<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>üíà Navalha de Ouro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="/icone.png" type="image/png">
    <link rel="apple-touch-icon" href="/icone.png">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <!-- Script Oficial do PagBank Connect para Checkout Transparente -->
    <script src="https://assets.pagseguro.com.br/checkout-sdk-js/rc/dist/browser/pagseguro.min.js"></script>

    <style>
        :root {
            --cor-fundo: #0c0c0c; --cor-card: #181818; --cor-botoes: #222222;
            --cor-texto-principal: #e0e0e0; --cor-destaque-ouro: #d4af37; --cor-destaque-prata: #c0c0c0;
            --cor-destaque-azul: #007BFF; --cor-sombra: #000000; --cor-borda: #333;
        }
        body {
            margin: 0; background: var(--cor-fundo); color: var(--cor-texto-principal);
            font-family: 'Poppins', sans-serif; display: flex; flex-direction: column; align-items: center;
        }
        .content-container {
            width: 100%; max-width: 500px; padding-top: 60px; padding-bottom: 80px;
            box-sizing: border-box; flex-grow: 1; display: flex; flex-direction: column; align-items: center; position: relative;
        }
        input, select, button, textarea {
            width: 100%; margin: 8px 0; padding: 14px; background: var(--cor-botoes);
            color: var(--cor-texto-principal); border: 1px solid var(--cor-borda); border-radius: 10px;
            font-size: 16px; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2); box-sizing: border-box;
        }
        button { cursor: pointer; font-weight: 600; transition: all 0.2s ease; }
        button:hover { background: var(--cor-destaque-ouro); color: var(--cor-fundo); transform: translateY(-2px); }
        button:disabled { cursor: not-allowed; background: #444; opacity: 0.6; }
        .card {
            background: var(--cor-card); padding: 24px; margin: 12px; border-radius: 16px;
            box-shadow: 0 6px 15px var(--cor-sombra); width: 90%; max-width: 480px; box-sizing: border-box;
            animation: fadeIn 0.5s ease-in-out; position: relative; overflow: hidden;
        }
        .hidden { display: none !important; }
        .topbar {
            position: fixed; top: 0; left: 0; right: 0; height: 60px; background: var(--cor-card);
            display: flex; justify-content: space-between; align-items: center; padding: 0 16px;
            box-shadow: 0 2px 4px #000; z-index: 10; border-bottom: 2px solid var(--cor-borda);
        }
        .logo { font-weight: 600; color: var(--cor-destaque-ouro); font-size: 18px; }
        .topbar-right { display: flex; align-items: center; gap: 10px; }
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85);
            display: none; align-items: center; justify-content: center; z-index: 20; opacity: 0; transition: opacity 0.3s ease;
        }
        .modal.show { display: flex; opacity: 1; }
        .modal-content {
            background: var(--cor-card); padding: 30px; border-radius: 20px; width: 90%;
            max-width: 400px; box-shadow: 0 6px 20px rgba(0,0,0,0.8); transform: scale(0.9);
            transition: transform 0.3s ease; border: 1px solid var(--cor-borda); position: relative;
        }
        .modal.show .modal-content { transform: scale(1); }
        .close-btn { position: absolute; top: 10px; right: 15px; font-size: 2.5em; color: #888; cursor: pointer; line-height: 1; }
        #btnChat {
            font-size: 26px; background: none; border: none; padding: 0; cursor: pointer;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.5); position: fixed; bottom: 12px; right: 12px; z-index: 15;
        }
        #btnSair {
            font-size: 20px; background: none; border: none; padding: 0; cursor: pointer;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.5); position: fixed; bottom: 72px; left: 12px; z-index: 15;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Estilos do Chat (estilo WhatsApp) */
        #janelaChat.fullscreen .modal-content {
            width: 100%; height: 100%; max-width: 100%; border-radius: 0;
            display: flex; flex-direction: column; padding: 10px;
        }
        #chat-header { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--cor-borda); }
        .chat-container {
            flex-grow: 1; overflow-y: auto; padding: 10px;
            display: flex; flex-direction: column; /* As mensagens fluem de cima para baixo */
        }
        .chat-message {
            padding: 8px 12px; margin-bottom: 8px; border-radius: 12px; max-width: 80%;
            animation: fadeIn 0.3s ease-in-out; word-wrap: break-word;
        }
        .chat-sent { align-self: flex-end; background: #075E54; color: white; }
        .chat-received { align-self: flex-start; background: var(--cor-botoes); }
        .chat-remetente { font-size: 0.8em; font-weight: bold; margin-bottom: 4px; display: block; }
        .admin-chat-red { color: #ff4d4d; }
        .barbeiro-chat { color: #3498db; }
        .cliente-chat-vip { color: var(--cor-destaque-ouro); }
        .cliente-chat { color: var(--cor-destaque-prata); }
        #chatForm { display: flex; padding-top: 10px; border-top: 1px solid var(--cor-borda); }
        #chatInput { flex-grow: 1; margin: 0; }
        #btnEnviarChat { width: auto; margin: 0 0 0 10px; }

        /* Estilos do Checkout PagBank */
        .loading-spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid var(--cor-destaque-ouro); border-radius: 50%;
            width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #pagbank-checkout-container { margin-top: 15px; }

        .barbeiro-list-container {
            width: 100%; max-height: 70vh; overflow-y: auto; padding: 0 10px; box-sizing: border-box;
        }
        /* Outros estilos unificados dos seus arquivos... */
    </style>
</head>
<body>

<div class="topbar hidden" id="topbar">
  <div class="logo">üíà Navalha de Ouro</div>
  <div class="topbar-right">
    <button id="btnCarteiraTop" class="hidden" onclick="abrirModal('modalCarteira')">üí∞ R$ <span id="saldoHeader">0,00</span></button>
  </div>
</div>

<div class="content-container">
  
  <div id="authView" class="card">
    <h2>üîê Entrar ou Criar Conta</h2>
    <input id="email" type="email" placeholder="üìß Email">
    <input id="senha" type="password" placeholder="üîë Senha">
    <div id="cadastro-fields" class="hidden">
      <input id="nomeCadastro" type="text" placeholder="üë§ Nome Completo">
      <select id="tipo">
        <option value="cliente">üôã Cliente</option>
        <option value="barbeiro">üíà Barbeiro</option>
      </select>
    </div>
    <button onclick="entrar()">‚û°Ô∏è Entrar</button>
    <button id="btnCriarConta" onclick="prepararCriarConta()">üÜï Criar conta</button>
  </div>

  <div id="clienteView" class="hidden card">
      <h2>üôã Painel do Cliente</h2>
      <div id="listaBarbeirosPrincipalCliente" class="barbeiro-list-container"></div>
  </div>

  <div id="barbeiroView" class="hidden card">
      <h2>üíà Painel do Barbeiro</h2>
      <p>Funcionalidades do barbeiro aqui...</p>
  </div>

  <div id="adminView" class="hidden card">
      <h2>üß† Painel do Admin</h2>
      <p>Funcionalidades do admin aqui...</p>
  </div>
</div>

<button id="btnChat" class="hidden" onclick="abrirChatGlobal()">üí¨</button>
<button id="btnSair" class="hidden" onclick="auth.signOut()">üö™ Sair</button>

<!-- ======================= MODAIS ======================== -->

<div id="modalCarteira" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="fecharModal('modalCarteira')">&times;</span>
    <h3>üí∞ Minha Carteira</h3>
    <p>Saldo: <b style="color: var(--cor-destaque-ouro);">R$ <span id="saldoModal">0,00</span></b></p>
    
    <div id="depositoContainer" style="margin-top:20px;">
        <h4>üì• Adicionar Saldo</h4>
        <input type="number" id="valorInput" placeholder="Valor do Dep√≥sito (Ex: 50.00)" required>
        <div style="display: flex; gap: 10px;">
          <button id="btnPagarPix" onclick="iniciarCheckoutPagBank()">Pagar com Pix</button>
          <button id="btnPagarCartao" onclick="iniciarCheckoutPagBank()">Pagar com Cart√£o</button>
        </div>
    </div>

    <div style="margin-top:20px;">
        <h4>üì§ Sacar Saldo</h4>
        <button onclick="abrirModal('modalSaque')">üí∏ Solicitar Saque</button>
    </div>
  </div>
</div>

<div id="modalPagbankCheckout" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="fecharModal('modalPagbankCheckout')">&times;</span>
    <h3>Finalizar Pagamento</h3>
    <div id="pagbank-loader" class="hidden">
        <div class="loading-spinner"></div>
        <p style="text-align:center;">Carregando ambiente seguro...</p>
    </div>
    <div id="pagbank-checkout-container"></div>
  </div>
</div>

<div id="modalSaque" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="fecharModal('modalSaque')">&times;</span>
        <h3>üì§ Solicitar Saque</h3>
        <p>A solicita√ß√£o ser√° enviada para an√°lise e o pagamento √© manual.</p>
        <input id="saqueValor" type="number" placeholder="Valor do saque">
        <input id="saqueNomeCompleto" type="text" placeholder="Nome Completo do Titular do PIX">
        <input id="saqueChavePix" type="text" placeholder="Sua chave PIX">
        <button onclick="confirmarSaque()">‚úÖ Confirmar Solicita√ß√£o</button>
    </div>
</div>

<div id="janelaChat" class="modal">
  <div class="modal-content">
      <div id="chat-header">
        <h3 id="chatTitle">üí¨ Chat Global</h3>
        <span class="close-btn" onclick="fecharModal('janelaChat')">&times;</span>
      </div>
      <div id="chatMessages" class="chat-container"></div>
      <form id="chatForm" onsubmit="enviarMensagem(); return false;">
          <input id="chatInput" placeholder="Digite sua mensagem" autocomplete="off">
          <button id="btnEnviarChat" type="submit">‚û°Ô∏è</button>
      </form>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>

<script>
    // Configura√ß√£o do Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyDBt7NcU5rP-hsrBZ07ne_HbiMCHRyVcnY",
        authDomain: "navalha-de-ouro-v11.firebaseapp.com",
        projectId: "navalha-de-ouro-v11",
        storageBucket: "navalha-de-ouro-v11.appspot.com",
        messagingSenderId: "434474263075",
        appId: "1:434474263075:web:163893d68a1b5dbe74c796"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let perfil = null;
    let chatListener = null;

    // --- L√ìGICA DE UI E MODAIS ---
    function mostrar(id) {
        ["authView", "clienteView", "barbeiroView", "adminView"].forEach(v => document.getElementById(v).classList.add("hidden"));
        document.getElementById(id).classList.remove("hidden");
        const isAuth = id !== "authView";
        document.getElementById("topbar").classList.toggle("hidden", !isAuth);
        document.getElementById("btnChat").classList.toggle("hidden", !isAuth);
        document.getElementById("btnSair").classList.toggle("hidden", !isAuth);
    }

    function abrirModal(id) {
        document.getElementById(id).classList.add('show');
    }

    function fecharModal(id) {
        document.getElementById(id).classList.remove('show');
        if (id === 'modalPagbankCheckout') {
            document.getElementById('pagbank-checkout-container').innerHTML = '';
        }
    }

    // --- AUTENTICA√á√ÉO ---
    auth.onAuthStateChanged(user => {
        if (user) {
            db.collection("usuarios").doc(user.uid).onSnapshot(doc => {
                if (doc.exists) {
                    perfil = doc.data();
                    document.getElementById("saldoHeader").textContent = (perfil.saldo || 0).toFixed(2);
                    document.getElementById("saldoModal").textContent = (perfil.saldo || 0).toFixed(2);
                    mostrar(perfil.tipo + "View");
                } else {
                    mostrar("authView");
                }
            });
        } else {
            if (chatListener) chatListener();
            perfil = null;
            mostrar("authView");
        }
    });

    function entrar() {
        const email = document.getElementById("email").value;
        const senha = document.getElementById("senha").value;
        auth.signInWithEmailAndPassword(email, senha).catch(e => alert(e.message));
    }

    function prepararCriarConta() {
        document.getElementById('cadastro-fields').classList.remove('hidden');
        document.getElementById('btnCriarConta').onclick = criarConta;
        document.getElementById('btnCriarConta').textContent = "Confirmar Cadastro";
    }

    function criarConta() {
        const nome = document.getElementById("nomeCadastro").value;
        const tipo = document.getElementById("tipo").value;
        const email = document.getElementById("email").value;
        const senha = document.getElementById("senha").value;
        if (!nome || !tipo) return alert("Preencha nome e tipo.");

        auth.createUserWithEmailAndPassword(email, senha)
            .then(cred => {
                return db.collection("usuarios").doc(cred.user.uid).set({
                    nome, email, tipo, saldo: 0, reputacao: 100,
                    //...outros campos padr√£o
                });
            })
            .catch(e => alert(e.message));
    }

    // --- DEP√ìSITO COM PAGBANK CHECKOUT ---
    async function iniciarCheckoutPagBank() {
        const valor = parseFloat(document.getElementById('valorInput').value);
        if (isNaN(valor) || valor < 5) {
            return alert("O valor m√≠nimo para dep√≥sito √© R$ 5,00.");
        }

        fecharModal('modalCarteira');
        abrirModal('modalPagbankCheckout');
        document.getElementById('pagbank-loader').classList.remove('hidden');
        document.getElementById('pagbank-checkout-container').innerHTML = '';

        try {
            // 1. Chamar seu backend para criar a ordem de pagamento
            const response = await fetch('https://navalhabackend.onrender.com/criar-deposito', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ valor, uid: auth.currentUser.uid, nome: perfil.nome, email: perfil.email, cpf: perfil.cpf })
            });

            if (!response.ok) throw new Error('Falha ao criar a ordem de pagamento.');
            
            const { id: orderId } = await response.json();

            // 2. Iniciar e renderizar o checkout
            const pagseguro = PagSeguro.connect({ orderId });
            const checkout = pagseguro.checkout();

            checkout.render({ container: 'pagbank-checkout-container' }, {
                onReady: () => {
                    document.getElementById('pagbank-loader').classList.add('hidden');
                },
                onSuccess: (res) => {
                    alert('Pagamento processado! Seu saldo ser√° atualizado assim que o sistema confirmar.');
                    fecharModal('modalPagbankCheckout');
                },
                onError: (err) => {
                    console.error('Erro no checkout:', err);
                    alert('Ocorreu um erro no pagamento. Tente novamente.');
                    fecharModal('modalPagbankCheckout');
                },
                onClose: () => {
                    fecharModal('modalPagbankCheckout');
                }
            });

        } catch (error) {
            console.error("Erro ao iniciar checkout:", error);
            alert("N√£o foi poss√≠vel iniciar o checkout. Tente mais tarde.");
            fecharModal('modalPagbankCheckout');
        }
    }

    // --- L√ìGICA DE SAQUE MANUAL ---
    async function confirmarSaque() {
        const valor = parseFloat(document.getElementById('saqueValor').value);
        const nomeCompleto = document.getElementById('saqueNomeCompleto').value.trim();
        const chavePix = document.getElementById('saqueChavePix').value.trim();

        if (isNaN(valor) || valor <= 0) return alert("Valor inv√°lido.");
        if (!nomeCompleto || !chavePix) return alert("Preencha todos os campos.");
        if (perfil.saldo < valor) return alert("Saldo insuficiente.");

        if (confirm(`Confirmar solicita√ß√£o de saque de R$ ${valor.toFixed(2)}?`)) {
            try {
                await db.collection("solicitacoesSaque").add({
                    uid: auth.currentUser.uid,
                    nomeUsuario: perfil.nome,
                    nomeTitular: nomeCompleto,
                    chavePix: chavePix,
                    valor: valor,
                    status: "pendente",
                    solicitadoEm: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert("Solicita√ß√£o de saque enviada com sucesso! Ser√° processada em breve.");
                fecharModal('modalSaque');
            } catch (error) {
                alert("Erro ao enviar solicita√ß√£o: " + error.message);
            }
        }
    }

    // --- L√ìGICA DO CHAT ---
    function abrirChatGlobal() {
        abrirModal('janelaChat');
        document.getElementById('janelaChat').querySelector('.modal-content').style.height = '80%'; // Ajusta altura
        const chatContainer = document.getElementById("chatMessages");
        chatContainer.innerHTML = "";

        if (chatListener) chatListener();

        chatListener = db.collection("chats").doc("chatGlobal").collection("mensagens")
            .orderBy("ts", "asc") // Ordena do mais antigo para o mais novo
            .limitToLast(50) // Pega as √∫ltimas 50 mensagens
            .onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === "added") {
                        const msg = change.doc.data();
                        const messageDiv = document.createElement('div');
                        messageDiv.className = `chat-message ${msg.remetenteUid === auth.currentUser.uid ? "chat-sent" : "chat-received"}`;
                        
                        let remetenteNome = `<span class="chat-remetente ${getRemetenteClass(msg)}">${msg.remetenteNome}</span>`;
                        messageDiv.innerHTML = `${remetenteNome}${msg.texto}`;
                        
                        chatContainer.appendChild(messageDiv);
                    }
                });
                // Garante que o scroll sempre fique no final
                chatContainer.scrollTop = chatContainer.scrollHeight;
            });
    }
    
    function getRemetenteClass(msg) {
        if(msg.tipo === 'admin') return 'admin-chat-red';
        if(msg.tipo === 'barbeiro') return 'barbeiro-chat';
        if(msg.vip) return 'cliente-chat-vip';
        return 'cliente-chat';
    }

    function enviarMensagem() {
        const input = document.getElementById("chatInput");
        const texto = input.value.trim();
        if (!texto) return;

        db.collection("chats").doc("chatGlobal").collection("mensagens").add({
            remetenteUid: auth.currentUser.uid,
            remetenteNome: perfil.nome,
            tipo: perfil.tipo,
            vip: perfil.vip || false,
            texto: texto,
            ts: firebase.firestore.FieldValue.serverTimestamp()
        });
        input.value = "";
    }

</script>
</body>
</html>

