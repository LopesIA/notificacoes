<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Nova Versão</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="icon" href="/icone.png" type="image/png">
  <link rel="apple-touch-icon" href="/icone.png">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root {
/* CORREÇÃO TELA 2: Centraliza e cobre o fundo da tela de onboarding com imagem */
.onboard-screen[style*="background-image"] {
    background-repeat: no-repeat;
    background-position: center center !important; 
    background-size: cover !important;
}

--cor-destaque-vermelho: #ff0000; /* Vermelho */
      --cor-fundo: #0c0c0c;
      --cor-card: #181818;
      --cor-botoes: #222222;
      --cor-texto-principal: #e0e0e0;
      --cor-destaque-ouro: #d4af37; /* Dourado */
      --cor-destaque-rosa: #e57373; /* Rosa Suave */
      --cor-destaque-prata: #c0c0c0; /* Prateado */
      --cor-destaque-azul: #007BFF; /* Azul */
      --cor-sombra: #000000;
      --cor-borda: #333;
      --cor-destaque: var(--cor-destaque-ouro); /* Cor padrão */
    }
/* ANIMAÇÃO DE BRILHO DOURADO PARA OPÇÃO SELECIONADA */
@keyframes brilhoDourado {
    0% {
        box-shadow: 0 0 5px rgba(212, 175, 55, 0.4), 0 0 10px rgba(212, 175, 55, 0.2);
    }
    50% {
        box-shadow: 0 0 15px var(--cor-tema-forte), 0 0 25px var(--cor-tema-forte); /* cor-tema-forte é o seu dourado */
    }
    100% {
        box-shadow: 0 0 5px rgba(212, 175, 55, 0.4), 0 0 10px rgba(212, 175, 55, 0.2);
    }
}

/* CLASSE QUE APLICA A ANIMAÇÃO QUANDO SELECIONADO */
.onboard-option.selected {
    border: 2px solid var(--cor-tema-forte) !important; /* Adiciona uma borda dourada sólida */
    animation: brilhoDourado 1.5s infinite alternate; /* Aplica o brilho piscante */
}

/* Garante que o item não selecionado não tenha a animação */
.onboard-option:not(.selected) {
    animation: none;
}
    body.tema-claro {
--cor-destaque-vermelho: #cc0000; /* Vermelho mais escuro para tema claro */
      --cor-fundo: #f0f0f0;
      --cor-card: #ffffff;
      --cor-botoes: #e0e0e0;
      --cor-texto-principal: #333;
      --cor-destaque-ouro: #d4af37;
      --cor-destaque-rosa: #e57373;
      --cor-destaque-prata: #808080;
      --cor-destaque-azul: #0056b3;
      --cor-sombra: #b0b0b0;
      --cor-borda: #ccc;
    }
    body {
      background-image: url('/icone.png');
      background-size: cover; /* Garante que a imagem cubra todo o elemento */
      background-position: center; /* Centraliza a imagem */
      background-repeat: no-repeat; /* Evita repetição */
      background-attachment: fixed; /* Opcional: mantém a imagem fixa ao rolar */

      /* Adiciona um overlay escuro para o texto ficar mais legível */
      background-blend-mode: multiply;
      background-color: rgba(0, 0, 0, 0.6); /* Cor de fundo escura (ajuste a opacidade 0.6 se necessário) */
      
      margin: 0;
      background: var(--cor-fundo);
      color: var(--cor-texto-principal);
      font-family: 'Poppins', sans-serif;
      min-height: 10vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: background-color 0.3s;
    }
    .content-container {
      width: 100%;
      max-width: 500px;
      padding-top: 60px;
      padding-bottom: 80px; /* Espaço para os botões do rodapé */
      box-sizing: border-box;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative; /* Adicionado para posicionamento do chat preview */
    }
    input, select, button, textarea {
      width: 100%;
      margin: 8px 0;
      padding: 14px;
      background: var(--cor-botoes);
      color: var(--cor-texto-principal);
      border: 1px solid var(--cor-borda);
      border-radius: 10px;
      font-size: 16px;
      transition: all 0.3s ease-in-out;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      box-sizing: border-box; /* CORREÇÃO: Garante que padding não estoure a div */
    }
    button {
      cursor: pointer;
      font-weight: 600;
    }
    button:hover {
      background: var(--cor-destaque);
      color: var(--cor-fundo);
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(212, 175, 55, 0.4);
    }
    button:disabled {
        cursor: not-allowed;
        background: #444;
        opacity: 0.6;
    }
    .card {
      background: var(--cor-card);
      padding: 24px;
      margin: 12px;
      border-radius: 16px;
      box-shadow: 0 6px 15px var(--cor-sombra);
      width: 90%;
      max-width: 480px;
      box-sizing: border-box;
      position: relative;
      overflow: hidden;
      /* Transição mais fluida */
      transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out;
    }
    .card.exiting {
        opacity: 0;
        transform: translateX(-50px);
    }
    .card.entering {
        opacity: 0;
        transform: translateX(50px);
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .hidden {
      display: none !important;
    }
    .topbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: var(--cor-card);
      color: var(--cor-texto-principal);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 16px;
      box-shadow: 0 2px 4px #000;
      font-size: 18px;
      z-index: 10;
      border-bottom: 2px solid var(--cor-borda);
    }
    .logo {
      font-weight: 600;
      color: var(--cor-destaque);
      font-size: 18px;
      text-shadow: 0 0 5px var(--cor-destaque);
      transition: color 0.3s;
    }
    .topbar-right {
      display: flex;
      align-items: center;
      gap: 15px; /* Aumentado o espaço */
    }
    #btnConfig {
      font-size: 20px;
      background: none;
      border: none;
      padding: 0;
      cursor: pointer;
    }
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 20;
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
    }
    .modal.show {
      display: flex;
      opacity: 1;
    }
    .modal-content {
      background: var(--cor-card);
      padding: 30px;
      border-radius: 20px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.8);
      transform: scale(0.9);
      transition: transform 0.3s ease-in-out;
      border: 1px solid var(--cor-borda);
      position: relative; /* Para popups sobrepostos */
    }
    .modal-overlay-content {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(12, 12, 12, 0.9);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border-radius: 20px;
        z-index: 25; /* Fica acima do conteúdo do modal pai */
    }
    /* Estilo para o modal de ranking maior */
    #modalRankingUnificado .modal-content {
        max-width: 600px; /* Maior para caber as duas colunas */
    }
    .modal.show .modal-content {
      transform: scale(1);
    }
    .servico-btn {
      background: #333;
      margin: 6px 0;
      border: 1px solid #555;
      border-radius: 8px;
      padding: 12px;
      text-align: left;
    }
    .bottom-buttons-container {
      position: fixed;
      bottom: 12px;
      width: 90%;
      max-width: 480px;
      display: flex;
      justify-content: space-between;
      z-index: 15;
    }
    .redeem-container {
      position: fixed;
      bottom: 25px; /* Posição ajustada */
      width: 100%;
      max-width: 500px;
      text-align: center;
      z-index: 15;
      box-sizing: border-box;
    }
    .redeem-container button {
      width: 200px;
      font-size: 14px;
      padding: 10px;
      margin: 0;
    }
    #btnChat, #btnDenuncia {
      font-size: 26px;
      background: none;
      border: none;
      padding: 0;
      margin: 0;
      cursor: pointer;
      width: auto;
      height: auto;
      text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
      position: relative; /* Para o contador de notificação */
    }
    #btnSair {
      font-size: 20px; /* Reduzido */
      background: none;
      border: none;
      padding: 0;
      margin: 0;
      cursor: pointer;
      width: auto;
      height: auto;
      text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
      position: fixed;
      bottom: 72px; /* Posição alterada para ficar acima do botão de denúncia */
      left: 12px;
      z-index: 15;
    }
    #btnChat {
      position: fixed;
      bottom: 12px;
      right: 12px;
      z-index: 15;
    }
    #btnTema {
      font-size: 18px; /* Ajuste aqui */
      background: none;
      border: none;
      padding: 0;
      margin: 0;
      cursor: pointer;
      width: auto;
      height: auto;
      text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
    }
    #btnCarteiraTop {
      font-size: 16px;
      background: var(--cor-botoes);
      color: var(--cor-texto-principal);
      border-radius: 10px;
      padding: 8px 12px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }
    #botaoExtra {
      margin: 10px;
      text-align: center;
      width: 90%;
      max-width: 480px;
      box-sizing: border-box;
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    .vantagens ul {
      list-style-type: '✅';
      padding-left: 20px;
    }
    .vantagens li {
      background: transparent;
      margin-bottom: 10px;
      padding: 5px;
      border-radius: 0;
      border: none;
      box-shadow: none;
      padding-left: 10px;
    }
    @keyframes vaga-glow {
      0% { box-shadow: 0 0 8px #4CAF50, 0 0 12px #4CAF50; }
      50% { box-shadow: 0 0 16px #4CAF50, 0 0 24px #4CAF50; }
      100% { box-shadow: 0 0 8px #4CAF50, 0 0 12px #4CAF50; }
    }
    @keyframes gold-flash-background {
        0%, 100% { background-color: var(--cor-card); }
        50% { background-color: #2c250e; }
    }
    .boosted-card {
        border: 2px solid var(--cor-destaque);
        animation: gold-flash-background 3s ease-in-out infinite, fadeIn 0.5s;
    }
    .boost-icon {
        position: absolute;
        top: 8px;
        left: 8px;
        font-size: 20px;
        text-shadow: 0 0 8px var(--cor-destaque);
    }
    @keyframes gold-flash {
      0%, 100% { background-color: transparent; transform: scale(1); }
      50% { background-color: rgba(212, 175, 55, 0.8); transform: scale(1.2); }
    }
    @keyframes gold-pulse {
      0% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.7); }
      70% { box-shadow: 0 0 10px 15px rgba(212, 175, 55, 0); }
      100% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0); }
    }
    .notificacao-pulsante {
        animation: gold-pulse 1.5s infinite;
    }
    .new-message-glow {
        animation: gold-flash 1.5s ease-in-out infinite;
        border-radius: 50%;
    }
    .notification-badge {
        position: absolute;
        top: -5px;
        right: -8px;
        background-color: #e74c3c;
        color: white;
        border-radius: 50%;
        padding: 2px 6px;
        font-size: 10px;
        font-weight: bold;
        border: 2px solid var(--cor-fundo);
    }
    .vip-glow {
      box-shadow: 0 0 8px var(--cor-destaque), 0 0 12px var(--cor-destaque);
      border: 1px solid var(--cor-destaque);
    }
    
    /* NOVO ESTILO ADICIONADO AQUI */
    .pro-glow {
      box-shadow: 0 0 8px var(--cor-destaque-azul), 0 0 12px var(--cor-destaque-azul);
      border: 1px solid var(--cor-destaque-azul);
    }
    .promocao-card {
      background: linear-gradient(45deg, #181818, var(--cor-destaque));
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 10px;
      color: #fff;
    }
    .chat-container {
      height: 100%;
      flex-grow: 1; /* Faz o container crescer */
      overflow-y: auto;
      border: 1px solid var(--cor-borda);
      padding: 10px;
      border-radius: 10px;
      background: #0d0d0d;
      margin-bottom: 10px;
      display: flex;
      flex-direction: column-reverse; 
    }
    .chat-message {
      padding: 8px 12px;
      margin-bottom: 8px;
      border-radius: 12px;
      animation: fadeIn 0.3s ease-in-out;
      transition: opacity 1.5s ease-out; /* Transição para o fade out */
    }
    .chat-message.fading-out {
        opacity: 0;
    }
    .chat-sent {
      text-align: right;
      background: #333;
      margin-left: 20%;
    }
    .chat-received {
      text-align: left;
      background: #555;
      margin-right: 20%;
    }
    .scrollable-list {
      max-height: 400px;
      overflow-y: auto;
    }
    .aviso-item {
      text-align: left;
      margin-bottom: 8px;
      border-bottom: 1px solid var(--cor-borda);
      padding-bottom: 8px;
      opacity: 0.8;
      transition: opacity 0.3s ease-in-out;
    }
    .horario-btn {
        background: #222;
        color: #fff;
        border: 1px solid #555;
        border-radius: 5px;
        padding: 8px;
        margin: 5px;
        width: 100px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .horario-btn.selecionado {
        background: var(--cor-destaque);
        color: var(--cor-fundo);
        border-color: var(--cor-destaque);
    }
    .horario-btn.bloqueado {
        background: #772014;
        color: #fff;
        border-color: #772014;
        text-decoration: line-through;
    }
    .horarios-actions {
        display: flex;
        justify-content: space-between;
        margin-top: 10px;
        gap: 10px;
    }
    .horarios-list {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 10px;
    }
    .horario-disponivel {
      background: var(--cor-botoes);
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 14px;
      color: var(--cor-texto-principal);
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .horario-disponivel:hover {
      background: var(--cor-destaque);
    }
    .admin-chat-red {
      color: red;
      font-weight: bold;
      text-shadow: 0 0 5px #000, 0 0 8px #000;
    }
    .barbeiro-chat {
        color: var(--cor-texto-principal);
        text-shadow: 0 0 8px var(--cor-destaque-azul);
    }
    .cliente-chat {
    color: var(--cor-destaque-prata); /* Cor do texto para prateado */
    text-shadow: 0 0 8px var(--cor-destaque-vermelho); /* Brilho vermelho */
}
    .show-password-container {
        position: relative;
        display: flex;
        align-items: center;
        width: 100%;
    }
    .show-password-container input {
        padding-right: 40px;
    }
    .show-password-toggle {
        position: absolute;
        right: 15px;
        cursor: pointer;
        color: var(--cor-destaque-prata);
    }
    .barbeiro-card {
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        cursor: pointer;
    }
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        border-bottom: 1px solid var(--cor-borda);
        padding-bottom: 10px;
    }
    .card-header-info h4 {
        margin: 0;
        font-size: 1.1em;
        color: var(--cor-destaque);
    }
    .card-header-info p {
        margin: 4px 0 0;
        font-size: 0.8em;
        opacity: 0.8;
    }
    .card-reputacao {
        font-size: 0.9em;
        text-align: right;
    }
    .card-status {
        padding: 10px;
        border-radius: 8px;
        text-align: center;
        font-weight: 600;
    }
    .status-imediato {
        background-color: #4CAF50;
        color: white;
        animation: vaga-glow 1.5s ease-in-out infinite;
    }
    .status-manual {
        background-color: var(--cor-botoes);
    }
    .status-indisponivel {
        background-color: #555;
        opacity: 0.7;
    }
    .card-horarios-disponiveis {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
        margin-top: 8px;
    }
    .card-horarios-disponiveis span {
        background: #333;
        padding: 4px 8px;
        border-radius: 5px;
        font-size: 0.85em;
    }
    .card-servicos-title {
        font-size: 0.9em;
        font-weight: 600;
        margin-top: 8px;
        border-top: 1px solid var(--cor-borda);
        padding-top: 10px;
    }
    .card-servicos-list {
        font-size: 0.8em;
        opacity: 0.9;
        list-style-type: none;
        padding: 0;
        margin: 0;
    }
    .popup-section {
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--cor-borda);
    }
    .popup-section h4 {
        margin-top: 0;
        margin-bottom: 10px;
        color: var(--cor-destaque);
    }
    .selectable-item {
        background: var(--cor-botoes);
        border: 1px solid var(--cor-borda);
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
    }
    .selectable-item:hover {
        border-color: var(--cor-destaque);
    }
    .selectable-item.selected {
        background: var(--cor-destaque);
        color: var(--cor-fundo);
        border-color: var(--cor-destaque);
        font-weight: 600;
    }
    #barbeiroPerfilHorariosList {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        max-height: 150px;
        overflow-y: auto;
    }
    #barbeiroPerfilHorariosList .selectable-item {
        flex-grow: 1;
        text-align: center;
    }
    #modalBarbeiroPerfil .modal-footer {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid var(--cor-borda);
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }
    #chatPreview {
        position: absolute;
        top: -40px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(24, 24, 24, 0.8);
        color: var(--cor-texto-principal);
        padding: 5px 12px;
        border-radius: 10px;
        font-size: 12px;
        z-index: 5;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 90%;
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
        pointer-events: none;
    }
    #chatPreview.show {
        opacity: 1;
    }
    .conquista-item {
        display: flex;
        align-items: center;
        gap: 15px;
        background-color: var(--cor-botoes);
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 10px;
    }
    .conquista-item.unlocked {
        border-left: 5px solid var(--cor-destaque);
    }
    .conquista-item.locked {
        opacity: 0.5;
        border-left: 5px solid var(--cor-borda);
    }
    .conquista-icon {
        font-size: 2em;
    }
    .ranking-container {
        display: flex;
        gap: 20px;
        width: 100%;
    }
    .ranking-column {
        flex: 1;
        min-width: 0;
    }
    .ranking-column h4 {
        text-align: center;
        margin-bottom: 10px;
        color: var(--cor-destaque);
    }
    .ranking-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 5px;
        border-bottom: 1px solid var(--cor-borda);
        font-size: 14px;
    }
    .ranking-item:first-child {
        font-weight: bold;
        color: var(--cor-destaque);
    }
    .chat-medal {
        margin-right: 4px;
    }
    .app-footer {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        text-align: center;
        padding: 5px 0;
        font-size: 10px;
        color: var(--cor-texto-principal);
        opacity: 0.5;
        z-index: 5;
        pointer-events: none;
    }
    /* Estilos do Chat Fullscreen */
    #janelaChat.fullscreen {
        padding: 0;
        border-radius: 0;
    }
    #janelaChat.fullscreen .modal-content {
        width: 100%;
        height: 100%;
        max-width: 100%;
        border-radius: 0;
        display: flex;
        flex-direction: column;
    }
    #janelaChat.fullscreen #chatInput {
        margin-bottom: 0;
    }
    #janelaChat #carregarMaisMsgBtn {
        margin: 0;
        width: 100%;
        border-radius: 0;
        background-color: var(--cor-botoes);
    }
    /* Estilos do Portfólio */
    .portfolio-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px;
      padding: 10px;
      max-height: 70vh;
      overflow-y: auto;
    }
    .portfolio-grid img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid var(--cor-borda);
    }
    #modalPortfolioCliente .modal-content, #lojaView .modal-content {
        width: 100%;
        height: 100%;
        max-width: 100%;
        border-radius: 0;
        display: flex;
        flex-direction: column;
    }

/* Estilos para o novo gerenciador de portfólio do profissional */
#portfolioInputsContainer {
    display: grid;
    /* Cria um grid que se ajusta, mostrando quantas colunas de 120px couberem */
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); 
    gap: 10px;
    max-height: 400px; /* Aumentado de 250px para 400px para caber mais */
    overflow-y: auto;
    padding: 5px;
    background: var(--cor-fundo); /* Fundo para ver os cards */
    border-radius: 8px;
}
.portfolio-admin-item {
    border: 1px solid var(--cor-borda);
    border-radius: 8px;
    overflow: hidden; /* Para o input não vazar */
    background: var(--cor-botoes);
    display: flex;
    flex-direction: column;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
.portfolio-admin-item img {
    width: 100%;
    height: 100px;
    object-fit: cover;
    background: #333; /* Cor de fundo enquanto a imagem carrega */
    border-bottom: 1px solid var(--cor-borda);
}
.portfolio-admin-item input {
    width: 100%;
    border-radius: 0;
    margin: 0;
    border: none;
    font-size: 12px;
    padding: 8px;
    box-sizing: border-box; /* Garante que o padding não quebre o layout */
}

    /* Estilos da Loja */
    .loja-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        padding: 10px;
        flex-grow: 1;
        overflow-y: auto;
    }
    .produto-card {
        background: var(--cor-botoes);
        border-radius: 12px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        border: 1px solid var(--cor-borda);
        cursor: pointer;
    }
    .produto-card img {
        width: 100%;
        height: 150px;
        object-fit: cover;
    }
    .produto-info {
        padding: 10px;
        text-align: center;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    .produto-nome { font-weight: 600; font-size: 1em; }
    .produto-preco { font-size: 1.1em; color: var(--cor-destaque); margin-top: 5px; }
    .produto-preco-original { text-decoration: line-through; opacity: 0.7; font-size: 0.9em; }
    .produto-card button { font-size: 14px; padding: 8px; margin-top: 10px;}
    #lojaView .card-header { display: flex; justify-content: space-between; align-items: center; }
    #lojaView .card-header h3 { font-size: 1.1em; white-space: nowrap; }
    #lojaContainer h4 { font-size: 1.0em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .tamanho-options { display: flex; gap: 5px; justify-content: center; margin: 10px 0; }
    .tamanho-options label {
      padding: 5px 10px;
      border: 1px solid var(--cor-borda);
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    .tamanho-options input { display: none; }
    .tamanho-options input:checked + label {
      background: var(--cor-destaque);
      color: var(--cor-fundo);
      border-color: var(--cor-destaque);
    }
    .checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; }
    .checkbox-group label { display: flex; align-items: center; gap: 5px; }
    .checkbox-group input { width: auto; margin: 0; }

    .modal-venda {
      z-index: 99;
    }
    .modal-venda .modal-content {
      background: #c0392b;
      color: white;
      text-align: center;
      border: 3px solid #e74c3c;
      animation: flash-red 1.5s infinite;
    }
    .modal-venda h3 {
      color: white;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    @keyframes flash-red {
      0%, 100% { background-color: #c0392b; }
      50% { background-color: #e74c3c; }
    }
    
    /* NOVOS ESTILOS */
    .barbeiro-list-container {
      width: 100%;
      max-height: 70vh;
      overflow-y: auto;
      padding: 0 10px;
      box-sizing: border-box;
    }
    .promo-info {
      font-size: 0.8em;
      color: var(--cor-destaque);
      margin: 8px 0 0 0;
      padding-top: 8px;
      border-top: 1px dashed var(--cor-borda);
    }
    #pix-qrcode {
        max-width: 200px;
        margin: 15px auto;
        display: block;
        border: 5px solid white;
        border-radius: 10px;
    }
    .pix-copia-cola-container {
      position: relative;
    }
    .pix-copia-cola-container button {
        width: 100%;
    }
    #pixChaveAleatoria {
        display: none;
    }
    .metodos-grid {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-top: 20px;
    }
    #detalhesProdutoAvaliacao {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid var(--cor-borda);
    }
    .avaliacao-estrelas {
        font-size: 1.2em;
        color: var(--cor-destaque);
    }
    .avaliacao-comentario {
        font-style: italic;
        opacity: 0.8;
        margin-top: 5px;
        font-size: 0.9em;
        background: var(--cor-botoes);
        padding: 8px;
        border-radius: 8px;
    }
    /* Estilo para imagem de produto no popup */
    #detalhesProdutoImg {
        width: 100%;
        height: 250px;
        object-fit: contain; /* Garante que a imagem apareça inteira */
        border-radius: 10px;
        margin-bottom: 15px;
        background-color: var(--cor-botoes);
    }

    /* ESTILOS ADICIONAIS Nova Versão */
    #popupAguarde {
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        z-index: 101;
    }
    #popupAguarde .modal-content {
        background: transparent;
        box-shadow: none;
        border: none;
        text-align: center;
        font-size: 1.2em;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .spinner {
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top: 4px solid var(--cor-destaque);
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px auto;
    }
    .modal-fullscreen {
        align-items: flex-end; /* Alinha o modal na parte inferior */
        background: none;
    }
    .modal-fullscreen .modal-content {
        width: 100%;
        height: 90vh;
        max-width: 100%;
        border-radius: 20px 20px 0 0;
        animation: slide-up 0.5s ease-out;
    }
    @keyframes slide-up {
        from { transform: translateY(100%); }
        to { transform: translateY(0); }
    }
    #onboardingContent {
        text-align: center;
    }
    #onboardingContent img {
        max-width: 80%;
        height: auto;
        margin-bottom: 20px;
    }
    .interest-options button {
    background: var(--cor-botoes);
    border: 2px solid transparent;
    transition: all 0.3s ease; /* Adicionado para suavizar o efeito */
}
    .interest-options button.selected {
    border-color: var(--cor-destaque);
    background: var(--cor-destaque-ouro);
    color: var(--cor-fundo);
    box-shadow: 0 0 15px var(--cor-destaque-ouro); /* Adicionado para o efeito de brilho */
}
    .onboarding-background-img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0.15;
      z-index: -1;
      border-radius: 20px 20px 0 0;
    }
    .onboarding-content-wrapper {
      position: relative;
      z-index: 1;
      padding: 20px;
      color: white;
      text-shadow: 1px 1px 3px black;
    }

/* Adicionado para a tela de onboarding ficar cheia */
#modalOnboarding .modal-content {
    padding: 0;
    border-radius: 0;
    height: 100%;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background-image: linear-gradient(rgba(0,0,0, 0.7), rgba(0,0,0, 0.7)), url('https://i.postimg.cc/NjxQW6sm/ezgif-com-animated-gif-maker.gif');
    background-size: cover;
    background-position: center;
}

    @keyframes blink-animation {
      0%, 100% { background-color: var(--cor-botoes); }
      50% { background-color: var(--cor-destaque); }
    }
    .blinking-button.closed {
      animation: blink-animation 2s infinite;
    }
    .chat-tabs {
        display: flex;
        border-bottom: 1px solid var(--cor-borda);
        margin-bottom: 10px;
    }
    .chat-tab {
        flex: 1;
        text-align: center;
        padding: 10px;
        cursor: pointer;
        border-bottom: 3px solid transparent;
    }
    .chat-tab.active {
        border-bottom-color: var(--cor-destaque);
    }
    .config-section button.selected {
        background-color: var(--cor-destaque);
        color: var(--cor-fundo);
    }

#modalVipPro .modal-content {
    max-height: 85vh; /* Limita a altura a 85% da altura da tela */
    overflow-y: auto; /* Adiciona barra de rolagem vertical se necessário */
}

/* Opcional: Melhora o espaçamento interno se necessário */
#vipProContentContainer {
    padding-bottom: 20px; /* Adiciona espaço no final para não cortar o botão */
}

  </style>
</head>
<body>

<!-- Modal para Alterar Senha -->
<div id="modalAlterarSenha" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>🔑 Alterar Senha</h3>
    <input id="senhaAntiga" type="password" placeholder="Senha Atual">
    <input id="senhaNova" type="password" placeholder="Nova Senha (mínimo 6 caracteres)">
    <input id="senhaNovaConfirm" type="password" placeholder="Confirmar Nova Senha">
    <button onclick="alterarSenhaUsuario()">✅ Confirmar Alteração</button>
    <button data-modal-id="modalAlterarSenha" onclick="fecharModal(event)">❌ Cancelar</button>
  </div>
</div>
<!-- Fim Modal Alterar Senha -->

<div id="popupAguarde" class="modal" onclick="fecharAguarde(event)">
  <div class="modal-content">
    <div class="spinner"></div>
    <span id="popupAguardeTexto">Aguarde...</span>
  </div>
</div>

<div id="modalOnboarding" class="modal modal-fullscreen">
  <div class="modal-content">
    <div id="onboardingContent">
      </div>
  </div>
</div>

<div class="topbar hidden" id="topbar">
  <div class="logo">Nova Versão</div>
  <div class="topbar-right">
    <button id="btnTema" onclick="alternarTema()">🌙</button>
    <button id="btnConfig" onclick="abrirModal('modalConfiguracoes')">⚙️</button>
    <button id="btnCarteiraTop" class="hidden" onclick="abrirModal('modalCarteira')">💰 R$ <span id="saldoHeader">0,00</span></button>
  </div>
</div>

<div class="content-container">
  
  <div id="chatPreview"></div> <div id="botaoExtra" class="hidden"></div>

  <div id="authView" class="card hidden">
    <h2>🔐 Entrar ou Criar Conta</h2>
    <input id="email" type="email" placeholder="📧 Email">
    <input id="senha" type="password" placeholder="🔑 Senha">
    <div id="cadastro-fields" class="hidden">
      <input id="nomeExibido" type="text" placeholder="😀 Nome Exibido (obrigatório)">
      <div class="show-password-container">
        <input id="senha-cadastro" type="password" placeholder="🔑 Senha (visível)">
      </div>
      <div class="show-password-container">
        <input id="senha-confirm" type="password" placeholder="🔑 Confirmar Senha (visível)">
      </div>
      <select id="tipo">
        <option value="cliente">🙋 Cliente</option>
        <option value="barbeiro">💈 Barbeiro</option>
        <option value="manicure_pedicure">💅 Manicure/Pedicure</option>
        <option value="designer_cilios">👁️ Designer de Cílios</option>
      </select>
      <input id="telefone" type="tel" placeholder="📞 Telefone com DDD (ex: 27999999999)">
      <input id="rua" type="text" placeholder="Endereço (Rua)" class="hidden">
      <input id="numero" type="text" placeholder="Endereço (Número)" class="hidden">
      <select id="estado" onchange="carregarCidades()">
        <option value="">🌎 Selecione seu estado</option>
      </select>
      <select id="cidade">
        <option value="">🏙️ Selecione sua cidade</option>
      </select>
      <input id="indicador" type="text" placeholder="📨 Email de quem te indicou? (opcional)">
      <button onclick="obterLocalizacaoCadastro()" id="btnLocalizacaoCadastro">📍 Usar minha localização atual</button>
    </div>
    <button onclick="entrar()">➡️ Entrar</button>
    <button id="btnCriarConta" onclick="prepararCriarConta()">🆕 Criar conta</button>
    <button id="btnVoltar" class="hidden" onclick="voltarParaLogin()">⬅️ Voltar</button>
    <button onclick="abrirModal('modalEsqueciSenha')" style="background: none; border: none; color: var(--cor-destaque); margin-top: 10px; width: 100%;">Esqueci minha senha</button>
  </div>
  
  <div id="guestView" class="card">
    <h2>🙋 Painel de Visitante</h2>
    <p style="text-align: center; font-size: 14px; opacity: 0.8;">Bem-vindo! Para interagir, crie uma conta ou faça login.</p>
    <button onclick="toggleFuncoes('guestFuncoesContainer')">⚙️ Funções do Visitante</button>
    <div id="guestFuncoesContainer" class="hidden">
        <div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:10px;">
          <button>📜 Histórico</button>
          <button>💎 VIP</button>
          <button>💰 Carteira</button>
          <button>🏆 Fidelidade</button>
          <button>📰 Blog</button>
          <button>🏅 Conquistas</button>
          <button>📊 Ranking</button>
          <button onclick="mostrar('lojaView'); carregarProdutos();">🛍️ Loja</button>
        </div>
    </div>
    <hr style="border-color: var(--cor-borda); margin: 20px 0;">
    <div id="listaBarbeirosPrincipalGuest" class="barbeiro-list-container"></div>
  </div>

  <div id="clienteView" class="hidden card">
    <h2>🙋 Painel do Cliente</h2>
    <button onclick="toggleFuncoes('clienteFuncoesContainer')" class="blinking-button closed">⚙️ Funções do Cliente</button>
    <div id="clienteFuncoesContainer" class="hidden">
        <div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:10px;">
          <button id="btnHistoricoCliente" onclick="abrirHistoricoCliente()" style="width:45%">📜 Histórico</button>
          <button id="btnVip" onclick="abrirModalVip()" style="width:45%">💎 VIP</button>
          <button onclick="abrirModal('modalCarteira')" style="width:45%">💰 Carteira</button>
          <button onclick="abrirModalFidelidade()" style="width:45%">🏆 Fidelidade</button>
          <button onclick="carregarListaBlog(); abrirModal('modalBlog')" style="width:45%">📰 Blog</button>
          <button onclick="abrirModalConquistas()" style="width:45%">🏅 Conquistas</button>
          <button onclick="abrirModalRankingUnificado()" style="width:45%">📊 Ranking</button>
          <button id="btnGerenciarLojaCliente" onclick="abrirGerenciarLoja()" class="hidden" style="width:45%">🏪 Minha Loja</button>
          <button id="btnMinhasCompras" onclick="abrirMinhasCompras()" style="width:45%">🛍️ Minhas Compras</button>
        </div>
    </div>
    <hr style="border-color: var(--cor-borda); margin: 20px 0;">
    <div id="listaBarbeirosPrincipalCliente" class="barbeiro-list-container"></div>
  </div>

  <div id="barbeiroView" class="hidden card">
    <h2>💈 Painel do Profissional</h2>
    <button onclick="toggleFuncoes('barbeiroFuncoesContainer')" class="blinking-button closed">⚙️ Funções do Profissional</button>
    <div id="barbeiroFuncoesContainer" class="hidden">
        <div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:10px;">
          <button onclick="abrirServicos()" style="width:45%">✂️ Serviços</button>
          <button onclick="abrirAgenda()" style="width:45%">📅 Agenda</button>
          <button id="btnAgendamentosBarbeiro" onclick="abrirAgendamentosBarbeiro()" style="width:45%">⏰ Agendamentos</button>
          <button onclick="abrirClientesBarbeiro()" style="width:45%">🧑‍🤝‍🧑 Clientes</button>
          <button onclick="abrirPromocoes()" style="width:45%">🎁 Promoções</button>
          <button onclick="abrirModal('modalCarteira')" style="width:45%">💰 Carteira</button>
          <button onclick="abrirHistoricoBarbeiro()" style="width:45%">📜 Histórico</button>
          <button id="btnAvaliacoesBarbeiro" onclick="abrirAvaliacoesBarbeiro()" style="width:45%">⭐ Avaliações</button>
          <button onclick="abrirModalPortfolioBarbeiro()" style="width:45%">🖼️ Portfólio</button>
          <button onclick="abrirModal('modalLogomarca')" style="width:45%">🎨 Logomarca</button>
          <button onclick="abrirModal('modalAlterarEnderecoBarbeiro')" style="width:45%">📍 Alterar Endereço</button>
          <button onclick="abrirModalDashboardBarbeiro()" style="width:45%">🚀 Desempenho</button>
          <button onclick="abrirModalConquistasBarbeiro()" style="width:45%">🏅 Conquistas</button>
          <button onclick="abrirModalRankingUnificado()" style="width:45%">📊 Ranking</button>
          <button onclick="carregarListaBlog(); abrirModal('modalBlog')" style="width:45%">📰 Blog</button>
          <button id="btnGerenciarLojaBarbeiro" onclick="abrirGerenciarLoja()" class="hidden" style="width:45%">🏪 Gerenciar Loja</button>
          <button onclick="abrirModalTurbinar()" style="width:92%; background: linear-gradient(45deg, var(--cor-destaque), #ffeb3b);">🚀 Turbinar Perfil (R$ 9,99)</button>
          
          <button id="btnVipPro" onclick="abrirModalVipPro()" style="width:92%; background: linear-gradient(45deg, var(--cor-destaque-azul), #00c6ff);">🌟 Seja PRO (R$ 29,99/mês)</button>
        </div>
    </div>
     <hr style="border-color: var(--cor-borda); margin: 20px 0;">
    <div id="listaBarbeirosPrincipalBarbeiro" class="barbeiro-list-container"></div>
  </div>

  <div id="adminView" class="hidden card">
    <h2>🧠 Painel do Admin</h2>
    <div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center">
      <button onclick="abrirModalEstatisticas()" style="width:45%">📊 Estatísticas</button>
      <button id="btnAdminSolicitacoes" onclick="abrirModalSolicitacoes()" style="width:45%">📥 Solicitações</button>
      <button onclick="abrirModalUsuarios()" style="width:45%">👥 Usuários</button>
      <button id="btnAdminDenuncias" onclick="abrirDenuncias()" style="width:45%">🚨 Denúncias</button>
      <button onclick="abrirModal('modalCarteira')" style="width:45%">💰 Carteira</button>
      <button onclick="abrirGerenciarLojaAdmin()" style="width:45%">🛍️ Gerenciar Loja</button>
      <button onclick="abrirModal('modalBlogAdmin')" style="width:45%">✍️ Publicar Blog</button>
      <button onclick="abrirModal('modalNotificacaoMarketing')" style="width:92%">📣 Enviar Notificação Geral</button>
    </div>
  </div>

  <div id="lojaView" class="hidden card">
    <div class="card-header">
        <h3>🛍️ Loja Nova Versão</h3>
    </div>
    <div id="lojaContainer" class="loja-grid">
    </div>
</div>


</div>

<div class="redeem-container hidden" id="redeemContainer">
  <button id="btnResgatar" onclick="abrirPortaSecreta()">✨ Resgatar Código</button>
</div>

<div class="bottom-buttons-container hidden" id="bottomButtons">
  <button id="btnDenuncia" onclick="abrirModal('modalDenuncia')">🚨</button>
  <button id="btnChat" onclick="abrirChatGlobal()">
    <span>💬</span>
    <span class="notification-badge hidden">0</span>
  </button>
</div>

<button id="btnSair" class="hidden" onclick="fazerLogout()">🚪 Sair</button>

<div id="modalConfiguracoes" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>⚙️ Configurações</h3>
    
<!-- Botão Adicionado -->
    <div class="popup-section">
      <h4>🔒 Segurança</h4>
      <button onclick="abrirModal('modalAlterarSenha'); fecharModalAtual();">Alterar Minha Senha</button>
    </div>
    <!-- Fim Botão Adicionado -->

    <div class="popup-section config-section">
      <h4>❤️ Meu Interesse Principal</h4>
      <div id="configInteresseContainer" style="display:flex; gap:10px;">
          <button data-interesse="barbeiro">Barbearias</button>
          <button data-interesse="manicure_pedicure">Unhas</button>
          <button data-interesse="designer_cilios">Cílios</button>
      </div>
    </div>

    <div class="popup-section">
      <h4>⚖️ Legal</h4>
      <div style="display:flex; flex-direction:column; gap:10px;">
        <button onclick="abrirModal('modalTermosUso')">Termos de Uso</button>
        <button onclick="abrirModal('modalTermosPrivacidade')">Termos de Privacidade</button>
        <button onclick="abrirModal('modalTermosCookies')">Termos de Cookies</button>
      </div>
    </div>
    <button data-modal-id="modalConfiguracoes" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalTermosUso" class="modal" onclick="fecharModal(event)"><div class="modal-content" onclick="event.stopPropagation()"><h3>Termos de Uso</h3><p class="scrollable-list">Bem-vindo ao Nova Versão! Ao usar nosso aplicativo, você concorda em seguir nossas regras de conduta, respeitar outros usuários e profissionais, e usar a plataforma para os fins a que se destina. Violações podem resultar na suspensão da conta.</p><button data-modal-id="modalTermosUso" onclick="fecharModal(event)">Fechar</button></div></div>
<div id="modalTermosPrivacidade" class="modal" onclick="fecharModal(event)"><div class="modal-content" onclick="event.stopPropagation()"><h3>Termos de Privacidade</h3><p class="scrollable-list">Sua privacidade é importante. Coletamos dados como nome, e-mail e localização para fornecer e melhorar nossos serviços. Não compartilhamos seus dados pessoais com terceiros sem seu consentimento, exceto quando exigido por lei.</p><button data-modal-id="modalTermosPrivacidade" onclick="fecharModal(event)">Fechar</button></div></div>
<div id="modalTermosCookies" class="modal" onclick="fecharModal(event)"><div class="modal-content" onclick="event.stopPropagation()"><h3>Termos de Cookies</h3><p class="scrollable-list">Utilizamos cookies e tecnologias semelhantes para manter sua sessão ativa, lembrar suas preferências e garantir o funcionamento do aplicativo. Ao continuar usando o Nova Versão, você concorda com nosso uso de cookies.</p><button data-modal-id="modalTermosCookies" onclick="fecharModal(event)">Fechar</button></div></div>

<div id="modalCarteira" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>💰 Minha Carteira</h3>
    <p>Seu saldo atual é: <b style="color: var(--cor-destaque);">R$ <span id="saldoModal">0,00</span></b></p>
    <button onclick="iniciarDeposito()">📥 Depositar</button>
    <button onclick="iniciarSaque()">📤 Sacar</button>
    <button data-modal-id="modalCarteira" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalDepositoFormulario" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>📝 Informações para Depósito</h3>
    <p>Preencha seus dados para continuar.</p>
    <input id="depositoPrimeiroNome" type="text" placeholder="Primeiro Nome">
    <input id="depositoSegundoNome" type="text" placeholder="Segundo Nome">
    <input id="depositoCpf" type="text" placeholder="CPF">
    <input id="depositoTelefone" type="tel" placeholder="Telefone com DDD">
    <input id="depositoValor" type="number" placeholder="💰 Valor a depositar (Ex: 50.00)">
    <button id="btnContinuarDeposito" onclick="criarSolicitacaoDeposito()" disabled>Continuar</button>
    <button data-modal-id="modalDepositoFormulario" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>


<div id="modalDeposito" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>💰 Depósito de Créditos</h3>
    <p>Escolha um método de pagamento para adicionar saldo à sua carteira.</p>
    <div class="metodos-grid">
        <button id="btnPagarComPix" onclick="processarPagamentoPixAprimorado()">⚡ PIX (QR Code)</button>
        <button id="btnPagarComCartao" onclick="abrirModalTaxaCartao()">💳 Cartão de Crédito</button>
    </div>
    <button data-modal-id="modalDeposito" onclick="fecharModal(event)">❌ Voltar</button>
  </div>
</div>

<div id="modalTaxaCartao" class="modal">
    <div class="modal-content" style="text-align: center;">
        <h3>⚠️ Taxa de Plataforma</h3>
        <p style="font-size: 14px;">Para garantir a transparência e a segurança da sua transação com cartão de crédito, informamos que há uma taxa administrativa fixa cobrada pela plataforma de pagamentos.</p>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
           <button onclick="fecharModalAtual()" style="background-color: #555;">Cancelar</button>
           <button onclick="processarPagamentoCartaoAprimorado()">Continuar</button>
        </div>
    </div>
</div>


<div id="modalGerandoQRCode" class="modal">
    <div class="modal-content" style="text-align: center;">
        <h3 style="color: var(--cor-destaque);">Gerando QR CODE</h3>
        <p>Aguarde um instante...</p>
    </div>
</div>

<div id="modalCarregandoGenerico" class="modal">
    <div class="modal-content" style="text-align: center;">
        <h3 id="carregandoGenericoTitulo" style="color: var(--cor-destaque);">Aguarde...</h3>
        <p id="carregandoGenericoTexto">Estamos processando sua solicitação.</p>
    </div>
</div>

<div id="modalExibirPixAprimorado" class="modal">
    <div class="modal-content" style="text-align: center;">
      <h3> Pague com PIX</h3>
      <p>Escaneie o QR Code abaixo com seu app de banco.</p>
      <img src="https://i.postimg.cc/fTZyFN6G/qrcode.jpg" id="pix-qrcode" alt="QR Code PIX">
      <div class="pix-copia-cola-container">
          <textarea id="pixChaveAleatoria">00020126770014BR.GOV.BCB.PIX0136ec4a8f0f-ec59-44bc-afcf-dff364f971de0215NAVALHA DE OURO5204000053039865802BR5920Josiel Lopes Azeredo6009SAO PAULO62140510vuyKg7Qnmx63041C39</textarea>
          <button onclick="copiarCodigoPixAprimorado(event)">Copiar Chave Aleatória PIX</button>
      </div>
      <p style="font-size: 14px; color: #ff9800; margin-top: 15px;">Este código expira em: <b id="pixTimer">10:00</b></p>
      <button onclick="confirmarEnvioComprovante()">CONFIRMAR</button>
    </div>
</div>

<div id="modalPixExpirado" class="modal" style="z-index: 22;">
    <div class="modal-content" style="text-align: center;">
        <h3 style="color: #e74c3c;">Tempo Expirado!</h3>
        <p>O tempo para pagamento deste PIX acabou.</p>
        <div style="display:flex; gap: 10px; margin-top: 20px;">
            <button onclick="fecharTodosOsModais()" style="background: #555;">Fechar</button>
            <button onclick="tentarGerarPixNovamente()">Tentar Novamente</button>
        </div>
    </div>
</div>

<div id="modalSaque" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>📤 Solicitar Saque</h3>
    <p>O valor será transferido para sua chave PIX após aprovação do administrador.</p>
    <input id="saqueValor" type="number" placeholder="Valor do saque">
    <select id="saqueChavePixTipo">
      <option value="">Tipo de Chave PIX</option>
      <option value="cpf">CPF</option>
      <option value="email">E-mail</option>
      <option value="telefone">Telefone</option>
      <option value="aleatoria">Aleatória</option>
    </select>
    <input id="saqueChavePix" type="text" placeholder="Sua chave PIX">
    <button id="btnConfirmarSaque" onclick="confirmarSaque()">✅ Confirmar Saque</button>
    <button data-modal-id="modalSaque" onclick="fecharModal(event)">❌ Cancelar</button>
  </div>
</div>

<div id="modalSaqueConfirmado" class="modal">
  <div class="modal-content" style="text-align:center;">
    <h3>✅ Solicitação Enviada!</h3>
    <p>Sua solicitação de saque foi enviada para análise.</p>
    <p style="font-size:14px; opacity: 0.8;">Para agilizar, entre em contato com o administrador.</p>
    <button onclick="contatarAdminSaque()">OK</button>
  </div>
</div>

<div id="janelaChat" class="modal fullscreen" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="chat-tabs">
        <div class="chat-tab active" id="tabChatGlobal" onclick="alternarChat('global')">🌎 Global</div>
        <div class="chat-tab" id="tabChatLocal" onclick="alternarChat('local')">📍 Local</div>
    </div>
    <button id="carregarMaisMsgBtn" onclick="carregarMensagensAnteriores()">Ver mensagens anteriores</button>
    <h3 id="chatTitle">💬 Chat Global</h3>
    <div id="chatMessages" class="chat-container"></div>
    <input id="chatInput" placeholder="Digite sua mensagem">
    <button onclick="enviarMensagem()">➡️ Enviar</button>
    <button data-modal-id="janelaChat" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="adminChatSelectorContainer" class="hidden" style="display: flex; gap: 10px; margin-bottom: 10px; padding: 5px; background: var(--cor-botoes); border-radius: 8px;">
    <select id="adminChatEstado" onchange="adminCarregarCidadesChat()"></select>
    <select id="adminChatCidade" onchange="adminRecarregarChat()"></select>
</div>

<div id="modalDenuncia" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>🚨 Denunciar</h3>
    <p>Envie sua mensagem e o administrador responderá em breve!</p>
    <textarea id="textoDenuncia" placeholder="Descreva o problema em detalhes"></textarea>
    <button onclick="enviarDenuncia()">➡️ Enviar</button>
    <button data-modal-id="modalDenuncia" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalDenunciaEnviada" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>✅ Denúncia Enviada!</h3>
    <p>Agradecemos a sua denúncia. Ela será analisada pela nossa equipe.</p>
    <p>💬 Se preferir, clique no botão abaixo para avisar o administrador diretamente no WhatsApp e agilizar o processo.</p>
    <a id="btnWhatsappDenuncia" href="#" target="_blank">
      <button>💬 Avisar no WhatsApp</button>
    </a>
    <button data-modal-id="modalDenunciaEnviada" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalBlog" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>📰 Blog</h3>
    <div id="listaBlog" class="scrollable-list"></div>
    <button data-modal-id="modalBlog" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalVip" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div id="vipContentContainer">
    </div>
    <button data-modal-id="modalVip" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalVipPro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div id="vipProContentContainer">
      </div>
    <button data-modal-id="modalVipPro" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalFidelidade" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>🏆 Programa de Fidelidade</h3>
    <p>Seus pontos: <b id="pontosFidelidade">0</b></p>
    <p style="font-size: 14px; color: var(--cor-destaque-prata);">Acumule pontos em cada agendamento e troque por descontos!</p>
    <button onclick="resgatarPontos()">🎁 Resgatar 100 pontos por R$ 5,00</button>
    <button data-modal-id="modalFidelidade" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalBarbeiroPerfil" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div id="barbeiroPerfilHeader">
      <h3 id="barbeiroPerfilNome"></h3>
      <p>Endereço: <span id="barbeiroPerfilEndereco"></span></p>
      <p>Reputação: <span id="barbeiroPerfilReputacao"></span></p>
      <img id="profissionalLogo" src="" alt="Logomarca" style="max-width: 100px; border-radius: 50%; display: none; margin: 10px auto;">
    </div>

    <div id="barbeiroPerfilServicos" class="popup-section">
      <h4>1. Escolha um Serviço</h4>
      <div id="barbeiroPerfilServicosList" class="scrollable-list" style="max-height: 150px;"></div>
    </div>

    <div id="barbeiroPerfilHorarios" class="popup-section">
      <h4>2. Escolha uma Opção</h4>
      <div id="barbeiroPerfilHorariosList"></div>
    </div>

    <div class="modal-footer">
      <button id="btnAcessarPortfolio" class="hidden" style="width: auto; background-color: var(--cor-botoes);">🖼️ Ver Portfólio</button>
      <button id="btnAbrirRota" class="hidden" style="width: auto; background-color: var(--cor-botoes);">🗺️ Rota</button>
      <button id="btnConfirmarAgendamento" disabled>🗓️ Agendar</button>
    </div>
    <button data-modal-id="modalBarbeiroPerfil" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>
<div id="modalVagaImediataAprovada" class="modal" style="z-index: 99;" onclick="fecharModal(event)">
  <div class="modal-content" style="background: #e74c3c; color: white;" onclick="event.stopPropagation()">
    <h3 style="color:white;text-shadow: 2px 2px 4px #000;">⚠️ VAGA IMEDIATA APROVADA!</h3>
    <p style="font-size: 1.2em; text-align: center;"><b>Você tem 10 minutos para chegar ao local.</b></p>
    <p style="text-align: center;">Não se atrase para não perder a vaga e o seu dinheiro!</p>
    <div style="display:flex; gap: 10px; margin-top: 20px;">
      <button data-modal-id="modalVagaImediataAprovada" onclick="fecharModal(event)" style="background:white; color:#e74c3c; flex: 1;">✅ Entendi</button>
      <button id="btnCancelarVagaAprovada" style="background: #333; color: white; flex: 1;">❌ Cancelar Agendamento</button>
    </div>
  </div>
</div>

<div id="modalBarbeariasCliente" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>💈 Profissionais disponíveis</h3>
    <input type="text" id="filtroBarbeiro" onkeyup="filtrarBarbeiros()" placeholder="🔎 Buscar por profissional ou cidade...">
    <div id='listaBarbeiros' class="scrollable-list"></div>
    <button data-modal-id="modalBarbeariasCliente" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalHistoricoCliente" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>📜 Meu Histórico</h3>
    <div id="painelHistorico" class="scrollable-list"></div>
    <button data-modal-id="modalHistoricoCliente" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalConquistas" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>🏅 Minhas Conquistas</h3>
    <div id="listaConquistas" class="scrollable-list"></div>
    <button data-modal-id="modalConquistas" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalRankingUnificado" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>🏆 Ranking Geral 🏆</h3>
    <p style="font-size: 12px; opacity: 0.7; text-align:center;">Top 100 com mais serviços concluídos.</p>
    <div id="listaRankingUnificado" class="scrollable-list"></div>
    <button data-modal-id="modalRankingUnificado" onclick="fecharModal(event)" style="margin-top: 20px;">❌ Fechar</button>
  </div>
</div>


<div id="modalCriarPromocao" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>🎁 Criar Promoção</h3>
    <input id="promocaoNome" placeholder="Nome da Promoção">
    <input id="promocaoDescricao" placeholder="Descrição curta">
    <input type="number" id="promocaoDesconto" placeholder="Desconto em % (ex: 15)">
    <button onclick="criarPromocao()">💾 Salvar Promoção</button>
    <button data-modal-id="modalCriarPromocao" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalLogomarca" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>🎨 Adicionar Logomarca</h3>
<p style="font-size: 12px; opacity: 0.8;">Faça o upload da sua logomarca (imagem ou GIF).</p>
<img id="logomarcaPreview" src="https://via.placeholder.com/100?text=Logo" alt="Preview" style="max-width: 100px; border-radius: 50%; display: block; margin: 10px auto; border: 1px solid var(--cor-borda);">
<input type="file" id="logomarcaFile" accept="image/*,image/gif" onchange="previewImage(this, 'logomarcaPreview')">
<progress id="logomarcaProgress" value="0" max="100" style="width: 100%; display: none;"></progress>
<button onclick="uploadLogomarca()">💾 Salvar Logomarca</button>
<button data-modal-id="modalLogomarca" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalAlterarEnderecoBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>📍 Alterar Endereço</h3>
    <input id="novoEnderecoRua" type="text" placeholder="Nova Rua">
    <input id="novoEnderecoNumero" type="text" placeholder="Novo Número">
    <button id="btnSalvarLocalAtual" onclick="salvarLocalizacaoAtualEndereco()">📍 Salvar Localização Atual</button>
<button data-modal-id="modalAlterarEnderecoBarbeiro" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalAvaliacoes" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>⭐ Minhas Avaliações</h3>
        <div id="listaAvaliacoesModal" class="scrollable-list"></div>
        <button data-modal-id="modalAvaliacoes" onclick="fecharModal(event)">❌ Fechar</button>
    </div>
</div>

<div id="modalServicosBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>✂️ Meus Serviços</h3>
    <div id="listaServicosBarbeiro" class="scrollable-list"></div>
    <button onclick="adicionarServico()">➕ Adicionar novo serviço</button>
    <button data-modal-id="modalServicosBarbeiro" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalAgendaBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>📅 Minha Agenda</h3>
    <p>Use os botões abaixo para gerenciar sua disponibilidade e horários.</p>
    <button id="btnDisponibilidade" onclick="toggleDisponibilidade()"></button>
    <button id="btnVagaImediata" onclick="toggleVagaImediata()"></button>
    <button id="btnAgendaManual" onclick="toggleAgendaManual()"></button>
    <div id="agendaManualPainel" class="hidden card">
        <h4>Horários Disponíveis Hoje</h4>
        <p>Selecione os horários para trabalhar ou clique duas vezes para bloquear.</p>
        <div id="horariosContainer" style="display:flex; flex-wrap:wrap; gap:5px; justify-content: center;"></div>
        <div class="horarios-actions">
            <button onclick="salvarAgendaManual()">💾 Salvar</button>
            <button data-modal-id="modalAgendaBarbeiro" onclick="fecharModal(event)">🚪 Fechar</button>
        </div>
    </div>
    <button data-modal-id="modalAgendaBarbeiro" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalOnboardingProfissionalServicos" class="modal"><div class="modal-content"><h3>1. Cadastre seus Serviços</h3><p>Adicione pelo menos um serviço para continuar.</p><div id="onboardingServicosList" class="scrollable-list"></div><input id="onboardingServicoNome" placeholder="Nome do Serviço"><input id="onboardingServicoValor" type="number" placeholder="Valor (R$)"><input id="onboardingServicoTempo" type="number" placeholder="Tempo (minutos)"><button onclick="adicionarServicoOnboarding()">Adicionar Serviço</button><button id="btnOnboardingNextServicos" disabled onclick="avancarOnboarding(2)">Próximo ➡️</button></div></div>
<div id="modalOnboardingProfissionalAgenda" class="modal"><div class="modal-content"><h3>2. Configure sua Agenda</h3><p>Como você irá atender seus clientes?</p><button id="onboardingBtnVagaImediata">⚡ Ativar Vaga Imediata</button><button id="onboardingBtnAgendaManual">📅 Usar Agenda Manual</button><div id="onboardingAgendaManualPainel" class="hidden card"><h4>Horários Disponíveis Hoje</h4><div id="onboardingHorariosContainer" style="display:flex; flex-wrap:wrap; gap:5px; justify-content: center;"></div></div><button onclick="avancarOnboarding(3)">✅ Concluir</button></div></div>


<div id="modalAgendamentosBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>⏰ Meus Agendamentos</h3>
    <div id="agendamentosPainel" class="scrollable-list"></div>
    <button data-modal-id="modalAgendamentosBarbeiro" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalClientesBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>🧑‍🤝‍🧑 Meus Clientes</h3>
    <p>Lista de clientes que já agendaram com você.</p>
    <div id="listaClientesBarbeiro" class="scrollable-list"></div>
    <button data-modal-id="modalClientesBarbeiro" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalDashboardBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>🚀 Meu Desempenho</h3>
    <div id="dashboardConteudo">
      <p>Carregando dados...</p>
    </div>
    <button data-modal-id="modalDashboardBarbeiro" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalHistoricoBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>📜 Histórico de Serviços</h3>
    <div id="painelHistoricoBarbeiro" class="scrollable-list"></div>
    <button data-modal-id="modalHistoricoBarbeiro" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalConquistasBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>🏅 Minhas Conquistas de Profissional</h3>
    <div id="listaConquistasBarbeiro" class="scrollable-list"></div>
    <button data-modal-id="modalConquistasBarbeiro" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalBlogAdmin" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>✍️ Novo Post</h3>
    <input id="blogTitulo" placeholder="Título">
    <textarea id="blogConteudo" placeholder="Conteúdo do post"></textarea>
    <button onclick="publicarBlog()">✍️ Publicar</button>
    <button data-modal-id="modalBlogAdmin" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalEstatisticas" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>📊 Estatísticas</h3>
    <div id="estatisticasPainel" class="scrollable-list"></div>
    <button data-modal-id="modalEstatisticas" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalSolicitacoes" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>📥 Todas as Solicitações</h3>
    <div id="listaSolicitacoes" class="scrollable-list"></div>
    <button data-modal-id="modalSolicitacoes" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalUsuarios" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>👥 Todos os Usuários</h3>
    <div id="usuariosPainel" class="scrollable-list"></div>
    <button data-modal-id="modalUsuarios" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalAdminGerenciarUsuario" class="modal"><div class="modal-content"><h3>Gerenciar Usuário</h3><div id="adminGerenciarConteudo"></div></div></div>

<div id="modalGerenciarLojaAdmin" class="modal"><div class="modal-content"><h3>Gerenciar Loja</h3><div class="popup-section"><h4>Deletar Produto</h4><div id="adminDeletarProdutoList" class="scrollable-list"></div></div><div class="popup-section"><h4>Ativar/Desativar Loja de Vendedor</h4><div id="adminToggleLojaList" class="scrollable-list"></div></div><button data-modal-id="modalGerenciarLojaAdmin" onclick="fecharModal(event)">Fechar</button></div></div>

<div id="modalDenunciasAdmin" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>🚨 Denúncias</h3>
    <div id="listaDenuncias" class="scrollable-list"></div>
    <button data-modal-id="modalDenunciasAdmin" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalNotificacaoMarketing" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>📣 Notificação para Todos</h3>
    <p>Esta mensagem será enviada como uma notificação push para todos os usuários do app.</p>
    <input id="marketingTitulo" placeholder="Título da Notificação">
    <textarea id="marketingCorpo" placeholder="Corpo da mensagem"></textarea>
    <button onclick="enviarNotificacaoMarketing()">🚀 Enviar para todos</button>
    <button data-modal-id="modalNotificacaoMarketing" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalPortfolioBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>🖼️ Gerenciar Portfólio</h3>
    <p style="font-size: 12px; opacity: 0.8;">Cole os links das suas imagens. Use serviços como <a href="https://postimages.org/" target="_blank">Postimages</a> para hospedar suas fotos gratuitamente. Máximo de 10 imagens.</p>
    <div id="portfolioInputsContainer" class="scrollable-list" style="max-height: 250px;"></div>
    <button onclick="salvarPortfolio()">💾 Salvar Portfólio</button>
    <button data-modal-id="modalPortfolioBarbeiro" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalPortfolioCliente" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3 id="portfolioClienteNome">🖼️ Portfólio</h3>
    <div id="portfolioClienteGrid" class="portfolio-grid"></div>
    <button data-modal-id="modalPortfolioCliente" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalLiberarLoja" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>🛍️ Acesso à Loja de Vendedores</h3>
        <p>Você ainda não tem permissão pra cadastrar produtos na loja. Peça autorização pro administrador no WhatsApp.</p>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button data-modal-id="modalLiberarLoja" onclick="fecharModal(event)" style="background-color: #555;">↩️ Cancelar</button>
            <button onclick="solicitarLiberacaoLoja()" style="flex-grow: 1;">
                💬 Pedir no WhatsApp
            </button>
        </div>
    </div>
</div>

<div id="modalTurbinar" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>🚀 Turbinar seu Perfil</h3>
        <p>Destaque seu perfil no topo da lista de profissionais por <strong>24 horas</strong> e alcance mais clientes!</p>
        <p style="font-size: 22px; color: var(--cor-destaque); font-weight: bold; text-align: center;">Apenas R$ 9,99</p>
        <button onclick="confirmarTurbinar()">💥 Confirmar e Turbinar</button>
        <button data-modal-id="modalTurbinar" onclick="fecharModal(event)">❌ Cancelar</button>
    </div>
</div>

<div id="modalPermissaoNotificacao" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>🔔 Fique por Dentro!</h3>
        <p>Ative as notificações para receber alertas importantes sobre seus agendamentos, promoções e novidades em tempo real.</p>
        <button onclick="pedirPermissaoEFechar()">👍 Ativar Notificações</button>
        <button data-modal-id="modalPermissaoNotificacao" onclick="fecharModal(event)">❌ Agora não</button>
    </div>
</div>

<div id="modalInstalarApp" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>📱 Leve o App com Você!</h3>
        <p>Instale nosso aplicativo na sua tela inicial para um acesso mais rápido e uma melhor experiência.</p>
        <button id="btnInstalarPWA">📲 Instalar Agora</button>
        <button data-modal-id="modalInstalarApp" onclick="fecharModal(event)">🤔 Depois</button>
    </div>
</div>

<div id="modalAtualizacao" class="modal" style="z-index: 100;" onclick="fecharModal(event)">
    <div class="modal-content" style="border: 2px solid var(--cor-destaque);" onclick="event.stopPropagation()">
        <h3>🚀 Nova Versão do App Disponível!</h3>
        <p>Uma nova versão do aplicativo está pronta. Clique no botão abaixo para atualizar e ter acesso às últimas novidades e melhorias.</p>
        <div style="display:flex; gap: 10px; margin-top: 20px;">
           <button data-modal-id="modalAtualizacao" onclick="fecharModal(event)" style="background: #555;">🤔 Depois</button>
           <button id="btnAtualizarApp" style="flex-grow: 1;">🔄 Atualize Agora</button>
        </div>
    </div>
</div>

<div id="modalPromocoesBarbeiro" class="modal">
  <div class="modal-content">
    <h2>🎁 Promoções Ativas</h2>
    <div id="listaPromocoes">
      </div>
    <div class="modal-botoes">
      <button onclick="abrirModalAddPromocao()">➕ Adicionar Promoção</button>
      <button data-modal-id="modalPromocoesBarbeiro" onclick="fecharModal(event)">❌ Fechar</button>
    </div>
  </div>
</div>

<div id="modalAddPromocao" class="modal">
  <div class="modal-content">
    <h2>➕ Adicionar Nova Promoção</h2>

    <input type="text" id="addPromocaoNome" placeholder="Nome da Promoção (Ex: Combo Barba+Cabelo)" required>
    <textarea id="addPromocaoDescricao" placeholder="Descrição (Ex: Válido de segunda a quarta)" required></textarea>

    <div class="popup-section">
      <h4>✂️ Aplicar a quais serviços?</h4>
      <p style="font-size: 12px; opacity: 0.7;">Segure Ctrl (ou Cmd) para selecionar vários.</p>
      <select id="addPromocaoServicos" multiple style="height: 120px;"></select>
    </div>

    <div class="popup-section">
      <h4>⚙️ Condições da Promoção</h4>
      <label for="addPromocaoDesconto">Desconto (%):</label>
      <input type="number" id="addPromocaoDesconto" placeholder="Ex: 15" required>

      <label for="addPromocaoValidade">Válida até (opcional):</label>
      <input type="date" id="addPromocaoValidade">

      <label for="addPromocaoValorMinimo">Valor mínimo do serviço para aplicar (opcional):</label>
      <input type="number" id="addPromocaoValorMinimo" placeholder="Ex: 50">
    </div>

    <button onclick="salvarNovaPromocao()">💾 Salvar Promoção</button>
    <button data-modal-id="modalAddPromocao" onclick="fecharModal(event)">❌ Cancelar</button>
  </div>
</div>
	
<div id="modalLoja" class="modal">
  <div class="modal-content">
    <h3>🛒 Produtos da Loja</h3>
    <div id="listaProdutos" class="loja-grid"></div>
    <button data-modal-id="modalLoja" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalProdutoDetalhes" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <img id="detalhesProdutoImg" src="" alt="Imagem do Produto">
        <h3 id="detalhesProdutoNome" style="margin: 0; color: var(--cor-destaque);"></h3>
        
        <p style="margin-top: 15px;"><strong>Tamanho:</strong></p>
        <div id="detalhesProdutoTamanhos" class="tamanho-options"></div>
        
        <p><strong>Preço:</strong> <span id="detalhesProdutoPreco" style="font-weight: bold; font-size: 1.2em;"></span></p>
        <p><strong>Descrição:</strong></p>
        <p id="detalhesProdutoDescricao" style="font-size: 14px; opacity: 0.9;"></p>
        
        <div id="detalhesProdutoAvaliacao"></div>

        <button id="btnComprarAgora">Continuar</button>
        <button data-modal-id="modalProdutoDetalhes" onclick="fecharModal(event)">❌ Fechar</button>
    </div>
</div>

<div id="modalFormularioCompraLoja" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-overlay-content hidden" id="overlayPagamento">
            <h3>Confirmar Pagamento</h3>
            <p>Debitar <b>R$ <span id="valorDebito">0,00</span></b> do seu saldo da carteira?</p>
            <div style="display: flex; gap: 10px; margin-top: 20px; width: 80%;">
                <button id="btnNaoDebitar" style="background-color: #555;">Não</button>
                <button id="btnSimDebitar">Sim</button>
            </div>
        </div>
        <h3>📝 Detalhes para Entrega</h3>
        <input id="compraNomeCompleto" type="text" placeholder="Nome Completo">
        <input id="compraCpf" type="text" placeholder="CPF">
        <input id="compraTelefone" type="tel" placeholder="Telefone para Contato">
        <input id="compraEmail" type="email" placeholder="Email para confirmação">
        <input id="compraCep" type="text" placeholder="CEP">
        <input id="compraRua" type="text" placeholder="Endereço Completo (Rua, Bairro...)">
        <input id="compraNumeroCasa" type="text" placeholder="Número da Casa e Complemento">
        <button id="btnPagarCompraLoja">Pagar</button>
        <button data-modal-id="modalFormularioCompraLoja" onclick="fecharModal(event)">❌ Cancelar</button>
    </div>
</div>

<div id="modalGerenciarLoja" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" style="max-width: 600px;">
        <h3>🏪 Gerenciar Minha Loja</h3>
        <div id="listaMeusProdutos" class="scrollable-list"></div>
        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px;">
          <button onclick="abrirFormularioProduto()">➕ Adicionar Produto</button>
          <button id="btnEntregasVendedor" onclick="abrirEntregasVendedor()">🚚 Entregas</button>
          <button data-modal-id="modalGerenciarLoja" onclick="fecharModal(event)">❌ Fechar</button>
        </div>
    </div>
</div>

<div id="modalAddEditProduto" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3 id="formProdutoTitulo">📦 Adicionar Novo Produto</h3>
        <p>Imagens do Produto (até 5):</p>
<input type="file" id="produtoImagensFile" accept="image/*,image/gif" multiple onchange="previewProductImages(this)">
<div id="produtoImagensPreviews" class="portfolio-grid" style="grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); max-height: 100px; overflow-y: auto;"></div>
<progress id="produtoImagensProgress" value="0" max="100" style="width: 100%; display: none;"></progress>
        <input id="produtoNome" type="text" placeholder="Nome do Produto">
        <input id="produtoPreco" type="number" placeholder="Preço (Ex: 49.90)">
        <p>Tamanhos disponíveis:</p>
        <div class="checkbox-group">
            <label><input type="checkbox" name="tamanhos" value="P"> P</label>
            <label><input type="checkbox" name="tamanhos" value="M"> M</label>
            <label><input type="checkbox" name="tamanhos" value="G"> G</label>
            <label><input type="checkbox" name="tamanhos" value="GG"> GG</label>
        </div>
        <input id="produtoDesconto" type="number" placeholder="Desconto em % (Opcional)">
        <input id="produtoEntrega" type="text" placeholder="Tempo de entrega (Ex: 3-5 dias)">
        <textarea id="produtoDescricao" placeholder="Descrição curta do produto" rows="3"></textarea>
        <button id="btnSalvarProduto" onclick="salvarProdutoVendedor()">💾 Salvar Produto</button>
        <button data-modal-id="modalAddEditProduto" onclick="fecharModal(event)">❌ Cancelar</button>
    </div>
</div>

<div id="modalEntregasVendedor" class="modal" onclick="fecharModal(event)">
    <div class="modal-content">
        <h3>🚚 Minhas Entregas</h3>
        <div id="listaEntregas" class="scrollable-list"></div>
        <button data-modal-id="modalEntregasVendedor" onclick="fecharModal(event)">❌ Fechar</button>
    </div>
</div>

<div id="modalMinhasCompras" class="modal" onclick="fecharModal(event)">
    <div class="modal-content">
        <h3>🛍️ Minhas Compras</h3>
        <div id="listaMinhasCompras" class="scrollable-list"></div>
        <button data-modal-id="modalMinhasCompras" onclick="fecharModal(event)">❌ Fechar</button>
    </div>
</div>

<div id="modalAvaliarProduto" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>⭐ Avaliar Produto</h3>
        <p>Como você avalia o produto <b id="avaliarProdutoNome"></b>?</p>
        <div class="rating-stars" id="ratingStars">
            <span data-value="1">☆</span><span data-value="2">☆</span><span data-value="3">☆</span><span data-value="4">☆</span><span data-value="5">☆</span>
        </div>
        <textarea id="avaliarProdutoComentario" placeholder="Deixe um comentário..." rows="3"></textarea>
        <button id="btnSalvarAvaliacaoProduto">Enviar Avaliação</button>
        <button data-modal-id="modalAvaliarProduto" onclick="fecharModal(event)">❌ Cancelar</button>
    </div>
</div>
<style>
.rating-stars {
    text-align: center;
    font-size: 2.5em;
    cursor: pointer;
    margin: 10px 0;
    color: #444;
}
.rating-stars span {
    transition: color 0.2s;
}
.rating-stars span:hover,
.rating-stars span.hovered,
.rating-stars span.selected {
    color: var(--cor-destaque);
}

/* ADICIONE ESTE CÓDIGO DENTRO DA TAG <style> */
#modalAdminGerenciarUsuario .modal-content {
    max-height: 80vh; /* Limita a altura máxima do modal */
    overflow-y: auto;   /* Adiciona a barra de rolagem vertical quando necessário */
}

</style>

<div id="modalInfoPopup" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3 id="infoPopupTitulo">Aviso</h3>
    <p id="infoPopupMensagem" style="margin-top: 15px;"></p>
    <button data-modal-id="modalInfoPopup" onclick="fecharModal(event)" style="margin-top: 20px;">✅ OK</button>
  </div>
</div>

<div id="modalAddServico" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>➕ Adicionar Novo Serviço</h3>
    <input id="addServicoNome" type="text" placeholder="Nome do Serviço">
    <input id="addServicoValor" type="number" placeholder="Valor (Ex: 25.50)">
    <input id="addServicoDuracao" type="number" placeholder="Duração em Minutos (Ex: 30)">
    <button onclick="salvarNovoServico()">💾 Salvar Serviço</button>
    <button data-modal-id="modalAddServico" onclick="fecharModal(event)">❌ Cancelar</button>
  </div>
</div>

<div id="modalVendaRealizada" class="modal modal-venda" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>🎉 VENDA REALIZADA! 🎉</h3>
        <p style="font-size: 1.1em;">Parabéns, você vendeu um produto!</p>
        <p>Acesse <strong>Gerenciar Loja > Entregas</strong> para ver os detalhes.</p>
        <button data-modal-id="modalVendaRealizada" onclick="fecharModal(event)" style="background: white; color: #c0392b;">✅ OK</button>
    </div>
</div>

<div id="modalConfirmacaoComprador" class="modal">
    <div class="modal-content">
        <h3 id="confirmacaoCompradorTitulo">Confirmar Recebimento</h3>
        <p id="confirmacaoCompradorTexto">O vendedor marcou o produto como entregue. Você confirma o recebimento?</p>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
           <button id="btnRecusarEntrega" style="background: #c0392b;">❌ Negar</button>
           <button id="btnAceitarEntrega" style="background: #27ae60;">✅ Confirmar</button>
        </div>
    </div>
</div>

<div id="modalModoFerias" class="modal">
  <div class="modal-content">
    <h3>📅 Modo Férias/Ausência</h3>
    <p>Bloqueie um período na sua agenda. Seus clientes serão notificados.</p>
    <label for="feriasInicio">Data de Início:</label>
    <input type="date" id="feriasInicio">
    <label for="feriasFim">Data de Fim:</label>
    <input type="date" id="feriasFim">
    <button onclick="ativarModoFerias()">✅ Ativar e Notificar Clientes</button>
    <button data-modal-id="modalModoFerias" onclick="fecharModal(event)">❌ Cancelar</button>
  </div>
</div>

<div id="modalEsqueciSenha" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>🔑 Recuperar Acesso</h3>
    <p style="font-size: 14px;">Preencha seus dados para solicitar uma nova senha ao administrador.</p>
    <input id="recuperaEmail" type="email" placeholder="📧 Seu email de cadastro">
    <input id="recuperaTelefone" type="tel" placeholder="📞 Seu telefone com DDD">
    <button onclick="enviarSolicitacaoRecuperacaoSenha()">➡️ Enviar Solicitação</button>
    <button data-modal-id="modalEsqueciSenha" onclick="fecharModal(event)">❌ Cancelar</button>
  </div>
</div>

<footer class="app-footer">
  <div id="appVersion"></div>
</footer>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-messaging-compat.js"></script> 

<script>
// Firebase e variáveis globais
const firebaseConfig = {
  apiKey: "AIzaSyDBt7NcU5rP-hsrBZ07ne_HbiMCHRyVcnY",
  authDomain: "navalha-de-ouro-v11.firebaseapp.com",
  projectId: "navalha-de-ouro-v11",
  storageBucket: "navalha-de-ouro-v11.firebasestorage.app",
  messagingSenderId: "434474263075",
  appId: "1:434474263075:web:163893d68a1b5dbe74c796"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth(), db = firebase.firestore();
const storage = firebase.storage(); // Inicializa o Firebase Storage
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
  .then(() => {
    console.log("Persistência de autenticação definida para 'local'. O usuário ficará logado.");
  })
  .catch((error) => {
    console.error("Erro ao definir a persistência de autenticação:", error);
  });
const messaging = firebase.messaging(); 
const ADMIN_EMAIL = "josiel70c@gmail.com", ADMIN_PASS = "Ja997640401", TAXA = 0.05, BONUS_INDICACAO = 100, PONTOS_POR_CORTE = 10, PONTOS_PARA_RESGATE = 100, VALOR_RESGATE = 5;
const PONTOS_POR_DEPOSITO_NORMAL = 4, PONTOS_POR_DEPOSITO_VIP = 8;
const WHATSAPP_ADM_PHONE = "5527995003737";
const PRECO_VIP = 100;
const PRECO_TURBINAR = 9.99;
// SUBSTITUA AS CONSTANTES DE PREÇO POR ESTAS
const PRECOS_PRO = { // Nossos 3 novos níveis
    tier1: { preco: 29.90, taxa: 0.04 }, // 4%
    tier2: { preco: 59.90, taxa: 0.02 }, // 2%
    tier3: { preco: 99.90, taxa: 0.00 }  // 0%
};

let fcmSetupDone = false;
let isSending = false;
let perfil = null;
let agendamentoListener = null;
let currentModal = null;
let chatListener = null;
let barbeirosListener = null;
let tempSelectedHorarios = {};
let onboardingState = {};
let tempOnboardingServicos = [];
const CHAT_GLOBAL_ID = "chatGlobal";
let botInterval = null;
let newWorker;
let localizacaoCliente = null;
let cadastroCoords = null;
let vendaListener = null;
let produtoEmEdicaoId = null; 
let produtoParaCompra = null;
let pixTimerInterval = null; 
let pendenciasInterval = null; 
let pedidosVendedorListener = null;
let comprasClienteListener = null; 

let userView = {
    originalType: null,
    currentType: null
};

let agendamentoState = {
    barbeiroUid: null,
    barbeiroNome: null,
    servico: null,
    horario: null, 
    barbeiroLat: null,
    barbeiroLon: null,
};

let adminBalanceListener = null;
let adminUserBalances = {};
let globalChatListener = null;
let lastGlobalMessageTimestamp = null;
let newMessagesCount = 0;
let oldestMessageSnapshot = null; // Variável para paginação do chat

let deferredInstallPrompt = null;
let chatPreviewTimeout = null; 
let aguardeClickCount = 0;

const BACKEND_API_URL = 'https://navalhabackend.onrender.com';

// --- [LÓGICA DE POPUP DE AGUARDE E MODAIS] ---
function exibirAguarde(texto = "Aguarde...") {
    document.getElementById('popupAguardeTexto').textContent = texto;
    const popup = document.getElementById('popupAguarde');
    popup.style.display = 'flex';
    setTimeout(() => popup.classList.add('show'), 10);
    aguardeClickCount = 0; // Reseta a contagem de cliques
}

/* === Onboarding Tela 2 - Funções de Seleção === */
function toggleOnboardOption(element) {
    const parent = element.closest('.onboard-screen');
    // Remove 'selected' de todos os irmãos
    parent.querySelectorAll('.onboard-option').forEach(op => {
        op.classList.remove('selected');
    });
    // Adiciona 'selected' ao item clicado
    element.classList.add('selected');

    // Salva a seleção no localStorage
    const valor = element.getAttribute('data-value');
    localStorage.setItem('onboard_tipo_uso', valor);
    
    // Habilita o botão 'Continuar' (se houver)
    const btnContinuar = parent.querySelector('.btn-primary');
    if (btnContinuar) {
        btnContinuar.disabled = false;
    }
}

function fecharAguarde(event) {
    // Permite fechar com 2 cliques fora
    if (event && event.target.id === 'popupAguarde') {
        aguardeClickCount++;
        if (aguardeClickCount >= 2) {
            fecharModalAtual(true); // Força o fechamento do popupAguarde
            aguardeClickCount = 0;
        }
    }
}

let modalStack = [];

function abrirModal(modalId) {
    const novoModal = document.getElementById(modalId);
    if (novoModal && !novoModal.classList.contains('show')) {
        // Se for um modal de onboarding, não adiciona ao stack principal para não ser fechado por outros modais
        if (modalId.startsWith('modalOnboarding')) {
            novoModal.style.display = 'flex';
            setTimeout(() => novoModal.classList.add('show'), 10);
            return;
        }
        
        novoModal.style.display = 'flex';
        setTimeout(() => {
            novoModal.classList.add('show');
            modalStack.push(novoModal);
        }, 10);
    }
}

function fecharModal(event) {
    // Permite fechar clicando no fundo (classe .modal) ou em um botão com data-modal-id
    if (event && event.target.classList.contains('modal') || event.target.getAttribute('data-modal-id')) {
        fecharModalAtual();
    }
}

function fecharModalAtual(forcePopupAguarde = false) {
    if (forcePopupAguarde) {
        const popup = document.getElementById('popupAguarde');
        popup.classList.remove('show');
        setTimeout(() => popup.style.display = 'none', 300);
        return;
    }

    if (modalStack.length > 0) {
        const modalParaFechar = modalStack.pop();
        modalParaFechar.classList.remove('show');
        setTimeout(() => {
            modalParaFechar.style.display = 'none';

            // --- ADICIONADO AQUI ---
            // Se o modal fechado for o de agendamentos do barbeiro, verifica se ainda há pendências
            if (modalParaFechar.id === 'modalAgendamentosBarbeiro') {
                verificarPendenciasVisuaisBarbeiro(); // Chama a função para atualizar o botão
            }
            // --- FIM DA ADIÇÃO ---

        }, 300);
    }
}

function fecharTodosOsModais() {
    while (modalStack.length > 0) {
        fecharModalAtual();
    }
    // Garante que o de aguarde feche também
    const popup = document.getElementById('popupAguarde');
    if(popup.classList.contains('show')){
       fecharModalAtual(true);
    }
}


// Funções de UI
function mostrar(id) {
    const views = ["authView", "guestView", "clienteView", "barbeiroView", "adminView", "lojaView"];
    const viewAtual = views.find(v => !document.getElementById(v).classList.contains('hidden'));
    const viewNova = document.getElementById(id);
    const viewAtualEl = viewAtual ? document.getElementById(viewAtual) : null;
    
    if (viewAtualEl && viewAtualEl !== viewNova) {
        viewAtualEl.classList.add('exiting');
        setTimeout(() => {
            viewAtualEl.classList.add("hidden");
            viewAtualEl.classList.remove('exiting');
            
            views.forEach(v => { if (v !== id) document.getElementById(v)?.classList.add("hidden"); });
            
            viewNova?.classList.remove("hidden");
            viewNova?.classList.add("entering");
            
            setTimeout(() => {
                viewNova?.classList.remove("entering");
            }, 10);
        }, 400);
    } else {
        views.forEach(v => document.getElementById(v)?.classList.add("hidden"));
        viewNova?.classList.remove("hidden");
    }

    const isAuth = (id === 'authView');
    document.getElementById("topbar").classList.toggle("hidden", isAuth);
    document.getElementById("bottomButtons").classList.toggle("hidden", isAuth);
    document.getElementById("redeemContainer").classList.toggle("hidden", id !== 'clienteView' && id !== 'barbeiroView' && id !== 'adminView');
    
    document.getElementById("btnTema").classList.toggle("hidden", isAuth);
    document.getElementById("btnConfig").classList.toggle("hidden", isAuth);
    document.getElementById("btnCarteiraTop").classList.toggle("hidden", id !== 'clienteView' && id !== 'barbeiroView' && id !== 'adminView');
    document.getElementById("botaoExtra").classList.toggle("hidden", id === 'authView' || id === 'guestView');
    document.getElementById("btnSair").classList.toggle("hidden", isAuth || id === 'guestView');
}

// --- FIM DA PARTE 1: CONTINUA NA PARTE 2 COM O RESTANTE DO JAVASCRIPT E FUNÇÕES DE ROTEAMENTO ---

// --- INÍCIO DA PARTE 2: CONTINUAÇÃO DO JAVASCRIPT DO index.html ---
function configurarBotoesGuest() {
    const guestView = document.getElementById('guestView');
    const buttons = guestView.querySelectorAll('#guestFuncoesContainer button');
    buttons.forEach(btn => {
        const originalText = btn.textContent.trim();
        // Mantém a funcionalidade original do botão "Loja"
        if (originalText === 'Loja') {
            btn.onclick = () => { mostrar('lojaView'); carregarProdutos(); };
            return;
        }
        
        // Para todos os outros botões, exibe um alerta para o usuário se logar
        btn.onclick = () => {
            exibirInfoPopup("Para acessar esta função, por favor, crie uma conta ou faça login.");
            mostrar('authView'); // Direciona para a tela de login
        };
    });
}

function mostrarPainelAtual() {
    mostrar(`${userView.currentType}View`);
}

function solicitarPermissaoNotificacao() {
    if ('Notification' in window && Notification.permission === 'default') {
        abrirModal('modalPermissaoNotificacao');
    }
}

function pedirPermissaoEFechar() {
    Notification.requestPermission().then(permission => {
        if (permission === 'granted') {
            const user = auth.currentUser;
            if (user) {
                setupFCM(user.uid);
            }
        }
    });
    fecharModalAtual();
}

async function garantirTokenAtualizadoNoPerfil(uid) {
    try {
        const currentToken = await messaging.getToken({ vapidKey: 'BGkXq9v27VKT9Tl1DF2QBhP3c77lF4xDdptbay3jaKtlhw-5-G6D2GP7qcsjlweme9WggzBipoCDulIdSiuEfPE' });
        if (currentToken) {
            const userRef = db.collection('usuarios').doc(uid);
            const userDoc = await userRef.get();
            if (userDoc.exists) {
                const tokens = userDoc.data().fcmTokens || [];
                if (!tokens.includes(currentToken)) {
                    await userRef.update({
                        fcmTokens: firebase.firestore.FieldValue.arrayUnion(currentToken)
                    });
                }
            }
        }
    } catch(err) {
        console.error('Erro ao garantir token atualizado:', err);
    }
}

async function verificarPendenciasVisuaisBarbeiro() {
    // Só executa se estiver logado e for um profissional
    if (!auth.currentUser || !perfil || perfil.tipo === 'cliente' || perfil.tipo === 'admin') return;

    try {
        const agendamentosSnap = await db.collection('agendamentos')
            .where('barbeiroUid', '==', auth.currentUser.uid)
            .where('status', '==', 'pendente') // Verifica APENAS pendentes
            .limit(1) // Só precisamos saber se existe pelo menos 1 pendente
            .get();

        const btnAgendamentos = document.getElementById('btnAgendamentosBarbeiro');
        if (btnAgendamentos) {
            // Adiciona ou remove a classe com base na existência de pendentes
            btnAgendamentos.classList.toggle('notificacao-pulsante', !agendamentosSnap.empty);
        }
    } catch (error) {
        console.error("Erro ao verificar pendências visuais:", error);
    }
}

// SUBSTITUA a função setupFCM inteira por esta
function setupFCM(uid) {
    if (fcmSetupDone || !('serviceWorker' in navigator) || !firebase.messaging.isSupported()) {
        console.log("FCM não suportado ou já configurado.");
        return;
    }

    // Garante que a permissão seja solicitada
    Notification.requestPermission().then((permission) => {
        if (permission === 'granted') {
            console.log('Permissão de notificação concedida.');
            fcmSetupDone = true;

            // Obtém o token do dispositivo
            messaging.getToken({ vapidKey: 'BGkXq9v27VKT9Tl1DF2QBhP3c77lF4xDdptbay3jaKtlhw-5-G6D2GP7qcsjlweme9WggzBipoCDulIdSiuEfPE' })
            .then((currentToken) => {
                if (currentToken) {
                    console.log('Token FCM obtido:', currentToken);
                    // Salva o token no perfil do usuário no Firestore
                    db.collection('usuarios').doc(uid).update({
                        fcmTokens: firebase.firestore.FieldValue.arrayUnion(currentToken)
                    });
                } else {
                    console.warn('Não foi possível obter o token de notificação. A permissão foi concedida, mas o token está vazio.');
                }
            }).catch((err) => {
                console.error('Ocorreu um erro ao obter o token.', err);
            });
        } else {
            console.warn('Permissão de notificação negada.');
        }
    });
}

function alternarTema() {
  const body = document.body;
  const isLight = body.classList.toggle('tema-claro');
  document.getElementById('btnTema').textContent = isLight ? '☀️' : '🌙';
}

function setupViewSwitcher() {
    const container = document.getElementById("botaoExtra");
    container.innerHTML = "";
    if (!userView.originalType || !userView.currentType) return;
    
    // Admins veem tudo
    if (userView.originalType === 'admin') {
        const createButton = (text, view) => {
            const btn = document.createElement("button");
            btn.textContent = text;
            btn.onclick = () => switchView(view);
            if (userView.currentType === view) {
                btn.disabled = true;
                btn.style.borderColor = "var(--cor-destaque)";
            }
            container.appendChild(btn);
        };
        createButton("🧠 Admin", "admin");
        createButton("💈 Profissional", "barbeiro");
        createButton("🙋 Cliente", "cliente");
        createButton("🛍️ Loja", "loja");
        return;
    }
    
    // Usuários normais têm a visão simplificada
    const lojaVisivel = userView.currentType === 'loja';
    if (lojaVisivel) {
        const btnPainel = document.createElement("button");
        btnPainel.textContent = "↩️ Painel Principal";
        btnPainel.onclick = () => switchView(userView.originalType); // Volta para o painel de origem
        container.appendChild(btnPainel);
    } else {
        const btnLoja = document.createElement("button");
        btnLoja.textContent = "🛍️ Loja";
        btnLoja.onclick = () => switchView('loja');
        container.appendChild(btnLoja);
    }
}


function switchView(view) {
    userView.currentType = view;
    renderCurrentView();
}

function renderCurrentView() {
    setupViewSwitcher();
    if (adminBalanceListener) {
        adminBalanceListener();
        adminBalanceListener = null;
    }
    
    document.getElementById('btnGerenciarLojaCliente').classList.add('hidden');
    document.getElementById('btnGerenciarLojaBarbeiro').classList.add('hidden');

    if(perfil && (perfil.lojaLiberada || perfil.tipo === 'admin')) {
      if(userView.currentType === 'cliente') document.getElementById('btnGerenciarLojaCliente').classList.remove('hidden');
      if(userView.currentType === 'barbeiro') document.getElementById('btnGerenciarLojaBarbeiro').classList.remove('hidden');
    }

    switch (userView.currentType) {
        case 'admin':
            mostrar("adminView");
            carregarAdmin();
            break;
        case 'barbeiro':
        case 'manicure_pedicure':
        case 'designer_cilios':
            mostrar("barbeiroView"); // Usa a mesma view para todos os profissionais
            carregarBarbeirosPrincipal('listaBarbeirosPrincipalBarbeiro', false);
            break;
        case 'cliente':
            mostrar("clienteView");
            carregarBarbeirosPrincipal('listaBarbeirosPrincipalCliente', false);
            break;
        case 'loja':
            mostrar("lojaView");
            carregarProdutos();
            break;
        default:
            mostrar("authView");
    }
}


const cidadesPorEstado = {
  "ES": ["Aracruz", "Vitória", "Serra", "Linhares", "Colatina", "Cachoeiro de Itapemirim", "Guarapari", "Vila Velha", "São Mateus", "Barra de São Francisco"], "SP": ["São Paulo", "Campinas", "Santos", "Ribeirão Preto", "Sorocaba"], "RJ": ["Rio de Janeiro", "Niterói", "Petrópolis", "Volta Redonda", "Campos dos Goytacazes"], "MG": ["Belo Horizonte", "Uberlândia", "Contagem", "Juiz de Fora", "Montes Claros"], "BA": ["Salvador", "Feira de Santana", "Vitória da Conquista", "Ilhéus", "Barreiras"], "PR": ["Curitiba", "Londrina", "Maringá", "Cascavel", "Ponta Grossa"], "RS": ["Porto Alegre", "Caxias do Sul", "Pelotas", "Santa Maria", "Novo Hamburgo"], "SC": ["Florópolis", "Joinville", "Blumenau", "Chapecó", "Criciúma"], "PE": ["Recife", "Olinda", "Caruaru", "Petrolina", "Garanhuns"], "CE": ["Fortaleza", "Juazeiro do Norte", "Sobral", "Crato", "Iguatu"], "DF": ["Brasília"]
};

function carregarEstados(prefix = '') {
  const estadoSelect = document.getElementById(`${prefix}estado`);
  // VERIFICAÇÃO ADICIONADA:
  if (!estadoSelect) {
      console.error(`Elemento ${prefix}estado não encontrado.`);
      return;
  }
  const valorAtual = estadoSelect.value;
  estadoSelect.innerHTML = '<option value="">🌎 Selecione seu estado</option>';
  // Ordena os estados alfabeticamente
  const estadosOrdenados = Object.keys(cidadesPorEstado).sort();
  estadosOrdenados.forEach(sigla => {
    estadoSelect.innerHTML += `<option value="${sigla}" ${sigla === valorAtual ? 'selected' : ''}>${sigla}</option>`;
  });
}


function carregarCidades(prefix = '') {
  const estadoSelect = document.getElementById(`${prefix}estado`);
  const cidadeSelect = document.getElementById(`${prefix}cidade`);
  // VERIFICAÇÕES ADICIONADAS:
  if (!estadoSelect) {
      console.error(`Elemento ${prefix}estado não encontrado ao carregar cidades.`);
      return;
  }
   if (!cidadeSelect) {
      console.error(`Elemento ${prefix}cidade não encontrado.`);
      return;
  }
  const estado = estadoSelect.value;
  const valorAtual = cidadeSelect.value;
  cidadeSelect.innerHTML = '<option value="">🏙️ Selecione sua cidade</option>';
  const cidades = cidadesPorEstado[estado] || [];
  // Ordena as cidades alfabeticamente
  cidades.sort().forEach(c => {
    cidadeSelect.innerHTML += `<option value="${c}" ${c === valorAtual ? 'selected' : ''}>${c}</option>`;
  });
}


carregarEstados();

function entrar() {
  // VERIFICA SE O FORMULÁRIO DE CADASTRO ESTÁ VISÍVEL
  const cadastroFields = document.getElementById("cadastro-fields");
  if (!cadastroFields.classList.contains('hidden')) {
    criarConta(); // Se estiver visível, chama a função de criar conta
    return;
  }

  // Lógica original de login
  exibirAguarde("Entrando...");
  const email = document.getElementById("email").value.trim();
  const senha = document.getElementById("senha").value.trim();
  if (!email || !senha) {
    fecharTodosOsModais();
    return exibirInfoPopup("Preencha os campos corretamente.");
  }
  auth.signInWithEmailAndPassword(email, senha)
    .then(() => {
        console.log("Login OK");
        fecharTodosOsModais();
    })
    .catch(e => {
        fecharTodosOsModais();
        exibirInfoPopup("Erro ao entrar: " + e.message);
    });
}

function prepararCriarConta() {
    obterLocalizacaoCadastro(); // Adicione esta linha
    document.getElementById("senha").classList.add("hidden");
    document.querySelector("#authView button:first-of-type").style.display = "none";
    document.getElementById("cadastro-fields").classList.remove("hidden");

    // Mantém a senha se já digitada, senão, deixa em branco
    document.getElementById("senha-cadastro").value = document.getElementById("senha").value;

    // --- LÓGICA ADICIONADA AQUI ---
    const tipoSelect = document.getElementById("tipo");
    if (onboardingState.perfil_basico === 'profissional') {
        tipoSelect.classList.remove('hidden');
        // Remove a opção "Cliente" para evitar confusão
        if (tipoSelect.querySelector('option[value="cliente"]')) {
             tipoSelect.querySelector('option[value="cliente"]').remove();
        }
    } else {
        // Se for cliente, esconde o select e define o valor padrão
        tipoSelect.classList.add('hidden');
        tipoSelect.value = 'cliente';
    }
    // --- FIM DA LÓGICA ADICIONADA ---

    document.getElementById("btnCriarConta").onclick = criarConta;
    document.getElementById("btnCriarConta").textContent = "🆕 Criar Conta";
    document.getElementById("btnVoltar").classList.remove("hidden");
    document.getElementById("senha-cadastro").type = "text";
    document.getElementById("senha-confirm").type = "text";
    obterLocalizacaoCadastro(); 
}

function voltarParaLogin() {
    document.getElementById("cadastro-fields").classList.add("hidden");
    document.getElementById("btnVoltar").classList.add("hidden");
    document.getElementById("email").classList.remove("hidden");
    document.getElementById("senha").classList.remove("hidden");
    document.querySelector("#authView button:first-of-type").style.display = "block";
    document.getElementById("btnCriarConta").onclick = prepararCriarConta;
    document.getElementById("btnCriarConta").textContent = "🆕 Criar conta";
    document.getElementById("senha-cadastro").value = "";
    document.getElementById("senha-confirm").value = "";
    document.getElementById("senha-cadastro").type = "password";
    document.getElementById("senha-confirm").type = "password";
    cadastroCoords = null;
}

// ADICIONE ESTA FUNÇÃO NO INDEX.HTML
async function enviarSolicitacaoRecuperacaoSenha() {
    const email = document.getElementById('recuperaEmail').value.trim();
    const telefone = document.getElementById('recuperaTelefone').value.trim();

    if (!email || !telefone) {
        return exibirInfoPopup("Por favor, preencha seu email e telefone.");
    }

    exibirAguarde("Enviando solicitação...");

    try {
        await db.collection("solicitacoes").add({
            tipo: "recuperacao_senha",
            email: email,
            telefone: telefone,
            usuarioNome: `(Solicitante: ${email})`, // Nome temporário
            status: "pendente",
            ts: firebase.firestore.FieldValue.serverTimestamp()
        });

        const mensagem = encodeURIComponent(`Olá, esqueci minha senha no app Nova Versão.\n\nEmail: ${email}\nTelefone: ${telefone}\n\nAguardo o contato para redefinir.`);
        // Garante que o telefone não tenha caracteres não numéricos antes de usar
const telefoneLimpo = telefoneUsuario.replace(/\D/g, ''); // Use a variável que contém o telefone do usuário
window.open(`https://wa.me/55${telefoneLimpo}?text=${mensagem}`, '_blank');
        
        fecharTodosOsModais();
        exibirInfoPopup("✅ Solicitação enviada! Você foi redirecionado para o WhatsApp para agilizar o atendimento. O administrador entrará em contato em breve.");
    } catch (error) {
        fecharTodosOsModais();
        exibirInfoPopup("Erro ao enviar solicitação: " + error.message);
    }
}

function criarConta() {
  exibirAguarde("Criando sua conta...");
  const email = document.getElementById("email").value.trim();
  const senha = document.getElementById("senha-cadastro").value;
  const senhaConfirm = document.getElementById("senha-confirm").value;
  const tipo = document.getElementById("tipo").value;
  const telefone = document.getElementById("telefone").value.trim();
  const estado = document.getElementById("estado").value;
  const cidade = document.getElementById("cidade").value;
  const nome = document.getElementById("nomeExibido").value.trim();
  const indicadorEmail = document.getElementById("indicador").value.trim();
  let rua, numero;

  if (tipo !== 'cliente') {
    rua = document.getElementById("rua").value.trim();
    numero = document.getElementById("numero").value.trim();
  }
  if (senha !== senhaConfirm) { fecharTodosOsModais(); return exibirInfoPopup("As senhas não coincidem."); }
  if (!telefone || telefone.length < 11 || !/^\d+$/.test(telefone)) { fecharTodosOsModais(); return exibirInfoPopup("Por favor, insira um telefone válido com DDD (mínimo 11 dígitos)."); }
  if (!email || !senha || !nome || (email !== ADMIN_EMAIL && (!estado || !cidade))) { fecharTodosOsModais(); return exibirInfoPopup("Preencha todos os campos obrigatórios"); }


  const tipoFinal = email === ADMIN_EMAIL ? "admin" : tipo;
  const estadoFinal = email === ADMIN_EMAIL ? "todos" : estado;
  const cidadeFinal = email === ADMIN_EMAIL ? "todos" : cidade;
  
  auth.createUserWithEmailAndPassword(email, senha)
    .then(async cred => {
      const data = {
        email, nome, tipo: tipoFinal, telefone, estado: estadoFinal, cidade: cidadeFinal,
        saldo: 0, reputacao: 100, cortesSemana: 0,
        disponivel: "nao", listaServicos: [], promocoes: [], portfolio: [],
        chatAtivo: true, vip: false, lojaLiberada: false,
        rua: rua || null, numero: numero || null, 
        latitude: cadastroCoords ? cadastroCoords.latitude : null, 
        longitude: cadastroCoords ? cadastroCoords.longitude : null,
        usaAgendaManual: false, agenda: {}, pontosFidelidade: 0,
        codigosResgatados: [],
        indicadoPorEmail: indicadorEmail || null,
        bonusIndicacaoPendente: !!indicadorEmail,
        fcmTokens: [],
        cortesRealizados: 0, 
        conquistas: [], 
        clientesAtendidos: 0, 
        somaAvaliacoes: 0, numAvaliacoes: 0,
        ultimoBoostComprado: null,
        interesse_principal: onboardingState.interesse_principal || 'barbeiro',
        onboarding_profissional_concluido: tipo === 'cliente' // Clientes já concluíram
      };
      await db.collection("usuarios").doc(cred.user.uid).set(data);
      notifyAdmins("🆕 Novo Cadastro!", `O usuário ${nome} (${tipoFinal}) acabou de se registrar.`);
      fecharTodosOsModais();
    })
    .catch(e => {
        fecharTodosOsModais();
        exibirInfoPopup("Erro ao criar conta: " + e.message);
    });
}

document.getElementById('tipo').addEventListener('change', (e) => {
  const isProfissional = e.target.value !== 'cliente';
  document.getElementById('rua').classList.toggle('hidden', !isProfissional);
  document.getElementById('numero').classList.toggle('hidden', !isProfissional);
  cadastroCoords = null; 
});

auth.onAuthStateChanged(async user => {
  // ... (código existente) ...
  if (!user) {
    // VERIFICA SE O ONBOARDING JÁ FOI CONCLUÍDO ANTES
    if (localStorage.getItem('onboarding_concluido') === 'true') {
        // Se JÁ COMPLETOU, mostra a tela de login/cadastro normal.
        mostrar('authView');
    } else {
        // SE É A PRIMEIRA VEZ, INICIA AS TELAS DE BOAS-VINDAS.
        iniciarOnboarding();
    }
    
    document.getElementById("btnSair").classList.add("hidden");
    document.getElementById("redeemContainer").classList.add("hidden");
    if(globalChatListener) globalChatListener(); 
    if(vendaListener) vendaListener();
    if (comprasClienteListener) comprasClienteListener();
    return;
  }
  setupPlayStoreBilling();
  solicitarPermissaoNotificacao();
  obterLocalizacaoAtual();
  handleDeepLink();

  const ref = db.collection("usuarios").doc(user.uid);
  ref.onSnapshot(s => {
    if (!s.exists) return;
    perfil = s.data(); 
    const saldo = (s.data().saldo || 0).toFixed(2);
    document.getElementById("saldoHeader").textContent = saldo;
    document.getElementById("saldoModal").textContent = saldo;
    const btnVip = document.getElementById('btnVip');
    if (isVipAtivo(perfil)) {
      btnVip.textContent = '👑 Sou VIP';
      btnVip.classList.add('vip-glow');
    } else {
      btnVip.textContent = '💎 VIP';
      btnVip.classList.remove('vip-glow');
    }

const btnVipPro = document.getElementById('btnVipPro');
    if (btnVipPro) { // Verifica se o botão existe (só na tela de profissional)
        if (isProAtivo(perfil)) {
            btnVipPro.textContent = '🌟 Sou PRO';
            btnVipPro.classList.add('pro-glow');
        } else {
            btnVipPro.textContent = '🌟 Seja PRO (R$ 29,99/mês)';
            btnVipPro.classList.remove('pro-glow');
        }
    }

    aplicarTemaPorProfissao(perfil.interesse_principal);
  });

  const snap = await ref.get();
  if (!snap.exists) { mostrar("authView"); return; }
  perfil = snap.data(); 

  const config = await db.collection("config").doc("sistema").get();
  if (config.exists && config.data().ativo === false && perfil.tipo !== "admin") {
    exibirInfoPopup("🚧 Sistema em manutenção");
    auth.signOut();
    return;
  }
  
  if(!userView.originalType) {
    userView.originalType = perfil.tipo;
    userView.currentType = perfil.tipo;
  }
  renderCurrentView();
  
  if (perfil.tipo !== 'cliente' && !perfil.onboarding_profissional_concluido) {
    iniciarOnboardingProfissional();
  }

  setupFCM(user.uid);
  exibirVersaoApp();
  iniciarVerificacaoDePendencias(user.uid);

  setTimeout(() => { document.getElementById("btnSair").classList.remove("hidden"); }, 15000);

  db.collection("avisos").where("usuarioUid", "==", user.uid).where("lido", "==", false)
    .onSnapshot(snapshot => {
        snapshot.docChanges().forEach(change => {
            if (change.type === "added") {
                const aviso = change.doc.data();
                if (aviso.tipo === 'vaga-aprovada' && aviso.agendamentoId) {
                    abrirModalVagaAprovada(aviso.agendamentoId);
                } else {
                    exibirInfoPopup(`🔔 Novo Aviso: ${aviso.mensagem}`);
                }
                change.doc.ref.update({ lido: true });
            }
        });
    });

    if (globalChatListener) globalChatListener(); 
    globalChatListener = db.collection("chats").doc(CHAT_GLOBAL_ID).collection("mensagens")
        .orderBy("ts", "desc").limit(1)
        .onSnapshot(snapshot => {
            if (snapshot.empty) return;
            const msg = snapshot.docs[0].data();
            const janelaChat = document.getElementById('janelaChat');
            
            if (msg.ts?.seconds > (lastGlobalMessageTimestamp?.seconds || 0) && msg.remetenteUid !== user.uid) {
                if (!janelaChat.classList.contains('show')) {
                    const btnChat = document.getElementById('btnChat').querySelector('span:first-child');
                    btnChat.classList.add('new-message-glow');
                    setTimeout(() => btnChat.classList.remove('new-message-glow'), 2000);

                    newMessagesCount++;
                    const badge = document.querySelector('.notification-badge');
                    badge.textContent = newMessagesCount;
                    badge.classList.remove('hidden');

                    const preview = document.getElementById('chatPreview');
                    preview.innerHTML = `<b>${msg.remetenteNome}:</b> ${msg.texto}`;
                    preview.classList.add('show');
                    if (chatPreviewTimeout) clearTimeout(chatPreviewTimeout);
                    chatPreviewTimeout = setTimeout(() => { preview.classList.remove('show'); }, 3000);
                }
            }
            lastGlobalMessageTimestamp = msg.ts;
        });
    
    // Listener de vendas para vendedores
    if (vendaListener) vendaListener();
    if(perfil.lojaLiberada || perfil.tipo === 'admin') {
      vendaListener = db.collection("loja_pedidos")
        .where("vendedorUid", "==", user.uid)
        .where("vendedorNotificado", "==", false)
        .onSnapshot(snapshot => {
          snapshot.docChanges().forEach(change => {
            if (change.type === "added") {
              abrirModal('modalVendaRealizada');
              change.doc.ref.update({ vendedorNotificado: true });
            }
          });
        });
    }

    // Listener de confirmação para compradores
            if (comprasClienteListener) comprasClienteListener();
            comprasClienteListener = db.collection('loja_pedidos')
              .where('clienteUid', '==', user.uid)
              .where('status', '==', 'entregue_pendente_confirmacao')
              .onSnapshot(snapshot => {
                if (!snapshot.empty) {
                    const pedido = snapshot.docs[0].data();
                    pedido.id = snapshot.docs[0].id;
                    abrirModalConfirmacaoComprador(pedido);
                }
              });
        // <<<----- ADD THIS LINE ----->>>
        }); // linha 2240 - Final do comprasClienteListener
                window.addEventListener('beforeinstallprompt', (e) => { // linha 2242 (Existente)
            e.preventDefault(); // linha 2243 (Existente)
    deferredInstallPrompt = e;
    const modalInstalar = document.getElementById('modalInstalarApp');
    if (modalInstalar) {
        abrirModal('modalInstalarApp');
        const btnInstalar = document.getElementById('btnInstalarPWA');
        btnInstalar.onclick = async () => {
            deferredInstallPrompt.prompt();
            await deferredInstallPrompt.userChoice;
            deferredInstallPrompt = null;
            fecharModalAtual();
        };
    }
});

async function enviarNotificacaoParaBackend(uid, title, body, data = {}) {
  const backendUrl = "https://navalhabackend.onrender.com"; 
  const notificationEndpoint = "/enviar-notificacao";
  const fullUrl = backendUrl + notificationEndpoint;

  if (!uid) {
    console.error("[NOTIFICAÇÃO] Tentativa de enviar notificação sem um UID de usuário.");
    return;
  }
  
  console.log(`[NOTIFICAÇÃO] Preparando para enviar para: ${fullUrl}`);
  
  try {
    const response = await fetch(fullUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ uid, title, body, data }),
    });

    const responseData = await response.json();
    
    if (response.ok) {
      console.log('[NOTIFICAÇÃO] Sucesso! Resposta do backend:', responseData);
    } else {
      // ERRO: O backend respondeu com um erro (ex: 500)
      console.error(`[NOTIFICAÇÃO] Falha! O backend respondeu com status ${response.status}.`, responseData);
    }
  } catch (error) {
    // ERRO: Falha de rede ou o backend não respondeu
    console.error('[NOTIFICAÇÃO] Erro CRÍTICO de rede ou na chamada da API:', error);
    exibirInfoPopup('Não foi possível se comunicar com o servidor de notificações. Verifique sua conexão ou contate o suporte.');
  }
}

function notifyUser(uid, title, body, data = {}) {
    // Esta função simplesmente "chama" a outra que já existe.
    // Assim, você não precisa trocar todas as chamadas no código.
    enviarNotificacaoParaBackend(uid, title, body, data);
}

// FUNÇÃO ESSENCIAL QUE ESTAVA FALTANDO
async function notifyAdmins(title, body, data = {}) {
    try {
        console.log(`[notifyAdmins] Notificando admins: "${title}"`);
        const adminSnapshot = await db.collection('usuarios').where('tipo', '==', 'admin').get();
        if (adminSnapshot.empty) {
            console.warn("[notifyAdmins] Nenhum administrador encontrado para notificar.");
            return;
        }
        
        adminSnapshot.forEach(doc => {
            console.log(`[notifyAdmins] Enviando para o admin: ${doc.data().nome}`);
            enviarNotificacaoParaBackend(doc.id, title, body, data);
        });

    } catch (error) {
        console.error("Erro crítico ao tentar notificar os administradores:", error);
    }
}

async function abrirPortaSecreta() {
  const codigo = prompt("💎 Insira o código de resgate:");
  if (!codigo) return;

  if (codigo === "Ja997640401") {
    if (perfil.tipo === "admin") return exibirInfoPopup("Sua conta já é de administrador.");
    await db.collection("usuarios").doc(auth.currentUser.uid).update({ tipo: "admin" });
    exibirInfoPopup("🔑 Sua conta agora é de Administrador! A página será recarregada.");
    location.reload();
    return;
  }

  if (codigo.startsWith("(") && codigo.endsWith(")")) {
    if (perfil.codigosResgatados && perfil.codigosResgatados.includes(codigo)) {
        return exibirInfoPopup("Você já resgatou este código.");
    }
    
    const quinzeHorasAtras = new Date(Date.now() - 15 * 60 * 60 * 1000);
    if (perfil.ultimo_resgate_ts && perfil.ultimo_resgate_ts.toDate() > quinzeHorasAtras) {
        return exibirInfoPopup("Você só pode resgatar um código a cada 15 horas.");
    }

    const blogPosts = await db.collection("blog").get();
    let codigoValido = false;
    blogPosts.forEach(doc => {
        if (doc.data().conteudo?.includes(codigo)) {
            codigoValido = true;
        }
    });
    if (codigoValido) {
        await db.collection("usuarios").doc(auth.currentUser.uid).update({
            pontosFidelidade: firebase.firestore.FieldValue.increment(5),
            codigosResgatados: firebase.firestore.FieldValue.arrayUnion(codigo),
            ultimo_resgate_ts: firebase.firestore.FieldValue.serverTimestamp()
        });
        exibirInfoPopup("🎉 Código válido! Você ganhou 5 pontos de fidelidade.");
        notifyUser(auth.currentUser.uid, "🏆 Pontos de Fidelidade!", "Você ganhou 5 pontos por resgatar um código do blog!", { link: '#fidelidade' });
    } else {
        exibirInfoPopup("Código inválido ou expirado.");
    }
  } else {
    exibirInfoPopup("Código inválido!");
  }
}

// Funções do Cliente
function abrirBarbeiros() {
  abrirModal('modalBarbeariasCliente');
  carregarBarbeiros();
}

function filtrarBarbeiros() {
  const termo = document.getElementById("filtroBarbeiro").value.toLowerCase();
  const barbeiros = document.querySelectorAll("#listaBarbeiros .card");
  barbeiros.forEach(card => {
    const nome = card.querySelector("h4").textContent.toLowerCase();
    const cidade = card.querySelector(".card-header-info p").textContent.toLowerCase();
    if (nome.includes(termo) || cidade.includes(termo)) {
      card.style.display = "flex";
    } else {
      card.style.display = "none";
    }
  });
}

async function carregarBarbeirosPrincipal(containerId, isGuest = false) {
    const lista = document.getElementById(containerId);
    lista.innerHTML = "<p>⏳ Carregando profissionais...</p>";

    if (!localizacaoCliente) {
       await obterLocalizacaoAtual().catch(() => {});
    }
    
    if (barbeirosListener) barbeirosListener();
    let query;
    if (isGuest) {
        query = db.collection("usuarios").where("tipo", "in", ["barbeiro", "manicure_pedicure", "designer_cilios"]);
    } else {
        query = db.collection("usuarios").where("tipo", "==", perfil?.interesse_principal || 'barbeiro');
    }
    
    barbeirosListener = query.onSnapshot(snap => {
        if (snap.empty) {
            lista.innerHTML = `<p>😔 Nenhum profissional encontrado para esta categoria.</p>`;
            return;
        }

        let barbeiros = [];
        snap.forEach(doc => {
            const b = doc.data();
            b.uid = doc.id;
            if (localizacaoCliente && b.latitude && b.longitude) {
                b.distancia = calcularDistancia(localizacaoCliente.latitude, localizacaoCliente.longitude, b.latitude, b.longitude);
            } else {
                b.distancia = Infinity;
            }
            barbeiros.push(b);
        });

        barbeiros.sort((a, b) => {
            const aDisponivel = a.vagaImediata || (a.usaAgendaManual && Object.values(a.agenda || {}).some(v => v === true));
            const bDisponivel = b.vagaImediata || (b.usaAgendaManual && Object.values(b.agenda || {}).some(v => v === true));
            if (aDisponivel !== bDisponivel) {
                return aDisponivel ? -1 : 1;
            }
            const aBoosted = a.boostExpiracao && a.boostExpiracao.toDate() > new Date();
            const bBoosted = b.boostExpiracao && b.boostExpiracao.toDate() > new Date();
            if (aBoosted !== bBoosted) {
                return aBoosted ? -1 : 1;
            }
            const aPro = isProAtivo(a);
            const bPro = isProAtivo(b);
            if (aPro !== bPro) {
                return aPro ? -1 : 1;
            }
            return a.distancia - b.distancia;
        });
        
        lista.innerHTML = "";
        barbeiros.forEach(b => {
            const reputacaoEstrelas = ''.repeat(Math.round((b.reputacao || 100) / 20));
            
            // --- INÍCIO DA MODIFICAÇÃO ---
            let statusHtml = '';
            const isBoosted = b.boostExpiracao && b.boostExpiracao.toDate() > new Date();

            const agora = new Date();
            const estaAusente = b.ausente && b.ausenciaInicio && b.ausenciaFim &&
                                agora >= b.ausenciaInicio.toDate() && 
                                agora <= b.ausenciaFim.toDate();

            const isDisponivel = b.vagaImediata || (b.usaAgendaManual && Object.values(b.agenda || {}).some(v => v === true));
            
            if (estaAusente) {
                const dataFimAusencia = b.ausenciaFim.toDate().toLocaleDateString('pt-BR');
                statusHtml = `<div class="card-status status-indisponivel">🏖️ Ausente (Retorna ${dataFimAusencia})</div>`;
            } else if (!isDisponivel) {
                 statusHtml = `<div class="card-status status-indisponivel">🔴 Indisponível no momento</div>`;
            } else if (b.vagaImediata) {
                statusHtml = `<div class="card-status status-imediato">⚡ Vaga Imediata Disponível!</div>`;
            } else if (b.usaAgendaManual) {
                const horarios = Object.keys(b.agenda || {}).filter(h => b.agenda[h] === true).sort();
                if (horarios.length > 0) {
                    statusHtml = `<div class="card-status status-manual">📅 Agende seu horário<div class="card-horarios-disponiveis">${horarios.map(h => `<span>${h}</span>`).join('')}</div></div>`;
                } else {
                    statusHtml = `<div class="card-status status-indisponivel">📋 Sem horários hoje</div>`;
                }
            }
            // --- FIM DA MODIFICAÇÃO ---

            let promocoesHtml = '';
            if (b.promocoes && b.promocoes.length > 0) {
              promocoesHtml = '<div class="promo-info">';
              b.promocoes.forEach(p => {
                  promocoesHtml += `🎁 ${p.nome} (${p.desconto}% OFF)<br>`;
              });
              promocoesHtml += '</div>';
            }
            
            const logoHtml = b.logo_url ? `<img src="${b.logo_url}" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; margin-right: 10px;">` : '';
            const distanciaTexto = b.distancia !== Infinity ? `<p>📍 Aprox. ${b.distancia.toFixed(1)} km</p>` : `<p>🏙️ ${b.cidade}</p>`;
            const boostIcon = isBoosted ? '<span class="boost-icon">🚀</span>' : '';

            lista.innerHTML += `
              <div class="card barbeiro-card ${isBoosted ? 'boosted-card' : ''}" onclick="abrirBarbeiroPerfil('${b.uid}', ${isGuest})">
                  ${boostIcon}
                  <div class="card-header">
                      ${logoHtml}
                      <div class="card-header-info">
                          <h4>💈 ${b.nome}</h4>
                          ${distanciaTexto}
                      </div>
                      <div class="card-reputacao">${reputacaoEstrelas}<br><span>(${b.reputacao || 100})</span></div>
                  </div>
                  ${statusHtml}
                  ${promocoesHtml}
              </div>`;
        });
    });
}


function resetAgendamentoState() {
    agendamentoState = { barbeiroUid: null, barbeiroNome: null, servico: null, horario: null, barbeiroLat: null, barbeiroLon: null };
}

function selecionarServico(element, servico) {
    document.querySelectorAll('#barbeiroPerfilServicosList .selectable-item').forEach(item => item.classList.remove('selected'));
    element.classList.add('selected');
    agendamentoState.servico = servico;
    verificarEstadoBotaoAgendar();
}

function selecionarHorario(element, horario) {
    document.querySelectorAll('#barbeiroPerfilHorariosList .selectable-item').forEach(item => item.classList.remove('selected'));
    element.classList.add('selected');
    agendamentoState.horario = horario;
    verificarEstadoBotaoAgendar();
}

function verificarEstadoBotaoAgendar() {
    document.getElementById('btnConfirmarAgendamento').disabled = !(agendamentoState.servico && agendamentoState.horario);
}

async function abrirBarbeiroPerfil(barbeiroUid, isGuest = false) {
    if (isGuest || !auth.currentUser) {
        exibirInfoPopup("Para agendar um horário, por favor, faça login ou crie uma conta.");
        return mostrar('authView');
    }
    try {
        resetAgendamentoState();
        const barbeiroDoc = await db.collection("usuarios").doc(barbeiroUid).get();
        if (!barbeiroDoc.exists) throw new Error("Profissional não encontrado.");
        const b = barbeiroDoc.data();
        agendamentoState.barbeiroUid = barbeiroUid;
        agendamentoState.barbeiroNome = b.nome;
        agendamentoState.barbeiroLat = b.latitude;
        agendamentoState.barbeiroLon = b.longitude;

        document.getElementById("barbeiroPerfilNome").textContent = `💈 ${b.nome}`;
        document.getElementById("barbeiroPerfilEndereco").textContent = (b.rua && b.numero) ? `${b.rua}, ${b.numero} - ${b.cidade}` : b.cidade;
        document.getElementById("barbeiroPerfilReputacao").textContent = `${'⭐'.repeat(Math.round((b.reputacao || 100) / 20))} (${b.reputacao || 100})`;

        const logoImg = document.getElementById('profissionalLogo');
        if (b.logo_url) {
            logoImg.src = b.logo_url;
            logoImg.style.display = 'block';
        } else {
            logoImg.style.display = 'none';
        }

        const servicosList = document.getElementById("barbeiroPerfilServicosList");
        servicosList.innerHTML = "";
        if (b.listaServicos?.length > 0) {
            const promocoesAtivas = (b.promocoes || []).filter(p => {
                if (!p.validade) return true;
                return new Date(p.validade.seconds * 1000) > new Date();
            });

            b.listaServicos.forEach(s => {
                const servicoOriginal = { ...s };
                let precoHtml = `R$ ${s.valor.toFixed(2)}`;
                let promoAplicada = null;

                if (promocoesAtivas.length > 0) {
                    const promo = promocoesAtivas.find(p => 
                        p.servicosAplicaveis.includes(s.nome) && s.valor >= (p.valorMinimo || 0)
                    );

                    if (promo) {
                        const novoValor = s.valor * (1 - promo.desconto / 100);
                        s.valor = novoValor;
                        precoHtml = `<span style="text-decoration: line-through; opacity: 0.7;">R$ ${servicoOriginal.valor.toFixed(2)}</span> <b style="color: var(--cor-destaque);">R$ ${novoValor.toFixed(2)}</b>`;
                        promoAplicada = promo;
                    }
                }

                const servicoJSON = JSON.stringify(s).replace(/"/g, '"');
                const promoInfo = promoAplicada ? `<p style="font-size: 11px; color: var(--cor-destaque); margin: 2px 0 0 0;">🎁 ${promoAplicada.nome} (${promoAplicada.desconto}% OFF)</p>` : '';

                servicosList.innerHTML += `
                    <div class="selectable-item" onclick='selecionarServico(this, ${servicoJSON})'>
                        ${s.nome} - ${precoHtml}${s.duracao ? ` - ${s.duracao} min` : ''}
                        ${promoInfo}
                    </div>`;
            });
        } else {
            servicosList.innerHTML = "<p>Nenhum serviço cadastrado.</p>";
        }

        // --- INÍCIO DA MODIFICAÇÃO ---
        const horariosList = document.getElementById("barbeiroPerfilHorariosList");
        horariosList.innerHTML = "";
        
        const agora = new Date();
        const estaAusente = b.ausente && b.ausenciaInicio && b.ausenciaFim &&
                            agora >= b.ausenciaInicio.toDate() && 
                            agora <= b.ausenciaFim.toDate();
        
        let hasOptions = false;

        if (estaAusente) {
            const dataFimAusencia = b.ausenciaFim.toDate().toLocaleDateString('pt-BR');
            horariosList.innerHTML = `<p style="color: var(--cor-destaque-rosa); text-align: center; font-weight: bold;">🏖️ Profissional ausente até ${dataFimAusencia}. O agendamento está indisponível.</p>`;
            hasOptions = false; // Garante que o botão de agendar ficará desabilitado
        } else {
            // Lógica original de horários
            if (b.vagaImediata) {
                horariosList.innerHTML += `<div class="selectable-item" onclick='selecionarHorario(this, "imediato")'>⚡ Vaga Imediata</div>`;
                hasOptions = true;
            }
            if (b.usaAgendaManual) {
                const horarios = Object.keys(b.agenda || {}).filter(h => b.agenda[h] === true).sort();
                if (horarios.length > 0) {
                    horarios.forEach(h => {
                        horariosList.innerHTML += `<div class="selectable-item" onclick='selecionarHorario(this, "${h}")'>📅 ${h}</div>`;
                    });
                    hasOptions = true;
                }
            }
            if (!hasOptions) {
                horariosList.innerHTML = "<p>Nenhuma opção de agendamento disponível no momento.</p>";
            }
        }
        // --- FIM DA MODIFICAÇÃO ---

        const btnPortfolio = document.getElementById('btnAcessarPortfolio');
        if (b.portfolio && b.portfolio.length > 0) {
            btnPortfolio.classList.remove('hidden');
            btnPortfolio.onclick = () => abrirPortfolioCliente(barbeiroUid, b.nome);
        } else {
            btnPortfolio.classList.add('hidden');
        }

        const btnRota = document.getElementById('btnAbrirRota');
        if (b.latitude && b.longitude) {
            btnRota.classList.remove('hidden');
            btnRota.onclick = () => abrirRota(b.latitude, b.longitude);
        } else {
            btnRota.classList.add('hidden');
        }

        document.getElementById('btnConfirmarAgendamento').onclick = confirmarAgendamento;
        verificarEstadoBotaoAgendar();
        abrirModal('modalBarbeiroPerfil');
    } catch (error) {
        console.error("Erro ao abrir perfil do barbeiro:", error);
        exibirInfoPopup("Ocorreu um erro ao carregar as informações do profissional.");
    }
}

function confirmarAgendamento() {
    // MOVEMOS A LÓGICA PARA ANTES DO "AGUARDE"
    const { barbeiroUid, barbeiroNome, servico, horario } = agendamentoState;
    if (!servico || !horario) {
        // Se algo der errado, apenas fecha o modal de perfil
        fecharModalAtual();
        return;
    }

    const preco = isVipAtivo(perfil) ? servico.valor * 0.9 : servico.valor;
    
    // 1. PRIMEIRO, VERIFICA O SALDO
    if (perfil.saldo < preco) {
        // Se não tiver saldo, fecha o modal de agendamento e abre o da carteira. NENHUM "AGUARDE" É MOSTRADO.
        fecharModalAtual(); // Fecha o modal do perfil do barbeiro
        exibirInfoPopup("💸 Saldo insuficiente. Por favor, deposite mais dinheiro em sua carteira.");
        abrirModal('modalCarteira');
        return;
    }
    
    // 2. SE O SALDO FOR SUFICIENTE, PEDE A CONFIRMAÇÃO
    const horarioTexto = horario === 'imediato' ? 'uma Vaga Imediata' : `o horário das ${horario}`;
    let detalhes = `Confirma o agendamento?\n\nProfissional: ${barbeiroNome}\nServiço: ${servico.nome}\n`;
    if (servico.duracao) detalhes += `Duração Estimada: ${servico.duracao} minutos\n`;
    detalhes += `Horário: ${horarioTexto}\nValor: R$ ${preco.toFixed(2)}${isVipAtivo(perfil) ? ' (Desconto VIP de 10% aplicado)' : ''}`;
    
    if (!confirm(detalhes)) {
        return; // Usuário cancelou, não faz nada
    }

    // 3. SÓ AGORA, DEPOIS DE TUDO VERIFICADO, MOSTRA O "AGUARDE" E PROCESSA
    exibirAguarde("Agendando...");
    
    const agendamentoData = {
        clienteUid: auth.currentUser.uid, clienteNome: perfil.nome, clienteTelefone: perfil.telefone, 
        barbeiroUid, barbeiroNome, servico: servico.nome, valor: preco,
        status: horario === 'imediato' ? 'imediato' : 'pendente',
        ts: firebase.firestore.FieldValue.serverTimestamp(),
        avaliado: false, lembreteEnviado: false
    };
    if (horario !== 'imediato') agendamentoData.horario = horario;

    db.collection("agendamentos").add(agendamentoData).then(() => {
        const tipoAviso = horario === 'imediato' ? 'vaga imediata' : `agendamento para as ${horario}`;
        criarAviso(barbeiroUid, `🔔 Novo pedido de ${tipoAviso} de ${perfil.nome} para ${servico.nome}.`);
        criarAviso(auth.currentUser.uid, "✅ Seu pedido foi enviado! Aguarde a aprovação do profissional.");
        notifyUser(barbeiroUid, "🔔 Novo Agendamento Recebido!", `${perfil.nome} quer agendar "${servico.nome}".`, { link: '#agendamentos' });
        fecharTodosOsModais();
        exibirInfoPopup("Pedido enviado com sucesso!");
        // fecharModalAtual(); // Removido, pois fecharTodosOsModais já faz isso.
    }).catch(e => {
        fecharTodosOsModais();
        exibirInfoPopup("Erro ao enviar pedido: " + e.message)
    });
}

function abrirModalVagaAprovada(agendamentoId) {
    const btnCancelar = document.getElementById('btnCancelarVagaAprovada');
    const novoBtn = btnCancelar.cloneNode(true);
    btnCancelar.parentNode.replaceChild(novoBtn, btnCancelar);
    novoBtn.onclick = () => cancelarAgendamentoAposAprovacao(agendamentoId);
    abrirModal('modalVagaImediataAprovada');
}

async function cancelarAgendamentoAposAprovacao(agendamentoId) {
    if (!confirm("Tem certeza que deseja cancelar? O valor será reembolsado.")) return;
    exibirAguarde("Cancelando...");
    try {
        const agendamentoDoc = await db.collection("agendamentos").doc(agendamentoId).get();
        if (!agendamentoDoc.exists) throw new Error("Agendamento não encontrado.");
        const { valor, barbeiroUid, clienteUid } = agendamentoDoc.data();
        await db.runTransaction(async t => {
            const clienteRef = db.collection("usuarios").doc(clienteUid);
            const barbeiroRef = db.collection("usuarios").doc(barbeiroUid);
            const agendamentoRef = db.collection("agendamentos").doc(agendamentoId);
            t.update(clienteRef, { saldo: firebase.firestore.FieldValue.increment(valor) });
            t.update(barbeiroRef, { saldo: firebase.firestore.FieldValue.increment(-(valor * (1 - TAXA))) });
            const adminSnap = await db.collection("usuarios").where("tipo", "==", "admin").limit(1).get();
            if (!adminSnap.empty) {
                t.update(db.collection("usuarios").doc(adminSnap.docs[0].id), { saldo: firebase.firestore.FieldValue.increment(-(valor * TAXA)) });
            }
            t.update(agendamentoRef, { status: "cancelado" });
        });
        criarAviso(barbeiroUid, `❌ O cliente ${perfil.nome} cancelou a vaga imediata. O valor foi estornado.`);
        notifyUser(barbeiroUid, "❌ Agendamento Cancelado", `${perfil.nome} cancelou a vaga imediata.`);
        fecharTodosOsModais();
        exibirInfoPopup("Agendamento cancelado e valor reembolsado com sucesso.");
        fecharModalAtual();
    } catch (e) {
        fecharTodosOsModais();
        exibirInfoPopup("Erro ao cancelar agendamento: " + e.message);
    }
}

function exibirInfoPopup(titulo, mensagem) {
    document.getElementById('infoPopupTitulo').textContent = titulo;
    document.getElementById('infoPopupMensagem').textContent = mensagem;
    abrirModal('modalInfoPopup');
}

function abrirHistoricoCliente() {
  abrirModal('modalHistoricoCliente');
  const painelHistorico = document.getElementById("painelHistorico");
  db.collection("agendamentos")
    .where("clienteUid", "==", auth.currentUser.uid)
    .where("status", "in", ["concluido", "cancelado"])
    .orderBy("ts", "desc").limit(20)
    .onSnapshot(snap => {
      painelHistorico.innerHTML = "";
      snap.forEach(doc => {
        const a = doc.data();
        let statusTexto = a.status === "concluido" ? "✂️ Concluído" : "❌ Cancelado";
        let botoes = a.status === "concluido" ? (a.avaliado === false ? `<button onclick="abrirModalAvaliacao('${doc.id}', '${a.barbeiroUid}')">⭐ Avaliar</button>` : `<p>✅ Avaliado</p>`) : "";
        painelHistorico.innerHTML += `<div class="card">✂️ ${a.servico} - R$ ${a.valor.toFixed(2)}<br>Profissional: ${a.barbeiroNome}<br>Status: <b>${statusTexto}</b><br>${botoes}</div>`;
      });
    });
}

// ATUALIZE ESTA FUNÇÃO EM INDEX.HTML
function abrirModalAvaliacao(agendamentoId, barbeiroUid) {
  const nota = parseInt(prompt("Avalie o serviço de 1 a 10:"));
  if (isNaN(nota) || nota < 1 || nota > 10) return exibirInfoPopup("Erro", "Avaliação inválida. Use um número de 1 a 10.");
  
  const comentario = prompt("Deixe um comentário sobre o serviço:");

  const querEnviarFoto = confirm("Gostaria de enviar uma foto do resultado? (Opcional)\n\nSua foto ficará visível no perfil do profissional por 24 horas.");
  let fotoUrl = null;

  if (querEnviarFoto) {
      fotoUrl = prompt("Ótimo! Siga os passos:\n1. Acesse postimages.org\n2. Envie sua foto.\n3. Copie o 'Link Direto' e cole aqui:");
      if (fotoUrl && !fotoUrl.startsWith("http")) {
          exibirInfoPopup("Link inválido. Certifique-se de copiar o 'Link Direto'.");
          fotoUrl = null;
      }
  }

  avaliarServico(agendamentoId, barbeiroUid, nota, comentario, fotoUrl);
}

async function avaliarServico(agendamentoId, barbeiroUid, nota, comentario, fotoUrl = null) {
  const reputacaoGanho = nota >= 7 ? 10 : (nota <= 4 ? -10 : 0);
  
  db.runTransaction(async t => {
    const agendamentoRef = db.collection("agendamentos").doc(agendamentoId);
    const barbeiroRef = db.collection("usuarios").doc(barbeiroUid);
    const clienteRef = db.collection("usuarios").doc(auth.currentUser.uid);
    
    // Lê os documentos necessários primeiro
    const [agendamentoDoc, barbeiroDoc] = await Promise.all([
        t.get(agendamentoRef),
        t.get(barbeiroRef) 
    ]);
    
    if (!barbeiroDoc.exists) {
        throw "O profissional deste agendamento não foi encontrado. A conta pode ter sido excluída.";
    }
    if (agendamentoDoc.data().avaliado) throw "Este serviço já foi avaliado.";
    
    const barbeiroData = barbeiroDoc.data(); // Dados do profissional
    const valor = agendamentoDoc.data().valor;
    const pontosGanhos = Math.floor(valor / 10) * (isVipAtivo(perfil) ? 2 : 1);
    
    // 1. Atualiza o agendamento
    t.update(agendamentoRef, { avaliado: true });

    // 2. Prepara as atualizações para o barbeiro
    const barbeiroUpdates = {
        reputacao: firebase.firestore.FieldValue.increment(reputacaoGanho),
        somaAvaliacoes: firebase.firestore.FieldValue.increment(nota),
        numAvaliacoes: firebase.firestore.FieldValue.increment(1)
    };

    // --- INÍCIO DA MODIFICAÇÃO ---
    if (fotoUrl) {
        const portfolioAtual = barbeiroData.portfolio || [];
        // Adiciona a foto APENAS se o portfólio tiver menos de 30 itens
        if (portfolioAtual.length < 30) {
            // Adiciona a URL como uma string simples, não mais um objeto
            barbeiroUpdates.portfolio = firebase.firestore.FieldValue.arrayUnion(fotoUrl);
        }
        // Se o portfólio estiver cheio (30/30), a foto do cliente é ignorada.
    }
    // --- FIM DA MODIFICAÇÃO ---
    
    // 3. Executa a atualização no barbeiro
    t.update(barbeiroRef, barbeiroUpdates); 

    // 4. Cria o documento de avaliação
    t.set(db.collection("avaliacoes").doc(), {
      barbeiroUid, clienteUid: auth.currentUser.uid, nota,
      comentario: comentario || "Sem comentário",
      ts: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    // 5. Atualiza os pontos do cliente (se houver)
    if (pontosGanhos > 0) {
        t.update(clienteRef, { pontosFidelidade: firebase.firestore.FieldValue.increment(pontosGanhos) });
    }
    return pontosGanhos;

  }).then((pontosGanhos) => {
    exibirInfoPopup(`Avaliação enviada com sucesso! Você ganhou ${pontosGanhos} pontos de fidelidade.`);
    criarAviso(barbeiroUid, `⭐ Você recebeu uma nova avaliação de ${perfil.nome}.`);
    notifyUser(barbeiroUid, "⭐ Nova Avaliação!", `${perfil.nome} deixou uma avaliação de nota ${nota} para você.`, { link: '#avaliacoes' });
  }).catch(e => {
    console.error("Erro detalhado ao avaliar:", e); 
    exibirInfoPopup("Erro ao avaliar: " + e); 
  });
}

function resgatarPontos() {
  if ((perfil.pontosFidelidade || 0) < PONTOS_PARA_RESGATE) {
    return exibirInfoPopup(`Você precisa de ${PONTOS_PARA_RESGATE} pontos para resgatar.`);
  }
  if (!confirm(`Deseja resgatar ${PONTOS_PARA_RESGATE} pontos por R$ ${VALOR_RESGATE.toFixed(2)}?`)) return;
  exibirAguarde("Resgatando...");
  db.runTransaction(async t => {
    const ref = db.collection("usuarios").doc(auth.currentUser.uid);
    const doc = await t.get(ref);
    if ((doc.data().pontosFidelidade || 0) < PONTOS_PARA_RESGATE) throw "Pontos insuficientes.";
    t.update(ref, {
        pontosFidelidade: firebase.firestore.FieldValue.increment(-PONTOS_PARA_RESGATE),
        saldo: firebase.firestore.FieldValue.increment(VALOR_RESGATE)
    });
  }).then(() => {
    fecharTodosOsModais();
    exibirInfoPopup(`🎉 Parabéns! Você resgatou R$ ${VALOR_RESGATE.toFixed(2)} com seus pontos!`);
    notifyUser(auth.currentUser.uid, "💸 Pontos Resgatados!", `Você converteu ${PONTOS_PARA_RESGATE} pontos em R$${VALOR_RESGATE.toFixed(2)}.`, { link: '#carteira' });
  }).catch(e => {
    fecharTodosOsModais();
    exibirInfoPopup("Erro ao resgatar pontos: " + e.message);
  });
}

function abrirModalVip() {
    const container = document.getElementById('vipContentContainer');
    if (isVipAtivo(perfil)) {
        const dataExpiracao = perfil.vipExpirationDate.toDate().toLocaleDateString('pt-BR');
        container.innerHTML = `
            <div class="vip-glow" style="padding: 20px; border-radius: 15px; text-align: center;">
                <h3 style="color: var(--cor-destaque);">👑 Você é um Membro VIP!</h3>
                <p>Sua assinatura é válida até: <strong>${dataExpiracao}</strong>.</p>
                <div class="vantagens" style="text-align: left; margin-top: 20px;">
                    <h4>Seus Benefícios Atuais:</h4>
                    <ul>
                        <li>Desconto de 10% em todos os serviços.</li>
                        <li>O dobro de pontos de fidelidade.</li>
                        <li>Símbolo de prestígio 👑 no chat global.</li>
                    </ul>
                </div>
            </div>
        `;
    } else {
        container.innerHTML = `
            <div style="padding: 20px; border-radius: 15px; text-align: center;">
                <h3 style="color: var(--cor-destaque);">💎 Torne-se um Membro VIP!</h3>
                <p>Eleve sua experiência por 6 meses e apoie o desenvolvimento do app.</p>
                <p style="font-size: 24px; font-weight: bold; margin: 15px 0;">Adesão: R$ ${PRECO_VIP.toFixed(2)}</p>
                <div class="vantagens" style="text-align: left; margin-top: 20px;">
                    <h4>Vantagens Exclusivas para Clientes VIP:</h4>
                    <ul>
                        <li><strong>10% de Desconto</strong> em todos os serviços.</li>
                        <li><strong>Dobro de Pontos</strong> de fidelidade.</li>
                         <li><strong>Status de Prestígio</strong> com um ícone 👑 no chat.</li>
                    </ul>
                </div>
                <button onclick="assinarVip()" style="margin-top: 15px;">💎 Assinar Agora</button>
            </div>
        `;
    }
    abrirModal('modalVip');
}

// ADICIONE ESTE BLOCO NO INDEX.HTML

// --- LÓGICA DE PAGAMENTO GOOGLE PLAY STORE (DIGITAL GOODS API) ---

const SKUS = {
    VIP: 'adesao_vip_6_meses',
    PRO: 'assinatura_pro_mensal',
    TURBINAR: 'turbinar_perfil_24h'
};

let playStoreService = null;

// Função para iniciar o serviço de pagamento da Play Store
async function setupPlayStoreBilling() {
    if ('getDigitalGoodsService' in window) {
        try {
            playStoreService = await window.getDigitalGoodsService("https://play.google.com/billing");
            if (playStoreService) {
                console.log("✅ Serviço de cobrança da Google Play conectado com sucesso!");
            }
        } catch (error) {
            console.error("Falha ao conectar com o serviço da Play Store:", error);
            playStoreService = null;
        }
    }
}

// Chama a configuração assim que o perfil do usuário é carregado
// (Você pode adicionar essa chamada dentro do 'auth.onAuthStateChanged')

// Função principal para iniciar uma compra
async function comprarComPlayStore(sku, precoEstimado) {
    if (!playStoreService) {
        exibirInfoPopup("O serviço de pagamento da Play Store não está disponível. Isso é esperado se você estiver acessando pelo navegador comum.");
        return;
    }

    try {
        console.log(`Iniciando compra para SKU: ${sku}`);
        const paymentMethodData = [{
            supportedMethods: "https://play.google.com/billing",
            data: { sku: sku }
        }];

        // Detalhes do pagamento (informativo)
        const paymentDetails = {
            total: {
                label: `Total`,
                amount: { currency: "BRL", value: precoEstimado.toString() }
            }
        };

        const request = new PaymentRequest(paymentMethodData, paymentDetails);
        const response = await request.show();
        
        const { purchaseToken } = response.details;
        
        // **MUITO IMPORTANTE:** AQUI VOCÊ DEVE ENVIAR O 'purchaseToken' PARA O SEU BACKEND
        // PARA VALIDAÇÃO E ATIVAÇÃO DO PRODUTO.
        
        // Exemplo de como seria a chamada para o backend:
        // await validarCompraNoBackend(purchaseToken, sku);

        await response.complete('success');
        
        // Simulação de sucesso (REMOVA APÓS IMPLEMENTAR O BACKEND)
        exibirInfoPopup("Compra via Play Store concluída com sucesso (Simulação)! A ativação real requer validação no backend.");
        // Exemplo: ativarBeneficioLocalmente(sku); // Função para atualizar a UI
        location.reload();


    } catch (error) {
        console.error("Erro durante a compra na Play Store:", error);
        if (error.name !== 'AbortError') {
             exibirInfoPopup("Ocorreu um erro ao processar seu pagamento na Play Store.");
        }
    }
}

// 1. SUBSTITUA A SUA FUNÇÃO 'assinarVip' ANTIGA POR ESTA COMPLETA
function assinarVip() {
    // Se o serviço da Play Store estiver ativo, usa ele como prioridade
    if (playStoreService) {
        comprarComPlayStore(SKUS.VIP, PRECO_VIP);
        return;
    }

    // Se não, usa o método antigo de saldo da carteira
    if (perfil.saldo < PRECO_VIP) {
        exibirInfoPopup("Saldo insuficiente para assinar o VIP.");
        return abrirModal('modalCarteira');
    }
    if (!confirm(`Deseja assinar o plano VIP por R$ ${PRECO_VIP.toFixed(2)} (válido por 6 meses)? O valor será descontado do seu saldo.`)) return;

    exibirAguarde("Ativando VIP...");
    db.runTransaction(async t => {
        const clienteRef = db.collection("usuarios").doc(auth.currentUser.uid);
        const financeiroRef = db.collection("config").doc("financeiro");
        const clienteDoc = await t.get(clienteRef);
        if (isVipAtivo(clienteDoc.data())) throw "Você já é um membro VIP ativo.";

        const expiracao = new Date();
        expiracao.setDate(expiracao.getDate() + 180); // Adiciona 180 dias

        t.update(clienteRef, {
            saldo: firebase.firestore.FieldValue.increment(-PRECO_VIP),
            vip: true,
            vipExpirationDate: firebase.firestore.Timestamp.fromDate(expiracao)
        });
        t.set(financeiroRef, { arrecadadoVip: firebase.firestore.FieldValue.increment(PRECO_VIP) }, { merge: true });
    }).then(() => {
        fecharTodosOsModais();
        exibirInfoPopup("Parabéns! Você agora é um membro VIP!");
        notifyUser(auth.currentUser.uid, "👑 Bem-vindo ao VIP!", "Aproveite seus benefícios exclusivos por 6 meses!");
        fecharModalAtual();
    }).catch(e => {
        fecharTodosOsModais();
        exibirInfoPopup("Erro ao assinar VIP: " + e.message);
    });
}

// 2. ADICIONE (ou SUBSTITUA) A FUNÇÃO 'assinarPro' POR ESTA NOVA VERSÃO
function assinarPro(tier) {
    const plano = PRECOS_PRO[tier];
    if (!plano) {
        return exibirInfoPopup("Plano PRO inválido selecionado.");
    }
    const sku = `pro_${tier}`; // Ex: pro_tier1, pro_tier2

    if (playStoreService) {
        comprarComPlayStore(sku, plano.preco);
        return;
    }

    if (perfil.saldo < plano.preco) {
        exibirInfoPopup("Saldo insuficiente para assinar este plano PRO. Por favor, deposite fundos na sua carteira.");
        return abrirModal('modalCarteira');
    }
    if (!confirm(`Deseja assinar o plano PRO por R$ ${plano.preco.toFixed(2)} (válido por 30 dias)? O valor será descontado do seu saldo.`)) return;

    exibirAguarde("Ativando PRO...");

    db.runTransaction(async t => {
        const proRef = db.collection("usuarios").doc(auth.currentUser.uid);
        const financeiroRef = db.collection("config").doc("financeiro");
        const proDoc = await t.get(proRef);

        if (isProAtivo(proDoc.data())) {
            throw "Você já é um membro PRO ativo.";
        }

        const expiracao = new Date();
        expiracao.setDate(expiracao.getDate() + 30); // Adiciona 30 dias

        t.update(proRef, {
            saldo: firebase.firestore.FieldValue.increment(-plano.preco),
            proAtivo: true,
            proTier: tier, // Salva o nível do plano
            proExpirationDate: firebase.firestore.Timestamp.fromDate(expiracao)
        });

        t.set(financeiroRef, { arrecadadoPro: firebase.firestore.FieldValue.increment(plano.preco) }, { merge: true });

    }).then(() => {
        fecharTodosOsModais();
        exibirInfoPopup("Parabéns! Você agora é um Profissional PRO!");
        notifyUser(auth.currentUser.uid, "🌟 Bem-vindo ao PRO!", "Aproveite seus benefícios exclusivos por 30 dias!");
        fecharModalAtual();
    }).catch(e => {
        fecharTodosOsModais();
        exibirInfoPopup("Erro ao assinar PRO: " + e.message);
    });
}

// 3. SUBSTITUA A SUA FUNÇÃO 'confirmarTurbinar' ANTIGA POR ESTA COMPLETA
function confirmarTurbinar() {
    if (playStoreService) {
        comprarComPlayStore(SKUS.TURBINAR, PRECO_TURBINAR);
        return;
    }

    if (perfil.saldo < PRECO_TURBINAR) {
        return exibirInfoPopup(`Saldo insuficiente. Você precisa de R$ ${PRECO_TURBINAR.toFixed(2)}.`);
    }
    if (perfil.ultimoBoostComprado) {
        const vinteQuatroHorasAtras = new Date(Date.now() - 24 * 60 * 60 * 1000);
        if (perfil.ultimoBoostComprado.toDate() > vinteQuatroHorasAtras) {
            return exibirInfoPopup("Você só pode turbinar o perfil uma vez a cada 24 horas.");
        }
    }
    if (confirm(`Confirmar o boost de 24h por R$ ${PRECO_TURBINAR.toFixed(2)}? O valor será descontado do seu saldo.`)) {
        const expiracao = new Date(Date.now() + 24 * 60 * 60 * 1000);
        db.collection('usuarios').doc(auth.currentUser.uid).update({
            saldo: firebase.firestore.FieldValue.increment(-PRECO_TURBINAR),
            boostExpiracao: firebase.firestore.Timestamp.fromDate(expiracao),
            ultimoBoostComprado: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
            exibirInfoPopup('Perfil turbinado com sucesso! Você está no topo da lista por 24 horas.');
            fecharModalAtual();
        }).catch(e => exibirInfoPopup('Erro ao turbinar perfil: ' + e.message));
    }
}

/**
 * Verifica se a assinatura PRO do profissional está ativa.
 */
function isProAtivo(perfilUsuario) {
    if (!perfilUsuario || !perfilUsuario.proAtivo || !perfilUsuario.proExpirationDate) {
        return false;
    }
    // Verifica se a data de expiração ainda não passou
    return perfilUsuario.proExpirationDate.toDate() > new Date();
}

/**
 * Abre o modal para o profissional assinar ou ver o status do PRO.
 */
// CÓDIGO ATUALIZADO (COPIE E COLE SUBSTITUINDO A FUNÇÃO INTEIRA)
// SUBSTITUA TODA A FUNÇÃO 'abrirModalVipPro' POR ESTA
function abrirModalVipPro() {
    const container = document.getElementById('vipProContentContainer');
    const proAtivo = isProAtivo(perfil);

    if (proAtivo) {
        const dataExpiracao = perfil.proExpirationDate.toDate().toLocaleDateString('pt-BR');
        let taxaAtual = (TAXA * 100); // Taxa padrão
        if(perfil.proTier && PRECOS_PRO[perfil.proTier]) {
            taxaAtual = PRECOS_PRO[perfil.proTier].taxa * 100;
        }

        container.innerHTML = `
            <div class="pro-glow" style="padding: 20px; border-radius: 15px; text-align: center;">
                <h3 style="color: var(--cor-destaque-azul);">🌟 Você é um Profissional PRO!</h3>
                <p>Sua assinatura mensal é válida até: <strong>${dataExpiracao}</strong>.</p>
                <p>Sua taxa de serviço atual é de apenas: <strong>${taxaAtual.toFixed(1)}%</strong>.</p>
                <div class="vantagens" style="text-align: left; margin-top: 20px;">
                    <h4>Seus Benefícios Atuais:</h4>
                    <ul>
                        <li>Selo 🌟 PRO de destaque no perfil e no chat.</li>
                        <li><strong>Taxa de serviço reduzida.</strong></li>
                        <li>Acesso ao Dashboard de Desempenho.</li>
                    </ul>
                </div>
            </div>
        `;
    } else {
        container.innerHTML = `
            <div style="text-align: center;">
                <h3 style="color: var(--cor-destaque-azul);">🌟 Torne-se um Profissional PRO!</h3>
                <p>Aumente seus lucros reduzindo a taxa de serviço do aplicativo.</p>
                
                <div style="display: flex; flex-direction: column; gap: 15px; margin-top: 20px;">
                    <div class="card" style="border: 1px solid #cd7f32;">
                        <h4>Plano Bronze</h4>
                        <p style="font-size: 22px; font-weight: bold;">R$ ${PRECOS_PRO.tier1.preco.toFixed(2)}<small>/mês</small></p>
                        <p>Reduz a taxa de serviço para <strong>4%</strong>.</p>
                        <button onclick="assinarPro('tier1')" style="background-color: #cd7f32;">Assinar Bronze</button>
                    </div>

                    <div class="card" style="border: 1px solid #c0c0c0;">
                        <h4>Plano Prata</h4>
                        <p style="font-size: 22px; font-weight: bold;">R$ ${PRECOS_PRO.tier2.preco.toFixed(2)}<small>/mês</small></p>
                        <p>Reduz a taxa de serviço para <strong>2%</strong>.</p>
                        <button onclick="assinarPro('tier2')" style="background-color: #c0c0c0; color: #333;">Assinar Prata</button>
                    </div>

                    <div class="card vip-glow">
                        <h4>Plano Ouro</h4>
                        <p style="font-size: 22px; font-weight: bold;">R$ ${PRECOS_PRO.tier3.preco.toFixed(2)}<small>/mês</small></p>
                        <p><strong>ZERE</strong> a taxa de serviço (<strong>0%</strong>).</p>
                        <button onclick="assinarPro('tier3')">Assinar Ouro</button>
                    </div>
                </div>
            </div>
        `;
    }
    abrirModal('modalVipPro');
}

/**
 * Processa a assinatura PRO, descontando do saldo.
 */

function isVipAtivo(perfilUsuario) {
    if (!perfilUsuario || !perfilUsuario.vip || !perfilUsuario.vipExpirationDate) {
        return false;
    }
    // Verifica se vipExpirationDate é um objeto Timestamp do Firebase (possui toDate)
    if (perfilUsuario.vipExpirationDate && typeof perfilUsuario.vipExpirationDate.toDate === 'function') {
        return perfilUsuario.vipExpirationDate.toDate() > new Date();
    }
    // Se não for um Timestamp, tenta converter de outras formas comuns (ex: string ISO ou segundos)
    try {
        let expiryDate;
        // Tenta tratar como objeto { _seconds: ..., _nanoseconds: ... } (serialização comum)
        if (typeof perfilUsuario.vipExpirationDate === 'object' && perfilUsuario.vipExpirationDate._seconds) {
             expiryDate = new Date(perfilUsuario.vipExpirationDate._seconds * 1000);
        }
        // Tenta tratar como string ISO 8601
        else if (typeof perfilUsuario.vipExpirationDate === 'string') {
             expiryDate = new Date(perfilUsuario.vipExpirationDate);
        }
        // Se conseguiu converter, compara
        if (expiryDate instanceof Date && !isNaN(expiryDate)) {
            return expiryDate > new Date();
        }
    } catch (e) {
        console.error("Erro ao processar vipExpirationDate:", e, perfilUsuario.vipExpirationDate);
    }
    // Se não conseguiu converter ou deu erro, considera como inativo por segurança
    return false;
}

// FUNÇÃO DO CHAT ATUALIZADA
let chatAtual = 'global';
function abrirChatGlobal() {
    const badge = document.querySelector('.notification-badge');
    newMessagesCount = 0;
    badge.textContent = '0';
    badge.classList.add('hidden');
    
    abrirModal('janelaChat');
    alternarChat('global'); // Começa sempre no global
}

// SUBSTITUA TODA A FUNÇÃO 'alternarChat' POR ESTA
function alternarChat(tipo) {
    chatAtual = tipo;
    document.getElementById('tabChatGlobal').classList.toggle('active', tipo === 'global');
    document.getElementById('tabChatLocal').classList.toggle('active', tipo === 'local');

    // Remove permanentemente o seletor de cidade do admin da tela
    const adminSelector = document.getElementById('adminChatSelectorContainer');
    adminSelector.classList.add('hidden'); 

    const chatContainer = document.getElementById("chatMessages");
    chatContainer.innerHTML = ""; // Limpa antes de carregar
    if (chatListener) chatListener();

    let query = db.collection("chats").doc(CHAT_GLOBAL_ID).collection("mensagens");
    const agora = new Date();

    if (tipo === 'local') {
        if (perfil.tipo === 'admin') {
            // Admin vê todas as mensagens locais, sem filtro de cidade
            document.getElementById("chatTitle").textContent = `📍 Chat Local (Todas as Cidades)`;
        } else {
            // Usuário comum vê apenas o chat da sua cidade
            query = query.where("cidade", "==", perfil.cidade);
            document.getElementById("chatTitle").textContent = `📍 Chat Local (${perfil.cidade})`;
        }
    } else {
        // Lógica para o chat global
        document.getElementById("chatTitle").textContent = '💬 Chat Global';
    }

    // A ordenação e o limite continuam os mesmos
    query = query.where("deleteAt", ">", agora).orderBy("deleteAt", "desc").limit(15);

    chatListener = query.onSnapshot(async snapshot => {
        if(snapshot.empty) {
            chatContainer.innerHTML = `<p>Nenhuma mensagem neste chat ainda.</p>`;
            return;
        }
        oldestMessageSnapshot = snapshot.docs[snapshot.docs.length - 1];
        chatContainer.innerHTML = ""; // Limpa para re-renderizar
        for(const doc of snapshot.docs.reverse()) { // Renderiza na ordem correta
            const msg = doc.data();
            const messageDiv = await createMessageDiv(msg);
            chatContainer.prepend(messageDiv);
        }
    });

    document.getElementById('chatInput').addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); enviarMensagem(); } });
    if (!botInterval) botInterval = setInterval(sendBotMessage, 3600000);
}


// NOVA FUNÇÃO PARA CARREGAR MENSAGENS ANTERIORES
async function carregarMensagensAnteriores() {
    if (!oldestMessageSnapshot) return; 

    const btn = document.getElementById('carregarMaisMsgBtn');
    btn.textContent = 'Carregando...';
    btn.disabled = true;

    const agora = new Date();
    let query = db.collection("chats").doc(CHAT_GLOBAL_ID).collection("mensagens");
    if (chatAtual === 'local') {
        query = query.where("cidade", "==", perfil.cidade);
    }
    query = query.where("deleteAt", ">", agora).orderBy("deleteAt", "desc").startAfter(oldestMessageSnapshot).limit(50);

    const snapshot = await query.get();

    if (snapshot.empty) {
        btn.textContent = 'Fim do histórico';
        return;
    }

    oldestMessageSnapshot = snapshot.docs[snapshot.docs.length - 1];
    
    const chatContainer = document.getElementById("chatMessages");
    for (const doc of snapshot.docs) { 
        const msg = doc.data();
        const messageDiv = await createMessageDiv(msg);
        chatContainer.appendChild(messageDiv); 
    }

    btn.textContent = 'Ver mensagens anteriores';
    btn.disabled = false;
}

// SUBSTITUA TODA A FUNÇÃO 'createMessageDiv' POR ESTA
async function createMessageDiv(msg) {
    let remetenteNome = msg.remetenteNome || "Desconhecido";
    let classeCSS = "", iconeBase = "", medalhaIcone = "", itemExclusivoIcone = "";
    const messageDiv = document.createElement('div');
    const isCurrentUser = auth.currentUser && msg.remetenteUid === auth.currentUser.uid;
    messageDiv.className = `chat-message ${isCurrentUser ? "chat-sent" : "chat-received"}`;

    if (msg.tipo === "bot" || msg.tipo === "ai_suporte") {
        remetenteNome = `<span style="color: red;">${msg.tipo === "ai_suporte" ? '🤖 Suporte AI' : '🤖 Nova Versão Bot'}</span>`;
    } else {
        const remetenteDoc = await db.collection("usuarios").doc(msg.remetenteUid).get();
        if(remetenteDoc.exists) {
            const remetenteData = remetenteDoc.data();

            if (remetenteData.possuiItemExclusivo) {
                itemExclusivoIcone = '👕✨';
            }

            if (remetenteData.tipo === "admin") {
                classeCSS = `admin-chat-red`; 
                iconeBase = `🧠`;
                messageDiv.style.textShadow = '0 0 5px #000';
            } else if (remetenteData.tipo !== "cliente") {
                classeCSS = `barbeiro-chat`;
                if (isProAtivo(remetenteData)) {
                    iconeBase = `🌟`; // Icone PRO
                } else {
                    iconeBase = `💼`; // Icone profissional normal
                }
                medalhaIcone = obterIconeMaiorConquista(remetenteData.conquistas, 'profissional');
            } else if (isVipAtivo(remetenteData)) {
                classeCSS = `cliente-chat`; iconeBase = `👑`;
                medalhaIcone = obterIconeMaiorConquista(remetenteData.conquistas, 'cliente');
            } else {
                classeCSS = `cliente-chat`; iconeBase = `👤`;
                medalhaIcone = obterIconeMaiorConquista(remetenteData.conquistas, 'cliente');
            }
            
            // LÓGICA PRINCIPAL ADICIONADA AQUI
            let cidadeLabel = '';
            if (perfil.tipo === 'admin' && chatAtual === 'local' && msg.cidade) {
                cidadeLabel = ` <small style="opacity: 0.7; font-weight: normal;">(${msg.cidade})</small>`;
            }

            remetenteNome = `<span class="${classeCSS}">${itemExclusivoIcone}${medalhaIcone}${iconeBase} ${remetenteData.nome}${cidadeLabel}</span>`;
        }
    }
    
    messageDiv.innerHTML = `<b>${remetenteNome}:</b> ${msg.texto}`;
    messageDiv.id = `msg-${msg.id || new Date().getTime()}`;
    return messageDiv;
}


const botMessages = [ "Dica: Avalie seu profissional para ganhar pontos de fidelidade e ajudar a comunidade!", "Você sabia? Indicando um amigo com seu e-mail, vocês dois ganham 100 pontos de fidelidade após o primeiro agendamento concluído dele!", "Mantenha seu saldo atualizado! Use a função de depósito para adicionar créditos de forma rápida e segura.", "Precisa de ajuda ou tem uma sugestão? Use a opção 'Denunciar' para falar diretamente com um administrador.", "Torne-se VIP para ter 10% de desconto em todos os serviços e ganhar o dobro de pontos!", "Fique de olho no nosso Blog! Postamos códigos de resgate valendo pontos de fidelidade. Procure por códigos entre (parênteses)!", "Explore a nossa Loja! Produtos exclusivos e da comunidade estão disponíveis para você.", "Complete agendamentos e desbloqueie conquistas para mostrar seu status no chat!" ];
let lastBotMessageIndex = -1;

function sendBotMessage() {
    let randomIndex;
    do { randomIndex = Math.floor(Math.random() * botMessages.length); } while (randomIndex === lastBotMessageIndex);
    lastBotMessageIndex = randomIndex;
    const deleteAt = new Date(Date.now() + 24 * 60 * 60 * 1000);
    db.collection("chats").doc(CHAT_GLOBAL_ID).collection("mensagens").add({
        remetenteUid: "bot-uid", remetenteNome: "Nova Versão Bot", tipo: "bot",
        texto: botMessages[randomIndex], ts: firebase.firestore.FieldValue.serverTimestamp(),
        cidade: "global", // Mensagem do bot é global
        deleteAt: firebase.firestore.Timestamp.fromDate(deleteAt)
    });
}

async function alterarSenhaUsuario() {
    const senhaAntiga = document.getElementById('senhaAntiga').value;
    const senhaNova = document.getElementById('senhaNova').value;
    const senhaNovaConfirm = document.getElementById('senhaNovaConfirm').value;
    const user = auth.currentUser;

    if (!user) {
        exibirInfoPopup("Você precisa estar logado para alterar a senha.");
        return;
    }

    if (!senhaAntiga || !senhaNova || !senhaNovaConfirm) {
        exibirInfoPopup("Por favor, preencha todos os campos.");
        return;
    }

    if (senhaNova.length < 6) {
        exibirInfoPopup("A nova senha deve ter pelo menos 6 caracteres.");
        return;
    }

    if (senhaNova !== senhaNovaConfirm) {
        exibirInfoPopup("A nova senha e a confirmação não coincidem.");
        return;
    }

    exibirAguarde("Verificando senha atual...");

    try {
        // Reautenticar o usuário com a senha antiga
        const credential = firebase.auth.EmailAuthProvider.credential(user.email, senhaAntiga);
        await user.reauthenticateWithCredential(credential);

        // Se a reautenticação foi bem-sucedida, atualiza a senha
        exibirAguarde("Atualizando senha...");
        await user.updatePassword(senhaNova);

        fecharTodosOsModais();
        exibirInfoPopup("✅ Senha alterada com sucesso!");
        // Limpa os campos e fecha o modal
        document.getElementById('senhaAntiga').value = '';
        document.getElementById('senhaNova').value = '';
        document.getElementById('senhaNovaConfirm').value = '';
        fecharModalAtual(); // Fecha o modal de alterar senha

    } catch (error) {
        fecharTodosOsModais();
        console.error("Erro ao alterar senha:", error);
        if (error.code === 'auth/wrong-password') {
            exibirInfoPopup("❌ A senha atual informada está incorreta.");
        } else if (error.code === 'auth/too-many-requests') {
             exibirInfoPopup("❌ Muitas tentativas incorretas. Tente novamente mais tarde.");
        } else {
            exibirInfoPopup("❌ Ocorreu um erro ao tentar alterar a senha: " + error.message);
        }
    }
}

function enviarMensagem() {
    if (!auth.currentUser) {
        exibirInfoPopup("Para enviar mensagens, por favor, faça login ou crie uma conta.");
        mostrar('authView');
        fecharModalAtual();
        return;
    }
    if (isSending) return;
    const texto = document.getElementById("chatInput").value.trim();
    if (!texto) return;
    isSending = true;
    const deleteAt = new Date(Date.now() + 24 * 60 * 60 * 1000);
    db.collection("chats").doc(CHAT_GLOBAL_ID).collection("mensagens").add({
        remetenteUid: auth.currentUser.uid, remetenteNome: perfil.nome, tipo: perfil.tipo, texto,
        ts: firebase.firestore.FieldValue.serverTimestamp(),
        cidade: perfil.cidade, // Adiciona a cidade à mensagem
        deleteAt: firebase.firestore.Timestamp.fromDate(deleteAt)
    }).then(() => {
        document.getElementById("chatInput").value = "";
        if (texto.toLowerCase().includes('suporte')) {
            setTimeout(enviarRespostaAI, 1500); 
        }
        setTimeout(() => { isSending = false; }, 1000);
    }).catch(error => { isSending = false; });
}

function enviarRespostaAI() {
    const resposta = `Olá! Sou a assistente virtual. Como posso ajudar? <br><br>
        • Para <b>dúvidas sobre o app</b> (agendamentos, carteira, VIP, etc.), tente ser específico na sua pergunta. <br>
        • Para <b>contatar um administrador</b> sobre problemas urgentes, denúncias ou sugestões, use o botão 🚨 no canto inferior esquerdo ou chame diretamente no WhatsApp: <a href="https://wa.me/${WHATSAPP_ADM_PHONE}" target="_blank">clique aqui</a>.`;
    const deleteAt = new Date(Date.now() + 24 * 60 * 60 * 1000);
    db.collection("chats").doc(CHAT_GLOBAL_ID).collection("mensagens").add({
        remetenteUid: "ai-suporte-uid",
        remetenteNome: "Suporte AI",
        tipo: "ai_suporte",
        texto: resposta,
        ts: firebase.firestore.FieldValue.serverTimestamp(),
        cidade: chatAtual === 'local' ? perfil.cidade : 'global',
        deleteAt: firebase.firestore.Timestamp.fromDate(deleteAt)
    });
}

// Funções novas para o admin no chat
function adminCarregarCidadesChat() {
    const estado = document.getElementById('adminChatEstado').value;
    const cidadeSelect = document.getElementById('adminChatCidade');
    const valorAtual = cidadeSelect.value;
    cidadeSelect.innerHTML = '<option value="">Selecione a cidade</option>';
    const cidades = cidadesPorEstado[estado] || [];
    cidades.forEach(c => {
        // Seleciona a cidade do perfil do admin por padrão na primeira vez
        const isSelected = c === valorAtual || (c === perfil.cidade && !valorAtual);
        cidadeSelect.innerHTML += `<option value="${c}" ${isSelected ? 'selected' : ''}>${c}</option>`;
    });
    // Após carregar as cidades, se for um admin, recarrega o chat
    if(perfil.tipo === 'admin') {
        adminRecarregarChat();
    }
}

function adminRecarregarChat() {
    // Simplesmente chama a função de alternar, que agora contém a lógica 
    // para ler os selects do admin e carregar as mensagens da cidade escolhida.
    alternarChat('local');
}

function criarAviso(uid, mensagem, tipo = 'geral', agendamentoId = null) {
  const avisoData = { usuarioUid: uid, mensagem, tipo, lido: false, ts: firebase.firestore.FieldValue.serverTimestamp() };
  if (agendamentoId) avisoData.agendamentoId = agendamentoId;
  db.collection("avisos").add(avisoData);
}

function enviarDenuncia() {
  const texto = document.getElementById("textoDenuncia").value.trim();
  if (!texto) return exibirInfoPopup("Por favor, descreva o problema.");
  db.collection("denuncias").add({
    usuarioUid: auth.currentUser.uid, usuarioNome: perfil.nome, texto,
    status: "aberta", ts: firebase.firestore.FieldValue.serverTimestamp()
  }).then(denunciaRef => {
    abrirModal('modalDenunciaEnviada');
    const mensagem = encodeURIComponent(`🚨 Nova denúncia no app. ID: ${denunciaRef.id}\n\nDe: ${perfil.nome}\n\nDescrição: ${texto}`);
    document.getElementById("btnWhatsappDenuncia").href = `https://wa.me/${WHATSAPP_ADM_PHONE}?text=${mensagem}`;
    document.getElementById("textoDenuncia").value = "";
    notifyAdmins("🚨 Nova Denúncia!", `Uma nova denúncia foi enviada por ${perfil.nome}.`, { link: '#denuncias' });
  }).catch(e => exibirInfoPopup("Erro ao enviar denúncia: " + e.message));
}

// Funções do Barbeiro
function abrirServicos() {
  abrirModal('modalServicosBarbeiro');
  listarServicos();
}

function listarServicos() {
  const lista = document.getElementById("listaServicosBarbeiro");
  lista.innerHTML = "<p>⏳ Carregando...</p>";
  db.collection("usuarios").doc(auth.currentUser.uid).onSnapshot(doc => {
    perfil = doc.data();
    lista.innerHTML = "";
    if (!perfil.listaServicos || perfil.listaServicos.length === 0) {
      lista.innerHTML = "<p>Nenhum serviço cadastrado.</p>";
      return;
    }
    perfil.listaServicos.forEach((s, index) => {
      lista.innerHTML += `<div class="card"><b>${s.nome}</b> - R$ ${s.valor.toFixed(2)} ${s.duracao ? `(${s.duracao} min)` : ''}<button onclick="removerServico(${index})" style="float:right">❌</button></div>`;
    });
  });
}

function adicionarServico() {
  // Limpa os campos do modal antes de abrir
  document.getElementById('addServicoNome').value = '';
  document.getElementById('addServicoValor').value = '';
  document.getElementById('addServicoDuracao').value = '';
  abrirModal('modalAddServico'); // Abre o novo modal
}

function salvarNovoServico() {
  const nome = document.getElementById('addServicoNome').value.trim();
  const valor = parseFloat(document.getElementById('addServicoValor').value);
  const duracao = parseInt(document.getElementById('addServicoDuracao').value);

  if (!nome || isNaN(valor) || valor <= 0 || isNaN(duracao) || duracao <= 0) {
      // Usa o novo popup de informação
      return exibirInfoPopup("Erro", "Entrada inválida. Preencha nome, valor (positivo) e duração (positiva) corretamente.");
  }

  const servico = { nome, valor, duracao };
  db.collection("usuarios").doc(auth.currentUser.uid).update({
    listaServicos: firebase.firestore.FieldValue.arrayUnion(servico)
  }).then(() => {
    exibirInfoPopup("Sucesso", "Serviço adicionado com sucesso!");
    fecharModalAtual(); // Fecha o modal de adicionar serviço
    // A lista de serviços no modal 'modalServicosBarbeiro' será atualizada pelo listener onSnapshot
  }).catch(e => {
     exibirInfoPopup("Erro", "Erro ao adicionar serviço: " + e.message);
  });
}

function removerServico(index) {
  const servicoParaRemover = perfil.listaServicos[index];
  if (!confirm(`Deseja remover "${servicoParaRemover.nome}"?`)) return;
  db.collection("usuarios").doc(auth.currentUser.uid).update({
    listaServicos: firebase.firestore.FieldValue.arrayRemove(servicoParaRemover)
  }).then(() => exibirInfoPopup("Serviço removido!")).catch(e => exibirInfoPopup("Erro: " + e.message));
}

async function uploadLogomarca() {
    const fileInput = document.getElementById('logomarcaFile');
    const file = fileInput.files[0];
    if (!file) return exibirInfoPopup("Selecione um arquivo de imagem ou GIF.");
    if (!auth.currentUser) return;

    const progressBar = document.getElementById('logomarcaProgress');
    const saveButton = document.querySelector('#modalLogomarca button[onclick="uploadLogomarca()"]');
    exibirAguarde("Enviando logomarca..."); // Usa o popup de aguarde
    progressBar.style.display = 'block';
    progressBar.value = 0;
    saveButton.disabled = true;

    const storageRef = storage.ref(`logomarcas/${auth.currentUser.uid}/${file.name}`);
    const uploadTask = storageRef.put(file);

    uploadTask.on('state_changed',
        (snapshot) => {
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            progressBar.value = progress;
            // Atualiza o texto do aguarde se quiser
            // document.getElementById('popupAguardeTexto').textContent = `Enviando ${Math.round(progress)}%...`;
        },
        (error) => {
            fecharTodosOsModais(); // Fecha o aguarde em caso de erro
            console.error("Erro no upload da logomarca:", error);
            exibirInfoPopup("Falha no upload: " + error.code);
            progressBar.style.display = 'none';
            saveButton.disabled = false;
        },
        async () => {
            try {
                const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                await db.collection('usuarios').doc(auth.currentUser.uid).update({ logo_url: downloadURL });
                progressBar.style.display = 'none';
                saveButton.disabled = false;
                fecharTodosOsModais(); // Fecha o aguarde
                exibirInfoPopup('Logomarca salva com sucesso!');
                fecharModalAtual();
            } catch (dbError) {
                fecharTodosOsModais(); // Fecha o aguarde
                exibirInfoPopup('Erro ao salvar URL no banco de dados: ' + dbError.message);
                progressBar.style.display = 'none';
                saveButton.disabled = false;
            }
        }
    );
}

function previewImage(input, previewId) {
    const file = input.files[0];
    const reader = new FileReader();
    reader.onload = function(e) {
        document.getElementById(previewId).src = e.target.result;
    }
    if (file) { reader.readAsDataURL(file); }
}

async function salvarLocalizacaoAtualEndereco() {
    const rua = document.getElementById("novoEnderecoRua").value.trim();
    const numero = document.getElementById("novoEnderecoNumero").value.trim();
    const btnSalvar = document.getElementById('btnSalvarLocalAtual');

    if (!rua || !numero) {
        return exibirInfoPopup("Erro", "Por favor, preencha a Rua e o Número.");
    }

    btnSalvar.textContent = '⏳ Obtendo localização...';
    btnSalvar.disabled = true;

    try {
        // Tenta obter a localização atual
        await new Promise((resolve, reject) => {
            if (!navigator.geolocation) {
               return reject(new Error("Geolocalização não suportada."));
            }
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    cadastroCoords = { // Salva nas coordenadas globais temporárias
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                    };
                    resolve();
                },
                (error) => {
                     reject(error); // Rejeita a promise se houver erro
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 } // Opções para tentar obter localização mais precisa
            );
        });

        // Se chegou aqui, a localização foi obtida com sucesso
        exibirAguarde("Salvando endereço...");
        await db.collection("usuarios").doc(auth.currentUser.uid).update({
            rua,
            numero,
            latitude: cadastroCoords.latitude,
            longitude: cadastroCoords.longitude,
        });

        fecharTodosOsModais();
        exibirInfoPopup("Sucesso", "Endereço e localização atualizados!");
        cadastroCoords = null; // Limpa as coordenadas temporárias

    } catch (error) {
        console.error("Erro ao obter localização ou salvar:", error);
        exibirInfoPopup("Erro", "Não foi possível obter a localização atual ou salvar. Verifique as permissões do navegador ou tente novamente. (" + error.message + ")");
    } finally {
         // Garante que o botão seja reativado e o texto volte ao normal
         btnSalvar.textContent = '📍 Salvar Localização Atual';
         btnSalvar.disabled = false;
         fecharAguarde(); // Garante que o "Aguarde" seja fechado em caso de erro também
    }
}

// ATUALIZE ESTA FUNÇÃO EM INDEX.HTML
function abrirAgenda() {
    abrirModal('modalAgendaBarbeiro');
    // Adiciona o novo botão no painel da agenda
    const container = document.getElementById('modalAgendaBarbeiro').querySelector('.modal-content');
    if (!container.querySelector('#btnModoFerias')) {
        const btnFerias = document.createElement('button');
        btnFerias.id = 'btnModoFerias';
        btnFerias.textContent = '🏖️ Ativar Modo Férias/Ausência';
        btnFerias.onclick = () => abrirModal('modalModoFerias');
        // Insere antes do painel da agenda manual para melhor organização
        const painelManual = document.getElementById('agendaManualPainel');
        container.insertBefore(btnFerias, painelManual);
    }
    carregarAgenda();
}

function carregarAgenda() {
    const btnDisp = document.getElementById("btnDisponibilidade");
    const btnVagaImediata = document.getElementById("btnVagaImediata");
    const btnAgendaManual = document.getElementById("btnAgendaManual");
    const agendaManualPainel = document.getElementById("agendaManualPainel");
    const horariosContainer = document.getElementById("horariosContainer");

    db.collection("usuarios").doc(auth.currentUser.uid).onSnapshot(doc => {
        perfil = doc.data(); 
        if(!btnDisp) return;
        btnDisp.textContent = perfil.disponivel === 'sim' ? '🔴 Ficar Indisponível (Automático)' : '🟢 Ficar Disponível (Automático)';
        btnVagaImediata.textContent = perfil.vagaImediata ? '⚠️ Desativar Vaga Imediata' : '⚡ Ativar Vaga Imediata';
        btnAgendaManual.textContent = perfil.usaAgendaManual ? '❌ Desativar Agenda Manual' : '📅 Ativar Agenda Manual';
        
        if (perfil.usaAgendaManual) {
            agendaManualPainel.classList.remove("hidden");
            horariosContainer.innerHTML = "";
            tempSelectedHorarios = { ...perfil.agenda };
            for (let i = 7; i <= 18; i++) {
                const horario = `${i}:00`;
                const statusHorario = tempSelectedHorarios[horario];
                const btn = document.createElement('button');
                btn.textContent = horario;
                btn.className = `horario-btn`;
                if(statusHorario === true) btn.classList.add('selecionado');
                if(statusHorario === 'bloqueado') btn.classList.add('bloqueado');
                btn.onclick = () => toggleHorario(horario);
                horariosContainer.appendChild(btn);
            }
        } else {
            agendaManualPainel.classList.add("hidden");
        }
    });
}

function abrirAgendamentosBarbeiro() {
  abrirModal('modalAgendamentosBarbeiro');
  const painel = document.getElementById("agendamentosPainel");
  painel.innerHTML = "<p>⏳ Carregando...</p>";
  db.collection("agendamentos")
    .where("barbeiroUid", "==", auth.currentUser.uid)
    .where("status", "in", ["pendente", "confirmado", "imediato", "conclusão pendente"])
    .orderBy("ts", "asc")
    .onSnapshot(snap => {
        painel.innerHTML = !snap.empty ? "" : "<p>Nenhum agendamento ativo.</p>";
        snap.forEach(doc => {
            const ag = doc.data();
            let botoes = "", statusTexto = "", horarioInfo = ag.horario ? ` às <b>${ag.horario}</b>` : ' (Vaga Imediata)';
            if (ag.status === "pendente") {
                statusTexto = "⏳ Aguardando Aprovação";
                botoes = `<button onclick="aprovarAgendamento('${doc.id}','${ag.clienteUid}',${ag.valor},'${ag.horario}')">✅ Aprovar</button><button onclick="recusarAgendamento('${doc.id}','${ag.clienteUid}')">❌ Recusar</button>`;
            } else if (ag.status === "confirmado" || ag.status === "conclusão pendente") {
                statusTexto = "✅ Conclusão Pendente";
                botoes = `<button onclick="concluirAgendamento('${doc.id}','${ag.clienteUid}')">✂️ Concluir</button><button onclick="cancelarAgendamentoManualmente('${doc.id}','${ag.clienteUid}',${ag.valor})">❌ Cancelar</button>`;
            } else if (ag.status === "imediato") {
                statusTexto = "⚡ Vaga Imediata Pendente";
                botoes = `<button onclick="aprovarAgendamentoImediato('${doc.id}','${ag.clienteUid}',${ag.valor})">✅ Aprovar</button><button onclick="recusarAgendamento('${doc.id}','${ag.clienteUid}')">❌ Recusar</button>`;
            }
            painel.innerHTML += `<div class="card"><b>${ag.clienteNome}</b> - ${ag.servico} (R$ ${ag.valor.toFixed(2)})<br>Horário: ${horarioInfo}<br>Status: <b>${statusTexto}</b>${ag.clienteTelefone ? `<br><a href="https://wa.me/55${ag.clienteTelefone}" target="_blank">📞 Contatar</a>` : ''}<div style="margin-top:10px; display:flex; gap: 8px;">${botoes}</div></div>`;
snap.docChanges().forEach(change => {
    // --- ADICIONADO AQUI ---
    // Se um novo agendamento pendente for adicionado E o modal estiver aberto, recarrega
    if (change.type === "added" && change.doc.data().status === 'pendente') {
         // Verifica se o modal de agendamentos está visível antes de recarregar
         const modalAgendamentos = document.getElementById('modalAgendamentosBarbeiro');
         if (modalAgendamentos && modalAgendamentos.classList.contains('show')) {
            console.log("Novo agendamento recebido, recarregando a página...");
            location.reload();
         }
         // Se o modal não estiver aberto, apenas a notificação pulsante (já existente) será ativada.
    }
    // --- FIM DA ADIÇÃO ---

    // Lógica existente para construir o HTML dos cards...
    // ... (o código que monta os cards continua aqui) ...
});
// Adiciona verificação visual após processar as mudanças, caso não recarregue
verificarPendenciasVisuaisBarbeiro();
        });
    });
}

function toggleVagaImediata() {
    db.collection("usuarios").doc(auth.currentUser.uid).update({ vagaImediata: !perfil.vagaImediata }).catch(e => exibirInfoPopup("Erro: " + e.message));
}

function toggleAgendaManual() {
  db.collection("usuarios").doc(auth.currentUser.uid).update({ usaAgendaManual: !perfil.usaAgendaManual }).catch(e => exibirInfoPopup("Erro: " + e.message));
}

function toggleHorario(horario) {
    const btn = Array.from(document.querySelectorAll('#horariosContainer .horario-btn')).find(b => b.textContent === horario);
    const statusAtual = tempSelectedHorarios[horario];
    if (statusAtual === true) {
        tempSelectedHorarios[horario] = 'bloqueado';
        btn.classList.remove("selecionado"); btn.classList.add("bloqueado");
    } else if (statusAtual === 'bloqueado') {
        delete tempSelectedHorarios[horario];
        btn.classList.remove("bloqueado");
    } else {
        tempSelectedHorarios[horario] = true;
        btn.classList.add("selecionado");
    }
}


function salvarAgendaManual() {
    db.collection("usuarios").doc(auth.currentUser.uid).update({ agenda: tempSelectedHorarios })
      .then(() => exibirInfoPopup("Agenda salva!"))
      .catch(e => exibirInfoPopup("Erro ao salvar: " + e.message));
}

function toggleDisponibilidade() {
  db.collection("usuarios").doc(auth.currentUser.uid).update({ disponivel: perfil.disponivel === "sim" ? "nao" : "sim" }).catch(e => exibirInfoPopup("Erro: " + e.message));
}

// SUBSTITUA A FUNÇÃO 'aprovarAgendamentoImediato'
async function aprovarAgendamentoImediato(agendamentoId, clienteUid, valor) {
    if (!confirm("Aprovar esta vaga imediata?")) return;
    exibirAguarde("Aprovando vaga..."); // <-- MOVIDO PARA ANTES

    // Lógica de cálculo de taxa dinâmica...
    let taxaAplicada = TAXA;
    if (isProAtivo(perfil) && perfil.proTier && PRECOS_PRO[perfil.proTier]) {
        taxaAplicada = PRECOS_PRO[perfil.proTier].taxa;
    }
    const valorComTaxa = valor * (1 - taxaAplicada);
    const valorAdmin = valor * taxaAplicada;

    db.runTransaction(async t => {
        const agendamentoRef = db.collection("agendamentos").doc(agendamentoId);
        const clienteRef = db.collection("usuarios").doc(clienteUid);
        const barbeiroRef = db.collection("usuarios").doc(auth.currentUser.uid);
        const [agendamentoDoc, clienteDoc, barbeiroDoc] = await Promise.all([t.get(agendamentoRef), t.get(clienteRef), t.get(barbeiroRef)]);
        if (!agendamentoDoc.exists || agendamentoDoc.data().status !== 'imediato') throw "Solicitação já processada ou não encontrada.";
        if (!clienteDoc.exists) throw "Cliente não encontrado.";
        if (clienteDoc.data().saldo < valor) throw "Saldo do cliente insuficiente.";
        if (!barbeiroDoc.exists || barbeiroDoc.data().vagaImediata === false) throw "Vaga imediata não está mais ativa ou profissional não encontrado.";

        t.update(clienteRef, { saldo: firebase.firestore.FieldValue.increment(-valor) });
        t.update(barbeiroRef, { saldo: firebase.firestore.FieldValue.increment(valorComTaxa), vagaImediata: false });
        t.update(agendamentoRef, { status: "conclusão pendente", confirmadoEm: firebase.firestore.FieldValue.serverTimestamp() });
        const adminSnap = await db.collection("usuarios").where("tipo", "==", "admin").limit(1).get();
        if(!adminSnap.empty) t.update(db.collection("usuarios").doc(adminSnap.docs[0].id), { saldo: firebase.firestore.FieldValue.increment(valorAdmin) });
        t.set(db.collection("config").doc("financeiro"), { arrecadadoTaxas: firebase.firestore.FieldValue.increment(valorAdmin) }, { merge: true });
    }).then(() => {
        fecharTodosOsModais(); // <-- ADICIONADO AQUI
        criarAviso(clienteUid, `✅ Sua vaga imediata foi aprovada por ${perfil.nome}!`, 'vaga-aprovada', agendamentoId);
        notifyUser(clienteUid, "✅ Agendamento Confirmado!", `Sua vaga imediata com ${perfil.nome} foi aprovada. Corra para o local!`);
        exibirInfoPopup("Agendamento aprovado!");
    }).catch(e => {
        fecharTodosOsModais(); // <-- ADICIONADO AQUI
        exibirInfoPopup("Erro ao aprovar: " + e);
    });
}

// SUBSTITUA A FUNÇÃO 'aprovarAgendamento'
async function aprovarAgendamento(agendamentoId, clienteUid, valor, horario = null) {
  if (!confirm("Aprovar este agendamento?")) return;
  exibirAguarde("Aprovando agendamento..."); // <-- MOVIDO PARA ANTES

  // Lógica de cálculo de taxa dinâmica
  let taxaAplicada = TAXA;
  if (isProAtivo(perfil) && perfil.proTier && PRECOS_PRO[perfil.proTier]) {
      taxaAplicada = PRECOS_PRO[perfil.proTier].taxa;
  }
  const valorComTaxa = valor * (1 - taxaAplicada);
  const valorAdmin = valor * taxaAplicada;

  db.runTransaction(async t => {
      const agendamentoRef = db.collection("agendamentos").doc(agendamentoId);
      const clienteRef = db.collection("usuarios").doc(clienteUid);
      const barbeiroRef = db.collection("usuarios").doc(auth.currentUser.uid);
      const [agendamentoDoc, clienteDoc, barbeiroDoc] = await Promise.all([t.get(agendamentoRef), t.get(clienteRef), t.get(barbeiroRef)]);
      if (!agendamentoDoc.exists || agendamentoDoc.data().status !== 'pendente') throw "Solicitação já processada ou não encontrada.";
      if (!clienteDoc.exists) throw "Cliente não encontrado.";
      if (!barbeiroDoc.exists) throw "Profissional não encontrado.";
      if (clienteDoc.data().saldo < valor) throw "Saldo do cliente insuficiente.";

      t.update(clienteRef, { saldo: firebase.firestore.FieldValue.increment(-valor) });
      t.update(barbeiroRef, { saldo: firebase.firestore.FieldValue.increment(valorComTaxa) });
      t.update(agendamentoRef, { status: "conclusão pendente", confirmadoEm: firebase.firestore.FieldValue.serverTimestamp() });

      if (barbeiroDoc.data().usaAgendaManual && horario && horario !== 'null') {
          const agendaAtual = barbeiroDoc.data().agenda || {};
          // Verifica se o horário existe antes de deletar
          if (agendaAtual.hasOwnProperty(horario)) {
              delete agendaAtual[horario];
              t.update(barbeiroRef, { agenda: agendaAtual });
          }
      }
      const adminSnap = await db.collection("usuarios").where("tipo", "==", "admin").limit(1).get();
      if(!adminSnap.empty) t.update(db.collection("usuarios").doc(adminSnap.docs[0].id), { saldo: firebase.firestore.FieldValue.increment(valorAdmin) });
      t.set(db.collection("config").doc("financeiro"), { arrecadadoTaxas: firebase.firestore.FieldValue.increment(valorAdmin) }, { merge: true });
  }).then(() => {
      fecharTodosOsModais(); // <-- ADICIONADO AQUI
      criarAviso(clienteUid, `✅ Seu agendamento foi aprovado pelo profissional ${perfil.nome}!`);
      notifyUser(clienteUid, "✅ Agendamento Confirmado!", `Seu horário com ${perfil.nome} para as ${horario} foi confirmado.`);
      exibirInfoPopup("Agendamento aprovado!");
  }).catch(e => {
      fecharTodosOsModais(); // <-- ADICIONADO AQUI
      exibirInfoPopup("Erro ao aprovar: " + e);
  });
}

function recusarAgendamento(agendamentoId, clienteUid) {
  if (!confirm("Recusar este agendamento?")) return;
  db.runTransaction(async t => {
      const agendamentoRef = db.collection("agendamentos").doc(agendamentoId);
      const agendamentoDoc = await t.get(agendamentoRef);
      const status = agendamentoDoc.data().status;
      if (status !== 'pendente' && status !== 'imediato') throw "Solicitação já processada.";
      t.update(agendamentoRef, { status: "cancelado" });
  }).then(() => {
      criarAviso(clienteUid, `❌ O profissional ${perfil.nome} recusou seu agendamento.`);
      notifyUser(clienteUid, "❌ Agendamento Recusado", `O profissional ${perfil.nome} não pôde aceitar seu pedido.`);
fecharTodosOsModais();
      exibirInfoPopup("Agendamento recusado.");
  }).catch(e => exibirInfoPopup("Erro ao recusar: " + e));
}

async function cancelarAgendamentoManualmente(agendamentoId, clienteUid, valor) {
  if (!confirm("Cancelar este agendamento? O dinheiro será reembolsado e sua reputação será afetada.")) return;
  exibirAguarde("Cancelando...");
  const valorComTaxa = valor * (1 - TAXA), valorAdmin = valor * TAXA;
  db.runTransaction(async t => {
      const agendamentoRef = db.collection("agendamentos").doc(agendamentoId);
      const agendamentoDoc = await t.get(agendamentoRef);
      const status = agendamentoDoc.data().status;
      if (status !== 'confirmado' && status !== 'conclusão pendente') throw "Apenas agendamentos aprovados podem ser cancelados.";
      
      const clienteRef = db.collection("usuarios").doc(clienteUid);
      const barbeiroRef = db.collection("usuarios").doc(auth.currentUser.uid);
      t.update(clienteRef, { saldo: firebase.firestore.FieldValue.increment(valor) });
      t.update(barbeiroRef, { saldo: firebase.firestore.FieldValue.increment(-valorComTaxa), reputacao: firebase.firestore.FieldValue.increment(-10) });
      t.update(agendamentoRef, { status: "cancelado" });

      const adminSnap = await db.collection("usuarios").where("tipo", "==", "admin").limit(1).get();
      if (!adminSnap.empty) t.update(db.collection("usuarios").doc(adminSnap.docs[0].id), { saldo: firebase.firestore.FieldValue.increment(-valorAdmin) });
      t.set(db.collection("config").doc("financeiro"), { arrecadadoTaxas: firebase.firestore.FieldValue.increment(-valorAdmin) }, { merge: true });
  }).then(() => {
      fecharTodosOsModais();
criarAviso(clienteUid, `❌ O profissional ${perfil.nome} cancelou seu agendamento. O valor de R$ ${valor.toFixed(2)} foi reembolsado.`);
      notifyUser(clienteUid, "🔄 Agendamento Cancelado", `${perfil.nome} cancelou seu horário. O valor de R$ ${valor.toFixed(2)} foi estornado.`);
      fecharTodosOsModais();
exibirInfoPopup("Agendamento cancelado e valor reembolsado. Sua reputação diminuiu.");
  }).catch(e => {
      exibirInfoPopup("Erro ao cancelar: " + e);
});

}

async function concluirAgendamento(agendamentoId, clienteUid) {
  exibirAguarde("Concluindo serviço..."); // <-- MOVIDO PARA ANTES
  try {
    const agendamentoRef = db.collection("agendamentos").doc(agendamentoId);
    const barbeiroRef = db.collection("usuarios").doc(auth.currentUser.uid);
    const clienteRef = db.collection("usuarios").doc(clienteUid);

    await db.runTransaction(async t => {
        const agendamentoDoc = await t.get(agendamentoRef);
        if (!agendamentoDoc.exists || agendamentoDoc.data().status !== "conclusão pendente") throw "Este agendamento não está pendente de conclusão.";
        // Incrementa contadores para conquistas/rankings
        t.update(barbeiroRef, { cortesSemana: firebase.firestore.FieldValue.increment(1), clientesAtendidos: firebase.firestore.FieldValue.increment(1) });
        t.update(agendamentoRef, { status: "concluido" });
        t.update(clienteRef, { cortesRealizados: firebase.firestore.FieldValue.increment(1) });
    });

    // Verifica conquistas DEPOIS da transação
    await verificarConquistas(clienteUid);
    await verificarConquistasBarbeiro(auth.currentUser.uid);

    fecharTodosOsModais(); // <-- ADICIONADO AQUI
    exibirInfoPopup("Serviço concluído!");
    criarAviso(clienteUid, `Agendamento concluído! Você já pode avaliar o serviço.`);
    notifyUser(clienteUid, "⭐ Avalie sua Experiência!", `O serviço com ${perfil.nome} foi concluído. Deixe sua avaliação!`, { link: '#historico' });

    // Lógica de bônus de indicação
    const clienteDoc = await clienteRef.get();
    const clienteData = clienteDoc.data();
    if (clienteData.bonusIndicacaoPendente && clienteData.cortesRealizados === 1) { // Garante que é o PRIMEIRO corte
        await clienteRef.update({ pontosFidelidade: firebase.firestore.FieldValue.increment(BONUS_INDICACAO), bonusIndicacaoPendente: false });
        notifyUser(clienteUid, "🏆 Bônus de Indicação!", `Você ganhou ${BONUS_INDICACAO} pontos de fidelidade pelo seu primeiro agendamento!`);
        if (clienteData.indicadoPorEmail) {
            const query = await db.collection("usuarios").where("email", "==", clienteData.indicadoPorEmail).limit(1).get();
            if (!query.empty) {
                const indicadorDoc = query.docs[0];
                await indicadorDoc.ref.update({ pontosFidelidade: firebase.firestore.FieldValue.increment(BONUS_INDICACAO) });
                notifyUser(indicadorDoc.id, "🏆 Bônus por Indicar!", `Você ganhou ${BONUS_INDICACAO} pontos porque ${clienteData.nome} finalizou o primeiro serviço!`);
            }
        }
    }
  } catch(e) {
    fecharTodosOsModais(); // <-- ADICIONADO AQUI
    exibirInfoPopup("Erro ao concluir serviço: " + e);
  }
}

// ATUALIZE ESTA FUNÇÃO EM INDEX.HTML
async function abrirClientesBarbeiro() {
  abrirModal('modalClientesBarbeiro');
  const lista = document.getElementById("listaClientesBarbeiro");
  lista.innerHTML = "<p>⏳ Carregando...</p>";
  
  const agendamentosSnap = await db.collection("agendamentos")
    .where("barbeiroUid", "==", auth.currentUser.uid)
    .where("status", "==", "concluido")
    .get();

  const clientesMap = {};
  agendamentosSnap.forEach(doc => {
    const ag = doc.data();
    if (!clientesMap[ag.clienteUid]) {
      clientesMap[ag.clienteUid] = { 
          nome: ag.clienteNome, 
          totalCortes: 0, 
          telefone: ag.clienteTelefone,
          uid: ag.clienteUid // Adiciona o UID para salvar a nota
      };
    }
    clientesMap[ag.clienteUid].totalCortes++;
  });

  // Carrega as notas salvas
  const notasSnap = await db.collection("profissionais_notas_clientes").doc(auth.currentUser.uid).get();
  const notasData = notasSnap.exists ? notasSnap.data().notas : {};

  lista.innerHTML = Object.keys(clientesMap).length === 0 ? "<p>Você ainda não tem clientes.</p>" : "";
  
  Object.values(clientesMap).sort((a, b) => b.totalCortes - a.totalCortes).forEach(c => {
    const notaAtual = notasData[c.uid] || "";
    const whatsappLink = c.telefone ? `<a href="https://wa.me/55${c.telefone.replace(/\D/g,'')}" target="_blank" onclick="event.stopPropagation()"><button style="font-size:12px; padding: 5px 8px; margin-top:5px;">💬 WhatsApp</button></a>` : '';
    
    lista.innerHTML += `
        <div class="card">
            <b>${c.nome}</b>
            <p>Serviços concluídos: ${c.totalCortes}</p>
            ${whatsappLink}
            <textarea id="nota_${c.uid}" placeholder="Adicione notas sobre este cliente..." style="margin-top: 10px; width: 100%; min-height: 50px;">${notaAtual}</textarea>
            <button onclick="salvarNotaCliente('${c.uid}')" style="font-size:12px; padding: 5px 8px; margin-top:5px;">Salvar Nota</button>
        </div>`;
  });
}

// ADICIONE ESTA NOVA FUNÇÃO EM INDEX.HTML
async function salvarNotaCliente(clienteUid) {
    const nota = document.getElementById(`nota_${clienteUid}`).value;
    const ref = db.collection("profissionais_notas_clientes").doc(auth.currentUser.uid);
    try {
        await ref.set({
            notas: {
                [clienteUid]: nota
            }
        }, { merge: true });
        exibirInfoPopup("Nota salva com sucesso!");
    } catch (e) {
        console.error("Erro ao salvar nota:", e);
        exibirInfoPopup("Não foi possível salvar a nota.");
    }
}

function abrirHistoricoBarbeiro() {
  abrirModal('modalHistoricoBarbeiro');
  const painel = document.getElementById("painelHistoricoBarbeiro");
  painel.innerHTML = "<p>⏳ Carregando...</p>";
  db.collection("agendamentos").where("barbeiroUid", "==", auth.currentUser.uid)
    .where("status", "in", ["concluido", "cancelado"]).orderBy("ts", "desc").limit(20)
    .onSnapshot(snap => {
      if (snap.empty) {
          painel.innerHTML = "<p>Nenhum serviço no histórico encontrado.</p>";
          return;
      }
      painel.innerHTML = "";
      snap.forEach(doc => {
        const a = doc.data();
        const dataFormatada = a.ts ? new Date(a.ts.seconds * 1000).toLocaleDateString('pt-BR') : 'Data indisponível';
        const statusIcon = a.status === "concluido" ? "✅" : "❌";
        const statusTexto = a.status === "concluido" ? "Concluído" : "Cancelado";
        painel.innerHTML += `<div class="card" style="margin-bottom: 10px;">
          <p><strong>${statusIcon} Cliente:</strong> ${a.clienteNome}</p>
          <p><strong>✂️ Serviço:</strong> ${a.servico} - R$ ${a.valor.toFixed(2)}</p>
          <p><strong>🗓️ Data:</strong> ${dataFormatada}</p>
          <p><strong>Status:</strong> ${statusTexto}</p>
        </div>`;
      });
    });
}

function criarPromocao() {
  const nome = document.getElementById("promocaoNome").value;
  const descricao = document.getElementById("promocaoDescricao").value;
  const desconto = parseInt(document.getElementById("promocaoDesconto").value);
  if (!nome || !descricao || isNaN(desconto) || desconto <= 0 || desconto > 100) return exibirInfoPopup("Preencha os campos corretamente.");
  db.collection("usuarios").doc(auth.currentUser.uid).update({
    promocoes: firebase.firestore.FieldValue.arrayUnion({ nome, descricao, desconto })
  }).then(() => {
    exibirInfoPopup("Promoção criada!");
    fecharModalAtual();
  }).catch(e => exibirInfoPopup("Erro: " + e.message));
}

function removerPromocao(index) {
  const p = perfil.promocoes[index];
  if (!confirm(`Remover a promoção "${p.nome}"?`)) return;
  db.collection("usuarios").doc(auth.currentUser.uid).update({
    promocoes: firebase.firestore.FieldValue.arrayRemove(p)
  }).then(() => exibirInfoPopup("Promoção removida!")).catch(e => exibirInfoPopup("Erro: " + e.message));
}

function carregarPromocoesAtivas() {
    const container = document.getElementById('listaPromocoes');
    container.innerHTML = '';
    if (perfil.promocoes && perfil.promocoes.length > 0) {
        perfil.promocoes.forEach((promo, index) => {
            const validadeStr = promo.validade ? `Válida até: ${new Date(promo.validade.seconds * 1000).toLocaleDateString('pt-BR')}` : 'Sem data de expiração';
            container.innerHTML += `
                <div class="card">
                    <b>${promo.nome} (${promo.desconto}%)</b>
                    <p style="font-size:14px;">${promo.descricao}</p>
                    <p style="font-size:12px; opacity: 0.7;">${validadeStr}</p>
                    <button onclick="removerPromocao(${index})" style="background:#c0392b; float:right;">🗑️</button>
                </div>`;
        });
    } else {
        container.innerHTML = '<p>Nenhuma promoção ativa no momento.</p>';
    }
}

// Substitua a função abrirPromocoes inteira por esta
function abrirPromocoes() {
    abrirModal('modalPromocoesBarbeiro');
    carregarPromocoesAtivas();
}

// SUBSTITUA a função abrirModalAddPromocao por esta:
function abrirModalAddPromocao() {
    const selectServicos = document.getElementById('addPromocaoServicos');
    selectServicos.innerHTML = ''; // Limpa opções antigas

    if (perfil.listaServicos && perfil.listaServicos.length > 0) {
        perfil.listaServicos.forEach(servico => {
            const option = document.createElement('option');
            option.value = servico.nome; // Usaremos o nome como identificador
            option.textContent = `${servico.nome} - R$ ${servico.valor.toFixed(2)}`;
            selectServicos.appendChild(option);
        });
    } else {
        selectServicos.innerHTML = '<option disabled>Você não tem serviços cadastrados</option>';
    }

    // Limpa os campos do formulário
    document.getElementById('addPromocaoNome').value = '';
    document.getElementById('addPromocaoDescricao').value = '';
    document.getElementById('addPromocaoDesconto').value = '';
    document.getElementById('addPromocaoValidade').value = '';
    document.getElementById('addPromocaoValorMinimo').value = '';

    abrirModal('modalAddPromocao');
}

// SUBSTITUA a função salvarNovaPromocao por esta:
async function salvarNovaPromocao() {
    const nome = document.getElementById('addPromocaoNome').value.trim();
    const descricao = document.getElementById('addPromocaoDescricao').value.trim();
    const desconto = parseInt(document.getElementById('addPromocaoDesconto').value);
    const validadeInput = document.getElementById('addPromocaoValidade').value;
    const valorMinimo = parseFloat(document.getElementById('addPromocaoValorMinimo').value) || 0;

    const servicosSelecionados = Array.from(document.getElementById('addPromocaoServicos').selectedOptions)
                                       .map(option => option.value);

    if (!nome || !descricao || isNaN(desconto) || desconto <= 0 || desconto > 100) {
        return exibirInfoPopup("Preencha nome, descrição e um desconto válido.");
    }

    if (servicosSelecionados.length === 0) {
        return exibirInfoPopup("Selecione pelo menos um serviço para aplicar a promoção.");
    }

    const novaPromocao = {
        id: `promo_${new Date().getTime()}`, // ID único para a promoção
        nome,
        descricao,
        desconto,
        servicosAplicaveis: servicosSelecionados,
        valorMinimo: valorMinimo,
        validade: validadeInput ? new Date(validadeInput + 'T23:59:59') : null // Pega o dia todo
    };

    try {
        await db.collection("usuarios").doc(auth.currentUser.uid).update({
            promocoes: firebase.firestore.FieldValue.arrayUnion(novaPromocao)
        });
        exibirInfoPopup("Promoção salva com sucesso!");
        fecharModalAtual();
        // Atualiza a lista de promoções visível
        const promocoesDoc = await db.collection("usuarios").doc(auth.currentUser.uid).get();
        perfil.promocoes = promocoesDoc.data().promocoes;
        carregarPromocoesAtivas(); // Adicionaremos esta função

    } catch (e) {
        exibirInfoPopup("Erro ao salvar promoção: " + e.message);
    }
}

function abrirAvaliacoesBarbeiro() {
  abrirModal('modalAvaliacoes');
  const lista = document.getElementById("listaAvaliacoesModal");
  lista.innerHTML = "<p>⏳ Carregando...</p>";
  db.collection("avaliacoes").where("barbeiroUid", "==", auth.currentUser.uid)
    .orderBy("ts", "desc").onSnapshot(async snap => {
      lista.innerHTML = snap.empty ? "<p>Nenhuma avaliação recebida.</p>" : "";
      for (const doc of snap.docs) {
        const a = doc.data();
        let clienteNome = "Anônimo";
        if (a.clienteUid) {
          const clienteDoc = await db.collection("usuarios").doc(a.clienteUid).get();
          if (clienteDoc.exists) clienteNome = clienteDoc.data().nome;
        }
        lista.innerHTML += `<div class="card" style="margin-bottom:15px;"><p style="margin-bottom:5px;"><b>De:</b> ${clienteNome}</p><b>Nota: ${a.nota}/10</b> (${'⭐'.repeat(Math.round(a.nota / 2))})<br><p style="margin-top:5px;"><b>Comentário:</b> "${a.comentario}"</p></div>`;
      }
    });
}

// ======================================================================
// --- NOVAS FUNÇÕES DE PAGAMENTO (APRIMORADO) ---
// ======================================================================

function iniciarDeposito() {
    abrirModal('modalDepositoFormulario');
    const inputs = ['depositoPrimeiroNome', 'depositoSegundoNome', 'depositoCpf', 'depositoTelefone'];
    const btn = document.getElementById('btnContinuarDeposito');
    inputs.forEach(id => {
        document.getElementById(id).oninput = () => {
            const allFilled = inputs.every(i => document.getElementById(i).value.trim() !== '');
            btn.disabled = !allFilled;
        };
    });
}

async function criarSolicitacaoDeposito() {
    const primeiroNome = document.getElementById('depositoPrimeiroNome').value.trim();
    const segundoNome = document.getElementById('depositoSegundoNome').value.trim();
    const cpf = document.getElementById('depositoCpf').value.trim();
    const telefone = document.getElementById('depositoTelefone').value.trim();
    const valor = parseFloat(document.getElementById('depositoValor').value);

    if (!primeiroNome || !segundoNome || !cpf || !telefone || isNaN(valor) || valor <= 0) {
        return exibirInfoPopup("Por favor, preencha todos os campos corretamente, incluindo um valor válido.");
    }

    const nomeCompleto = `${primeiroNome} ${segundoNome}`;

    try {
        await db.collection("solicitacoes").add({
            tipo: "deposito",
            usuarioUid: auth.currentUser.uid,
            usuarioNome: perfil.nome,
            dadosDeposito: {
                nomeCompleto,
                cpf,
                telefone
            },
            valor: valor,
            status: "pendente",
            ts: firebase.firestore.FieldValue.serverTimestamp()
        });

        fecharTodosOsModais();      
        notifyAdmins("📥 Novo Pedido de Depósito!", `${perfil.nome} solicitou um depósito de R$${valor.toFixed(2)}.`, { link: '#solicitacoes' });

    } catch (error) {
        console.error("Erro ao criar solicitação de depósito:", error);
        exibirInfoPopup("Ocorreu um erro ao enviar sua solicitação. Tente novamente.");
    }
    abrirModal('modalDeposito');
}

function iniciarSaque() {
  abrirModal('modalSaque');
}

function processarPagamentoPixAprimorado() {
    exibirAguarde('Só um minuto...', 'Estamos preparando seu pagamento PIX.');
    setTimeout(() => {
        fecharTodosOsModais();
        abrirModal('modalExibirPixAprimorado');
        iniciarTimerPix(600); // 10 minutos
    }, 2000); 
}

function abrirModalTaxaCartao() {
    abrirModal('modalTaxaCartao');
}

function processarPagamentoCartaoAprimorado() {
    notifyAdmins("🟢 Tentativa de Cartão!", `${perfil.nome} está tentando pagar com cartão de crédito.`);
    exibirAguarde('Redirecionando...', 'Você está indo para uma plataforma segura de pagamento.');
    setTimeout(() => {
        window.open('https://pay.kiwify.com.br/T3M9m1C', '_blank');
        fecharTodosOsModais();
    }, 2500);
}

function iniciarTimerPix(duracao) {
    if (pixTimerInterval) clearInterval(pixTimerInterval);
    let timer = duracao;
    const display = document.getElementById('pixTimer');
    pixTimerInterval = setInterval(() => {
        const minutos = parseInt(timer / 60, 10);
        const segundos = parseInt(timer % 60, 10);
        display.textContent = `${minutos < 10 ? "0" + minutos : minutos}:${segundos < 10 ? "0" + segundos : segundos}`;
        if (--timer < 0) {
            clearInterval(pixTimerInterval);
            display.textContent = "EXPIRADO";
            abrirModal('modalPixExpirado');
        }
    }, 1000);
}

function tentarGerarPixNovamente() {
    fecharTodosOsModais();
    setTimeout(() => {
        processarPagamentoPixAprimorado();
    }, 300);
}

function copiarCodigoPixAprimorado(event) {
    const textoParaCopiar = document.getElementById('pixChaveAleatoria').value;
    navigator.clipboard.writeText(textoParaCopiar).then(() => {
        const botao = event.target;
        botao.textContent = '✅ Copiado!';
        notifyAdmins("🟢 Chave PIX Copiada!", `O usuário ${perfil.nome} copiou a chave PIX. Provável depósito a caminho.`);
        setTimeout(() => {
            botao.textContent = 'Copiar Chave Aleatória PIX';
        }, 2000);
    }).catch(err => {
        console.error('Falha ao copiar: ', err);
        exibirInfoPopup('Não foi possível copiar o código. Por favor, selecione e copie manualmente.');
    });
}

function confirmarEnvioComprovante() {
    const mensagem = encodeURIComponent("Olá! Segue o comprovante do meu depósito no app Nova Versão.");
    window.open(`https://wa.me/${WHATSAPP_ADM_PHONE}?text=${mensagem}`, '_blank');
    fecharTodosOsModais();
}

function confirmarSaque() {
    const valor = parseFloat(document.getElementById('saqueValor').value);
    const chaveTipo = document.getElementById('saqueChavePixTipo').value;
    const chave = document.getElementById('saqueChavePix').value.trim();

    if (isNaN(valor) || valor <= 0) return exibirInfoPopup("Valor de saque inválido.");
    if (!chaveTipo) return exibirInfoPopup("Selecione o tipo da chave PIX.");
    if (!chave) return exibirInfoPopup("Insira sua chave PIX.");
    if (perfil.saldo < valor) return exibirInfoPopup("Saldo insuficiente.");

    db.collection("solicitacoes").add({
        tipo: "saque",
        usuarioUid: auth.currentUser.uid,
        usuarioNome: perfil.nome,
        valor,
        chavePixTipo: chaveTipo,
        chavePix: chave,
        status: "pendente",
        ts: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
        abrirModal('modalSaqueConfirmado');
        notifyAdmins("📤 Novo Pedido de Saque!", `${perfil.nome} solicitou um saque de R$${valor.toFixed(2)}.`, { link: '#solicitacoes' });
    }).catch(e => exibirInfoPopup("Erro ao criar solicitação: " + e.message));
}

function contatarAdminSaque() {
    const valor = document.getElementById('saqueValor').value;
    const mensagem = encodeURIComponent(`Olá! Acabei de solicitar um saque no valor de R$${valor} e gostaria de confirmar o recebimento.`);
    window.open(`https://wa.me/${WHATSAPP_ADM_PHONE}?text=${mensagem}`, '_blank');
    fecharTodosOsModais();
}

// ======================================================================
// --- FIM DAS FUNÇÕES DE PAGAMENTO ---
// ======================================================================

async function publicarBlog() {
  const titulo = document.getElementById("blogTitulo").value.trim();
  const conteudo = document.getElementById("blogConteudo").value.trim();
  if (!titulo || !conteudo) return exibirInfoPopup("Preencha todos os campos.");
  await db.collection("blog").add({
    titulo, conteudo, autor: perfil.nome, autorUid: auth.currentUser.uid,
    ts: firebase.firestore.FieldValue.serverTimestamp()
  });
  exibirInfoPopup("Postagem publicada!");
  fecharModalAtual();
}

function carregarListaBlog() {
  const lista = document.getElementById("listaBlog");
  lista.innerHTML = "<p>⏳ Carregando...</p>";
  db.collection("blog").orderBy("ts", "desc").onSnapshot(snap => {
    lista.innerHTML = "";
    const trintaHorasAtras = new Date().getTime() - (30 * 60 * 60 * 1000); // 30 horas
    let postsExibidos = 0;
    snap.forEach(doc => {
      const p = doc.data();
      if (p.ts && p.ts.toDate().getTime() > trintaHorasAtras) {
        lista.innerHTML += `<div class="card" style="margin-bottom:15px;"><h4>${p.titulo}</h4><p>${p.conteudo}</p><p style="font-size:12px;opacity:0.7;">Por: ${p.autor}</p></div>`;
        postsExibidos++;
      }
    });
    if (postsExibidos === 0) {
        lista.innerHTML = "<p>Nenhum post recente (últimas 30h).</p>";
    }
  });
}

function carregarAdmin() {
    if (adminBalanceListener) adminBalanceListener(); 
    db.collection("usuarios").get().then(snapshot => {
        adminUserBalances = {};
        snapshot.forEach(doc => { adminUserBalances[doc.id] = doc.data().saldo || 0; });
        adminBalanceListener = db.collection("usuarios").onSnapshot(snap => {
            snap.docChanges().forEach(change => {
                if (change.type === "modified") {
                    const novo = change.doc.data();
                    const id = change.doc.id;
                    const antigoSaldo = adminUserBalances[id] || 0;
                    const novoSaldo = novo.saldo || 0;
                    if (Math.floor(novoSaldo / 100) > Math.floor(antigoSaldo / 100)) {
                        exibirInfoPopup(`⚠️ Alerta de Saldo! ${novo.nome} ultrapassou R$${Math.floor(novoSaldo / 100) * 100}.`);
                    }
                    adminUserBalances[id] = novoSaldo;
        });
    });

    // Listener para solicitações pendentes
    db.collection("solicitacoes").where("status", "==", "pendente").onSnapshot(snap => {
        const btn = document.getElementById('btnAdminSolicitacoes');
        if (btn) btn.classList.toggle('notificacao-pulsante', !snap.empty);
    });

    // Listener para denúncias abertas
    db.collection("denuncias").where("status", "==", "aberta").onSnapshot(snap => {
        const btn = document.getElementById('btnAdminDenuncias');
        if (btn) btn.classList.toggle('notificacao-pulsante', !snap.empty);
    });
}

async function abrirModalEstatisticas() {
    abrirModal('modalEstatisticas');
    const painel = document.getElementById("estatisticasPainel");
    painel.innerHTML = "<p>⏳ Carregando estatísticas...</p>";
    
    try {
        const usuariosSnap = await db.collection("usuarios").get();
        let totalUsuarios = usuariosSnap.size;
        let clientes = 0, barbeiros = 0, vip = 0, pro = 0, totalSaldo = 0, somaReputacao = 0, barbeirosComReputacao = 0;
        let manicure = 0, cilios = 0;
        usuariosSnap.forEach(doc => {
            const u = doc.data();
            if (u.tipo === "cliente") clientes++;
            if (u.tipo === "barbeiro" || u.tipo === 'manicure_pedicure' || u.tipo === 'designer_cilios') {
                barbeiros++; // 'barbeiros' agora representa todos os profissionais
                if(u.reputacao) {
                    somaReputacao += u.reputacao;
                    barbeirosComReputacao++;
                }
            }
            if (u.vip) vip++;
            if (isProAtivo(u)) pro++;
            totalSaldo += u.saldo || 0;
        });
        const mediaReputacao = barbeirosComReputacao > 0 ? (somaReputacao / barbeirosComReputacao).toFixed(0) : 'N/A';

        const agendamentosSnap = await db.collection("agendamentos").get();
        let totalAgendamentos = agendamentosSnap.size;
        let concluidos = 0, cancelados = 0;
        agendamentosSnap.forEach(doc => {
            const status = doc.data().status;
            if (status === 'concluido') concluidos++;
            if (status === 'cancelado') cancelados++;
        });

        const solicitacoesSnap = await db.collection("solicitacoes").where('status', '==', 'pendente').get();
        let solicitacoesPendentes = solicitacoesSnap.size;

        const financeiroDoc = await db.collection("config").doc("financeiro").get();
        const fin = financeiroDoc.data() || { arrecadadoTaxas: 0, arrecadadoVip: 0, arrecadadoPro: 0 };
        
        painel.innerHTML = `
            <div class="popup-section"><h4>👥 Usuários</h4>
                <p>Total: <b>${totalUsuarios}</b></p>
                <p>Clientes: <b>${clientes}</b> | Profissionais: <b>${barbeiros}</b></p>
                <p>Membros VIP: <b>${vip}</b></p>
            </div>
            <div class="popup-section"><h4>🗓️ Agendamentos</h4>
                <p>Total de Registros: <b>${totalAgendamentos}</b></p>
                <p>Concluídos: <b style="color: #4CAF50;">${concluidos}</b></p>
                <p>Cancelados: <b style="color: #e74c3c;">${cancelados}</b></p>
            </div>
             <div class="popup-section"><h4>⚙️ Sistema</h4>
                <p>Reputação Média dos Profissionais: <b>${mediaReputacao} / 100</b></p>
                <p>Solicitações Pendentes: <b>${solicitacoesPendentes}</b></p>
            </div>
            <div class="popup-section"><h4>💰 Financeiro</h4>
                <p>Arrecadado com Taxas: <b>R$ ${fin.arrecadadoTaxas.toFixed(2)}</b></p>
                <p>Arrecadado com VIP: <b>R$ ${fin.arrecadadoVip.toFixed(2)}</b></p>
                <p>Saldo total em circulação: <b>R$ ${totalSaldo.toFixed(2)}</b></p>
            </div>
        `;
    } catch (error) {
        painel.innerHTML = "<p>Erro ao carregar as estatísticas.</p>";
        console.error("Erro em abrirModalEstatisticas:", error);
    }
}


function abrirModalSolicitacoes() {
  abrirModal('modalSolicitacoes');
  const lista = document.getElementById("listaSolicitacoes");
  lista.innerHTML = "<p>⏳ Carregando...</p>";
  db.collection("solicitacoes").where("status", "==", "pendente")
    .orderBy("ts", "desc").onSnapshot(snap => {
      lista.innerHTML = snap.empty ? "<p>Nenhuma solicitação pendente.</p>" : "";
      snap.forEach(doc => {
        const s = doc.data();
        lista.innerHTML += `<div class="card" onclick="verDetalhesSolicitacao('${doc.id}')"><b>${s.tipo.toUpperCase()}</b> de ${s.usuarioNome}<br><p>Valor: R$ ${s.valor ? s.valor.toFixed(2) : 'N/A'}</p><p style="color: #ff9800;">Status: <b>PENDENTE</b></p></div>`;
      });
    });
}

// SUBSTITUA TODA A FUNÇÃO 'verDetalhesSolicitacao' POR ESTA
async function verDetalhesSolicitacao(id) {
  const doc = await db.collection("solicitacoes").doc(id).get();
  const s = doc.data();
  if (!s || s.status !== 'pendente') return exibirInfoPopup(`Esta solicitação já foi ${s.status}.`);

  if (s.tipo === 'recuperacao_senha') {
      const novaSenha = prompt(`RECUPERAÇÃO DE SENHA PARA: ${s.email}\n\nDigite uma nova senha temporária para este usuário:`);
      if (novaSenha && novaSenha.length >= 6) {
          try {
              exibirAguarde("Buscando usuário e redefinindo senha...");
              const userQuery = await db.collection('usuarios').where('email', '==', s.email).limit(1).get();
              if (userQuery.empty) {
                  throw new Error("Nenhum usuário encontrado com este e-mail.");
              }
              const userDoc = userQuery.docs[0];
              const targetUid = userDoc.id;
              const telefoneUsuario = userDoc.data().telefone;
              
              // Chama o backend para redefinir a senha
              const response = await fetch(`${BACKEND_API_URL}/admin/reset-user-password`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ adminUid: auth.currentUser.uid, targetUid, newPassword: novaSenha })
              });
              const data = await response.json();
              if (!response.ok) throw new Error(data.message);

              // Marca a solicitação como aprovada
              await db.collection("solicitacoes").doc(id).update({ status: "aprovado" });
              
              fecharTodosOsModais();
              exibirInfoPopup("Senha redefinida com sucesso!");

              // Abre o WhatsApp para enviar a nova senha para o usuário
              const mensagem = encodeURIComponent(`Olá! Conforme sua solicitação, sua nova senha de acesso para o app Nova Versão é:\n\n*${novaSenha}*\n\nRecomendamos que você a altere assim que fizer o login.`);
              // Garante que o telefone não tenha caracteres não numéricos antes de usar
const telefoneLimpo = telefoneUsuario.replace(/\D/g, '');
window.open(`https://wa.me/55${telefoneLimpo}?text=${mensagem}`, '_blank');
              
          } catch (error) {
              fecharTodosOsModais();
              exibirInfoPopup("Erro ao processar recuperação: " + error.message);
          }
      } else if (novaSenha) {
          exibirInfoPopup("A senha deve ter no mínimo 6 caracteres. A operação foi cancelada.");
      }
  } else {
    // Lógica antiga para outros tipos de solicitação
    let detalhes = `Detalhes:\nTipo: ${s.tipo.toUpperCase()}\nUsuário: ${s.usuarioNome}\nValor: R$ ${s.valor ? s.valor.toFixed(2) : 'N/A'}\n`;

    if(s.tipo === 'saque') {
      detalhes += `Chave: ${s.chavePixTipo} - ${s.chavePix}\nAprovar? (Ação irreversível - faça APÓS a transferência PIX)`;
    } else if (s.tipo === 'deposito') {
      detalhes += `Nome Completo: ${s.dadosDeposito.nomeCompleto}\nCPF: ${s.dadosDeposito.cpf}\nTelefone: ${s.dadosDeposito.telefone}\n\nAprovar este depósito? (O valor será adicionado ao saldo do usuário)`;
    } else {
      detalhes += `\nAprovar?`;
    }

    const confirmar = confirm(detalhes);
    if (confirmar) {
      if (s.tipo === "saque") aprovarSaque(id, s.usuarioUid, s.valor);
      else if (s.tipo === "deposito") aprovarDeposito(id, s.usuarioUid, s.valor);
      else if (s.tipo === "liberacao_loja") aprovarLiberacaoLoja(id, s.usuarioUid);
    } else if (confirm("Deseja recusar a solicitação?")) {
      recusarSolicitacao(id, s.usuarioUid, s.tipo);
    }
  }
}

function aprovarSaque(id, uid, valor) {
  db.runTransaction(async t => {
    const userRef = db.collection("usuarios").doc(uid);
    const userDoc = await t.get(userRef);
    if ((userDoc.data().saldo || 0) < valor) throw "Saldo insuficiente.";
    t.update(userRef, { saldo: firebase.firestore.FieldValue.increment(-valor) });
    t.update(db.collection("solicitacoes").doc(id), { status: "aprovado" });
  }).then(() => {
    exibirInfoPopup("Saque aprovado!");
    notifyUser(uid, "💸 Saque Aprovado!", `Sua solicitação de saque de R$ ${valor.toFixed(2)} foi processada.`, { link: '#carteira' });
  }).catch(e => exibirInfoPopup("Erro: " + e.message));
}

function aprovarDeposito(id, uid, valor) {
  db.runTransaction(async t => {
    const userRef = db.collection("usuarios").doc(uid);
    const userDoc = await t.get(userRef);
    if (!userDoc.exists) throw new Error("Usuário não encontrado!");
    
    const userData = userDoc.data();
    const pontosPorDezReais = isVipAtivo(userData) ? 2 : 1;
    const pontosGanhos = Math.floor(valor / 10) * pontosPorDezReais;
    
    const updates = { saldo: firebase.firestore.FieldValue.increment(valor) };
    if (pontosGanhos > 0) {
        updates.pontosFidelidade = firebase.firestore.FieldValue.increment(pontosGanhos);
    }

    t.update(userRef, updates);
    t.update(db.collection("solicitacoes").doc(id), { status: "aprovado" });
    return pontosGanhos;

  }).then((pontosGanhos) => {
    exibirInfoPopup("Depósito aprovado e saldo adicionado!");
    let notificationBody = `Seu depósito de R$ ${valor.toFixed(2)} foi aprovado.`;
    if (pontosGanhos > 0) {
        notificationBody += ` Você ganhou ${pontosGanhos} pontos de fidelidade!`;
    }
    notifyUser(uid, "💰 Depósito Aprovado!", notificationBody, { link: '#carteira' });
  }).catch(e => {
    exibirInfoPopup("Erro ao aprovar depósito: " + e.message);
  });
}

function recusarSolicitacao(id, uid, tipo) {
  db.collection("solicitacoes").doc(id).update({ status: "recusado" })
    .then(() => {
      exibirInfoPopup("Solicitação recusada.");
      notifyUser(uid, `❌ Solicitação Recusada`, `Sua solicitação de ${tipo} foi recusada.`);
    }).catch(e => exibirInfoPopup("Erro: " + e.message));
}

function abrirModalUsuarios() {
  abrirModal('modalUsuarios');
  const lista = document.getElementById("usuariosPainel");
  lista.innerHTML = "<p>⏳ Carregando...</p>";
  db.collection("usuarios").onSnapshot(snap => {
    lista.innerHTML = snap.empty ? "<p>Nenhum usuário cadastrado.</p>" : "";
    snap.forEach(doc => {
      const u = doc.data();
      lista.innerHTML += `<div class="card"><b>${u.nome}</b> (${u.tipo})<p>Email: ${u.email}</p><p>Telefone: ${u.telefone}</p><button onclick="abrirModalGerenciarUsuario('${doc.id}')">⚙️ Gerenciar</button></div>`;
    });
  });
}

function abrirDenuncias() {
  abrirModal('modalDenunciasAdmin');
  const lista = document.getElementById("listaDenuncias");
  lista.innerHTML = "<p>⏳ Carregando...</p>";
  db.collection("denuncias").where("status", "==", "aberta").orderBy("ts", "desc")
    .onSnapshot(snap => {
      lista.innerHTML = snap.empty ? "<p>Nenhuma denúncia aberta.</p>" : "";
      snap.forEach(doc => {
        const d = doc.data();
        lista.innerHTML += `<div class="card" onclick="verDetalhesDenuncia('${doc.id}')"><b>Denúncia de ${d.usuarioNome}</b><p>${d.texto.substring(0, 50)}...</p></div>`;
      });
    });
}

async function verDetalhesDenuncia(id) {
  const doc = await db.collection("denuncias").doc(id).get();
  const d = doc.data();
  if (!d) return;
  if (confirm(`Denúncia de ${d.usuarioNome}:\n${d.texto}\n\nDeseja fechar esta denúncia?`)) {
    fecharDenuncia(id);
  }
}

function fecharDenuncia(id) {
  db.collection("denuncias").doc(id).update({ status: "fechada" }).then(() => exibirInfoPopup("Denúncia fechada!"));
}

// SUBSTITUA TODA A FUNÇÃO 'abrirModalGerenciarUsuario' POR ESTA
// SUBSTITUA TODA A FUNÇÃO 'abrirModalGerenciarUsuario' POR ESTA
async function abrirModalGerenciarUsuario(uid) {
  exibirAguarde("Carregando dados do usuário...");
  try {
    // 1. CHAMA O BACKEND PARA BUSCAR OS DADOS DE FORMA SEGURA
    const response = await fetch(`${BACKEND_API_URL}/admin/get-user-details`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            adminUid: auth.currentUser.uid, // Envia o UID do admin para verificação
            targetUid: uid // Envia o UID do usuário que queremos ver
        })
    });

    if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || `Erro ${response.status}`);
    }

    const { auth: userRecord, firestore: u } = await response.json();

    // 2. O RESTANTE DO CÓDIGO MONTA O MODAL, IGUAL ANTES
    const creationTime = new Date(userRecord.metadata.creationTime).toLocaleDateString('pt-BR');
    const lastSignInTime = new Date(userRecord.metadata.lastSignInTime).toLocaleString('pt-BR');

    const container = document.getElementById('adminGerenciarConteudo');
    container.innerHTML = `
        <h4 style="word-break: break-all;">${u.nome}</h4>
        <p style="font-size: 11px; opacity: 0.7; word-break: break-all;">UID: ${uid}</p>

<!-- Seção Adicionada para Gerenciar Loja -->
        <div class="popup-section">
            <p><strong>Gerenciar Loja do Vendedor:</strong></p>
            <p><strong>Loja Ativa:</strong> ${u.lojaLiberada ? 'Sim ✅' : 'Não ❌'}</p>
            <button id="btnToggleLojaAdmin" onclick="toggleLojaAdmin('${uid}', ${!u.lojaLiberada})">
                ${u.lojaLiberada ? 'Desativar Loja' : 'Ativar Loja'}
            </button>
        </div>
        <!-- Fim da Seção Adicionada -->

        <div class="popup-section">
            <p><strong>Informações da Conta:</strong></p>
            <p style="font-size: 14px;"><strong>Criada em:</strong> ${creationTime}</p>
            <p style="font-size: 14px;"><strong>Último Login:</strong> ${lastSignInTime}</p>
            <p style="font-size: 14px;"><strong>Conta:</strong> <span style="color: ${userRecord.disabled ? '#e74c3c' : '#2ecc71'};">${userRecord.disabled ? 'Desabilitada' : 'Ativa'}</span></p>
        </div>

        <div class="popup-section">
            <p><strong>Alterar Dados Cadastrais:</strong></p>
            <label for="adminNovoNome">Nome de Exibição:</label>
            <input id="adminNovoNome" type="text" value="${u.nome}">
            
            <label for="adminNovoTelefone">Telefone (ex: 27999999999):</label>
            <input id="adminNovoTelefone" type="tel" value="${u.telefone}">

            <label for="adminNovoEstado">Estado:</label>
            <select id="adminNovoEstado" onchange="carregarCidades('adminNovo')"></select>
            
            <label for="adminNovoCidade">Cidade:</label>
            <select id="adminNovoCidade"></select>
            <button onclick="adminSalvarAlteracoesUsuario('${uid}')" style="margin-top: 10px;">💾 Salvar Dados</button>
        </div>

        <div class="popup-section">
            <p><strong>Gerenciar Saldo e VIP:</strong></p>
            <p><strong>Saldo Atual:</strong> R$ ${(u.saldo || 0).toFixed(2)}</p>
            <input id="adminModificarSaldo" type="number" placeholder="Valor a adicionar/remover (-)">
            <button onclick="adminModificarSaldo('${uid}')">Modificar Saldo</button>
            <hr style="border-color: var(--cor-borda); margin: 15px 0;">
            <p><strong>VIP Ativo:</strong> ${isVipAtivo(u) ? 'Sim' : 'Não'}</p>
            <button onclick="adminToggleVip('${uid}')">${isVipAtivo(u) ? 'Remover VIP' : 'Conceder VIP (6 meses)'}</button>
        </div>
        
        <div class="popup-section">
            <p><strong>Ações de Segurança:</strong></p>
            <input id="adminNovaSenha" type="password" placeholder="🔑 Definir Nova Senha para o Usuário">
            <button onclick="adminDefinirNovaSenha('${uid}')">Definir Nova Senha</button>
        </div>

        <div class="popup-section">
            <p><strong>Ações de Conta:</strong></p>
            <button style="background-color: ${userRecord.disabled ? '#2ecc71' : '#f1c40f'};" onclick="adminToggleUserStatus('${uid}', ${!userRecord.disabled})">${userRecord.disabled ? 'Reativar Conta' : 'Desativar Conta'}</button>
            <button style="background-color: #c0392b; margin-top: 10px;" onclick="adminDeletarUsuario('${uid}', '${u.nome}')">DELETAR USUÁRIO</button>
        </div>

        <button data-modal-id="modalAdminGerenciarUsuario" onclick="fecharModal(event)" style="margin-top: 20px;">❌ Fechar</button>
    `;
    
    fecharTodosOsModais(); // Fecha o "Aguarde..."
    
    carregarEstados('adminNovo');
    setTimeout(() => {
        document.getElementById('adminNovoEstado').value = u.estado;
        carregarCidades('adminNovo');
        setTimeout(() => {
            document.getElementById('adminNovoCidade').value = u.cidade;
        }, 200);
    }, 200);
    
    abrirModal('modalAdminGerenciarUsuario');
  } catch (error) {
      fecharTodosOsModais();
      console.error("Erro ao buscar dados do usuário:", error);
      exibirInfoPopup("Não foi possível carregar os dados completos do usuário. " + error.message);
  }
}

async function toggleLojaAdmin(uid, novoEstado) {
    const acao = novoEstado ? "ativar" : "desativar";
    if (!confirm(`Tem certeza que deseja ${acao} a loja para este usuário?`)) {
        return;
    }
    exibirAguarde(`${acao.charAt(0).toUpperCase() + acao.slice(1)}ndo loja...`);
    try {
        // Usa a mesma rota do backend, apenas envia o campo 'lojaLiberada'
        const response = await fetch(`${BACKEND_API_URL}/admin/update-user-firestore`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                adminUid: auth.currentUser.uid,
                targetUid: uid,
                updates: { lojaLiberada: novoEstado } // Envia a atualização específica
            })
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.message);

        fecharTodosOsModais();
        exibirInfoPopup(`Loja ${novoEstado ? 'ativada' : 'desativada'} com sucesso!`);
        // Reabre o modal para mostrar o status atualizado
        abrirModalGerenciarUsuario(uid);
    } catch (error) {
        fecharTodosOsModais();
        exibirInfoPopup(`Erro ao ${acao} a loja: ` + error.message);
    }
}

// ADICIONE ESTAS NOVAS FUNÇÕES NO INDEX.HTML

async function adminSalvarAlteracoesUsuario(uid) {
    const updates = {
        nome: document.getElementById('adminNovoNome').value.trim(),
        telefone: document.getElementById('adminNovoTelefone').value.trim(),
        estado: document.getElementById('adminNovoEstado').value,
        cidade: document.getElementById('adminNovoCidade').value
    };

    if (!updates.nome || !updates.telefone || !updates.estado || !updates.cidade) {
        return exibirInfoPopup("Todos os campos devem ser preenchidos.");
    }

    exibirAguarde("Salvando...");
    try {
        const response = await fetch(`${BACKEND_API_URL}/admin/update-user-firestore`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ adminUid: auth.currentUser.uid, targetUid: uid, updates })
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.message);
        
        fecharTodosOsModais();
        exibirInfoPopup("Dados do usuário atualizados com sucesso!");
        fecharModalAtual(); // Fecha o modal de gerenciamento
    } catch (error) {
        fecharTodosOsModais();
        exibirInfoPopup("Erro ao salvar alterações: " + error.message);
    }
}

async function adminDefinirNovaSenha(uid) {
    const novaSenha = document.getElementById('adminNovaSenha').value;
    if (novaSenha.length < 6) {
        return exibirInfoPopup("A nova senha deve ter no mínimo 6 caracteres.");
    }
    if (!confirm("Tem certeza que deseja definir esta nova senha para o usuário? Ele perderá o acesso com a senha antiga.")) {
        return;
    }
    
    exibirAguarde("Redefinindo senha...");
    try {
        const response = await fetch(`${BACKEND_API_URL}/admin/reset-user-password`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ adminUid: auth.currentUser.uid, targetUid: uid, newPassword: novaSenha })
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.message);
        
        fecharTodosOsModais();
        exibirInfoPopup(`Senha redefinida! A nova senha é "${novaSenha}". É recomendado enviar para o usuário via WhatsApp.`);
    } catch (error) {
        fecharTodosOsModais();
        exibirInfoPopup("Erro ao definir nova senha: " + error.message);
    }
}

async function adminToggleUserStatus(uid, disable) {
    const acao = disable ? "desabilitar" : "reativar";
    if (!confirm(`Tem certeza que deseja ${acao} a conta deste usuário? Ele ${disable ? 'não poderá mais fazer login' : 'poderá voltar a fazer login'}.`)) {
        return;
    }

    exibirAguarde(`${acao.charAt(0).toUpperCase() + acao.slice(1)}ndo conta...`);
    try {
        const response = await fetch(`${BACKEND_API_URL}/admin/toggle-user-status`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ adminUid: auth.currentUser.uid, targetUid: uid, disable })
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.message);
        
        fecharTodosOsModais();
        exibirInfoPopup(`Conta ${disable ? 'desabilitada' : 'reativada'} com sucesso!`);
        fecharModalAtual(); // Fecha o modal para forçar a reabertura com os dados atualizados
    } catch (error) {
        fecharTodosOsModais();
        exibirInfoPopup(`Erro ao ${acao} conta: ` + error.message);
    }
}


// Funções de Ação do Modal Admin
async function adminMudarTipo(uid) {
  const novoTipo = document.getElementById('adminNovoTipo').value;
  await db.collection("usuarios").doc(uid).update({ tipo: novoTipo });
  exibirInfoPopup("Tipo alterado!");
  fecharModalAtual();
}
async function adminModificarSaldo(uid) {
  const valor = parseFloat(document.getElementById('adminModificarSaldo').value);
  if (!isNaN(valor)) {
    await db.collection("usuarios").doc(uid).update({ saldo: firebase.firestore.FieldValue.increment(valor) });
    notifyUser(uid, "💸 Nova Transação!", `Um admin alterou seu saldo em R$ ${valor.toFixed(2)}.`, { link: '#carteira' });
    exibirInfoPopup("Saldo alterado!");
    fecharModalAtual();
  } else exibirInfoPopup("Valor inválido.");
}
async function adminToggleVip(uid) {
  const userDoc = await db.collection("usuarios").doc(uid).get();
  const userData = userDoc.data();
  if (isVipAtivo(userData)) {
      await db.collection("usuarios").doc(uid).update({ vip: false });
      exibirInfoPopup("VIP Removido!");
  } else {
      const expiracao = new Date();
      expiracao.setDate(expiracao.getDate() + 180);
      await db.collection("usuarios").doc(uid).update({ vip: true, vipExpirationDate: firebase.firestore.Timestamp.fromDate(expiracao) });
      exibirInfoPopup("VIP concedido por 6 meses!");
  }
  fecharModalAtual();
}
async function adminDeletarUsuario(uid, nome) {
  if (prompt(`TEM CERTEZA? Para deletar ${nome}, digite "DELETAR":`) === "DELETAR") {
    await db.collection("usuarios").doc(uid).delete();
    exibirInfoPopup("Usuário deletado!");
    fecharModalAtual();
  } else exibirInfoPopup("Exclusão cancelada.");
}


async function enviarNotificacaoMarketing() {
    const title = document.getElementById('marketingTitulo').value.trim();
    const body = document.getElementById('marketingCorpo').value.trim();
    if (!title || !body || !confirm(`Confirma o envio da notificação em massa?`)) return;
    try {
        exibirAguarde("Aguarde...", "Enviando notificações para todos.");
        const response = await fetch("https://navalhabackend.onrender.com/enviar-notificacao-massa", {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title, body, adminUid: auth.currentUser.uid }),
        });
        const data = await response.json();
        fecharTodosOsModais();
        if (!response.ok) throw new Error(data.message);
        exibirInfoPopup(`Notificações enviadas!\nSucessos: ${data.successCount}\nFalhas: ${data.failureCount}`);
        fecharModalAtual();
    } catch (error) {
        fecharTodosOsModais();
        exibirInfoPopup('Falha ao enviar: ' + error.message);
    }
}

const conquistasDefinidas = {
    'cliente': {
        'cortes_1': { nome: 'Primeiro Agendamento', icone: '👶', descricao: 'Concluiu seu primeiro agendamento.', level: 1 },
        'cortes_5': { nome: 'Cliente Iniciante', icone: '👍', descricao: 'Concluiu 5 agendamentos.', level: 2 },
        'cortes_10': { nome: 'Cliente Regular', icone: '⭐', descricao: 'Concluiu 10 agendamentos.', level: 3 },
        'cortes_50': { nome: 'Parceiro da Beleza', icone: '💪', descricao: 'Concluiu 50 agendamentos.', level: 5 },
        'cortes_100': { nome: 'Membro de Honra', icone: '👑', descricao: 'Concluiu 100 agendamentos.', level: 6 }
    },
    'profissional': {
        'cortes_1': { nome: 'Primeiro Cliente', icone: '🎉', descricao: 'Concluiu seu primeiro serviço.', level: 1 },
        'cortes_10': { nome: 'Profissional em Ascensão', icone: '🔥', descricao: 'Concluiu 10 serviços.', level: 3 },
        'cortes_50': { nome: 'Profissional Experiente', icone: '😎', descricao: 'Concluiu 50 serviços.', level: 5 },
        'cortes_100': { nome: 'Mestre da Área', icone: '💎', descricao: 'Concluiu 100 serviços.', level: 6 },
        'cortes_1000': { nome: 'Lenda do Ramo', icone: '🏆', descricao: 'Concluiu 1000 serviços.', level: 7 }
    }
};

async function verificarConquistas(uid) {
    const userRef = db.collection('usuarios').doc(uid);
    const userDoc = await userRef.get();
    if (!userDoc.exists) return;
    const userData = userDoc.data();
    const conquistasAtuais = userData.conquistas || [];
    const cortes = userData.cortesRealizados || 0;
    const definicoes = conquistasDefinidas.cliente;
    const niveis = { 1: 'cortes_1', 5: 'cortes_5', 10: 'cortes_10', 50: 'cortes_50', 100: 'cortes_100' };

    for (const nivel in niveis) {
        const conquistaId = niveis[nivel];
        if (cortes >= nivel && !conquistasAtuais.includes(conquistaId)) {
            await userRef.update({ conquistas: firebase.firestore.FieldValue.arrayUnion(conquistaId) });
            const conquista = definicoes[conquistaId];
            notifyUser(uid, "🏅 Nova Conquista!", `Você desbloqueou: "${conquista.nome}"!`, { link: '#conquistas' });
        }
    }
}

async function verificarConquistasBarbeiro(uid) {
    const userRef = db.collection('usuarios').doc(uid);
    const userDoc = await userRef.get();
    if (!userDoc.exists) return;
    const userData = userDoc.data();
    const conquistasAtuais = userData.conquistas || [];
    const cortes = userData.clientesAtendidos || 0;
    const definicoes = conquistasDefinidas.profissional;
    const niveis = { 1: 'cortes_1', 10: 'cortes_10', 50: 'cortes_50', 100: 'cortes_100', 1000: 'cortes_1000' };
    
    for (const nivel in niveis) {
        const conquistaId = niveis[nivel];
        if (cortes >= nivel && !conquistasAtuais.includes(conquistaId)) {
            await userRef.update({ conquistas: firebase.firestore.FieldValue.arrayUnion(conquistaId) });
            const conquista = definicoes[conquistaId];
            notifyUser(uid, "🏅 Nova Conquista de Profissional!", `Você desbloqueou: "${conquista.nome}"!`, { link: '#conquistas' });
        }
    }
}

function abrirModalConquistas() {
    abrirModal('modalConquistas');
    const container = document.getElementById('listaConquistas');
    container.innerHTML = "";
    const conquistasDoUsuario = perfil.conquistas || [];
    const definicoes = conquistasDefinidas.cliente;
    for (const id in definicoes) {
        const c = definicoes[id];
        const unlocked = conquistasDoUsuario.includes(id);
        container.innerHTML += `<div class="conquista-item ${unlocked ? 'unlocked' : 'locked'}"><div class="conquista-icon">${c.icone}</div><div><b>${c.nome}</b><p style="font-size:12px; margin:0;">${c.descricao}</p></div></div>`;
    }
}

function abrirModalConquistasBarbeiro() {
    abrirModal('modalConquistasBarbeiro');
    const container = document.getElementById('listaConquistasBarbeiro');
    container.innerHTML = "";
    const conquistasDoUsuario = perfil.conquistas || [];
    const definicoes = conquistasDefinidas.profissional;
    for (const id in definicoes) {
        const c = definicoes[id];
        const unlocked = conquistasDoUsuario.includes(id);
        container.innerHTML += `<div class="conquista-item ${unlocked ? 'unlocked' : 'locked'}"><div class="conquista-icon">${c.icone}</div><div><b>${c.nome}</b><p style="font-size:12px; margin:0;">${c.descricao}</p></div></div>`;
    }
}

async function abrirModalRankingUnificado() {
    abrirModal('modalRankingUnificado');
    const container = document.getElementById('listaRankingUnificado');
    container.innerHTML = '<p>Carregando...</p>';
    
    try {
        const [clientesSnap, profissionaisSnap] = await Promise.all([
            db.collection('usuarios').where('tipo', '==', 'cliente').orderBy('cortesRealizados', 'desc').limit(50).get(),
            db.collection('usuarios').where('tipo', 'in', ['barbeiro', 'manicure_pedicure', 'designer_cilios']).orderBy('clientesAtendidos', 'desc').limit(50).get()
        ]);
        
        let ranking = [];
        clientesSnap.forEach(doc => ranking.push({ nome: doc.data().nome, contagem: doc.data().cortesRealizados || 0, tipo: 'cliente' }));
        profissionaisSnap.forEach(doc => ranking.push({ nome: doc.data().nome, contagem: doc.data().clientesAtendidos || 0, tipo: 'profissional' }));

        ranking.sort((a, b) => b.contagem - a.contagem);
        
        container.innerHTML = "";
        ranking.slice(0, 100).forEach((item, i) => {
            const icone = item.tipo === 'cliente' ? '🙋' : '💼';
            container.innerHTML += `<div class="ranking-item"><span>${i + 1}. ${icone} ${item.nome}</span><span>${item.contagem}</span></div>`;
        });

    } catch (e) { 
        container.innerHTML = '<p>Erro ao carregar ranking.</p>'; 
        console.error(e);
    }
}


function obterIconeMaiorConquista(conquistas, tipo) {
    if (!conquistas || conquistas.length === 0) return '';
    const definicoes = tipo === 'cliente' ? conquistasDefinidas.cliente : conquistasDefinidas.profissional;
    let maiorLevel = -1;
    let melhorIcone = '';
    for (const id of conquistas) {
        if (definicoes[id] && definicoes[id].level > maiorLevel) {
            maiorLevel = definicoes[id].level;
            melhorIcone = definicoes[id].icone;
        }
    }
    return maiorLevel > -1 ? `<span class="chat-medal">${melhorIcone}</span>` : '';
}

async function abrirModalDashboardBarbeiro() {
    abrirModal('modalDashboardBarbeiro');
    const container = document.getElementById('dashboardConteudo');
    container.innerHTML = '<p>Calculando...</p>';
    try {
        const agora = new Date();
        const trintaDiasAtras = new Date(new Date().setDate(agora.getDate() - 30));
        
        const snap = await db.collection('agendamentos')
            .where('barbeiroUid', '==', auth.currentUser.uid)
            .get();

        let faturamentoTotal = 0, faturamento30d = 0;
        let concluidosTotal = 0, canceladosTotal = 0;
        const clientes = new Set();
        const servicos = {};
        
        snap.forEach(doc => {
            const ag = doc.data();
            clientes.add(ag.clienteUid);
            
            if(ag.status === 'concluido'){
                concluidosTotal++;
                faturamentoTotal += ag.valor;
                servicos[ag.servico] = (servicos[ag.servico] || 0) + 1;
                if(ag.ts.toDate() > trintaDiasAtras){
                    faturamento30d += ag.valor;
                }
            } else if (ag.status === 'cancelado'){
                canceladosTotal++;
            }
        });
        
        const taxaCancelamento = (concluidosTotal + canceladosTotal) > 0 ? ((canceladosTotal / (concluidosTotal + canceladosTotal)) * 100).toFixed(1) : 0;
        const popular = Object.entries(servicos).sort((a, b) => b[1] - a[1])[0]?.[0] || "N/A";
        const mediaAvaliacoes = perfil.numAvaliacoes > 0 ? (perfil.somaAvaliacoes / perfil.numAvaliacoes).toFixed(1) : "N/A";

        const servicosHtml = Object.entries(servicos).sort((a,b) => b[1] - a[1]).map(([nome, qtde]) => `<p>${nome}: <b>${qtde}</b></p>`).join('');

        container.innerHTML = `
            <div class="popup-section"><h4>Visão Geral</h4>
                <p>⭐ Avaliação Média: <b>${mediaAvaliacoes} / 10</b> (${perfil.numAvaliacoes} avaliações)</p>
                <p>🧑‍🤝‍🧑 Clientes Únicos: <b>${clientes.size}</b></p>
                <p>📈 Serviços Concluídos: <b>${concluidosTotal}</b></p>
                <p>❌ Taxa de Cancelamento: <b>${taxaCancelamento}%</b></p>
            </div>
            <div class="popup-section"><h4>💰 Financeiro</h4>
                <p>Faturamento Total: <b>R$ ${faturamentoTotal.toFixed(2)}</b></p>
                <p>Faturamento (Últimos 30 dias): <b>R$ ${faturamento30d.toFixed(2)}</b></p>
            </div>
            <div class="popup-section"><h4>✂️ Serviços</h4>
                <p>Serviço Mais Popular: <b>${popular}</b></p>
                ${servicosHtml}
            </div>
        `;
    } catch (e) { 
        container.innerHTML = '<p>Erro ao carregar dados.</p>'; 
        console.error("Erro no dashboard do profissional:", e);
    }
}

// Funções de Portfólio
function abrirModalPortfolioBarbeiro() {
    abrirModal('modalPortfolioBarbeiro');
    const container = document.getElementById('portfolioInputsContainer');
    const pInfo = document.querySelector('#modalPortfolioBarbeiro .modal-content p');

    // Atualiza texto de ajuda
    pInfo.innerHTML = `Faça upload de até 30 imagens (JPG, PNG, GIF) para seu portfólio. As imagens existentes serão mantidas se você não enviar novas.`;

    // Limpa o container e adiciona input de ARQUIVO MÚLTIPLO e área de preview
    container.innerHTML = `
        <label for="portfolioFiles" style="display:block; margin-bottom: 10px; cursor:pointer; background: var(--cor-botoes); padding: 10px; border-radius: 5px; text-align: center;">
            ➕ Selecionar Imagens (até 30)
        </label>
        <input type="file" id="portfolioFiles" accept="image/*,image/gif" multiple onchange="previewPortfolioImages(this)" style="display: none;">
        <div id="portfolioPreviews" class="portfolio-grid" style="grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); max-height: 250px; overflow-y: auto; border: 1px dashed var(--cor-borda); min-height: 50px; padding: 5px;">
            </div>
        <progress id="portfolioProgress" value="0" max="100" style="width: 100%; display: none; margin-top: 10px;"></progress>
    `;
    // Garante que o botão Salvar chame a função correta
     const saveButton = document.querySelector('#modalPortfolioBarbeiro button[onclick="salvarPortfolio()"]');
     if(saveButton) saveButton.onclick = salvarPortfolio; // Reatribui para garantir
}

// NOVA FUNÇÃO para salvar múltiplas imagens do portfólio via upload
async function salvarPortfolio() {
    const fileInput = document.getElementById('portfolioFiles');
    const files = fileInput.files;
    if (!auth.currentUser) return;

    // Se nenhum arquivo novo foi selecionado, não faz nada (mantém o existente)
    if (!files || files.length === 0) {
        exibirInfoPopup("Nenhuma nova imagem selecionada. O portfólio existente foi mantido.");
        fecharModalAtual();
        return;
    }

    // Limita a 30 arquivos
    const filesToUpload = Array.from(files).slice(0, 30);
    if (files.length > 30) {
        exibirInfoPopup("Limite excedido. Apenas as primeiras 30 imagens serão enviadas.");
    }

    const progressBar = document.getElementById('portfolioProgress');
    const saveButton = document.querySelector('#modalPortfolioBarbeiro button[onclick="salvarPortfolio()"]'); // Seleciona o botão correto
    exibirAguarde("Enviando imagens do portfólio...");
    progressBar.style.display = 'block';
    progressBar.value = 0;
    saveButton.disabled = true;

    const uploadPromises = [];
    const newDownloadURLs = []; // Armazena as URLs das novas imagens
    let uploadedCount = 0;

    for (const file of filesToUpload) {
        const storageRef = storage.ref(`portfolio/${auth.currentUser.uid}/${Date.now()}_${file.name}`);
        const uploadTask = storageRef.put(file);

        const promise = new Promise((resolve, reject) => {
            uploadTask.on('state_changed',
                (snapshot) => {
                    // Calcula o progresso geral baseado em todos os arquivos
                    const progress = ((uploadedCount + (snapshot.bytesTransferred / snapshot.totalBytes)) / filesToUpload.length) * 100;
                    progressBar.value = progress;
                },
                (error) => reject(error),
                async () => {
                    try {
                        const url = await uploadTask.snapshot.ref.getDownloadURL();
                        newDownloadURLs.push(url); // Salva a URL obtida
                        uploadedCount++;
                        // Atualiza o progresso após completar um upload
                        progressBar.value = (uploadedCount / filesToUpload.length) * 100;
                        resolve();
                    } catch (getUrlError) {
                        reject(getUrlError); // Rejeita se não conseguir a URL
                    }
                }
            );
        });
        uploadPromises.push(promise);
    }

    try {
        await Promise.all(uploadPromises); // Espera todos os uploads

        // Pega portfólio existente
        const userDoc = await db.collection('usuarios').doc(auth.currentUser.uid).get();
        const portfolioAtual = userDoc.data()?.portfolio || [];

        // Combina o atual com as novas URLs e garante que são strings válidas
        const portfolioCombinado = [...portfolioAtual, ...newDownloadURLs]
                                     .filter(url => typeof url === 'string' && url.startsWith('http'));

        // Mantém apenas os últimos 30 itens únicos (os mais recentes ficam no final)
        const portfolioFinal = [...new Set(portfolioCombinado)].slice(-30);

        // Atualiza o portfólio no Firestore
        await db.collection('usuarios').doc(auth.currentUser.uid).update({ portfolio: portfolioFinal });

        progressBar.style.display = 'none';
        saveButton.disabled = false;
        fecharTodosOsModais();
        exibirInfoPopup('Portfólio salvo com sucesso!');
        fecharModalAtual();
        // Limpa o input de arquivo para a próxima vez
        fileInput.value = '';
        document.getElementById('portfolioPreviews').innerHTML = '';

    } catch (error) {
        fecharTodosOsModais();
        console.error("Erro no upload do portfólio:", error);
        exibirInfoPopup("Falha no upload de uma ou mais imagens: " + (error.code || error.message));
        progressBar.style.display = 'none';
        saveButton.disabled = false;
    }
}

async function uploadPortfolio() {
    const fileInput = document.getElementById('portfolioFiles');
    const files = fileInput.files;
    if (!files || files.length === 0) return exibirInfoPopup("Selecione pelo menos uma imagem ou GIF.");
    if (files.length > 30) return exibirInfoPopup("Você pode selecionar no máximo 30 imagens.");
    if (!auth.currentUser) return;

    const progressBar = document.getElementById('portfolioProgress');
    const saveButton = document.querySelector('#modalPortfolioBarbeiro button[onclick="uploadPortfolio()"]');
    exibirAguarde("Enviando imagens do portfólio...");
    progressBar.style.display = 'block';
    progressBar.value = 0;
    saveButton.disabled = true;

    const uploadPromises = [];
    const downloadURLs = [];
    let uploadedCount = 0;

    for (const file of files) {
        const storageRef = storage.ref(`portfolio/${auth.currentUser.uid}/${Date.now()}_${file.name}`);
        const uploadTask = storageRef.put(file);

        const promise = new Promise((resolve, reject) => {
            uploadTask.on('state_changed',
                (snapshot) => {
                    const progress = ((uploadedCount + (snapshot.bytesTransferred / snapshot.totalBytes)) / files.length) * 100;
                    progressBar.value = progress;
                },
                (error) => reject(error),
                async () => {
                    try {
                        const url = await uploadTask.snapshot.ref.getDownloadURL();
                        downloadURLs.push(url); // Salva a URL obtida
                        uploadedCount++;
                        progressBar.value = (uploadedCount / files.length) * 100; // Atualiza progresso após completar
                        resolve();
                    } catch (getUrlError) {
                        reject(getUrlError); // Rejeita se não conseguir a URL
                    }
                }
            );
        });
        uploadPromises.push(promise);
    }

    try {
        await Promise.all(uploadPromises); // Espera todos os uploads

        // Pega portfólio existente e adiciona novas URLs, mantendo no máximo 30
        const userDoc = await db.collection('usuarios').doc(auth.currentUser.uid).get();
        const portfolioAtual = userDoc.data()?.portfolio || [];

        // Combina e garante que são apenas strings de URL válidas
        const portfolioCombinado = [...portfolioAtual, ...downloadURLs]
                                     .filter(url => typeof url === 'string' && url.startsWith('http'));

        // Mantém apenas os últimos 30 itens únicos
        const portfolioFinal = [...new Set(portfolioCombinado)].slice(-30);

        await db.collection('usuarios').doc(auth.currentUser.uid).update({ portfolio: portfolioFinal });

        progressBar.style.display = 'none';
        saveButton.disabled = false;
        fecharTodosOsModais();
        exibirInfoPopup('Portfólio salvo com sucesso!');
        fecharModalAtual();
    } catch (error) {
        fecharTodosOsModais();
        console.error("Erro no upload do portfólio:", error);
        exibirInfoPopup("Falha no upload de uma ou mais imagens: " + error.code);
        progressBar.style.display = 'none';
        saveButton.disabled = false;
    }
}

// NOVA FUNÇÃO para preview de múltiplas imagens do portfólio
function previewPortfolioImages(input) {
    const previewsContainer = document.getElementById('portfolioPreviews');
    previewsContainer.innerHTML = ''; // Limpa previews antigos
    if (input.files) {
        const files = Array.from(input.files).slice(0, 30); // Limita a 30 previews
        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.alt = "Preview";
                img.style.cssText = "width: 80px; height: 80px; object-fit: cover; border-radius: 5px;";
                previewsContainer.appendChild(img);
            }
            reader.readAsDataURL(file);
        });
    }
}


function abrirModalFidelidade() {
  const pontosDisplay = document.getElementById("pontosFidelidade");
  if (perfil && pontosDisplay) {
    pontosDisplay.textContent = perfil.pontosFidelidade || 0;
  }
  abrirModal('modalFidelidade');
}

async function abrirPortfolioCliente(barbeiroUid, barbeiroNome) {
    const doc = await db.collection('usuarios').doc(barbeiroUid).get();
    if (!doc.exists) return;
    const portfolio = doc.data().portfolio || [];
    
    const grid = document.getElementById('portfolioClienteGrid');
    grid.innerHTML = '';
    document.getElementById('portfolioClienteNome').textContent = `🖼️ Portfólio de ${barbeiroNome}`;
    
    if (portfolio.length > 0) {
        portfolio.forEach(url => {
            grid.innerHTML += `<img src="${url}" alt="Foto do portfólio" onerror="this.src='https://via.placeholder.com/150?text=Erro'">`;
        });
    } else {
        grid.innerHTML = '<p>Este profissional ainda não adicionou imagens ao portfólio.</p>';
    }
    
    abrirModal('modalPortfolioCliente');
}

function calcularDistancia(lat1, lon1, lat2, lon2) {
    const R = 6371; // Raio da Terra em km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c; // Distância em km
}

function obterLocalizacaoAtual() {
    return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
            return reject(new Error("Geolocalização não suportada."));
        }
        navigator.geolocation.getCurrentPosition(
            (position) => {
                localizacaoCliente = {
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude,
                };
                resolve(localizacaoCliente);
            },
            (error) => {
                console.warn("Não foi possível obter a localização: ", error.message);
                reject(error);
            }
        );
    });
}

function obterLocalizacaoCadastro() {
    const btn = document.getElementById('btnLocalizacaoCadastro');
    if(btn) btn.textContent = '⏳ Obtendo localização...';
    if (!navigator.geolocation) {
        exibirInfoPopup("Geolocalização não é suportada pelo seu navegador.");
        if(btn) btn.textContent = '📍 Usar minha localização atual';
        return;
    }
    navigator.geolocation.getCurrentPosition(
        (position) => {
            cadastroCoords = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
            };
            
            if(btn) btn.textContent = '✅ Localização Obtida!';
        },
        (error) => {
            exibirInfoPopup("Não foi possível obter a localização. Por favor, verifique as permissões no seu navegador.");
            if(btn) btn.textContent = '📍 Usar minha localização atual';
        }
    );
}

function abrirRota(barbeiroLat, barbeiroLon) {
    if (localizacaoCliente) {
        window.open(`https://www.google.com/maps/dir/?api=1&origin=${localizacaoCliente.latitude},${localizacaoCliente.longitude}&destination=${barbeiroLat},${barbeiroLon}`, '_blank');
    } else {
        window.open(`https://www.google.com/maps/search/?api=1&query=${barbeiroLat},${barbeiroLon}`, '_blank');
    }
}

function abrirModalTurbinar(){
    abrirModal('modalTurbinar');
}


// Funções da Loja
function abrirModalParaVender() {
    if (perfil.lojaLiberada || perfil.tipo === 'admin') {
        abrirFormularioProduto();
    } else {
        abrirModal('modalLiberarLoja');
    }
}

function solicitarLiberacaoLoja() {
    const mensagem = encodeURIComponent(`Olá, gostaria de solicitar autorização para cadastrar produtos na loja. Meu nome de usuário é ${perfil.nome}.`);
    window.open(`https://wa.me/${WHATSAPP_ADM_PHONE}?text=${mensagem}`, '_blank');
    db.collection("solicitacoes").add({
        tipo: "liberacao_loja",
        usuarioUid: auth.currentUser.uid,
        usuarioNome: perfil.nome,
        status: "pendente",
        ts: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
        exibirInfoPopup("Sua solicitação foi enviada ao administrador. Você será redirecionado para o WhatsApp para confirmar.");
        notifyAdmins("🛍️ Liberação de Loja", `${perfil.nome} quer permissão para vender.`, { link: '#solicitacoes' });
    }).catch(e => exibirInfoPopup("Erro ao criar solicitação: " + e.message));
}

function aprovarLiberacaoLoja(solicitacaoId, uid) {
    db.runTransaction(async t => {
        t.update(db.collection("usuarios").doc(uid), { lojaLiberada: true });
        t.update(db.collection("solicitacoes").doc(solicitacaoId), { status: "aprovado" });
    }).then(() => {
        exibirInfoPopup("Acesso à loja liberado!");
        notifyUser(uid, "🛍️ Acesso à Loja Liberado!", "Parabéns! Você já pode cadastrar seus produtos para vender no app.");
    }).catch(e => exibirInfoPopup("Erro ao aprovar: " + e.message));
}

async function carregarProdutos() {
    const container = document.getElementById('lojaContainer');
    container.innerHTML = '<p>Carregando loja...</p>';

    try {
        const usersSnap = await db.collection('usuarios').get();
        const usersData = {};
        usersSnap.forEach(doc => {
            usersData[doc.id] = doc.data();
        });

        const produtosSnap = await db.collection('loja_produtos').orderBy('ts', 'desc').get();
        
        let officialHtml = '<h4 style="grid-column: 1 / -1;">⭐ Oficiais Nova Versão ⭐</h4>';
        let communityProducts = [];
        let officialProductsFound = false;

        produtosSnap.forEach(doc => {
            const produto = { ...doc.data(), id: doc.id };
            const produtoJSON = JSON.stringify(produto).replace(/'/g, "\\'");
            if (produto.isOficial) {
                officialHtml += renderProdutoCard(produto, produtoJSON);
                officialProductsFound = true;
            } else {
                communityProducts.push({ data: produto, json: produtoJSON });
            }
        });

        if (!officialProductsFound) {
            officialHtml += '<p style="grid-column: 1 / -1; font-size: 14px; opacity: 0.7;">Nenhum produto oficial no momento.</p>';
        }

        const getUserScore = (uid) => {
            const user = usersData[uid];
            if (!user) return 0;
            if (isVipAtivo(user)) return 4;
            const isBoosted = user.boostExpiracao && user.boostExpiracao.toDate() > new Date();
            if (isBoosted) return 3;
            if (user.tipo !== 'cliente') return 2;
            return 1;
        };

        communityProducts.sort((a, b) => {
            const scoreA = getUserScore(a.data.vendedorUid);
            const scoreB = getUserScore(b.data.vendedorUid);
            return scoreB - scoreA;
        });

        let communityHtml = '<h4 style="grid-column: 1 / -1; margin-top: 20px;">🛒 Marketplace da Comunidade</h4>';
        if (communityProducts.length === 0) {
            communityHtml += '<p style="grid-column: 1 / -1;">Nenhum produto da comunidade ainda.</p>';
        } else {
            communityProducts.forEach(p => {
                communityHtml += renderProdutoCard(p.data, p.json);
            });
        }
        
        container.innerHTML = officialHtml + communityHtml;

    } catch (error) {
        console.error("Erro ao carregar produtos:", error);
        container.innerHTML = '<p>Ocorreu um erro ao carregar a loja.</p>';
    }
}


function renderProdutoCard(p, pJson) {
    const precoFinal = p.desconto ? p.preco * (1 - p.desconto / 100) : p.preco;
    const precoHtml = p.desconto ? `<span class="produto-preco-original">R$ ${p.preco.toFixed(2)}</span> R$ ${precoFinal.toFixed(2)}` : `R$ ${p.preco.toFixed(2)}`;
    
    return `
        <div class="produto-card" onclick='handleProdutoClick(${pJson})'>
            <img src="${p.imagemUrl}" alt="${p.nome}" onerror="this.src='https://via.placeholder.com/150?text=VersaoPro'">
            <div class="produto-info">
                <div class="produto-nome">${p.nome}</div>
                <div class="produto-preco">${precoHtml}</div>
            </div>
        </div>
    `;
}

async function exibirVersaoApp() {
    try {
        const response = await fetch('/index.html', { method: 'HEAD', cache: 'no-store' });
        const lastModified = response.headers.get('Last-Modified');
        if (lastModified) {
            const d = new Date(lastModified);
            const version = `V${d.getFullYear().toString().slice(-2)}.${(d.getMonth() + 1).toString().padStart(2, '0')}.${d.getDate().toString().padStart(2, '0')}.${d.getHours().toString().padStart(2, '0')}${d.getMinutes().toString().padStart(2, '0')}`;
            document.getElementById('appVersion').textContent = version;
        }
    } catch(e) {
        console.error("Erro ao obter nova versão do app:", e);
        document.getElementById('appVersion').textContent = 'V.Local';
    }
}

function recarregarSaldoDoUsuario() {
    exibirInfoPopup("💰 Seu saldo foi atualizado! A interface irá refletir a mudança em instantes.");
}

if (firebase.messaging.isSupported()) {
    messaging.onMessage((payload) => {
        console.log('Mensagem de primeiro plano recebida:', payload);

        if (payload.data && payload.data.tipo === 'atualizar_saldo') {
            recarregarSaldoDoUsuario();
        }

        if (payload.notification) {
            const notificationTitle = payload.notification.title;
            const notificationOptions = {
                body: payload.notification.body,
                icon: payload.notification.icon || '/icone.png'
            };
            if (Notification.permission === 'granted') {
                new Notification(notificationTitle, notificationOptions);
            }
        }
    });
}
// NOVAS FUNÇÕES DA LOJA E GERENCIAMENTO
async function abrirDetalhesProduto(produto) {
    produtoParaCompra = produto;
    const imgContainer = document.getElementById('detalhesProdutoImgContainer');
imgContainer.innerHTML = ''; // Limpa imagens antigas do slider
const urls = produto.imagensUrls || []; // Usa o array de URLs

if (urls && urls.length > 0) {
    // Cria um slider simples (pode ser aprimorado com bibliotecas como Swiper.js)
    let sliderHtml = '<div class="product-slider">';
    urls.forEach((url, index) => {
        sliderHtml += `<img src="${url}" alt="Imagem ${index + 1} do Produto" style="display: ${index === 0 ? 'block' : 'none'}; width: 100%; height: 250px; object-fit: contain; border-radius: 10px; margin-bottom: 15px;">`;
    });
    sliderHtml += '</div>';
    if (urls.length > 1) {
        sliderHtml += `<div style="text-align: center; margin-bottom: 10px;">
                         <button onclick="changeProductSlide(-1)">◀</button>
                         <span id="slideIndicator">1 / ${urls.length}</span>
                         <button onclick="changeProductSlide(1)">▶</button>
                       </div>`;
    }
    imgContainer.innerHTML = sliderHtml;
    currentProductSlide = 0; // Reseta o slide atual
} else {
    // Se não houver URLs no array, tenta usar a antiga 'imagemUrl' como fallback
    if(produto.imagemUrl) {
         imgContainer.innerHTML = `<img id="detalhesProdutoImg" src="${produto.imagemUrl}" alt="Imagem do Produto" style="display: block; width: 100%; height: 250px; object-fit: contain; border-radius: 10px; margin-bottom: 15px;">`;
    } else {
         imgContainer.innerHTML = '<p>Nenhuma imagem disponível.</p>'; // Nenhuma imagem
    }
    document.getElementById('detalhesProdutoNome').textContent = produto.nome;
    const precoFinal = produto.desconto ? produto.preco * (1 - produto.desconto / 100) : produto.preco;
    document.getElementById('detalhesProdutoPreco').textContent = `R$ ${precoFinal.toFixed(2)}`;
    document.getElementById('detalhesProdutoDescricao').textContent = produto.descricao;
    
    const tamanhosContainer = document.getElementById('detalhesProdutoTamanhos');
    tamanhosContainer.innerHTML = '';
    if (produto.tamanhos && produto.tamanhos.length > 0) {
        produto.tamanhos.forEach((t, index) => {
            tamanhosContainer.innerHTML += `<input type="radio" name="tamanho_selecionado" value="${t}" id="tamanho_${t}" ${index === 0 ? 'checked' : ''}><label for="tamanho_${t}">${t}</label>`;
        });
    } else {
        tamanhosContainer.innerHTML = 'Tamanho único';
    }
    
    const avaliacaoContainer = document.getElementById('detalhesProdutoAvaliacao');
    await carregarAvaliacaoProduto(produto.id, produto.nome, avaliacaoContainer);
    
    document.getElementById('btnComprarAgora').onclick = () => iniciarCompra(produto);
    abrirModal('modalProdutoDetalhes');
}

let currentProductSlide = 0;

function changeProductSlide(direction) {
    const slider = document.querySelector('#detalhesProdutoImgContainer .product-slider');
    if (!slider) return;
    const images = slider.querySelectorAll('img');
    if (images.length <= 1) return;

    images[currentProductSlide].style.display = 'none'; // Esconde a atual
    currentProductSlide = (currentProductSlide + direction + images.length) % images.length; // Calcula o novo índice
    images[currentProductSlide].style.display = 'block'; // Mostra a nova

    document.getElementById('slideIndicator').textContent = `${currentProductSlide + 1} / ${images.length}`;
}

function iniciarCompra(produto) {
    const tamanhoSelecionado = document.querySelector('input[name="tamanho_selecionado"]:checked');
    if ((produto.tamanhos && produto.tamanhos.length > 0) && !tamanhoSelecionado) {
        return exibirInfoPopup('Por favor, selecione um tamanho.');
    }
    produtoParaCompra.tamanhoSelecionado = tamanhoSelecionado ? tamanhoSelecionado.value : 'único';
    
    abrirModal('modalFormularioCompraLoja');
    document.getElementById('btnPagarCompraLoja').onclick = () => {
        const nome = document.getElementById('compraNomeCompleto').value;
        const cpf = document.getElementById('compraCpf').value;
        const telefone = document.getElementById('compraTelefone').value;
        const email = document.getElementById('compraEmail').value;
        const cep = document.getElementById('compraCep').value;
        const rua = document.getElementById('compraRua').value;
        const numero = document.getElementById('compraNumeroCasa').value;
        if (!nome || !cpf || !telefone || !email || !cep || !rua || !numero) {
            return exibirInfoPopup('Todos os campos são obrigatórios.');
        }
        
        const precoFinal = produtoParaCompra.desconto ? produtoParaCompra.preco * (1 - produtoParaCompra.desconto / 100) : produtoParaCompra.preco;
        document.getElementById('valorDebito').textContent = precoFinal.toFixed(2);
        
        const overlay = document.getElementById('overlayPagamento');
        overlay.classList.remove('hidden');
        document.getElementById('btnNaoDebitar').onclick = () => overlay.classList.add('hidden');
        document.getElementById('btnSimDebitar').onclick = () => confirmarCompraLoja({ nome, cpf, telefone, email, cep, rua, numero });
    };
}

async function confirmarCompraLoja(dadosEntrega) {
    exibirAguarde("Processando seu pedido...");
    const produto = produtoParaCompra;
    const precoFinal = produto.desconto ? produto.preco * (1 - produto.desconto / 100) : produto.preco;
    if (perfil.saldo < precoFinal) {
        fecharTodosOsModais();
        return exibirInfoPopup('Saldo insuficiente.');
    }
    
    try {
        await db.runTransaction(async t => {
            const clienteRef = db.collection("usuarios").doc(auth.currentUser.uid);
            const vendedorRef = db.collection("usuarios").doc(produto.vendedorUid);
            const adminSnap = await db.collection("usuarios").where("tipo", "==", "admin").limit(1).get();
            const adminRef = db.collection("usuarios").doc(adminSnap.docs[0].id);
            const produtoRef = db.collection("loja_produtos").doc(produto.id);

            const valorVendedor = precoFinal * (1 - TAXA);
            const valorAdmin = precoFinal * TAXA;

            t.update(clienteRef, { saldo: firebase.firestore.FieldValue.increment(-precoFinal) });
            t.update(vendedorRef, { saldo: firebase.firestore.FieldValue.increment(valorVendedor) });
            t.update(adminRef, { saldo: firebase.firestore.FieldValue.increment(valorAdmin) });
            t.update(produtoRef, { vendasRealizadas: firebase.firestore.FieldValue.increment(1) });
            
            t.set(db.collection("loja_pedidos").doc(), {
                produtoId: produto.id,
                produtoNome: produto.nome,
                valor: precoFinal,
                tamanho: produto.tamanhoSelecionado,
                clienteUid: auth.currentUser.uid,
                clienteNome: perfil.nome,
                endereco: `${dadosEntrega.rua}, ${dadosEntrega.numero}`,
                cpf: dadosEntrega.cpf,
                telefone: dadosEntrega.telefone,
                email: dadosEntrega.email,
                cep: dadosEntrega.cep,
                vendedorUid: produto.vendedorUid,
                vendedorNotificado: false,
                status: "pendente",
                avaliado: false,
                ts: firebase.firestore.FieldValue.serverTimestamp()
            });
        });

        fecharTodosOsModais();
        exibirInfoPopup("Pedido realizado com sucesso!");
        notifyUser(auth.currentUser.uid, '📦 Pedido Confirmado!', `Sua compra de "${produto.nome}" foi realizada.`, { link: '#minhascompras' });
        notifyUser(produto.vendedorUid, '🎉 Nova Venda!', `Você vendeu um(a) "${produto.nome}" para ${perfil.nome}.`, { link: '#entregas' });
        fecharTodosOsModais();
    } catch (e) {
        fecharTodosOsModais();
        exibirInfoPopup('Erro ao processar a compra: ' + e.message);
    }
}


async function abrirGerenciarLoja() {
    abrirModal('modalGerenciarLoja');
    const container = document.getElementById('listaMeusProdutos');
    container.innerHTML = '<p>Carregando seus produtos...</p>';
    
    const snap = await db.collection('loja_produtos').where('vendedorUid', '==', auth.currentUser.uid).get();
    if (snap.empty) {
        container.innerHTML = '<p>Você ainda não tem produtos cadastrados.</p>';
        return;
    }
    
    container.innerHTML = '';
    snap.forEach(doc => {
        const p = doc.data();
        container.innerHTML += `
            <div class="card">
                <b>${p.nome}</b> - R$ ${p.preco.toFixed(2)}
                <p>Vendas: ${p.vendasRealizadas || 0}</p>
                <div style="display: flex; gap: 5px; margin-top: 5px;">
                    <button onclick="abrirFormularioProduto('${doc.id}')" style="font-size:12px; padding: 5px 8px;">✏️ Editar</button>
                    <button onclick="deletarProdutoVendedor('${doc.id}')" style="background: #c0392b; font-size:12px; padding: 5px 8px;">🗑️ Excluir</button>
                </div>
            </div>`;
    });
}

async function abrirFormularioProduto(produtoId = null) {
    produtoEmEdicaoId = produtoId;
    const form = document.getElementById('modalAddEditProduto');
    document.getElementById('formProdutoTitulo').textContent = produtoId ? '✏️ Editar Produto' : '📦 Adicionar Novo Produto';
    
    // Reset form
    form.querySelector('#produtoNome').value = '';
    form.querySelector('#produtoImagemUrl').value = '';
    form.querySelector('#produtoPreco').value = '';
    form.querySelector('#produtoDesconto').value = '';
    form.querySelector('#produtoEntrega').value = '';
    form.querySelector('#produtoDescricao').value = '';
    form.querySelectorAll('input[name="tamanhos"]').forEach(c => c.checked = false);

    if (produtoId) {
        const doc = await db.collection('loja_produtos').doc(produtoId).get();
        const p = doc.data();
        form.querySelector('#produtoNome').value = p.nome;
        form.querySelector('#produtoImagemUrl').value = p.imagemUrl;
        form.querySelector('#produtoPreco').value = p.preco;
        form.querySelector('#produtoDesconto').value = p.desconto || '';
        form.querySelector('#produtoEntrega').value = p.tempoEntrega || '';
        form.querySelector('#produtoDescricao').value = p.descricao || '';
        if (p.tamanhos) {
            p.tamanhos.forEach(t => {
                const checkbox = form.querySelector(`input[value="${t}"]`);
                if(checkbox) checkbox.checked = true;
            });
        }
    }
    abrirModal('modalAddEditProduto');
}

async function salvarProdutoVendedor() {
    const nome = document.getElementById('produtoNome').value.trim();
    const preco = parseFloat(document.getElementById('produtoPreco').value);
    const desconto = parseInt(document.getElementById('produtoDesconto').value) || 0;
    const tempoEntrega = document.getElementById('produtoEntrega').value.trim();
    const descricao = document.getElementById('produtoDescricao').value.trim();
    const tamanhos = Array.from(document.querySelectorAll('#modalAddEditProduto input[name="tamanhos"]:checked')).map(c => c.value);

    const fileInput = document.getElementById('produtoImagensFile');
    const files = fileInput.files;

    // Validações básicas
    if (!nome || isNaN(preco) || preco <= 0 || !tempoEntrega) {
        return exibirInfoPopup('Preencha nome, preço válido e tempo de entrega.');
    }

    // Validação de imagens: Obrigatório ao adicionar, opcional ao editar
    if (!produtoEmEdicaoId && (!files || files.length === 0)) {
        return exibirInfoPopup("Selecione pelo menos uma imagem para adicionar o produto.");
    }
    if (files && files.length > 5) {
        return exibirInfoPopup("Você pode enviar no máximo 5 imagens.");
    }

    exibirAguarde("Salvando produto...");
    const progressBar = document.getElementById('produtoImagensProgress');
    const saveButton = document.getElementById('btnSalvarProduto');
    saveButton.disabled = true;

    let imagemUrls = []; // Array para guardar as URLs

    try {
        // Upload de novas imagens, se houver
        if (files && files.length > 0) {
            progressBar.style.display = 'block';
            progressBar.value = 0;
            const uploadPromises = [];
            let uploadedCount = 0;

            for (const file of files) {
                const storageRef = storage.ref(`loja_produtos/${auth.currentUser.uid}/${Date.now()}_${file.name}`);
                const uploadTask = storageRef.put(file);
                const promise = new Promise((resolve, reject) => {
                    uploadTask.on('state_changed',
                        (snapshot) => {
                            const progress = ((uploadedCount + (snapshot.bytesTransferred / snapshot.totalBytes)) / files.length) * 100;
                            progressBar.value = progress;
                        },
                        (error) => reject(error),
                        async () => {
                            try {
                                const url = await uploadTask.snapshot.ref.getDownloadURL();
                                imagemUrls.push(url); // Adiciona a URL ao array
                                uploadedCount++;
                                progressBar.value = (uploadedCount / files.length) * 100;
                                resolve();
                            } catch (getUrlError) { reject(getUrlError); }
                        }
                    );
                });
                uploadPromises.push(promise);
            }
            await Promise.all(uploadPromises); // Espera todos os uploads
            progressBar.style.display = 'none';
        }

        // Busca URLs antigas se for edição e não houve novo upload
        if (produtoEmEdicaoId && imagemUrls.length === 0) {
             const docAtual = await db.collection('loja_produtos').doc(produtoEmEdicaoId).get();
             if (docAtual.exists) {
                 imagemUrls = docAtual.data().imagensUrls || []; // Pega as URLs existentes
             }
        }

        // Prepara os dados para salvar no Firestore
        const data = {
            nome, preco, desconto, tempoEntrega, descricao, tamanhos,
            imagensUrls: imagemUrls, // Salva o array de URLs
            vendedorUid: auth.currentUser.uid,
            vendedorNome: perfil.nome,
            isOficial: perfil.tipo === 'admin',
            ts: firebase.firestore.FieldValue.serverTimestamp()
        };

        // Salva ou atualiza
        if (produtoEmEdicaoId) {
            await db.collection('loja_produtos').doc(produtoEmEdicaoId).update(data);
        } else {
            data.vendasRealizadas = 0; // Inicializa vendas ao criar
            await db.collection('loja_produtos').add(data);
        }

        saveButton.disabled = false;
        fecharTodosOsModais(); // Fecha o aguarde
        exibirInfoPopup('Produto salvo com sucesso!');
        produtoEmEdicaoId = null; // Limpa o ID de edição
        fecharModalAtual(); // Fecha o modal do formulário
        abrirGerenciarLoja(); // Recarrega a lista no modal de gerenciamento

    } catch (error) {
        fecharTodosOsModais(); // Fecha o aguarde
        console.error("Erro ao salvar produto:", error);
        exibirInfoPopup("Falha ao salvar produto: " + error.code || error.message);
        progressBar.style.display = 'none';
        saveButton.disabled = false;
    }
}

function previewProductImages(input) {
    const previewsContainer = document.getElementById('produtoImagensPreviews');
    previewsContainer.innerHTML = ''; // Limpa previews antigos
    if (input.files) {
        const files = Array.from(input.files).slice(0, 5); // Limita a 5 previews
        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                previewsContainer.innerHTML += `<img src="${e.target.result}" alt="Preview" style="width: 80px; height: 80px; object-fit: cover; border-radius: 5px;">`;
            }
            reader.readAsDataURL(file);
        });
    }
}

async function deletarProdutoVendedor(produtoId) {
    if (confirm('Tem certeza que deseja excluir este produto?')) {
        await db.collection('loja_produtos').doc(produtoId).delete();
        exibirInfoPopup('Produto excluído.');
        abrirGerenciarLoja();
    }
}

async function abrirEntregasVendedor() {
    abrirModal('modalEntregasVendedor');
    const container = document.getElementById('listaEntregas');
    container.innerHTML = '<p>Carregando entregas...</p>';
    
    if (pedidosVendedorListener) pedidosVendedorListener();
    pedidosVendedorListener = db.collection('loja_pedidos')
      .where('vendedorUid', '==', auth.currentUser.uid)
      .where('status', 'in', ['pendente', 'disputa'])
      .onSnapshot(snap => {
        if(snap.empty) {
            container.innerHTML = '<p>Nenhuma entrega pendente.</p>';
            return;
        }
        container.innerHTML = '';
        snap.forEach(doc => {
            const pedido = doc.data();
            let statusHtml = '';
            let acaoHtml = `<button onclick="marcarComoEntregue('${doc.id}', '${pedido.clienteUid}')">Marcar como Entregue</button>`;
            
            if (pedido.status === 'pendente') {
                statusHtml = '<p style="color: #f1c40f;">Status: Aguardando Entrega</p>';
            } else if (pedido.status === 'disputa') {
                statusHtml = '<p style="color: #e74c3c;">Status: Cliente Negou Recebimento. Tente Novamente.</p>';
            }

            container.innerHTML += `
                <div class="card">
                    <b>Comprador: ${pedido.clienteNome}</b>
                    <p>Produto: ${pedido.produtoNome} (T: ${pedido.tamanho})</p>
                    <p>Endereço: ${pedido.endereco} - CEP: ${pedido.cep}</p>
                    <p>WhatsApp: <a href="https://wa.me/55${pedido.telefone}" target="_blank">${pedido.telefone}</a></p>
                    ${statusHtml}
                    ${acaoHtml}
                </div>`;
        });
    });
}

async function marcarComoEntregue(pedidoId, clienteUid) {
    if (!confirm("Confirmar que o produto foi entregue? O comprador será notificado para confirmar o recebimento.")) return;
    try {
        await db.collection('loja_pedidos').doc(pedidoId).update({ status: 'entregue_pendente_confirmacao' });
        notifyUser(clienteUid, '🚚 Seu Pedido foi Entregue!', 'Por favor, confirme o recebimento do seu produto no app para finalizar a compra.');
        exibirInfoPopup('Notificação enviada ao comprador.');
    } catch (e) {
        exibirInfoPopup('Erro ao marcar como entregue: ' + e.message);
    }
}

async function abrirMinhasCompras() {
    abrirModal('modalMinhasCompras');
    const container = document.getElementById('listaMinhasCompras');
    container.innerHTML = '<p>Carregando suas compras...</p>';

    const snap = await db.collection('loja_pedidos').where('clienteUid', '==', auth.currentUser.uid).orderBy('ts', 'desc').get();
    if (snap.empty) {
        container.innerHTML = '<p>Você ainda não fez nenhuma compra.</p>';
        return;
    }
    container.innerHTML = '';
    snap.forEach(doc => {
        const compra = doc.data();
        let statusTexto = 'Status desconhecido';
        let acaoBotao = '';

        switch(compra.status) {
            case 'pendente': statusTexto = 'Aguardando entrega'; break;
            case 'entregue_pendente_confirmacao': statusTexto = 'Confirme o recebimento!'; break;
            case 'confirmado_pelo_cliente': statusTexto = 'Entrega confirmada'; break;
            case 'disputa': statusTexto = 'Entrega recusada'; break;
        }
        
        if (compra.status === 'confirmado_pelo_cliente' && !compra.avaliado) {
            acaoBotao = `<button onclick="abrirModalAvaliacaoProduto('${doc.id}', '${compra.produtoId}', '${compra.produtoNome}')">⭐ Avaliar Produto</button>`;
        } else if (compra.status === 'confirmado_pelo_cliente' && compra.avaliado) {
            acaoBotao = `<p style="font-size: 14px; color: var(--cor-destaque);">✅ Produto avaliado!</p>`;
        }

        container.innerHTML += `
            <div class="card">
                <b>${compra.produtoNome}</b>
                <p>Status: ${statusTexto}</p>
                <div style="margin-top: 10px;">${acaoBotao}</div>
            </div>
        `;
    });
}

function abrirModalConfirmacaoComprador(pedido) {
    const modal = document.getElementById('modalConfirmacaoComprador');
    if(modal.classList.contains('show')) return; 

    document.getElementById('btnAceitarEntrega').onclick = () => responderConfirmacaoEntrega(pedido.id, true);
    document.getElementById('btnRecusarEntrega').onclick = () => responderConfirmacaoEntrega(pedido.id, false);
    abrirModal('modalConfirmacaoComprador');
}

async function responderConfirmacaoEntrega(pedidoId, aceito) {
    const novoStatus = aceito ? 'confirmado_pelo_cliente' : 'disputa';
    try {
        const pedidoDoc = await db.collection('loja_pedidos').doc(pedidoId).get();
        const vendedorUid = pedidoDoc.data().vendedorUid;
        await db.collection('loja_pedidos').doc(pedidoId).update({ status: novoStatus });
        const msg = aceito ? '✅ O comprador confirmou o recebimento!' : '❌ O comprador recusou o recebimento. Entre em contato.';
        notifyUser(vendedorUid, '📦 Atualização de Entrega', msg, { link: '#entregas' });
        exibirInfoPopup('Resposta enviada com sucesso!');
        fecharModalAtual();
        abrirMinhasCompras();
    } catch (e) {
        exibirInfoPopup('Erro ao enviar resposta: ' + e.message);
    }
}
function toggleFuncoes(containerId) {
    const container = document.getElementById(containerId);
    const button = container.previousElementSibling;
    if (container) {
        container.classList.toggle('hidden');
        button.classList.toggle('closed', container.classList.contains('hidden'));
    }
}

function handleProdutoClick(produto) {
    if (!auth.currentUser) {
        exibirInfoPopup("Para ver detalhes e comprar produtos, por favor, faça login ou crie uma conta.");
        mostrar('authView');
    } else {
        abrirDetalhesProduto(produto);
    }
}

function iniciarVerificacaoDePendencias(uid) {
    if (pendenciasInterval) clearInterval(pendenciasInterval);
    verificarPendencias(uid);
    pendenciasInterval = setInterval(() => verificarPendencias(uid), 60000);
}

async function verificarPendencias(uid) {
    if (!uid || !perfil) return;

    if (perfil.tipo !== 'cliente') {
        const agendamentosSnap = await db.collection('agendamentos').where('barbeiroUid', '==', uid).where('status', '==', 'pendente').get();
        const btnAgendamentos = document.getElementById('btnAgendamentosBarbeiro');
        if (!agendamentosSnap.empty) {
            btnAgendamentos?.classList.add('notificacao-pulsante');
            notifyUser(uid, '⏰ Agendamento Pendente', `Você tem ${agendamentosSnap.size} novo(s) agendamento(s) para aprovar.`, { link: '#agendamentos' });
        } else {
            btnAgendamentos?.classList.remove('notificacao-pulsante');
        }
    }

    if (perfil.tipo === 'cliente') {
        const avaliacoesSnap = await db.collection('agendamentos').where('clienteUid', '==', uid).where('status', '==', 'concluido').where('avaliado', '==', false).get();
        const btnHistorico = document.getElementById('btnHistoricoCliente');
        if (!avaliacoesSnap.empty) {
            btnHistorico?.classList.add('notificacao-pulsante');
            notifyUser(uid, '⭐ Avaliação Pendente', `Você tem ${avaliacoesSnap.size} serviço(s) para avaliar e ganhar pontos!`, { link: '#historico' });
        } else {
            btnHistorico?.classList.remove('notificacao-pulsante');
        }
    }

    const saqueSnap = await db.collection("solicitacoes").where("usuarioUid", "==", uid).where("status", "==", "pendente").where("tipo", "==", "saque").get();
    if (!saqueSnap.empty) {
        notifyUser(uid, "⏳ Saque em Análise", "Sua solicitação de saque ainda está pendente de aprovação.", { link: '#carteira' });
    }
}

async function carregarAvaliacaoProduto(produtoId, produtoNome, container) {
    container.innerHTML = '';
    
    if (produtoNome.toLowerCase().includes('Nova Versão')) {
        const hoje = new Date().toISOString().split('T')[0]; 
        const seed = produtoId + hoje;
        let hash = 0;
        for (let i = 0; i < seed.length; i++) {
            const char = seed.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash |= 0; 
        }
        const randomValue = (Math.abs(hash) % 10) / 10;
        const notaAleatoria = (4.1 + randomValue).toFixed(1);

        const snap = await db.collection('avaliacoes_produtos').where('produtoId', '==', produtoId).orderBy('ts', 'desc').limit(1).get();
        
        let avaliacaoHtml = `<p class="avaliacao-estrelas">⭐ ${notaAleatoria}</p>`;
        
        if (!snap.empty) {
            const ultimaAvaliacao = snap.docs[0].data();
            const doisDiasAtras = new Date(Date.now() - 2 * 24 * 60 * 60 * 1000);
            if (ultimaAvaliacao.ts.toDate() > doisDiasAtras) {
                avaliacaoHtml += `<p class="avaliacao-comentario">"${ultimaAvaliacao.comentario}"</p>`;
            } else {
                 avaliacaoHtml += `<p class="avaliacao-comentario">Veja as avaliações dos clientes.</p>`;
            }
        } else {
             avaliacaoHtml += `<p class="avaliacao-comentario">Seja o primeiro a avaliar!</p>`;
        }
        container.innerHTML = avaliacaoHtml;

    } else {
        const snap = await db.collection('avaliacoes_produtos').where('produtoId', '==', produtoId).orderBy('ts', 'desc').limit(1).get();
        if (snap.empty) {
            container.innerHTML = `<p class="avaliacao-estrelas">⭐ Sem avaliação</p><p class="avaliacao-comentario">Seja o primeiro a avaliar!</p>`;
        } else {
            const avaliacao = snap.docs[0].data();
            container.innerHTML = `
                <p class="avaliacao-estrelas">⭐ ${avaliacao.nota.toFixed(1)}</p>
                <p class="avaliacao-comentario">"${avaliacao.comentario}"</p>
            `;
        }
    }
}

let notaSelecionada = 0;
function abrirModalAvaliacaoProduto(pedidoId, produtoId, produtoNome) {
    notaSelecionada = 0;
    document.getElementById('avaliarProdutoNome').textContent = produtoNome;
    document.getElementById('avaliarProdutoComentario').value = '';
    
    const starsContainer = document.getElementById('ratingStars');
    const stars = starsContainer.querySelectorAll('span');

    stars.forEach(star => {
        star.classList.remove('selected');
        star.innerHTML = '☆';
        star.onmouseover = () => {
            const rating = parseInt(star.dataset.value);
            stars.forEach(s => {
                s.classList.toggle('hovered', parseInt(s.dataset.value) <= rating);
                s.innerHTML = parseInt(s.dataset.value) <= rating ? '★' : '☆';
            });
        };
        star.onmouseout = () => {
            stars.forEach(s => {
                s.classList.remove('hovered');
                const rating = notaSelecionada;
                s.innerHTML = parseInt(s.dataset.value) <= rating ? '★' : '☆';
            });
        };
        star.onclick = () => {
            notaSelecionada = parseInt(star.dataset.value);
            stars.forEach(s => {
                s.classList.toggle('selected', parseInt(s.dataset.value) <= notaSelecionada);
            });
        };
    });

    document.getElementById('btnSalvarAvaliacaoProduto').onclick = () => {
        const comentario = document.getElementById('avaliarProdutoComentario').value.trim();
        if (notaSelecionada === 0) {
            return exibirInfoPopup('Por favor, selecione uma nota de 1 a 5 estrelas.');
        }
        salvarAvaliacaoProduto(pedidoId, produtoId, notaSelecionada, comentario);
    };
    
    abrirModal('modalAvaliarProduto');
}

async function salvarAvaliacaoProduto(pedidoId, produtoId, nota, comentario) {
    try {
        await db.collection('avaliacoes_produtos').add({
            produtoId,
            nota,
            comentario,
            clienteUid: auth.currentUser.uid,
            clienteNome: perfil.nome,
            ts: firebase.firestore.FieldValue.serverTimestamp()
        });
        await db.collection('loja_pedidos').doc(pedidoId).update({ avaliado: true });
        
        exibirInfoPopup('Obrigado pela sua avaliação!');
        fecharModalAtual();
        abrirMinhasCompras();
    } catch (e) {
        exibirInfoPopup('Erro ao salvar avaliação: ' + e.message);
    }
}

function fazerLogout() {
    auth.signOut().then(() => {
        // Apenas recarrega a página. A lógica de verificação de login
        // irá automaticamente direcionar para a tela de autenticação.
        location.reload();
    });
}

function handleDeepLink() {
    const hash = window.location.hash.substring(1);
    if (!hash || !auth.currentUser) return;

    switch (hash) {
        case 'agendamentos':
            if (perfil.tipo !== 'cliente') abrirAgendamentosBarbeiro();
            break;
        case 'solicitacoes':
            if (perfil.tipo === 'admin') abrirModalSolicitacoes();
            break;
        case 'denuncias':
            if (perfil.tipo === 'admin') abrirDenuncias();
            break;
        case 'carteira':
            abrirModal('modalCarteira');
            break;
        case 'historico':
            if (perfil.tipo === 'cliente') abrirHistoricoCliente();
            break;
        case 'fidelidade':
            abrirModal('modalFidelidade');
            break;
        case 'conquistas':
            if (perfil.tipo === 'cliente') abrirModalConquistas();
            else abrirModalConquistasBarbeiro();
            break;
        case 'avaliacoes':
            if (perfil.tipo !== 'cliente') abrirAvaliacoesBarbeiro();
            break;
        case 'minhascompras':
            abrirMinhasCompras();
            break;
        case 'entregas':
            abrirEntregasVendedor();
            break;
    }
    history.pushState("", document.title, window.location.pathname + window.location.search);
}

// --- NOVAS FUNÇÕES Nova Versão ---

function iniciarOnboarding() {
    const modal = document.getElementById('modalOnboarding');
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('show'), 10);
    renderOnboardingTela1();
}

function renderOnboardingTela1() {
    document.getElementById('onboardingContent').innerHTML = `
        <div class="onboarding-content-wrapper" style="text-align: center;">
            <img src="https://i.postimg.cc/KYbBp2VR/image-removebg-preview.png" alt="Logo VersãoPro" style="width: 150px; height: 150px; margin-bottom: 20px;">
            <h2 style="color: var(--cor-destaque-ouro);">Bem-vindo(a) ao Nova Versão!</h2>
            <p style="color: var(--cor-destaque-ouro);">seu ecossistema de beleza e bem-estar.</p>
            <button onclick="renderOnboardingTela2()">Próximo</button>
        </div>
    `;
}

function renderOnboardingTela2() {
    const onboardingContent = document.getElementById('onboardingContent');
    
    onboardingContent.innerHTML = `
      <div class="onboarding-content-wrapper">
        <h2 style="color:var(--cor-destaque-ouro);">Qual o seu maior interesse?</h2>
        <p>Isso nos ajuda a personalizar sua experiência.</p>
        <div class="interest-options" style="display:flex; flex-direction:column; gap:10px;">
            <button onclick="selecionarInteresse('barbeiro')">Barbearias</button>
            <button onclick="selecionarInteresse('manicure_pedicure')">Manicure e Pedicure</button>
            <button onclick="selecionarInteresse('designer_cilios')">Designer de Cílios</button>
        </div>
        <button onclick="renderOnboardingTela3()" style="margin-top:20px;" id="btnOnboardingNext2" disabled>Próximo</button>
      </div>
    `;
}

function selecionarInteresse(interesse) {
    onboardingState.interesse_principal = interesse;
    const buttons = document.querySelectorAll('.interest-options button');
    buttons.forEach(btn => {
        // Lógica mais precisa: verifica qual botão corresponde exatamente ao interesse clicado.
        const isSelected = btn.getAttribute('onclick') === `selecionarInteresse('${interesse}')`;
        btn.classList.toggle('selected', isSelected);
    });
    document.getElementById('btnOnboardingNext2').disabled = false;
}

function renderOnboardingTela3() {
    document.getElementById('onboardingContent').innerHTML = `
      <div class="onboarding-content-wrapper">
        <h2 style="color:var(--cor-destaque-ouro);">Como você usará o app?</h2>
        <p>Escolha seu perfil principal.</p>
        <div class="interest-options" style="display:flex; flex-direction:column; gap:10px;">
            <button onclick="selecionarPerfilBasico('cliente')">Sou Cliente</button>
            <button onclick="selecionarPerfilBasico('profissional')">Sou Profissional</button>
        </div>
        <button onclick="finalizarOnboarding()" style="margin-top:20px;" id="btnOnboardingNext3" disabled>Começar!</button>
      </div>
    `;
}

function selecionarPerfilBasico(tipo) {
    onboardingState.perfil_basico = tipo;
    const buttons = document.querySelectorAll('.interest-options button');
    buttons.forEach(btn => {
        btn.classList.toggle('selected', btn.textContent.toLowerCase().includes(tipo));
    });
    document.getElementById('btnOnboardingNext3').disabled = false;
}

// ADICIONE ESTA NOVA FUNÇÃO EM INDEX.HTML
async function ativarModoFerias() {
    const inicio = document.getElementById('feriasInicio').value;
    const fim = document.getElementById('feriasFim').value;

    if (!inicio || !fim) {
        return exibirInfoPopup("Por favor, selecione a data de início e fim.");
    }

    const dataInicio = new Date(inicio);
    const dataFim = new Date(fim);

    if (dataFim < dataInicio) {
        return exibirInfoPopup("A data de fim não pode ser anterior à data de início.");
    }
    
    if (!confirm(`Você tem certeza que deseja bloquear sua agenda de ${dataInicio.toLocaleDateString()} até ${dataFim.toLocaleDateString()}? Seus clientes serão notificados.`)) {
        return;
    }

    exibirAguarde("Bloqueando agenda e notificando...");

    try {
        // Lógica de notificação (simples, para não sobrecarregar)
        // Uma implementação mais avançada usaria Cloud Functions para notificar em lotes
        const clientesSnap = await db.collection("agendamentos")
            .where("barbeiroUid", "==", auth.currentUser.uid)
            .where("status", "==", "concluido")
            .get();

        const clientesNotificados = new Set();
        clientesSnap.forEach(doc => {
            const clienteUid = doc.data().clienteUid;
            if (!clientesNotificados.has(clienteUid)) {
                notifyUser(
                    clienteUid, 
                    `🗓️ Aviso de ${perfil.nome}`, 
                    `O profissional estará ausente de ${dataInicio.toLocaleDateString()} a ${dataFim.toLocaleDateString()}.`
                );
                clientesNotificados.add(clienteUid);
            }
        });

        await db.collection("usuarios").doc(auth.currentUser.uid).update({
            ausente: true,
            ausenciaInicio: firebase.firestore.Timestamp.fromDate(dataInicio),
            ausenciaFim: firebase.firestore.Timestamp.fromDate(dataFim)
        });

        fecharTodosOsModais();
        exibirInfoPopup("Modo férias ativado com sucesso! Sua agenda está bloqueada para o período e seus clientes foram notificados.");

    } catch (e) {
        fecharTodosOsModais();
        exibirInfoPopup("Ocorreu um erro: " + e.message);
    }
}

function finalizarOnboarding() {
    localStorage.setItem('onboarding_concluido', 'true');
    const modal = document.getElementById('modalOnboarding');
    modal.classList.remove('show');
    setTimeout(() => modal.style.display = 'none', 500);
    prepararCriarConta();
    mostrar('authView'); // <-- ADICIONE ESTA LINHA
}

function aplicarTemaPorProfissao(interesse) {
    let cor = 'var(--cor-destaque-ouro)';
    if (interesse === 'manicure_pedicure' || interesse === 'designer_cilios') {
        cor = 'var(--cor-destaque-rosa)';
    }
    document.documentElement.style.setProperty('--cor-destaque', cor);
}

function iniciarOnboardingProfissional() {
    tempOnboardingServicos = [];
    abrirModal('modalOnboardingProfissionalServicos');
}

function adicionarServicoOnboarding() {
    const nome = document.getElementById('onboardingServicoNome').value.trim();
    const valor = parseFloat(document.getElementById('onboardingServicoValor').value);
    const tempo = parseInt(document.getElementById('onboardingServicoTempo').value);
    if (!nome || isNaN(valor) || isNaN(tempo)) return exibirInfoPopup("Preencha todos os campos do serviço.");

    tempOnboardingServicos.push({ nome, valor, duracao: tempo });
    
    const list = document.getElementById('onboardingServicosList');
    list.innerHTML += `<p>✅ ${nome} - R$${valor.toFixed(2)}</p>`;
    document.getElementById('onboardingServicoNome').value = '';
    document.getElementById('onboardingServicoValor').value = '';
    document.getElementById('onboardingServicoTempo').value = '';
    document.getElementById('btnOnboardingNextServicos').disabled = false;
}

function avancarOnboarding(etapa) {
    if (etapa === 2) {
        fecharModalAtual();
        abrirModal('modalOnboardingProfissionalAgenda');
        
        // Pega os elementos dos botões
        const btnVaga = document.getElementById('onboardingBtnVagaImediata');
        const btnManual = document.getElementById('onboardingBtnAgendaManual');
        const painelManual = document.getElementById('onboardingAgendaManualPainel');

        // Reseta o estado inicial
        onboardingState.vagaImediata = false;
        onboardingState.usaAgendaManual = false;
        btnVaga.textContent = '⚡ Ativar Vaga Imediata';
        btnVaga.classList.remove('selected');
        btnManual.classList.remove('selected');
        painelManual.classList.add('hidden');
        
        const horariosContainer = document.getElementById("onboardingHorariosContainer");
        horariosContainer.innerHTML = ''; // Limpa para evitar duplicatas
        for (let i = 7; i <= 18; i++) {
            const horario = `${i}:00`;
            horariosContainer.innerHTML += `<button class="horario-btn" onclick="this.classList.toggle('selecionado')">${horario}</button>`;
        }
        
        // --- LÓGICA APRIMORADA PARA O BOTÃO DE VAGA IMEDIATA ---
        btnVaga.onclick = () => {
            // Inverte o estado atual
            onboardingState.vagaImediata = !onboardingState.vagaImediata;
            
            if (onboardingState.vagaImediata) {
                // Se ativou a Vaga Imediata
                btnVaga.textContent = '⚡ Vaga Imediata Ativa ✅';
                btnVaga.classList.add('selected');
                
                // Garante que a outra opção seja desativada
                onboardingState.usaAgendaManual = false;
                btnManual.classList.remove('selected');
                painelManual.classList.add('hidden');
            } else {
                // Se desativou a Vaga Imediata
                btnVaga.textContent = '⚡ Ativar Vaga Imediata';
                btnVaga.classList.remove('selected');
            }
        };
        
        // --- LÓGICA APRIMORADA PARA O BOTÃO DE AGENDA MANUAL ---
        btnManual.onclick = () => {
            onboardingState.usaAgendaManual = !onboardingState.usaAgendaManual;
            
            if (onboardingState.usaAgendaManual) {
                btnManual.classList.add('selected');
                painelManual.classList.remove('hidden');

                // Garante que a outra opção seja desativada
                onboardingState.vagaImediata = false;
                btnVaga.textContent = '⚡ Ativar Vaga Imediata';
                btnVaga.classList.remove('selected');
            } else {
                btnManual.classList.remove('selected');
                painelManual.classList.add('hidden');
            }
        };

    } else if (etapa === 3) {
        // MUDANÇA: Mostra o "Aguarde" ANTES de salvar e reiniciar
        exibirAguarde("Finalizando configuração e reiniciando...");

        const userRef = db.collection('usuarios').doc(auth.currentUser.uid);
        const updates = {
            listaServicos: tempOnboardingServicos,
            onboarding_profissional_concluido: true
        };

        if (onboardingState.usaAgendaManual) {
            updates.usaAgendaManual = true;
            updates.vagaImediata = false;
            const agenda = {};
            document.querySelectorAll('#onboardingHorariosContainer .selecionado').forEach(btn => {
                agenda[btn.textContent] = true;
            });
            updates.agenda = agenda;
        } else {
            // Salva o estado da Vaga Imediata (seja true ou false)
            updates.vagaImediata = onboardingState.vagaImediata;
            updates.usaAgendaManual = false;
        }

        // Atualiza o banco de dados
        userRef.update(updates).then(() => {
            // MUDANÇA PRINCIPAL: Em vez de fechar modais, REINICIA O APP
            // Isso garante que tudo carregue do zero, já com o perfil de profissional configurado.
            location.reload(); 
        }).catch(e => {
            // Se der erro, fecha o "Aguarde" e mostra a falha
            fecharTodosOsModais();
            exibirInfoPopup("Erro ao salvar: " + e.message);
        });
    }
}

async function adminToggleLoja(uid, deveAtivar) {
    await db.collection('usuarios').doc(uid).update({ lojaLiberada: deveAtivar });
    exibirInfoPopup(`Loja ${deveAtivar ? 'ativada' : 'desativada'} para o usuário.`);
    abrirModalGerenciarUsuario(uid); // Reabre o modal para refletir a mudança
}

async function adminDeletarProduto(produtoId, nome) {
    if(confirm(`Tem certeza que deseja deletar o produto "${nome}"?`)) {
        await db.collection('loja_produtos').doc(produtoId).delete();
        exibirInfoPopup("Produto deletado!");
        fecharModalAtual();
    }
}

async function abrirGerenciarLojaAdmin() {
    abrirModal('modalGerenciarLojaAdmin');
    const produtosList = document.getElementById('adminDeletarProdutoList');
    const usuariosList = document.getElementById('adminToggleLojaList');
    produtosList.innerHTML = "<p>Carregando...</p>";
    usuariosList.innerHTML = "<p>Carregando...</p>";

    const produtosSnap = await db.collection('loja_produtos').get();
    produtosList.innerHTML = "";
    produtosSnap.forEach(doc => {
        const p = doc.data();
        produtosList.innerHTML += `<div class="card"><b>${p.nome}</b> por ${p.vendedorNome} <button style="background: #c0392b; float:right;" onclick="adminDeletarProduto('${doc.id}', '${p.nome}')">X</button></div>`;
    });

    const usersSnap = await db.collection('usuarios').where('lojaLiberada', 'in', [true, false]).get();
    usuariosList.innerHTML = "";
    usersSnap.forEach(doc => {
        const u = doc.data();
        if (u.tipo === 'admin') return;
        usuariosList.innerHTML += `<div class="card"><b>${u.nome}</b> <button style="float:right;" onclick="adminToggleLoja('${doc.id}', ${!u.lojaLiberada})">${u.lojaLiberada ? 'Desativar' : 'Ativar'}</button></div>`;
    });
}

async function registrarSincronizacaoDeMensagem(mensagemData) {
    const swRegistration = await navigator.serviceWorker.ready;
    // Salve a mensagem no IndexedDB (armazenamento local) aqui
    await swRegistration.sync.register('enviar-mensagem-chat');
    console.log('Sincronização para envio de mensagem registrada.');
}

function setupConfiguracoes() {
    carregarEstados('config');
    setTimeout(() => { // Garante que os estados carregaram
        document.getElementById('configEstado').value = perfil.estado;
        carregarCidades('config');
        setTimeout(() => {
            document.getElementById('configCidade').value = perfil.cidade;
        }, 100);
    }, 100);

// ADICIONAR ESTAS DUAS LINHAS
configurarBotoesGuest();
carregarBarbeirosPrincipal('listaBarbeirosPrincipalGuest', true);

    const interesseContainer = document.getElementById('configInteresseContainer');
    const buttons = interesseContainer.querySelectorAll('button');
    buttons.forEach(btn => {
        btn.classList.toggle('selected', btn.dataset.interesse === perfil.interesse_principal);
        btn.onclick = async () => {
            const novoInteresse = btn.dataset.interesse;
            await db.collection('usuarios').doc(auth.currentUser.uid).update({ interesse_principal: novoInteresse });
            buttons.forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            exibirInfoPopup("Interesse atualizado!");
            location.reload(); // Recarrega para aplicar as mudanças de filtro
        }
    });
}
async function salvarLocalizacaoConfig() {
    const estado = document.getElementById('configEstado').value;
    const cidade = document.getElementById('configCidade').value;
    if (!estado || !cidade) return exibirInfoPopup("Selecione estado e cidade.");
    await db.collection('usuarios').doc(auth.currentUser.uid).update({ estado, cidade });
    exibirInfoPopup("Localização salva!");
    fecharModalAtual();
}

document.getElementById('btnConfig').onclick = () => {
    setupConfiguracoes();
    abrirModal('modalConfiguracoes');
}
</script>
<script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('/firebase-messaging-sw.js').then(function(reg) {
          console.log('✅ Service Worker registrado com sucesso:', reg.scope);

          reg.addEventListener('updatefound', () => {
            newWorker = reg.installing;
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                 const modal = document.getElementById('modalAtualizacao');
                 const btn = document.getElementById('btnAtualizarApp');
                 btn.onclick = () => {
                   newWorker.postMessage({ type: 'SKIP_WAITING' });
                 };
                 abrirModal('modalAtualizacao');
              }
            });
          });
        }).catch(function(err) {
          console.error('❌ Falha ao registrar Service Worker:', err);
        });

        let refreshing;
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          if (refreshing) return;
          window.location.reload();
          refreshing = true;
        });
      });
    }

// --- NOVO CÓDIGO: Adiciona a funcionalidade de login com a tecla Enter ---
const loginFields = [document.getElementById('email'), document.getElementById('senha')];
loginFields.forEach(field => {
    field.addEventListener('keyup', function(event) {
        // Verifica se a tecla pressionada foi "Enter"
        if (event.key === 'Enter') {
            // Impede qualquer ação padrão do navegador
            event.preventDefault();
            // Pega o botão de entrar pelo texto, pois não tem ID
            const entrarButton = Array.from(document.querySelectorAll('#authView button')).find(btn => btn.textContent.includes('Entrar'));
            // Clica no botão
            if (entrarButton) {
                entrarButton.click();
            }
        }
    });
});

</script>
</body>
</html>
