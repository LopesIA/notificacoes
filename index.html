function girarRoleta() {
    const hoje = new Date().toDateString();
    
    // Verifica giros dispon√≠veis
    let girosTotais = 1;
    if (isProAtivo(perfil) && perfil.proTier && PRECOS_PRO[perfil.proTier]) {
        girosTotais = PRECOS_PRO[perfil.proTier].giros;
    }
    let girosUsados = (perfil.ultimoGiroRoleta === hoje && perfil.girosRealizadosHoje) ? perfil.girosRealizadosHoje : 0;
    
    if (girosUsados >= girosTotais) {
        return exibirPopup("Sem giros", "Voc√™ j√° usou seus giros de hoje! Volte amanh√£ ou assine PRO para mais chances.");
    }

    const btnGirar = document.getElementById('btnGirarRoleta');
    btnGirar.disabled = true;
    btnGirar.textContent = "Girando...";

    // 1. Definir o Resultado (Sorteio)
    const rand = Math.random();
    let resultado = rand < 0.90 ? Math.ceil(Math.random() * 10) : 11; // 1-10 (pontos) ou 11 (presente)

    // 2. Configura√ß√£o da Anima√ß√£o (Ajustado para o novo CSS)
    // Item: 80px largura + 10px margem (5 esq + 5 dir) = 90px TOTAL
    const itemTotalWidth = 90; 
    const itensPorSet = 11; // 10 n√∫meros + 1 presente
    const voltas = 5; // Menos voltas para ser mais suave
    
    // O √≠ndice alvo no array gigante de HTML gerado
    const indiceAlvo = (voltas * itensPorSet) + (resultado - 1);
    
    // Pega a largura vis√≠vel da janela da roleta (container)
    const containerWidth = document.getElementById('roletaVisual').offsetWidth;
    
    // C√°lculo para centralizar: 
    const posicaoFinal = (indiceAlvo * itemTotalWidth) - (containerWidth / 2) + (itemTotalWidth / 2);

    const faixa = document.getElementById('roletaFaixa');
    
    // Adiciona um pequeno "ru√≠do" aleat√≥rio (+/- 15px) para a seta n√£o cair roboticamente no meio
    const jitter = Math.floor(Math.random() * 30) - 15; 
    
    // Anima√ß√£o Cubic-Bezier para efeito de "freio" realista
    faixa.style.transition = `transform 5s cubic-bezier(0.25, 1, 0.5, 1)`; 
    faixa.style.transform = `translateX(-${posicaoFinal + jitter}px)`;
    
    // 3. Processar Pr√™mio AP√ìS a anima√ß√£o
    setTimeout(async () => {
        let premioTitulo = "";
        let premioDescricao = "";
        
        // Dados b√°sicos de atualiza√ß√£o
        let updates = { 
            ultimoGiroRoleta: hoje,
            girosRealizadosHoje: (perfil.ultimoGiroRoleta === hoje) ? firebase.firestore.FieldValue.increment(1) : 1
        };
        
        // --- L√ìGICA DE EXPIRA√á√ÉO EM 24H ---
        const validade = new Date();
        validade.setHours(validade.getHours() + 24); // Define validade para 24h a partir de agora

        if (resultado <= 10) {
            premioTitulo = `üéâ Ganhou ${resultado} Ponto(s)!`;
            premioDescricao = `Voc√™ ganhou ${resultado} pontos. Eles expiram em 24 horas se n√£o usados!`;
            
            updates.pontosFidelidade = firebase.firestore.FieldValue.increment(resultado);
            
            // Adiciona ao "bolso" de pontos a expirar (O CRON do servidor vai limpar isso)
            updates.historicoPontosRoleta = firebase.firestore.FieldValue.arrayUnion({
                valor: resultado,
                expiraEm: firebase.firestore.Timestamp.fromDate(validade)
            });

        } else {
            premioTitulo = "üéÅ CAIXA MISTERIOSA!";
            if (perfil.tipo !== 'cliente') {
                // Profissional ganha Boost
                const exp = new Date(); 
                const atualExp = perfil.boostExpiracao ? perfil.boostExpiracao.toDate() : new Date();
                if (atualExp < new Date()) { atualExp.setTime(Date.now()); } 
                atualExp.setHours(atualExp.getHours() + 24); 
                
                updates.boostExpiracao = firebase.firestore.Timestamp.fromDate(atualExp);
                updates.ultimoBoostComprado = firebase.firestore.FieldValue.serverTimestamp();
                premioDescricao = "Sorte GRANDE! Voc√™ ganhou 24 horas de Perfil Turbinado!";
            } else {
                // Cliente ganha VIP
                const exp = new Date();
                const atualVipExp = (isVipAtivo(perfil) && perfil.vipExpirationDate) ? perfil.vipExpirationDate.toDate() : new Date();
                if (atualVipExp < new Date()) { atualVipExp.setTime(Date.now()); }
                atualVipExp.setDate(atualVipExp.getDate() + 5); 
                
                updates.vip = true; 
                updates.vipExpirationDate = firebase.firestore.Timestamp.fromDate(atualVipExp);
                premioDescricao = "Incr√≠vel! Voc√™ ganhou 5 Dias de VIP Gr√°tis!";
            }
        }
        
        try {
            await db.collection('usuarios').doc(auth.currentUser.uid).update(updates);
            exibirPopupBloqueante(premioTitulo, premioDescricao, () => {});
            notifyUser(auth.currentUser.uid, "üé∞ Pr√™mio da Roleta", premioDescricao);
            
            // Atualiza localmente para feedback imediato nos pontos
            if (resultado <= 10 && perfil.pontosFidelidade) {
                 const pontosEl = document.getElementById('pontosFidelidade');
                 if(pontosEl) pontosEl.textContent = (perfil.pontosFidelidade + resultado);
            }

        } catch (e) {
            console.error(e);
            exibirPopup("Erro", "Erro ao salvar pr√™mio: " + e.message);
        }

        // Resetar bot√£o para pr√≥ximo giro (se houver)
        let novosGirosUsados = (perfil.ultimoGiroRoleta === hoje ? perfil.girosRealizadosHoje : 0) + 1; 
        let restantes = Math.max(0, girosTotais - novosGirosUsados);
        btnGirar.textContent = `üé≤ GIRAR (${restantes} Restantes)`;
        
        if(restantes > 0) {
            btnGirar.disabled = false;
            // Reset visual suave
            setTimeout(() => {
                faixa.style.transition = 'none';
                faixa.style.transform = 'translateX(0px)';
            }, 1000);
        } else {
            btnGirar.textContent = "Volte Amanh√£";
        }

    }, 5000); // Tempo sincronizado com a transi√ß√£o CSS (5s)
}
