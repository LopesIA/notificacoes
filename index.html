<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Nova Versão</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="icon" href="/icone.png" type="image/png">
  <link rel="apple-touch-icon" href="/icone.png">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root {
/* CORREÇÃO TELA 2: Centraliza e cobre o fundo da tela de onboarding com imagem */
.onboard-screen[style*="background-image"] {
    background-repeat: no-repeat;
    background-position: center center !important; 
    background-size: cover !important;
}

      --cor-fundo: #0c0c0c;
      --cor-card: #181818;
      --cor-botoes: #222222;
      --cor-texto-principal: #e0e0e0;
      --cor-destaque-ouro: #d4af37; /* Dourado */
      --cor-destaque-rosa: #e57373; /* Rosa Suave */
      --cor-destaque-prata: #c0c0c0; /* Prateado */
      --cor-destaque-azul: #007BFF; /* Azul */
      --cor-sombra: #000000;
      --cor-borda: #333;
      --cor-destaque: var(--cor-destaque-ouro); /* Cor padrão */
    }
/* ANIMAÇÃO DE BRILHO DOURADO PARA OPÇÃO SELECIONADA */
@keyframes brilhoDourado {
    0% {
        box-shadow: 0 0 5px rgba(212, 175, 55, 0.4), 0 0 10px rgba(212, 175, 55, 0.2);
    }
    50% {
        box-shadow: 0 0 15px var(--cor-tema-forte), 0 0 25px var(--cor-tema-forte); /* cor-tema-forte é o seu dourado */
    }
    100% {
        box-shadow: 0 0 5px rgba(212, 175, 55, 0.4), 0 0 10px rgba(212, 175, 55, 0.2);
    }
}

/* Estilo para o botão de Usuários Online (Admin) */
#onlineUserCount {
    font-size: 14px;
    font-weight: 600;
    /* color: #2ecc71;  <-- REMOVIDO */
    background: linear-gradient(45deg, var(--cor-destaque-prata), var(--cor-destaque-ouro));
    color: var(--cor-fundo);
    padding: 8px 12px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
    /* animation: pulse-green 2s infinite; <-- REMOVIDO */
    cursor: pointer;
    transition: all 0.3s ease;
}
#onlineUserCount:hover {
    transform: scale(1.05);
    box-shadow: 0 0 15px rgba(212, 175, 55, 0.8);
}

/* Estilo para o modal de novo agendamento (não-fechável) */
#modalNovoAgendamento {
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
}

/* Estilo para item clicável na lista de usuários online */
#listaUsuariosOnline .selectable-item {
    background: var(--cor-botoes);
    border: 1px solid var(--cor-borda);
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
}
#listaUsuariosOnline .selectable-item:hover {
    border-color: var(--cor-destaque);
    background-color: var(--cor-card);
}

/* Estilos para Desktop - Agendamentos do Profissional */
@media (min-width: 768px) { /* Aplica a partir de telas médias (tablets e desktops) */
  #modalAgendamentosBarbeiro .modal-content {
    max-width: 800px; /* Modal um pouco mais largo */
  }

  #agendamentosPainel {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* Cria colunas */
    gap: 15px; /* Espaçamento entre os cards */
    max-height: 70vh; /* Ajusta a altura máxima se necessário */
  }

  #agendamentosPainel .card {
    width: auto; /* Deixa o card ocupar o espaço da coluna */
    margin: 0; /* Remove margem padrão do card */
  }

  /* Opcional: Ajustar tamanho da fonte ou padding nos cards se necessário */
  #agendamentosPainel .card p,
  #agendamentosPainel .card button {
    font-size: 0.9em; /* Levemente menor para caber mais info */
  }
   #agendamentosPainel .card button {
      padding: 8px 10px;
   }

   /* Ajustes gerais para telas maiores */
   .content-container {
      max-width: 900px; /* Container principal mais largo */
   }
   .card {
     max-width: none; /* Remove limitação de largura dos cards */
   }
}

/* Garante que o modal da agenda tenha rolagem interna */
#modalAgendaBarbeiro .modal-content {
    max-height: 85vh; /* Altura máxima */
    display: flex;
    flex-direction: column;
    overflow: hidden; /* O scroll vai no corpo, não no modal todo */
}

/* Área de rolagem para os botões e grid */
#agendaScrollContent {
    overflow-y: auto;
    padding-right: 5px;
    flex-grow: 1;
}

/* Correção visual do Grid de Horários */
#horariosContainer {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
    gap: 8px;
    padding: 10px;
    background: var(--cor-fundo);
    border: 1px solid var(--cor-borda);
    border-radius: 8px;
    margin-top: 10px;
}

/* CLASSE QUE APLICA A ANIMAÇÃO QUANDO SELECIONADO */
.onboard-option.selected {
    border: 2px solid var(--cor-tema-forte) !important; /* Adiciona uma borda dourada sólida */
    animation: brilhoDourado 1.5s infinite alternate; /* Aplica o brilho piscante */
}

/* Garante que o item não selecionado não tenha a animação */
.onboard-option:not(.selected) {
    animation: none;
}
    body.tema-claro {
      --cor-fundo: #f0f0f0;
      --cor-card: #ffffff;
      --cor-botoes: #e0e0e0;
      --cor-texto-principal: #333;
      --cor-destaque-ouro: #d4af37;
      --cor-destaque-rosa: #e57373;
      --cor-destaque-prata: #808080;
      --cor-destaque-azul: #0056b3;
      --cor-sombra: #b0b0b0;
      --cor-borda: #ccc;
    }
    body {
      background-image: url('/icone.png'); /* Caminho correto para o Firebase Hosting/Web */
      background-size: cover; /* Garante que a imagem cubra todo o elemento */
      background-position: center; /* Centraliza a imagem */
      background-repeat: no-repeat; /* Evita repetição */
      background-attachment: fixed; /* Opcional: mantém a imagem fixa ao rolar */

      /* Adiciona um overlay escuro para o texto ficar mais legível */
      background-blend-mode: multiply;
      background-color: rgba(0, 0, 0, 0.6); /* Cor de fundo escura (ajuste a opacidade 0.6 se necessário) */
      
      margin: 0;
      background: var(--cor-fundo);
      color: var(--cor-texto-principal);
      font-family: 'Poppins', sans-serif;
      min-height: 10vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: background-color 0.3s;
    }
    .content-container {
      width: 100%;
      max-width: 500px;
      padding-top: 60px;
      padding-bottom: 80px; /* Espaço para os botões do rodapé */
      box-sizing: border-box;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative; /* Adicionado para posicionamento do chat preview */
    }
    input, select, button, textarea {
      width: 100%;
      margin: 8px 0;
      padding: 14px;
      background: var(--cor-botoes);
      color: var(--cor-texto-principal);
      border: 1px solid var(--cor-borda);
      border-radius: 10px;
      font-size: 16px;
      transition: all 0.3s ease-in-out;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      box-sizing: border-box; /* CORREÇÃO: Garante que padding não estoure a div */
    }
    button {
      cursor: pointer;
      font-weight: 600;
    }
    button:hover {
      background: var(--cor-destaque);
      color: var(--cor-fundo);
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(212, 175, 55, 0.4);
    }
    button:disabled {
        cursor: not-allowed;
        background: #444;
        opacity: 0.6;
    }
    .card {
      background: var(--cor-card);
      padding: 24px;
      margin: 12px;
      border-radius: 16px;
      box-shadow: 0 6px 15px var(--cor-sombra);
      width: 90%;
      max-width: 480px;
      box-sizing: border-box;
      position: relative;
      overflow: hidden;
      /* Transição mais fluida */
      transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out;
    }
    .card.exiting {
        opacity: 0;
        transform: translateX(-50px);
    }
    .card.entering {
        opacity: 0;
        transform: translateX(50px);
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .hidden {
      display: none !important;
    }
    .topbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: var(--cor-card);
      color: var(--cor-texto-principal);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 16px;
      box-shadow: 0 2px 4px #000;
      font-size: 18px;
      z-index: 10;
      border-bottom: 2px solid var(--cor-borda);
    }
    .logo {
      font-weight: 600;
      color: var(--cor-destaque);
      font-size: 18px;
      text-shadow: 0 0 5px var(--cor-destaque);
      transition: color 0.3s;
    }
    .topbar-right {
      display: flex;
      align-items: center;
      gap: 15px; /* Aumentado o espaço */
    }
    #btnConfig {
      font-size: 20px;
      background: none;
      border: none;
      padding: 0;
      cursor: pointer;
    }
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 20;
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
    }
    .modal.show {
      display: flex;
      opacity: 1;
    }
    .modal-content {
      background: var(--cor-card);
      padding: 30px;
      border-radius: 20px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.8);
      transform: scale(0.9);
      transition: transform 0.3s ease-in-out;
      border: 1px solid var(--cor-borda);
      position: relative; /* Para popups sobrepostos */
    }
    .modal-overlay-content {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(12, 12, 12, 0.9);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border-radius: 20px;
        z-index: 25; /* Fica acima do conteúdo do modal pai */
    }
    /* Estilo para o modal de ranking maior */
    #modalRankingUnificado .modal-content {
        max-width: 600px; /* Maior para caber as duas colunas */
    }
    .modal.show .modal-content {
      transform: scale(1);
    }
    .servico-btn {
      background: #333;
      margin: 6px 0;
      border: 1px solid #555;
      border-radius: 8px;
      padding: 12px;
      text-align: left;
    }
    .bottom-buttons-container {
      position: fixed;
      bottom: 12px;
      width: 90%;
      max-width: 480px;
      display: flex;
      justify-content: space-between;
      z-index: 15;
    }
    .redeem-container {
      position: fixed;
      bottom: 25px; /* Posição ajustada */
      width: 100%;
      max-width: 500px;
      text-align: center;
      z-index: 15;
      box-sizing: border-box;
    }
    .redeem-container button {
      width: 200px;
      font-size: 14px;
      padding: 10px;
      margin: 0;
    }
    #btnChat, #btnDenuncia {
      font-size: 26px;
      background: none;
      border: none;
      padding: 0;
      margin: 0;
      cursor: pointer;
      width: auto;
      height: auto;
      text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
      position: relative; /* Para o contador de notificação */
    }
    #btnSair {
      font-size: 20px; /* Reduzido */
      background: none;
      border: none;
      padding: 0;
      margin: 0;
      cursor: pointer;
      width: auto;
      height: auto;
      text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
      position: fixed;
      bottom: 72px; /* Posição alterada para ficar acima do botão de denúncia */
      left: 12px;
      z-index: 15;
    }
    #btnTema {
      font-size: 18px; /* Ajuste aqui */
      background: none;
      border: none;
      padding: 0;
      margin: 0;
      cursor: pointer;
      width: auto;
      height: auto;
      text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
    }
    #btnCarteiraTop {
      font-size: 16px;
      background: var(--cor-botoes);
      color: var(--cor-texto-principal);
      border-radius: 10px;
      padding: 8px 12px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }
    #botaoExtra {
      margin: 10px;
      text-align: center;
      width: 90%;
      max-width: 480px;
      box-sizing: border-box;
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    .vantagens ul {
      list-style-type: '✅';
      padding-left: 20px;
    }
    .vantagens li {
      background: transparent;
      margin-bottom: 10px;
      padding: 5px;
      border-radius: 0;
      border: none;
      box-shadow: none;
      padding-left: 10px;
    }
    @keyframes vaga-glow {
      0% { box-shadow: 0 0 8px #4CAF50, 0 0 12px #4CAF50; }
      50% { box-shadow: 0 0 16px #4CAF50, 0 0 24px #4CAF50; }
      100% { box-shadow: 0 0 8px #4CAF50, 0 0 12px #4CAF50; }
    }
    @keyframes gold-flash-background {
        0%, 100% { background-color: var(--cor-card); }
        50% { background-color: #2c250e; }
    }
    .boosted-card {
        border: 2px solid var(--cor-destaque);
        animation: gold-flash-background 3s ease-in-out infinite, fadeIn 0.5s;
    }
    .boost-icon {
        position: absolute;
        top: 8px;
        left: 8px;
        font-size: 20px;
        text-shadow: 0 0 8px var(--cor-destaque);
    }
    @keyframes gold-flash {
      0%, 100% { background-color: transparent; transform: scale(1); }
      50% { background-color: rgba(212, 175, 55, 0.8); transform: scale(1.2); }
    }
    @keyframes gold-pulse {
      0% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.7); }
      70% { box-shadow: 0 0 10px 15px rgba(212, 175, 55, 0); }
      100% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0); }
    }
    .notificacao-pulsante {
        animation: gold-pulse 1.5s infinite;
    }
    .new-message-glow {
        animation: gold-flash 1.5s ease-in-out infinite;
        border-radius: 50%;
    }
    .notification-badge {
        position: absolute;
        top: -5px;
        right: -8px;
        background-color: #e74c3c;
        color: white;
        border-radius: 50%;
        padding: 2px 6px;
        font-size: 10px;
        font-weight: bold;
        border: 2px solid var(--cor-fundo);
    }
    .vip-glow {
      box-shadow: 0 0 8px var(--cor-destaque), 0 0 12px var(--cor-destaque);
      border: 1px solid var(--cor-destaque);
    }
    
    /* NOVO ESTILO ADICIONADO AQUI */
    .pro-glow {
      box-shadow: 0 0 8px var(--cor-destaque-azul), 0 0 12px var(--cor-destaque-azul);
      border: 1px solid var(--cor-destaque-azul);
    }
    .promocao-card {
      background: linear-gradient(45deg, #181818, var(--cor-destaque));
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 10px;
      color: #fff;
    }
    .chat-container {
      height: 100%;
      flex-grow: 1; /* Faz o container crescer */
      overflow-y: auto;
      border: 1px solid var(--cor-borda);
      padding: 10px;
      border-radius: 10px;
      background: #0d0d0d;
      margin-bottom: 10px;
      display: flex;
      flex-direction: column; 
    }
    .chat-message {
      padding: 8px 12px;
      margin-bottom: 8px;
      border-radius: 12px;
      animation: fadeIn 0.3s ease-in-out;
      transition: opacity 1.5s ease-out; /* Transição para o fade out */
    }
    .chat-message.fading-out {
        opacity: 0;
    }
    .chat-sent {
      text-align: right;
      background: #333;
      margin-left: 20%;
    }
    .chat-received {
      text-align: left;
      background: #555;
      margin-right: 20%;
    }
    .scrollable-list {
      max-height: 250px; /* Ou outro valor que funcione bem */
overflow-y: auto;
padding-right: 10px; /* Espaço para a barra de rolagem */
    }
    .aviso-item {
      text-align: left;
      margin-bottom: 8px;
      border-bottom: 1px solid var(--cor-borda);
      padding-bottom: 8px;
      opacity: 0.8;
      transition: opacity 0.3s ease-in-out;
    }
    .horario-btn {
        background: #222;
        color: #fff;
        border: 1px solid #555;
        border-radius: 5px;
        padding: 8px;
        margin: 5px;
        width: 100px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .horario-btn.selecionado {
        background: var(--cor-destaque);
        color: var(--cor-fundo);
        border-color: var(--cor-destaque);
    }
    .horario-btn.bloqueado {
        background: #772014;
        color: #fff;
        border-color: #772014;
        text-decoration: line-through;
    }
    .horarios-actions {
        display: flex;
        justify-content: space-between;
        margin-top: 10px;
        gap: 10px;
    }
    .horarios-list {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 10px;
    }
    .horario-disponivel {
      background: var(--cor-botoes);
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 14px;
      color: var(--cor-texto-principal);
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .horario-disponivel:hover {
      background: var(--cor-destaque);
    }
    .admin-chat-red {
      color: red;
      font-weight: bold;
      text-shadow: 0 0 5px #000, 0 0 8px #000;
    }
    .barbeiro-chat {
        color: var(--cor-texto-principal);
        text-shadow: 0 0 8px var(--cor-destaque-azul);
    }
    .cliente-chat {
        color: var(--cor-texto-principal);
        text-shadow: 0 0 8px var(--cor-destaque-prata);
    }
    .show-password-container {
        position: relative;
        display: flex;
        align-items: center;
        width: 100%;
    }
    .show-password-container input {
        padding-right: 40px;
    }
    .show-password-toggle {
        position: absolute;
        right: 15px;
        cursor: pointer;
        color: var(--cor-destaque-prata);
    }
    .barbeiro-card {
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        cursor: pointer;
    }
    .card-header {
        display: flex;
        justify-content: flex-start; /* Alinha itens ao início (esquerda) */
        align-items: center; /* Centraliza verticalmente */
        border-bottom: 1px solid var(--cor-borda);
        padding-bottom: 10px;
        gap: 15px; /* Espaço entre a logo e o texto */
    }

    .card-header img {
        flex-shrink: 0; /* Garante que a logo não diminua */
        margin: 0; /* Remove margens antigas */
    }

    .card-header-info {
        flex-grow: 1; /* Faz essa div ocupar todo o espaço restante */
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center; /* Centraliza o texto horizontalmente */
        text-align: center; /* Garante que o texto dentro fique centralizado */
        min-width: 0; /* Evita que textos longos quebrem o layout flex */
    }
    .card-header-info h4 {
        margin: 0;
        font-size: 1.1em;
        color: var(--cor-destaque);
    }
    .card-header-info p {
        margin: 4px 0 0;
        font-size: 0.8em;
        opacity: 0.8;
    }
    .card-reputacao {
        font-size: 0.9em;
        text-align: right;
    }
    .card-status {
        padding: 10px;
        border-radius: 8px;
        text-align: center;
        font-weight: 600;
    }
    .status-imediato {
        background-color: #4CAF50;
        color: white;
        animation: vaga-glow 1.5s ease-in-out infinite;
    }
    .status-manual {
        background-color: var(--cor-botoes);
    }
    .status-indisponivel {
        background-color: #555;
        opacity: 0.7;
    }
    .card-horarios-disponiveis {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
        margin-top: 8px;
    }
    .card-horarios-disponiveis span {
        background: #333;
        padding: 4px 8px;
        border-radius: 5px;
        font-size: 0.85em;
    }
    .card-servicos-title {
        font-size: 0.9em;
        font-weight: 600;
        margin-top: 8px;
        border-top: 1px solid var(--cor-borda);
        padding-top: 10px;
    }
    .card-servicos-list {
        font-size: 0.8em;
        opacity: 0.9;
        list-style-type: none;
        padding: 0;
        margin: 0;
    }
    .popup-section {
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--cor-borda);
    }
    .popup-section h4 {
        margin-top: 0;
        margin-bottom: 10px;
        color: var(--cor-destaque);
    }
    .selectable-item {
        background: var(--cor-botoes);
        border: 1px solid var(--cor-borda);
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
    }
    .selectable-item:hover {
        border-color: var(--cor-destaque);
    }
    .selectable-item.selected {
        background: var(--cor-destaque);
        color: var(--cor-fundo);
        border-color: var(--cor-destaque);
        font-weight: 600;
    }
    #barbeiroPerfilHorariosList {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        max-height: 150px;
        overflow-y: auto;
    }
    #barbeiroPerfilHorariosList .selectable-item {
        flex-grow: 1;
        text-align: center;
    }
    #modalBarbeiroPerfil .modal-footer {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid var(--cor-borda);
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }
    #chatPreview {
        position: absolute;
        top: -40px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(24, 24, 24, 0.8);
        color: var(--cor-texto-principal);
        padding: 5px 12px;
        border-radius: 10px;
        font-size: 12px;
        z-index: 5;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 90%;
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
        pointer-events: none;
    }
    #chatPreview.show {
        opacity: 1;
    }
    .conquista-item {
        display: flex;
        align-items: center;
        gap: 15px;
        background-color: var(--cor-botoes);
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 10px;
    }
    .conquista-item.unlocked {
        border-left: 5px solid var(--cor-destaque);
    }
    .conquista-item.locked {
        opacity: 0.5;
        border-left: 5px solid var(--cor-borda);
    }
    .conquista-icon {
        font-size: 2em;
    }
    .ranking-container {
        display: flex;
        gap: 20px;
        width: 100%;
    }
    .ranking-column {
        flex: 1;
        min-width: 0;
    }
    .ranking-column h4 {
        text-align: center;
        margin-bottom: 10px;
        color: var(--cor-destaque);
    }
    .ranking-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 5px;
        border-bottom: 1px solid var(--cor-borda);
        font-size: 14px;
    }
    .ranking-item:first-child {
        font-weight: bold;
        color: var(--cor-destaque);
    }
    .chat-medal {
        margin-right: 4px;
    }
    .app-footer {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        text-align: center;
        padding: 5px 0;
        font-size: 10px;
        color: var(--cor-texto-principal);
        opacity: 0.5;
        z-index: 5;
        pointer-events: none;
    }
    /* Estilos do Chat Fullscreen */
    #janelaChat.fullscreen {
        padding: 0;
        border-radius: 0;
    }
    #janelaChat.fullscreen .modal-content {
        width: 100%;
        height: 100%;
        max-width: 100%;
        border-radius: 0;
        display: flex;
        flex-direction: column;
    }
    #janelaChat.fullscreen #chatInput {
        margin-bottom: 0;
    }
    #janelaChat #carregarMaisMsgBtn {
        margin: 0;
        width: 100%;
        border-radius: 0;
        background-color: var(--cor-botoes);
    }
    /* Estilos do Portfólio */
    .portfolio-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px;
      padding: 10px;
      max-height: 70vh;
      overflow-y: auto;
    }
    .portfolio-grid img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid var(--cor-borda);
    }
    #modalPortfolioCliente .modal-content, #lojaView .modal-content {
        width: 100%;
        height: 100%;
        max-width: 100%;
        border-radius: 0;
        display: flex;
        flex-direction: column;
    }

/* Estilos para o novo gerenciador de portfólio do profissional */
#portfolioInputsContainer {
    display: grid;
    /* Cria um grid que se ajusta, mostrando quantas colunas de 120px couberem */
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); 
    gap: 10px;
    max-height: 400px; /* Aumentado de 250px para 400px para caber mais */
    overflow-y: auto;
    padding: 5px;
    background: var(--cor-fundo); /* Fundo para ver os cards */
    border-radius: 8px;
}
.portfolio-admin-item {
    border: 1px solid var(--cor-borda);
    border-radius: 8px;
    overflow: hidden; /* Para o input não vazar */
    background: var(--cor-botoes);
    display: flex;
    flex-direction: column;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
.portfolio-admin-item img {
    width: 100%;
    height: 100px;
    object-fit: cover;
    background: #333; /* Cor de fundo enquanto a imagem carrega */
    border-bottom: 1px solid var(--cor-borda);
}
.portfolio-admin-item input {
    width: 100%;
    border-radius: 0;
    margin: 0;
    border: none;
    font-size: 12px;
    padding: 8px;
    box-sizing: border-box; /* Garante que o padding não quebre o layout */
}

    /* Estilos da Loja */
    .loja-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        padding: 10px;
        flex-grow: 1;
        overflow-y: auto;
    }
    .produto-card {
        background: var(--cor-botoes);
        border-radius: 12px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        border: 1px solid var(--cor-borda);
        cursor: pointer;
    }
    .produto-card img {
        width: 100%;
        height: 150px;
        object-fit: cover;
    }
    .produto-info {
        padding: 10px;
        text-align: center;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    .produto-nome { font-weight: 600; font-size: 1em; }
    .produto-preco { font-size: 1.1em; color: var(--cor-destaque); margin-top: 5px; }
    .produto-preco-original { text-decoration: line-through; opacity: 0.7; font-size: 0.9em; }
    .produto-card button { font-size: 14px; padding: 8px; margin-top: 10px;}
    #lojaView .card-header { display: flex; justify-content: space-between; align-items: center; }
    #lojaView .card-header h3 { font-size: 1.1em; white-space: nowrap; }
    #lojaContainer h4 { font-size: 1.0em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .tamanho-options { display: flex; gap: 5px; justify-content: center; margin: 10px 0; }
    .tamanho-options label {
      padding: 5px 10px;
      border: 1px solid var(--cor-borda);
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    .tamanho-options input { display: none; }
    .tamanho-options input:checked + label {
      background: var(--cor-destaque);
      color: var(--cor-fundo);
      border-color: var(--cor-destaque);
    }
    .checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; }
    .checkbox-group label { display: flex; align-items: center; gap: 5px; }
    .checkbox-group input { width: auto; margin: 0; }

    .modal-venda {
      z-index: 99;
    }
    .modal-venda .modal-content {
      background: #c0392b;
      color: white;
      text-align: center;
      border: 3px solid #e74c3c;
      animation: flash-red 1.5s infinite;
    }
    .modal-venda h3 {
      color: white;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    @keyframes flash-red {
      0%, 100% { background-color: #c0392b; }
      50% { background-color: #e74c3c; }
    }
    
    /* NOVOS ESTILOS */
    .barbeiro-list-container {
      width: 100%;
      max-height: 70vh;
      overflow-y: auto;
      padding: 0 10px;
      box-sizing: border-box;
    }
    .promo-info {
      font-size: 0.8em;
      color: var(--cor-destaque);
      margin: 8px 0 0 0;
      padding-top: 8px;
      border-top: 1px dashed var(--cor-borda);
    }
    #pix-qrcode {
        max-width: 200px;
        margin: 15px auto;
        display: block;
        border: 5px solid white;
        border-radius: 10px;
    }
    .pix-copia-cola-container {
      position: relative;
    }
    .pix-copia-cola-container button {
        width: 100%;
    }
    #pixChaveAleatoria {
        display: none;
    }
    .metodos-grid {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-top: 20px;
    }
    #detalhesProdutoAvaliacao {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid var(--cor-borda);
    }
    .avaliacao-estrelas {
        font-size: 1.2em;
        color: var(--cor-destaque);
    }
    .avaliacao-comentario {
        font-style: italic;
        opacity: 0.8;
        margin-top: 5px;
        font-size: 0.9em;
        background: var(--cor-botoes);
        padding: 8px;
        border-radius: 8px;
    }
    /* Estilo para imagem de produto no popup */
    #detalhesProdutoImg {
        width: 100%;
        height: 250px;
        object-fit: contain; /* Garante que a imagem apareça inteira */
        border-radius: 10px;
        margin-bottom: 15px;
        background-color: var(--cor-botoes);
    }

/* ===================================================================== */
/* ====== INÍCIO: CSS PARA SCROLLBARS (COPIAR) ======================== */
/* ===================================================================== */

/* ===================================================================== */
/* ====== INÍCIO: CORREÇÃO LAYOUT E SCROLL (SUBSTITUIR) =============== */
/* ===================================================================== */

/* Adiciona scroll ao popup de perfil do profissional (para o cliente) */
#modalBarbeiroPerfil .modal-content {
    max-height: 90vh;
    overflow-y: auto;
}

/* --- CORREÇÃO DE LAYOUT E SCROLL DOS MODAIS DE ONBOARDING --- */
/* Garante que o conteúdo dos modais fique em coluna (um abaixo do outro) */
#modalOnboardingProfissionalServicos .modal-content,
#modalAddPromocao .modal-content, 
#modalOnboardingPromocoes .modal-content,
#modalOnboardingAgenda .modal-content,
#modalOnboardingLogomarca .modal-content,
#modalOnboardingPortfolio .modal-content {
    overflow-y: auto;
    max-height: 90vh;
    display: flex; 
    flex-direction: column; /* <-- ESTA É A CORREÇÃO PRINCIPAL */
}

/* Garante que a área de conteúdo (inputs, listas, etc.) possa rolar */
#modalOnboardingProfissionalServicos .modal-content,
#modalOnboardingAgenda .modal-content,
#modalOnboardingLogomarca .modal-content,
#modalOnboardingPortfolio .modal-content {
    overflow-y: auto; /* Adiciona scroll ao modal-content principal */
}

/* Para os modais de promoção (que têm um scrollable-list interno) */
#modalAddPromocao .scrollable-list, 
#modalOnboardingPromocoes .scrollable-list {
    overflow-y: auto;
    flex-grow: 1; /* Faz esta área crescer para ocupar o espaço */
    padding-right: 10px;
}
/* ===================================================================== */
/* ====== FIM: CORREÇÃO LAYOUT E SCROLL (SUBSTITUIR) ================== */
/* ===================================================================== */

    /* ESTILOS ADICIONAIS Nova Versão */
    #popupAguarde {
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        z-index: 101;
    }
    #popupAguarde .modal-content {
        background: transparent;
        box-shadow: none;
        border: none;
        text-align: center;
        font-size: 1.2em;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .spinner {
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top: 4px solid var(--cor-destaque);
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px auto;
    }
    .modal-fullscreen {
        align-items: flex-end; /* Alinha o modal na parte inferior */
        background: none;
    }
    .modal-fullscreen .modal-content {
        width: 100%;
        height: 90vh;
        max-width: 100%;
        border-radius: 20px 20px 0 0;
        animation: slide-up 0.5s ease-out;
    }
    @keyframes slide-up {
        from { transform: translateY(100%); }
        to { transform: translateY(0); }
    }
    #onboardingContent {
        text-align: center;
    }
    #onboardingContent img {
        max-width: 80%;
        height: auto;
        margin-bottom: 20px;
    }
    .interest-options button {
    background: var(--cor-botoes);
    border: 2px solid transparent;
    transition: all 0.3s ease; /* Adicionado para suavizar o efeito */
}
    .interest-options button.selected {
    border-color: var(--cor-destaque);
    background: var(--cor-destaque-ouro);
    color: var(--cor-fundo);
    box-shadow: 0 0 15px var(--cor-destaque-ouro); /* Adicionado para o efeito de brilho */
}
    .onboarding-background-img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0.15;
      z-index: -1;
      border-radius: 20px 20px 0 0;
    }
    .onboarding-content-wrapper {
      position: relative;
      z-index: 1;
      padding: 20px;
      color: white;
      text-shadow: 1px 1px 3px black;
    }

/* Adicionado para a tela de onboarding ficar cheia */
#modalOnboarding .modal-content {
    padding: 0;
    border-radius: 0;
    height: 100%;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background-image: linear-gradient(rgba(0,0,0, 0.7), rgba(0,0,0, 0.7)), url('https://i.postimg.cc/NjxQW6sm/ezgif-com-animated-gif-maker.gif');
    background-size: cover;
    background-position: center;
}

    @keyframes blink-animation {
      0%, 100% { background-color: var(--cor-botoes); }
      50% { background-color: var(--cor-destaque); }
    }
    .blinking-button.closed {
      animation: blink-animation 2s infinite;
    }
    .chat-tabs {
        display: flex;
        border-bottom: 1px solid var(--cor-borda);
        margin-bottom: 10px;
    }
    .chat-tab {
        flex: 1;
        text-align: center;
        padding: 10px;
        cursor: pointer;
        border-bottom: 3px solid transparent;
    }
    .chat-tab.active {
        border-bottom-color: var(--cor-destaque);
    }
    .config-section button.selected {
        background-color: var(--cor-destaque);
        color: var(--cor-fundo);
    }
.footer-contact a {
    color: inherit; /* Herda a cor do texto padrão */
    text-decoration: none;
    display: inline-block; /* Necessário para aplicar gradiente corretamente */
}

.animated-gradient-text {
    background: linear-gradient(90deg, var(--cor-destaque-prata), var(--cor-destaque-ouro), var(--cor-destaque-prata));
    background-size: 200% auto; /* Tamanho do gradiente para animação */
    color: transparent; /* Torna o texto transparente */
    -webkit-background-clip: text;
    background-clip: text;
    animation: gradient-animation 4s linear infinite;
    font-weight: 500; /* Um pouco mais de destaque */
}

@keyframes gradient-animation {
    0% { background-position: 200% center; }
    100% { background-position: 0% center; }
}

.online-counter {
    font-size: 14px;
    font-weight: 600;
    color: #2ecc71; /* Verde vivo */
    background-color: var(--cor-botoes);
    padding: 8px 12px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(46, 204, 113, 0.5);
    animation: pulse-green 2s infinite;
}

@keyframes pulse-green {
    0% { box-shadow: 0 0 5px rgba(46, 204, 113, 0.3); }
    50% { box-shadow: 0 0 15px rgba(46, 204, 113, 0.8); }
    100% { box-shadow: 0 0 5px rgba(46, 204, 113, 0.3); }
}

/* Feedback visual para admin poder deletar msg no chat */
.chat-message.admin-deletable {
    cursor: pointer;
    border: 1px dashed rgba(255, 0, 0, 0.3);
    transition: all 0.2s ease-in-out;
}
.chat-message.admin-deletable:hover {
    background-color: #4d1c1c; /* Fundo vermelho escuro no hover */
    border: 1px dashed rgba(255, 0, 0, 0.8);
}

.professional-name-card {
        margin: 0;
        font-size: 1.2em; /* Um pouco maior */
        font-weight: 700; /* Mais forte (Poppins 700) */
        color: var(--cor-destaque); /* Usa a cor do tema */
        text-shadow: 0 0 6px rgba(212, 175, 55, 0.4); /* Brilho sutil */
        transition: text-shadow 0.3s ease;
    }
    .barbeiro-card:hover .professional-name-card {
         text-shadow: 0 0 10px var(--cor-destaque); /* Brilho maior no hover */
    }

.card-reputacao-info {
        font-size: 0.9em;
        margin-top: 5px; /* Espaçamento do item acima (distância) */
        color: var(--cor-destaque); /* Cor dourada/tema */
    }
    .card-reputacao-info span {
        color: var(--cor-texto-principal); /* Cor do texto normal para o número */
        opacity: 0.8;
        font-size: 0.9em;
    }
.card-action-btn { /* Classe base para ações no card */
        position: absolute;
        bottom: 10px;
        background: rgba(0,0,0,0.6);
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 16px;
        z-index: 5;
        transition: transform 0.2s;
        color: var(--cor-texto-principal); /* Cor do ícone */
    }
    .card-action-btn:hover {
        transform: scale(1.1);
    }
    
    .card-favorite-btn {
        right: 10px; /* Coração na direita */
    }
    
    .card-share-btn {
        right: 50px; /* Link ao lado do Coração */
        font-size: 18px; 
    }
/* Agenda Visual Corrigida */
#horariosContainer {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); /* Botoes com tamanho fixo e responsivo */
    gap: 8px;
    justify-content: center;
    max-height: 300px;
    overflow-y: auto;
    padding: 10px;
    background: var(--cor-fundo);
    border-radius: 8px;
    border: 1px solid var(--cor-borda);
    margin-top: 10px;
}
/* Ajuste no botão de horário */
.horario-btn {
    width: 100% !important; /* Ocupa a célula do grid */
    margin: 0 !important;   /* Remove margem externa pois usamos gap */
    font-size: 13px;
    padding: 8px 2px;
}

    /* Scroll para a Agenda do Onboarding */
    #onboardingHorariosContainer {
        display: flex; 
        flex-wrap: wrap; 
        gap: 5px; 
        justify-content: center;
        max-height: 200px; /* Define uma altura máxima */
        overflow-y: auto; /* Adiciona o scroll vertical */
        padding: 5px;
        background: var(--cor-fundo);
        border-radius: 5px;
    }

/* --- NOVOS ESTILOS (FAVORITOS, PREMIUM, PERFIL, MOLDURAS) --- */

/* Botão Favoritos Estilizado */
.btn-favoritos-estilo {
    font-size: 14px !important;
    padding: 8px 16px !important;
    border-radius: 20px !important;
    font-weight: 600;
    margin: 10px auto;
    display: block;
    width: fit-content !important;
    transition: transform 0.2s;
    cursor: pointer;
}

.estilo-gold {
    background: linear-gradient(45deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
    color: #000 !important;
    border: 1px solid #aa771c !important;
    box-shadow: 0 0 10px rgba(191, 149, 63, 0.5);
}

.estilo-pink {
    background: linear-gradient(45deg, #ff9a9e, #fad0c4, #fad0c4);
    color: #4a0000 !important;
    border: 1px solid #ff9a9e !important;
    box-shadow: 0 0 10px rgba(255, 154, 158, 0.5);
}

/* Produto Premium na Loja */
.produto-premium {
    grid-column: 1 / -1; /* Ocupa toda a largura */
    background: radial-gradient(circle, #2c250e 0%, #000000 100%);
    border: 2px solid var(--cor-destaque-ouro);
    box-shadow: 0 0 20px rgba(212, 175, 55, 0.6);
    transform: scale(1.02);
    margin-bottom: 20px;
    animation: gold-pulse 2s infinite;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}
.produto-premium .produto-nome {
    font-size: 1.3em;
    color: var(--cor-destaque-ouro);
    text-transform: uppercase;
    letter-spacing: 1px;
    font-weight: bold;
    margin-top: 10px;
}
.produto-premium .produto-preco {
    font-size: 1.5em;
    font-weight: 800;
    color: #fff;
    text-shadow: 0 0 5px var(--cor-destaque-ouro);
    margin-bottom: 10px;
}

#modalMeuPerfil .modal-content {
    max-height: 90vh;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
}

/* Roleta Diária */
/* --- ROLETA FINAL (Visual + Seta Corrigida) --- */
.roleta-container {
    background: #111;
    border: 4px solid #d4af37;
    border-radius: 15px;
    height: 100px; 
    margin: 20px auto;
    position: relative; /* Importante para a seta */
    overflow: hidden;   /* Corta o que sai da caixa */
    width: 100%;
    max-width: 320px;
    box-shadow: inset 0 0 30px rgba(0,0,0,1); /* Sombra interna mais forte */
}

/* Sombras laterais (Fade) */
.roleta-container::before, .roleta-container::after {
    content: '';
    position: absolute;
    top: 0; bottom: 0; width: 60px; z-index: 2; pointer-events: none;
}
.roleta-container::before { left: 0; background: linear-gradient(to right, #000, transparent); }
.roleta-container::after { right: 0; background: linear-gradient(to left, #000, transparent); }

.roleta-faixa {
    display: flex;
    height: 100%;
    align-items: center;
    will-change: transform;
}

.roleta-item {
    /* MEDIDA EXATA: 80px + 5px margem esq + 5px margem dir = 90px TOTAL */
    width: 80px; 
    height: 80px;
    margin: 0 5px; 
    flex-shrink: 0;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 32px; /* Fonte maior */
    font-weight: 900;
    font-family: 'Arial Black', sans-serif;
    box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
    border: 2px solid rgba(255,255,255,0.2);
}

/* Cores Vivas */
.tema-barbearia .roleta-item:nth-child(odd) { background: #ffcc00; color: #000; }
.tema-barbearia .roleta-item:nth-child(even) { background: #1a1a1a; color: #ffcc00; border-color: #ffcc00; }
.tema-feminino .roleta-item:nth-child(odd) { background: #ff6b81; color: #fff; }
.tema-feminino .roleta-item:nth-child(even) { background: #1a1a1a; color: #ff6b81; border-color: #ff6b81; }
.roleta-item.especial { background: #fff !important; color: #333 !important; border: 3px solid gold; }

@keyframes pulse-glow {
    from { box-shadow: 0 0 5px rgba(255,255,255,0.5); }
    to { box-shadow: 0 0 20px rgba(255,255,255,1); }
}

/* Indicador de Seleção na Moldura */
.moldura-check {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #2ecc71;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    z-index: 2;
}
.roleta-faixa {
    display: flex; /* Flexbox para alinhar os itens */
    height: 100%;
    align-items: center; /* Centraliza verticalmente */
    will-change: transform; /* Otimiza performance */
}

/* Temas da Roleta */
.tema-barbearia .roleta-item:nth-child(odd) { background: var(--cor-destaque-ouro); color: #000; }
.tema-barbearia .roleta-item:nth-child(even) { background: #000; color: var(--cor-destaque-ouro); }
.tema-feminino .roleta-item:nth-child(odd) { background: var(--cor-destaque-rosa); color: #000; }
.tema-feminino .roleta-item:nth-child(even) { background: #000; color: var(--cor-destaque-rosa); }
.roleta-item.especial { background: #fff !important; color: #000 !important; box-shadow: 0 0 15px #fff; }


/* Molduras */
.moldura-item {
    transition: transform 0.1s, border-color 0.2s;
    -webkit-tap-highlight-color: transparent; /* Remove o fundo azul/cinza no mobile */
    outline: none; /* Remove borda de foco */
    user-select: none; /* Impede seleção de texto */
}
.moldura-item:active, .moldura-item:focus {
    background-color: transparent !important; /* Garante que não tenha fundo */
}
/* O checkmark agora é controlado por uma classe 'temp-selected' via JS para feedback instantâneo */
.moldura-item.temp-selected .moldura-check {
    display: flex !important;
    animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.moldura-item:not(.temp-selected):not(.selecionada) .moldura-check {
    display: none;
}

@keyframes popIn {
    from { transform: scale(0); }
    to { transform: scale(1); }
}
.moldura-item.comprada { border-color: #4CAF50; }
.moldura-item.selecionada { border-color: var(--cor-destaque); }

.moldura-item.temp-selected {
    border-color: var(--cor-destaque) !important;
    transform: scale(1.05);
}
/* Molduras Visuais */
.avatar-frame-bronze { border: 3px solid #cd7f32; box-shadow: 0 0 5px #cd7f32; }
.avatar-frame-prata { border: 3px solid #c0c0c0; box-shadow: 0 0 8px #c0c0c0; }
.avatar-frame-ouro { border: 3px solid #ffd700; box-shadow: 0 0 10px #ffd700; animation: gold-pulse 2s infinite; }
.avatar-frame-diamante { border: 3px solid #b9f2ff; box-shadow: 0 0 12px #b9f2ff, inset 0 0 10px #b9f2ff; animation: flash-blue 1.5s infinite; }

@keyframes flash-blue { 0%, 100% { box-shadow: 0 0 12px #b9f2ff; } 50% { box-shadow: 0 0 20px #fff; } }

/* Foto no Chat */
.chat-user-photo {
    width: 24px; height: 24px;
    border-radius: 50%;
    vertical-align: middle;
    margin-right: 5px;
    object-fit: cover;
    border: 1px solid #555;
    cursor: pointer;
}

/* Popup Perfil Bonito */
.perfil-visualizacao {
    text-align: center;
    background-size: cover;
    background-position: center;
    position: relative;
    overflow: hidden;
}
.perfil-visualizacao::before {
    content: ''; position: absolute; top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.85); z-index: 0;
}
.perfil-visualizacao-content { position: relative; z-index: 1; padding: 20px; }
.perfil-foto-grande {
    width: 120px; height: 120px;
    border-radius: 50%;
    object-fit: cover;
    margin-bottom: 10px;
}

/* Inversão Botões Rodapé */
.bottom-buttons-container {
    display: flex;
    flex-direction: column-reverse; /* Sair embaixo, Denuncia em cima */
    align-items: flex-start;
    position: fixed;
    bottom: 12px; left: 12px;
    gap: 15px;
    z-index: 15;
    width: auto;
}
/* Reset de posições antigas para funcionar no novo container */
#btnSair { position: static !important; margin: 0 !important; }
#btnDenuncia { position: static !important; margin: 0 !important; }
/* Botão Chat Fixo na Direita */
/* === CORREÇÃO BOTÃO CHAT (RESGATE) === */
#btnChat {
    position: fixed !important;
    bottom: 20px !important;
    right: 20px !important;
    left: auto !important; /* Garante que não fique na esquerda */
    z-index: 1000 !important; /* Z-index altíssimo para ficar acima de tudo */
    display: flex !important;
    align-items: center;
    justify-content: center;
    
    /* Estilo Visual para garantir visibilidade */
    background-color: rgba(0, 0, 0, 0.6) !important; /* Fundo escuro translúcido */
    border: 1px solid var(--cor-destaque) !important; /* Borda na cor do tema */
    border-radius: 50% !important;
    width: 50px !important;
    height: 50px !important;
    box-shadow: 0 4px 10px rgba(0,0,0,0.5) !important;
    
    /* Texto/Emoji */
    font-size: 24px !important;
    line-height: 1 !important;
    padding: 0 !important;
    margin: 0 !important;
    cursor: pointer;
}

/* Garante que o emoji dentro não seja afetado por outros estilos */
#btnChat span {
    pointer-events: none;
    display: block;
}

/* Ajuste da bolinha de notificação */
.notification-badge {
    position: absolute !important;
    top: -5px !important;
    right: -5px !important;
    background-color: #e74c3c !important; /* Vermelho forte */
    color: white !important;
    border-radius: 50%;
    padding: 4px 7px !important;
    font-size: 11px !important;
    font-weight: bold;
    border: 2px solid #fff;
    z-index: 1002; /* Acima do botão do chat */
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    display: none; /* Começa oculto */
}
.notification-badge.visible {
    display: block !important;
    animation: pulse-red 2s infinite;
}

#btnChat .notification-badge {
    position: absolute !important;
    top: -5px !important;
    right: -5px !important;
    background-color: #e74c3c !important;
    color: white !important;
    border-radius: 50%;
    padding: 4px 7px !important;
    min-width: 18px; /* Garante bolinha redonda */
    text-align: center;
    font-size: 11px !important;
    font-weight: bold;
    border: 2px solid #fff;
    z-index: 1002;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    display: none; /* Começa oculto */
}
#btnChat .notification-badge.visible {
    display: block !important;
    animation: pulse-red 2s infinite;
}
@keyframes pulse-red {
    0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
    70% { box-shadow: 0 0 0 6px rgba(231, 76, 60, 0); }
    100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
}

/* Botão Admin Premium */
.btn-admin-premium {
    background: linear-gradient(45deg, #000, #d4af37);
    border: 1px solid #d4af37;
    color: #fff;
    width: 100%;
    margin-bottom: 10px;
    font-weight: bold;
}

/* === CORREÇÃO DE LAYOUT (CSS FIX) === */

/* 1. Forçar centralização da tela inteira */
body {
    display: flex;
    flex-direction: column;
    align-items: center !important; /* Garante que tudo fique no meio horizontalmente */
    overflow-x: hidden; /* Impede barra de rolagem lateral */
    width: 100%;
}

/* 2. Arrumar o container principal */
.content-container {
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    width: 100% !important;
    max-width: 500px !important; /* Mantém o formato de app */
    margin: 0 auto !important; /* Centraliza o bloco na tela */
    padding-top: 70px !important; /* Espaço para a Topbar não cobrir o conteúdo */
    position: relative;
}

/* 3. Consertar os Cards (Admin, Cliente, etc) */
.card {
    width: 92% !important; /* Garante margem nas laterais */
    max-width: 480px !important;
    margin: 10px auto !important; /* Centraliza o card */
    box-sizing: border-box; /* Evita que o padding estoure a largura */
}

/* 4. Ajustar a Topbar para caber tudo */
.topbar {
    justify-content: space-between !important;
    padding: 0 8px !important; /* Reduz padding lateral */
    width: 100%;
    box-sizing: border-box;
    z-index: 100; /* Garante que fique acima de tudo */
}

.topbar-right {
    gap: 5px !important; /* Diminui espaço entre ícones para não vazar */
    flex-wrap: nowrap !important; /* Impede que os ícones caiam pra linha de baixo */
}

/* Ajuste de tamanho dos botões da Topbar para telas pequenas */
.topbar-right button {
    font-size: 18px !important; /* Levemente menor */
    padding: 5px !important;
}

#onlineUserCount {
    font-size: 12px !important;
    padding: 4px 8px !important;
    white-space: nowrap; /* Texto não quebra */
}

/* 5. Consertar Botões Inferiores (Sair e Denúncia) */
.bottom-buttons-container {
    position: fixed !important;
    bottom: 20px !important;
    left: 20px !important;
    display: flex !important;
    flex-direction: column-reverse !important; /* Sair em baixo, Denúncia em cima */
    gap: 15px !important;
    z-index: 99;
    align-items: center;
}

/* 6. Ajuste do Painel Admin (Botões cortados) */
#adminView > div {
    justify-content: center !important; /* Centraliza os botões do admin */
}
#adminView button {
    flex-grow: 1; /* Faz botões ocuparem espaço igual */
    min-width: 130px; /* Tamanho mínimo para não cortar texto */
    margin: 5px !important;
}

@keyframes brilhoMetalico {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

/* Garante que modais de confirmação fiquem acima do popup de agendamento (9999) */
#modalConfirmacaoGenerica, 
#modalPopupGenerico, 
#modalBloqueante {
    z-index: 10000 !important;
}

/* --- SETAS EXTERNAS DA ROLETA --- */
.roleta-wrapper-externo {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    margin: 10px 0; /* Espaçamento geral */
}

.seta-externa {
    width: 0; 
    height: 0; 
    border-left: 10px solid transparent; /* Largura da base da seta */
    border-right: 10px solid transparent;
    z-index: 15; /* Garante que fique acima de sombras */
}

.seta-externa.topo {
    /* Seta de Cima: Aponta para BAIXO */
    border-top: 15px solid var(--cor-destaque); 
    margin-bottom: 2px; /* Cola na roleta */
    filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5));
}

.seta-externa.baixo {
    /* Seta de Baixo: Aponta para CIMA */
    border-bottom: 15px solid var(--cor-destaque);
    margin-top: 2px; /* Cola na roleta */
    filter: drop-shadow(0 -2px 2px rgba(0,0,0,0.5));
}

/* Garante que o Modal de Confirmação e o Bloqueante fiquem ACIMA de tudo */
#modalConfirmacaoGenerica, 
#modalBloqueante,
#modalPopupGenerico {
    z-index: 10000 !important; /* Maior que o modal de agendamento (9999) */
}

/* Garante que o fundo escuro desses modais também fique acima */
#modalConfirmacaoGenerica.show,
#modalBloqueante.show {
    background: rgba(0,0,0,0.95); /* Fundo bem escuro para focar */
}

/* ============================================================ */
/* === MOLDURAS PREMIUM (CORRIGIDO: ASAS NO CHAT) === */
/* ============================================================ */

/* --- ESTRUTURA BASE --- */
.avatar-wrapper {
    position: relative;
    display: inline-flex;
    justify-content: center;
    align-items: center;
    z-index: 1;
    vertical-align: middle;
    overflow: visible !important; /* Permite asas para fora */
}

/* Foto do Usuário (Chat e Geral) */
.chat-user-photo {
    position: relative;
    z-index: 20; /* Foto acima das asas */
    object-fit: cover;
    background: #000;
    display: block;
    box-sizing: border-box;
}

/* Foto do Usuário (Popup Grande) - Z-Index Alto */
.perfil-foto-grande {
    position: relative;
    z-index: 25 !important; /* Foto acima da asa no popup */
    object-fit: cover;
    background: #000;
    display: block;
}

/* Coroa (Comum a todas) */
.coroa-topo {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    z-index: 30; /* Coroa acima de tudo */
    background: transparent;
    filter: drop-shadow(0 2px 2px rgba(0,0,0,0.8));
    pointer-events: none;
}
.coroa-topo::after {
    content: '';
    position: absolute;
    bottom: 0; left: 0; width: 100%; height: 100%;
    clip-path: polygon(5% 100%, 0% 30%, 25% 50%, 50% 0%, 75% 50%, 100% 30%, 95% 100%);
}

/* 2. TAMANHO POPUP (Grande - 120px) */
.avatar-wrapper.popup-size {
    width: 120px; height: 120px;
    margin: 15px auto 20px auto; 
}
.avatar-wrapper.popup-size .perfil-foto-grande {
    width: 100%; height: 100%;
    border-radius: 50%; padding: 3px;
}
.avatar-wrapper.popup-size .coroa-topo {
    width: 40px; height: 26px; top: -30px;
}

/* 3. TAMANHO LOJA (Médio - 60px) */
.avatar-wrapper.shop-size {
    width: 60px; height: 60px;
}
.avatar-wrapper.shop-size div[class*="avatar-frame"] { 
    z-index: 20; position: relative; 
}
.avatar-wrapper.shop-size .coroa-topo {
    width: 20px; height: 14px; top: -16px;
}

/* --- ESTILOS DOS NÍVEIS --- */

/* NÍVEL 1: BRONZE */
.avatar-wrapper.bronze .chat-user-photo,
.avatar-wrapper.bronze .perfil-foto-grande,
.avatar-wrapper.bronze .avatar-frame-bronze {
    background: linear-gradient(45deg, #804a00, #cd7f32);
    box-shadow: 0 0 0 2px #804a00; 
}
.avatar-wrapper.bronze .coroa-topo::after { background: linear-gradient(to bottom, #ffcc80, #cd7f32); }

/* NÍVEL 2: PRATA */
.avatar-wrapper.prata .chat-user-photo,
.avatar-wrapper.prata .perfil-foto-grande,
.avatar-wrapper.prata .avatar-frame-prata {
    background: linear-gradient(135deg, #fff, #c0c0c0, #777);
    box-shadow: 0 0 0 2px #777;
    animation: brilhoMetalico 3s infinite;
}
.avatar-wrapper.prata .coroa-topo::after { background: linear-gradient(to bottom, #fff, #999); }

/* NÍVEL 3: OURO */
.avatar-wrapper.ouro .chat-user-photo,
.avatar-wrapper.ouro .perfil-foto-grande,
.avatar-wrapper.ouro .avatar-frame-ouro {
    background: linear-gradient(45deg, #bf953f, #fcf6ba, #aa771c);
    box-shadow: 0 0 0 2px #aa771c, 0 0 10px rgba(255, 215, 0, 0.6);
    animation: brilhoDourado 2s infinite alternate;
}
.avatar-wrapper.ouro .coroa-topo::after { background: linear-gradient(to bottom, #fff7cc, #ffd700, #b8860b); }

/* --- NÍVEL 4: DIAMANTE (ASAS REVISADAS) --- */

.avatar-wrapper.diamante .chat-user-photo, 
.avatar-wrapper.diamante .perfil-foto-grande,
.avatar-wrapper.diamante .avatar-frame-diamante {
    background: transparent; 
    border: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 0 15px rgba(0, 198, 255, 0.9), inset 0 0 10px rgba(0, 198, 255, 0.5); 
}

.avatar-wrapper.diamante .coroa-topo::after {
    background: linear-gradient(to bottom, #e0ffff, #00c6ff);
}

/* ASAS (Cristal Afiado) */
.avatar-wrapper.diamante::before {
    content: '';
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    z-index: 0; /* Atrás da foto */
    
    background: linear-gradient(90deg, rgba(0,198,255,0) 0%, rgba(0,198,255,0.8) 20%, rgba(0,198,255,1) 50%, rgba(0,198,255,0.8) 80%, rgba(0,198,255,0) 100%);
    
    clip-path: polygon(
        0% 10%, 20% 30%, 5% 50%, 35% 55%, 
        50% 50%, 
        65% 55%, 95% 50%, 80% 30%, 100% 10%, 
        60% 40%, 50% 20%, 40% 40%
    );
    
    animation: asa-cristal-flutuar 3s ease-in-out infinite;
}

/* AJUSTE: Asa no CHAT (Agora visível e proporcional) */
.avatar-wrapper.chat-size.diamante::before {
    display: block;
    width: 54px;  /* Mais largo que os 32px da foto */
    height: 22px;
    top: 50%;
    opacity: 1;
    /* Ajuste fino para centralizar perfeitamente atrás da bolinha */
    transform: translate(-50%, -50%); 
}

/* AJUSTE: Asa no POPUP (Distante do centro) */
.avatar-wrapper.popup-size.diamante::before {
    width: 280px; height: 120px;
    top: 50%;
    transform: translate(-50%, -60%);
    filter: drop-shadow(0 0 10px #00c6ff);
}

/* AJUSTE: Asa na LOJA (Visível) */
.avatar-wrapper.shop-size.diamante::before {
    width: 130px; height: 50px;
    top: 50%;
    transform: translate(-50%, -50%);
    opacity: 1;
}

@keyframes asa-cristal-flutuar {
    0%, 100% { opacity: 0.8; transform: translate(-50%, -50%) scale(1); }
    50% { opacity: 1; transform: translate(-50%, -50%) scale(1.05); }
}

@keyframes pulse-wings {
    0%, 100% { opacity: 0.6; transform: translate(-50%, -50%) scale(1); }
    50% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
}

/* --- CORREÇÃO: Container de Scroll das Molduras (Estilo Caixa/Roleta) --- */
.molduras-scroll-container {
    display: flex;
    overflow-x: auto; /* Permite rolar para o lado */
    overflow-y: hidden;
    gap: 15px;
    padding: 15px;
    background: #1a1a1a; /* Fundo da caixa */
    border: 1px solid var(--cor-borda);
    border-radius: 12px;
    margin-top: 10px;
    white-space: nowrap; /* Garante que fiquem em linha */
    box-shadow: inset 0 0 10px #000; /* Sombra interna para profundidade */
    align-items: center; /* Centraliza verticalmente */
}

/* Barra de rolagem mais bonita para o carrossel */
.molduras-scroll-container::-webkit-scrollbar {
    height: 6px;
}
.molduras-scroll-container::-webkit-scrollbar-thumb {
    background: var(--cor-destaque);
    border-radius: 3px;
}
.molduras-scroll-container::-webkit-scrollbar-track {
    background: #333;
}

/* --- CORREÇÃO: Wrapper da Moldura no CHAT (Pequeno e Alinhado) --- */
.avatar-wrapper.chat-size {
    width: 32px; 
    height: 32px;
    margin-right: 15px; /* Aumentei a margem para a asa não bater no nome */
    margin-left: 8px;   /* Espaço na esquerda para a asa */
    vertical-align: middle; 
    display: inline-flex; 
    position: relative;
    justify-content: center;
    align-items: center;
    overflow: visible !important; /* IMPORTANTE: Permite que a asa saia da caixinha */
}

.avatar-wrapper.chat-size .chat-user-photo {
    width: 100% !important;
    height: 100% !important;
    border-radius: 50%;
    padding: 1px;
    margin: 0;
    display: block;
    position: relative;
    z-index: 10; /* Foto acima da asa */
}

.avatar-wrapper.chat-size .coroa-topo {
    width: 16px; 
    height: 10px; 
    top: -10px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 15; /* Coroa acima da foto */
}

/* Garante que as asas (::before) apareçam */
.avatar-wrapper.chat-size::before {
    display: block !important;
    z-index: 0; /* Asa atrás da foto */
}

/* Removemos aura giratória pesada no chat pequeno para não poluir,
   mas mantemos o brilho da borda definido nas classes .ouro, .diamante etc */
.avatar-wrapper.chat-size::after, 
.avatar-wrapper.chat-size::before {
    display: none; 
}

/* --- CORREÇÃO: Wrapper da Moldura no POPUP (Grande) --- */
.avatar-wrapper.popup-size {
    width: 120px;
    height: 120px;
    margin: 0 auto 15px auto;
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
}

.avatar-wrapper.popup-size .perfil-foto-grande {
    width: 100%;
    height: 100%;
    padding: 3px;
    border-radius: 50%;
    display: block;
}

.avatar-wrapper.popup-size .coroa-topo {
    width: 50px;
    height: 30px;
    top: -35px;
    left: 50%;
    transform: translateX(-50%);
}

/* --- MOLDURAS ADMIN (BASEADA NA DIAMANTE) --- */

/* 1. SUPREME BLACK (PRETA) */
.avatar-wrapper.admin_black .chat-user-photo, 
.avatar-wrapper.admin_black .perfil-foto-grande,
.avatar-wrapper.admin_black .avatar-frame-admin-black {
    background: transparent; 
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.9), inset 0 0 10px rgba(50, 50, 50, 0.8); 
}
.avatar-wrapper.admin_black .coroa-topo::after {
    background: linear-gradient(to bottom, #444, #000); /* Coroa Preta */
}
/* Asas Pretas/Sombrias */
.avatar-wrapper.admin_black::before {
    content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 0;
    background: linear-gradient(90deg, rgba(0,0,0,0) 0%, rgba(0,0,0,0.9) 20%, rgba(20,20,20,1) 50%, rgba(0,0,0,0.9) 80%, rgba(0,0,0,0) 100%);
    clip-path: polygon(0% 10%, 20% 30%, 5% 50%, 35% 55%, 50% 50%, 65% 55%, 95% 50%, 80% 30%, 100% 10%, 60% 40%, 50% 20%, 40% 40%);
    animation: asa-sombria-flutuar 3s ease-in-out infinite;
}

/* 2. SUPREME RED (VERMELHA) */
.avatar-wrapper.admin_red .chat-user-photo, 
.avatar-wrapper.admin_red .perfil-foto-grande,
.avatar-wrapper.admin_red .avatar-frame-admin-red {
    background: transparent; 
    border: 1px solid rgba(255, 0, 0, 0.3);
    box-shadow: 0 0 15px rgba(231, 76, 60, 0.9), inset 0 0 10px rgba(192, 57, 43, 0.5); 
}
.avatar-wrapper.admin_red .coroa-topo::after {
    background: linear-gradient(to bottom, #ff6b6b, #c0392b); /* Coroa Vermelha */
}
/* Asas de Fogo */
.avatar-wrapper.admin_red::before {
    content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 0;
    background: linear-gradient(90deg, rgba(231,76,60,0) 0%, rgba(231,76,60,0.8) 20%, rgba(192,57,43,1) 50%, rgba(231,76,60,0.8) 80%, rgba(231,76,60,0) 100%);
    clip-path: polygon(0% 10%, 20% 30%, 5% 50%, 35% 55%, 50% 50%, 65% 55%, 95% 50%, 80% 30%, 100% 10%, 60% 40%, 50% 20%, 40% 40%);
    animation: asa-fogo-flutuar 3s ease-in-out infinite;
}

/* Animações Específicas e Ajustes de Tamanho */
@keyframes asa-sombria-flutuar {
    0%, 100% { opacity: 0.7; transform: translate(-50%, -50%) scale(1); filter: drop-shadow(0 0 5px black); }
    50% { opacity: 1; transform: translate(-50%, -50%) scale(1.05); filter: drop-shadow(0 0 15px black); }
}
@keyframes asa-fogo-flutuar {
    0%, 100% { opacity: 0.7; transform: translate(-50%, -50%) scale(1); filter: drop-shadow(0 0 5px red); }
    50% { opacity: 1; transform: translate(-50%, -50%) scale(1.05); filter: drop-shadow(0 0 15px red); }
}

/* Ajustes de Tamanho para as Asas Admin (Igual Diamante) */
.avatar-wrapper.chat-size.admin_black::before, .avatar-wrapper.chat-size.admin_red::before {
    display: block; width: 54px; height: 22px; top: 50%; opacity: 1; transform: translate(-50%, -50%);
}
.avatar-wrapper.popup-size.admin_black::before, .avatar-wrapper.popup-size.admin_red::before {
    width: 280px; height: 120px; top: 50%; transform: translate(-50%, -60%);
}
.avatar-wrapper.shop-size.admin_black::before, .avatar-wrapper.shop-size.admin_red::before {
    width: 130px; height: 50px; top: 50%; transform: translate(-50%, -50%); opacity: 1;
}

/* Correção para listas horizontais no perfil */
.molduras-scroll-container {
    display: flex;
    overflow-x: auto;
    gap: 15px;
    padding: 15px;
    background: #111;
    border: 1px solid var(--cor-borda);
    border-radius: 12px;
    margin-top: 10px;
    min-height: 130px; /* Altura mínima garantida */
    align-items: center;
}

/* --- CORREÇÃO ROLETA (CSS) --- */
.roleta-container {
    background: #0a0a0a;
    border: 4px solid #d4af37;
    border-radius: 15px;
    height: 100px; 
    margin: 20px auto;
    position: relative;
    overflow: hidden;
    width: 320px; /* Largura fixa para garantir a matemática */
    box-shadow: inset 0 0 30px rgba(0,0,0,1);
}

.roleta-faixa {
    display: flex;
    height: 100%;
    align-items: center;
    will-change: transform;
    /* A transição será injetada via JS */
}

/* O item tem 90px TOTAL (80 largura + 5 margem esq + 5 margem dir) */
.roleta-item {
    width: 80px; 
    height: 80px;
    margin: 0 5px; 
    flex-shrink: 0; /* ISSO É CRUCIAL: Impede que o item esmague */
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px; 
    font-weight: 900;
    background: #1a1a1a;
    color: #fff;
    border: 1px solid #333;
    box-sizing: border-box;
    position: relative;
    overflow: hidden; /* Para conter os efeitos internos */
}

/* Estilos Específicos dos Itens da Roleta */
.roleta-item.ponto { color: #eee; }
.roleta-item.premio-top { background: #111; border: 1px solid gold; }
.roleta-item.caixa { background: #c0392b; border: 2px solid #e74c3c; animation: pulse-red 1s infinite; }

/* --- PREVIEWS REAIS DENTRO DA ROLETA --- */
.mini-moldura-preview {
    width: 50px; height: 50px; 
    border-radius: 50%; 
    background: url('https://via.placeholder.com/50/000000/FFFFFF/?text=VC') center/cover;
    position: relative;
}
.mini-balao-preview {
    width: 60px; height: 40px;
    display: flex; align-items: center; justify-content: center;
    font-size: 10px;
    border-radius: 8px;
}

/* ============================================================
   ESTILOS COMPLETOS DOS BALÕES DE CHAT (FINAL)
   ============================================================ */

/* --- BASE PARA TODOS OS BALÕES CUSTOMIZADOS --- */
.chat-message.custom-bubble {
    position: relative;
    border: 1px solid transparent;
    transition: all 0.3s;
    /* 'isolation' cria um novo contexto de empilhamento.
       Isso impede que os efeitos de fundo (z-index -1) fiquem atrás do container do chat */
    isolation: isolate; 
    z-index: 1;
    /* Sombra preta forte para garantir que a letra branca apareça em qualquer fundo */
    text-shadow: 1px 1px 2px #000000, 0 0 5px #000000;
    font-weight: 600;
}

/* ============================================================
   NÍVEL 1: BRONZE (Sólido, Simples)
   ============================================================ */
.chat-message.bubble-bronze {
    border: 1px solid #cd7f32;
    background: linear-gradient(145deg, #5c3a1e, #2a1a0a);
    box-shadow: 1px 1px 3px rgba(0,0,0,0.5);
    color: #ffdcb0 !important;
}
/* Garante limpeza */
.chat-message.bubble-bronze::before, 
.chat-message.bubble-bronze::after { display: none !important; }


/* ============================================================
   NÍVEL 2: PRATA (Metálico Fosco - SEM ANIMAÇÃO DE MOVIMENTO)
   Correção: Fundo aplicado direto no elemento para não bugar.
   ============================================================ */
.chat-message.bubble-prata {
    border: 1px solid #a0a0a0;
    /* Gradiente cinza metálico chumbo */
    background: linear-gradient(145deg, #7f7f7f, #2a2a2a);
    box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    color: #ffffff !important; /* Texto Branco Puro */
}
.chat-message.bubble-prata::before, 
.chat-message.bubble-prata::after { display: none !important; }


/* ============================================================
   NÍVEL 3: OURO (Valioso - COM BRILHO NO FUNDO)
   Correção: Animação direta no background-position.
   ============================================================ */
.chat-message.bubble-ouro {
    border: 1px solid #FFD700;
    /* Gradiente dourado com uma faixa clara no meio */
    background: linear-gradient(110deg, #4b3b00 20%, #b88a00 40%, #fff8db 50%, #b88a00 60%, #4b3b00 80%);
    background-size: 200% 100%; /* Tamanho dobrado para permitir o movimento */
    color: #fff !important;
    box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
    animation: shine-gold 4s linear infinite; /* Brilho passando */
}
.chat-message.bubble-ouro::before, 
.chat-message.bubble-ouro::after { display: none !important; }


/* ============================================================
   NÍVEL 4: DIAMANTE (Movimento LENTO - 15s)
   ============================================================ */
.chat-message.bubble-diamante {
    background: #000 !important; /* Fundo PRETO sólido atrás do texto */
    color: #e0ffff !important; 
    border: none; 
    overflow: visible !important; /* Permite a coroa sair pra fora */
    margin-top: 12px !important; /* Espaço para a coroa */
}
/* Borda Animada (Fica atrás do fundo preto graças ao z-index -1 e isolation) */
.chat-message.bubble-diamante::before {
    content: ''; position: absolute;
    top: -2px; left: -2px; right: -2px; bottom: -2px;
    border-radius: 14px; 
    z-index: -1; 
    background: linear-gradient(60deg, #00c6ff, #0072ff, #000, #000, #00c6ff);
    background-size: 300% 300%;
    animation: border-travel 15s linear infinite; /* LENTO */
    opacity: 0.8;
}
/* Coroa */
.chat-message.bubble-diamante::after {
    content: '👑'; position: absolute; top: -14px; right: -5px; font-size: 14px;
    animation: float-crown 4s ease-in-out infinite;
}


/* ============================================================
   ADMIN BLACK (Movimento LENTO - 15s)
   ============================================================ */
.chat-message.bubble-admin-black {
    background: #000 !important;
    color: #ffffff !important; 
    border: none;
    overflow: visible !important;
    margin-top: 12px !important;
}
.chat-message.bubble-admin-black::before {
    content: ''; position: absolute;
    top: -2px; left: -2px; right: -2px; bottom: -2px;
    border-radius: 14px; z-index: -1;
    /* Gradiente Preto/Branco viajando */
    background: linear-gradient(60deg, #ffffff, #333, #000, #000, #ffffff);
    background-size: 300% 300%;
    animation: border-travel 15s linear infinite; /* LENTO */
}
.chat-message.bubble-admin-black::after {
    content: '👑'; position: absolute; top: -14px; right: -5px; font-size: 14px;
    filter: grayscale(100%); /* Coroa Cinza */
    animation: float-crown 4s ease-in-out infinite;
}


/* ============================================================
   ADMIN RED (Movimento LENTO - 12s)
   ============================================================ */
.chat-message.bubble-admin-red {
    background: #1a0000 !important; 
    color: #ffe0e0 !important; 
    border: none;
    overflow: visible !important;
    margin-top: 12px !important;
}
.chat-message.bubble-admin-red::before {
    content: ''; position: absolute;
    top: -2px; left: -2px; right: -2px; bottom: -2px;
    border-radius: 14px; z-index: -1;
    /* Gradiente Vermelho Fogo viajando */
    background: linear-gradient(60deg, #ff0000, #ff4500, #2c0000, #2c0000, #ff0000);
    background-size: 300% 300%;
    animation: border-travel 12s linear infinite; /* LENTO */
}
.chat-message.bubble-admin-red::after {
    content: '👑'; position: absolute; top: -14px; right: -5px; font-size: 14px;
    filter: sepia(100%) saturate(1000%) hue-rotate(-50deg); /* Coroa Vermelha */
    animation: float-crown 4s ease-in-out infinite;
}


/* ============================================================
   ANIMAÇÕES GERAIS
   ============================================================ */
@keyframes border-travel {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}
@keyframes float-crown {
    0%, 100% { transform: translateY(0) rotate(5deg); }
    50% { transform: translateY(-3px) rotate(-5deg); }
}
@keyframes shine-gold {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

/* ============================================================
   FIX: DESTAQUE DA ASA PRETA NO POPUP (CONTRASTE)
   ============================================================ */

/* 1. Cria uma "luz" radial atrás do avatar para separar do fundo preto */
.avatar-wrapper.popup-size.admin_black {
    /* Brilho difuso branco atrás do conjunto todo */
    box-shadow: 0 0 50px 15px rgba(255, 255, 255, 0.25);
    /* Fundo radial sutil para dar profundidade */
    background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%);
    border-radius: 50%;
}

/* 2. Reforça o contorno branco na própria asa para definição máxima */
.avatar-wrapper.popup-size.admin_black::before {
    /* Drop-shadow branco intenso e nítido ao redor da asa preta */
    filter: drop-shadow(0 0 5px rgba(255, 255, 255, 1)) drop-shadow(0 0 15px rgba(255, 255, 255, 0.5)) !important;
}
  </style>
</head>
<body>

<div id="popupAguarde" class="modal" onclick="fecharAguarde(event)">
  <div class="modal-content">
    <div class="spinner"></div>
    <span id="popupAguardeTexto">Aguarde...</span>
  </div>
</div>

<div id="modalOnboarding" class="modal modal-fullscreen">
  <div class="modal-content">
    <div id="onboardingContent">
      </div>
  </div>
</div>

<div class="topbar" id="topbar">
  <div class="logo" style="font-size: 16px; white-space: nowrap;">Nova Versão</div>
  
  <div class="topbar-right">
    <button onclick="abrirModalPerfil()" style="background:none; border:none;">👤</button>
    
    <button id="btnTema" onclick="alternarTema()" style="background:none; border:none;">🌙</button>
    
    <button id="btnConfig" onclick="abrirModal('modalConfiguracoes')" style="background:none; border:none;">⚙️</button>
    
    <button id="btnCarteiraTop" class="hidden" onclick="abrirModal('modalCarteira')">💰 <span id="saldoHeader">0</span></button>
    
  </div>
</div>

<div class="content-container">
  <div id="chatPreview"></div> 
  
  <div id="botaoExtra" class="hidden"></div>
  
  <div id="authView" class="card hidden">
    <h2>🔐 Entrar ou Criar Conta</h2>
    <input id="email" type="email" placeholder="📧 Email">
    <input id="senha" type="password" placeholder="🔑 Senha">
    <div id="cadastro-fields" class="hidden">
      <input id="nomeExibido" type="text" placeholder="😀 Nome Exibido (obrigatório)">
      <div class="show-password-container">
        <input id="senha-cadastro" type="password" placeholder="🔑 Senha (visível)">
      </div>
      <div class="show-password-container">
        <input id="senha-confirm" type="password" placeholder="🔑 Confirmar Senha (visível)">
      </div>
      <select id="tipo">
        <option value="cliente">🙋 Cliente</option>
        <option value="barbeiro">💈 Barbeiro</option>
        <option value="manicure_pedicure">💅 Manicure/Pedicure</option>
        <option value="designer_cilios">👁️ Designer de Cílios</option>
      </select>
      <input id="telefone" type="tel" placeholder="📞 Telefone com DDD (ex: 27999999999)">
      <input id="rua" type="text" placeholder="Endereço (Rua)" class="hidden">
      <input id="numero" type="text" placeholder="Endereço (Número)" class="hidden">
  
      <input id="estado" type="text" placeholder="🌎 Digite seu estado (Ex: São Paulo)" oninput="this.value = formatarNomeProprio(this.value)">
      <input id="cidade" type="text" placeholder="🏙️ Digite sua cidade (Ex: São Paulo)" oninput="this.value = formatarNomeProprio(this.value)">
      <input id="indicador" type="text" placeholder="📨 Email de quem te indicou? (opcional)">
      <button onclick="obterLocalizacaoCadastro()" id="btnLocalizacaoCadastro">📍 Usar minha localização atual</button>
    </div>
    <button onclick="entrar()">➡️ Entrar</button>
    <button id="btnCriarConta" onclick="prepararCriarConta()">🆕 Criar conta</button>
    <button id="btnVoltar" class="hidden" onclick="voltarParaLogin()">⬅️ Voltar</button>
    <button onclick="abrirModal('modalEsqueciSenha')" style="background: none; border: none; color: var(--cor-destaque); margin-top: 10px; width: 100%;">Esqueci minha senha</button>
  </div>
  
  <div id="guestView" class="card">
    <h2>🙋 Painel de Visitante</h2>
    <p style="text-align: center; font-size: 14px; opacity: 0.8;">Bem-vindo! Para interagir, crie uma conta ou faça login.</p>
    <button onclick="toggleFuncoes('guestFuncoesContainer')">⚙️ Funções do Visitante</button>
    <div id="guestFuncoesContainer" class="hidden">
        <div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:10px;">
          <button>📜 Histórico</button>
          <button>💎 VIP</button>
          <button>💰 Carteira</button>
          <button>🏆 Fidelidade</button>
          <button>📰 Blog</button>
          <button>🏅 Conquistas</button>
          <button>📊 Ranking</button>
          <button onclick="mostrar('lojaView'); carregarProdutos();">🛍️ Loja</button>
        </div>
    </div>
    <hr style="border-color: var(--cor-borda); margin: 20px 0;">
    <div id="listaBarbeirosPrincipalGuest" class="barbeiro-list-container"></div>
  </div>

  <div id="clienteView" class="hidden card">
    <h2>🙋 Painel do Cliente</h2>
    <button onclick="toggleFuncoes('clienteFuncoesContainer')" class="blinking-button closed">⚙️ Funções do Cliente</button>
    <div id="clienteFuncoesContainer" class="hidden">
        <div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:10px;">
          <button id="btnHistoricoCliente" onclick="abrirHistoricoCliente()" style="width:45%">📜 Histórico</button>
          <button id="btnVip" onclick="abrirModalVip()" style="width:45%">💎 VIP</button>
          <button onclick="abrirModal('modalCarteira')" style="width:45%">💰 Carteira</button>
          <button onclick="abrirModalFidelidade()" style="width:45%">🏆 Fidelidade</button>
          <button onclick="carregarListaBlog(); abrirModal('modalBlog')" style="width:45%">📰 Blog</button>
          <button onclick="abrirModalConquistas()" style="width:45%">🏅 Conquistas</button>
          <button onclick="abrirModalRankingUnificado()" style="width:45%">📊 Ranking</button>
          <button id="btnGerenciarLojaCliente" onclick="abrirGerenciarLoja()" class="hidden" style="width:45%">🏪 Minha Loja</button>
          <button id="btnMinhasCompras" onclick="abrirMinhasCompras()" style="width:45%">🛍️ Minhas Compras</button>
        </div>
    </div>
    <hr style="border-color: var(--cor-borda); margin: 20px 0;">
    <div id="listaBarbeirosPrincipalCliente" class="barbeiro-list-container"></div>
  </div>

  <div id="barbeiroView" class="hidden card">
    <h2>💈 Painel do Profissional</h2>
    <button onclick="toggleFuncoes('barbeiroFuncoesContainer')" class="blinking-button closed">⚙️ Funções do Profissional</button>
    <div id="barbeiroFuncoesContainer" class="hidden">
        <div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:10px;">
          <button onclick="abrirServicos()" style="width:45%">✂️ Serviços</button>
          <button onclick="abrirAgenda()" style="width:45%">📅 Agenda</button>
          <button id="btnAgendamentosBarbeiro" onclick="abrirAgendamentosBarbeiro()" style="width:45%">⏰ Agendamentos</button>
          <button onclick="abrirClientesBarbeiro()" style="width:45%">🧑‍🤝‍🧑 Clientes</button>
          <button onclick="abrirPromocoes()" style="width:45%">🎁 Promoções</button>
          <button onclick="abrirModal('modalCarteira')" style="width:45%">💰 Carteira</button>
          <button onclick="abrirModalFidelidade()" style="width:45%">🏆 Fidelidade</button>
          <button onclick="abrirHistoricoBarbeiro()" style="width:45%">📜 Histórico</button>
          <button id="btnAvaliacoesBarbeiro" onclick="abrirAvaliacoesBarbeiro()" style="width:45%">⭐ Avaliações</button>
          <button onclick="abrirModalPortfolioBarbeiro()" style="width:45%">🖼️ Portfólio</button>
          <button onclick="abrirModal('modalLogomarca')" style="width:45%">🎨 Logomarca</button>
          <button onclick="abrirModal('modalAlterarEnderecoBarbeiro')" style="width:45%">📍 Alterar Endereço</button>
          <button onclick="abrirModalDashboardBarbeiro()" style="width:45%">🚀 Desempenho</button>
          <button onclick="abrirModalConquistasBarbeiro()" style="width:45%">🏅 Conquistas</button>
          <button onclick="abrirModalRankingUnificado()" style="width:45%">📊 Ranking</button>
          <button onclick="carregarListaBlog(); abrirModal('modalBlog')" style="width:45%">📰 Blog</button>
          <button id="btnGerenciarLojaBarbeiro" onclick="abrirGerenciarLoja()" class="hidden" style="width:45%">🏪 Gerenciar Loja</button>
          <button onclick="abrirModalTurbinar()" style="width:92%; background: linear-gradient(45deg, var(--cor-destaque), #ffeb3b);">🚀 Turbinar Perfil (R$ 9,99)</button>
          
          <button id="btnVipPro" onclick="abrirModalVipPro()" style="width:92%; background: linear-gradient(45deg, var(--cor-destaque-azul), #00c6ff);">🌟 Seja PRO (R$ 29,99/mês)</button>
        </div>
    </div>
     <hr style="border-color: var(--cor-borda); margin: 20px 0;">
    <div id="listaBarbeirosPrincipalBarbeiro" class="barbeiro-list-container"></div>
  </div>

  <div id="adminView" class="hidden card">
    <div id="onlineUserCount" class="online-counter hidden" style="margin: 0 auto 10px auto; cursor: pointer; width: fit-content; display:block;">🏆 0 Online</div>

    <h2>🧠 Painel do Admin</h2>
    <div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center">
      <button onclick="abrirModalEstatisticas()" style="width:45%">📊 Estatísticas</button>
      <button id="btnAdminSolicitacoes" onclick="abrirModalSolicitacoes()" style="width:45%">📥 Solicitações</button>
      <button onclick="abrirModalUsuarios()" style="width:45%">👥 Usuários</button>
      <button id="btnAdminDenuncias" onclick="abrirDenuncias()" style="width:45%">🚨 Denúncias</button>
      <button onclick="abrirModal('modalCarteira')" style="width:45%">💰 Carteira</button>
      <button onclick="abrirGerenciarLojaAdmin()" style="width:45%">🛍️ Gerenciar Loja</button>
      <button onclick="abrirModal('modalBlogAdmin')" style="width:45%">✍️ Publicar Blog</button>
      
      <button onclick="abrirModal('modalNotificacaoMarketing')" style="width:92%">📣 Enviar Notificação Geral</button>
    </div>
  </div>

  <div id="lojaView" class="hidden card">
    <div class="card-header">
        <h3>🛍️ Loja Nova Versão</h3>
    </div>
    <div id="lojaContainer" class="loja-grid">
    </div>
</div>
</div>


</div>

<div class="redeem-container hidden" id="redeemContainer">
  <button id="btnResgatar" onclick="abrirPortaSecreta()">✨ Resgatar Código</button>
</div>

<div class="bottom-buttons-container hidden" id="bottomButtons">
  <button id="btnSair" onclick="fazerLogout()">🚪</button>
  <button id="btnDenuncia" onclick="abrirModal('modalDenuncia')">🚨</button>
</div>
<button id="btnChat" class="hidden" onclick="abrirChatGlobal()">
    <span>💬</span>
    <span class="notification-badge hidden">0</span>
</button>

<button id="btnSair" class="hidden" onclick="fazerLogout()">🚪 Sair</button>

<div id="modalConfiguracoes" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>⚙️ Configurações</h3>

    <div class="scrollable-list" style="max-height: 60vh;"> 

        <div class="popup-section config-section">
          <h4>❤️ Meu Interesse Principal</h4>
          <p style="font-size: 12px; opacity: 0.7;">Ao mudar, o app será recarregado.</p>
          <div id="configInteresseContainer" style="display:flex; gap:10px; flex-wrap: wrap; justify-content: center;">
              <button data-interesse="barbeiro" style="flex: 1; min-width: 100px;">Barbearias</button>
              <button data-interesse="manicure_pedicure" style="flex: 1; min-width: 100px;">Unhas</button>
              <button data-interesse="designer_cilios" style="flex: 1; min-width: 100px;">Cílios</button>
          </div>
        </div>

        <div class="popup-section">
          <h4>Conta</h4>
          <button onclick="abrirModalAlterarSenha()">🔑 Alterar Senha</button>
          <button onclick="solicitarAlteracaoCidade()">🏙️ Solicitar Alteração de Cidade</button>
        </div>

<div class="popup-section">
    <h4>🛍️ Loja de Vendedores</h4>
    <button id="btnSolicitarAcessoLoja" class="hidden" onclick="abrirModal('modalSolicitarLoja')">Quero Vender Meus Produtos</button>
    <p id="msgLojaJaLiberada" class="hidden" style="font-size: 14px; opacity: 0.8;">Você já tem acesso para gerenciar seus produtos na loja.</p>
 </div>

        <div class="popup-section">
          <h4>⚖️ Legal</h4>
          
          <div style="display:flex; flex-direction:column; gap:10px;">
            <button onclick="abrirModal('modalTermosUso')">Termos de Uso</button>
            <button onclick="abrirModal('modalTermosPrivacidade')">Termos de Privacidade</button>
            <button onclick="abrirModal('modalTermosCookies')">Termos de Cookies</button>
          </div>
        </div>

<div class="popup-section hidden" id="secaoVirarProfissional">
  <h4>🚀 Evoluir Conta</h4>
  <button onclick="solicitarVirarProfissional()" style="background: linear-gradient(45deg, var(--cor-destaque), #ffeb3b); color: var(--cor-fundo);">Quero ser um Profissional</button>
</div>

<div class="popup-section">
  <h4>🔒 Encerrar Conta</h4>
  <button onclick="prepararDeletarConta()" style="background-color: #c0392b; border: 1px solid #e74c3c;">Excluir Minha Conta Permanentemente</button>
</div>
         
         <div class="popup-section footer-contact" style="text-align: center; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--cor-borda);">
            <p style="font-size: 12px; margin-bottom: 8px;">
                 <a href="https://wa.me/5527995003737" target="_blank" class="animated-contact-link">
                     <span class="animated-gradient-text">📞 (27) 99500-3737</span>
                 </a>
            </p>
            <p style="font-size: 12px; margin: 0;">
                 <a href="mailto:suportenovaversao@gmail.com" class="animated-contact-link">
                     <span class="animated-gradient-text">📧 suportenovaversao@gmail.com</span>
                 </a>
            </p>
        </div>

    </div> 

    <button data-modal-id="modalConfiguracoes" onclick="fecharModal(event)" style="margin-top: 20px;">❌ Fechar</button>
  </div>
</div>

<div id="modalTermosUso" class="modal" onclick="fecharModal(event)"><div class="modal-content" onclick="event.stopPropagation()"><h3>Termos de Uso</h3><p class="scrollable-list">Bem-vindo ao Nova Versão! Ao usar nosso aplicativo, você concorda em seguir nossas regras de conduta, respeitar outros usuários e profissionais, e usar a plataforma para os fins a que se destina. Violações podem resultar na suspensão da conta.</p><button data-modal-id="modalTermosUso" onclick="fecharModal(event)">Fechar</button></div></div>
<div id="modalTermosPrivacidade" class="modal" onclick="fecharModal(event)"><div class="modal-content" onclick="event.stopPropagation()"><h3>Termos de Privacidade</h3><p class="scrollable-list">Sua privacidade é importante. Coletamos dados como nome, e-mail e localização para fornecer e melhorar nossos serviços. Não compartilhamos seus dados pessoais com terceiros sem seu consentimento, exceto quando exigido por lei.</p><button data-modal-id="modalTermosPrivacidade" onclick="fecharModal(event)">Fechar</button></div></div>
<div id="modalTermosCookies" class="modal" onclick="fecharModal(event)"><div class="modal-content" onclick="event.stopPropagation()"><h3>Termos de Cookies</h3><p class="scrollable-list">Utilizamos cookies e tecnologias semelhantes para manter sua sessão ativa, lembrar suas preferências e garantir o funcionamento do aplicativo. Ao continuar usando o Nova Versão, você concorda com nosso uso de cookies.</p><button data-modal-id="modalTermosCookies"
onclick="fecharModal(event)">Fechar</button></div></div>

<div id="modalCarteira" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>💰 Minha Carteira</h3>
    <p>Seu saldo atual é: <b style="color: var(--cor-destaque);">R$ <span id="saldoModal">0,00</span></b></p>
    <button onclick="iniciarDeposito()">📥 Depositar</button>
    <button onclick="iniciarSaque()">📤 Sacar</button>
    <button data-modal-id="modalCarteira" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalDepositoPlayStore" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>💰 Adicionar Saldo (Play Store)</h3>
    <p>Selecione um valor para adicionar à sua carteira com segurança através do Google Play.</p>
    
    <div class="metodos-grid" style="margin-top: 10px;">
        <button onclick="comprarComPlayStore('deposito_10', 10.00)">
            Adicionar R$ 10,00
        </button>
        <button onclick="comprarComPlayStore('deposito_25', 25.00)">
            Adicionar R$ 25,00
        </button>
        <button onclick="comprarComPlayStore('deposito_50', 50.00)">
            Adicionar R$ 50,00
        </button>
         <button onclick="comprarComPlayStore('deposito_100', 100.00)">
            Adicionar R$ 100,00
        </button>
    </div>
    
    <button data-modal-id="modalDepositoPlayStore" onclick="fecharModal(event)" style="margin-top: 20px;">❌ Voltar</button>
  </div>
</div>

<div id="modalPacotesMoedasTWA" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3 style="color: #00c6ff;">💎 Loja de Moedas</h3>
    <p style="font-size:12px; color:#aaa;">Compra segura via Google Play para itens digitais (VIP, Boost, etc).</p>
    
    <div class="metodos-grid" style="margin-top: 15px;">
        <button onclick="comprarComPlayStore('moedas_10', 10.00)" style="background: #222; border: 1px solid #00c6ff; color: #fff;">
            10 Moedas - R$ 10,00
        </button>
        <button onclick="comprarComPlayStore('moedas_50', 50.00)" style="background: #222; border: 1px solid #00c6ff; color: #fff;">
            50 Moedas - R$ 50,00
        </button>
        <button onclick="comprarComPlayStore('moedas_100', 100.00)" style="background: #222; border: 1px solid #00c6ff; color: #fff;">
            100 Moedas - R$ 100,00
        </button>
    </div>
    <p style="font-size:10px; margin-top:10px; opacity:0.6; text-align: center;">1 Moeda (C$) = R$ 1,00 em poder de compra digital.</p>
    <button data-modal-id="modalPacotesMoedasTWA" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalDepositoFormulario" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>📝 Informações para Depósito</h3>
    <p>Preencha seus dados para continuar.</p>
    <input id="depositoPrimeiroNome" type="text" placeholder="Primeiro Nome">
    <input id="depositoSegundoNome" type="text" placeholder="Segundo Nome">
    <input id="depositoCpf" type="text" placeholder="CPF">
    <input id="depositoTelefone" type="tel" placeholder="Telefone com DDD">
    <input id="depositoValor" type="number" placeholder="💰 Valor a depositar (Ex: 50.00)">
    <button id="btnContinuarDeposito" onclick="criarSolicitacaoDeposito()" disabled>Continuar</button>
    <button data-modal-id="modalDepositoFormulario" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalAlterarSenha" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>🔑 Alterar Senha</h3>
    <p style="font-size: 14px;">Para sua segurança, digite sua senha atual e a nova senha desejada.</p>
    <div class="show-password-container">
      <input id="senhaAtual" type="password" placeholder="Senha Atual">
      <span class="show-password-toggle" onclick="togglePasswordVisibility('senhaAtual', this)">👁️</span>
    </div>
     <div class="show-password-container">
      <input id="novaSenha" type="password" placeholder="Nova Senha (mínimo 6 caracteres)">
       <span class="show-password-toggle" onclick="togglePasswordVisibility('novaSenha', this)">👁️</span>
    </div>
     <div class="show-password-container">
      <input id="confirmarNovaSenha" type="password" placeholder="Confirmar Nova Senha">
       <span class="show-password-toggle" onclick="togglePasswordVisibility('confirmarNovaSenha', this)">👁️</span>
    </div>
    <button onclick="executarAlteracaoSenha()">✅ Salvar Nova Senha</button>
    <button data-modal-id="modalAlterarSenha" onclick="fecharModal(event)">❌ Cancelar</button>
  </div>
</div>

<div id="modalDeposito" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>💰 Depósito de Créditos</h3>
    <p>Escolha um método de pagamento para adicionar saldo à sua carteira.</p>
    <div class="metodos-grid">
        <button id="btnPagarComPix" onclick="processarPagamentoPixAprimorado()">⚡ PIX (QR Code)</button>
        <button id="btnPagarComCartao" onclick="abrirModalTaxaCartao()">💳 Cartão de Crédito</button>
    </div>
    <button data-modal-id="modalDeposito" onclick="fecharModal(event)">❌ Voltar</button>
  </div>
</div>

<div id="modalTaxaCartao" class="modal">
    <div class="modal-content" style="text-align: center;">
        <h3>⚠️ Taxa de Plataforma</h3>
        <p style="font-size: 14px;">Para garantir a transparência e a segurança da sua transação com cartão de crédito, informamos que há uma taxa administrativa fixa cobrada pela plataforma de pagamentos.</p>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
           <button onclick="fecharModalAtual()" style="background-color: #555;">Cancelar</button>
           <button onclick="processarPagamentoCartaoAprimorado()">Continuar</button>
        </div>
    </div>
</div>


<div id="modalGerandoQRCode" class="modal">
    <div class="modal-content" style="text-align: center;">
        <h3 style="color: var(--cor-destaque);">Gerando QR CODE</h3>
        <p>Aguarde um instante...</p>
    </div>
</div>

<div id="modalCarregandoGenerico" class="modal">
    <div class="modal-content" style="text-align: center;">
        <h3 id="carregandoGenericoTitulo" style="color: var(--cor-destaque);">Aguarde...</h3>
        <p id="carregandoGenericoTexto">Estamos processando sua solicitação.</p>
    </div>
</div>

<div id="modalExibirPixAprimorado" class="modal">
    <div class="modal-content" style="text-align: center;">
      <h3> Pague com PIX</h3>
      <p>Escaneie o QR Code abaixo com seu app de banco.</p>
      <img src="https://i.postimg.cc/fTZyFN6G/qrcode.jpg" id="pix-qrcode" alt="QR Code PIX">
      <div class="pix-copia-cola-container">
          <textarea id="pixChaveAleatoria">00020126770014BR.GOV.BCB.PIX0136ec4a8f0f-ec59-44bc-afcf-dff364f971de0215NAVALHA DE OURO5204000053039865802BR5920Josiel Lopes Azeredo6009SAO PAULO62140510vuyKg7Qnmx63041C39</textarea>
          <button onclick="copiarCodigoPixAprimorado(event)">Copiar Chave Aleatória PIX</button>
      </div>
      <p style="font-size: 14px; color: #ff9800; margin-top: 15px;">Este código expira em: <b id="pixTimer">10:00</b></p>
      <button onclick="confirmarEnvioComprovante()">CONFIRMAR</button>
    </div>
</div>

<div id="modalPixExpirado" class="modal" style="z-index: 22;">
    <div class="modal-content" style="text-align: center;">
        <h3 style="color: #e74c3c;">Tempo Expirado!</h3>
        <p>O tempo para pagamento deste PIX acabou.</p>
        <div style="display:flex; gap: 10px; margin-top: 20px;">
            <button onclick="fecharTodosOsModais()" style="background: #555;">Fechar</button>
            <button onclick="tentarGerarPixNovamente()">Tentar Novamente</button>
        </div>
    </div>
</div>

<div id="modalSaque" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>📤 Solicitar Saque</h3>
    <p>O valor será transferido para sua chave PIX após aprovação do administrador.</p>
    <input id="saqueValor" type="number" placeholder="Valor do saque">
    <select id="saqueChavePixTipo">
      <option value="">Tipo de Chave PIX</option>
      <option value="cpf">CPF</option>
      <option value="email">E-mail</option>
      <option value="telefone">Telefone</option>
      <option value="aleatoria">Aleatória</option>
    </select>
    <input id="saqueChavePix" type="text" placeholder="Sua chave PIX">
    <button id="btnConfirmarSaque" onclick="confirmarSaque()">✅ Confirmar Saque</button>
    <button data-modal-id="modalSaque" onclick="fecharModal(event)">❌ Cancelar</button>
  </div>
</div>

<div id="modalSaqueConfirmado" class="modal">
  <div class="modal-content" style="text-align:center;">
    <h3>✅ Solicitação Enviada!</h3>
    <p>Sua solicitação de saque foi enviada para análise.</p>
    <p style="font-size:14px; opacity: 0.8;">Para agilizar, entre em contato com o administrador.</p>
    <button onclick="contatarAdminSaque()">OK</button>
  </div>
</div>

<div id="janelaChat" class="modal fullscreen" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="chat-tabs">
        <div class="chat-tab active" id="tabChatGlobal" onclick="alternarChat('global')">🌎 Global</div>
        <div class="chat-tab" id="tabChatLocal" onclick="alternarChat('local')">📍 Local</div>
    </div>
    <button id="carregarMaisMsgBtn" onclick="carregarMensagensAnteriores()">Ver mensagens anteriores</button>
    <h3 id="chatTitle">💬 Chat Global</h3>
    <div id="chatMessages" class="chat-container"></div>
    <input id="chatInput" placeholder="Digite sua mensagem">
    <button onclick="enviarMensagem()">➡️ Enviar</button>
    <button data-modal-id="janelaChat" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="adminChatSelectorContainer" class="hidden" style="display: flex; gap: 10px; margin-bottom: 10px; padding: 5px; background: var(--cor-botoes); border-radius: 8px;">
    <select id="adminChatEstado" onchange="adminCarregarCidadesChat()"></select>
    <select id="adminChatCidade" onchange="adminRecarregarChat()"></select>
</div>

<div id="modalDenuncia" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>🚨 Denunciar</h3>
    <p>Envie sua mensagem e o administrador responderá em breve!</p>
    <textarea id="textoDenuncia" placeholder="Descreva o problema em detalhes"></textarea>
    <button onclick="enviarDenuncia()">➡️ Enviar</button>
    <button data-modal-id="modalDenuncia" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalDenunciaEnviada" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>✅ Denúncia Enviada!</h3>
    <p>Agradecemos a sua denúncia. Ela será analisada pela nossa equipe.</p>
    <p>💬 Se preferir, clique no botão abaixo para avisar o administrador diretamente no WhatsApp e agilizar o processo.</p>
    <a id="btnWhatsappDenuncia" href="#" target="_blank">
      <button>💬 Avisar no WhatsApp</button>
    </a>
    <button data-modal-id="modalDenunciaEnviada" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalBlog" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>📰 Blog</h3>
    <div id="listaBlog" class="scrollable-list"></div>
    <button data-modal-id="modalBlog" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalVip" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div id="vipContentContainer">
    </div>
    <button data-modal-id="modalVip" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalVipPro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div id="vipProContentContainer">
      </div>
    <button data-modal-id="modalVipPro" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalFidelidade" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>🏆 Programa de Fidelidade</h3>
    <p>Seus pontos: <b id="pontosFidelidade">0</b></p>
    <p style="font-size: 14px; color: var(--cor-destaque-prata);">Acumule pontos em cada agendamento e troque por descontos!</p>
    <button onclick="resgatarPontos()">🎁 Resgatar 100 pontos por R$ 5,00</button>
    <button data-modal-id="modalFidelidade" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalBarbeiroPerfil" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div id="barbeiroPerfilHeader">
      <h3 id="barbeiroPerfilNome"></h3>
      <p>Endereço: <span id="barbeiroPerfilEndereco"></span></p>
      <p>Reputação: <span id="barbeiroPerfilReputacao"></span></p>
      <img id="profissionalLogo" src="" alt="Logomarca" style="max-width: 100px; border-radius: 50%; display: none; margin: 10px auto;">
    </div>

    <div id="barbeiroPerfilServicos" class="popup-section">
      <h4>1. Escolha um Serviço</h4>
      <div id="barbeiroPerfilServicosList" class="scrollable-list" style="max-height: 150px;"></div>
    </div>

    <div id="barbeiroPerfilHorarios" class="popup-section">
      <h4>2. Escolha uma Opção</h4>
      <div id="barbeiroPerfilHorariosList"></div>
    </div>

    <div class="modal-footer">
      <button id="btnAcessarPortfolio" class="hidden" style="width: auto; background-color: var(--cor-botoes);">🖼️ Ver Portfólio</button>
      <button id="btnAbrirRota" class="hidden" style="width: auto; background-color: var(--cor-botoes);">🗺️ Rota</button>
      <button id="btnConfirmarAgendamento" disabled>🗓️ Agendar</button>
    </div>
    <button data-modal-id="modalBarbeiroPerfil" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>
<div id="modalVagaImediataAprovada" class="modal" style="z-index: 99;" onclick="fecharModal(event)">
  <div class="modal-content" style="background: #e74c3c; color: white;" onclick="event.stopPropagation()">
    <h3 style="color:white;text-shadow: 2px 2px 4px #000;">⚠️ VAGA IMEDIATA APROVADA!</h3>
    <p style="font-size: 1.2em; text-align: center;"><b>Você tem 10 minutos para chegar ao local.</b></p>
    <p style="text-align: center;">Não se atrase para não perder a vaga e o seu dinheiro!</p>
    <div style="display:flex; gap: 10px; margin-top: 20px;">
      <button data-modal-id="modalVagaImediataAprovada" onclick="fecharModal(event)" style="background:white; color:#e74c3c; flex: 1;">✅ Entendi</button>
      <button id="btnCancelarVagaAprovada" style="background: #333; color: white; flex: 1;">❌ Cancelar Agendamento</button>
    </div>
  </div>
</div>

<div id="modalBarbeariasCliente" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>💈 Profissionais disponíveis</h3>
    <input type="text" id="filtroBarbeiro" onkeyup="filtrarBarbeiros()" placeholder="🔎 Buscar por profissional ou cidade...">
    
    <button id="btnMostrarFavoritos" 
            onclick="carregarBarbeirosPrincipal('listaBarbeiros', true)" 
            class="btn-favoritos">
        ⭐ Mostrar Favoritos
    </button>
        <div id='listaBarbeiros' class="scrollable-list"></div>
    <button data-modal-id="modalBarbeariasCliente" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalHistoricoCliente" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>📜 Meu Histórico</h3>
    <div id="painelHistorico" class="scrollable-list"></div>
    <button data-modal-id="modalHistoricoCliente" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalConquistas" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>🏅 Minhas Conquistas</h3>
    <div id="listaConquistas" class="scrollable-list"></div>
    <button data-modal-id="modalConquistas" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalRankingUnificado" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>🏆 Ranking Geral 🏆</h3>
    <p style="font-size: 12px; opacity: 0.7; text-align:center;">Top 100 com mais serviços concluídos.</p>
    <div id="listaRankingUnificado" class="scrollable-list"></div>
    <button data-modal-id="modalRankingUnificado" onclick="fecharModal(event)" style="margin-top: 20px;">❌ Fechar</button>
  </div>
</div>

<div id="modalConfirmacaoGenerica" class="modal" style="z-index: 25;">
  <div class="modal-content" onclick="event.stopPropagation()" style="text-align: center;">
    <h3 id="confirmacaoGenericaTitulo" style="margin-top: 0;"></h3>
    <p id="confirmacaoGenericaMensagem" style="margin-bottom: 20px;"></p>
    <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button id="btnConfirmacaoGenericaNao" style="background-color: #555; flex-grow: 1;">Não</button>
        <button id="btnConfirmacaoGenericaSim" style="flex-grow: 1;">Sim</button>
    </div>
  </div>
</div>

<div id="modalCriarPromocao" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>🎁 Criar Promoção</h3>
    <input id="promocaoNome" placeholder="Nome da Promoção">
    <input id="promocaoDescricao" placeholder="Descrição curta">
    <input type="number" id="promocaoDesconto" placeholder="Desconto em % (ex: 15)">
    <button onclick="criarPromocao()">💾 Salvar Promoção</button>
    <button data-modal-id="modalCriarPromocao" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalLogomarca" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>🎨 Adicionar Logomarca (1 Imagem)</h3>
    <p style="font-size: 12px; opacity: 0.8;">Selecione uma imagem ou GIF do seu dispositivo.</p>
    <input id="logomarcaFile" type="file" accept="image/*,image/gif">
    <img id="logomarcaPreview" src="#" alt="Preview" style="max-width: 100px; max-height: 100px; margin-top: 10px; display: none; border-radius: 50%; object-fit: cover;">
    <progress id="logoUploadProgress" value="0" max="100" style="width: 100%; display: none; margin-top: 10px;"></progress>
    <button id="btnSalvarLogo" onclick="salvarLogomarca()" disabled>💾 Salvar Logomarca</button>
    <button data-modal-id="modalLogomarca" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalAlterarEnderecoBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>📍 Alterar Endereço</h3>
    <input id="novoEnderecoRua" type="text" placeholder="Nova Rua">
    <input id="novoEnderecoNumero" type="text" placeholder="Novo Número">
    <button onclick="obterLocalizacaoCadastro('barbeiro')">📍 Usar minha localização atual</button>
    <button onclick="alterarEnderecoBarbeiro(event)">💾 Salvar</button>
    <button data-modal-id="modalAlterarEnderecoBarbeiro" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalAvaliacoes" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>⭐ Minhas Avaliações</h3>
        <div id="listaAvaliacoesModal" class="scrollable-list"></div>
        <button data-modal-id="modalAvaliacoes" onclick="fecharModal(event)">❌ Fechar</button>
    </div>
</div>

<div id="modalServicosBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>✂️ Meus Serviços</h3>
    <div id="listaServicosBarbeiro" class="scrollable-list"></div>
    <button onclick="adicionarServico()">➕ Adicionar novo serviço</button>
    <button data-modal-id="modalServicosBarbeiro" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalAgendaBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div style="flex-shrink: 0; border-bottom: 1px solid var(--cor-borda); padding-bottom: 10px; margin-bottom: 10px;">
        <h3 style="margin:0;">📅 Gerenciar Agenda</h3>
    </div>

    <div id="agendaScrollContent">
        <p style="font-size: 12px; margin-bottom: 15px;">Configure como você quer receber agendamentos.</p>
        
        <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;">
            <button id="btnDisponibilidade" onclick="toggleDisponibilidade()">Carregando...</button>
            <button id="btnVagaImediata" onclick="toggleVagaImediata()">Carregando...</button>
            <button id="btnAgendaManual" onclick="toggleAgendaManual()">Carregando...</button>
            <button id="btnModoFerias" onclick="abrirModal('modalModoFerias')" style="background: linear-gradient(45deg, #e57373, #c0392b);">🏖️ Modo Férias / Ausência</button>
        </div>

        <div id="agendaManualPainel" class="hidden" style="border-top: 1px solid var(--cor-borda); padding-top: 10px;">
            <h4>Horários Fixos</h4>
            <p style="font-size: 12px;">Clique para liberar (Dourado) ou bloquear (Riscado).</p>
            <div id="horariosContainer"></div>
            <div class="horarios-actions" style="margin-top: 10px;">
                <button onclick="salvarAgendaManual()" style="width: 100%;">💾 Salvar Horários</button>
            </div>
        </div>
    </div>

    <button data-modal-id="modalAgendaBarbeiro" onclick="fecharModal(event)" style="margin-top: 15px; background: #444; flex-shrink: 0;">❌ Fechar</button>
  </div>
</div>

<div id="modalOnboardingProfissionalServicos" class="modal"><div class="modal-content"><h3>1. Cadastre seus Serviços</h3><p>Adicione pelo menos um serviço para continuar.</p><div id="onboardingServicosList" class="scrollable-list"></div><input id="onboardingServicoNome" placeholder="Nome do Serviço"><input id="onboardingServicoValor" type="number" placeholder="Valor (R$)"><input id="onboardingServicoTempo" type="number" placeholder="Tempo (minutos)"><button onclick="adicionarServicoOnboarding()">Adicionar Serviço</button><button id="btnOnboardingNextServicos" disabled onclick="avancarOnboarding(2)">Próximo ➡️</button></div></div>


<div id="modalAgendamentosBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>⏰ Meus Agendamentos</h3>
    <div id="agendamentosPainel" class="scrollable-list"></div>
    <button data-modal-id="modalAgendamentosBarbeiro" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalClientesBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>🧑‍🤝‍🧑 Meus Clientes</h3>
    <p>Lista de clientes que já agendaram com você.</p>
    <div id="listaClientesBarbeiro" class="scrollable-list"></div>
    <button data-modal-id="modalClientesBarbeiro" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalDashboardBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>🚀 Meu Desempenho</h3>
    <div id="dashboardConteudo">
      <p>Carregando dados...</p>
    </div>
    <button data-modal-id="modalDashboardBarbeiro" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalHistoricoBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>📜 Histórico de Serviços</h3>
    <div id="painelHistoricoBarbeiro" class="scrollable-list"></div>
    <button data-modal-id="modalHistoricoBarbeiro" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalConquistasBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>🏅 Minhas Conquistas de Profissional</h3>
    <div id="listaConquistasBarbeiro" class="scrollable-list"></div>
    <button data-modal-id="modalConquistasBarbeiro" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalBlogAdmin" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>✍️ Novo Post</h3>
    <input id="blogTitulo" placeholder="Título">
    <textarea id="blogConteudo" placeholder="Conteúdo do post"></textarea>
    <button onclick="publicarBlog()">✍️ Publicar</button>
    <button data-modal-id="modalBlogAdmin" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalEstatisticas" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>📊 Estatísticas</h3>
    <div id="estatisticasPainel" class="scrollable-list"></div>
    <button data-modal-id="modalEstatisticas" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalSolicitacoes" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>📥 Todas as Solicitações</h3>
    <div id="listaSolicitacoes" class="scrollable-list"></div>
    <button data-modal-id="modalSolicitacoes" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalUsuarios" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>👥 Todos os Usuários</h3>
    <div id="usuariosPainel" class="scrollable-list"></div>
    <button data-modal-id="modalUsuarios" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalGerenciarUsuario" class="modal"><div class="modal-content"><h3>Gerenciar Usuário</h3><div id="adminGerenciarConteudo"></div></div></div>

<div id="modalGerenciarLojaAdmin" class="modal"><div class="modal-content"><h3>Gerenciar Loja</h3><div class="popup-section"><h4>Deletar Produto</h4><div id="adminDeletarProdutoList" class="scrollable-list"></div></div><div class="popup-section"><h4>Ativar/Desativar Loja de Vendedor</h4><div id="adminToggleLojaList" class="scrollable-list"></div></div><button data-modal-id="modalGerenciarLojaAdmin" onclick="fecharModal(event)">Fechar</button></div></div>

<div id="modalDenunciasAdmin" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>🚨 Denúncias</h3>
    <div id="listaDenuncias" class="scrollable-list"></div>
    <button data-modal-id="modalDenunciasAdmin" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalNotificacaoMarketing" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>📣 Notificação para Todos</h3>
    <p>Esta mensagem será enviada como uma notificação push para todos os usuários do app.</p>
    <input id="marketingTitulo" placeholder="Título da Notificação">
    <textarea id="marketingCorpo" placeholder="Corpo da mensagem"></textarea>
    <button onclick="enviarNotificacaoMarketing()">🚀 Enviar para todos</button>
    <button data-modal-id="modalNotificacaoMarketing" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalAlterarCidadeInputs" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>🏙️ Alterar Localização</h3>
    <p>Digite o novo estado e cidade desejados.</p>
    <label for="novoEstadoInput">Novo Estado:</label>
    <input id="novoEstadoInput" type="text" placeholder="Ex: Espírito Santo" oninput="this.value = formatarNomeProprio(this.value)">
    <label for="novoCidadeInput">Nova Cidade:</label>
    <input id="novoCidadeInput" type="text" placeholder="Ex: Aracruz" oninput="this.value = formatarNomeProprio(this.value)">
    <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button data-modal-id="modalAlterarCidadeInputs" onclick="fecharModal(event)" style="background-color: #555;">Cancelar</button>
        <button id="btnConfirmarInputsCidade" onclick="processarInputsCidade()">Confirmar</button>
    </div>
  </div>
</div>

<div id="modalConfirmarAlteracaoCidade" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>Confirmar Alteração?</h3>
    <p>Você confirma a solicitação para alterar sua cidade para <b id="confirmCidadeEstadoTexto"></b>? Isso abrirá o WhatsApp para agilizar.</p>
    <div style="display: flex; gap: 10px; margin-top: 15px;">
      <button id="btnNaoConfirmarCidade" onclick="fecharModalAtual()" style="background-color: #555;">Não</button>
      <button id="btnSimConfirmarCidade">Sim, Solicitar</button> </div>
  </div>
</div>

<div id="modalPortfolioBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>🖼️ Gerenciar Portfólio (Máx. 30 Imagens/GIFs)</h3>
    <p style="font-size: 12px; opacity: 0.8;">Adicione novas imagens abaixo ou clique no '❌' sobre uma imagem existente para removê-la.</p>
    <p style="font-size: 14px; margin-bottom: 10px;">Imagens Atuais: <b id="portfolioContador">0</b>/30</p>

    <div id="portfolioExistenteGrid" class="portfolio-grid" style="margin-bottom: 15px; border: 1px dashed var(--cor-borda); padding: 10px; min-height: 100px; max-height: 250px; overflow-y: auto;">
      </div>

    <label id="labelPortfolioFiles" for="portfolioFilesInput" style="cursor: pointer; background-color: var(--cor-botoes); padding: 10px; border-radius: 8px; text-align: center; display: block; margin-bottom: 10px;">Adicionar Novas Imagens</label>
    <input id="portfolioFilesInput" type="file" accept="image/*,image/gif" multiple style="display: none;">
    <progress id="portfolioUploadProgress" value="0" max="100" style="width: 100%; display: none; margin-bottom: 10px;"></progress>
    <div id="portfolioPreviews" style="display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 15px; max-height: 100px; overflow-y: auto;"></div>

    <button id="btnSalvarPortfolio" onclick="salvarAlteracoesPortfolio()" disabled>💾 Salvar Alterações</button>
    <button data-modal-id="modalPortfolioBarbeiro" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalPortfolioCliente" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3 id="portfolioClienteNome">🖼️ Portfólio</h3>
    <div id="portfolioClienteGrid" class="portfolio-grid"></div>
    <button data-modal-id="modalPortfolioCliente" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalLiberarLoja" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>🛍️ Acesso à Loja de Vendedores</h3>
        <p>Você ainda não tem permissão pra cadastrar produtos na loja. Peça autorização pro administrador no WhatsApp.</p>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button data-modal-id="modalLiberarLoja" onclick="fecharModal(event)" style="background-color: #555;">↩️ Cancelar</button>
            <button onclick="solicitarLiberacaoLoja()" style="flex-grow: 1;">
                💬 Pedir no WhatsApp
            </button>
        </div>
    </div>
</div>

<div id="modalTurbinar" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>🚀 Turbinar seu Perfil</h3>
        <p>Destaque seu perfil no topo da lista de profissionais por <strong>24 horas</strong> e alcance mais clientes!</p>
        <p style="font-size: 22px; color: var(--cor-destaque); font-weight: bold; text-align: center;">Apenas R$ 9,99</p>
        <button onclick="confirmarTurbinar()">💥 Confirmar e Turbinar</button>
        <button data-modal-id="modalTurbinar" onclick="fecharModal(event)">❌ Cancelar</button>
    </div>
</div>

<div id="modalPermissaoNotificacao" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>🔔 Fique por Dentro!</h3>
        <p>Ative as notificações para receber alertas importantes sobre seus agendamentos, promoções e novidades em tempo real.</p>
        <button onclick="pedirPermissaoEFechar()">👍 Ativar Notificações</button>
        <button data-modal-id="modalPermissaoNotificacao" onclick="fecharModal(event)">❌ Agora não</button>
    </div>
</div>

<div id="modalInstalarApp" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>📱 Leve o App com Você!</h3>
        <p>Instale nosso aplicativo na sua tela inicial para um acesso mais rápido e uma melhor experiência.</p>
        <button id="btnInstalarPWA">📲 Instalar Agora</button>
        <button data-modal-id="modalInstalarApp" onclick="fecharModal(event)">🤔 Depois</button>
    </div>
</div>

<div id="modalAtualizacao" class="modal" style="z-index: 100;" onclick="fecharModal(event)">
    <div class="modal-content" style="border: 2px solid var(--cor-destaque);" onclick="event.stopPropagation()">
        <h3>🚀 Nova Versão do App Disponível!</h3>
        <p>Uma nova versão do aplicativo está pronta. Clique no botão abaixo para atualizar e ter acesso às últimas novidades e melhorias.</p>
        <div style="display:flex; gap: 10px; margin-top: 20px;">
           <button data-modal-id="modalAtualizacao" onclick="fecharModal(event)" style="background: #555;">🤔 Depois</button>
           <button id="btnAtualizarApp" style="flex-grow: 1;">🔄 Atualize Agora</button>
        </div>
    </div>
</div>

<div id="modalPromocoesBarbeiro" class="modal">
  <div class="modal-content">
    <h2>🎁 Promoções Ativas</h2>
    <div id="listaPromocoes">
      </div>
    <div class="modal-botoes">
      <button onclick="abrirModalAddPromocao()">➕ Adicionar Promoção</button>
      <button data-modal-id="modalPromocoesBarbeiro" onclick="fecharModal(event)">❌ Fechar</button>
    </div>
  </div>
</div>

<div id="modalAddPromocao" class="modal">
  <div class="modal-content">
    <h2>➕ Adicionar Nova Promoção</h2>

    <input type="text" id="addPromocaoNome" placeholder="Nome da Promoção (Ex: Combo Barba+Cabelo)" required>
    <textarea id="addPromocaoDescricao" placeholder="Descrição (Ex: Válido de segunda a quarta)" required></textarea>

    <div class="popup-section">
      <h4>✂️ Aplicar a quais serviços?</h4>
      <p style="font-size: 12px; opacity: 0.7;">Segure Ctrl (ou Cmd) para selecionar vários.</p>
      <select id="addPromocaoServicos" multiple style="height: 120px;"></select>
    </div>

    <div class="popup-section">
      <h4>⚙️ Condições da Promoção</h4>
      <label for="addPromocaoDesconto">Desconto (%):</label>
      <input type="number" id="addPromocaoDesconto" placeholder="Ex: 15" required>

      <label for="addPromocaoValidade">Válida até (opcional):</label>
      <input type="date" id="addPromocaoValidade">

      <label for="addPromocaoValorMinimo">Valor mínimo do serviço para aplicar (opcional):</label>
      <input type="number" id="addPromocaoValorMinimo" placeholder="Ex: 50">
    </div>

    <button onclick="salvarNovaPromocao()">💾 Salvar Promoção</button>
    <button data-modal-id="modalAddPromocao" onclick="fecharModal(event)">❌ Cancelar</button>
  </div>
</div>
	
<div id="modalConfirmarFecharPopup" class="modal" style="z-index: 30;" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3 id="confirmarFecharTitulo">🤔 Tem certeza?</h3>
    <p id="confirmarFecharMensagem">Você pode completar esta etapa mais tarde pelas configurações.</p>
    <div style="display: flex; gap: 10px; margin-top: 20px;">
      <button onclick="cancelarFechamentoPopup()" style="background-color: #555;">Não, continuar</button>
      <button onclick="confirmarFechamentoPopup()">Sim, fechar</button>
    </div>
  </div>
</div>

<div id="modalLoja" class="modal">
  <div class="modal-content">
    <h3>🛒 Produtos da Loja</h3>
    <div id="listaProdutos" class="loja-grid"></div>
    <button data-modal-id="modalLoja" onclick="fecharModal(event)">❌ Fechar</button>
  </div>
</div>

<div id="modalProdutoDetalhes" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">

        
        <div id="detalhesProdutoImagensContainer" style="width: 100%; overflow-x: auto; display: flex; scroll-snap-type: x mandatory; margin-bottom: 5px; background-color: var(--cor-botoes); border-radius: 10px; min-height: 250px; align-items: center;">
            {/* Imagens serão carregadas aqui pelo JS */}
        </div>

        
        <div id="detalhesProdutoImagensIndicadores" style="text-align: center; margin-bottom: 15px;">
            {/* Indicadores (pontinhos) serão carregados aqui pelo JS */}
        </div>
        

        <h3 id="detalhesProdutoNome" style="margin: 0; color: var(--cor-destaque);"></h3>

        <p style="margin-top: 15px;"><strong>Tamanho:</strong></p>
        <div id="detalhesProdutoTamanhos" class="tamanho-options"></div>

        <p><strong>Preço:</strong> <span id="detalhesProdutoPreco" style="font-weight: bold; font-size: 1.2em;"></span></p>
        <p><strong>Descrição:</strong></p>
        <p id="detalhesProdutoDescricao" style="font-size: 14px; opacity: 0.9;"></p>

        <div id="detalhesProdutoAvaliacao"></div>

        <button id="btnComprarAgora">Continuar</button>
        <button data-modal-id="modalProdutoDetalhes" onclick="fecharModal(event)">❌ Fechar</button>

    </div>
</div>

<div id="modalFormularioCompraLoja" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-overlay-content hidden" id="overlayPagamento">
            <h3>Confirmar Pagamento</h3>
            <p>Debitar <b>R$ <span id="valorDebito">0,00</span></b> do seu saldo da carteira?</p>
            <div style="display: flex; gap: 10px; margin-top: 20px; width: 80%;">
                <button id="btnNaoDebitar" style="background-color: #555;">Não</button>
                <button id="btnSimDebitar">Sim</button>
            </div>
        </div>
        <h3>📝 Detalhes para Entrega</h3>
        <input id="compraNomeCompleto" type="text" placeholder="Nome Completo">
        <input id="compraCpf" type="text" placeholder="CPF">
        <input id="compraTelefone" type="tel" placeholder="Telefone para Contato">
        <input id="compraEmail" type="email" placeholder="Email para confirmação">
        <input id="compraCep" type="text" placeholder="CEP">
        <input id="compraRua" type="text" placeholder="Endereço Completo (Rua, Bairro...)">
        <input id="compraNumeroCasa" type="text" placeholder="Número da Casa e Complemento">
        <button id="btnPagarCompraLoja">Pagar</button>
        <button data-modal-id="modalFormularioCompraLoja" onclick="fecharModal(event)">❌ Cancelar</button>
    </div>
</div>

<div id="modalGerenciarLoja" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" style="max-width: 600px;">
        <h3>🏪 Gerenciar Minha Loja</h3>
        <div id="listaMeusProdutos" class="scrollable-list"></div>
        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px;">
          <button onclick="abrirFormularioProduto()">➕ Adicionar Produto</button>
          <button id="btnEntregasVendedor" onclick="abrirEntregasVendedor()">🚚 Entregas</button>
          <button data-modal-id="modalGerenciarLoja" onclick="fecharModal(event)">❌ Fechar</button>
        </div>
    </div>
</div>

<div id="modalSolicitarLoja" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>🛍️ Venda Seus Produtos na Loja!</h3>
        <p>Gostaria de se tornar um vendedor em nossa plataforma?</p>
        <p style="font-size: 14px; opacity: 0.8;">Ao clicar em "Enviar Solicitação", um pedido será enviado ao administrador para análise e você será redirecionado(a) ao WhatsApp para agilizar o contato.</p>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button data-modal-id="modalSolicitarLoja" onclick="fecharModal(event)" style="background-color: #555;">Cancelar</button>
            <button id="btnConfirmarSolicitarLoja" onclick="confirmarSolicitacaoAcessoLoja()">➡️ Enviar Solicitação</button>
        </div>
    </div>
 </div>

<div id="modalAddEditProduto" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-height: 85vh; overflow-y: auto;"> <h3 id="formProdutoTitulo">📦 Adicionar/Editar Produto</h3>

        <div class="popup-section">
            <h4>Imagens (1 a 5) *</h4>
            <p style="font-size: 12px; opacity: 0.8;">Selecione até 5 imagens ou GIFs. A primeira será a principal. Clique no '❌' para remover uma imagem existente.</p>
            <p style="font-size: 14px;">Imagens Atuais: <b id="produtoContadorImagens">0</b>/5</p>
            <div id="produtoPreviewsExistentes" style="display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px; border: 1px dashed var(--cor-borda); padding: 5px; min-height: 70px;">
                </div>
            <label id="labelProdutoFiles" for="produtoFiles">Adicionar Novas Imagens</label>
            <input id="produtoFiles" type="file" accept="image/*,image/gif" multiple style="margin-bottom: 5px;" disabled>
            <progress id="produtoUploadProgress" value="0" max="100" style="width: 100%; display: none; margin-bottom: 5px;"></progress>
            <div id="produtoPreviewsNovas" style="display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px; max-height: 80px; overflow-y: auto;"></div>
        </div>

        <label for="produtoNome">Nome do Produto *</label>
        <input id="produtoNome" type="text" placeholder="Ex: Camiseta Básica Preta" required>

        <label for="produtoPreco">Preço (R$) *</label>
        <input id="produtoPreco" type="number" step="0.01" placeholder="Ex: 49.90" required>

        <label for="produtoDesconto">Desconto (%)</label>
        <input id="produtoDesconto" type="number" placeholder="Opcional, Ex: 10 (para 10%)">

        <label style="margin-top: 10px; display: block;">Tamanhos disponíveis *</label>
        <div id="produtoTamanhosGroup" class="checkbox-group" style="margin-bottom: 15px;">
            <label><input type="checkbox" name="tamanhos" value="Único"> Único</label>
            <label><input type="checkbox" name="tamanhos" value="P"> P</label>
            <label><input type="checkbox" name="tamanhos" value="M"> M</label>
            <label><input type="checkbox" name="tamanhos" value="G"> G</label>
            <label><input type="checkbox" name="tamanhos" value="GG"> GG</label>
            </div>

        <label for="produtoDescricao">Descrição *</label>
        <textarea id="produtoDescricao" placeholder="Descreva brevemente o produto..." rows="3" required></textarea>

        <button id="btnSalvarProduto" onclick="salvarProdutoVendedor()" style="margin-top: 15px;">💾 Salvar Produto</button>
        <button data-modal-id="modalAddEditProduto" onclick="fecharModal(event)">❌ Cancelar</button>
    </div>
</div>

<div id="modalEntregasVendedor" class="modal" onclick="fecharModal(event)">
    <div class="modal-content">
        <h3>🚚 Minhas Entregas</h3>
        <div id="listaEntregas" class="scrollable-list"></div>
        <button data-modal-id="modalEntregasVendedor" onclick="fecharModal(event)">❌ Fechar</button>
    </div>
</div>

<div id="modalMinhasCompras" class="modal" onclick="fecharModal(event)">
    <div class="modal-content">
        <h3>🛍️ Minhas Compras</h3>
        <div id="listaMinhasCompras" class="scrollable-list"></div>
        <button data-modal-id="modalMinhasCompras" onclick="fecharModal(event)">❌ Fechar</button>
    </div>
</div>

<div id="modalAvaliarProduto" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>⭐ Avaliar Produto</h3>
        <p>Como você avalia o produto <b id="avaliarProdutoNome"></b>?</p>
        <div class="rating-stars" id="ratingStars">
            <span data-value="1">☆</span><span data-value="2">☆</span><span data-value="3">☆</span><span data-value="4">☆</span><span data-value="5">☆</span>
        </div>
        <textarea id="avaliarProdutoComentario" placeholder="Deixe um comentário..." rows="3"></textarea>
        <button id="btnSalvarAvaliacaoProduto">Enviar Avaliação</button>
        <button data-modal-id="modalAvaliarProduto" onclick="fecharModal(event)">❌ Cancelar</button>
    </div>
</div>

<div id="modalPopupGenerico" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()" style="text-align: center;">
    <h3 id="popupGenericoTitulo" style="margin-top: 0;"></h3>
    <p id="popupGenericoMensagem" style="margin-bottom: 20px;"></p>
    <button data-modal-id="modalPopupGenerico" onclick="handlePopupGenericoOk(event)">OK</button>
  </div>
</div>

<style>
.rating-stars {
    text-align: center;
    font-size: 2.5em;
    cursor: pointer;
    margin: 10px 0;
    color: #444;
}
.rating-stars span {
    transition: color 0.2s;
}
.rating-stars span:hover,
.rating-stars span.hovered,
.rating-stars span.selected {
    color: var(--cor-destaque);
}

#modalGerenciarUsuario .modal-content {
    max-height: 80vh; /* Limita a altura máxima a 80% da altura da tela */
    overflow-y: auto;   /* Adiciona a barra de rolagem vertical APENAS quando necessário */
    /* Você pode ajustar o valor de max-height (ex: 75vh, 85vh) se preferir */
}

#modalVipPro .modal-content {
    max-height: 85vh; /* Define uma altura máxima */
    /* display: flex;  Removido ou ajustado para não interferir no scroll */
    /* flex-direction: column; Removido ou ajustado */
}
#vipProContentContainer {
     max-height: calc(85vh - 120px); /* Calcula altura máxima do conteúdo (85vh - paddings - altura botão fechar aprox) */
     overflow-y: auto; /* Adiciona scroll se necessário */
     padding-right: 10px; /* Espaço para a barra de rolagem não colar no conteúdo */
     box-sizing: border-box; /* Garante que o padding não aumente o tamanho */
}

</style>


<div id="modalVendaRealizada" class="modal modal-venda" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>🎉 VENDA REALIZADA! 🎉</h3>
        <p style="font-size: 1.1em;">Parabéns, você vendeu um produto!</p>
        <p>Acesse <strong>Gerenciar Loja > Entregas</strong> para ver os detalhes.</p>
        <button data-modal-id="modalVendaRealizada" onclick="fecharModal(event)" style="background: white; color: #c0392b;">✅ OK</button>
    </div>
</div>

<div id="modalConfirmacaoComprador" class="modal">
    <div class="modal-content">
        <h3 id="confirmacaoCompradorTitulo">Confirmar Recebimento</h3>
        <p id="confirmacaoCompradorTexto">O vendedor marcou o produto como entregue. Você confirma o recebimento?</p>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
           <button id="btnRecusarEntrega" style="background: #c0392b;">❌ Negar</button>
           <button id="btnAceitarEntrega" style="background: #27ae60;">✅ Confirmar</button>
        </div>
    </div>
</div>

<div id="modalModoFerias" class="modal">
  <div class="modal-content">
    <h3>📅 Modo Férias/Ausência</h3>
    <p>Bloqueie um período na sua agenda. Seus clientes serão notificados.</p>
    <label for="feriasInicio">Data de Início:</label>
    <input type="date" id="feriasInicio">
    <label for="feriasFim">Data de Fim:</label>
    <input type="date" id="feriasFim">
    <button onclick="ativarModoFerias()">✅ Ativar e Notificar Clientes</button>
    <button data-modal-id="modalModoFerias" onclick="fecharModal(event)">❌ Cancelar</button>
  </div>
</div>

<div id="modalEsqueciSenha" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>🔑 Recuperar Acesso</h3>
    <p style="font-size: 14px;">Preencha seus dados para solicitar uma nova senha ao administrador.</p>
    <input id="recuperaEmail" type="email" placeholder="📧 Seu email de cadastro">
    <input id="recuperaTelefone" type="tel" placeholder="📞 Seu telefone com DDD">
    <button onclick="enviarSolicitacaoRecuperacaoSenha()">➡️ Enviar Solicitação</button>
    <button data-modal-id="modalEsqueciSenha" onclick="fecharModal(event)">❌ Cancelar</button>
  </div>
</div>

<!-- ===================================================================== -->
<!-- ====== INÍCIO: NOVOS MODAIS ONBOARDING PROFISSIONAL (COPIAR) ====== -->
<!-- ===================================================================== -->

<!-- Popup 2: Promoções (Onboarding) -->
<div id="modalOnboardingPromocoes" class="modal" style="z-index: 21;">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="modal-overlay-content hidden" id="overlayOnboardingPromocao">
        <h3 id="onboardingPromocaoTituloAviso">Atenção</h3>
        <p id="onboardingPromocaoMensagemAviso">É necessário adicionar pelo menos 1 promoção para concluir esta etapa.</p>
        <button onclick="document.getElementById('overlayOnboardingPromocao').classList.add('hidden')" style="margin-top: 15px;">OK</button>
    </div>

    <h3>2. Crie sua Primeira Promoção</h3>
    <p style="font-size: 14px; opacity: 0.8;">Atraia clientes com um desconto! (Ex: Combo Barba+Cabelo com 10% OFF).</p>

    <!-- Adicionado scrollable-list aqui -->
    <div class="scrollable-list" style="max-height: 55vh; padding-right: 10px;">
        <input type="text" id="onboardingPromocaoNome" placeholder="Nome da Promoção (Ex: Combo Barba+Cabelo)" required>
        <textarea id="onboardingPromocaoDescricao" placeholder="Descrição (Ex: Válido de segunda a quarta)" required></textarea>

        <div class="popup-section">
          <h4>✂️ Aplicar a quais serviços?</h4>
          <p style="font-size: 12px; opacity: 0.7;">Selecione os serviços que você acabou de cadastrar. Segure Ctrl (ou Cmd) para selecionar vários.</p>
          <select id="onboardingPromocaoServicos" multiple style="height: 120px;"></select>
        </div>

        <div class="popup-section">
          <h4>⚙️ Condições da Promoção</h4>
          <label for="onboardingPromocaoDesconto">Desconto (%):</label>
          <input type="number" id="onboardingPromocaoDesconto" placeholder="Ex: 15" required>

          <label for="onboardingPromocaoValidade">Válida até (opcional):</label>
          <input type="date" id="onboardingPromocaoValidade">
        </div>
    </div>
    
    <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button onclick="fecharOnboardingComAviso(2)" style="background-color: #555;">❌ Fechar</button>
        <button id="btnOnboardingNextPromocoes" onclick="salvarOnboardingPromocao()">Concluir ➡️</button>
    </div>
  </div>
</div>

<!-- Popup 3: Agenda (Onboarding) - (Você já tem 'modalAgendaBarbeiro', vamos criar um clone para o onboarding) -->
<div id="modalOnboardingAgenda" class="modal" style="z-index: 22;">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="modal-overlay-content hidden" id="overlayOnboardingAgenda">
        <h3>Atenção</h3>
        <p>Você precisa ativar pelo menos uma forma de atendimento (Vaga Imediata ou Agenda Manual) para continuar.</p>
        <button onclick="document.getElementById('overlayOnboardingAgenda').classList.add('hidden')" style="margin-top: 15px;">OK</button>
    </div>
    
    <h3>3. Configure sua Agenda</h3>
    <p>Use os botões abaixo para gerenciar sua disponibilidade.</p>
    <button id="onboardingBtnDisponibilidade" onclick="toggleOnboardingDisponibilidade()"></button>
    <button id="onboardingBtnVagaImediata" onclick="toggleOnboardingVagaImediata()"></button>
    <button id="onboardingBtnAgendaManual" onclick="toggleOnboardingAgendaManual()"></button>
    
    <div id="onboardingAgendaManualPainel" class="hidden card">
        <h4>Horários Disponíveis Hoje</h4>
        <p>Selecione os horários para trabalhar.</p>
        <div id="onboardingHorariosContainer" style="display:flex; flex-wrap:wrap; gap:5px; justify-content: center;"></div>
    </div>
    
    <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button onclick="fecharOnboardingComAviso(3)" style="background-color: #555;">❌ Fechar</button>
        <button id="btnOnboardingNextAgenda" onclick="salvarOnboardingAgenda()">Concluir ➡️</button>
    </div>
  </div>
</div>

<!-- Popup 4: Logomarca (Onboarding) -->
<div id="modalOnboardingLogomarca" class="modal" style="z-index: 23;">
  <div class="modal-content" onclick="event.stopPropagation()">
     <div class="modal-overlay-content hidden" id="overlayOnboardingLogo">
        <h3>Atenção</h3>
        <p>É necessário enviar uma logomarca para concluir esta etapa.</p>
        <button onclick="document.getElementById('overlayOnboardingLogo').classList.add('hidden')" style="margin-top: 15px;">OK</button>
    </div>

    <h3>4. Adicione sua Logomarca</h3>
    <p style="font-size: 12px; opacity: 0.8;">Selecione uma imagem ou GIF do seu dispositivo.</p>
    
    <input id="onboardingLogomarcaFile" type="file" accept="image/*,image/gif">
    <img id="onboardingLogomarcaPreview" src="#" alt="Preview" style="max-width: 100px; max-height: 100px; margin-top: 10px; display: none; border-radius: 50%; object-fit: cover;">
    <progress id="onboardingLogoUploadProgress" value="0" max="100" style="width: 100%; display: none; margin-top: 10px;"></progress>
    
    <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button onclick="fecharOnboardingComAviso(4)" style="background-color: #555;">❌ Fechar</button>
        <button id="btnOnboardingNextLogo" onclick="salvarOnboardingLogo()" disabled>Concluir ➡️</button>
    </div>
  </div>
</div>

<!-- Popup 5: Portfólio (Onboarding) -->
<div id="modalOnboardingPortfolio" class="modal" style="z-index: 24;">
  <div class="modal-content" onclick="event.stopPropagation()">
     <div class="modal-overlay-content hidden" id="overlayOnboardingPortfolio">
        <h3>Atenção</h3>
        <p>É necessário enviar pelo menos uma imagem para seu portfólio para concluir.</p>
        <button onclick="document.getElementById('overlayOnboardingPortfolio').classList.add('hidden')" style="margin-top: 15px;">OK</button>
    </div>

    <h3>5. Mostre seu Trabalho (Portfólio)</h3>
    <p style="font-size: 12px; opacity: 0.8;">Envie pelo menos 1 imagem (Máx. 30) para que os clientes vejam sua qualidade.</p>
    
    <label for="onboardingPortfolioFilesInput" style="cursor: pointer; background-color: var(--cor-botoes); padding: 10px; border-radius: 8px; text-align: center; display: block; margin-bottom: 10px;">Adicionar Imagens</label>
    <input id="onboardingPortfolioFilesInput" type="file" accept="image/*,image/gif" multiple style="display: none;">
    
    <progress id="onboardingPortfolioUploadProgress" value="0" max="100" style="width: 100%; display: none; margin-bottom: 10px;"></progress>
    <div id="onboardingPortfolioPreviews" style="display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 15px; max-height: 150px; overflow-y: auto;"></div>

    <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button onclick="fecharOnboardingComAviso(5)" style="background-color: #555;">❌ Fechar</button>
        <button id="btnOnboardingNextPortfolio" onclick="salvarOnboardingPortfolio()" disabled>🎉 Finalizar Configuração</button>
    </div>
  </div>
</div>

<!-- Popup de Aviso Genérico (Onboarding) -->
<div id="modalAvisoOnboarding" class="modal" style="z-index: 30;">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3 id="avisoOnboardingTitulo">Atenção</h3>
    <p id="avisoOnboardingMensagem">Você precisa concluir esta etapa mais tarde para que os clientes possam agendar com você.</p>
    <button onclick="confirmarFechamentoOnboarding()" style="margin-top: 15px;">OK, Entendi</button>
  </div>
</div>
<!-- ===================================================================== -->
<!-- ====== FIM: NOVOS MODAIS ONBOARDING PROFISSIONAL (COPIAR) ========= -->
<!-- ===================================================================== -->

<div id="modalLembretePendencia" class="modal" style="z-index: 30;">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>Configurações Pendentes</h3>
    <p>Faltam configurações essenciais para que os clientes possam encontrar e agendar com você. Recomendamos que conclua agora.</p>
    <div style="display: flex; gap: 10px; margin-top: 20px;">
      <button onclick="fecharModalAtual()" style="background-color: #555;">Deixar pra depois</button>
      <button id="btnLembreteOk" onclick="iniciarFluxoDeLembrete()">OK, Configurar</button>
    </div>
  </div>
</div>

<div id="modalAdminDetalhesCidade" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>🏙️ Aprovar Alteração de Cidade</h3>
    <p>Usuário: <b id="adminCidadeNomeUsuario"></b></p>
    <p>Cidade Atual: <span id="adminCidadeAtual"></span></p>

    
    <label for="adminNovoEstadoSolicitacao">Novo Estado:</label>
    <input id="adminNovoEstadoSolicitacao" type="text" placeholder="Digite o novo estado" oninput="this.value = formatarNomeProprio(this.value)">

    <label for="adminNovoCidadeSolicitacao">Nova Cidade:</label>
    <input id="adminNovoCidadeSolicitacao" type="text" placeholder="Digite a nova cidade" oninput="this.value = formatarNomeProprio(this.value)">
    

    <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button onclick="recusarSolicitacaoAtual()" style="background-color: #e74c3c;">❌ Recusar</button>
        <button id="btnAprovarCidade" onclick="aprovarAlteracaoCidade()">✅ Aprovar Alteração</button>
    </div>
     <button data-modal-id="modalAdminDetalhesCidade" onclick="fecharModal(event)" style="margin-top: 10px;">Fechar Janela</button>
  </div>
</div>

<!-- Modal para Adicionar/Editar Serviço (Substitui o prompt) -->
<div id="modalAddServico" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3 id="modalAddServicoTitulo">Adicionar Novo Serviço</h3>
    <input id="addServicoNome" type="text" placeholder="Nome do Serviço (Ex: Corte Masculino)">
    <input id="addServicoValor" type="number" placeholder="Preço (Ex: 25.50)">
    <input id="addServicoTempo" type="number" placeholder="Tempo Estimado (em minutos, Ex: 30)">
    <button id="btnSalvarServico" onclick="salvarServico()">💾 Salvar Serviço</button>
    <button data-modal-id="modalAddServico" onclick="fecharModal(event)">❌ Cancelar</button>
  </div>
</div>

<!-- Modal para Resgatar Código (Substitui o prompt) -->
<div id="modalResgatarCodigo" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>✨ Resgatar Código</h3>
    <p>Insira o código de resgate:</p>
    <input id="inputCodigoResgate" type="text" placeholder="Digite o código aqui...">
    <button onclick="executarResgateCodigo()">➡️ Resgatar</button>
    <button data-modal-id="modalResgatarCodigo" onclick="fecharModal(event)">❌ Cancelar</button>
  </div>
</div>

<!-- Modal para Avaliação do Cliente (Substitui os prompts) -->
<div id="modalAvaliacaoCliente" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>⭐ Avaliar Serviço</h3>
    <p>Avalie o serviço de 1 a 10:</p>
    <input id="inputAvaliacaoNota" type="number" min="1" max="10" placeholder="Nota (1-10)">
    <p>Deixe um comentário:</p>
    <textarea id="inputAvaliacaoComentario" placeholder="Descreva sua experiência..."></textarea>
    <p>Enviar foto do resultado? (Opcional)</p>
    <input id="inputAvaliacaoFotoFile" type="file" accept="image/*" style="background-color: var(--cor-botoes);">
    <progress id="avaliacaoUploadProgress" value="0" max="100" style="width: 100%; display: none; margin-top: 5px;"></progress>
    <button id="btnSalvarAvaliacao" onclick="executarAvaliacaoCliente()">Enviar Avaliação</button>
    <button data-modal-id="modalAvaliacaoCliente" onclick="fecharModal(event)">❌ Cancelar</button>
  </div>
</div>

<!-- Modal para Confirmar Exclusão de Conta (Substitui o prompt) -->
<div id="modalConfirmarSenhaExclusao" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>🗑️ Excluir Conta</h3>
    <p style="color: #e74c3c; font-weight: bold;">Atenção: Esta ação é irreversível!</p>
    <p>Para confirmar a exclusão da sua conta, digite sua senha atual:</p>
    <div class="show-password-container">
      <input id="exclusaoSenhaInput" type="password" placeholder="🔑 Sua Senha">
      <span class="show-password-toggle" onclick="togglePasswordVisibility('exclusaoSenhaInput', this)">👁️</span>
    </div>
    <button onclick="deletarConta()" style="background-color: #c0392b; margin-top: 15px;">Confirmar Exclusão Permanente</button>
    <button data-modal-id="modalConfirmarSenhaExclusao" onclick="fecharModal(event)">❌ Cancelar</button>
  </div>
</div>

<!-- Modal POPUP PERSISTENTE Novo Agendamento (Profissional) -->
<div id="modalNovoAgendamento" class="modal" style="z-index: 9999; background: rgba(0,0,0,0.9);">
  <div class="modal-content" style="border: 3px solid var(--cor-destaque); pointer-events: auto;" onclick="event.stopPropagation()">
    <h3 style="color: var(--cor-destaque); animation: flash-red 2s infinite;">🔔 Novo Agendamento!</h3>
    <div id="modalNovoAgendamentoInfo" style="text-align: left; margin-bottom: 20px;">
      <p><b>Cliente:</b> <span id="popupClienteNome"></span></p>
      <p><b>Serviço:</b> <span id="popupServicoNome"></span></p>
      <p><b>Horário:</b> <span id="popupHorario"></span></p>
      <p><b>Valor:</b> R$ <span id="popupValor"></span></p>
    </div>
    <div style="display: flex; gap: 10px;">
      <button id="btnRecusarAgendamentoPopup" style="background-color: #c0392b; flex: 1;">❌ Recusar</button>
      <button id="btnAceitarAgendamentoPopup" style="background-color: #2ecc71; flex: 1;">✅ Aceitar</button>
    </div>
    <a id="btnWhatsAppPopup" href="#" target="_blank" style="margin-top: 10px; display: block;">
      <button style="background-color: #25D366; width: 100%;">💬 WhatsApp do Cliente</button>
    </a>
  </div>
</div>

<!-- Modal Admin: Lista de Usuários Online -->
<div id="modalUsuariosOnline" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>Usuários Online (Últimos 5 min)</h3>
    <div id="listaUsuariosOnline" class="scrollable-list" style="max-height: 60vh;">
      <p>Carregando...</p>
    </div>
    <button data-modal-id="modalUsuariosOnline" onclick="fecharModal(event)" style="margin-top: 15px;">❌ Fechar</button>
  </div>
</div>

<!-- Modal Admin: Info Rápida do Chat -->
<div id="modalAdminInfoChat" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3 id="adminInfoChatNome">Info do Usuário</h3>
    <div id="adminInfoChatConteudo" class="scrollable-list" style="max-height: 50vh; text-align: left;">
      <p>Carregando...</p>
    </div>
    <div style="display: flex; gap: 10px; margin-top: 15px;">
      <button id="adminInfoChatBtnWpp" onclick="">💬 Chamar no WhatsApp</button>
      <button id="adminInfoChatBtnGerenciar" onclick="">⚙️ Gerenciamento Completo</button>
    </div>
    <button data-modal-id="modalAdminInfoChat" onclick="fecharModal(event)" style="margin-top: 10px;">❌ Fechar</button>
  </div>
</div>

<div id="modalMeuPerfil" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 500px;">
    <h3>👤 Editar Perfil</h3>
    
    <div style="text-align: center; margin-bottom: 15px;">
        <div style="position: relative; display: inline-block;">
            <img id="perfilFotoPreview" src="https://via.placeholder.com/100" class="perfil-foto-grande" style="width: 100px; height: 100px; border-radius: 50%; border: 2px solid #333;">
            <label for="perfilFotoInput" style="position: absolute; bottom: 0; right: 0; background: var(--cor-destaque); color: #000; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer;">📷</label>
        </div>
        <input type="file" id="perfilFotoInput" accept="image/*" style="display: none;" onchange="previewFotoPerfil()">
    </div>

    <label>Nome de Exibição:</label>
    <input type="text" id="perfilNomeInput" placeholder="Seu nome">

    <div class="popup-section">
        <h4>🎰 Roleta Diária</h4>
        <p id="roletaInfoPremios" style="font-size: 12px; color: #aaa; margin-bottom: 5px;"></p>
        
        <div class="roleta-wrapper-externo">
            
            <div class="seta-externa topo"></div>

            <div id="roletaVisual" class="roleta-container" style="margin: 0;">
                <div class="roleta-faixa" id="roletaFaixa"></div>
            </div>

            <div class="seta-externa baixo"></div>
            
        </div>
        <button id="btnGirarRoleta" onclick="girarRoleta()" style="width: 100%; font-weight: bold; font-size: 16px;">🎲 GIRAR (0)</button>
    </div>

    <div class="popup-section">
        <h4>🖼️ Molduras de Perfil</h4>
        <p style="font-size: 12px; opacity: 0.8;">Selecione para usar (✅) ou clique para comprar.</p>
        <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-top: 10px;" id="listaMolduras">
            </div>
    </div>

    <div class="popup-section">
        <h4>🏅 Exibir Conquistas (Máx 3)</h4>
        <div id="listaSelecaoConquistas" class="scrollable-list" style="max-height: 120px;"></div>
    </div>

    <div style="display: flex; gap: 10px; margin-top: 20px; border-top: 1px solid var(--cor-borda); padding-top: 15px;">
        <button onclick="fecharModalAtual()" style="background-color: #555; flex: 1;">❌ Cancelar</button>
        <button onclick="salvarNomePerfil()" style="flex: 1;">💾 Salvar Alterações</button>
    </div>
  </div>
</div>

<div id="modalVisualizarPerfilChat" class="modal" onclick="fecharModal(event)">
  <div class="modal-content perfil-visualizacao" onclick="event.stopPropagation()">
    <div class="perfil-visualizacao-content">
        <img id="visuPerfilFoto" src="" class="perfil-foto-grande">
        <h3 id="visuPerfilNome" style="margin: 5px 0; color: var(--cor-destaque);"></h3>
        <p id="visuPerfilTipo" style="font-size: 12px; opacity: 0.8; color: #fff;"></p>
        
        <div id="visuPerfilConquistas" style="display: flex; justify-content: center; gap: 10px; font-size: 24px; margin: 15px 0;"></div>
        
        <button data-modal-id="modalVisualizarPerfilChat" onclick="fecharModal(event)">Fechar</button>
    </div>
  </div>
</div>

<div id="modalBloqueante" class="modal" style="z-index: 9999; backdrop-filter: blur(5px);">
    <div class="modal-content" style="text-align: center; border: 2px solid var(--cor-destaque);">
        <h3 id="tituloBloqueante" style="color: var(--cor-destaque);">Atenção</h3>
        <p id="msgBloqueante" style="font-size: 1.1em; margin: 20px 0;"></p>
        <button id="btnOkBloqueante" style="width: 100%; padding: 12px; background: var(--cor-destaque); color: var(--cor-fundo); font-weight: bold;">OK</button>
    </div>
</div>
<footer class="app-footer">
  <div id="appVersion"></div>
</footer>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-messaging-compat.js"></script> 
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-storage-compat.js"></script>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script> 

<script>
// Firebase e variáveis globais
const firebaseConfig = {
  apiKey: "AIzaSyDBt7NcU5rP-hsrBZ07ne_HbiMCHRyVcnY",
  authDomain: "navalha-de-ouro-v11.firebaseapp.com",
  projectId: "navalha-de-ouro-v11",
  storageBucket: "navalha-de-ouro-v11.firebasestorage.app",
  messagingSenderId: "434474263075",
  appId: "1:434474263075:web:163893d68a1b5dbe74c796"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth(), db = firebase.firestore();

let popupGenericoCallback = null;

auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
  .then(() => {
    console.log("Persistência de autenticação definida para 'local'. O usuário ficará logado.");
  })
  .catch((error) => {
    console.error("Erro ao definir a persistência de autenticação:", error);
  });
const storage = firebase.storage();

const messaging = firebase.messaging(); 

// ADICIONE ESTAS LINHAS ABAIXO (Linha ~2241)
let isTwa = false; // Variável global para o ambiente

// --- CONFIGURAÇÕES GERAIS E FINANCEIRAS ---
const PIX_CODE_RAW = "00020126770014BR.GOV.BCB.PIX0136ac099e3b-e63e-402f-9d3e-6e20828470b90215Nova Versão APP5204000053039865802BR5920Josiel Lopes Azeredo6009SAO PAULO62140510ERLNMtaT5r63040E73";

// Variável global para controlar o tipo de depósito atual (serviço ou digital)
let tipoDepositoAtual = 'servico'; 

// Função para detectar se está no App (TWA) ou Navegador
function detectarAmbiente() {
    const urlParams = new URLSearchParams(window.location.search);
    // Verifica parâmetro URL ou se o referer vem de um app android
    if (urlParams.get('source') === 'twa' || document.referrer.includes('android-app')) {
        isTwa = true;
        console.log("Ambiente detectado: TWA (Google Play)");
    } else {
        isTwa = false;
        console.log("Ambiente detectado: Web (Navegador)");
    }
}
detectarAmbiente();

// Chama a função para definir a variável 'isTwa' na inicialização
detectarAmbiente(); 
const ADMIN_EMAIL = "josiel70c@gmail.com";
const ADMIN_PASS = "Ja997640401";
const TAXA = 0.20; // Atualizado para 20%
const BONUS_INDICACAO = 100;
const PONTOS_POR_CORTE = 10;
const PONTOS_PARA_RESGATE = 100;
const VALOR_RESGATE = 5;
const PONTOS_POR_DEPOSITO_NORMAL = 4;
const PONTOS_POR_DEPOSITO_VIP = 8;
const WHATSAPP_ADM_PHONE = "5527995003737"; // Mantido
const PRECO_VIP = 29.90; 
const PRECO_TURBINAR = 9.99;

// Novos Planos PRO
const PRECOS_PRO = { 
    tier1: { nome: 'Bronze', preco: 29.90, taxa: 0.15, giros: 2 }, 
    tier2: { nome: 'Prata', preco: 59.90, taxa: 0.10, giros: 3 }, 
    tier3: { nome: 'Ouro', preco: 99.90, taxa: 0.05, giros: 4 }, 
    tier4: { nome: 'Diamante', preco: 199.90, taxa: 0.00, giros: 5 }
};

// Novas Molduras
const MOLDURAS = {
    bronze: { nome: 'Bronze', preco: 9.99, classe: 'avatar-frame-bronze' },
    prata: { nome: 'Prata', preco: 19.99, classe: 'avatar-frame-prata' },
    ouro: { nome: 'Ouro', preco: 29.99, classe: 'avatar-frame-ouro' },
    diamante: { nome: 'Diamante', preco: 39.99, classe: 'avatar-frame-diamante' },
    // NOVAS MOLDURAS ADMIN
    admin_black: { nome: 'Supreme Black', preco: 9999, classe: 'avatar-frame-admin-black', adminOnly: true },
    admin_red: { nome: 'Supreme Red', preco: 9999, classe: 'avatar-frame-admin-red', adminOnly: true }
};

// NOVOS BALÕES DE CHAT
const BALOES = {
    bronze: { nome: 'Chat Bronze', preco: 9.99, classe: 'bubble-bronze' },
    prata: { nome: 'Chat Prata', preco: 19.99, classe: 'bubble-prata' },
    ouro: { nome: 'Chat Ouro', preco: 29.99, classe: 'bubble-ouro' },
    diamante: { nome: 'Chat Diamante', preco: 39.99, classe: 'bubble-diamante' },
    // EXCLUSIVOS ADMIN
    admin_black: { nome: 'Supreme Black', preco: 9999, classe: 'bubble-admin-black', adminOnly: true },
    admin_red: { nome: 'Supreme Red', preco: 9999, classe: 'bubble-admin-red', adminOnly: true }
};

let fcmSetupDone = false;
let isSending = false;
let perfil = null;
let agendamentoListener = null;
let currentModal = null;
let chatListener = null;
let barbeirosListener = null;
let tempSelectedHorarios = {};
let onboardingState = {};
let tempOnboardingServicos = [];
const CHAT_GLOBAL_ID = "chatGlobal";
let newWorker;
let localizacaoCliente = null;
let cadastroCoords = null;
let vendaListener = null;
let produtoEmEdicaoId = null; 
let produtoParaCompra = null;
let pixTimerInterval = null; 
let pendenciasInterval = null; 
let pedidosVendedorListener = null;
let comprasClienteListener = null; 
let aguardeTimeoutId = null;
let portfolioListener = null; // Guarda a referência do listener
let imagensMarcadasParaExcluir = []; // Array global temporário para guardar URLs a excluir
let modalOriginalIdParaConfirmar = null;
let fluxoPosCadastroAtivo = false;
let lastReloadTimestamp = null; // Variável para controlar o reload forçado
let previousTipo = null;
let onConfirmCallback = null;
let avaliacaoAgendamentoId = null;
let avaliacaoBarbeiroUid = null;
let popupAgendamentoAberto = false;

let userView = {
    originalType: null,
    currentType: null
};

let mostrarApenasFavoritos = false; // Estado do filtro
let agendamentoState = {
    barbeiroUid: null,
    barbeiroNome: null,
    servico: null,
    horario: null, 
    barbeiroLat: null,
    barbeiroLon: null,
};

let adminBalanceListener = null;
let adminUserBalances = {};
let globalChatListener = null;
let lastGlobalMessageTimestamp = null;
let newMessagesCount = 0;
let oldestMessageSnapshot = null; // Variável para paginação do chat

let deferredInstallPrompt = null;
let chatPreviewTimeout = null; 
let aguardeClickCount = 0;
let updateLastSeenInterval = null;
let onlineUsersListener = null;
const USER_ACTIVE_THRESHOLD_MS = 5 * 60 * 1000; // 5 minutos
const BACKEND_API_URL = 'https://navalhabackend.onrender.com';

// --- [LÓGICA DE POPUP DE AGUARDE E MODAIS] ---
function exibirAguarde(texto = "Aguarde...") {
    // Limpa qualquer timeout anterior para evitar múltiplos popups de erro
    if (aguardeTimeoutId) {
        clearTimeout(aguardeTimeoutId);
        aguardeTimeoutId = null;
    }

    document.getElementById('popupAguardeTexto').textContent = texto;
    const popup = document.getElementById('popupAguarde');
    // Garante que está visível antes de adicionar a classe show
    popup.style.display = 'flex';
    // Adiciona um pequeno delay para a transição CSS funcionar
    setTimeout(() => popup.classList.add('show'), 10);
    aguardeClickCount = 0; // Reseta a contagem de cliques para fechar

    // Define o timeout de 10 segundos
    aguardeTimeoutId = setTimeout(() => {
        // Verifica se o popup ainda está visível (pode já ter sido fechado por sucesso)
        if (popup.classList.contains('show')) {
            fecharAguarde(null, true); // Força o fechamento do "Aguarde"
            exibirPopup('Ops!', 'A operação demorou mais que o esperado. Verifique sua conexão e tente novamente.', 'erro');
        }
        aguardeTimeoutId = null; // Limpa o ID do timeout
    }, 10000); // 10000 milissegundos = 10 segundos
}

/* === Onboarding Tela 2 - Funções de Seleção === */
function toggleOnboardOption(element) {
    const parent = element.closest('.onboard-screen');
    // Remove 'selected' de todos os irmãos
    parent.querySelectorAll('.onboard-option').forEach(op => {
        op.classList.remove('selected');
    });
    // Adiciona 'selected' ao item clicado
    element.classList.add('selected');

    // Salva a seleção no localStorage
    const valor = element.getAttribute('data-value');
    localStorage.setItem('onboard_tipo_uso', valor);
    
    // Habilita o botão 'Continuar' (se houver)
    const btnContinuar = parent.querySelector('.btn-primary');
    if (btnContinuar) {
        btnContinuar.disabled = false;
    }
}

async function carregarBarbeirosPrincipal(containerId, isGuest = false) {
    const lista = document.getElementById(containerId);
    // Feedback imediato de carregamento
    lista.innerHTML = "<p style='text-align:center; margin-top:20px; opacity:0.7;'>⏳ Buscando os profissionais mais próximos de você...</p>";

    // Tenta obter localização em paralelo (sem travar se falhar rápido)
    if (!localizacaoCliente) { 
        try { await obterLocalizacaoAtual(); } catch(e) {} 
    }
    
    if (barbeirosListener) barbeirosListener(); 
    
    let tipoParaBuscar = 'barbeiro'; 

    if (isGuest) {
        tipoParaBuscar = localStorage.getItem('onboard_tipo_uso') || 'barbeiro';
        if (tipoParaBuscar === 'cliente' || tipoParaBuscar === 'profissional') tipoParaBuscar = 'barbeiro';
    } else {
        tipoParaBuscar = perfil.interesse_principal || perfil.tipo || 'barbeiro';
    }

    let query = db.collection("usuarios").where("tipo", "==", tipoParaBuscar);
    
    barbeirosListener = query.onSnapshot(snap => {
        if (snap.empty) {
             let nomeCategoria = "nesta categoria";
             if(tipoParaBuscar === 'barbeiro') nomeCategoria = "Barbearias";
             if(tipoParaBuscar === 'manicure_pedicure') nomeCategoria = "Manicure/Pedicure";
             if(tipoParaBuscar === 'designer_cilios') nomeCategoria = "Design de Cílios";
             
             lista.innerHTML = `<div style="text-align:center; padding:20px;"><p>😔 Nenhum profissional de <b>${nomeCategoria}</b> encontrado no momento.</p></div>`;
             return;
        }

        let barbeiros = [];
        const favoritos = (perfil && perfil.favoritos) ? perfil.favoritos : [];

        snap.forEach(doc => {
            const b = doc.data();
            b.uid = doc.id;
            b.isFavorito = favoritos.includes(b.uid);

            if (localizacaoCliente && b.latitude && b.longitude) {
                b.distancia = calcularDistancia(localizacaoCliente.latitude, localizacaoCliente.longitude, b.latitude, b.longitude);
            } else {
                b.distancia = Infinity;
            }
            barbeiros.push(b);
        });

        // ORDENAÇÃO INTELIGENTE
        barbeiros.sort((a, b) => {
            if (a.isFavorito && !b.isFavorito) return -1;
            if (!a.isFavorito && b.isFavorito) return 1;

            const aDisp = a.vagaImediata || (a.usaAgendaManual && Object.values(a.agenda || {}).some(v => v === true));
            const bDisp = b.vagaImediata || (b.usaAgendaManual && Object.values(b.agenda || {}).some(v => v === true));
            if (aDisp !== bDisp) return aDisp ? -1 : 1;

            const aBoost = a.boostExpiracao && a.boostExpiracao.toDate() > new Date();
            const bBoost = b.boostExpiracao && b.boostExpiracao.toDate() > new Date();
            if (aBoost !== bBoost) return aBoost ? -1 : 1;
            
            const aPro = isProAtivo(a);
            const bPro = isProAtivo(b);
            if (aPro !== bPro) return aPro ? -1 : 1;

            return a.distancia - b.distancia;
        });
        
        // --- OTIMIZAÇÃO DE PERFORMANCE (BUFFER) ---
        // Acumula todo o HTML em uma string gigante antes de jogar na tela
        let htmlBuffer = "";
        
        barbeiros.forEach(b => {
            const notaMedia = (b.numAvaliacoes > 0) ? (b.somaAvaliacoes / b.numAvaliacoes) : 5;
            const estrelas = Math.round(notaMedia / 2); 
            const reputacaoEstrelas = '⭐'.repeat(Math.max(0, Math.min(5, estrelas)));
            const reputacaoTexto = b.numAvaliacoes > 0 ? `${notaMedia.toFixed(1)}/10` : 'Novo';

            let statusHtml = '';
            const agora = new Date();
            const estaAusente = b.ausente && b.ausenciaInicio && b.ausenciaFim && agora >= b.ausenciaInicio.toDate() && agora <= b.ausenciaFim.toDate();
            const isDisponivel = b.vagaImediata || (b.usaAgendaManual && Object.values(b.agenda || {}).some(v => v === true));
            
            if (estaAusente) {
                const dataFim = b.ausenciaFim.toDate().toLocaleDateString('pt-BR');
                statusHtml = `<div class="card-status status-indisponivel">🏖️ Ausente (Volta ${dataFim})</div>`;
            } else if (!isDisponivel) {
                 statusHtml = `<div class="card-status status-indisponivel">🔴 Indisponível</div>`;
            } else if (b.vagaImediata) {
                statusHtml = `<div class="card-status status-imediato">⚡ Vaga Imediata</div>`;
            } else if (b.usaAgendaManual) {
                const horarios = Object.keys(b.agenda || {}).filter(h => b.agenda[h] === true).sort();
                statusHtml = horarios.length > 0 ? `<div class="card-status status-manual">📅 Horários Disponíveis</div>` : `<div class="card-status status-indisponivel">📋 Sem horários hoje</div>`;
            }
            
            let promocoesHtml = (b.promocoes && b.promocoes.length > 0) ? `<div class="promo-info">🎁 ${b.promocoes[0].nome} (${b.promocoes[0].desconto}% OFF)</div>` : '';
            const logoHtml = b.logo_url ? `<img src="${b.logo_url}" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover;" loading="lazy">` : `<div style="width:60px;height:60px;background:#333;border-radius:50%;display:flex;align-items:center;justify-content:center;">💈</div>`;
            const distanciaTexto = b.distancia !== Infinity ? `<p>📍 ~${b.distancia.toFixed(1)} km</p>` : `<p>🏙️ ${b.cidade}</p>`;
            const isBoosted = b.boostExpiracao && b.boostExpiracao.toDate() > new Date();
            const boostIcon = isBoosted ? '<span class="boost-icon">🚀</span>' : '';
            
            const heartColor = b.isFavorito ? 'var(--cor-destaque)' : 'white';
            const heartIcon = b.isFavorito ? '❤️' : '♡';
            
            const favoriteBtn = `<button class="card-action-btn card-favorite-btn" style="color:${heartColor}" onclick="event.stopPropagation(); ${isGuest ? "exibirPopup('Faça login', 'Crie uma conta para favoritar!'); mostrar('authView');" : `toggleFavorito('${b.uid}')`}">${heartIcon}</button>`;
            const shareBtn = `<button class="card-action-btn card-share-btn" onclick="event.stopPropagation(); compartilharPerfil('${b.nome}', '${b.uid}')">🔗</button>`;

            // Adiciona ao buffer em vez de desenhar na tela
            htmlBuffer += `
              <div class="card barbeiro-card ${isBoosted ? 'boosted-card' : ''}" onclick="abrirBarbeiroPerfil('${b.uid}', ${isGuest})">
                  ${boostIcon} ${favoriteBtn} ${shareBtn}
                  <div class="card-header">
                      ${logoHtml}
                      <div class="card-header-info">
                          <h4 class="professional-name-card">${b.nome}</h4>
                          ${distanciaTexto}
                          <p class="card-reputacao-info">${reputacaoEstrelas} <span>(${reputacaoTexto})</span></p> 
                      </div>
                  </div>
                  ${statusHtml} ${promocoesHtml}
              </div>`;
        });

        // INJEÇÃO ÚNICA (Muito mais rápido)
        lista.innerHTML = htmlBuffer;
    });
}

function fecharAguarde(event) {
    // Permite fechar com 2 cliques fora
    if (event && event.target.id === 'popupAguarde') {
        aguardeClickCount++;
        if (aguardeClickCount >= 2) {
            fecharModalAtual(true); // Força o fechamento do popupAguarde
            aguardeClickCount = 0;
        }
    }
}

let modalStack = [];

// SUBSTITUA A FUNÇÃO 'exibirPopup'
// SUBSTITUA A FUNÇÃO 'exibirPopup'
function exibirPopup(titulo, mensagem, tipo = 'info', onOkCallback = null) { // Adiciona 'onOkCallback'
    // Fecha qualquer popup de aguarde que possa estar aberto
    const aguardePopup = document.getElementById('popupAguarde');
    if (aguardePopup.classList.contains('show')) {
        fecharAguarde(null, true);
    }

    const tituloEl = document.getElementById('popupGenericoTitulo');
    const mensagemEl = document.getElementById('popupGenericoMensagem');
    const modalContent = document.querySelector('#modalPopupGenerico .modal-content');

    // Define o título e a mensagem
    tituloEl.textContent = titulo;
    mensagemEl.textContent = mensagem;

    // Ajusta a cor do título com base no tipo (opcional)
    let corTitulo = 'var(--cor-destaque)'; // Padrão dourado
    if (tipo === 'sucesso') corTitulo = '#2ecc71'; // Verde
    else if (tipo === 'erro') corTitulo = '#e74c3c'; // Vermelho
    else if (tipo === 'aviso') corTitulo = '#f1c40f'; // Amarelo

    tituloEl.style.color = corTitulo;
    // Reset border style
    modalContent.style.border = '1px solid var(--cor-borda)';

    // Armazena o callback para a função handlePopupGenericoOk usar
    popupGenericoCallback = onOkCallback;

    // Abre o modal genérico
    abrirModal('modalPopupGenerico');
}

function handlePopupGenericoOk(event) {
    // Fecha o modal genérico
    fecharModal(event); 
    
    // Executa o callback se ele existir
    if (popupGenericoCallback) {
        popupGenericoCallback(); // Executa a ação (ex: abrirModalEtapa1)
        popupGenericoCallback = null; // Limpa o callback
    }
}

// Modificar fecharAguarde para aceitar um segundo argumento para forçar fechamento
function fecharAguarde(event, force = false) {
    const popup = document.getElementById('popupAguarde');
    // Permite fechar com 2 cliques fora OU se force for true
    if (force || (event && event.target.id === 'popupAguarde')) {
        if (!force) {
            aguardeClickCount++;
        }
        if (force || aguardeClickCount >= 2) {
             // Verifica se o modal está na pilha antes de tentar removê-lo
             const indexNaPilha = modalStack.indexOf(popup);
             if (indexNaPilha > -1) {
                 modalStack.splice(indexNaPilha, 1); // Remove da pilha se estiver lá
             }
            popup.classList.remove('show');
            setTimeout(() => popup.style.display = 'none', 300);
            aguardeClickCount = 0;
        }
    }
}

function abrirModal(modalId) {
    const novoModal = document.getElementById(modalId);

    // Verifica se o modal existe e se já não está aberto
    if (novoModal && !novoModal.classList.contains('show')) {
        
        // --- NOVA LÓGICA DE EMPILHAMENTO (STACKING) ---
        // 1. Definimos uma base alta (2000) para ficar acima de botões fixos como o do Chat
        const baseZIndex = 2000;
        
        // 2. Calculamos o incremento: Se já tem 1 modal aberto, soma +10. Se tem 2, +20.
        // Isso garante que o novo SEMPRE tenha um número maior que o anterior.
        const incremento = modalStack.length * 10;
        
        // 3. Aplica o novo Z-Index diretamente no elemento
        novoModal.style.zIndex = baseZIndex + incremento;

        // --- FIM DA LÓGICA NOVA ---

        novoModal.style.display = 'flex';
        setTimeout(() => {
            novoModal.classList.add('show');
            modalStack.push(novoModal); // Adiciona à pilha para controle do botão voltar/fechar
        }, 10);
    }
}

function fecharModal(event) {
    // Permite fechar clicando no fundo (classe .modal) ou em um botão com data-modal-id
    if (event && event.target.classList.contains('modal') || event.target.getAttribute('data-modal-id')) {
        
        // Impede o fechamento do modal de novo agendamento
        if (event.target.id === 'modalNovoAgendamento') {
            console.log("Fechamento do modal de agendamento bloqueado.");
            return;
        }
        
        fecharModalAtual();
    }
}

function fecharModalAtual(forcePopupAguarde = false) {
    if (forcePopupAguarde) {
        const popup = document.getElementById('popupAguarde');
        popup.classList.remove('show');
        setTimeout(() => popup.style.display = 'none', 300);
        return;
    }
    
    if (intervaloRelogiosPerfil) {
        clearInterval(intervaloRelogiosPerfil);
        intervaloRelogiosPerfil = null;
    }

    if (modalStack.length > 0) {
        const modalParaFechar = modalStack.pop();
        modalParaFechar.classList.remove('show');
        setTimeout(() => {
            modalParaFechar.style.display = 'none';
        }, 300);
    }
}

function fecharTodosOsModais() {
    // Fecha todos os modais da pilha
    while (modalStack.length > 0) {
        fecharModalAtual();
    }
    
    // Garante que o de aguarde feche também
    const popup = document.getElementById('popupAguarde');
    if(popup.classList.contains('show')){
       fecharModalAtual(true);
    }

    // Força o fechamento de qualquer modal de onboarding que possa ter ficado aberto
    // (Medida de segurança caso a pilha falhe)
    document.querySelectorAll('.modal[id^="modalOnboarding"]').forEach(modal => {
        if (modal.classList.contains('show')) {
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }
    });
    // Fecha também o popup de aviso
    const avisoOnboarding = document.getElementById('modalAvisoOnboarding');
    if (avisoOnboarding.classList.contains('show')) {
        avisoOnboarding.classList.remove('show');
        setTimeout(() => {
            avisoOnboarding.style.display = 'none';
        }, 300);
    }
}


// Funções de UI
function mostrar(id) {
    const views = ["authView", "guestView", "clienteView", "barbeiroView", "adminView", "lojaView"];
    const viewAtual = views.find(v => !document.getElementById(v).classList.contains('hidden'));
    const viewNova = document.getElementById(id);
    const viewAtualEl = viewAtual ? document.getElementById(viewAtual) : null;
    
    if (viewAtualEl && viewAtualEl !== viewNova) {
        viewAtualEl.classList.add('exiting');
        setTimeout(() => {
            viewAtualEl.classList.add("hidden");
            viewAtualEl.classList.remove('exiting');
            
            views.forEach(v => { if (v !== id) document.getElementById(v)?.classList.add("hidden"); });
            
            viewNova?.classList.remove("hidden");
            viewNova?.classList.add("entering");
            
            setTimeout(() => {
                viewNova?.classList.remove("entering");
            }, 10);
        }, 400);
    } else {
        views.forEach(v => document.getElementById(v)?.classList.add("hidden"));
        viewNova?.classList.remove("hidden");
    }

    const isAuth = (id === 'authView');
    document.getElementById("topbar").classList.toggle("hidden", isAuth);
    document.getElementById("bottomButtons").classList.toggle("hidden", isAuth);
    document.getElementById("redeemContainer").classList.toggle("hidden", id !== 'clienteView' && id !== 'barbeiroView' && id !== 'adminView');
    
    document.getElementById("btnTema").classList.toggle("hidden", isAuth);
    document.getElementById("btnConfig").classList.toggle("hidden", isAuth);
    document.getElementById("btnCarteiraTop").classList.toggle("hidden", id !== 'clienteView' && id !== 'barbeiroView' && id !== 'adminView');
    document.getElementById("botaoExtra").classList.toggle("hidden", id === 'authView' || id === 'guestView');
    document.getElementById("btnSair").classList.toggle("hidden", isAuth || id === 'guestView');
}

// --- FIM DA PARTE 1: CONTINUA NA PARTE 2 COM O RESTANTE DO JAVASCRIPT E FUNÇÕES DE ROTEAMENTO ---

// --- INÍCIO DA PARTE 2: CONTINUAÇÃO DO JAVASCRIPT DO index.html ---
function configurarBotoesGuest() {
    const guestView = document.getElementById('guestView');
    const buttons = guestView.querySelectorAll('#guestFuncoesContainer button');
    buttons.forEach(btn => {
        const originalText = btn.textContent.trim();
        // Mantém a funcionalidade original do botão "Loja"
        if (originalText === 'Loja') {
            btn.onclick = () => { mostrar('lojaView'); carregarProdutos(); };
            return;
        }
        
        // Para todos os outros botões, exibe um alerta para o usuário se logar
        btn.onclick = () => {
            exibirPopup("Para acessar esta função, por favor, crie uma conta ou faça login.");
            mostrar('authView'); // Direciona para a tela de login
        };
    });
}

function mostrarPainelAtual() {
    mostrar(`${userView.currentType}View`);
}

function solicitarPermissaoNotificacao() {
    if ('Notification' in window && Notification.permission === 'default') {
        abrirModal('modalPermissaoNotificacao');
    }
}

function pedirPermissaoEFechar() {
    Notification.requestPermission().then(permission => {
        if (permission === 'granted') {
            const user = auth.currentUser;
            if (user) {
                setupFCM(user.uid);
            }
        }
    });
    fecharModalAtual();
}

async function garantirTokenAtualizadoNoPerfil(uid) {
    try {
        const currentToken = await messaging.getToken({ vapidKey: 'BGkXq9v27VKT9Tl1DF2QBhP3c77lF4xDdptbay3jaKtlhw-5-G6D2GP7qcsjlweme9WggzBipoCDulIdSiuEfPE' });
        if (currentToken) {
            const userRef = db.collection('usuarios').doc(uid);
            const userDoc = await userRef.get();
            if (userDoc.exists) {
                const tokens = userDoc.data().fcmTokens || [];
                if (!tokens.includes(currentToken)) {
                    await userRef.update({
                        fcmTokens: firebase.firestore.FieldValue.arrayUnion(currentToken)
                    });
                }
            }
        }
    } catch(err) {
        console.error('Erro ao garantir token atualizado:', err);
    }
}


// SUBSTITUA a função setupFCM inteira por esta
function setupFCM(uid) {
    if (fcmSetupDone || !('serviceWorker' in navigator) || !firebase.messaging.isSupported()) {
        console.log("FCM não suportado ou já configurado.");
        return;
    }

    // Garante que a permissão seja solicitada
    Notification.requestPermission().then((permission) => {
        if (permission === 'granted') {
            console.log('Permissão de notificação concedida.');
            fcmSetupDone = true;

            // Obtém o token do dispositivo
            messaging.getToken({ vapidKey: 'BGkXq9v27VKT9Tl1DF2QBhP3c77lF4xDdptbay3jaKtlhw-5-G6D2GP7qcsjlweme9WggzBipoCDulIdSiuEfPE' })
            .then((currentToken) => {
                if (currentToken) {
                    console.log('Token FCM obtido:', currentToken);
                    // Salva o token no perfil do usuário no Firestore
                    db.collection('usuarios').doc(uid).update({
                        fcmTokens: firebase.firestore.FieldValue.arrayUnion(currentToken)
                    });
                } else {
                    console.warn('Não foi possível obter o token de notificação. A permissão foi concedida, mas o token está vazio.');
                }
            }).catch((err) => {
                console.error('Ocorreu um erro ao obter o token.', err);
            });
        } else {
            console.warn('Permissão de notificação negada.');
        }
    });
}

function alternarTema() {
  const body = document.body;
  const isLight = body.classList.toggle('tema-claro');
  document.getElementById('btnTema').textContent = isLight ? '☀️' : '🌙';
}

function setupViewSwitcher() {
    const container = document.getElementById("botaoExtra");
    container.innerHTML = "";
    if (!userView.originalType || !userView.currentType) return;
    
    // Admins veem tudo
    if (userView.originalType === 'admin') {
        const createButton = (text, view) => {
            const btn = document.createElement("button");
            btn.textContent = text;
            btn.onclick = () => switchView(view);
            if (userView.currentType === view) {
                btn.disabled = true;
                btn.style.borderColor = "var(--cor-destaque)";
            }
            container.appendChild(btn);
        };
        createButton("🧠 Admin", "admin");
        createButton("💈 Profissional", "barbeiro");
        createButton("🙋 Cliente", "cliente");
        createButton("🛍️ Loja", "loja");
        return;
    }
    
    // Usuários normais têm a visão simplificada
    const lojaVisivel = userView.currentType === 'loja';
    if (lojaVisivel) {
        const btnPainel = document.createElement("button");
        btnPainel.textContent = "↩️ Painel Principal";
        btnPainel.onclick = () => switchView(userView.originalType); // Volta para o painel de origem
        container.appendChild(btnPainel);
    } else {
        const btnLoja = document.createElement("button");
        btnLoja.textContent = "🛍️ Loja";
        btnLoja.onclick = () => switchView('loja');
        container.appendChild(btnLoja);
    }
}


function switchView(view) {
    userView.currentType = view;
    renderCurrentView();
}

function renderCurrentView() {
    setupViewSwitcher();
    if (adminBalanceListener) {
        adminBalanceListener();
        adminBalanceListener = null;
    }
    
    document.getElementById('btnGerenciarLojaCliente').classList.add('hidden');
    document.getElementById('btnGerenciarLojaBarbeiro').classList.add('hidden');

    if(perfil && (perfil.lojaLiberada || perfil.tipo === 'admin')) {
      if(userView.currentType === 'cliente') document.getElementById('btnGerenciarLojaCliente').classList.remove('hidden');
      if(userView.currentType === 'barbeiro') document.getElementById('btnGerenciarLojaBarbeiro').classList.remove('hidden');
    }

// Controla a visibilidade do contador de usuários online
const countElement = document.getElementById('onlineUserCount');
if (countElement) {
    // Mostra se for admin E a visão atual for admin, esconde caso contrário
    countElement.classList.toggle('hidden', !(perfil && perfil.tipo === 'admin' && userView.currentType === 'admin'));
}

    switch (userView.currentType) {
        case 'admin':
            mostrar("adminView");
            carregarAdmin();
            break;
        case 'barbeiro':
        case 'manicure_pedicure':
        case 'designer_cilios':
            mostrar("barbeiroView"); // Usa a mesma view para todos os profissionais
            carregarBarbeirosPrincipal('listaBarbeirosPrincipalBarbeiro', false);
            break;
        case 'cliente':
            mostrar("clienteView");
            carregarBarbeirosPrincipal('listaBarbeirosPrincipalCliente', false);
            break;
        case 'loja':
            mostrar("lojaView");
            carregarProdutos();
            break;
        default:
            mostrar("authView");
    }
}


const cidadesPorEstado = {
  "ES": ["Aracruz", "Vitória", "Serra", "Linhares", "Colatina", "Cachoeiro de Itapemirim", "Guarapari", "Vila Velha", "São Mateus", "Barra de São Francisco"], "SP": ["São Paulo", "Campinas", "Santos", "Ribeirão Preto", "Sorocaba"], "RJ": ["Rio de Janeiro", "Niterói", "Petrópolis", "Volta Redonda", "Campos dos Goytacazes"], "MG": ["Belo Horizonte", "Uberlândia", "Contagem", "Juiz de Fora", "Montes Claros"], "BA": ["Salvador", "Feira de Santana", "Vitória da Conquista", "Ilhéus", "Barreiras"], "PR": ["Curitiba", "Londrina", "Maringá", "Cascavel", "Ponta Grossa"], "RS": ["Porto Alegre", "Caxias do Sul", "Pelotas", "Santa Maria", "Novo Hamburgo"], "SC": ["Florópolis", "Joinville", "Blumenau", "Chapecó", "Criciúma"], "PE": ["Recife", "Olinda", "Caruaru", "Petrolina", "Garanhuns"], "CE": ["Fortaleza", "Juazeiro do Norte", "Sobral", "Crato", "Iguatu"], "DF": ["Brasília"]
};

function carregarEstados(prefix = '') {
  // Constrói o ID específico para o select de estado baseado no prefixo
  const estadoSelectId = prefix ? `${prefix}Estado` : 'estado';
  const estadoSelect = document.getElementById(estadoSelectId);

  // Se o elemento select específico não for encontrado, loga um erro e sai
  if (!estadoSelect) {
      console.error(`Erro em carregarEstados: Elemento select com ID "${estadoSelectId}" não encontrado.`);
      // Tenta um fallback apenas se o prefixo falhou
      const fallbackSelect = prefix ? document.getElementById('estado') : null;
      if (fallbackSelect) {
           console.warn(`Usando fallback para o select de estado ID "estado" pois "${estadoSelectId}" não foi encontrado.`);
           // Poderia continuar com o fallbackSelect aqui, mas vamos retornar para focar no problema do prefixo
           return;
      } else {
           return; // Sai se nenhum select for encontrado
      }
  }

  console.log(`[Debug] Carregando estados para o select ID: "${estadoSelectId}"`); // Log de depuração

  const valorAtual = estadoSelect.value; // Guarda o valor atual antes de limpar
  estadoSelect.innerHTML = '<option value="">🌎 Selecione o estado</option>'; // Limpa opções existentes

  // Preenche com os estados
  Object.keys(cidadesPorEstado).sort().forEach(sigla => {
    const option = document.createElement('option');
    option.value = sigla;
    option.textContent = sigla;
    if (sigla === valorAtual) {
      option.selected = true; // Tenta re-selecionar o valor anterior
    }
    estadoSelect.appendChild(option);
  });
  console.log(`[Debug] Estados carregados para "${estadoSelectId}". Opções:`, estadoSelect.options.length); // Log de depuração
}

function carregarCidades(prefix = '') {
  // Constrói os IDs específicos baseados no prefixo
  const estadoSelectId = prefix ? `${prefix}Estado` : 'estado';
  const cidadeSelectId = prefix ? `${prefix}Cidade` : 'cidade';

  const estadoSelect = document.getElementById(estadoSelectId);
  const cidadeSelect = document.getElementById(cidadeSelectId);

  // Se os elementos não forem encontrados, loga um erro e sai
  if (!estadoSelect) {
      console.error(`Erro em carregarCidades: Elemento select de estado com ID "${estadoSelectId}" não encontrado.`);
      return;
  }
  if (!cidadeSelect) {
      console.error(`Erro em carregarCidades: Elemento select de cidade com ID "${cidadeSelectId}" não encontrado.`);
      return;
  }

  console.log(`[Debug] Carregando cidades para "${cidadeSelectId}" baseado no estado de "${estadoSelectId}"`); // Log de depuração

  const estado = estadoSelect.value;
  const valorAtual = cidadeSelect.value; // Guarda o valor atual da cidade

  // Limpa opções da cidade e desabilita
  cidadeSelect.innerHTML = '<option value="">🏙️ Selecione a cidade</option>';
  cidadeSelect.disabled = true;

  if (!estado) {
    console.log(`[Debug] Nenhum estado selecionado em "${estadoSelectId}", cidades não carregadas.`);
    return; // Nenhum estado selecionado, não faz mais nada
  }

  const cidades = cidadesPorEstado[estado] || [];

  if (cidades.length > 0) {
      cidades.sort().forEach(c => {
        const option = document.createElement('option');
        option.value = c;
        option.textContent = c;
        // Não precisa setar 'selected' aqui, faremos isso depois se necessário
        cidadeSelect.appendChild(option);
      });
      cidadeSelect.disabled = false; // Habilita o select de cidade
      console.log(`[Debug] ${cidades.length} cidades carregadas para "${cidadeSelectId}".`); // Log de depuração
  } else {
       console.log(`[Debug] Nenhuma cidade encontrada para o estado "${estado}"`);
       // Mantém o select de cidade desabilitado
  }

  // Tenta re-selecionar o valor original da cidade DEPOIS de popular as opções
  // Isso é importante caso o valorAtual fosse de um estado diferente
  if (valorAtual && cidadeSelect.querySelector(`option[value="${valorAtual}"]`)) {
      cidadeSelect.value = valorAtual;
      console.log(`[Debug] Cidade "${valorAtual}" re-selecionada em "${cidadeSelectId}".`)
  } else if (cidades.length > 0) {
      // Se não conseguiu re-selecionar o valor antigo (ou não tinha um), e há cidades,
      // seleciona a primeira opção (que é "Selecione a cidade")
      cidadeSelect.value = "";
  }
}


function entrar() {
  // VERIFICA SE O FORMULÁRIO DE CADASTRO ESTÁ VISÍVEL
  const cadastroFields = document.getElementById("cadastro-fields");
  if (!cadastroFields.classList.contains('hidden')) {
    criarConta(); // Se estiver visível, chama a função de criar conta
    return;
  }

  // Lógica original de login
  exibirAguarde("Entrando...");
  const email = document.getElementById("email").value.trim();
  const senha = document.getElementById("senha").value.trim();
  if (!email || !senha) {
    fecharTodosOsModais();
    return exibirPopup("Preencha os campos corretamente.");
  }
  auth.signInWithEmailAndPassword(email, senha)
    .then(() => {
        console.log("Login OK");
        fecharTodosOsModais();
    })
    .catch(e => {
        fecharTodosOsModais();
        exibirPopup("Erro ao entrar: email ou senha incorreta");
    });
}

function prepararCriarConta() {
    obterLocalizacaoCadastro(); // Adicione esta linha
    document.getElementById("senha").classList.add("hidden");
    document.querySelector("#authView button:first-of-type").style.display = "none";
    document.getElementById("cadastro-fields").classList.remove("hidden");

    // Mantém a senha se já digitada, senão, deixa em branco
    document.getElementById("senha-cadastro").value = document.getElementById("senha").value;

    // --- LÓGICA ADICIONADA AQUI ---
    const tipoSelect = document.getElementById("tipo");
    if (onboardingState.perfil_basico === 'profissional') {
        tipoSelect.classList.remove('hidden');
        // Remove a opção "Cliente" para evitar confusão
        if (tipoSelect.querySelector('option[value="cliente"]')) {
             tipoSelect.querySelector('option[value="cliente"]').remove();
        }
    } else {
        // Se for cliente, esconde o select e define o valor padrão
        tipoSelect.classList.add('hidden');
        tipoSelect.value = 'cliente';
    }
    // --- FIM DA LÓGICA ADICIONADA ---

    document.getElementById("btnCriarConta").onclick = criarConta;
    document.getElementById("btnCriarConta").textContent = "🆕 Criar Conta";
    document.getElementById("btnVoltar").classList.remove("hidden");
    document.getElementById("senha-cadastro").type = "text";
    document.getElementById("senha-confirm").type = "text";
    obterLocalizacaoCadastro(); 
}

function voltarParaLogin() {
    document.getElementById("cadastro-fields").classList.add("hidden");
    document.getElementById("btnVoltar").classList.add("hidden");
    document.getElementById("email").classList.remove("hidden");
    document.getElementById("senha").classList.remove("hidden");
    document.querySelector("#authView button:first-of-type").style.display = "block";
    document.getElementById("btnCriarConta").onclick = prepararCriarConta;
    document.getElementById("btnCriarConta").textContent = "🆕 Criar conta";
    document.getElementById("senha-cadastro").value = "";
    document.getElementById("senha-confirm").value = "";
    document.getElementById("senha-cadastro").type = "password";
    document.getElementById("senha-confirm").type = "password";
    cadastroCoords = null;
}

// ADICIONE ESTA FUNÇÃO NO INDEX.HTML
async function enviarSolicitacaoRecuperacaoSenha() {
    const email = document.getElementById('recuperaEmail').value.trim();
    const telefone = document.getElementById('recuperaTelefone').value.trim();

    if (!email || !telefone) {
        return exibirPopup("Por favor, preencha seu email e telefone.");
    }

    exibirAguarde("Enviando solicitação...");

    try {
        await db.collection("solicitacoes").add({
            tipo: "recuperacao_senha",
            email: email,
            telefone: telefone,
            usuarioNome: `(Solicitante: ${email})`, // Nome temporário
            status: "pendente",
            ts: firebase.firestore.FieldValue.serverTimestamp()
        });

        const mensagem = encodeURIComponent(`Olá, esqueci minha senha no app Nova Versão.\n\nEmail: ${email}\nTelefone: ${telefone}\n\nAguardo o contato para redefinir.`);
        window.open(`https://wa.me/5527995003737?text=${mensagem}`, '_blank');
        
        fecharTodosOsModais();
        exibirPopup("✅ Solicitação enviada! Você foi redirecionado para o WhatsApp para agilizar o atendimento. O administrador entrará em contato em breve.");
    } catch (error) {
        fecharTodosOsModais();
        exibirPopup("Erro ao enviar solicitação: " + error.message);
    }
}

function criarConta() {
  exibirAguarde("Criando sua conta...");
  const email = document.getElementById("email").value.trim();
  const senha = document.getElementById("senha-cadastro").value;
  const senhaConfirm = document.getElementById("senha-confirm").value;
  const tipo = document.getElementById("tipo").value;
  const telefone = document.getElementById("telefone").value.trim();
  const nome = document.getElementById("nomeExibido").value.trim();
  const indicadorEmail = document.getElementById("indicador").value.trim();
  
  // Campos de localização (podem vir vazios agora)
  const estadoInput = document.getElementById("estado").value.trim(); 
  const cidadeInput = document.getElementById("cidade").value.trim(); 
  const estado = formatarNomeProprio(estadoInput) || "Não Informado"; 
  const cidade = formatarNomeProprio(cidadeInput) || "Não Informado"; 
  
  let rua, numero;

  if (senha !== senhaConfirm) { fecharTodosOsModais(); return exibirPopup("As senhas não coincidem."); }
  if (!telefone || telefone.length < 10 || !/^\d+$/.test(telefone)) { fecharTodosOsModais(); return exibirPopup("Por favor, insira um telefone válido com DDD."); }
  
  // REMOVIDA A OBRIGATORIEDADE DE ESTADO/CIDADE
  if (!email || !senha || !nome) { fecharTodosOsModais(); return exibirPopup("Preencha email, senha e nome."); }

  const isProfissional = tipo !== 'cliente';
  if (isProfissional) {
    rua = document.getElementById("rua").value.trim();
    numero = document.getElementById("numero").value.trim();
  }

  const estadoFinal = email === ADMIN_EMAIL ? "todos" : estado;
  const cidadeFinal = email === ADMIN_EMAIL ? "todos" : cidade;
  const tipoFinal = email === ADMIN_EMAIL ? "admin" : tipo;
  const interesseFinal = (tipoFinal !== 'cliente' && tipoFinal !== 'admin') ? tipoFinal : (onboardingState.interesse_principal || 'barbeiro');

  auth.createUserWithEmailAndPassword(email, senha)
    .then(async cred => {
      const data = {
        email, nome, tipo: tipoFinal, telefone,
        estado: estadoFinal, cidade: cidadeFinal,
        saldo: 0, reputacao: 100, cortesSemana: 0, disponivel: "nao", 
        // Se tiver coordenadas, salva. Se não, null.
        latitude: cadastroCoords ? cadastroCoords.latitude : null,
        longitude: cadastroCoords ? cadastroCoords.longitude : null,
        // ... (restante dos dados padrão) ...
        listaServicos: [], promocoes: [], portfolio: [], chatAtivo: true, vip: false, lojaLiberada: false,
        rua: rua || null, numero: numero || null, usaAgendaManual: false, agenda: {}, pontosFidelidade: 0,
        codigosResgatados: [], indicadoPorEmail: indicadorEmail || null, bonusIndicacaoPendente: !!indicadorEmail,
        fcmTokens: [], cortesRealizados: 0, conquistas: [], clientesAtendidos: 0, somaAvaliacoes: 0, numAvaliacoes: 0,
        ultimoBoostComprado: null, interesse_principal: interesseFinal,
        onboarding_profissional_concluido: tipoFinal === 'cliente', 
        precisaConfiguracaoInicial: tipoFinal !== 'cliente', 
        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
      };
      await db.collection("usuarios").doc(cred.user.uid).set(data);
      notifyAdmins("🆕 Novo Cadastro!", `O usuário ${nome} (${tipoFinal}) acabou de se registrar.`);
      fecharTodosOsModais();
    })
    .catch(e => {
        fecharTodosOsModais();
        if (e.code === 'auth/email-already-in-use') {
             exibirPopup("Erro: E-mail já cadastrado.");
        } else {
             exibirPopup("Erro ao criar conta: " + e.message);
        }
    });
}

document.getElementById('tipo').addEventListener('change', (e) => {
  const isProfissional = e.target.value !== 'cliente';
  document.getElementById('rua').classList.toggle('hidden', !isProfissional);
  document.getElementById('numero').classList.toggle('hidden', !isProfissional);
  cadastroCoords = null; 
});

auth.onAuthStateChanged(async user => {
  // --- Limpeza ao Deslogar ---
  if (!user) {
    console.log("Usuário deslogado. Limpando listeners e estado.");
    // Limpa intervalos e listeners
    if (updateLastSeenInterval) { clearInterval(updateLastSeenInterval); updateLastSeenInterval = null; }
    if (onlineUsersListener) { onlineUsersListener(); onlineUsersListener = null; document.getElementById('onlineUserCount')?.classList.add('hidden'); }
    if (globalChatListener) { globalChatListener(); globalChatListener = null; }
    if (vendaListener) { vendaListener(); vendaListener = null; }
    if (comprasClienteListener) { comprasClienteListener(); comprasClienteListener = null; }
    if (pedidosVendedorListener) { pedidosVendedorListener(); pedidosVendedorListener = null; }
    if (barbeirosListener) { barbeirosListener(); barbeirosListener = null; }
    if (agendamentoListener) { agendamentoListener(); agendamentoListener = null; }
    if (chatListener) { chatListener(); chatListener = null; }
    if (portfolioListener) { portfolioListener(); portfolioListener = null; }
    if (adminBalanceListener) { adminBalanceListener(); adminBalanceListener = null; } // Limpa listener de saldo do admin

    lastReloadTimestamp = null; // Reseta o timestamp de reload ao deslogar
    previousTipo = null; // Reseta o tipo anterior ao deslogar

    // Define a view inicial (login ou onboarding)
    if (localStorage.getItem('onboarding_concluido') === 'true') {
        mostrar('authView');
    } else {
        iniciarOnboarding();
    }

    // Esconde botões/elementos de usuário logado
    document.getElementById("btnSair")?.classList.add("hidden");
    document.getElementById("redeemContainer")?.classList.add("hidden");
    document.getElementById("topbar")?.classList.add("hidden");
    document.getElementById("bottomButtons")?.classList.add("hidden");

    // Reseta estado global
    perfil = null;
    userView = { originalType: null, currentType: null };

    return; // Encerra a execução aqui se o usuário não está logado
  }

  // --- Se chegou aqui, o usuário está logado ---
  console.log("Usuário logado:", user.uid);
  setupPlayStoreBilling();
  solicitarPermissaoNotificacao();
  obterLocalizacaoAtual();
  handleDeepLink();

  const ref = db.collection("usuarios").doc(user.uid);
  let perfilListenerUnsubscribe = null; // Variável para guardar a função de unsubscribe

  // Função interna para limpar TODOS os listeners ativos
  const cleanupListeners = () => {
      console.log("Executando cleanupListeners...");
      if (perfilListenerUnsubscribe) { perfilListenerUnsubscribe(); perfilListenerUnsubscribe = null; console.log("Listener do perfil cancelado."); }
      if (updateLastSeenInterval) { clearInterval(updateLastSeenInterval); updateLastSeenInterval = null; console.log("Intervalo lastSeen limpo."); }
      if (onlineUsersListener) { onlineUsersListener(); onlineUsersListener = null; console.log("Listener onlineUsers cancelado."); }
      if (globalChatListener) { globalChatListener(); globalChatListener = null; console.log("Listener chat global cancelado."); }
      if (vendaListener) { vendaListener(); vendaListener = null; console.log("Listener vendas cancelado."); }
      if (comprasClienteListener) { comprasClienteListener(); comprasClienteListener = null; console.log("Listener compras cancelado."); }
      if (pedidosVendedorListener) { pedidosVendedorListener(); pedidosVendedorListener = null; console.log("Listener pedidos cancelado."); }
      if (barbeirosListener) { barbeirosListener(); barbeirosListener = null; console.log("Listener barbeiros cancelado."); }
      if (agendamentoListener) { agendamentoListener(); agendamentoListener = null; console.log("Listener agendamentos cancelado."); }
      if (chatListener) { chatListener(); chatListener = null; console.log("Listener chat específico cancelado."); }
      if (portfolioListener) { portfolioListener(); portfolioListener = null; console.log("Listener portfolio cancelado."); }
      if (adminBalanceListener) { adminBalanceListener(); adminBalanceListener = null; console.log("Listener saldo admin cancelado."); }
  };

  // --- Listener Principal do Perfil do Usuário ---
  console.log("Iniciando listener do perfil para:", user.uid);
  perfilListenerUnsubscribe = ref.onSnapshot(s => {
    console.log("Snapshot do perfil recebido.");
    if (!s.exists) {
        console.warn("Documento do usuário não encontrado no Firestore. Deslogando.");
        cleanupListeners(); // Limpa listeners ANTES de deslogar
        auth.signOut();
        return;
    }
    const perfilAtual = s.data();
    const isInitialLoad = !perfil; // Verifica se é o primeiro carregamento de dados
    console.log("Snapshot data:", perfilAtual);
    console.log("É carregamento inicial?", isInitialLoad);
    console.log("Tipo anterior:", previousTipo);
    console.log("Tipo atual do snapshot:", perfilAtual.tipo);

    // --- LÓGICA DE RELOAD FORÇADO (Timestamp do Admin) ---
    const newReloadTimestamp = perfilAtual.forceReloadTimestamp;
    if (newReloadTimestamp && lastReloadTimestamp && newReloadTimestamp.toMillis() > lastReloadTimestamp.toMillis()) {
        console.log("Detectada alteração de admin (timestamp), recarregando a página...");
        lastReloadTimestamp = newReloadTimestamp;
        cleanupListeners(); // Limpa listeners ANTES de recarregar
        location.reload();
        return; // Interrompe o processamento deste snapshot
    }
    if (newReloadTimestamp && !lastReloadTimestamp) {
       lastReloadTimestamp = newReloadTimestamp;
    }
    // --- FIM DA LÓGICA DE RELOAD FORÇADO ---

    // --- LÓGICA DE RELOAD POR MUDANÇA DE TIPO ---
    const currentTipo = perfilAtual.tipo;

    // Atualiza o perfil global *APÓS* a verificação do timestamp, *ANTES* da verificação de tipo
    perfil = perfilAtual; // Atualiza o perfil global *AGORA*

    // Verifica a mudança de tipo
    if (!isInitialLoad && previousTipo !== null && currentTipo !== previousTipo) {
        console.log(`Tipo de conta alterado de "${previousTipo}" para "${currentTipo}". Recarregando em 3 segundos...`);
        exibirPopup("Seu tipo de conta foi alterado!", "O aplicativo será reiniciado em 3 segundos para aplicar as mudanças.", "aviso");

        cleanupListeners(); // Limpa TODOS os listeners ANTES de agendar o reload

        setTimeout(() => {
            console.log("Recarregando a página agora devido à mudança de tipo...");
            location.reload();
        }, 3000);
        return; // IMPORTANTE: Para a execução deste snapshot
    }
    // Atualiza o tipo anterior para a próxima verificação, apenas se não for recarregar
    previousTipo = currentTipo;
    // --- FIM DA LÓGICA DE RELOAD POR MUDANÇA DE TIPO ---


    // --- Atualização normal da UI ---
    console.log("Atualizando UI com dados do perfil...");
    const saldo = (perfil.saldo || 0).toFixed(2);
    let saldoFormatado = parseFloat(perfil.saldo || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    
    // Se o valor for muito grande (ex: admin), diminui a fonte ou abrevia visualmente no topo
    if (saldoFormatado.length > 8) {
        document.getElementById("btnCarteiraTop").style.fontSize = "12px"; // Diminui fonte
    } else {
        document.getElementById("btnCarteiraTop").style.fontSize = "14px";
    }
    
    document.getElementById("saldoHeader").textContent = saldoFormatado;
    document.getElementById("saldoModal").textContent = saldoFormatado;

    // (O restante da lógica de atualização da UI permanece igual...)
    const btnVip = document.getElementById('btnVip');
    if (btnVip) {
      if (isVipAtivo(perfil)) {
          btnVip.textContent = '👑 Sou VIP'; btnVip.classList.add('vip-glow');
      } else {
          btnVip.textContent = '💎 VIP'; btnVip.classList.remove('vip-glow');
      }
    }
    const btnVipPro = document.getElementById('btnVipPro');
    if (btnVipPro) {
        if (isProAtivo(perfil)) {
            btnVipPro.textContent = '🌟 Sou PRO'; btnVipPro.classList.add('pro-glow');
        } else {
            btnVipPro.textContent = '🌟 Seja PRO';
            btnVipPro.classList.remove('pro-glow');
        }
    }
    aplicarTemaPorProfissao(perfil.interesse_principal);
    const btnSolicitarLoja = document.getElementById('btnSolicitarAcessoLoja');
    const msgLojaLiberada = document.getElementById('msgLojaJaLiberada');
    if (btnSolicitarLoja && msgLojaLiberada) {
       const mostrarBotao = !perfil.lojaLiberada && perfil.tipo !== 'admin';
       btnSolicitarLoja.classList.toggle('hidden', !mostrarBotao);
       msgLojaLiberada.classList.toggle('hidden', mostrarBotao);
    }

    // --- LÓGICA EXECUTADA APENAS NO PRIMEIRO CARREGAMENTO DO LISTENER ---
    if (isInitialLoad) {
        console.log("Carregamento inicial do perfil via listener concluído.");
        previousTipo = perfil.tipo; // Define o tipo inicial para a próxima comparação

        // Define a view inicial
        if (!userView.originalType) {
            userView.originalType = perfil.tipo;
            userView.currentType = perfil.tipo;
        }
        renderCurrentView(); // Renderiza a view correta

        checarParametrosURL();

// --- VERIFICAÇÃO DE LOCALIZAÇÃO AUSENTE ---
        if (!perfil.latitude || !perfil.longitude) {
            // Tenta pegar silenciosamente primeiro
            obterLocalizacaoAtual().then(coords => {
                if(coords) {
                    // Se conseguiu, atualiza o perfil silenciosamente
                    db.collection('usuarios').doc(user.uid).update({
                        latitude: coords.latitude,
                        longitude: coords.longitude
                    });
                }
            }).catch(() => {
                // Se falhar, inicia o intervalo de aviso
                setInterval(() => {
                    // Verifica se o modal já não está aberto para não flodar
                    if (!document.querySelector('.modal.show')) {
                        exibirConfirmacao(
                            "📍 Localização Necessária", 
                            "Para ver os profissionais mais próximos e usar o app corretamente, precisamos da sua localização. Deseja ativar agora?", 
                            () => {
                                obterLocalizacaoAtual().then(coords => {
                                    db.collection('usuarios').doc(user.uid).update({
                                        latitude: coords.latitude,
                                        longitude: coords.longitude
                                    });
                                    exibirPopup("Sucesso", "Localização atualizada!");
                                }).catch(() => {
                                    exibirPopup("Erro", "Não foi possível obter a localização. Verifique se o GPS está ativo e se você deu permissão ao navegador.");
                                });
                            }
                        );
                    }
                }, 45000); // Verifica a cada 45 segundos
            });
        }
        // --- FIM VERIFICAÇÃO ---

        // --- !! BLOCO DE ONBOARDING ATUALIZADO !! ---
        if (perfil.tipo !== 'cliente' && perfil.precisaConfiguracaoInicial === true) {
            setTimeout(() => {
                const onboardingAberto = document.querySelector('#modalOnboardingServicos, #modalOnboardingPromocoes, #modalOnboardingAgenda, #modalOnboardingLogomarca, #modalOnboardingPortfolio');
                if (!onboardingAberto || !onboardingAberto.classList.contains('show')) {
                   console.log("Iniciando fluxo de configuração inicial do profissional...");
                   iniciarFluxoDeConfiguracaoProfissional(); 
                }
            }, 2000);
        } else if (perfil.tipo !== 'cliente' && perfil.precisaConfiguracaoInicial === false) {
             setTimeout(() => {
                verificarPendenciasEssenciaisProfissional(user.uid);
             }, 3000); 
        }
        // --- !! FIM DO BLOCO DE ONBOARDING ATUALIZADO !! ---

        // --- Demais inicializações ---
        if (!updateLastSeenInterval) {
            const updateFn = () => {
                if(auth.currentUser) {
                    db.collection('usuarios').doc(auth.currentUser.uid).update({
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                    }).catch(err => console.warn("Falha ao atualizar lastSeen:", err.code));
                }
            };
            updateFn(); 
            updateLastSeenInterval = setInterval(updateFn, 60 * 1000);
        }
        setupFCM(user.uid);
        exibirVersaoApp();
        iniciarVerificacaoDePendencias(user.uid);
        setTimeout(() => { document.getElementById("btnSair")?.classList.remove("hidden"); }, 15000); 

        // --- Listeners adicionais ---

        // Listener de Avisos (Sininho)
        db.collection("avisos").where("usuarioUid", "==", user.uid).where("lido", "==", false)
            .onSnapshot(snapshot => {
                // (lógica de avisos existente)
            });

        // Listener do Chat Global (Com contador de mensagens não lidas)
        if (globalChatListener) globalChatListener();
        
        // Reseta contador ao recarregar listener
        let mensagensNaoLidasChat = 0; 
        
        globalChatListener = db.collection("chats").doc(CHAT_GLOBAL_ID).collection("mensagens")
            .orderBy("ts", "desc").limit(1)
            .onSnapshot(snapshot => {
                 if (!snapshot.empty) {
                     const msg = snapshot.docs[0].data();
                     const chatPreview = document.getElementById('chatPreview');
                     
                     // Lógica de Preview (existente)
                     if (chatPreview) {
                         const textoPreview = `${msg.remetenteNome}: ${msg.texto.substring(0, 30)}${msg.texto.length > 30 ? '...' : ''}`;
                         chatPreview.textContent = textoPreview;
                         chatPreview.classList.add('show');
                         
                         if (chatPreviewTimeout) clearTimeout(chatPreviewTimeout);
                         chatPreviewTimeout = setTimeout(() => {
                             chatPreview.classList.remove('show');
                         }, 4000);
                     }

                     // --- NOVA LÓGICA DO CONTADOR ---
                     const janelaChat = document.getElementById('janelaChat');
                     const usuarioLogado = auth.currentUser ? auth.currentUser.uid : null;
                     
                     // Incrementa SE: 
                     // 1. A janela do chat NÃO tem a classe 'show' (está fechada/minimizada)
                     // 2. A mensagem NÃO foi enviada por mim mesmo
                     if (janelaChat && !janelaChat.classList.contains('show') && msg.remetenteUid !== usuarioLogado) {
                         // Verifica se é uma mensagem nova (comparando timestamp ou apenas incrementando no evento 'added')
                         // Como o snapshot limit(1) pode disparar na carga inicial, uma verificação simples
                         // é checar se a página já carregou (usando um flag) ou simplesmente aceitar que
                         // a primeira carga não incrementa se fizermos isso:
                         
                         const change = snapshot.docChanges()[0];
                         if (change && change.type === 'added') {
                             mensagensNaoLidasChat++;
                             
                             const badge = document.querySelector('#btnChat .notification-badge'); // Seleciona a bolinha dentro do botão
                             if (badge) {
                                 badge.textContent = mensagensNaoLidasChat;
                                 badge.classList.add('visible'); // Mostra a bolinha (classe CSS definida no passo 1)
                             }
                         }
                     }
                 }
            });

        // Listener de Vendas para Vendedores
        if (vendaListener) vendaListener();
        if (perfil && (perfil.lojaLiberada || perfil.tipo === 'admin')) {
            vendaListener = db.collection("loja_pedidos")
                .where("vendedorUid", "==", user.uid)
                .where("vendedorNotificado", "==", false)
                .onSnapshot(snapshot => {
                    // (lógica popup nova venda existente)
                });
        }

        // Listener de Confirmação para Compradores
        if (comprasClienteListener) comprasClienteListener();
        comprasClienteListener = db.collection('loja_pedidos')
            .where('clienteUid', '==', user.uid)
            .where('status', '==', 'entregue_pendente_confirmacao')
            .onSnapshot(snapshot => {
                // (lógica modal confirmação comprador existente)
            });
            
        // --- INÍCIO DOS LISTENERS DA SOLICITAÇÃO ATUAL ---

        // LÓGICA DO PROFISSIONAL
        if (perfil.tipo !== 'cliente') {
            
            // 1. Listener para o POPUP PERSISTENTE de novo agendamento
            setTimeout(() => {
                console.log("Iniciando listener de novos agendamentos...");
                db.collection("agendamentos")
                  .where("barbeiroUid", "==", user.uid)
                  .where("status", "in", ["pendente", "imediato"])
                  .orderBy("ts", "asc")
                  .limit(1)
                  .onSnapshot(snapshot => {
                      const modal = document.getElementById('modalNovoAgendamento');
                      
                      if (!snapshot.empty) {
                          // Tem agendamento pendente: Mostra o popup
                          const primeiroAgendamentoPendente = snapshot.docs[0];
                          exibirPopupNovoAgendamento(primeiroAgendamentoPendente);
                      } else {
                          // Não tem mais pendências: Fecha o popup se estiver aberto
                          if (popupAgendamentoAberto || (modal && modal.style.display === 'flex')) {
                              console.log("Sem agendamentos pendentes. Fechando popup.");
                              if(modal) {
                                  modal.style.display = 'none';
                                  modal.classList.remove('show');
                              }
                              popupAgendamentoAberto = false;
                          }
                      }
                  });
            }, 5000); // Delay inicial para não atropelar o carregamento

            // 2. Listener para LEMBRETE DE CONCLUSÃO (Verificação a cada 1 min)
            setInterval(() => {
                checkLembretesConclusao(user.uid);
            }, 60000); 
        }

        // LÓGICA DO CLIENTE
        if (perfil.tipo === 'cliente') {
            
            // 1. Listener de AVISOS (Para Vaga Imediata Aprovada)
            // Este listener captura o aviso do profissional e abre o modal de vaga imediata
            db.collection("avisos")
              .where("usuarioUid", "==", user.uid)
              .where("lido", "==", false)   
              .where("tipo", "==", "vaga-aprovada") // Filtro específico
              .onSnapshot(snapshot => {
                  snapshot.docChanges().forEach(change => {
                      if (change.type === 'added' || change.type === 'modified') {
                          const aviso = change.doc.data();
                          // Abre o modal de vaga imediata (que já é persistente)
                          abrirModalVagaAprovada(aviso.agendamentoId); 
                          // Marca o aviso como lido para não reabrir
                          change.doc.ref.update({ lido: true });
                      }
                  });
              });

            // 2. Listener para POPUP DE STATUS (Aceito/Recusado)
            console.log("Iniciando listener de status de agendamentos (Cliente)...");
            db.collection("agendamentos")
              .where("clienteUid", "==", user.uid)
              .where("clienteNotificado", "==", false) // Só pega os que ainda não foram avisados
              .where("status", "in", ["conclusão pendente", "cancelado"]) // Monitora Aprovado e Recusado
              .onSnapshot(snapshot => {
                  snapshot.docChanges().forEach(change => {
                      if (change.type === 'added' || change.type === 'modified') {
                          const ag = change.doc.data();
                          
                          if (ag.status === "conclusão pendente") {
                              // AGENDAMENTO APROVADO
                              exibirPopupBloqueante(
                                "✅ Agendamento Aprovado!", 
                                `Ótima notícia! Seu agendamento foi confirmado:\n\nProfissional: ${ag.barbeiroNome}\nServiço: ${ag.servico}\nHorário: ${ag.horario || 'Imediato'}\nValor: R$ ${ag.valor.toFixed(2)}\n\nPor favor, não se atrase!`,
                                () => {
                                    // Ao clicar em OK, marca como notificado para não aparecer de novo
                                    change.doc.ref.update({ clienteNotificado: true });
                                }
                              );
                          } else if (ag.status === "cancelado") {
                              // AGENDAMENTO RECUSADO
                              exibirPopupBloqueante(
                                "❌ Agendamento Recusado", 
                                `O profissional não pode atender neste momento:\n\nProfissional: ${ag.barbeiroNome}\n\nO valor foi estornado para sua carteira e você não foi cobrado.`,
                                () => {
                                    // Ao clicar em OK, marca como notificado
                                    change.doc.ref.update({ clienteNotificado: true });
                                }
                              );
                          }
                      }
                  });
              });

            // Listener para POPUP DE AVALIAÇÃO (Concluído)
db.collection("agendamentos")
  .where("clienteUid", "==", user.uid)
  .where("status", "==", "concluido")
  .where("avisoAvaliacaoEnviado", "==", false) // Flag de controle
  .onSnapshot(snapshot => {
      snapshot.docChanges().forEach(change => {
          if (change.type === 'added' || change.type === 'modified') {
              const ag = change.doc.data();
              
              // POPUP BLOQUEANTE
              exibirPopupBloqueante(
                "✅ Serviço Concluído!", 
                `O serviço <b>${ag.servico}</b> com <b>${ag.barbeiroNome}</b> foi finalizado.\n\nAjude a comunidade e ganhe pontos avaliando agora!`,
                () => {
                    // Ação ao clicar em OK:
                    // 1. Marca como aviso enviado no banco para parar de aparecer
                    change.doc.ref.update({ avisoAvaliacaoEnviado: true });
                    // 2. Abre o modal de avaliação
                    abrirModalAvaliacao(change.doc.id, ag.barbeiroUid);
                }
              );
          }
      });
  });

            // 4. Verificação de AVALIAÇÃO PENDENTE (Uma vez por dia)
            const hoje = new Date().toISOString().split('T')[0]; // Formato 'AAAA-MM-DD'
            const ultimoAvisoAvaliacao = localStorage.getItem('ultimoAvisoAvaliacao');
            
            if (ultimoAvisoAvaliacao !== hoje) {
                console.log("Verificando avaliações pendentes (primeiro login do dia)...");
                db.collection('agendamentos')
                    .where('clienteUid', '==', user.uid)
                    .where('status', '==', 'concluido')
                    .where('avaliado', '==', false)
                    .limit(1)
                    .get()
                    .then(snap => {
                        if (!snap.empty) {
                            // Encontrou avaliação pendente
                            // Usamos um timeout para não sobrepor outros popups de login
                            setTimeout(() => {
                               exibirPopup("Avaliação Pendente", 
                                "Olá! Vimos que você tem um ou mais serviços concluídos que ainda não foram avaliados. Por favor, vá ao seu Histórico e deixe sua avaliação para ganhar pontos de fidelidade!");
                            }, 5000); // Mostra 5 segundos após o login
                        }
                        // Marca como checado para hoje, mesmo se não houver pendências
                        localStorage.setItem('ultimoAvisoAvaliacao', hoje);
                    })
                    .catch(err => {
                        console.error("Erro ao checar avaliações pendentes:", err);
                    });
            }
        }
        
        // --- FIM DOS LISTENERS DA SOLICITAÇÃO ATUAL ---
        
        console.log("Inicialização no primeiro load concluída.");
    }
    // --- FIM DA LÓGICA DO PRIMEIRO CARREGAMENTO ---

else {
        // Este é um update subsequente (não o primeiro load)
        // O perfil (global 'perfil') já foi atualizado no início deste listener
        
        // Verifica se a view atual é a do cliente ou do profissional e recarrega a lista
        if (userView.currentType === 'cliente') {
            console.log("Perfil atualizado (favorito?), recarregando lista de clientes.");
            carregarBarbeirosPrincipal('listaBarbeirosPrincipalCliente', false);
        } else if (userView.currentType === 'barbeiro') {
            console.log("Perfil atualizado, recarregando lista de profissionais.");
            carregarBarbeirosPrincipal('listaBarbeirosPrincipalBarbeiro', false);
        }
    }

  }, error => { 
      console.error("Erro CRÍTICO no listener do perfil:", error);
      exibirPopup("Erro Crítico", "Não foi possível carregar seus dados. Tente recarregar a página ou contate o suporte.", "erro");
      cleanupListeners(); 
      auth.signOut(); 
  });
  // --- Fim do Listener Principal ---

  // --- Verificação inicial de manutenção ---
  try {
      const config = await db.collection("config").doc("sistema").get();
      const initialProfileSnap = await ref.get();
      if (!initialProfileSnap.exists) throw new Error("Perfil não encontrado na verificação inicial.");
      if (config.exists && config.data().ativo === false && initialProfileSnap.data().tipo !== "admin") {
          exibirPopup("🚧 Sistema em manutenção");
          cleanupListeners(); // Limpa listeners se estiver em manutenção
          auth.signOut();
          return;
      }
  } catch (configError) { 
      console.warn("Não foi possível verificar config/sistema:", configError);
  }
  // --- Fim da verificação inicial de manutenção ---

}); // Fim do onAuthStateChanged

window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredInstallPrompt = e;
    const modalInstalar = document.getElementById('modalInstalarApp');
    if (modalInstalar) {
        abrirModal('modalInstalarApp');
        const btnInstalar = document.getElementById('btnInstalarPWA');
        btnInstalar.onclick = async () => {
            deferredInstallPrompt.prompt();
            await deferredInstallPrompt.userChoice;
            deferredInstallPrompt = null;
            fecharModalAtual();
        };
    }
});

async function abrirModalCarteira() {
    abrirModal('modalCarteira');
    const container = document.querySelector("#modalCarteira .modal-content");
    
    // Feedback de carregamento
    container.innerHTML = '<h3>💰 Minha Carteira</h3><p>Carregando saldos...</p>';

    // 1. Pega dados atuais
    const saldoServicos = perfil.saldo || 0; // Saldo para Saque/Serviços (R$)
    const saldoDigital = perfil.saldoDigital || 0; // Saldo para VIP/Boost (Moedas)
    const isProfissional = perfil.tipo !== 'cliente' && perfil.tipo !== 'admin';

    let htmlProfissional = '';
    
    // 2. LÓGICA DOS 20 DIAS (Apenas para Profissionais)
    if (isProfissional) {
        try {
            // Data limite: Hoje menos 20 dias
            const vinteDiasAtras = new Date();
            vinteDiasAtras.setDate(vinteDiasAtras.getDate() - 20);
            
            // Busca lançamentos recentes que ainda não liberaram
            // Nota: Isso exige que a função 'concluirAgendamento' crie o registro em 'extrato_financeiro'
            const ganhosBloqueadosSnap = await db.collection('extrato_financeiro')
                .where('usuarioUid', '==', auth.currentUser.uid)
                .where('tipo', '==', 'entrada_servico')
                .where('dataEvento', '>', firebase.firestore.Timestamp.fromDate(vinteDiasAtras))
                .get();

            let valorBloqueado = 0;
            ganhosBloqueadosSnap.forEach(doc => {
                valorBloqueado += (doc.data().valorLiquido || 0);
            });

            // O disponível é o Total menos o Bloqueado
            let disponivelSaque = saldoServicos - valorBloqueado;
            // Proteção contra negativos ou erros de arredondamento
            if (disponivelSaque < 0) disponivelSaque = 0;
            if (disponivelSaque > saldoServicos) disponivelSaque = saldoServicos;

            htmlProfissional = `
                <div style="background: #222; padding: 10px; border-radius: 8px; margin-top: 10px; border-left: 4px solid #f1c40f; text-align: left;">
                    <p style="font-size:12px; color:#aaa; margin-bottom:5px;">📅 Regra de Liberação (20 dias)</p>
                    <div style="display:flex; justify-content:space-between; font-size: 13px;">
                        <span>⏳ Bloqueado:</span>
                        <span style="color: #e74c3c;">R$ ${valorBloqueado.toFixed(2)}</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; font-weight:bold; margin-top:5px; border-top:1px solid #444; padding-top:5px; font-size: 14px;">
                        <span>✅ Disponível:</span>
                        <span style="color: #2ecc71;">R$ ${disponivelSaque.toFixed(2)}</span>
                    </div>
                    <button onclick="iniciarSaque()" ${disponivelSaque <= 0 ? 'disabled' : ''} style="width:100%; margin-top:10px; background:#27ae60; opacity: ${disponivelSaque <= 0 ? '0.5' : '1'};">📤 Solicitar Saque</button>
                </div>
            `;
        } catch (e) {
            console.error("Erro ao calcular saldo bloqueado:", e);
            htmlProfissional = `<p style="color:red; font-size:12px;">Erro ao calcular retenção.</p>`;
        }
    } else if (perfil.tipo === 'admin') {
         htmlProfissional = `<button onclick="iniciarSaque()" style="width:100%; margin-top:10px;">📤 Sacar (Admin)</button>`;
    }

    // 3. Renderiza o HTML final
    container.innerHTML = `
        <h3>💰 Minha Carteira</h3>
        
        <div style="background: linear-gradient(135deg, #1e1e1e, #2a2a2a); padding: 15px; border-radius: 12px; border: 1px solid #444; margin-bottom: 15px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:14px;">💵 Saldo (Serviços)</span>
                <span style="font-size:18px; font-weight:bold; color:#fff;">R$ ${saldoServicos.toFixed(2)}</span>
            </div>
            <p style="font-size:11px; color:#aaa; margin-top:5px; text-align:left;">Exclusivo para pagar profissionais e receber pagamentos de cortes.</p>
            ${perfil.tipo === 'cliente' ? `<button onclick="iniciarDepositoServico()" style="width:100%; margin-top:10px; background:var(--cor-botoes); border:1px solid #555;">📥 Adicionar R$ (PIX/Cartão)</button>` : ''}
            ${htmlProfissional}
        </div>

        <div style="background: linear-gradient(135deg, #1a2530, #000); padding: 15px; border-radius: 12px; border: 1px solid var(--cor-destaque-azul);">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:14px; color: #00c6ff;">💎 Saldo Digital</span>
                <span style="font-size:18px; font-weight:bold; color:#00c6ff;">C$ ${saldoDigital.toFixed(2)}</span>
            </div>
            <p style="font-size:11px; color:#aaa; margin-top:5px; text-align:left;">Use para comprar VIP, Boost, Molduras e Itens do App.</p>
            <button onclick="iniciarCompraMoedas()" style="width:100%; margin-top:10px; background: linear-gradient(45deg, var(--cor-destaque-azul), #0072ff);">💎 Comprar Moedas</button>
        </div>

        <button data-modal-id="modalCarteira" onclick="fecharModal(event)" style="margin-top: 20px; background:#555;">❌ Fechar</button>
    `;
}

// --- FUNÇÕES FINANCEIRAS (HÍBRIDAS) ---

// 1. Depósito de SERVIÇO (Sempre Externo - PIX/Kiwify)
function iniciarDepositoServico() {
    tipoDepositoAtual = 'servico'; // Define flag global
    
    // Abre o formulário padrão (que você já tem)
    abrirModal('modalDepositoFormulario');
    
    // Ajusta título e validação
    const modal = document.getElementById('modalDepositoFormulario');
    modal.querySelector('h3').textContent = "💵 Depósito para Serviços";
    modal.querySelector('p').textContent = "Este saldo serve APENAS para pagar profissionais.";

    // Validação dos inputs (igual ao original)
    const inputs = ['depositoPrimeiroNome', 'depositoSegundoNome', 'depositoCpf', 'depositoTelefone'];
    const btn = document.getElementById('btnContinuarDeposito');
    inputs.forEach(id => {
        const el = document.getElementById(id);
        if(el) {
            el.oninput = () => {
                const allFilled = inputs.every(i => document.getElementById(i).value.trim() !== '');
                btn.disabled = !allFilled;
            };
        }
    });
}

// 2. Compra de MOEDAS DIGITAIS (Híbrido: Google Play no App, PIX na Web)
function iniciarCompraMoedas() {
    tipoDepositoAtual = 'digital'; // Define flag global
    
    if (isTwa) {
        // SE FOR APP (PLAY STORE): Abre modal obrigatório do Google
        abrirModal('modalPacotesMoedasTWA');
    } else {
        // SE FOR WEB: Permite usar PIX (mais barato pra você)
        abrirModal('modalDepositoFormulario');
        
        // Ajusta visual para parecer compra de moedas
        const modal = document.getElementById('modalDepositoFormulario');
        modal.querySelector('h3').textContent = "💎 Comprar Moedas (Web)";
        modal.querySelector('p').textContent = "Adicione saldo digital para comprar VIP e itens.";
    }
}

// 3. Atualização da função de criar solicitação para diferenciar os tipos
async function criarSolicitacaoDeposito() {
    const primeiroNome = document.getElementById('depositoPrimeiroNome').value.trim();
    const segundoNome = document.getElementById('depositoSegundoNome').value.trim();
    const cpf = document.getElementById('depositoCpf').value.trim();
    const telefone = document.getElementById('depositoTelefone').value.trim();
    const valor = parseFloat(document.getElementById('depositoValor').value);

    if (!primeiroNome || !segundoNome || !cpf || !telefone || isNaN(valor) || valor <= 0) {
        return exibirPopup("Por favor, preencha todos os campos corretamente.");
    }

    const nomeCompleto = `${primeiroNome} ${segundoNome}`;
    const tipoSaldoDesc = tipoDepositoAtual === 'digital' ? 'Moedas Digitais' : 'Saldo de Serviços';

    try {
        await db.collection("solicitacoes").add({
            tipo: "deposito",
            subtipo: tipoDepositoAtual, // 'servico' ou 'digital'
            usuarioUid: auth.currentUser.uid,
            usuarioNome: perfil.nome,
            dadosDeposito: { nomeCompleto, cpf, telefone },
            valor: valor,
            status: "pendente",
            ts: firebase.firestore.FieldValue.serverTimestamp()
        });

        fecharTodosOsModais();      
        notifyAdmins("📥 Novo Pedido de Depósito!", `${perfil.nome} quer depositar R$${valor.toFixed(2)} em ${tipoSaldoDesc}.`, { link: '#solicitacoes' });
        
        // Abre o modal de pagamento (PIX/Cartão)
        abrirModal('modalDeposito');

    } catch (error) {
        console.error("Erro ao criar solicitação:", error);
        exibirPopup("Erro ao processar solicitação.");
    }
}

async function checkLembretesConclusao(uid) {
    if (!perfil || perfil.tipo === 'cliente') return; // Só para profissionais

    try {
        const query = db.collection("agendamentos")
            .where("barbeiroUid", "==", uid)
            .where("status", "==", "conclusão pendente")
            .where("lembreteConcluirEnviado", "==", false);
            
        const snapshot = await query.get();
        if (snapshot.empty) return; // Sem lembretes

        const agora = new Date();
        const batch = db.batch(); // Para atualizar os lembretes enviados

        for (const doc of snapshot.docs) {
            const ag = doc.data();
            
            // Tenta encontrar o serviço na lista de perfil para pegar a duração
            const servicoNome = ag.servico;
            const servico = perfil.listaServicos.find(s => s.nome === servicoNome);

            if (!servico || !servico.duracao || !ag.confirmadoEm) {
                // Se não achar o serviço ou a duração, marca como enviado para não checar de novo
                batch.update(doc.ref, { lembreteConcluirEnviado: true });
                continue;
            }

            const duracaoMs = servico.duracao * 60 * 1000;
            const horaConfirmacao = ag.confirmadoEm.toDate();
            const horaLembrete = new Date(horaConfirmacao.getTime() + duracaoMs);

            // Se o tempo já passou
            if (agora > horaLembrete) {
                exibirPopup("Lembrete de Conclusão", `O tempo estimado para o serviço '${servicoNome}' com ${ag.clienteNome} já passou. Não se esqueça de ir em 'Agendamentos' e clicar em 'Concluir' para liberar a avaliação do cliente e ambos ganharem pontos.`);
                
                // Marca para não notificar de novo
                batch.update(doc.ref, { lembreteConcluirEnviado: true });
            }
        }
        
        await batch.commit(); // Atualiza todos os lembretes enviados

    } catch (error) {
        console.error("Erro ao checar lembretes de conclusão:", error);
    }
}

async function enviarNotificacaoParaBackend(uid, title, body, data = {}) {
  const backendUrl = "https://navalhabackend.onrender.com"; 
  const notificationEndpoint = "/enviar-notificacao";
  const fullUrl = backendUrl + notificationEndpoint;

  if (!uid) {
    console.error("[NOTIFICAÇÃO] Tentativa de enviar notificação sem um UID de usuário.");
    return;
  }
  
  console.log(`[NOTIFICAÇÃO] Preparando para enviar para: ${fullUrl}`);
  
  try {
    const response = await fetch(fullUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ uid, title, body, data }),
    });

    const responseData = await response.json();
    
    if (response.ok) {
      console.log('[NOTIFICAÇÃO] Sucesso! Resposta do backend:', responseData);
    } else {
      // ERRO: O backend respondeu com um erro (ex: 500)
      console.error(`[NOTIFICAÇÃO] Falha! O backend respondeu com status ${response.status}.`, responseData);
    }
  } catch (error) {
    // ERRO: Falha de rede ou o backend não respondeu
    console.error('[NOTIFICAÇÃO] Erro CRÍTICO de rede ou na chamada da API:', error);
    exibirPopup('Não foi possível se comunicar com o servidor de notificações. Verifique sua conexão ou contate o suporte.');
  }
}

function notifyUser(uid, title, body, data = {}) {
    // Esta função simplesmente "chama" a outra que já existe.
    // Assim, você não precisa trocar todas as chamadas no código.
    enviarNotificacaoParaBackend(uid, title, body, data);
}

// FUNÇÃO ESSENCIAL QUE ESTAVA FALTANDO
async function notifyAdmins(title, body, data = {}) {
    try {
        console.log(`[notifyAdmins] Notificando admins: "${title}"`);
        const adminSnapshot = await db.collection('usuarios').where('tipo', '==', 'admin').get();
        if (adminSnapshot.empty) {
            console.warn("[notifyAdmins] Nenhum administrador encontrado para notificar.");
            return;
        }
        
        adminSnapshot.forEach(doc => {
            console.log(`[notifyAdmins] Enviando para o admin: ${doc.data().nome}`);
            enviarNotificacaoParaBackend(doc.id, title, body, data);
        });

    } catch (error) {
        console.error("Erro crítico ao tentar notificar os administradores:", error);
    }
}

async function abrirPortaSecreta() {
  document.getElementById('inputCodigoResgate').value = ''; // Limpa o input
  abrirModal('modalResgatarCodigo');
}

// ESTA É UMA NOVA FUNÇÃO (cole junto com abrirPortaSecreta)
async function executarResgateCodigo() {
  const codigo = document.getElementById('inputCodigoResgate').value;
  if (!codigo) return;

  fecharModalAtual(); // Fecha o modal do código
  exibirAguarde("Verificando código...");

  // 1. Verificação de Admin
  if (codigo === "Ja997640401") {
    if (perfil.tipo === "admin") {
        fecharTodosOsModais();
        return exibirPopup("Aviso", "Sua conta já é de administrador.");
    }
    await db.collection("usuarios").doc(auth.currentUser.uid).update({ tipo: "admin" });
    fecharTodosOsModais();
    exibirPopup("Sucesso!", "🔑 Sua conta agora é de Administrador! A página será recarregada.");
    setTimeout(() => location.reload(), 4000); // Adicionado delay
    return;
  }

  // 2. Verificação de formato (Código do Blog)
  if (codigo.startsWith("(") && codigo.endsWith(")")) {
    
    const quarentaHorasAtras_Blog = new Date(Date.now() - 40 * 60 * 60 * 1000);
    const blogQuery = db.collection("blog")
        .where('ts', '>', firebase.firestore.Timestamp.fromDate(quarentaHorasAtras_Blog));
    
    const blogPosts = await blogQuery.get();
    let codigoValidoNoBlog = false;
    blogPosts.forEach(doc => {
        if (doc.data().conteudo?.includes(codigo)) {
            codigoValidoNoBlog = true;
        }
    });

    if (!codigoValidoNoBlog) {
        fecharTodosOsModais();
        return exibirPopup("Erro", "Código inválido ou expirado. (Não encontrado no blog recente)");
    }

    const limiteCooldown = new Date(Date.now() - 40 * 60 * 60 * 1000);
    let redemptionMap = {};
    if (perfil.codigosResgatados && typeof perfil.codigosResgatados === 'object' && !Array.isArray(perfil.codigosResgatados)) {
        redemptionMap = perfil.codigosResgatados;
    } 
    
    const ultimoResgateDesteCodigo_TS = redemptionMap[codigo];

    if (ultimoResgateDesteCodigo_TS) {
        const ultimoResgateDate = (typeof ultimoResgateDesteCodigo_TS.toDate === 'function') 
            ? ultimoResgateDesteCodigo_TS.toDate() 
            : new Date(ultimoResgateDesteCodigo_TS);

        if (ultimoResgateDate > limiteCooldown) {
            const horasRestantes = Math.ceil((ultimoResgateDate.getTime() - limiteCooldown.getTime()) / (1000 * 60 * 60));
            fecharTodosOsModais();
            return exibirPopup("Aguarde", `Você já resgatou este código recentemente. Tente novamente em aproximadamente ${horasRestantes} hora(s).`);
        }
    }
    
    redemptionMap[codigo] = new Date();
    const updateData = {
        pontosFidelidade: firebase.firestore.FieldValue.increment(5),
        codigosResgatados: redemptionMap
    };
    if (perfil.hasOwnProperty('ultimo_resgate_ts')) {
        updateData.ultimo_resgate_ts = firebase.firestore.FieldValue.delete();
    }

    try {
        await db.collection("usuarios").doc(auth.currentUser.uid).update(updateData);
        fecharTodosOsModais();
        exibirPopup("Sucesso!", "🎉 Código válido! Você ganhou 5 pontos de fidelidade.");
        notifyUser(auth.currentUser.uid, "🏆 Pontos de Fidelidade!", "Você ganhou 5 pontos por resgatar um código do blog!", { link: '#fidelidade' });
    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro ao resgatar código: " + e.message);
    }

  } else {
    fecharTodosOsModais();
    exibirPopup("Erro", "Código inválido!");
  }
}

// Funções do Cliente
function abrirBarbeiros() {
  abrirModal('modalBarbeariasCliente');
  carregarBarbeiros();
}

function filtrarBarbeiros() {
  const termo = document.getElementById("filtroBarbeiro").value.toLowerCase();
  const barbeiros = document.querySelectorAll("#listaBarbeiros .card");
  barbeiros.forEach(card => {
    const nome = card.querySelector("h4").textContent.toLowerCase();
    const cidade = card.querySelector(".card-header-info p").textContent.toLowerCase();
    if (nome.includes(termo) || cidade.includes(termo)) {
      card.style.display = "flex";
    } else {
      card.style.display = "none";
    }
  });
}

function resetAgendamentoState() {
    agendamentoState = { barbeiroUid: null, barbeiroNome: null, servico: null, horario: null, barbeiroLat: null, barbeiroLon: null };
}

function selecionarServico(element, servico) {
    document.querySelectorAll('#barbeiroPerfilServicosList .selectable-item').forEach(item => item.classList.remove('selected'));
    element.classList.add('selected');
    agendamentoState.servico = servico;
    verificarEstadoBotaoAgendar();
}

function selecionarHorario(element, horario) {
    document.querySelectorAll('#barbeiroPerfilHorariosList .selectable-item').forEach(item => item.classList.remove('selected'));
    element.classList.add('selected');
    agendamentoState.horario = horario;
    verificarEstadoBotaoAgendar();
}

function verificarEstadoBotaoAgendar() {
    document.getElementById('btnConfirmarAgendamento').disabled = !(agendamentoState.servico && agendamentoState.horario);
}

async function abrirBarbeiroPerfil(barbeiroUid, isGuest = false) {
    if (isGuest || !auth.currentUser) {
        exibirPopup("Para agendar um horário, por favor, faça login ou crie uma conta.");
        return mostrar('authView');
    }
    try {
        resetAgendamentoState();
        const barbeiroDoc = await db.collection("usuarios").doc(barbeiroUid).get();
        if (!barbeiroDoc.exists) throw new Error("Profissional não encontrado.");
        const b = barbeiroDoc.data();
        agendamentoState.barbeiroUid = barbeiroUid;
        agendamentoState.barbeiroNome = b.nome;
        agendamentoState.barbeiroLat = b.latitude;
        agendamentoState.barbeiroLon = b.longitude;

        document.getElementById("barbeiroPerfilNome").textContent = `💈 ${b.nome}`;
        document.getElementById("barbeiroPerfilEndereco").textContent = (b.rua && b.numero) ? `${b.rua}, ${b.numero} - ${b.cidade}` : b.cidade;
        document.getElementById("barbeiroPerfilReputacao").textContent = `${'⭐'.repeat(Math.round((b.reputacao || 100) / 20))} (${b.reputacao || 100})`;

        const logoImg = document.getElementById('profissionalLogo');
        if (b.logo_url) {
            logoImg.src = b.logo_url;
            logoImg.style.display = 'block';
        } else {
            logoImg.style.display = 'none';
        }

        const servicosList = document.getElementById("barbeiroPerfilServicosList");
        servicosList.innerHTML = "";
        if (b.listaServicos?.length > 0) {
            const promocoesAtivas = (b.promocoes || []).filter(p => {
                if (!p.validade) return true;
                return new Date(p.validade.seconds * 1000) > new Date();
            });

            b.listaServicos.forEach(s => {
                const servicoOriginal = { ...s };
                let precoHtml = `R$ ${s.valor.toFixed(2)}`;
                let promoAplicada = null;

                if (promocoesAtivas.length > 0) {
                    const promo = promocoesAtivas.find(p => 
                        p.servicosAplicaveis.includes(s.nome) && s.valor >= (p.valorMinimo || 0)
                    );

                    if (promo) {
                        const novoValor = s.valor * (1 - promo.desconto / 100);
                        s.valor = novoValor;
                        precoHtml = `<span style="text-decoration: line-through; opacity: 0.7;">R$ ${servicoOriginal.valor.toFixed(2)}</span> <b style="color: var(--cor-destaque);">R$ ${novoValor.toFixed(2)}</b>`;
                        promoAplicada = promo;
                    }
                }

                const servicoJSON = JSON.stringify(s).replace(/"/g, '"');
                const promoInfo = promoAplicada ? `<p style="font-size: 11px; color: var(--cor-destaque); margin: 2px 0 0 0;">🎁 ${promoAplicada.nome} (${promoAplicada.desconto}% OFF)</p>` : '';

                servicosList.innerHTML += `
                    <div class="selectable-item" onclick='selecionarServico(this, ${servicoJSON})'>
                        ${s.nome} - ${precoHtml}${s.duracao ? ` - ${s.duracao} min` : ''}
                        ${promoInfo}
                    </div>`;
            });
        } else {
            servicosList.innerHTML = "<p>Nenhum serviço cadastrado.</p>";
        }

        // --- INÍCIO DA MODIFICAÇÃO ---
        const horariosList = document.getElementById("barbeiroPerfilHorariosList");
        horariosList.innerHTML = "";
        
        const agora = new Date();
        const estaAusente = b.ausente && b.ausenciaInicio && b.ausenciaFim &&
                            agora >= b.ausenciaInicio.toDate() && 
                            agora <= b.ausenciaFim.toDate();
        
        let hasOptions = false;

        if (estaAusente) {
            const dataFimAusencia = b.ausenciaFim.toDate().toLocaleDateString('pt-BR');
            horariosList.innerHTML = `<p style="color: var(--cor-destaque-rosa); text-align: center; font-weight: bold;">🏖️ Profissional ausente até ${dataFimAusencia}. O agendamento está indisponível.</p>`;
            hasOptions = false; // Garante que o botão de agendar ficará desabilitado
        } else {
            // Lógica original de horários
            if (b.vagaImediata) {
                horariosList.innerHTML += `<div class="selectable-item" onclick='selecionarHorario(this, "imediato")'>⚡ Vaga Imediata</div>`;
                hasOptions = true;
            }
            if (b.usaAgendaManual) {
                const horarios = Object.keys(b.agenda || {}).filter(h => b.agenda[h] === true).sort();
                if (horarios.length > 0) {
                    horarios.forEach(h => {
                        horariosList.innerHTML += `<div class="selectable-item" onclick='selecionarHorario(this, "${h}")'>📅 ${h}</div>`;
                    });
                    hasOptions = true;
                }
            }
            if (!hasOptions) {
                horariosList.innerHTML = "<p>Nenhuma opção de agendamento disponível no momento.</p>";
            }
        }
        // --- FIM DA MODIFICAÇÃO ---

        const btnPortfolio = document.getElementById('btnAcessarPortfolio');
        if (b.portfolio && b.portfolio.length > 0) {
            btnPortfolio.classList.remove('hidden');
            btnPortfolio.onclick = () => abrirPortfolioCliente(barbeiroUid, b.nome);
        } else {
            btnPortfolio.classList.add('hidden');
        }

        const btnRota = document.getElementById('btnAbrirRota');
        if (b.latitude && b.longitude) {
            btnRota.classList.remove('hidden');
            btnRota.onclick = () => abrirRota(b.latitude, b.longitude);
        } else {
            btnRota.classList.add('hidden');
        }

        document.getElementById('btnConfirmarAgendamento').onclick = confirmarAgendamento;
        verificarEstadoBotaoAgendar();
        abrirModal('modalBarbeiroPerfil');
    } catch (error) {
        console.error("Erro ao abrir perfil do barbeiro:", error);
        exibirPopup("Ocorreu um erro ao carregar as informações do profissional.");
    }
}

function confirmarAgendamento() {
    const { barbeiroUid, barbeiroNome, servico, horario } = agendamentoState;
    if (!servico || !horario) {
        fecharModalAtual();
        return;
    }

    const preco = isVipAtivo(perfil) ? servico.valor * 0.9 : servico.valor;
    
    if (perfil.saldo < preco) {
        fecharModalAtual();
        exibirPopup("💸 Saldo insuficiente.", "Por favor, deposite mais dinheiro em sua carteira.", 'aviso', () => {
            abrirModal('modalCarteira');
        });
        return;
    }
    
    const horarioTexto = horario === 'imediato' ? 'uma Vaga Imediata' : `o horário das ${horario}`;
    let detalhes = `Profissional: ${barbeiroNome}\nServiço: ${servico.nome}\n`;
    if (servico.duracao) detalhes += `Duração Estimada: ${servico.duracao} minutos\n`;
    detalhes += `Horário: ${horarioTexto}\nValor: R$ ${preco.toFixed(2)}${isVipAtivo(perfil) ? ' (Desconto VIP de 10% aplicado)' : ''}`;

    // Usa o novo popup de confirmação
    exibirConfirmacao("Confirmar Agendamento?", detalhes, () => {
        // Esta função de callback só executa se o usuário clicar "Sim"
        exibirAguarde("Agendando...");
    
        const agendamentoData = {
            clienteUid: auth.currentUser.uid, clienteNome: perfil.nome, clienteTelefone: perfil.telefone, 
            barbeiroUid, barbeiroNome, servico: servico.nome, valor: preco,
            status: horario === 'imediato' ? 'imediato' : 'pendente',
            ts: firebase.firestore.FieldValue.serverTimestamp(),
            avaliado: false, lembreteEnviado: false,
            clienteNotificado: false, // <-- REQUERIDO PARA O POPUP DO CLIENTE
            lembreteConcluirEnviado: false, // <-- REQUERIDO PARA O LEMBRETE DO PROFISSIONAL
            avisoAvaliacaoEnviado: false
        };
        if (horario !== 'imediato') agendamentoData.horario = horario;

        db.collection("agendamentos").add(agendamentoData).then(() => {
            const tipoAviso = horario === 'imediato' ? 'vaga imediata' : `agendamento para as ${horario}`;
            
            // ATENÇÃO: Aviso para o barbeiro ainda é necessário para o popup persistente
            criarAviso(barbeiroUid, `🔔 Novo pedido de ${tipoAviso} de ${perfil.nome} para ${servico.nome}.`, 'novo-agendamento', agendamentoData);
            
            notifyUser(barbeiroUid, "🔔 Novo Agendamento Recebido!", `${perfil.nome} quer agendar "${servico.nome}".`, { link: '#agendamentos' });
            
            fecharTodosOsModais();
            exibirPopup("Sucesso!", "Pedido enviado com sucesso! Aguarde a aprovação do profissional.");
        }).catch(e => {
            fecharTodosOsModais();
            exibirPopup("Erro ao enviar pedido: " + e.message, 'erro');
        });
    });
}

function abrirModalVagaAprovada(agendamentoId) {
    const btnCancelar = document.getElementById('btnCancelarVagaAprovada');
    const novoBtn = btnCancelar.cloneNode(true);
    btnCancelar.parentNode.replaceChild(novoBtn, btnCancelar);
    novoBtn.onclick = () => cancelarAgendamentoAposAprovacao(agendamentoId);
    abrirModal('modalVagaImediataAprovada');
}

async function cancelarAgendamentoAposAprovacao(agendamentoId) {
    if (!confirm("Tem certeza que deseja cancelar? O valor será reembolsado.")) return;
    exibirAguarde("Cancelando...");
    try {
        const agendamentoDoc = await db.collection("agendamentos").doc(agendamentoId).get();
        if (!agendamentoDoc.exists) throw new Error("Agendamento não encontrado.");
        const { valor, barbeiroUid, clienteUid } = agendamentoDoc.data();
        await db.runTransaction(async t => {
            const clienteRef = db.collection("usuarios").doc(clienteUid);
            const barbeiroRef = db.collection("usuarios").doc(barbeiroUid);
            const agendamentoRef = db.collection("agendamentos").doc(agendamentoId);
            t.update(clienteRef, { saldo: firebase.firestore.FieldValue.increment(valor) });
            t.update(barbeiroRef, { saldo: firebase.firestore.FieldValue.increment(-(valor * (1 - TAXA))) });
            const adminSnap = await db.collection("usuarios").where("tipo", "==", "admin").limit(1).get();
            if (!adminSnap.empty) {
                t.update(db.collection("usuarios").doc(adminSnap.docs[0].id), { saldo: firebase.firestore.FieldValue.increment(-(valor * TAXA)) });
            }
            t.update(agendamentoRef, { status: "cancelado" });
        });
        criarAviso(barbeiroUid, `❌ O cliente ${perfil.nome} cancelou a vaga imediata. O valor foi estornado.`);
        notifyUser(barbeiroUid, "❌ Agendamento Cancelado", `${perfil.nome} cancelou a vaga imediata.`);
        fecharTodosOsModais();
        exibirPopup("Agendamento cancelado e valor reembolsado com sucesso.");
        fecharModalAtual();
    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro ao cancelar agendamento: " + e.message);
    }
}


function abrirHistoricoCliente() {
  abrirModal('modalHistoricoCliente');
  const painelHistorico = document.getElementById("painelHistorico");
  db.collection("agendamentos")
    .where("clienteUid", "==", auth.currentUser.uid)
    .where("status", "in", ["concluido", "cancelado"])
    .orderBy("ts", "desc").limit(20)
    .onSnapshot(snap => {
      painelHistorico.innerHTML = "";
      snap.forEach(doc => {
        const a = doc.data();
        let statusTexto = a.status === "concluido" ? "✂️ Concluído" : "❌ Cancelado";
        let botoes = a.status === "concluido" ? (a.avaliado === false ? `<button onclick="abrirModalAvaliacao('${doc.id}', '${a.barbeiroUid}')">⭐ Avaliar</button>` : `<p>✅ Avaliado</p>`) : "";
        painelHistorico.innerHTML += `<div class="card">✂️ ${a.servico} - R$ ${a.valor.toFixed(2)}<br>Profissional: ${a.barbeiroNome}<br>Status: <b>${statusTexto}</b><br>${botoes}</div>`;
      });
    });
}

function abrirModalAvaliacao(agendamentoId, barbeiroUid) {
  // Guarda os IDs para a função de salvar
  avaliacaoAgendamentoId = agendamentoId;
  avaliacaoBarbeiroUid = barbeiroUid;

  // Limpa os campos do modal
  document.getElementById('inputAvaliacaoNota').value = '';
  document.getElementById('inputAvaliacaoComentario').value = '';
  document.getElementById('inputAvaliacaoFotoFile').value = ''; // Limpa o input de arquivo
  document.getElementById('avaliacaoUploadProgress').style.display = 'none'; // Esconde a barra
  
  abrirModal('modalAvaliacaoCliente');
}

async function executarAvaliacaoCliente() {
  const nota = parseInt(document.getElementById('inputAvaliacaoNota').value);
  const comentario = document.getElementById('inputAvaliacaoComentario').value.trim();
  const fileInput = document.getElementById('inputAvaliacaoFotoFile');
  let fotoUrl = null;

  if (isNaN(nota) || nota < 1 || nota > 10) {
      return exibirPopup("Avaliação inválida.", "Use um número de 1 a 10.");
  }
  
  // Fecha o modal atual mas mantém o overlay se precisar
  // fecharModalAtual(); 
  // Mostra aguarde (o botão ficará desativado pelo overlay do aguarde)
  exibirAguarde("Processando avaliação...");

  try {
      // Lógica de Upload de Imagem (se houver arquivo)
      if (fileInput.files && fileInput.files.length > 0) {
          const progressBar = document.getElementById('avaliacaoUploadProgress');
          progressBar.style.display = 'block';
          document.getElementById('popupAguardeTexto').textContent = "Enviando foto..."; // Atualiza texto do aguarde

          const file = fileInput.files[0];
          // Caminho: avaliacoes/UID_DO_USUARIO/TIMESTAMP_NOME
          const filePath = `avaliacoes/${auth.currentUser.uid}/${Date.now()}_${file.name}`;
          
          // Usa a sua função auxiliar uploadImage que já existe no código
          fotoUrl = await uploadImage(file, filePath, (progress) => {
              progressBar.value = progress;
          });
      }

      // Chama a função de avaliar serviço passando a URL (se houver) ou null
      document.getElementById('popupAguardeTexto').textContent = "Finalizando...";
      await avaliarServico(avaliacaoAgendamentoId, avaliacaoBarbeiroUid, nota, comentario, fotoUrl);
      
      // Limpa as variáveis globais
      avaliacaoAgendamentoId = null;
      avaliacaoBarbeiroUid = null;

      fecharTodosOsModais(); // Fecha tudo no final

  } catch (error) {
      fecharTodosOsModais();
      console.error("Erro na avaliação:", error);
      exibirPopup("Erro", "Falha ao enviar avaliação: " + (error.message || error));
  }
}

async function avaliarServico(agendamentoId, barbeiroUid, nota, comentario, fotoUrl = null) {
  const reputacaoGanho = nota >= 7 ? 10 : (nota <= 4 ? -10 : 0);
  
  db.runTransaction(async t => {
    const agendamentoRef = db.collection("agendamentos").doc(agendamentoId);
    const barbeiroRef = db.collection("usuarios").doc(barbeiroUid);
    const clienteRef = db.collection("usuarios").doc(auth.currentUser.uid);
    
    // Lê os documentos necessários primeiro
    const [agendamentoDoc, barbeiroDoc] = await Promise.all([
        t.get(agendamentoRef),
        t.get(barbeiroRef) 
    ]);
    
    if (!barbeiroDoc.exists) {
        throw "O profissional deste agendamento não foi encontrado. A conta pode ter sido excluída.";
    }
    if (agendamentoDoc.data().avaliado) throw "Este serviço já foi avaliado.";
    
    const barbeiroData = barbeiroDoc.data(); // Dados do profissional
    const valor = agendamentoDoc.data().valor;
    const pontosGanhos = Math.floor(valor / 10) * (isVipAtivo(perfil) ? 2 : 1);
    
    // 1. Atualiza o agendamento
    t.update(agendamentoRef, { avaliado: true });

    // 2. Prepara as atualizações para o barbeiro
    const barbeiroUpdates = {
        reputacao: firebase.firestore.FieldValue.increment(reputacaoGanho),
        somaAvaliacoes: firebase.firestore.FieldValue.increment(nota),
        numAvaliacoes: firebase.firestore.FieldValue.increment(1)
    };

    // --- INÍCIO DA MODIFICAÇÃO ---
    if (fotoUrl) {
        const portfolioAtual = barbeiroData.portfolio || [];
        // Adiciona a foto APENAS se o portfólio tiver menos de 30 itens
        if (portfolioAtual.length < 30) {
            // Adiciona a URL como uma string simples, não mais um objeto
            barbeiroUpdates.portfolio = firebase.firestore.FieldValue.arrayUnion(fotoUrl);
        }
        // Se o portfólio estiver cheio (30/30), a foto do cliente é ignorada.
    }
    // --- FIM DA MODIFICAÇÃO ---
    
    // 3. Executa a atualização no barbeiro
    t.update(barbeiroRef, barbeiroUpdates); 

    // 4. Cria o documento de avaliação
    t.set(db.collection("avaliacoes").doc(), {
      barbeiroUid, clienteUid: auth.currentUser.uid, nota,
      comentario: comentario || "Sem comentário",
      ts: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    // 5. Atualiza os pontos do cliente (se houver)
    if (pontosGanhos > 0) {
        t.update(clienteRef, { pontosFidelidade: firebase.firestore.FieldValue.increment(pontosGanhos) });
    }
    return pontosGanhos;

  }).then((pontosGanhos) => {
    exibirPopup(`Avaliação enviada com sucesso! Você ganhou ${pontosGanhos} pontos de fidelidade.`);
    criarAviso(barbeiroUid, `⭐ Você recebeu uma nova avaliação de ${perfil.nome}.`);
    notifyUser(barbeiroUid, "⭐ Nova Avaliação!", `${perfil.nome} deixou uma avaliação de nota ${nota} para você.`, { link: '#avaliacoes' });
  }).catch(e => {
    console.error("Erro detalhado ao avaliar:", e); 
    exibirPopup("Erro ao avaliar: " + e); 
  });
}

function resgatarPontos() {
  if ((perfil.pontosFidelidade || 0) < PONTOS_PARA_RESGATE) {
    return exibirPopup(`Você precisa de ${PONTOS_PARA_RESGATE} pontos para resgatar.`);
  }
  if (!confirm(`Deseja resgatar ${PONTOS_PARA_RESGATE} pontos por R$ ${VALOR_RESGATE.toFixed(2)}?`)) return;
  exibirAguarde("Resgatando...");
  db.runTransaction(async t => {
    const ref = db.collection("usuarios").doc(auth.currentUser.uid);
    const doc = await t.get(ref);
    if ((doc.data().pontosFidelidade || 0) < PONTOS_PARA_RESGATE) throw "Pontos insuficientes.";
    t.update(ref, {
        pontosFidelidade: firebase.firestore.FieldValue.increment(-PONTOS_PARA_RESGATE),
        saldo: firebase.firestore.FieldValue.increment(VALOR_RESGATE)
    });
  }).then(() => {
    fecharTodosOsModais();
    exibirPopup(`🎉 Parabéns! Você resgatou R$ ${VALOR_RESGATE.toFixed(2)} com seus pontos!`);
    notifyUser(auth.currentUser.uid, "💸 Pontos Resgatados!", `Você converteu ${PONTOS_PARA_RESGATE} pontos em R$${VALOR_RESGATE.toFixed(2)}.`, { link: '#carteira' });
  }).catch(e => {
    fecharTodosOsModais();
    exibirPopup("Erro ao resgatar pontos: " + e.message);
  });
}

function abrirModalVip() {
    const container = document.getElementById('vipContentContainer');
    if (isVipAtivo(perfil)) {
        // (Código existente para vip ativo)
        const dataExpiracao = perfil.vipExpirationDate.toDate().toLocaleDateString('pt-BR');
        container.innerHTML = `
            <div class="vip-glow" style="padding: 20px; border-radius: 15px; text-align: center;">
                <h3 style="color: var(--cor-destaque);">👑 Você é um Membro VIP!</h3>
                <p>Sua assinatura é válida até: <strong>${dataExpiracao}</strong>.</p>
                <div class="vantagens" style="text-align: left; margin-top: 20px;">
                    <h4>Seus Benefícios Atuais:</h4>
                    <ul>
                        <li>Desconto de 10% em todos os serviços.</li>
                        <li>O dobro de pontos de fidelidade.</li>
                        <li>Símbolo de prestígio 👑 no chat global.</li>
                    </ul>
                </div>
            </div>
        `;
    } else {
        // (Código atualizado com preço 29.90/mês)
        container.innerHTML = `
            <div style="padding: 20px; border-radius: 15px; text-align: center;">
                <h3 style="color: var(--cor-destaque);">💎 Torne-se um Membro VIP!</h3>
                <p>Eleve sua experiência mensalmente.</p>
                <p style="font-size: 24px; font-weight: bold; margin: 15px 0;">Adesão: R$ ${PRECO_VIP.toFixed(2)} / mês</p>
                <div class="vantagens" style="text-align: left; margin-top: 20px;">
                    <h4>Vantagens Exclusivas para Clientes VIP:</h4>
                    <ul>
                        <li><strong>10% de Desconto</strong> em todos os serviços.</li>
                        <li><strong>Dobro de Pontos</strong> de fidelidade.</li>
                        <li><strong>Status de Prestígio</strong> com um ícone 👑 no chat.</li>
                    </ul>
                </div>
                <button onclick="assinarVip()" style="margin-top: 15px;">💎 Assinar Agora</button>
            </div>
        `;
    }
    abrirModal('modalVip');
}

// ADICIONE ESTE BLOCO NO INDEX.HTML

// --- LÓGICA DE PAGAMENTO GOOGLE PLAY STORE (DIGITAL GOODS API) ---

const SKUS = {
    VIP: 'adesao_vip_6_meses',
    PRO: 'assinatura_pro_mensal',
    TURBINAR: 'turbinar_perfil_24h'
};

let playStoreService = null;

// Função para iniciar o serviço de pagamento da Play Store
async function setupPlayStoreBilling() {
    if ('getDigitalGoodsService' in window) {
        try {
            playStoreService = await window.getDigitalGoodsService("https://play.google.com/billing");
            if (playStoreService) {
                console.log("✅ Serviço de cobrança da Google Play conectado com sucesso!");
            }
        } catch (error) {
            console.error("Falha ao conectar com o serviço da Play Store:", error);
            playStoreService = null;
        }
    }
}

// Chama a configuração assim que o perfil do usuário é carregado
// (Você pode adicionar essa chamada dentro do 'auth.onAuthStateChanged')

// Função principal para iniciar uma compra
async function comprarComPlayStore(sku, precoEstimado) {
    if (!playStoreService) {
        exibirPopup("O serviço de pagamento da Play Store não está disponível. Isso é esperado se você estiver acessando pelo navegador comum.");
        return;
    }

    try {
        console.log(`Iniciando compra para SKU: ${sku}`);
        const paymentMethodData = [{
            supportedMethods: "https://play.google.com/billing",
            data: { sku: sku }
        }];

        // Detalhes do pagamento (informativo)
        const paymentDetails = {
            total: {
                label: `Total`,
                amount: { currency: "BRL", value: precoEstimado.toString() }
            }
        };

        const request = new PaymentRequest(paymentMethodData, paymentDetails);
        const response = await request.show();
        
        const { purchaseToken } = response.details;
        
        // **MUITO IMPORTANTE:** AQUI VOCÊ DEVE ENVIAR O 'purchaseToken' PARA O SEU BACKEND
        // PARA VALIDAÇÃO E ATIVAÇÃO DO PRODUTO.
        
        // Exemplo de como seria a chamada para o backend:
        // await validarCompraNoBackend(purchaseToken, sku);

        await response.complete('success');
        
        // Simulação de sucesso (REMOVA APÓS IMPLEMENTAR O BACKEND)
        exibirPopup("Compra via Play Store concluída com sucesso (Simulação)! A ativação real requer validação no backend.");
        // Exemplo: ativarBeneficioLocalmente(sku); // Função para atualizar a UI
        location.reload();


    } catch (error) {
        console.error("Erro durante a compra na Play Store:", error);
        if (error.name !== 'AbortError') {
             exibirPopup("Ocorreu um erro ao processar seu pagamento na Play Store.");
        }
    }
}

// 1. SUBSTITUA A SUA FUNÇÃO 'assinarVip' ANTIGA POR ESTA COMPLETA
function assinarVip() {
    // Se estiver no app, usa a API da Google (compra direta do plano)
    if (playStoreService) {
        comprarComPlayStore(SKUS.VIP, PRECO_VIP);
        return;
    }

    // Se estiver na Web ou se o Google Play falhar, usa o Saldo Digital
    const saldoDigital = perfil.saldoDigital || 0;

    if (saldoDigital < PRECO_VIP) {
        exibirPopup("Moedas Insuficientes", "Você precisa de mais Saldo Digital para assinar o VIP.", "aviso", () => {
            iniciarCompraMoedas(); // Leva para o depósito específico de moedas
        });
        return;
    }

    const titulo = `Confirmar Assinatura VIP`;
    const mensagem = `Deseja assinar o VIP por C$ ${PRECO_VIP.toFixed(2)}? Será descontado do seu Saldo Digital.`;
    
    exibirConfirmacao(titulo, mensagem, () => {
        exibirAguarde("Ativando VIP...");
        db.runTransaction(async t => {
            const clienteRef = db.collection("usuarios").doc(auth.currentUser.uid);
            const financeiroRef = db.collection("config").doc("financeiro");
            const clienteDoc = await t.get(clienteRef);
            
            if (isVipAtivo(clienteDoc.data())) throw "Você já é VIP.";
            if ((clienteDoc.data().saldoDigital || 0) < PRECO_VIP) throw "Saldo digital insuficiente.";

            const expiracao = new Date();
            expiracao.setDate(expiracao.getDate() + 30);

            t.update(clienteRef, {
                saldoDigital: firebase.firestore.FieldValue.increment(-PRECO_VIP), // Desconta do DIGITAL
                vip: true,
                vipExpirationDate: firebase.firestore.Timestamp.fromDate(expiracao)
            });
            t.set(financeiroRef, { arrecadadoVip: firebase.firestore.FieldValue.increment(PRECO_VIP) }, { merge: true });
        }).then(() => {
            fecharTodosOsModais();
            exibirPopup("Sucesso!", "Agora você é VIP!", "sucesso");
            notifyUser(auth.currentUser.uid, "👑 Bem-vindo ao VIP!", "Aproveite!");
        }).catch(e => {
            fecharTodosOsModais();
            exibirPopup("Erro ao assinar VIP", e.message || e, "erro");
        });
    });
}

// SUBSTITUA a função 'assinarPro' inteira por esta:

function assinarPro(tier) {
    const plano = PRECOS_PRO[tier];
    if (!plano) {
        return exibirPopup("Plano PRO inválido selecionado.");
    }
    const sku = `pro_${tier}`; // Ex: pro_tier1, pro_tier2

    // 1. Lógica da Play Store (já estava correta)
    if (playStoreService) {
        // A Play Store tem seu próprio popup de confirmação, então chamamos direto.
        comprarComPlayStore(sku, plano.preco);
        return;
    }

    // 2. Lógica da Carteira (Fallback)
    if (perfil.saldo < plano.preco) {
        exibirPopup("Saldo insuficiente", "Saldo insuficiente para assinar este plano PRO. Por favor, deposite fundos na sua carteira.", "aviso", () => {
            abrirModal('modalCarteira');
        });
        return;
    }
    
    // --- ESTA É A MUDANÇA: Usando o novo popup de confirmação ---
    const titulo = `Confirmar Assinatura PRO`;
    const mensagem = `Deseja assinar o plano PRO (Tier ${tier.replace('tier', '')}) por R$ ${plano.preco.toFixed(2)} (válido por 30 dias)? O valor será descontado do seu saldo da carteira.`;
    
    exibirConfirmacao(titulo, mensagem, () => {
        // O código abaixo só executa se o usuário clicar "Sim"
        exibirAguarde("Ativando PRO...");

        db.runTransaction(async t => {
            const proRef = db.collection("usuarios").doc(auth.currentUser.uid);
            const financeiroRef = db.collection("config").doc("financeiro");
            const proDoc = await t.get(proRef);

            if (isProAtivo(proDoc.data())) {
                throw "Você já é um membro PRO ativo.";
            }

            const expiracao = new Date();
            expiracao.setDate(expiracao.getDate() + 30); // Adiciona 30 dias

            t.update(proRef, {
                saldo: firebase.firestore.FieldValue.increment(-plano.preco),
                proAtivo: true,
                proTier: tier, // Salva o nível do plano
                proExpirationDate: firebase.firestore.Timestamp.fromDate(expiracao)
            });

            t.set(financeiroRef, { arrecadadoPro: firebase.firestore.FieldValue.increment(plano.preco) }, { merge: true });

        }).then(() => {
            fecharTodosOsModais();
            exibirPopup("Sucesso!", "Parabéns! Você agora é um Profissional PRO!", "sucesso");
            notifyUser(auth.currentUser.uid, "🌟 Bem-vindo ao PRO!", "Aproveite seus benefícios exclusivos por 30 dias!");
            fecharModalAtual(); // Fecha o modal 'modalVipPro'
        }).catch(e => {
            fecharTodosOsModais();
            exibirPopup("Erro ao assinar PRO", e.message, "erro");
        });
    });
    // --- FIM DA MUDANÇA ---
}

// 3. SUBSTITUA A SUA FUNÇÃO 'confirmarTurbinar' ANTIGA POR ESTA COMPLETA
function confirmarTurbinar() {
    if (playStoreService) {
        comprarComPlayStore(SKUS.TURBINAR, PRECO_TURBINAR);
        return;
    }

    if (perfil.saldo < PRECO_TURBINAR) {
        return exibirPopup(`Saldo insuficiente. Você precisa de R$ ${PRECO_TURBINAR.toFixed(2)}.`);
    }
    if (perfil.ultimoBoostComprado) {
        const vinteQuatroHorasAtras = new Date(Date.now() - 24 * 60 * 60 * 1000);
        if (perfil.ultimoBoostComprado.toDate() > vinteQuatroHorasAtras) {
            return exibirPopup("Você só pode turbinar o perfil uma vez a cada 24 horas.");
        }
    }
    if (confirm(`Confirmar o boost de 24h por R$ ${PRECO_TURBINAR.toFixed(2)}? O valor será descontado do seu saldo.`)) {
        const expiracao = new Date(Date.now() + 24 * 60 * 60 * 1000);
        db.collection('usuarios').doc(auth.currentUser.uid).update({
            saldo: firebase.firestore.FieldValue.increment(-PRECO_TURBINAR),
            boostExpiracao: firebase.firestore.Timestamp.fromDate(expiracao),
            ultimoBoostComprado: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
            exibirPopup('Perfil turbinado com sucesso! Você está no topo da lista por 24 horas.');
            fecharModalAtual();
        }).catch(e => exibirPopup('Erro ao turbinar perfil: ' + e.message));
    }
}

/**
 * Verifica se a assinatura PRO do profissional está ativa.
 */

function isVipAtivo(perfilUsuario) {
    // Se não tiver a flag vip ou a data, retorna falso
    if (!perfilUsuario || !perfilUsuario.vip || !perfilUsuario.vipExpirationDate) {
        return false;
    }
    
    let expiracao;
    const dateData = perfilUsuario.vipExpirationDate;

    try {
        // Caso 1: É um Timestamp do Firebase (tem a função toDate)
        if (typeof dateData.toDate === 'function') {
            expiracao = dateData.toDate();
        }
        // Caso 2: Já é um objeto Date do JS
        else if (dateData instanceof Date) {
            expiracao = dateData;
        }
        // Caso 3: É uma String (formato ISO vindo do JSON da API)
        else if (typeof dateData === 'string') {
            expiracao = new Date(dateData);
        }
        // Caso 4: É um objeto Timestamp serializado (tem seconds/nanoseconds mas não a função)
        else if (dateData.seconds || dateData._seconds) {
            expiracao = new Date((dateData.seconds || dateData._seconds) * 1000);
        } else {
            return false; // Formato desconhecido
        }

        // Verifica se a data de expiração é maior que agora
        return expiracao > new Date();

    } catch (e) {
        console.error("Erro ao verificar VIP:", e);
        return false;
    }
}

// ADICIONE ESTA ÚNICA VERSÃO CORRETA (e delete as 3 antigas)

function isProAtivo(perfilUsuario) {
    // Se não tiver a flag proAtivo ou a data, retorna falso
    if (!perfilUsuario || !perfilUsuario.proAtivo || !perfilUsuario.proExpirationDate) {
        return false;
    }

    let expiracao;
    const dateData = perfilUsuario.proExpirationDate;

    try {
        // Caso 1: Timestamp do Firebase (tem a função toDate)
        if (typeof dateData.toDate === 'function') {
            expiracao = dateData.toDate();
        }
        // Caso 2: Objeto Date do JS
        else if (dateData instanceof Date) {
            expiracao = dateData;
        }
        // Caso 3: String ISO (formato que o admin envia)
        else if (typeof dateData === 'string') {
            expiracao = new Date(dateData);
        }
        // Caso 4: Objeto Timestamp serializado (pode vir de algum cache)
        else if (dateData.seconds || dateData._seconds) {
            expiracao = new Date((dateData.seconds || dateData._seconds) * 1000);
        } else {
            return false; // Formato desconhecido
        }

        // Verifica se a data de expiração é maior que agora
        return expiracao > new Date();

    } catch (e) {
        console.error("Erro ao verificar PRO:", e);
        return false;
    }
}


// FUNÇÃO DO CHAT ATUALIZADA
let chatAtual = 'global';
function abrirChatGlobal() {
    // Reseta o contador visualmente e a variável
    const badge = document.querySelector('.notification-badge');
    if(badge) {
        badge.textContent = '0';
        badge.classList.remove('visible'); // Esconde a bolinha
    }
    
    abrirModal('janelaChat');
    alternarChat('global'); // Começa sempre no global
}

function alternarChat(tipo) {
    chatAtual = tipo; // Atualiza a variável global
    document.getElementById('tabChatGlobal').classList.toggle('active', tipo === 'global');
    document.getElementById('tabChatLocal').classList.toggle('active', tipo === 'local');

    const adminSelector = document.getElementById('adminChatSelectorContainer');
    if (adminSelector) adminSelector.classList.add('hidden'); // Garante que está escondido

    const chatContainer = document.getElementById("chatMessages");
    chatContainer.innerHTML = ""; // Limpa mensagens anteriores
    oldestMessageSnapshot = null; // Reseta a paginação
    if (chatListener) chatListener(); // Cancela o listener anterior

    let query = db.collection("chats").doc(CHAT_GLOBAL_ID).collection("mensagens");
    const agora = new Date();

    query = query.where("tipoChat", "==", tipo);

    if (tipo === 'local') {
        if (perfil.tipo === 'admin') {
            document.getElementById("chatTitle").textContent = `📍 Chat Local (Todas as Cidades)`;
        } else {
            query = query.where("cidade", "==", perfil.cidade); 
            document.getElementById("chatTitle").textContent = `📍 Chat Local (${perfil.cidade})`;
        }
    } else {
        document.getElementById("chatTitle").textContent = '💬 Chat Global';
    }

    // CORREÇÃO AQUI: Alterado de limit(50) para limit(10)
    query = query.where("deleteAt", ">", agora) 
                 .orderBy("ts", "desc")         
                 .limit(10);                     

    chatListener = query.onSnapshot(async snapshot => {
        const chatContainer = document.getElementById("chatMessages");
        const carregarMaisBtn = document.getElementById('carregarMaisMsgBtn');
        // Só rola para baixo automaticamente se estiver perto do fundo ou se for o primeiro load
        const deveRolarParaBaixo = (chatContainer.scrollTop + chatContainer.clientHeight + 150) >= chatContainer.scrollHeight || chatContainer.innerHTML === "";
        
        const changes = snapshot.docChanges();

        // Verifica se é a carga inicial limpa
        const isFirstLoad = chatContainer.children.length === 0 || 
                          (chatContainer.children.length === 1 && chatContainer.children[0].tagName === 'P');

        if (isFirstLoad) {
            chatContainer.innerHTML = ""; // Limpa o placeholder
            if (snapshot.empty) {
                let msgVazio = `Nenhuma mensagem ${tipo === 'global' ? 'neste chat' : ''} ainda.`;
                if (tipo === 'local' && perfil.tipo !== 'admin') msgVazio = `Nenhuma mensagem em ${perfil.cidade} ainda.`;
                else if (tipo === 'local' && perfil.tipo === 'admin') msgVazio = `Nenhuma mensagem local encontrada.`;
                chatContainer.innerHTML = `<p>${msgVazio}</p>`;
                
                carregarMaisBtn.style.display = 'none';
                oldestMessageSnapshot = null;
                return;
            }
            
            carregarMaisBtn.style.display = 'block';
            carregarMaisBtn.textContent = 'Ver mensagens anteriores';
            carregarMaisBtn.disabled = false;
            oldestMessageSnapshot = snapshot.docs[snapshot.docs.length - 1]; 

            const docsEmOrdem = snapshot.docs.reverse(); 
            for (const doc of docsEmOrdem) {
                const msg = doc.data();
                const messageDiv = await createMessageDiv(msg, doc.id); // Passa o doc.id
                chatContainer.appendChild(messageDiv);
            }
        } else {
            // Processa apenas as mudanças subsequentes
            for (const change of changes) {
                if (change.type === 'added') {
                    // Verifica duplicidade
                    const existingMsg = chatContainer.querySelector(`[data-doc-id="${change.doc.id}"]`);
                    if (!existingMsg) { 
                        // Se for mensagem nova (newIndex 0 na query desc), adiciona no final
                        // Se veio de paginação ou atualização histórica, a lógica seria outra, 
                        // mas aqui focamos em mensagens novas chegando em tempo real.
                        const msg = change.doc.data();
                        const messageDiv = await createMessageDiv(msg, change.doc.id); 
                        chatContainer.appendChild(messageDiv); 
                    }
                }
                if (change.type === 'removed') {
                    const existingMsg = chatContainer.querySelector(`[data-doc-id="${change.doc.id}"]`);
                    if (existingMsg) {
                        existingMsg.remove(); // Remove a mensagem da tela
                    }
                }
            }
        }

        if (deveRolarParaBaixo) {
            setTimeout(() => {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, 100);
        }

    }, error => { 
        console.error("Erro ao carregar chat:", error);
        chatContainer.innerHTML = `<p style="color: red;">Erro ao carregar mensagens.</p>`;
        document.getElementById('carregarMaisMsgBtn').style.display = 'none';
    });

    const chatInput = document.getElementById('chatInput');
    chatInput.removeEventListener('keydown', handleChatEnter);
    chatInput.addEventListener('keydown', handleChatEnter);
}

async function carregarMensagensAnteriores() {
    if (!oldestMessageSnapshot) {
        document.getElementById('carregarMaisMsgBtn').textContent = 'Fim do histórico';
        document.getElementById('carregarMaisMsgBtn').disabled = true; // Desabilita o botão
        return;
    }

    const btn = document.getElementById('carregarMaisMsgBtn');
    btn.textContent = 'Carregando...';
    btn.disabled = true;

    const agora = new Date();
    let query = db.collection("chats").doc(CHAT_GLOBAL_ID).collection("mensagens");

    // --- FILTRO POR TIPO DE CHAT ---
    query = query.where("tipoChat", "==", chatAtual);
    // ---------------------------------

    if (chatAtual === 'local') {
        if (perfil.tipo === 'admin') {
            // Admin vê todas as locais, sem filtro de cidade para paginação também
        } else {
            // Usuário comum só pagina na sua cidade
            query = query.where("cidade", "==", perfil.cidade);
        }
    }

    // Continua com a paginação e expiração, ordenando por 'ts'
    query = query.where("deleteAt", ">", agora) // Filtra mensagens não expiradas
                 .orderBy("ts", "desc")         // Ordena pela mais recente primeiro
                 .startAfter(oldestMessageSnapshot) // Começa depois da última mensagem carregada
                 .limit(30);                     // Limite para mensagens anteriores

    try {
        const snapshot = await query.get();
        const chatContainer = document.getElementById("chatMessages");
        
        // Guarda a altura atual para manter a posição do scroll
        const scrollAntes = chatContainer.scrollHeight - chatContainer.scrollTop;

        if (snapshot.empty) {
            btn.textContent = 'Fim do histórico';
            oldestMessageSnapshot = null; // Marca que chegou ao fim
            btn.disabled = true; // Desabilita pois não há mais o que carregar
            return;
        }

        oldestMessageSnapshot = snapshot.docs[snapshot.docs.length - 1]; // Atualiza o cursor da paginação

        // Inverte a ordem do snapshot (que veio DESC) para iterar (ASC)
        const docsEmOrdem = snapshot.docs.reverse();

        for (const doc of docsEmOrdem) {
            const msg = doc.data();
            const messageDiv = await createMessageDiv(msg, doc.id); // Passa o doc.id
            chatContainer.prepend(messageDiv); // ADICIONA NO TOPO (prepend)
        }

        // Tenta restaurar a posição do scroll relativa ao ponto onde estava
        chatContainer.scrollTop = chatContainer.scrollHeight - scrollAntes;

        btn.textContent = 'Ver mensagens anteriores';
        btn.disabled = false;

    } catch (error) {
        console.error("Erro ao carregar mensagens anteriores:", error);
        btn.textContent = 'Erro ao carregar';
        btn.disabled = false; // Permite tentar novamente
    }
 }

// SUBSTITUA A FUNÇÃO enviarMensagem INTEIRA POR ESTA:
async function enviarMensagem() {
    if (!auth.currentUser) {
        exibirPopup("Para enviar mensagens, por favor, faça login ou crie uma conta.");
        mostrar('authView');
        fecharModalAtual();
        return;
    }
    if (isSending) return; // Impede envio se já estiver enviando
    const texto = document.getElementById("chatInput").value.trim();
    if (!texto) return;
    
    isSending = true; // Trava o botão
    const deleteAt = new Date(Date.now() + 24 * 60 * 60 * 1000);

    const messageData = {
        remetenteUid: auth.currentUser.uid,
        remetenteNome: perfil.nome,
        tipo: perfil.tipo,
        texto,
        ts: firebase.firestore.FieldValue.serverTimestamp(),
        cidade: perfil.cidade, // Cidade do remetente
        tipoChat: chatAtual, // 'global' ou 'local'
        deleteAt: firebase.firestore.Timestamp.fromDate(deleteAt)
    };

    try {
        await db.collection("chats").doc(CHAT_GLOBAL_ID).collection("mensagens").add(messageData);
        
        document.getElementById("chatInput").value = ""; // Limpa o input
        
        const lowerTexto = texto.toLowerCase();
        if ((lowerTexto.includes('suporte') || lowerTexto.includes('ajuda')) && chatAtual === 'global') { 
            setTimeout(enviarRespostaAI, 1000); // Resposta do bot 1s depois
        }
        
        // Libera o botão após 1 segundo, independentemente da resposta do bot
        setTimeout(() => { isSending = false; }, 1000); 

    } catch (error) {
        console.error("Erro ao enviar mensagem:", error);
        isSending = false; // Libera o botão em caso de erro
    }
 }

async function createMessageDiv(msg, docId) {
    let remetenteNome = msg.remetenteNome || "Desconhecido";
    let classeCSS = "", iconeBase = "";
    const messageDiv = document.createElement('div');
    const isCurrentUser = auth.currentUser && msg.remetenteUid === auth.currentUser.uid;
    
    // Classes padrão
    let classesDiv = `chat-message ${isCurrentUser ? "chat-sent" : "chat-received"}`;

    if (docId) {
        messageDiv.dataset.docId = docId;
        if (perfil && perfil.tipo === 'admin' && msg.tipo !== 'bot' && msg.tipo !== 'ai_suporte') {
            messageDiv.onclick = () => adminDeletarMensagemChat(docId, msg.texto);
            messageDiv.title = 'Admin: Clique para deletar esta mensagem';
            messageDiv.classList.add('admin-deletable');
        }
    }

    let nomeSpanHtml = ''; 
    let balaoCustomClass = '';

    // LÓGICA DE BOT
    if (msg.tipo === "bot" || msg.tipo === "ai_suporte") {
        nomeSpanHtml = `<span style="color: red; font-weight:bold;">${msg.tipo === "ai_suporte" ? '🤖 Suporte AI' : '🤖 Nova Versão Bot'}</span>`;
    } else {
        try {
            let remetenteData;
            
            // ATUALIZAÇÃO CRÍTICA: Sempre busca dados frescos se for o usuário atual para pegar a troca de balão imediata
            if (isCurrentUser) {
                // Recarrega o perfil global se necessário ou usa o atual (que já deve ter sido atualizado pelo listener do perfil)
                remetenteData = perfil; 
            } else {
                // Para outros usuários, busca no banco
                const remetenteDoc = await db.collection("usuarios").doc(msg.remetenteUid).get();
                if (remetenteDoc.exists) remetenteData = remetenteDoc.data();
            }

            if(remetenteData) {
                // --- 1. APLICA O BALÃO SELECIONADO (CORREÇÃO) ---
                if (remetenteData.balaoSelecionado && BALOES[remetenteData.balaoSelecionado]) {
                    // Adiciona a classe CSS do balão (ex: bubble-ouro)
                    balaoCustomClass = ' ' + BALOES[remetenteData.balaoSelecionado].classe + ' custom-bubble';
                }

                // --- 2. DEFINE ESTILO DO NOME ---
                if (remetenteData.tipo === "admin") {
                    classeCSS = `admin-chat-red`; iconeBase = `🧠`;
                } else if (remetenteData.tipo !== "cliente") { 
                    classeCSS = `barbeiro-chat`;
                    iconeBase = isProAtivo(remetenteData) ? `🌟` : `💼`;
                } else { 
                    classeCSS = `cliente-chat`;
                    iconeBase = isVipAtivo(remetenteData) ? `👑` : `👤`;
                }

                // --- 3. CONQUISTAS ---
                let conquistasHtml = "";
                if (remetenteData.conquistasSelecionadas) {
                    const todasDefs = { ...conquistasDefinidas.cliente, ...conquistasDefinidas.profissional };
                    remetenteData.conquistasSelecionadas.forEach(cId => {
                        if(todasDefs[cId]) conquistasHtml += `<span style="margin-right:2px;">${todasDefs[cId].icone}</span>`;
                    });
                }

                // --- 4. FOTO E MOLDURA ---
                const fotoUrl = remetenteData.fotoPerfil || 'https://via.placeholder.com/30';
                let avatarHtml = '';

                if (remetenteData.molduraSelecionada && MOLDURAS[remetenteData.molduraSelecionada]) {
                    const classeMoldura = MOLDURAS[remetenteData.molduraSelecionada].classe;
                    // CORREÇÃO AQUI: Adicionada a classe da moldura (ex: 'diamante') na div wrapper
                    avatarHtml = `
                    <div class="avatar-wrapper chat-size ${remetenteData.molduraSelecionada}" onclick="event.stopPropagation(); abrirPerfilUsuarioChat('${msg.remetenteUid}')" style="cursor: pointer;">
                        <div class="coroa-topo"></div>
                        <img src="${fotoUrl}" class="chat-user-photo ${classeMoldura}">
                    </div>`;
                } else {
                    avatarHtml = `<img src="${fotoUrl}" class="chat-user-photo" style="width:32px; height:32px; border-radius:50%; margin-right:8px; vertical-align:middle; border:1px solid #555; display:inline-block; object-fit:cover;" onclick="event.stopPropagation(); abrirPerfilUsuarioChat('${msg.remetenteUid}')">`;
                }

                const nomeClicavel = `<span class="${classeCSS}" onclick="event.stopPropagation(); abrirPerfilUsuarioChat('${msg.remetenteUid}')" style="cursor: pointer; text-decoration: underline; font-weight: bold; vertical-align: middle;">${remetenteData.nome}</span>`;
                
                nomeSpanHtml = `${avatarHtml} ${nomeClicavel} <span style="vertical-align: middle; margin-left:5px;">${conquistasHtml} ${iconeBase}</span>`;

            } else {
                 nomeSpanHtml = `<span class="cliente-chat">👻 Usuário Excluído</span>`;
            }
        } catch (error) {
             console.log(error);
             nomeSpanHtml = `<span class="cliente-chat">${remetenteNome}</span>`;
        }
    }

    // Aplica as classes finais (Garante que classes antigas não interfiram)
    messageDiv.className = classesDiv + balaoCustomClass;

    messageDiv.innerHTML = `
        <div style="display:flex; align-items:center; margin-bottom:4px;">${nomeSpanHtml}</div>
        <div style="padding-left: 5px; word-break: break-word; line-height: 1.4;">${msg.texto}</div>
    `;
    
    if (msg.ts && msg.ts.toDate) {
        const timeString = msg.ts.toDate().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        messageDiv.innerHTML += ` <small style="opacity: 0.6; font-size: 0.7em; float:right; margin-top:5px; margin-left: 10px;">${timeString}</small>`;
    }
    return messageDiv;
}

async function abrirPerfilUsuarioChat(uid) {
    const doc = await db.collection('usuarios').doc(uid).get();
    if(!doc.exists) return;
    const u = doc.data();
    
    // Limpa e prepara o container da foto
    // Precisamos substituir a tag <img> simples por uma div wrapper se houver moldura
    // O jeito mais seguro é injetar HTML novo na área da foto
    const modalContent = document.querySelector('#modalVisualizarPerfilChat .perfil-visualizacao-content');
    
    // Remove foto antiga se existir para recriar
    const fotoAntiga = document.getElementById('visuPerfilFoto');
    const wrapperAntigo = modalContent.querySelector('.avatar-wrapper');
    if (fotoAntiga) fotoAntiga.remove();
    if (wrapperAntigo) wrapperAntigo.remove();

    const nomeEl = document.getElementById('visuPerfilNome'); // Referência para inserir antes
    
    const fotoUrl = u.fotoPerfil || 'https://via.placeholder.com/120';
    let htmlFoto = '';

    if (u.molduraSelecionada && MOLDURAS[u.molduraSelecionada]) {
        // Com Moldura (Grande - popup-size)
        htmlFoto = `
        <div class="avatar-wrapper popup-size ${u.molduraSelecionada}">
            <div class="coroa-topo"></div>
            <img id="visuPerfilFoto" src="${fotoUrl}" class="perfil-foto-grande">
        </div>`;
    } else {
        // Sem Moldura
        htmlFoto = `<img id="visuPerfilFoto" src="${fotoUrl}" class="perfil-foto-grande" style="width:120px; height:120px; border-radius:50%; border:3px solid #333; margin: 0 auto 10px auto; display: block;">`;
    }
    
    // Insere o HTML da foto antes do Nome
    nomeEl.insertAdjacentHTML('beforebegin', htmlFoto);
    
    nomeEl.textContent = u.nome;
    
    // Tipo de Usuário
    let tipoTexto = "Usuário";
    let corTipo = "#ccc";
    if (u.tipo === 'admin') { tipoTexto = "🧠 Administrador"; corTipo = "#e74c3c"; }
    else if (u.tipo === 'cliente') { tipoTexto = "🙋 Cliente"; corTipo = "#fff"; }
    else { tipoTexto = "💈 Profissional"; corTipo = "var(--cor-destaque)"; }
    
    const tipoEl = document.getElementById('visuPerfilTipo');
    tipoEl.textContent = tipoTexto;
    tipoEl.style.color = corTipo;
    
    // Conquistas
    const container = document.getElementById('visuPerfilConquistas');
    container.innerHTML = '';
    if (u.conquistasSelecionadas) {
        const todasDefs = { ...conquistasDefinidas.cliente, ...conquistasDefinidas.profissional };
        u.conquistasSelecionadas.forEach(cId => {
            if(todasDefs[cId]) container.innerHTML += `<span title="${todasDefs[cId].nome}">${todasDefs[cId].icone}</span>`;
        });
    }
    
    // Botões Admin
    const oldAdminBtns = document.getElementById('adminActionsChatPopup');
    if(oldAdminBtns) oldAdminBtns.remove();

    if (perfil.tipo === 'admin') {
        const divBtns = document.createElement('div');
        divBtns.id = 'adminActionsChatPopup';
        divBtns.style.display = 'flex';
        divBtns.style.gap = '10px';
        divBtns.style.marginTop = '15px';
        divBtns.style.justifyContent = 'center';

        if(u.telefone) {
            const btnWpp = document.createElement('button');
            btnWpp.innerHTML = '💬 WhatsApp';
            btnWpp.style.backgroundColor = '#25D366';
            btnWpp.onclick = () => abrirWhatsApp(u.telefone);
            divBtns.appendChild(btnWpp);
        }

        const btnGerenciar = document.createElement('button');
        btnGerenciar.innerHTML = '⚙️ Gerenciar';
        btnGerenciar.onclick = () => {
            fecharModalAtual();
            abrirModalGerenciarUsuario(uid);
        };
        divBtns.appendChild(btnGerenciar);
        container.parentNode.appendChild(divBtns);
    }
    
    abrirModal('modalVisualizarPerfilChat');
}

async function adminAbrirInfoChat(uid) {
    exibirAguarde("Buscando dados do usuário...");
    
    const modal = document.getElementById('modalAdminInfoChat');
    const nomeEl = modal.querySelector('#adminInfoChatNome');
    const conteudoEl = modal.querySelector('#adminInfoChatConteudo');
    const btnWpp = modal.querySelector('#adminInfoChatBtnWpp');
    const btnGerenciar = modal.querySelector('#adminInfoChatBtnGerenciar');

    try {
        const userDoc = await db.collection('usuarios').doc(uid).get();
        if (!userDoc.exists) {
            throw new Error("Usuário não encontrado.");
        }
        const u = userDoc.data();

        nomeEl.textContent = u.nome;
        conteudoEl.innerHTML = `
            <p><strong>Email:</strong> ${u.email}</p>
            <p><strong>Telefone:</strong> ${u.telefone || 'N/A'}</p>
            <p><strong>Tipo:</strong> ${u.tipo}</p>
            <p><strong>Cidade/Estado:</strong> ${u.cidade || 'N/A'} - ${u.estado || 'N/A'}</p>
            <p><strong>Saldo:</strong> R$ ${(u.saldo || 0).toFixed(2)}</p>
            <p><strong>VIP:</strong> ${isVipAtivo(u) ? 'Sim' : 'Não'}</p>
            <p><strong>PRO:</strong> ${isProAtivo(u) ? `Sim (Tier: ${u.proTier})` : 'Não'}</p>
        `;

        if (u.telefone) {
            btnWpp.onclick = () => abrirWhatsApp(u.telefone);
            btnWpp.disabled = false;
        } else {
            btnWpp.onclick = null;
            btnWpp.disabled = true;
        }
        
        btnGerenciar.onclick = () => {
            fecharModalAtual(); // Fecha o modal de info
            abrirModalGerenciarUsuario(uid); // Abre o de gerenciamento completo
        };

        fecharTodosOsModais(); // Fecha o "aguarde"
        abrirModal('modalAdminInfoChat');

    } catch (error) {
        fecharTodosOsModais();
        exibirPopup("Erro", "Não foi possível carregar os dados: " + error.message, 'erro');
    }
}

async function adminDeletarMensagemChat(docId, textoMensagem) {
    if (!docId) return;
    
    const confirmacao = confirm(`ADMIN: Deseja deletar permanentemente esta mensagem?\n\n"${textoMensagem.substring(0, 100)}..."`);
    
    if (confirmacao) {
        exibirAguarde("Deletando mensagem...");
        try {
            const msgRef = db.collection("chats").doc(CHAT_GLOBAL_ID).collection("mensagens").doc(docId);
            await msgRef.delete();
            fecharTodosOsModais();
            // O listener do 'alternarChat' (com a lógica 'removed')
            // cuidará de remover a mensagem da tela.
            console.log(`[Admin] Mensagem ${docId} deletada.`);
        } catch (error) {
            fecharTodosOsModais();
            console.error("Erro ao deletar mensagem:", error);
            exibirPopup("Erro", "Não foi possível deletar a mensagem: " + error.message);
        }
    }
}

function sendBotMessage() {
    let randomIndex;
    do { randomIndex = Math.floor(Math.random() * botMessages.length); } while (randomIndex === lastBotMessageIndex);
    lastBotMessageIndex = randomIndex;
    const deleteAt = new Date(Date.now() + 24 * 60 * 60 * 1000);
    db.collection("chats").doc(CHAT_GLOBAL_ID).collection("mensagens").add({
        remetenteUid: "bot-uid", remetenteNome: "Nova Versão Bot", tipo: "bot",
        texto: botMessages[randomIndex], ts: firebase.firestore.FieldValue.serverTimestamp(),
        cidade: "global", // Mensagem do bot é global
        deleteAt: firebase.firestore.Timestamp.fromDate(deleteAt)
    });
}

// ADICIONE ESTA NOVA FUNÇÃO
function handleChatEnter(event) {
    // Verifica se a tecla pressionada foi "Enter" e se a tecla Shift NÃO estava pressionada
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault(); // Impede a quebra de linha
        enviarMensagem(); // Chama a função de enviar
    }
}

function enviarMensagem() {
    if (!auth.currentUser) {
        exibirPopup("Para enviar mensagens, por favor, faça login ou crie uma conta.");
        mostrar('authView');
        fecharModalAtual();
        return;
    }
    if (isSending) return;
    const texto = document.getElementById("chatInput").value.trim();
    if (!texto) return;
    isSending = true;
    const deleteAt = new Date(Date.now() + 24 * 60 * 60 * 1000);

    // Adiciona o tipo do chat atual (global ou local)
    const messageData = {
        remetenteUid: auth.currentUser.uid,
        remetenteNome: perfil.nome,
        tipo: perfil.tipo,
        texto,
        ts: firebase.firestore.FieldValue.serverTimestamp(),
        cidade: perfil.cidade, // Cidade do remetente
        tipoChat: chatAtual, // <-- ADICIONADO: 'global' ou 'local'
        deleteAt: firebase.firestore.Timestamp.fromDate(deleteAt)
    };

    db.collection("chats").doc(CHAT_GLOBAL_ID).collection("mensagens").add(messageData)
    .then(() => {
        document.getElementById("chatInput").value = "";
        if (texto.toLowerCase().includes('suporte') && chatAtual === 'global') { // Bot só responde no global
            setTimeout(enviarRespostaAI, 1500);
        }
        setTimeout(() => { isSending = false; }, 1000);
    }).catch(error => { isSending = false; });
 }

// SUBSTITUA A FUNÇÃO enviarRespostaAI INTEIRA POR ESTA:
function enviarRespostaAI() {
    // A constante WHATSAPP_ADM_PHONE já deve estar definida no topo do seu script
    const mensagemPreEscrita = encodeURIComponent("Olá! Preciso de ajuda/suporte com o app Nova Versão.");
    const whatsappLink = `https://wa.me/${WHATSAPP_ADM_PHONE}?text=${mensagemPreEscrita}`;

    const resposta = `Olá! Sou a assistente virtual. <br><br>
        • Se você precisa de <b>ajuda ou suporte</b> de um administrador, a forma mais rápida é pelo WhatsApp. <br>
        • <b><a href="${whatsappLink}" target="_blank" style="color: var(--cor-destaque);">Clique aqui para falar com o suporte agora.</a></b> <br><br>
        • Se for uma dúvida geral sobre o app, tente perguntar aqui.`;
        
    const deleteAt = new Date(Date.now() + 24 * 60 * 60 * 1000);
    db.collection("chats").doc(CHAT_GLOBAL_ID).collection("mensagens").add({
        remetenteUid: "ai-suporte-uid",
        remetenteNome: "Suporte AI",
        tipo: "ai_suporte",
        texto: resposta,
        ts: firebase.firestore.FieldValue.serverTimestamp(),
        cidade: "global", // Resposta de suporte é sempre no global
        tipoChat: "global",
        deleteAt: firebase.firestore.Timestamp.fromDate(deleteAt)
    });
}

// Funções novas para o admin no chat
function adminCarregarCidadesChat() {
    const estado = document.getElementById('adminChatEstado').value;
    const cidadeSelect = document.getElementById('adminChatCidade');
    const valorAtual = cidadeSelect.value;
    cidadeSelect.innerHTML = '<option value="">Selecione a cidade</option>';
    const cidades = cidadesPorEstado[estado] || [];
    cidades.forEach(c => {
        // Seleciona a cidade do perfil do admin por padrão na primeira vez
        const isSelected = c === valorAtual || (c === perfil.cidade && !valorAtual);
        cidadeSelect.innerHTML += `<option value="${c}" ${isSelected ? 'selected' : ''}>${c}</option>`;
    });
    // Após carregar as cidades, se for um admin, recarrega o chat
    if(perfil.tipo === 'admin') {
        adminRecarregarChat();
    }
}

function adminRecarregarChat() {
    // Simplesmente chama a função de alternar, que agora contém a lógica 
    // para ler os selects do admin e carregar as mensagens da cidade escolhida.
    alternarChat('local');
}

function criarAviso(uid, mensagem, tipo = 'geral', agendamentoId = null) {
  const avisoData = { usuarioUid: uid, mensagem, tipo, lido: false, ts: firebase.firestore.FieldValue.serverTimestamp() };
  if (agendamentoId) avisoData.agendamentoId = agendamentoId;
  db.collection("avisos").add(avisoData);
}

function abrirModalComConfirmacao(modalId, tituloPopupConfirmacao = undefined, mensagemPopupConfirmacao = undefined) {
    abrirModal(modalId);
    const modalElement = document.getElementById(modalId);
    // Encontra o botão de fechar padrão (que usa data-modal-id)
    const btnFecharPadrao = modalElement.querySelector(`button[data-modal-id="${modalId}"]`);
    if (btnFecharPadrao) {
        // Modifica o onclick para chamar a confirmação
        btnFecharPadrao.onclick = () => pedirConfirmacaoFecharPopup(modalId, tituloPopupConfirmacao, mensagemPopupConfirmacao);
    }
    // Adiciona a confirmação ao clique no fundo também (se o modal permitir fechar no fundo)
    modalElement.onclick = (event) => {
        if (event.target.id === modalId) { // Clicou no fundo
            pedirConfirmacaoFecharPopup(modalId, tituloPopupConfirmacao, mensagemPopupConfirmacao);
        }
    };
    // Impede que cliques dentro do conteúdo fechem (já feito no seu modal-content)
    const modalContent = modalElement.querySelector('.modal-content');
    if (modalContent) {
        modalContent.onclick = (event) => event.stopPropagation();
    }
}

function enviarDenuncia() {
  const texto = document.getElementById("textoDenuncia").value.trim();
  if (!texto) return exibirPopup("Por favor, descreva o problema.");
  db.collection("denuncias").add({
    usuarioUid: auth.currentUser.uid, usuarioNome: perfil.nome, texto,
    status: "aberta", ts: firebase.firestore.FieldValue.serverTimestamp()
  }).then(denunciaRef => {
    abrirModal('modalDenunciaEnviada');
    const mensagem = encodeURIComponent(`🚨 Nova denúncia no app. ID: ${denunciaRef.id}\n\nDe: ${perfil.nome}\n\nDescrição: ${texto}`);
    document.getElementById("btnWhatsappDenuncia").href = `https://wa.me/${WHATSAPP_ADM_PHONE}?text=${mensagem}`;
    document.getElementById("textoDenuncia").value = "";
    notifyAdmins("🚨 Nova Denúncia!", `Uma nova denúncia foi enviada por ${perfil.nome}.`, { link: '#denuncias' });
  }).catch(e => exibirPopup("Erro ao enviar denúncia: " + e.message));
}

function abrirServicos() {
  abrirModal('modalServicosBarbeiro');
  listarServicos(); // Apenas lista os serviços
}

function listarServicos() {
  const lista = document.getElementById("listaServicosBarbeiro");
  lista.innerHTML = "<p>⏳ Carregando...</p>";
  db.collection("usuarios").doc(auth.currentUser.uid).onSnapshot(doc => {
    perfil = doc.data();
    lista.innerHTML = "";
    if (!perfil.listaServicos || perfil.listaServicos.length === 0) {
      lista.innerHTML = "<p>Nenhum serviço cadastrado.</p>";
      return;
    }
    perfil.listaServicos.forEach((s, index) => {
      lista.innerHTML += `<div class="card"><b>${s.nome}</b> - R$ ${s.valor.toFixed(2)} ${s.duracao ? `(${s.duracao} min)` : ''}<button onclick="removerServico(${index})" style="float:right">❌</button></div>`;
    });
  });
}

function iniciarFluxoPosCadastroProfissional() {
    fluxoPosCadastroAtivo = true;
    // Abre o primeiro modal (Logomarca) com a opção de confirmação ao fechar
    abrirModalComConfirmacao('modalLogomarca', '🎨 Adicionar Logomarca');
}

function adicionarServico() {
  // Limpa os campos do modal e define o título para "Adicionar"
  document.getElementById('modalAddServicoTitulo').textContent = 'Adicionar Novo Serviço';
  document.getElementById('addServicoNome').value = '';
  document.getElementById('addServicoValor').value = '';
  document.getElementById('addServicoTempo').value = '';
  
  // Define o botão para chamar a função de salvar (sem índice)
  document.getElementById('btnSalvarServico').onclick = () => salvarServico();
  
  abrirModal('modalAddServico');
}

// ESTA É UMA NOVA FUNÇÃO (cole junto com as outras funções do profissional)
function salvarServico() {
  const nome = document.getElementById("addServicoNome").value;
  const valor = parseFloat(document.getElementById("addServicoValor").value);
  const duracao = parseInt(document.getElementById("addServicoTempo").value);
  
  if (!nome || isNaN(valor) || valor <= 0 || isNaN(duracao) || duracao <= 0) {
      return exibirPopup("Entrada inválida.", "Por favor, preencha nome, valor (Ex: 25.50) e duração (Ex: 30).");
  }

  exibirAguarde("Salvando...");
  db.collection("usuarios").doc(auth.currentUser.uid).update({
    listaServicos: firebase.firestore.FieldValue.arrayUnion({ nome, valor, duracao })
  }).then(() => {
    fecharTodosOsModais(); // Fecha o "aguarde"
    fecharModalAtual(); // Fecha o modal "modalAddServico"
    exibirPopup("Sucesso!", "Serviço adicionado!");
    // listarServicos() será chamado automaticamente pelo onSnapshot em modalServicosBarbeiro
  }).catch(e => {
    fecharTodosOsModais();
    exibirPopup("Erro: " + e.message);
  });
}

function removerServico(index) {
  const servicoParaRemover = perfil.listaServicos[index];
  if (!confirm(`Deseja remover "${servicoParaRemover.nome}"?`)) return;
  db.collection("usuarios").doc(auth.currentUser.uid).update({
    listaServicos: firebase.firestore.FieldValue.arrayRemove(servicoParaRemover)
  }).then(() => exibirPopup("Serviço removido!")).catch(e => exibirPopup("Erro: " + e.message));
}

// Certifique-se de que a URL para a notificação está correta (ex: '/enviarNotificacao')
const NOTIFICATION_ENDPOINT = '/enviarNotificacao/'; 

// --- FUNÇÕES DE APROVAÇÃO E RECUSA ---

async function aprovarAgendamento(agendamentoId, clienteUid, clienteNome) {
    if (!agendamentoId) return;

    try {
        // 1. Atualiza o status no Firebase
        await db.collection('agendamentos').doc(agendamentoId).update({
            status: 'aprovado',
            aprovadoEm: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // 2. Envia notificação PUSH/POPUP para o cliente
        if (clienteUid) {
            await fetch(NOTIFICATION_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    targetUid: clienteUid,
                    title: `✅ Agendamento Aprovado!`,
                    body: `Seu agendamento com ${perfil.nome} foi confirmado. Te esperamos!`,
                    // Ação no payload para o Service Worker disparar o popup no cliente
                    data: { action: 'agendamento_status', status: 'aprovado', link: '#historico' } 
                })
            });
        }

        fecharModalAtual();
        exibirPopup("Sucesso", `Agendamento de ${clienteNome} Aprovado! A notificação foi enviada ao cliente.`);
        // Chamaria a função para recarregar a lista de agendamentos pendentes aqui.

    } catch (error) {
        console.error("Erro ao aprovar agendamento:", error);
        exibirPopup("Erro", "Falha ao aprovar. Tente novamente.");
    }
}

async function recusarAgendamento(agendamentoId, clienteUid, clienteNome) {
    if (!agendamentoId) return;

    try {
        // 1. Atualiza o status no Firebase
        await db.collection('agendamentos').doc(agendamentoId).update({
            status: 'recusado',
            recusadoEm: firebase.firestore.FieldValue.serverTimestamp()
        });

        // 2. Envia notificação PUSH/POPUP para o cliente
        if (clienteUid) {
            await fetch(NOTIFICATION_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    targetUid: clienteUid,
                    title: `❌ Agendamento Recusado`,
                    body: `Lamentamos, seu agendamento com ${perfil.nome} não pôde ser confirmado.`,
                    data: { action: 'agendamento_status', status: 'recusado', link: '#historico' }
                })
            });
        }

        fecharModalAtual();
        exibirPopup("Atenção", `Agendamento de ${clienteNome} Recusado.`);
        // Chama a função para recarregar a lista de agendamentos pendentes.

    } catch (error) {
        console.error("Erro ao recusar agendamento:", error);
        exibirPopup("Erro", "Falha ao recusar. Tente novamente.");
    }
}

// --- FUNÇÃO DE CONCLUSÃO (AVALIAÇÃO E PONTOS) ---

async function concluirAgendamento(agendamentoId, clienteUid, clienteNome, servicoNome) {
    if (!agendamentoId) return;

    try {
        // 1. Atualiza o status para 'concluido' no Firebase
        await db.collection('agendamentos').doc(agendamentoId).update({
            status: 'concluido',
            concluidoEm: firebase.firestore.FieldValue.serverTimestamp()
        });

        // 2. Notifica o cliente para avaliar e receber pontos!
        if (clienteUid) {
            await fetch(NOTIFICATION_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    targetUid: clienteUid,
                    title: `✨ Serviço Concluído!`,
                    body: `Como foi seu ${servicoNome}? Avalie para ganhar pontos e ajudar a comunidade!`,
                    data: { 
                        action: 'evaluate', 
                        agendamentoId: agendamentoId, 
                        modalId: 'modalAvaliacao' // Dispara modal de avaliação no cliente
                    } 
                })
            });
        }

        fecharModalAtual();
        exibirPopup("Sucesso", `Serviço com ${clienteNome} marcado como concluído!`);

    } catch (error) {
        console.error("Erro ao concluir agendamento:", error);
        exibirPopup("Erro", "Falha ao concluir. Tente novamente.");
    }
}

async function salvarLogomarca() {
    // ... (código original de upload e salvar no DB) ...
    const fileInput = document.getElementById("logomarcaFile");
    const progressBar = document.getElementById('logoUploadProgress');
    const previewImg = document.getElementById('logomarcaPreview');
    const btnSalvar = document.getElementById('btnSalvarLogo');

    if (!fileInput.files || fileInput.files.length === 0) { return exibirPopup("Por favor, selecione um arquivo."); }
    const file = fileInput.files[0];
    const userId = auth.currentUser.uid;

    exibirAguarde("Enviando logomarca...");
    progressBar.style.display = 'block'; progressBar.value = 0; previewImg.style.opacity = '0.5'; btnSalvar.disabled = true;

    if (perfil && perfil.logo_url) { try { const oldLogoRef = storage.refFromURL(perfil.logo_url); await oldLogoRef.delete(); } catch (e) { console.warn("Não foi possível deletar a logo antiga:", e.message); } }
    const filePath = `logos/${userId}_${Date.now()}_${file.name}`;

    try {
        const downloadURL = await uploadImage(file, filePath, (progress) => { progressBar.value = progress; });
        await db.collection("usuarios").doc(userId).update({ logo_url: downloadURL });

        progressBar.style.display = 'none'; progressBar.value = 0; previewImg.style.opacity = '1';
        fecharTodosOsModais();
        exibirPopup("Logomarca salva com sucesso!");

        // --- ADIÇÃO PARA FLUXO PÓS-CADASTRO ---
        // ... (código de sucesso)
 if (fluxoPosCadastroAtivo) {
     fecharModalAtual(); // Fecha o modal da logo
     abrirModalComConfirmacao('modalPortfolioBarbeiro', '🖼️ Adicionar ao Portfólio'); // Abre o próximo
 } else {
      fecharModalAtual(); // Fecha o modal da logo (comportamento normal)
 }
        // --- FIM DA ADIÇÃO ---

    } catch (error) { /* ... (bloco catch original) ... */
        progressBar.style.display = 'none'; progressBar.value = 0; previewImg.style.opacity = '1';
        fecharTodosOsModais(); exibirPopup("Erro ao salvar logomarca: " + error.message); btnSalvar.disabled = false;
    }
}

// Listener para preview da logomarca e habilitar botão salvar
const logoFileInput = document.getElementById('logomarcaFile');
const logoPreviewImg = document.getElementById('logomarcaPreview');
const logoSaveBtn = document.getElementById('btnSalvarLogo');
if (logoFileInput && logoPreviewImg && logoSaveBtn) {
    logoFileInput.addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                logoPreviewImg.src = e.target.result;
                logoPreviewImg.style.display = 'block';
                logoSaveBtn.disabled = false; // Habilita o botão
            }
            reader.readAsDataURL(file);
        } else {
            logoPreviewImg.src = '#';
            logoPreviewImg.style.display = 'none';
            logoSaveBtn.disabled = true; // Desabilita o botão
        }
    });
}

async function finalizarFluxoPosCadastro() {
    if (!fluxoPosCadastroAtivo) return;
    fluxoPosCadastroAtivo = false; // Desativa o fluxo
    try {
        await db.collection('usuarios').doc(auth.currentUser.uid).update({ onboarding_profissional_concluido: true });
        console.log("Onboarding do profissional marcado como concluído.");
        exibirPopup("Configuração concluída!", "Você já pode usar todas as funções do painel do profissional."); // Feedback final
    } catch (error) {
        console.error("Erro ao marcar onboarding como concluído:", error);
        // Informar o usuário sobre o erro pode ser útil
        exibirPopup("Erro", "Houve um problema ao finalizar a configuração. Tente novamente mais tarde ou contate o suporte.");
    }
    // Não precisa fechar modal aqui, pois já foi fechado antes de chamar esta função
 }

function alterarEnderecoBarbeiro(event) {
    const rua = document.getElementById("novoEnderecoRua").value.trim();
    const numero = document.getElementById("novoEnderecoNumero").value.trim();
    if (!rua || !numero) return exibirPopup("Por favor, preencha a rua e o número.");
    if (!cadastroCoords) return exibirPopup("Por favor, use o botão para definir a localização no mapa antes de salvar.");
    
    db.collection("usuarios").doc(auth.currentUser.uid).update({ 
        rua, 
        numero,
        latitude: cadastroCoords.latitude,
        longitude: cadastroCoords.longitude,
    }).then(() => {
        exibirPopup("Endereço alterado com sucesso!");
        cadastroCoords = null;
        fecharModalAtual();
    }).catch(e => exibirPopup("Erro ao alterar endereço: " + e.message));
}

// ATUALIZE ESTA FUNÇÃO EM INDEX.HTML
function abrirAgenda() {
    abrirModal('modalAgendaBarbeiro');
    // Adiciona o novo botão no painel da agenda
    const container = document.getElementById('modalAgendaBarbeiro').querySelector('.modal-content');
    if (!container.querySelector('#btnModoFerias')) {
        const btnFerias = document.createElement('button');
        btnFerias.id = 'btnModoFerias';
        btnFerias.textContent = '🏖️ Ativar Modo Férias/Ausência';
        btnFerias.onclick = () => abrirModal('modalModoFerias');
        // Insere antes do painel da agenda manual para melhor organização
        const painelManual = document.getElementById('agendaManualPainel');
        container.insertBefore(btnFerias, painelManual);
    }
    carregarAgenda();
}

/**
 * Exibe um popup de confirmação customizado.
 * @param {string} titulo O título do popup.
 * @param {string} mensagem A pergunta ou mensagem.
 * @param {function} onConfirm A função a ser executada se o usuário clicar "Sim".
 */
function exibirConfirmacao(titulo, mensagem, onConfirm) {
    document.getElementById('confirmacaoGenericaTitulo').textContent = titulo;
    document.getElementById('confirmacaoGenericaMensagem').textContent = mensagem;

    onConfirmCallback = onConfirm; // Armazena a ação

    document.getElementById('btnConfirmacaoGenericaSim').onclick = () => {
        if (onConfirmCallback) {
            onConfirmCallback();
        }
        fecharModalAtual();
        onConfirmCallback = null;
    };

    document.getElementById('btnConfirmacaoGenericaNao').onclick = () => {
        fecharModalAtual();
        onConfirmCallback = null;
    };

    // Adiciona listener para fechar no fundo
    const modal = document.getElementById('modalConfirmacaoGenerica');
    modal.onclick = (event) => {
         if (event.target.id === 'modalConfirmacaoGenerica') {
             fecharModalAtual();
             onConfirmCallback = null;
         }
    };

    abrirModal('modalConfirmacaoGenerica');
}

function carregarAgenda() {
    const btnDisp = document.getElementById("btnDisponibilidade");
    const btnVagaImediata = document.getElementById("btnVagaImediata");
    const btnAgendaManual = document.getElementById("btnAgendaManual");
    const agendaManualPainel = document.getElementById("agendaManualPainel");
    const horariosContainer = document.getElementById("horariosContainer");

    // Verifica se o usuário está logado antes de buscar
    if (!auth.currentUser) return;

    db.collection("usuarios").doc(auth.currentUser.uid).onSnapshot(doc => {
        perfil = doc.data(); 
        if(!btnDisp) return; // Se o modal não estiver renderizado ainda

        // Atualiza Textos e Cores dos Botões
        btnDisp.textContent = perfil.disponivel === 'sim' ? '🔴 Parar Disponibilidade Automática' : '🟢 Ativar Disponibilidade Automática';
        btnDisp.style.border = perfil.disponivel === 'sim' ? '1px solid #e74c3c' : '1px solid #2ecc71';

        btnVagaImediata.textContent = perfil.vagaImediata ? '⚠️ Desativar Vaga Imediata' : '⚡ Ativar Vaga Imediata';
        btnVagaImediata.classList.toggle('selected', perfil.vagaImediata);

        btnAgendaManual.textContent = perfil.usaAgendaManual ? '❌ Fechar Agenda Manual' : '📅 Configurar Agenda Manual';
        btnAgendaManual.classList.toggle('selected', perfil.usaAgendaManual);
        
        // Lógica da Agenda Manual
        if (perfil.usaAgendaManual) {
            agendaManualPainel.classList.remove("hidden");
            horariosContainer.innerHTML = "";
            tempSelectedHorarios = { ...perfil.agenda };
            
            // Gera horários das 07:00 às 20:00 (ajuste conforme necessidade)
            for (let i = 7 * 60; i <= 20 * 60; i += 30) { 
                const horas = Math.floor(i / 60);
                const minutos = i % 60;
                const horario = `${horas}:${minutos.toString().padStart(2, '0')}`;
                
                const statusHorario = tempSelectedHorarios[horario];
                const btn = document.createElement('button');
                btn.textContent = horario;
                btn.className = `horario-btn`;
                
                if(statusHorario === true) btn.classList.add('selecionado');
                if(statusHorario === 'bloqueado') btn.classList.add('bloqueado');
                
                btn.onclick = () => toggleHorario(horario);
                horariosContainer.appendChild(btn);
            }
        } else {
            agendaManualPainel.classList.add("hidden");
        }
    });
}

function abrirAgendamentosBarbeiro() {
  abrirModal('modalAgendamentosBarbeiro');
  const painel = document.getElementById("agendamentosPainel");
  painel.innerHTML = "<p>⏳ Carregando...</p>";
  db.collection("agendamentos")
    .where("barbeiroUid", "==", auth.currentUser.uid)
    .where("status", "in", ["pendente", "confirmado", "imediato", "conclusão pendente"])
    .orderBy("ts", "asc")
    .onSnapshot(snap => {
        painel.innerHTML = !snap.empty ? "" : "<p>Nenhum agendamento ativo.</p>";
        snap.forEach(doc => {
            const ag = doc.data();
            let botoes = "", statusTexto = "", horarioInfo = ag.horario ? ` às <b>${ag.horario}</b>` : ' (Vaga Imediata)';
            if (ag.status === "pendente") {
                statusTexto = "⏳ Aguardando Aprovação";
                botoes = `<button onclick="aprovarAgendamento('${doc.id}','${ag.clienteUid}',${ag.valor},'${ag.horario}')">✅ Aprovar</button><button onclick="recusarAgendamento('${doc.id}','${ag.clienteUid}')">❌ Recusar</button>`;
            } else if (ag.status === "confirmado" || ag.status === "conclusão pendente") {
                statusTexto = "✅ Conclusão Pendente";
                botoes = `<button onclick="concluirAgendamento('${doc.id}','${ag.clienteUid}')">✂️ Concluir</button><button onclick="cancelarAgendamentoManualmente('${doc.id}','${ag.clienteUid}',${ag.valor})">❌ Cancelar</button>`;
            } else if (ag.status === "imediato") {
                statusTexto = "⚡ Vaga Imediata Pendente";
                botoes = `<button onclick="aprovarAgendamentoImediato('${doc.id}','${ag.clienteUid}',${ag.valor})">✅ Aprovar</button><button onclick="recusarAgendamento('${doc.id}','${ag.clienteUid}')">❌ Recusar</button>`;
            }
            painel.innerHTML += `<div class="card"><b>${ag.clienteNome}</b> - ${ag.servico} (R$ ${ag.valor.toFixed(2)})<br>Horário: ${horarioInfo}<br>Status: <b>${statusTexto}</b>${ag.clienteTelefone ? `<br><a href="https://wa.me/55${ag.clienteTelefone}" target="_blank">📞 Contatar</a>` : ''}<div style="margin-top:10px; display:flex; gap: 8px;">${botoes}</div></div>`;
        });
    });
}

function formatarNomeProprio(texto) {
  if (!texto) return "";
  // Converte tudo para minúsculo primeiro para padronizar
  return texto.toLowerCase()
    // Separa as palavras por espaço
    .split(' ')
    // Mapeia cada palavra
    .map(palavra => {
      // Capitaliza a primeira letra e concatena com o resto da palavra
      return palavra.charAt(0).toUpperCase() + palavra.slice(1);
    })
    // Junta as palavras de volta com espaço
    .join(' ');
}

function toggleVagaImediata() {
    db.collection("usuarios").doc(auth.currentUser.uid).update({ vagaImediata: !perfil.vagaImediata }).catch(e => exibirPopup("Erro: " + e.message));
}

function toggleAgendaManual() {
  db.collection("usuarios").doc(auth.currentUser.uid).update({ usaAgendaManual: !perfil.usaAgendaManual }).catch(e => exibirPopup("Erro: " + e.message));
}

function toggleHorario(horario) {
    const btn = Array.from(document.querySelectorAll('#horariosContainer .horario-btn')).find(b => b.textContent === horario);
    const statusAtual = tempSelectedHorarios[horario];
    if (statusAtual === true) {
        tempSelectedHorarios[horario] = 'bloqueado';
        btn.classList.remove("selecionado"); btn.classList.add("bloqueado");
    } else if (statusAtual === 'bloqueado') {
        delete tempSelectedHorarios[horario];
        btn.classList.remove("bloqueado");
    } else {
        tempSelectedHorarios[horario] = true;
        btn.classList.add("selecionado");
    }
}


function salvarAgendaManual() {
    db.collection("usuarios").doc(auth.currentUser.uid).update({ agenda: tempSelectedHorarios })
      .then(() => exibirPopup("Agenda salva!"))
      .catch(e => exibirPopup("Erro ao salvar: " + e.message));
}

function toggleDisponibilidade() {
  db.collection("usuarios").doc(auth.currentUser.uid).update({ disponivel: perfil.disponivel === "sim" ? "nao" : "sim" }).catch(e => exibirPopup("Erro: " + e.message));
}

async function aprovarAgendamentoImediato(agendamentoId, clienteUid, valor) {
    exibirAguarde("Aprovando...");
    
    // Lógica de cálculo de taxa dinâmica
    let taxaAplicada = TAXA;
    if (isProAtivo(perfil) && perfil.proTier && PRECOS_PRO[perfil.proTier]) {
        taxaAplicada = PRECOS_PRO[perfil.proTier].taxa;
    }
    const valorComTaxa = valor * (1 - taxaAplicada);
    const valorAdmin = valor * taxaAplicada;

    db.runTransaction(async t => {
        const agendamentoRef = db.collection("agendamentos").doc(agendamentoId);
        const clienteRef = db.collection("usuarios").doc(clienteUid);
        const barbeiroRef = db.collection("usuarios").doc(auth.currentUser.uid);
        
        const [agendamentoDoc, clienteDoc, barbeiroDoc] = await Promise.all([t.get(agendamentoRef), t.get(clienteRef), t.get(barbeiroRef)]);
        
        if (agendamentoDoc.data().status !== 'imediato') throw "Solicitação já processada.";
        if (!clienteDoc.exists) throw "Cliente não encontrado.";
        if (clienteDoc.data().saldo < valor) throw "Saldo do cliente insuficiente.";
        if (barbeiroDoc.data().vagaImediata === false) throw "Vaga imediata não está mais ativa.";

        t.update(clienteRef, { saldo: firebase.firestore.FieldValue.increment(-valor) });
        t.update(barbeiroRef, { saldo: firebase.firestore.FieldValue.increment(valorComTaxa), vagaImediata: false });
        
        t.update(agendamentoRef, { 
            status: "conclusão pendente", 
            confirmadoEm: firebase.firestore.FieldValue.serverTimestamp(), 
            lembreteConcluirEnviado: false,
            clienteNotificado: false // Garante popup do cliente
        });
        
        const adminSnap = await db.collection("usuarios").where("tipo", "==", "admin").limit(1).get();
        if(!adminSnap.empty) t.update(db.collection("usuarios").doc(adminSnap.docs[0].id), { saldo: firebase.firestore.FieldValue.increment(valorAdmin) });
        t.set(db.collection("config").doc("financeiro"), { arrecadadoTaxas: firebase.firestore.FieldValue.increment(valorAdmin) }, { merge: true });

        // RETORNA O TELEFONE
        return agendamentoDoc.data().clienteTelefone;

    }).then((clienteTelefone) => {
        
        // --- NOVO: DIRECIONAMENTO PARA O WHATSAPP ---
        if (clienteTelefone) {
            const phoneNum = clienteTelefone.replace(/\D/g, '');
            // Mensagem adaptada para Vaga Imediata
            const msg = encodeURIComponent(`Olá, passando aqui pra confirmar que aprovei seu agendamento de Vaga Imediata comigo no aplicativo Nova Versão, fico no seu aguardo :)`);
            window.open(`https://wa.me/55${phoneNum}?text=${msg}`, '_blank');
        }
        // --------------------------------------------

        // Avisos para o cliente (mantidos do código original)
        criarAviso(clienteUid, `✅ Sua vaga imediata foi aprovada por ${perfil.nome}!`, 'vaga-aprovada', agendamentoId);
        notifyUser(clienteUid, "✅ Agendamento Confirmado!", `Sua vaga imediata com ${perfil.nome} foi aprovada. Corra para o local!`);
        
        fecharTodosOsModais();
        exibirPopup("Agendamento aprovado! Redirecionando para o WhatsApp...");
        
        setTimeout(() => location.reload(), 4000);

    }).catch(e => {
        fecharTodosOsModais();
        exibirPopup("Erro ao aprovar: " + e);
        setTimeout(() => location.reload(), 4000);
    });
}

async function aprovarAgendamento(agendamentoId, clienteUid, valor, horario = null) {
  // Confirmação visual já foi feita no popup anterior, mas mantemos a verificação de segurança
  exibirAguarde("Aprovando...");
  
  // Lógica de cálculo de taxa dinâmica
  let taxaAplicada = TAXA;
  if (isProAtivo(perfil) && perfil.proTier && PRECOS_PRO[perfil.proTier]) {
      taxaAplicada = PRECOS_PRO[perfil.proTier].taxa;
  }
  const valorComTaxa = valor * (1 - taxaAplicada);
  const valorAdmin = valor * taxaAplicada;

  db.runTransaction(async t => {
      const agendamentoRef = db.collection("agendamentos").doc(agendamentoId);
      const clienteRef = db.collection("usuarios").doc(clienteUid);
      const barbeiroRef = db.collection("usuarios").doc(auth.currentUser.uid);
      
      const [agendamentoDoc, clienteDoc, barbeiroDoc] = await Promise.all([t.get(agendamentoRef), t.get(clienteRef), t.get(barbeiroRef)]);
      
      if (agendamentoDoc.data().status !== 'pendente') throw "Solicitação já processada.";
      if (!clienteDoc.exists) throw "Cliente não encontrado.";
      if (clienteDoc.data().saldo < valor) throw "Saldo do cliente insuficiente.";

      // 1. Movimentação Financeira
      t.update(clienteRef, { saldo: firebase.firestore.FieldValue.increment(-valor) });
      t.update(barbeiroRef, { saldo: firebase.firestore.FieldValue.increment(valorComTaxa) });
      
      // 2. Atualiza Status do Agendamento
      t.update(agendamentoRef, { 
          status: "conclusão pendente", 
          confirmadoEm: firebase.firestore.FieldValue.serverTimestamp(), 
          lembreteConcluirEnviado: false,
          clienteNotificado: false // Garante o popup do cliente
      });

      // 3. Remove horário da agenda se necessário
      if (barbeiroDoc.data().usaAgendaManual && horario) {
          const agendaAtual = barbeiroDoc.data().agenda || {};
          if (agendaAtual[horario]) { 
              delete agendaAtual[horario]; 
              t.update(barbeiroRef, { agenda: agendaAtual }); 
          }
      }
      
      // 4. Taxa do Admin
      const adminSnap = await db.collection("usuarios").where("tipo", "==", "admin").limit(1).get();
      if(!adminSnap.empty) t.update(db.collection("usuarios").doc(adminSnap.docs[0].id), { saldo: firebase.firestore.FieldValue.increment(valorAdmin) });
      t.set(db.collection("config").doc("financeiro"), { arrecadadoTaxas: firebase.firestore.FieldValue.increment(valorAdmin) }, { merge: true });

      // RETORNA O TELEFONE PARA USAR NO .THEN
      return agendamentoDoc.data().clienteTelefone;

  }).then((clienteTelefone) => {
      
      // --- NOVO: DIRECIONAMENTO PARA O WHATSAPP ---
      if (clienteTelefone) {
          const phoneNum = clienteTelefone.replace(/\D/g, '');
          // Mensagem pré-definida
          const msg = encodeURIComponent(`Olá, passando aqui pra confirmar que aprovei seu agendamento comigo no aplicativo Nova Versão, fico no seu aguardo no horario ${horario} :D`);
          // Abre em nova aba
          window.open(`https://wa.me/55${phoneNum}?text=${msg}`, '_blank');
      }
      // --------------------------------------------

      fecharTodosOsModais();
      exibirPopup("Sucesso!", "Agendamento aprovado! Você foi redirecionado para o WhatsApp do cliente.");
      
      // Recarrega a página após 4 segundos para atualizar tudo
      setTimeout(() => location.reload(), 4000); 

  }).catch(e => {
      fecharTodosOsModais();
      exibirPopup("Erro ao aprovar: " + e);
      setTimeout(() => location.reload(), 4000); 
  });
}

function recusarAgendamento(agendamentoId, clienteUid) {
  if (!confirm("Recusar este agendamento?")) return;
  db.runTransaction(async t => {
      const agendamentoRef = db.collection("agendamentos").doc(agendamentoId);
      const agendamentoDoc = await t.get(agendamentoRef);
      const status = agendamentoDoc.data().status;
      if (status !== 'pendente' && status !== 'imediato') throw "Solicitação já processada.";
      t.update(agendamentoRef, { status: "cancelado" });
  }).then(() => {
      setTimeout(() => location.reload(), 4000); // 4 segundos

      
      notifyUser(clienteUid, "❌ Agendamento Recusado", `O profissional ${perfil.nome} não pôde aceitar seu pedido.`);
      exibirPopup("Agendamento recusado.");
  }).catch(e => exibirPopup("Erro ao recusar: " + e));
}

async function cancelarAgendamentoManualmente(agendamentoId, clienteUid, valor) {
  if (!confirm("Cancelar este agendamento? O dinheiro será reembolsado e sua reputação será afetada.")) return;
  exibirAguarde("Cancelando...");
  const valorComTaxa = valor * (1 - TAXA), valorAdmin = valor * TAXA;
  db.runTransaction(async t => {
      const agendamentoRef = db.collection("agendamentos").doc(agendamentoId);
      const agendamentoDoc = await t.get(agendamentoRef);
      const status = agendamentoDoc.data().status;
      if (status !== 'confirmado' && status !== 'conclusão pendente') throw "Apenas agendamentos aprovados podem ser cancelados.";
      
      const clienteRef = db.collection("usuarios").doc(clienteUid);
      const barbeiroRef = db.collection("usuarios").doc(auth.currentUser.uid);
      t.update(clienteRef, { saldo: firebase.firestore.FieldValue.increment(valor) });
      t.update(barbeiroRef, { saldo: firebase.firestore.FieldValue.increment(-valorComTaxa), reputacao: firebase.firestore.FieldValue.increment(-10) });
      t.update(agendamentoRef, { status: "cancelado" });

      const adminSnap = await db.collection("usuarios").where("tipo", "==", "admin").limit(1).get();
      if (!adminSnap.empty) t.update(db.collection("usuarios").doc(adminSnap.docs[0].id), { saldo: firebase.firestore.FieldValue.increment(-valorAdmin) });
      t.set(db.collection("config").doc("financeiro"), { arrecadadoTaxas: firebase.firestore.FieldValue.increment(-valorAdmin) }, { merge: true });
  }).then(() => {
      setTimeout(() => location.reload(), 4000); // 4 segundos

      criarAviso(clienteUid, `❌ O profissional ${perfil.nome} cancelou seu agendamento. O valor de R$ ${valor.toFixed(2)} foi reembolsado.`);
      notifyUser(clienteUid, "🔄 Agendamento Cancelado", `${perfil.nome} cancelou seu horário. O valor de R$ ${valor.toFixed(2)} foi estornado.`);
      exibirPopup("Agendamento cancelado e valor reembolsado. Sua reputação diminuiu.");
  }).catch(e => {
      setTimeout(() => location.reload(), 4000); // 4 segundos

      exibirPopup("Erro ao cancelar: " + e);
  });
}

async function concluirAgendamento(agendamentoId, clienteUid) {
  exibirAguarde("Concluindo...");
  
  try {
    const agendamentoRef = db.collection("agendamentos").doc(agendamentoId);
    const barbeiroRef = db.collection("usuarios").doc(auth.currentUser.uid);
    const clienteRef = db.collection("usuarios").doc(clienteUid);

    const clienteTelefone = await db.runTransaction(async t => {
        const agendamentoDoc = await t.get(agendamentoRef);
        const agData = agendamentoDoc.data();

        if (agData.status !== "conclusão pendente") throw "Este agendamento não pode ser concluído.";

        const valorLiquido = agData.valor * (1 - TAXA); // Desconta os 20%

        // 1. Atualiza contadores e SALDO GERAL do barbeiro
        // (O saldo sobe na hora, mas o modal da carteira calcula o bloqueio visualmente)
        t.update(barbeiroRef, { 
            saldo: firebase.firestore.FieldValue.increment(valorLiquido), 
            cortesSemana: firebase.firestore.FieldValue.increment(1), 
            clientesAtendidos: firebase.firestore.FieldValue.increment(1) 
        });
        
        // 2. Marca agendamento como concluído
        t.update(agendamentoRef, { 
            status: "concluido", 
            avisoAvaliacaoEnviado: false
        });

        // 3. [CRUCIAL] Cria registro financeiro para a regra de 20 dias
        const registroRef = db.collection("extrato_financeiro").doc();
        t.set(registroRef, {
            usuarioUid: auth.currentUser.uid,
            tipo: "entrada_servico",
            valorBruto: agData.valor,
            valorLiquido: valorLiquido,
            dataEvento: firebase.firestore.FieldValue.serverTimestamp(),
            origem: `Serviço: ${agData.servico}`,
            agendamentoId: agendamentoId
        });
        
        // 4. Atualiza contador do cliente
        t.update(clienteRef, { 
            cortesRealizados: firebase.firestore.FieldValue.increment(1) 
        });

        return agData.clienteTelefone;
    });

    // Verifica conquistas e avisa no WhatsApp
    await verificarConquistas(clienteUid);
    await verificarConquistasBarbeiro(auth.currentUser.uid);

    if (clienteTelefone) {
        const phoneNum = clienteTelefone.replace(/\D/g, '');
        const msg = encodeURIComponent("Acabei de concluir o agendamento no aplicativo, você pode ir em historico e deixar sua avaliação! :D");
        window.open(`https://wa.me/55${phoneNum}?text=${msg}`, '_blank');
    }

    fecharTodosOsModais();
    exibirPopup("Sucesso", "Serviço concluído! O valor estará disponível para saque em 20 dias.");
    
    notifyUser(clienteUid, "⭐ Avalie sua Experiência!", `O serviço com ${perfil.nome} foi concluído.`, { link: '#historico' });
    
    setTimeout(() => location.reload(), 4000);

  } catch(e) {
    fecharTodosOsModais();
    exibirPopup("Erro ao concluir serviço: " + e);
    setTimeout(() => location.reload(), 4000); 
  }
}

// ATUALIZE ESTA FUNÇÃO EM INDEX.HTML
async function abrirClientesBarbeiro() {
  abrirModal('modalClientesBarbeiro');
  const lista = document.getElementById("listaClientesBarbeiro");
  lista.innerHTML = "<p>⏳ Carregando...</p>";
  
  const agendamentosSnap = await db.collection("agendamentos")
    .where("barbeiroUid", "==", auth.currentUser.uid)
    .where("status", "==", "concluido")
    .get();

  const clientesMap = {};
  agendamentosSnap.forEach(doc => {
    const ag = doc.data();
    if (!clientesMap[ag.clienteUid]) {
      clientesMap[ag.clienteUid] = { 
          nome: ag.clienteNome, 
          totalCortes: 0, 
          telefone: ag.clienteTelefone,
          uid: ag.clienteUid // Adiciona o UID para salvar a nota
      };
    }
    clientesMap[ag.clienteUid].totalCortes++;
  });

  // Carrega as notas salvas
  const notasSnap = await db.collection("profissionais_notas_clientes").doc(auth.currentUser.uid).get();
  const notasData = notasSnap.exists ? notasSnap.data().notas : {};

  lista.innerHTML = Object.keys(clientesMap).length === 0 ? "<p>Você ainda não tem clientes.</p>" : "";
  
  Object.values(clientesMap).sort((a, b) => b.totalCortes - a.totalCortes).forEach(c => {
    const notaAtual = notasData[c.uid] || "";
    const whatsappLink = c.telefone ? `<a href="https://wa.me/55${c.telefone.replace(/\D/g,'')}" target="_blank" onclick="event.stopPropagation()"><button style="font-size:12px; padding: 5px 8px; margin-top:5px;">💬 WhatsApp</button></a>` : '';
    
    lista.innerHTML += `
        <div class="card">
            <b>${c.nome}</b>
            <p>Serviços concluídos: ${c.totalCortes}</p>
            ${whatsappLink}
            <textarea id="nota_${c.uid}" placeholder="Adicione notas sobre este cliente..." style="margin-top: 10px; width: 100%; min-height: 50px;">${notaAtual}</textarea>
            <button onclick="salvarNotaCliente('${c.uid}')" style="font-size:12px; padding: 5px 8px; margin-top:5px;">Salvar Nota</button>
        </div>`;
  });
}

// ADICIONE ESTA NOVA FUNÇÃO EM INDEX.HTML
async function salvarNotaCliente(clienteUid) {
    const nota = document.getElementById(`nota_${clienteUid}`).value;
    const ref = db.collection("profissionais_notas_clientes").doc(auth.currentUser.uid);
    try {
        await ref.set({
            notas: {
                [clienteUid]: nota
            }
        }, { merge: true });
        exibirPopup("Nota salva com sucesso!");
    } catch (e) {
        console.error("Erro ao salvar nota:", e);
        exibirPopup("Não foi possível salvar a nota.");
    }
}

function abrirHistoricoBarbeiro() {
  abrirModal('modalHistoricoBarbeiro');
  const painel = document.getElementById("painelHistoricoBarbeiro");
  painel.innerHTML = "<p>⏳ Carregando...</p>";
  db.collection("agendamentos").where("barbeiroUid", "==", auth.currentUser.uid)
    .where("status", "in", ["concluido", "cancelado"]).orderBy("ts", "desc").limit(20)
    .onSnapshot(snap => {
      if (snap.empty) {
          painel.innerHTML = "<p>Nenhum serviço no histórico encontrado.</p>";
          return;
      }
      painel.innerHTML = "";
      snap.forEach(doc => {
        const a = doc.data();
        const dataFormatada = a.ts ? new Date(a.ts.seconds * 1000).toLocaleDateString('pt-BR') : 'Data indisponível';
        const statusIcon = a.status === "concluido" ? "✅" : "❌";
        const statusTexto = a.status === "concluido" ? "Concluído" : "Cancelado";
        painel.innerHTML += `<div class="card" style="margin-bottom: 10px;">
          <p><strong>${statusIcon} Cliente:</strong> ${a.clienteNome}</p>
          <p><strong>✂️ Serviço:</strong> ${a.servico} - R$ ${a.valor.toFixed(2)}</p>
          <p><strong>🗓️ Data:</strong> ${dataFormatada}</p>
          <p><strong>Status:</strong> ${statusTexto}</p>
        </div>`;
      });
    });
}

function criarPromocao() {
  const nome = document.getElementById("promocaoNome").value;
  const descricao = document.getElementById("promocaoDescricao").value;
  const desconto = parseInt(document.getElementById("promocaoDesconto").value);
  if (!nome || !descricao || isNaN(desconto) || desconto <= 0 || desconto > 100) return exibirPopup("Preencha os campos corretamente.");
  db.collection("usuarios").doc(auth.currentUser.uid).update({
    promocoes: firebase.firestore.FieldValue.arrayUnion({ nome, descricao, desconto })
  }).then(() => {
    exibirPopup("Promoção criada!");
    fecharModalAtual();
  }).catch(e => exibirPopup("Erro: " + e.message));
}

function removerPromocao(index) {
  const p = perfil.promocoes[index];
  if (!confirm(`Remover a promoção "${p.nome}"?`)) return;
  db.collection("usuarios").doc(auth.currentUser.uid).update({
    promocoes: firebase.firestore.FieldValue.arrayRemove(p)
  }).then(() => exibirPopup("Promoção removida!")).catch(e => exibirPopup("Erro: " + e.message));
}

function carregarPromocoesAtivas() {
    const container = document.getElementById('listaPromocoes');
    container.innerHTML = '';
    if (perfil.promocoes && perfil.promocoes.length > 0) {
        perfil.promocoes.forEach((promo, index) => {
            const validadeStr = promo.validade ? `Válida até: ${new Date(promo.validade.seconds * 1000).toLocaleDateString('pt-BR')}` : 'Sem data de expiração';
            container.innerHTML += `
                <div class="card">
                    <b>${promo.nome} (${promo.desconto}%)</b>
                    <p style="font-size:14px;">${promo.descricao}</p>
                    <p style="font-size:12px; opacity: 0.7;">${validadeStr}</p>
                    <button onclick="removerPromocao(${index})" style="background:#c0392b; float:right;">🗑️</button>
                </div>`;
        });
    } else {
        container.innerHTML = '<p>Nenhuma promoção ativa no momento.</p>';
    }
}

// Substitua a função abrirPromocoes inteira por esta
function abrirPromocoes() {
    abrirModal('modalPromocoesBarbeiro');
    carregarPromocoesAtivas();
}

// SUBSTITUA a função abrirModalAddPromocao por esta:
function abrirModalAddPromocao() {
    const selectServicos = document.getElementById('addPromocaoServicos');
    selectServicos.innerHTML = ''; // Limpa opções antigas

    if (perfil.listaServicos && perfil.listaServicos.length > 0) {
        perfil.listaServicos.forEach(servico => {
            const option = document.createElement('option');
            option.value = servico.nome; // Usaremos o nome como identificador
            option.textContent = `${servico.nome} - R$ ${servico.valor.toFixed(2)}`;
            selectServicos.appendChild(option);
        });
    } else {
        selectServicos.innerHTML = '<option disabled>Você não tem serviços cadastrados</option>';
    }

    // Limpa os campos do formulário
    document.getElementById('addPromocaoNome').value = '';
    document.getElementById('addPromocaoDescricao').value = '';
    document.getElementById('addPromocaoDesconto').value = '';
    document.getElementById('addPromocaoValidade').value = '';
    document.getElementById('addPromocaoValorMinimo').value = '';

    abrirModal('modalAddPromocao');
}

// SUBSTITUA a função salvarNovaPromocao por esta:
async function salvarNovaPromocao() {
    // ... (código original de validação e salvar no DB) ...
    const nome = document.getElementById('addPromocaoNome').value.trim();
    const descricao = document.getElementById('addPromocaoDescricao').value.trim();
    const desconto = parseInt(document.getElementById('addPromocaoDesconto').value);
    const validadeInput = document.getElementById('addPromocaoValidade').value;
    const valorMinimo = parseFloat(document.getElementById('addPromocaoValorMinimo').value) || 0;
    const servicosSelecionados = Array.from(document.getElementById('addPromocaoServicos').selectedOptions).map(option => option.value);

    if (!nome || !descricao || isNaN(desconto) || desconto <= 0 || desconto > 100) { return exibirPopup("Preencha nome, descrição e um desconto válido."); }
    if (servicosSelecionados.length === 0) { return exibirPopup("Selecione pelo menos um serviço para aplicar a promoção."); }

    const novaPromocao = { id: `promo_${new Date().getTime()}`, nome, descricao, desconto, servicosAplicaveis: servicosSelecionados, valorMinimo: valorMinimo, validade: validadeInput ? new Date(validadeInput + 'T23:59:59') : null };

    try {
        await db.collection("usuarios").doc(auth.currentUser.uid).update({ promocoes: firebase.firestore.FieldValue.arrayUnion(novaPromocao) });
        exibirPopup("Promoção salva com sucesso!");
        fecharModalAtual();

        // --- ADIÇÃO PARA FLUXO PÓS-CADASTRO ---
        // ... (código de sucesso)
fecharModalAtual(); // Fecha o modal de adicionar promoção

if (fluxoPosCadastroAtivo) {
    finalizarFluxoPosCadastro(); // Finaliza o fluxo aqui
} else {
    // Comportamento normal: Atualiza a lista se o modal de promoções estiver aberto
    const promocoesDoc = await db.collection("usuarios").doc(auth.currentUser.uid).get();
    if (promocoesDoc.exists) { // Verifica se o documento existe
       perfil.promocoes = promocoesDoc.data().promocoes;
       if (document.getElementById('modalPromocoesBarbeiro').classList.contains('show')) {
           carregarPromocoesAtivas();
       }
    }
}
        // --- FIM DA ADIÇÃO ---

    } catch (e) { /* ... (bloco catch original) ... */
        exibirPopup("Erro ao salvar promoção: " + e.message);
    }
}

function abrirAvaliacoesBarbeiro() {
  abrirModal('modalAvaliacoes');
  const lista = document.getElementById("listaAvaliacoesModal");
  lista.innerHTML = "<p>⏳ Carregando...</p>";
  db.collection("avaliacoes").where("barbeiroUid", "==", auth.currentUser.uid)
    .orderBy("ts", "desc").onSnapshot(async snap => {
      lista.innerHTML = snap.empty ? "<p>Nenhuma avaliação recebida.</p>" : "";
      for (const doc of snap.docs) {
        const a = doc.data();
        let clienteNome = "Anônimo";
        if (a.clienteUid) {
          const clienteDoc = await db.collection("usuarios").doc(a.clienteUid).get();
          if (clienteDoc.exists) clienteNome = clienteDoc.data().nome;
        }
        lista.innerHTML += `<div class="card" style="margin-bottom:15px;"><p style="margin-bottom:5px;"><b>De:</b> ${clienteNome}</p><b>Nota: ${a.nota}/10</b> (${'⭐'.repeat(Math.round(a.nota / 2))})<br><p style="margin-top:5px;"><b>Comentário:</b> "${a.comentario}"</p></div>`;
      }
    });
}

// ======================================================================
// --- NOVAS FUNÇÕES DE PAGAMENTO (APRIMORADO) ---
// ======================================================================

// SUBSTITUA a função 'iniciarDeposito' inteira (Linha ~4661) por esta:

function iniciarDeposito() {
    if (isTwa) {
        // Ambiente TWA (Play Store): Abre o modal de depósito do Google Play
        abrirModal('modalDepositoPlayStore');
    } else {
        // Ambiente Web (Navegador): Abre o formulário de depósito (PIX/Cartão)
        abrirModal('modalDepositoFormulario');
        const inputs = ['depositoPrimeiroNome', 'depositoSegundoNome', 'depositoCpf', 'depositoTelefone'];
        const btn = document.getElementById('btnContinuarDeposito');
        inputs.forEach(id => {
            document.getElementById(id).oninput = () => {
                const allFilled = inputs.every(i => document.getElementById(i).value.trim() !== '');
                btn.disabled = !allFilled;
            };
        });
    }
}

async function criarSolicitacaoDeposito() {
    const primeiroNome = document.getElementById('depositoPrimeiroNome').value.trim();
    const segundoNome = document.getElementById('depositoSegundoNome').value.trim();
    const cpf = document.getElementById('depositoCpf').value.trim();
    const telefone = document.getElementById('depositoTelefone').value.trim();
    const valor = parseFloat(document.getElementById('depositoValor').value);

    if (!primeiroNome || !segundoNome || !cpf || !telefone || isNaN(valor) || valor <= 0) {
        return exibirPopup("Por favor, preencha todos os campos corretamente, incluindo um valor válido.");
    }

    const nomeCompleto = `${primeiroNome} ${segundoNome}`;

    try {
        await db.collection("solicitacoes").add({
            tipo: "deposito",
            usuarioUid: auth.currentUser.uid,
            usuarioNome: perfil.nome,
            dadosDeposito: {
                nomeCompleto,
                cpf,
                telefone
            },
            valor: valor,
            status: "pendente",
            ts: firebase.firestore.FieldValue.serverTimestamp()
        });

        fecharTodosOsModais();      
        notifyAdmins("📥 Novo Pedido de Depósito!", `${perfil.nome} solicitou um depósito de R$${valor.toFixed(2)}.`, { link: '#solicitacoes' });

    } catch (error) {
        console.error("Erro ao criar solicitação de depósito:", error);
        exibirPopup("Ocorreu um erro ao enviar sua solicitação. Tente novamente.");
    }
    abrirModal('modalDeposito');
}

function iniciarSaque() {
  abrirModal('modalSaque');
}

function processarPagamentoPixAprimorado() {
    exibirAguarde('Só um minuto...', 'Estamos preparando seu pagamento PIX.');
    setTimeout(() => {
        fecharTodosOsModais();
        abrirModal('modalExibirPixAprimorado');
        iniciarTimerPix(600); // 10 minutos
    }, 2000); 
}

function abrirModalTaxaCartao() {
    abrirModal('modalTaxaCartao');
}

function processarPagamentoCartaoAprimorado() {
    notifyAdmins("🟢 Tentativa de Cartão!", `${perfil.nome} está tentando pagar com cartão de crédito.`);
    exibirAguarde('Redirecionando...', 'Você está indo para uma plataforma segura de pagamento.');
    setTimeout(() => {
        window.open('https://pay.kiwify.com.br/T3M9m1C', '_blank');
        fecharTodosOsModais();
    }, 2500);
}

function iniciarTimerPix(duracao) {
    if (pixTimerInterval) clearInterval(pixTimerInterval);
    let timer = duracao;
    const display = document.getElementById('pixTimer');
    pixTimerInterval = setInterval(() => {
        const minutos = parseInt(timer / 60, 10);
        const segundos = parseInt(timer % 60, 10);
        display.textContent = `${minutos < 10 ? "0" + minutos : minutos}:${segundos < 10 ? "0" + segundos : segundos}`;
        if (--timer < 0) {
            clearInterval(pixTimerInterval);
            display.textContent = "EXPIRADO";
            abrirModal('modalPixExpirado');
        }
    }, 1000);
}

function tentarGerarPixNovamente() {
    fecharTodosOsModais();
    setTimeout(() => {
        processarPagamentoPixAprimorado();
    }, 300);
}

function copiarCodigoPixAprimorado(event) {
    const textoParaCopiar = document.getElementById('pixChaveAleatoria').value;
    navigator.clipboard.writeText(textoParaCopiar).then(() => {
        const botao = event.target;
        botao.textContent = '✅ Copiado!';
        notifyAdmins("🟢 Chave PIX Copiada!", `O usuário ${perfil.nome} copiou a chave PIX. Provável depósito a caminho.`);
        setTimeout(() => {
            botao.textContent = 'Copiar Chave Aleatória PIX';
        }, 2000);
    }).catch(err => {
        console.error('Falha ao copiar: ', err);
        exibirPopup('Não foi possível copiar o código. Por favor, selecione e copie manualmente.');
    });
}

function confirmarEnvioComprovante() {
    const mensagem = encodeURIComponent("Olá! Segue o comprovante do meu depósito no app Nova Versão.");
    window.open(`https://wa.me/${WHATSAPP_ADM_PHONE}?text=${mensagem}`, '_blank');
    fecharTodosOsModais();
}

function confirmarSaque() {
    const valor = parseFloat(document.getElementById('saqueValor').value);
    const chaveTipo = document.getElementById('saqueChavePixTipo').value;
    const chave = document.getElementById('saqueChavePix').value.trim();

    if (isNaN(valor) || valor <= 0) return exibirPopup("Valor de saque inválido.");
    if (!chaveTipo) return exibirPopup("Selecione o tipo da chave PIX.");
    if (!chave) return exibirPopup("Insira sua chave PIX.");
    if (perfil.saldo < valor) return exibirPopup("Saldo insuficiente.");

    db.collection("solicitacoes").add({
        tipo: "saque",
        usuarioUid: auth.currentUser.uid,
        usuarioNome: perfil.nome,
        valor,
        chavePixTipo: chaveTipo,
        chavePix: chave,
        status: "pendente",
        ts: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
        abrirModal('modalSaqueConfirmado');
        notifyAdmins("📤 Novo Pedido de Saque!", `${perfil.nome} solicitou um saque de R$${valor.toFixed(2)}.`, { link: '#solicitacoes' });
    }).catch(e => exibirPopup("Erro ao criar solicitação: " + e.message));
}

function contatarAdminSaque() {
    const valor = document.getElementById('saqueValor').value;
    const mensagem = encodeURIComponent(`Olá! Acabei de solicitar um saque no valor de R$${valor} e gostaria de confirmar o recebimento.`);
    window.open(`https://wa.me/${WHATSAPP_ADM_PHONE}?text=${mensagem}`, '_blank');
    fecharTodosOsModais();
}

// ======================================================================
// --- FIM DAS FUNÇÕES DE PAGAMENTO ---
// ======================================================================

function pedirConfirmacaoFecharPopup(modalId, titulo = '🤔 Tem certeza?', mensagem = 'Você pode completar esta etapa mais tarde pelas configurações.') {
    modalOriginalIdParaConfirmar = modalId; // Guarda qual modal pediu
    document.getElementById('confirmarFecharTitulo').textContent = titulo;
    document.getElementById('confirmarFecharMensagem').textContent = mensagem;
    abrirModal('modalConfirmarFecharPopup');
}

function confirmarFechamentoPopup() {
    fecharModalAtual(); // Fecha o modal de confirmação
    if (modalOriginalIdParaConfirmar) {
        // Encontra o modal original na pilha e o remove também
        const modalOriginal = document.getElementById(modalOriginalIdParaConfirmar);
        if (modalOriginal && modalOriginal.classList.contains('show')) {
            const indexNaPilha = modalStack.indexOf(modalOriginal);
            if (indexNaPilha > -1) {
                modalStack.splice(indexNaPilha, 1);
            }
            modalOriginal.classList.remove('show');
            setTimeout(() => { modalOriginal.style.display = 'none'; }, 300);
        }

        // --- LÓGICA DE AVANÇO NO FLUXO PÓS-CADASTRO ---
        if (fluxoPosCadastroAtivo) {
            if (modalOriginalIdParaConfirmar === 'modalLogomarca') {
                abrirModalComConfirmacao('modalPortfolioBarbeiro', '🖼️ Adicionar ao Portfólio'); // Próximo: Portfólio
            } else if (modalOriginalIdParaConfirmar === 'modalPortfolioBarbeiro') {
                abrirModalComConfirmacao('modalAddPromocao', '🎁 Adicionar Promoção (Opcional)'); // Próximo: Promoção (Opcional)
            } else if (modalOriginalIdParaConfirmar === 'modalAddPromocao') {
                finalizarFluxoPosCadastro(); // Finaliza o fluxo se pular a promoção
            }
        }
        // --- FIM DA LÓGICA DE AVANÇO ---

        modalOriginalIdParaConfirmar = null; // Limpa a referência
    }
 }

function cancelarFechamentoPopup() {
    fecharModalAtual(); // Fecha apenas o modal de confirmação
    // Não faz nada com o modal original, ele continua aberto
    modalOriginalIdParaConfirmar = null; // Limpa a referência
}

async function confirmarSolicitacaoAcessoLoja() {
    // Verifica se já existe uma solicitação pendente para evitar duplicação
    try {
        const q = db.collection("solicitacoes")
            .where("usuarioUid", "==", auth.currentUser.uid)
            .where("tipo", "==", "liberacao_loja")
            .where("status", "==", "pendente");
        const existingRequests = await q.get();
        if (!existingRequests.empty) {
            fecharModalAtual(); // Fecha o modal de solicitação
            return exibirPopup("Atenção", "Você já possui uma solicitação de acesso à loja pendente. Aguarde a análise do administrador.");
        }
    } catch (error) {
        console.error("Erro ao verificar solicitações existentes:", error);
        // Continua mesmo se a verificação falhar, mas loga o erro
    }

    exibirAguarde("Enviando solicitação...");

    try {
        // Cria a solicitação no Firestore
        await db.collection("solicitacoes").add({
            tipo: "liberacao_loja",
            usuarioUid: auth.currentUser.uid,
            usuarioNome: perfil.nome, // Pega o nome do perfil carregado
            status: "pendente",
            ts: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Prepara e abre o link do WhatsApp
        const mensagem = encodeURIComponent(`Olá! Gostaria de solicitar autorização para cadastrar produtos na loja do app Nova Versão.\n\nMeu nome de usuário é: ${perfil.nome}\nMeu email: ${perfil.email}`);
        const phoneNum = WHATSAPP_ADM_PHONE.startsWith('55') ? WHATSAPP_ADM_PHONE : `55${WHATSAPP_ADM_PHONE.replace(/\D/g, '')}`;
        window.open(`https://wa.me/${phoneNum}?text=${mensagem}`, '_blank');

        fecharTodosOsModais(); // Fecha o "Aguarde" e o modal de solicitação
        exibirPopup("✅ Solicitação Enviada!", "Seu pedido foi enviado para análise. Você foi redirecionado(a) ao WhatsApp para contato.");

        // Notifica os administradores
        notifyAdmins("🛍️ Nova Solicitação de Loja", `${perfil.nome} (${perfil.email}) solicitou acesso para vender na loja.`, { link: '#solicitacoes' });

    } catch (error) {
        fecharTodosOsModais();
        console.error("Erro ao confirmar solicitação de acesso à loja:", error);
        exibirPopup("Erro", "Não foi possível enviar sua solicitação: " + error.message);
    }
 }

async function publicarBlog() {
  const titulo = document.getElementById("blogTitulo").value.trim();
  const conteudo = document.getElementById("blogConteudo").value.trim();
  if (!titulo || !conteudo) return exibirPopup("Preencha todos os campos.");
  await db.collection("blog").add({
    titulo, conteudo, autor: perfil.nome, autorUid: auth.currentUser.uid,
    ts: firebase.firestore.FieldValue.serverTimestamp()
  });
  exibirPopup("Postagem publicada!");
  fecharModalAtual();
}

function carregarListaBlog() {
  const lista = document.getElementById("listaBlog");
  lista.innerHTML = "<p>⏳ Carregando...</p>";
  db.collection("blog").orderBy("ts", "desc").onSnapshot(snap => {
    lista.innerHTML = "";
    const trintaHorasAtras = new Date().getTime() - (30 * 60 * 60 * 1000); // 30 horas
    let postsExibidos = 0;
    snap.forEach(doc => {
      const p = doc.data();
      if (p.ts && p.ts.toDate().getTime() > trintaHorasAtras) {
        lista.innerHTML += `<div class="card" style="margin-bottom:15px;"><h4>${p.titulo}</h4><p>${p.conteudo}</p><p style="font-size:12px;opacity:0.7;">Por: ${p.autor}</p></div>`;
        postsExibidos++;
      }
    });
    if (postsExibidos === 0) {
        lista.innerHTML = "<p>Nenhum post recente (últimas 30h).</p>";
    }
  });
}

document.getElementById('onlineUserCount').onclick = () => abrirModalUsuariosOnline();

function carregarAdmin() {
    if (adminBalanceListener) adminBalanceListener(); 
    db.collection("usuarios").get().then(snapshot => {
        adminUserBalances = {};
        snapshot.forEach(doc => { adminUserBalances[doc.id] = doc.data().saldo || 0; });
        adminBalanceListener = db.collection("usuarios").onSnapshot(snap => {
            snap.docChanges().forEach(change => {
                if (change.type === "modified") {
                    const novo = change.doc.data();
                    const id = change.doc.id;
                    const antigoSaldo = adminUserBalances[id] || 0;
                    const novoSaldo = novo.saldo || 0;
                    if (Math.floor(novoSaldo / 100) > Math.floor(antigoSaldo / 100)) {
                        exibirPopup(`⚠️ Alerta de Saldo! ${novo.nome} ultrapassou R$${Math.floor(novoSaldo / 100) * 100}.`);
                    }
                    adminUserBalances[id] = novoSaldo;
                }
            });
        });
    });

    // Listener para solicitações pendentes
    db.collection("solicitacoes").where("status", "==", "pendente").onSnapshot(snap => {
        const btn = document.getElementById('btnAdminSolicitacoes');
        if (btn) btn.classList.toggle('notificacao-pulsante', !snap.empty);
    });

    // Listener para denúncias abertas
    db.collection("denuncias").where("status", "==", "aberta").onSnapshot(snap => {
        const btn = document.getElementById('btnAdminDenuncias');
        if (btn) btn.classList.toggle('notificacao-pulsante', !snap.empty);
    });

    // Listener para usuários online (somente admin)
    const countElement = document.getElementById('onlineUserCount');
    if (onlineUsersListener) onlineUsersListener(); // Cancela listener anterior

    const thresholdDate = new Date(Date.now() - USER_ACTIVE_THRESHOLD_MS); // Data limite (ex: 5 min atrás)

    onlineUsersListener = db.collection('usuarios')
        .where('lastSeen', '>', thresholdDate)
        .onSnapshot(snap => {
            const count = snap.size;
            if (countElement) {
                // Atualiza o texto do botão
                countElement.textContent = `🏆 ${count} Online`; // <-- MUDANÇA AQUI
                countElement.classList.toggle('hidden', !(perfil && perfil.tipo === 'admin' && userView.currentType === 'admin'));
            }

            // ATUALIZA A LISTA DO MODAL EM TEMPO REAL
            const lista = document.getElementById('listaUsuariosOnline');
            if (lista) {
                lista.innerHTML = ""; // Limpa a lista
                if (snap.empty) {
                    lista.innerHTML = "<p>Nenhum usuário online no momento.</p>";
                    return;
                }
                snap.forEach(doc => {
                    const u = doc.data();
                    // Adiciona o item clicável
                    // Alterado para chamar adminAbrirInfoChat passando o ID do documento (doc.id)
lista.innerHTML += `<div class="selectable-item" onclick="adminAbrirInfoChat('${doc.id}')" title="Ver opções para ${u.nome}">${u.nome}</div>`;
                });
            }

        }, err => {
            console.error("Erro ao ouvir usuários online:", err);
            if (countElement) countElement.classList.add('hidden');
        });
}

function abrirModalUsuariosOnline() {
    abrirModal('modalUsuariosOnline');
    // A lista é populada em tempo real pelo listener em carregarAdmin()
}

function abrirWhatsApp(telefone) {
    if (!telefone) {
        return exibirPopup("Aviso", "Este usuário não possui um número de telefone cadastrado.");
    }
    const phoneNum = telefone.startsWith('55') ? telefone : `55${telefone.replace(/\D/g, '')}`;
    window.open(`https://wa.me/${phoneNum}`, '_blank');
}

async function abrirModalEstatisticas() {
    abrirModal('modalEstatisticas');
    const painel = document.getElementById("estatisticasPainel");
    painel.innerHTML = "<p>⏳ Carregando estatísticas...</p>";
    
    try {
        const usuariosSnap = await db.collection("usuarios").get();
        let totalUsuarios = usuariosSnap.size;
        let clientes = 0, barbeiros = 0, vip = 0, pro = 0, totalSaldo = 0, somaReputacao = 0, barbeirosComReputacao = 0;
        let manicure = 0, cilios = 0;
        usuariosSnap.forEach(doc => {
            const u = doc.data();
            if (u.tipo === "cliente") clientes++;
            if (u.tipo === "barbeiro" || u.tipo === 'manicure_pedicure' || u.tipo === 'designer_cilios') {
                barbeiros++; // 'barbeiros' agora representa todos os profissionais
                if(u.reputacao) {
                    somaReputacao += u.reputacao;
                    barbeirosComReputacao++;
                }
            }
            if (u.vip) vip++;
            if (isProAtivo(u)) pro++;
            totalSaldo += u.saldo || 0;
        });
        const mediaReputacao = barbeirosComReputacao > 0 ? (somaReputacao / barbeirosComReputacao).toFixed(0) : 'N/A';

        const agendamentosSnap = await db.collection("agendamentos").get();
        let totalAgendamentos = agendamentosSnap.size;
        let concluidos = 0, cancelados = 0;
        agendamentosSnap.forEach(doc => {
            const status = doc.data().status;
            if (status === 'concluido') concluidos++;
            if (status === 'cancelado') cancelados++;
        });

        const solicitacoesSnap = await db.collection("solicitacoes").where('status', '==', 'pendente').get();
        let solicitacoesPendentes = solicitacoesSnap.size;

        const financeiroDoc = await db.collection("config").doc("financeiro").get();
        const fin = financeiroDoc.data() || { arrecadadoTaxas: 0, arrecadadoVip: 0, arrecadadoPro: 0 };
        
        painel.innerHTML = `
            <div class="popup-section"><h4>👥 Usuários</h4>
                <p>Total: <b>${totalUsuarios}</b></p>
                <p>Clientes: <b>${clientes}</b> | Profissionais: <b>${barbeiros}</b></p>
                <p>Membros VIP: <b>${vip}</b></p>
            </div>
            <div class="popup-section"><h4>🗓️ Agendamentos</h4>
                <p>Total de Registros: <b>${totalAgendamentos}</b></p>
                <p>Concluídos: <b style="color: #4CAF50;">${concluidos}</b></p>
                <p>Cancelados: <b style="color: #e74c3c;">${cancelados}</b></p>
            </div>
             <div class="popup-section"><h4>⚙️ Sistema</h4>
                <p>Reputação Média dos Profissionais: <b>${mediaReputacao} / 100</b></p>
                <p>Solicitações Pendentes: <b>${solicitacoesPendentes}</b></p>
            </div>
            <div class="popup-section"><h4>💰 Financeiro</h4>
                <p>Arrecadado com Taxas: <b>R$ ${fin.arrecadadoTaxas.toFixed(2)}</b></p>
                <p>Arrecadado com VIP: <b>R$ ${fin.arrecadadoVip.toFixed(2)}</b></p>
                <p>Saldo total em circulação: <b>R$ ${totalSaldo.toFixed(2)}</b></p>
            </div>
        `;
    } catch (error) {
        painel.innerHTML = "<p>Erro ao carregar as estatísticas.</p>";
        console.error("Erro em abrirModalEstatisticas:", error);
    }
}


function abrirModalSolicitacoes() {
  abrirModal('modalSolicitacoes');
  const lista = document.getElementById("listaSolicitacoes");
  lista.innerHTML = "<p>⏳ Carregando...</p>";
  db.collection("solicitacoes").where("status", "==", "pendente")
    .orderBy("ts", "desc").onSnapshot(snap => {
      lista.innerHTML = snap.empty ? "<p>Nenhuma solicitação pendente.</p>" : "";
      snap.forEach(doc => {
        const s = doc.data();
        lista.innerHTML += `
    <div class="card" style="position: relative;">
        <div onclick="verDetalhesSolicitacao('${doc.id}')">
            <b>${s.tipo.toUpperCase()}</b> de ${s.usuarioNome}<br>
            <p>Valor: R$ ${s.valor ? s.valor.toFixed(2) : 'N/A'}</p>
            <p style="color: #ff9800;">Status: <b>PENDENTE</b></p>
        </div>
        <button onclick="adminDeletarSolicitacao('${doc.id}')" style="position: absolute; top: 10px; right: 10px; background: #c0392b; width: 30px; height: 30px; padding: 0; border-radius: 50%; font-size: 12px;">🗑️</button>
    </div>`;
      });
    });
}

async function adminDeletarSolicitacao(id) {
    if(confirm("Tem certeza que deseja EXCLUIR esta solicitação? Ela sumirá da lista.")) {
        try {
            await db.collection("solicitacoes").doc(id).delete();
            exibirPopup("Solicitação excluída.");
        } catch (e) {
            exibirPopup("Erro ao excluir: " + e.message);
        }
    }
}

async function verDetalhesSolicitacao(id) {
  const doc = await db.collection("solicitacoes").doc(id).get();
  if (!doc.exists) return exibirPopup("Erro", "Solicitação não encontrada."); // Usa popup
  const s = doc.data();
  if (!s || s.status !== 'pendente') return exibirPopup("Info", `Esta solicitação já foi ${s.status}.`); // Usa popup

  // --- NOVA LÓGICA ---
  if (s.tipo === 'alteracao_cidade') {
      abrirModalAdminCidade(id, s); // Abre o modal específico
      return; // Sai da função aqui para não mostrar o confirm genérico
  }
  // --- FIM DA NOVA LÓGICA ---

  if (s.tipo === 'recuperacao_senha') {
      const novaSenha = prompt(`RECUPERAÇÃO DE SENHA PARA: ${s.email}\n\nDigite uma nova senha temporária (mínimo 6 caracteres):`);
      if (novaSenha && novaSenha.length >= 6) {
          try {
              exibirAguarde("Buscando usuário e redefinindo senha...");
              // Busca o usuário pelo email na coleção 'usuarios' para obter o UID
              const userQuery = await db.collection('usuarios').where('email', '==', s.email).limit(1).get();
              if (userQuery.empty) {
                  throw new Error("Nenhum usuário encontrado com este e-mail no banco de dados.");
              }
              const userDoc = userQuery.docs[0];
              const targetUid = userDoc.id; // UID encontrado
              const telefoneUsuario = userDoc.data().telefone; // Pega o telefone do Firestore

              // Chama o backend para redefinir a senha via Firebase Auth
              const response = await fetch(`${BACKEND_API_URL}/admin/reset-user-password`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ adminUid: auth.currentUser.uid, targetUid: targetUid, newPassword: novaSenha })
              });
              const data = await response.json();
              if (!response.ok) {
                  console.error("Backend error response:", data); // Log detalhado do erro do backend
                  throw new Error(data.message || `Erro ${response.status} do backend.`);
              }

              // Marca a solicitação como aprovada no Firestore
              await db.collection("solicitacoes").doc(id).update({ status: "aprovado" });

              fecharAguarde(null, true);
              exibirPopup("Sucesso", "Senha redefinida com sucesso!");

              // Abre o WhatsApp para enviar a nova senha para o usuário
              if (telefoneUsuario) {
                 const phoneNum = telefoneUsuario.startsWith('55') ? telefoneUsuario : `55${telefoneUsuario.replace(/\D/g, '')}`; // Garante 55 e limpa
                 const mensagem = encodeURIComponent(`Olá! Conforme sua solicitação, sua nova senha de acesso para o app Nova Versão é:\n\n*${novaSenha}*\n\nRecomendamos que você a altere assim que fizer o login.`);
                 window.open(`https://wa.me/${phoneNum}?text=${mensagem}`, '_blank');
              } else {
                 exibirPopup("Aviso", "Não foi possível encontrar o telefone do usuário para enviar a senha via WhatsApp. Avise-o manualmente.");
              }

          } catch (error) {
              fecharAguarde(null, true);
              console.error("Erro detalhado ao processar recuperação:", error); // Log detalhado
              exibirPopup("Erro", "Erro ao processar recuperação: " + error.message);
          }
      } else if (novaSenha) { // Se digitou algo mas < 6 chars
          exibirPopup("Aviso", "A senha deve ter no mínimo 6 caracteres. A operação foi cancelada.");
      }
      // Se cancelou o prompt, não faz nada
  } else {
    // Lógica antiga para outros tipos de solicitação (saque, depósito, etc.)
    let detalhes = `Detalhes:\nTipo: ${s.tipo.toUpperCase()}\nUsuário: ${s.usuarioNome}\nValor: R$ ${s.valor ? s.valor.toFixed(2) : 'N/A'}\n`;

    if(s.tipo === 'saque') {
      detalhes += `Chave: ${s.chavePixTipo} - ${s.chavePix}\nAprovar? (Ação irreversível - faça APÓS a transferência PIX)`;
    } else if (s.tipo === 'deposito') {
      detalhes += `Nome Completo: ${s.dadosDeposito.nomeCompleto}\nCPF: ${s.dadosDeposito.cpf}\nTelefone: ${s.dadosDeposito.telefone}\n\nAprovar este depósito? (O valor será adicionado ao saldo do usuário)`;
    } else if (s.tipo === "liberacao_loja") {
        detalhes += `\nAprovar liberação da loja para ${s.usuarioNome}?`;
    }
     else {
      detalhes += `\nAprovar?`;
    }

    // Usa confirm por enquanto, pode ser substituído por popup customizado depois
    const confirmar = confirm(detalhes);
    if (confirmar) {
      if (s.tipo === "saque") aprovarSaque(id, s.usuarioUid, s.valor);
      else if (s.tipo === "deposito") aprovarDeposito(id, s.usuarioUid, s.valor);
      else if (s.tipo === "liberacao_loja") aprovarLiberacaoLoja(id, s.usuarioUid);
    } else if (confirm("Deseja recusar a solicitação?")) {
      recusarSolicitacao(id, s.usuarioUid, s.tipo);
    }
  }
}

function aprovarSaque(id, uid, valor) {
  db.runTransaction(async t => {
    const userRef = db.collection("usuarios").doc(uid);
    const userDoc = await t.get(userRef);
    if ((userDoc.data().saldo || 0) < valor) throw "Saldo insuficiente.";
    t.update(userRef, { saldo: firebase.firestore.FieldValue.increment(-valor) });
    t.update(db.collection("solicitacoes").doc(id), { status: "aprovado" });
  }).then(() => {
    exibirPopup("Saque aprovado!");
    notifyUser(uid, "💸 Saque Aprovado!", `Sua solicitação de saque de R$ ${valor.toFixed(2)} foi processada.`, { link: '#carteira' });
  }).catch(e => exibirPopup("Erro: " + e.message));
}

function aprovarDeposito(id, uid, valor) {
  // Primeiro buscamos a solicitação para saber o subtipo (serviço ou digital)
  db.collection("solicitacoes").doc(id).get().then(snap => {
      if (!snap.exists) throw new Error("Solicitação sumiu.");
      const solicitacao = snap.data();
      const tipoSaldo = solicitacao.subtipo || 'servico'; // Padrão para antigo é serviço

      db.runTransaction(async t => {
        const userRef = db.collection("usuarios").doc(uid);
        const userDoc = await t.get(userRef);
        if (!userDoc.exists) throw new Error("Usuário não encontrado!");
        
        const userData = userDoc.data();
        const pontosPorDezReais = isVipAtivo(userData) ? 2 : 1;
        const pontosGanhos = Math.floor(valor / 10) * pontosPorDezReais;
        
        // Define qual campo atualizar
        const updates = {};
        if (tipoSaldo === 'digital') {
            updates.saldoDigital = firebase.firestore.FieldValue.increment(valor);
        } else {
            updates.saldo = firebase.firestore.FieldValue.increment(valor);
        }

        if (pontosGanhos > 0) {
            updates.pontosFidelidade = firebase.firestore.FieldValue.increment(pontosGanhos);
        }

        t.update(userRef, updates);
        t.update(db.collection("solicitacoes").doc(id), { status: "aprovado" });
        return { pontosGanhos, tipoSaldo };

      }).then((res) => {
        exibirPopup("Depósito aprovado!");
        let tipoTexto = res.tipoSaldo === 'digital' ? 'Moedas Digitais' : 'Saldo de Serviços';
        let notificationBody = `Seu depósito de R$ ${valor.toFixed(2)} em ${tipoTexto} foi aprovado.`;
        
        notifyUser(uid, "💰 Depósito Aprovado!", notificationBody, { link: '#carteira' });
      }).catch(e => {
        exibirPopup("Erro ao aprovar depósito: " + e.message);
      });
  });
}

function recusarSolicitacao(id, uid, tipo) {
  db.collection("solicitacoes").doc(id).update({ status: "recusado" })
    .then(() => {
      exibirPopup("Solicitação recusada.");
      notifyUser(uid, `❌ Solicitação Recusada`, `Sua solicitação de ${tipo} foi recusada.`);
    }).catch(e => exibirPopup("Erro: " + e.message));
}

function abrirModalUsuarios() {
  abrirModal('modalUsuarios');
  const lista = document.getElementById("usuariosPainel");
  lista.innerHTML = "<p>⏳ Carregando...</p>";
  db.collection("usuarios").onSnapshot(snap => {
    lista.innerHTML = snap.empty ? "<p>Nenhum usuário cadastrado.</p>" : "";
    snap.forEach(doc => {
      const u = doc.data();
      lista.innerHTML += `<div class="card"><b>${u.nome}</b> (${u.tipo})<p>Email: ${u.email}</p><p>Telefone: ${u.telefone}</p><button onclick="abrirModalGerenciarUsuario('${doc.id}')">⚙️ Gerenciar</button></div>`;
    });
  });
}

function abrirDenuncias() {
  abrirModal('modalDenunciasAdmin');
  const lista = document.getElementById("listaDenuncias");
  lista.innerHTML = "<p>⏳ Carregando...</p>";
  db.collection("denuncias").where("status", "==", "aberta").orderBy("ts", "desc")
    .onSnapshot(snap => {
      lista.innerHTML = snap.empty ? "<p>Nenhuma denúncia aberta.</p>" : "";
      snap.forEach(doc => {
        const d = doc.data();
        lista.innerHTML += `<div class="card" onclick="verDetalhesDenuncia('${doc.id}')"><b>Denúncia de ${d.usuarioNome}</b><p>${d.texto.substring(0, 50)}...</p></div>`;
      });
    });
}

async function verDetalhesDenuncia(id) {
  const doc = await db.collection("denuncias").doc(id).get();
  const d = doc.data();
  if (!d) return;
  if (confirm(`Denúncia de ${d.usuarioNome}:\n${d.texto}\n\nDeseja fechar esta denúncia?`)) {
    fecharDenuncia(id);
  }
}

function fecharDenuncia(id) {
  db.collection("denuncias").doc(id).update({ status: "fechada" }).then(() => exibirPopup("Denúncia fechada!"));
}

async function abrirModalGerenciarUsuario(uid) {
    exibirAguarde("Carregando dados do usuário...");
    try {
        const response = await fetch(`${BACKEND_API_URL}/admin/get-user-details`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ adminUid: auth.currentUser.uid, targetUid: uid })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || `Erro ${response.status}`);
        }
        const { auth: userRecord, firestore: u } = await response.json();
        const creationTime = new Date(userRecord.metadata.creationTime).toLocaleDateString('pt-BR');
        const lastSignInTime = new Date(userRecord.metadata.lastSignInTime).toLocaleString('pt-BR');

        // --- 1. PREPARA A LISTA DE MOLDURAS (LÓGICA VEM ANTES DO HTML) ---
        let moldurasHtml = '';
        const moldurasAdquiridas = u.moldurasAdquiridas || [];
        const molduraEquipada = u.molduraSelecionada;

        // Helper para verificar se é temporária do PRO
        const checkProAccess = (key) => {
            if (!isProAtivo(u) || !u.proTier) return false;
            const tier = u.proTier;
            const niveis = ['tier1', 'tier2', 'tier3', 'tier4'];
            const moldurasOrdem = ['bronze', 'prata', 'ouro', 'diamante'];
            const idxUser = niveis.indexOf(tier);
            const idxMoldura = moldurasOrdem.indexOf(key);
            return (idxUser >= 0 && idxMoldura >= 0 && idxUser >= idxMoldura);
        };

        Object.keys(MOLDURAS).forEach(key => {
            const m = MOLDURAS[key];
            const isDefinitiva = moldurasAdquiridas.includes(key);
            const isTemporaria = !isDefinitiva && checkProAccess(key);
            const isEquipada = molduraEquipada === key;

            if (isDefinitiva || isTemporaria) {
                const tipoBadge = isDefinitiva 
                    ? '<span style="background:#27ae60; color:white; padding:2px 6px; border-radius:4px; font-size:10px;">DEFINITIVA (Comprada)</span>' 
                    : '<span style="background:#2980b9; color:white; padding:2px 6px; border-radius:4px; font-size:10px;">TEMPORÁRIA (PRO)</span>';
                
                const equipadaBadge = isEquipada ? '✅ Em uso' : '';

                moldurasHtml += `
                    <div style="display:flex; justify-content:space-between; align-items:center; background:var(--cor-botoes); padding:8px; margin-bottom:5px; border-radius:8px; border: 1px solid var(--cor-borda);">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <div class="${m.classe}" style="width:30px; height:30px; border-radius:50%;"></div>
                            <div>
                                <div style="font-weight:bold; font-size:14px;">${m.nome} ${equipadaBadge}</div>
                                ${tipoBadge}
                            </div>
                        </div>
                        <button onclick="adminRemoverMoldura('${uid}', '${key}', ${isDefinitiva})" style="background:#c0392b; font-size:12px; padding:5px 10px; width:auto;">Remover</button>
                    </div>
                `;
            }
        });

        if (moldurasHtml === '') {
            moldurasHtml = '<p style="font-size:12px; opacity:0.7;">Este usuário não possui molduras liberadas.</p>';
        }
        // --- FIM DA LÓGICA DE MOLDURAS ---


        // --- 2. MONTA O HTML DO MODAL ---
        const container = document.getElementById('adminGerenciarConteudo');
        container.innerHTML = `
            <h4 style="word-break: break-all;">${u.nome}</h4>
            <p style="font-size: 11px; opacity: 0.7; word-break: break-all;">UID: ${uid}</p>
            
            <div class="popup-section">
                <p><strong>Informações da Conta:</strong></p>
                <p style="font-size: 14px;"><strong>Criada em:</strong> ${creationTime}</p>
                <p style="font-size: 14px;"><strong>Último Login:</strong> ${lastSignInTime}</p>
                <p style="font-size: 14px;"><strong>Conta:</strong> <span style="color: ${userRecord.disabled ? '#e74c3c' : '#2ecc71'};">${userRecord.disabled ? 'Desabilitada' : 'Ativa'}</span></p>
            </div>

            <div class="popup-section">
                <button onclick="document.getElementById('adminDadosCadastroOculto').classList.toggle('hidden')">📋 Mostrar/Ocultar Dados de Cadastro</button>
                <div id="adminDadosCadastroOculto" class="hidden" style="margin-top: 10px; background: var(--cor-fundo); padding: 10px; border-radius: 8px;">
                    <p style="font-size: 14px;"><strong>Email:</strong> ${u.email || 'N/A'}</p>
                    <p style="font-size: 14px;"><strong>Telefone:</strong> ${u.telefone || 'N/A'}</p>
                    <p style="font-size: 14px;"><strong>Estado:</strong> ${u.estado || 'N/A'}</p>
                    <p style="font-size: 14px;"><strong>Cidade:</strong> ${u.cidade || 'N/A'}</p>
                    <p style="font-size: 14px;"><strong>Endereço (Rua):</strong> ${u.rua || 'N/A'}</p>
                    <p style="font-size: 14px;"><strong>Endereço (Número):</strong> ${u.numero || 'N/A'}</p>
                    <p style="font-size: 14px;"><strong>Indicado Por (Email):</strong> ${u.indicadoPorEmail || 'N/A'}</p>
                    <p style="font-size: 14px;"><strong>Coordenadas (Lat/Lon):</strong> ${u.latitude ? u.latitude.toFixed(4) : 'N/A'} / ${u.longitude ? u.longitude.toFixed(4) : 'N/A'}</p>
                </div>
            </div>

            <div class="popup-section">
                <p><strong>Alterar Dados Cadastrais:</strong></p>
                <label for="adminNovoNome">Nome de Exibição:</label>
                <input id="adminNovoNome" type="text" value="${u.nome}">
                <label for="adminNovoTelefone">Telefone (ex: 27999999999):</label>
                <input id="adminNovoTelefone" type="tel" value="${u.telefone || ''}">

                <label for="adminNovoEstado">Estado:</label>
                <input id="adminNovoEstado" type="text" value="${u.estado || ''}" placeholder="Digite o estado" oninput="this.value = formatarNomeProprio(this.value)">
                <label for="adminNovoCidade">Cidade:</label>
                <input id="adminNovoCidade" type="text" value="${u.cidade || ''}" placeholder="Digite a cidade" oninput="this.value = formatarNomeProprio(this.value)">
                <button onclick="adminSalvarAlteracoesUsuario('${uid}')" style="margin-top: 10px;">💾 Salvar Dados</button>
            </div>

            <div class="popup-section">
                <p><strong>Gerenciar Molduras:</strong></p>
                ${moldurasHtml}
            </div>

            <div class="popup-section">
                <p><strong>Gerenciar Saldo, VIP, PRO e Pontos:</strong></p>
                
                <p><strong>Saldo Atual:</strong> R$ ${(u.saldo || 0).toFixed(2)}</p>
                <div style="display:flex; gap:5px; margin-bottom: 10px;">
                    <input id="adminModificarSaldo" type="number" placeholder="Valor (+ ou -)" style="margin:0;">
                    <button onclick="adminModificarSaldo('${uid}')" style="width:auto;">Aplicar</button>
                </div>
                <hr style="border-color: var(--cor-borda); margin: 10px 0;">
                
                <p><strong>Roleta Diária:</strong></p>
                <div style="display:flex; gap:5px; align-items: center;">
                    <input id="adminInputGiros" type="number" placeholder="Qtd Giros" style="margin:0; width: 80px;">
                    <button onclick="adminAdicionarGiros('${uid}')" style="background-color: var(--cor-destaque-ouro); color: #000;">🎲 Dar Giros</button>
                </div>
                <p style="font-size:10px; opacity:0.7; margin-top:5px;">Adiciona giros extras para hoje.</p>
                <hr style="border-color: var(--cor-borda); margin: 10px 0;">

                <p><strong>VIP Ativo:</strong> ${isVipAtivo(u) ? '<span style="color:#2ecc71; font-weight:bold;">Sim ✅</span>' : '<span style="color:#e74c3c">Não ❌</span>'}</p>
                ${isVipAtivo(u) 
                    ? `<button onclick="adminToggleVip('${uid}', false)" style="background-color: #c0392b; border: 1px solid red;">🚫 Remover VIP</button>` 
                    : `<button onclick="adminToggleVip('${uid}', true)" style="background-color: var(--cor-destaque);">👑 Conceder VIP (6 meses)</button>`
                }
                <hr style="border-color: var(--cor-borda); margin: 10px 0;">

                <p><strong>PRO Ativo:</strong> ${isProAtivo(u) ? `<span style="color:#00c6ff; font-weight:bold;">Sim ✅ (Tier: ${u.proTier || '?'})</span>` : '<span style="color:#e74c3c">Não ❌</span>'}</p>
                
                ${!isProAtivo(u) ? `
                    <div style="display:flex; gap:5px; flex-direction: column; margin-top:5px;">
                        <label style="font-size:12px;">Selecione o Plano:</label>
                        <select id="adminConcederProTier" style="margin:0; padding: 8px; background:#222; color:white; border:1px solid #555;">
                            <option value="tier1">Bronze (4%)</option>
                            <option value="tier2">Prata (2%)</option>
                            <option value="tier3">Ouro (0%)</option>
                        </select>
                        <button onclick="adminTogglePro('${uid}', true)" style="background-color: var(--cor-destaque-azul); margin-top:5px;">🌟 Conceder PRO</button>
                    </div>
                ` : `
                    <button onclick="adminTogglePro('${uid}', false)" style="background-color: #c0392b; border: 1px solid red; margin-top:5px;">🚫 Remover PRO</button>
                `}
                <hr style="border-color: var(--cor-borda); margin: 10px 0;">

                 <p><strong>Pontos Fidelidade:</strong> ${u.pontosFidelidade || 0}</p>
                 <div style="display:flex; gap:5px;">
                    <input id="adminModificarPontos" type="number" placeholder="Pontos (+ ou -)" style="margin:0;">
                    <button onclick="adminModificarPontos('${uid}')" style="width:auto;">Aplicar</button>
                 </div>
            </div>

            <div class="popup-section">
                <p><strong>Acesso à Loja:</strong></p>
                <p><strong>Loja Liberada:</strong> ${u.lojaLiberada ? 'Sim ✅' : 'Não ❌'}</p>
                <button onclick="adminToggleLoja('${uid}', ${!u.lojaLiberada})">
                    ${u.lojaLiberada ? 'Bloquear Acesso à Loja' : 'Liberar Acesso à Loja'}
                </button>
            </div>

            <div class="popup-section">
                <p><strong>Alterar Tipo de Conta:</strong></p>
                <p>Tipo Atual: <strong>${u.tipo}</strong></p>
                <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 5px; justify-content: center;">
                    <button style="flex-basis: 45%;" onclick="adminMudarTipoUsuario('${uid}', 'admin')">🧠 Admin</button>
                    <button style="flex-basis: 45%;" onclick="adminMudarTipoUsuario('${uid}', 'cliente')" ${u.tipo === 'cliente' ? 'disabled' : ''}>🙋 Cliente</button>
                    <button style="flex-basis: 45%;" onclick="adminMudarTipoUsuario('${uid}', 'barbeiro')" ${u.tipo === 'barbeiro' ? 'disabled' : ''}>💈 Barbeiro</button>
                    <button style="flex-basis: 45%;" onclick="adminMudarTipoUsuario('${uid}', 'manicure_pedicure')" ${u.tipo === 'manicure_pedicure' ? 'disabled' : ''}>💅 Manicure/Pedicure</button>
                    <button style="flex-basis: 45%;" onclick="adminMudarTipoUsuario('${uid}', 'designer_cilios')" ${u.tipo === 'designer_cilios' ? 'disabled' : ''}>👁️ Designer Cílios</button>
                </div>
            </div>

            <div class="popup-section">
                <p><strong>Ações de Segurança:</strong></p>
                <input id="adminNovaSenha" type="password" placeholder="🔑 Definir Nova Senha para o Usuário">
                <button onclick="adminDefinirNovaSenha('${uid}')">Definir Nova Senha</button>
            </div>

            <div class="popup-section">
                <p><strong>Ações de Conta:</strong></p>
                <button style="background-color: ${userRecord.disabled ? '#2ecc71' : '#f1c40f'};" onclick="adminToggleUserStatus('${uid}', ${!userRecord.disabled})">${userRecord.disabled ? 'Reativar Conta' : 'Desativar Conta'}</button>
                <button style="background-color: #c0392b; margin-top: 10px;" onclick="adminDeletarUsuario('${uid}', '${u.nome}')">DELETAR USUÁRIO</button>
            </div>
            <button data-modal-id="modalGerenciarUsuario" onclick="fecharModal(event)" style="margin-top: 20px;">❌ Fechar</button>
        `;

        fecharTodosOsModais(); // Fecha o "Aguarde..."
        abrirModal('modalGerenciarUsuario'); // Abre o modal
    } catch (error) {
        fecharTodosOsModais();
        console.error("Erro ao buscar dados do usuário:", error);
        exibirPopup("Não foi possível carregar os dados completos do usuário. " + error.message);
    }
}

function prepararDeletarConta() {
  // Fecha o modal de config
  fecharModalAtual();
  
  // Pede a primeira confirmação
  exibirConfirmacao("Excluir Conta?", "Esta ação é irreversível. Todos os seus dados, saldo, agendamentos e histórico serão apagados permanentemente. Deseja continuar?", (confirmacao1) => {
      // Pede a segunda confirmação
      exibirConfirmacao("Confirmação Final", "Esta é sua última chance. Todos os seus dados serão perdidos. Confirma a exclusão permanente da sua conta?", async (confirmacao2) => {
          // Se chegou aqui, abre o modal de senha
          document.getElementById('exclusaoSenhaInput').value = ''; // Limpa senha
          abrirModal('modalConfirmarSenhaExclusao');
      });
  });
}

async function deletarConta() {
  const password = document.getElementById('exclusaoSenhaInput').value;
  if (!password) {
      return exibirPopup("Senha necessária.", "Digite sua senha para confirmar.");
  }

  fecharModalAtual(); // Fecha o modal de senha
  exibirAguarde("Reautenticando e excluindo sua conta...");

  const user = auth.currentUser;
  const credential = firebase.auth.EmailAuthProvider.credential(user.email, password);

  try {
      // 1. Reautenticar
      await user.reauthenticateWithCredential(credential);

      // 2. Deletar dados do Firestore
      await db.collection('usuarios').doc(user.uid).delete();
      
      // 3. Deletar usuário do Auth
      await user.delete();

      fecharTodosOsModais();
      exibirPopup("Conta Excluída", "Sua conta foi excluída com sucesso. Sentiremos sua falta.", 'sucesso', () => {
          location.reload(); // Recarrega a página após o usuário clicar em OK
      });
      
  } catch (error) {
      fecharTodosOsModais();
      if (error.code === 'auth/wrong-password') {
          exibirPopup("Senha Incorreta", "A senha digitada está incorreta. A exclusão foi cancelada.", 'erro');
      } else {
          exibirPopup("Erro", "Ocorreu um erro ao excluir sua conta: " + error.message, 'erro');
      }
  }
}

async function adminSalvarAlteracoesUsuario(uid) {
    const nomeInput = document.getElementById('adminNovoNome');
    const telefoneInput = document.getElementById('adminNovoTelefone');
    const estadoInput = document.getElementById('adminNovoEstado'); // Input de estado
    const cidadeInput = document.getElementById('adminNovoCidade'); // Input de cidade

    const updates = {
        nome: nomeInput.value.trim(),
        telefone: telefoneInput.value.trim(),
        // Formata os valores dos inputs antes de salvar
        estado: formatarNomeProprio(estadoInput.value.trim()),
        cidade: formatarNomeProprio(cidadeInput.value.trim())
    };

    if (!updates.nome || !updates.telefone || !updates.estado || !updates.cidade) {
        return exibirPopup("Todos os campos (Nome, Telefone, Estado, Cidade) devem ser preenchidos.");
    }
     // Validação extra para telefone (exemplo)
    if (!/^\d{10,11}$/.test(updates.telefone)) {
        return exibirPopup("O telefone deve conter 10 ou 11 dígitos (com DDD).");
    }

    exibirAguarde("Salvando...");
    try {
        const response = await fetch(`${BACKEND_API_URL}/admin/update-user-firestore`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ adminUid: auth.currentUser.uid, targetUid: uid, updates })
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.message || 'Erro no backend');

        fecharTodosOsModais();
        exibirPopup("Dados do usuário atualizados com sucesso!");
        // Não é mais necessário fechar o modal aqui, fecharTodosOsModais já faz
        // Opcional: Reabrir a lista pode ser confuso, melhor deixar o admin fechar
        // abrirModalUsuarios();

    } catch (error) {
        fecharTodosOsModais();
        exibirPopup("Erro ao salvar alterações: " + error.message);
    }
}

async function adminDefinirNovaSenha(uid) {
    const novaSenha = document.getElementById('adminNovaSenha').value;
    if (novaSenha.length < 6) {
        return exibirPopup("A nova senha deve ter no mínimo 6 caracteres.");
    }
    if (!confirm("Tem certeza que deseja definir esta nova senha para o usuário? Ele perderá o acesso com a senha antiga.")) {
        return;
    }
    
    exibirAguarde("Redefinindo senha...");
    try {
        const response = await fetch(`${BACKEND_API_URL}/admin/reset-user-password`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ adminUid: auth.currentUser.uid, targetUid: uid, newPassword: novaSenha })
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.message);
        
        fecharTodosOsModais();
        exibirPopup(`Senha redefinida! A nova senha é "${novaSenha}". É recomendado enviar para o usuário via WhatsApp.`);
    } catch (error) {
        fecharTodosOsModais();
        exibirPopup("Erro ao definir nova senha: " + error.message);
    }
}

async function adminToggleUserStatus(uid, disable) {
    const acao = disable ? "desabilitar" : "reativar";
    if (!confirm(`Tem certeza que deseja ${acao} a conta deste usuário? Ele ${disable ? 'não poderá mais fazer login' : 'poderá voltar a fazer login'}.`)) {
        return;
    }

    exibirAguarde(`${acao.charAt(0).toUpperCase() + acao.slice(1)}ndo conta...`);
    try {
        const response = await fetch(`${BACKEND_API_URL}/admin/toggle-user-status`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ adminUid: auth.currentUser.uid, targetUid: uid, disable })
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.message);
        
        fecharTodosOsModais();
        exibirPopup(`Conta ${disable ? 'desabilitada' : 'reativada'} com sucesso!`);
        fecharModalAtual(); // Fecha o modal para forçar a reabertura com os dados atualizados
    } catch (error) {
        fecharTodosOsModais();
        exibirPopup(`Erro ao ${acao} conta: ` + error.message);
    }
}


// Funções de Ação do Modal Admin
async function adminMudarTipo(uid) {
  const novoTipo = document.getElementById('adminNovoTipo').value;
  await db.collection("usuarios").doc(uid).update({ tipo: novoTipo });
  exibirPopup("Tipo alterado!");
  fecharModalAtual();
}
async function adminModificarSaldo(uid) {
  const valor = parseFloat(document.getElementById('adminModificarSaldo').value);
  if (!isNaN(valor)) {
    await db.collection("usuarios").doc(uid).update({ saldo: firebase.firestore.FieldValue.increment(valor) });
    notifyUser(uid, "💸 Nova Transação!", `Um admin alterou seu saldo em R$ ${valor.toFixed(2)}.`, { link: '#carteira' });
    exibirPopup("Saldo alterado!");
    fecharModalAtual();
  } else exibirPopup("Valor inválido.");
}

async function adminToggleVip(uid, conceder) {
    const acao = conceder ? "Concedendo VIP..." : "Removendo VIP...";
    exibirAguarde(acao);
    try {
        let updates = {};
        if (conceder) {
            const expiracao = new Date();
            expiracao.setDate(expiracao.getDate() + 180); // 6 meses
            updates = {
                vip: true,
                vipExpirationDate: expiracao.toISOString() // Envia como string ISO
            };
        } else {
            updates = {
                vip: false,
                vipExpirationDate: null // Define como null (seu backend e a função isVipAtivo já tratam isso)
            };
        }
        
        // CHAMA O BACKEND SEGURO
        const response = await fetch(`${BACKEND_API_URL}/admin/update-user-firestore`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                adminUid: auth.currentUser.uid, 
                targetUid: uid, 
                updates: updates 
            })
        });
        
        const data = await response.json();
        if (!response.ok) throw new Error(data.message || 'Erro no backend');

        fecharTodosOsModais();
        exibirPopup(conceder ? "VIP concedido!" : "VIP Removido!");
        
        // Notifica o usuário
        if (conceder) {
            notifyUser(uid, "👑 VIP Concedido!", "Um administrador ativou sua assinatura VIP por 6 meses.");
        } else {
            notifyUser(uid, "ℹ️ VIP Removido", "Sua assinatura VIP foi removida por um administrador.");
        }
        
        abrirModalGerenciarUsuario(uid); // Reabre para atualizar a UI
    } catch (error) {
        fecharTodosOsModais();
        exibirPopup("Erro ao gerenciar VIP: " + error.message);
    }
}

function abrirModalVipPro() {
    const container = document.getElementById('vipProContentContainer');
    const proAtivo = isProAtivo(perfil);

    if (proAtivo) {
        // ... (código para quem já é PRO mantém-se quase igual, só atualize se quiser mostrar o que ele tem)
        let dataFormatada = "Indefinido";
        if (perfil.proExpirationDate) {
             try {
                 const dateObj = typeof perfil.proExpirationDate.toDate === 'function' 
                    ? perfil.proExpirationDate.toDate() 
                    : new Date(perfil.proExpirationDate);
                 dataFormatada = dateObj.toLocaleDateString('pt-BR');
             } catch (e) { console.log(e); }
        }
        let taxaAtual = (TAXA * 100); let girosAtuais = 1; let nomeTier = "";
        if (perfil.proTier && PRECOS_PRO[perfil.proTier]) {
            taxaAtual = PRECOS_PRO[perfil.proTier].taxa * 100;
            girosAtuais = PRECOS_PRO[perfil.proTier].giros;
            nomeTier = PRECOS_PRO[perfil.proTier].nome;
        }
        container.innerHTML = `
            <div class="pro-glow" style="padding: 20px; border-radius: 15px; text-align: center; background: linear-gradient(180deg, #0f2027, #203a43, #2c5364);">
                <h3 style="color: #00c6ff; text-shadow: 0 0 10px #00c6ff;">🌟 Você é PRO ${nomeTier.toUpperCase()}!</h3>
                <p style="color:white;">Sua assinatura é válida até: <strong>${dataFormatada}</strong></p>
                <div style="display:flex; justify-content:space-around; margin-top:20px;">
                    <div style="background:rgba(0,0,0,0.3); padding:10px; border-radius:10px;">
                        <p style="font-size:24px;">📉 ${taxaAtual.toFixed(0)}%</p>
                        <p style="font-size:12px; color:#aaa;">Taxa de Serviço</p>
                    </div>
                    <div style="background:rgba(0,0,0,0.3); padding:10px; border-radius:10px;">
                        <p style="font-size:24px;">🎲 ${girosAtuais}</p>
                        <p style="font-size:12px; color:#aaa;">Giros Diários</p>
                    </div>
                </div>
                <p style="margin-top:10px; font-size:13px; color:#fff;">Você também tem acesso liberado às Molduras e Balões de Chat do seu nível!</p>
            </div>
        `;
    } else {
        let htmlPlanos = '';
        
        // BENEFÍCIOS ATUALIZADOS COM OS BALÕES
        const beneficios = {
            'tier1': ['📉 Taxa: <strong>15%</strong>', '🎲 <strong>2 Giros</strong>/dia', '🥉 Moldura + Chat Bronze'],
            'tier2': ['📉 Taxa: <strong>10%</strong>', '🎲 <strong>3 Giros</strong>/dia', '🥈 Moldura + Chat Prata'],
            'tier3': ['📉 Taxa: <strong>5%</strong>', '🎲 <strong>4 Giros</strong>/dia', '🥇 Moldura + Chat Ouro'],
            'tier4': ['🚫 <strong>TAXA ZERO (0%)</strong>', '🎲 <strong>5 Giros</strong>/dia', '💎 Moldura + Chat Diamante']
        };

        const cores = { 'tier1': '#cd7f32', 'tier2': '#c0c0c0', 'tier3': '#ffd700', 'tier4': '#00c6ff' };

        Object.keys(PRECOS_PRO).forEach(tier => {
            const plano = PRECOS_PRO[tier];
            const cor = cores[tier];
            const listaBeneficios = beneficios[tier].map(b => `<li>${b}</li>`).join('');
            
            htmlPlanos += `
            <div class="card" style="border: 2px solid ${cor}; background: linear-gradient(135deg, #1a1a1a, #000); cursor: pointer; margin-bottom: 15px;" onclick="assinarPro('${tier}')">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h4 style="color: ${cor}; margin:0; font-size: 20px; text-transform: uppercase;">${plano.nome}</h4>
                    <span style="background:${cor}; color:black; font-weight:bold; padding:2px 8px; border-radius:10px; font-size:12px;">R$ ${plano.preco.toFixed(2)}</span>
                </div>
                <ul style="text-align:left; font-size: 14px; color: #ddd; padding-left: 20px; margin: 10px 0;">
                    ${listaBeneficios}
                </ul>
                <p style="font-size:11px; color:${cor}; margin:0 0 10px 0;">*Libera todos os itens dos níveis anteriores!</p>
                <button style="background: ${cor}; width: 100%; color:black; font-weight:bold; border:none; padding: 10px; pointer-events: none;">QUERO SER ${plano.nome.toUpperCase()}</button>
            </div>`;
        });

        container.innerHTML = `
            <div style="text-align: center;">
                <h3 style="background: -webkit-linear-gradient(#00c6ff, #0072ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 24px; font-weight: 800;">🚀 SEJA UM PROFISSIONAL PRO</h3>
                <p style="font-size:14px; opacity:0.8; margin-bottom: 20px;">Taxas menores, visual exclusivo e mais chances na roleta!</p>
                <div style="max-height: 60vh; overflow-y: auto; padding: 5px;">
                    ${htmlPlanos}
                </div>
            </div>
        `;
    }
    abrirModal('modalVipPro');
}

async function adminDeletarUsuario(uid, nome) {
  if (prompt(`TEM CERTEZA? Para deletar ${nome}, digite "DELETAR":`) === "DELETAR") {
    await db.collection("usuarios").doc(uid).delete();
    exibirPopup("Usuário deletado!");
    fecharModalAtual();
  } else exibirPopup("Exclusão cancelada.");
}

async function adminToggleLoja(uid, deveAtivar) {
    const acao = deveAtivar ? "liberar" : "bloquear";
    if (!confirm(`Tem certeza que deseja ${acao} o acesso à loja para este usuário?`)) return;

    exibirAguarde(`${deveAtivar ? 'Liberando' : 'Bloqueando'} acesso...`);
    try {
        await db.collection('usuarios').doc(uid).update({ lojaLiberada: deveAtivar });
        fecharTodosOsModais();
        exibirPopup(`Acesso à loja ${deveAtivar ? 'liberado' : 'bloqueado'} com sucesso!`);
        // Reabre o modal para atualizar a interface
        abrirModalGerenciarUsuario(uid); // Chama a função que recarrega os dados e reabre
    } catch (error) {
        fecharTodosOsModais();
        exibirPopup(`Erro ao ${acao} acesso: ${error.message}`);
    }
}

// SUBSTITUA A FUNÇÃO 'adminTogglePro' POR ESTA:
async function adminTogglePro(uid, conceder) {
    exibirAguarde(conceder ? "Concedendo PRO..." : "Removendo PRO...");
    
    try {
        // 1. Busca dados atuais do usuário para verificar a moldura
        const userDoc = await db.collection('usuarios').doc(uid).get();
        if (!userDoc.exists) throw new Error("Usuário não encontrado.");
        const u = userDoc.data();

        let updates = {};
        
        if (conceder) {
            // SÓ tenta ler o select se estiver CONCEDENDO
            const selectElement = document.getElementById('adminConcederProTier');
            if (!selectElement) throw new Error("Erro na interface: Select não encontrado.");
            
            const tierSelecionado = selectElement.value;
            const expiracao = new Date();
            expiracao.setDate(expiracao.getDate() + 30); 
            
            updates = {
                proAtivo: true,
                proTier: tierSelecionado,
                proExpirationDate: expiracao.toISOString() 
            };
        } else {
            // --- LÓGICA DE REMOÇÃO INTELIGENTE DA MOLDURA ---
            // Se o usuário estiver com uma moldura equipada
            if (u.molduraSelecionada) {
                const moldurasCompradas = u.moldurasAdquiridas || [];
                // Se a moldura atual NÃO estiver na lista de compradas (ou seja, é temporária do PRO)
                if (!moldurasCompradas.includes(u.molduraSelecionada)) {
                    console.log("Removendo moldura temporária do usuário...");
                    updates.molduraSelecionada = firebase.firestore.FieldValue.delete(); // Remove a seleção
                }
            }
            // ------------------------------------------------

            // Remove status PRO
            updates.proAtivo = false;
            updates.proTier = null;
            updates.proExpirationDate = null;
        }
        
        // Envia para o backend
        const response = await fetch(`${BACKEND_API_URL}/admin/update-user-firestore`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                adminUid: auth.currentUser.uid, 
                targetUid: uid, 
                updates: updates 
            })
        });
        
        const data = await response.json();
        if (!response.ok) throw new Error(data.message || 'Erro no backend');

        fecharTodosOsModais(); // Fecha o aguarde
        
        // Callback para reabrir o modal
        const reabrirModalAdmin = () => {
            abrirModalGerenciarUsuario(uid);
        };

        if (conceder) {
            notifyUser(uid, "🌟 PRO Ativado!", `Admin ativou seu plano ${updates.proTier}.`);
            exibirPopup("Sucesso!", `Plano PRO ${updates.proTier} ativado.`, "sucesso", reabrirModalAdmin);
        } else {
            notifyUser(uid, "ℹ️ PRO Removido", "Seu plano PRO foi cancelado pelo admin.");
            exibirPopup("Sucesso!", "Plano PRO removido (Moldura temporária retirada, se houver).", "sucesso", reabrirModalAdmin);
        }

    } catch (error) {
        fecharTodosOsModais();
        exibirPopup("Erro", error.message);
    }
}

// NOVA FUNÇÃO PARA ADMIN REMOVER MOLDURAS MANUALMENTE
async function adminRemoverMoldura(uid, molduraKey, isDefinitiva) {
    if (!confirm(`Tem certeza que deseja remover a moldura "${MOLDURAS[molduraKey].nome}" deste usuário?`)) return;

    exibirAguarde("Removendo moldura...");
    try {
        const userRef = db.collection('usuarios').doc(uid);
        const userDoc = await userRef.get();
        const u = userDoc.data();
        
        let updates = {};

        // 1. Se for definitiva, remove do array de adquiridas
        if (isDefinitiva) {
            updates.moldurasAdquiridas = firebase.firestore.FieldValue.arrayRemove(molduraKey);
        }

        // 2. Se o usuário estiver USANDO essa moldura no momento, desequipa ela
        if (u.molduraSelecionada === molduraKey) {
            updates.molduraSelecionada = firebase.firestore.FieldValue.delete();
        }

        await userRef.update(updates);

        fecharTodosOsModais();
        exibirPopup("Sucesso", "Moldura removida com sucesso!");
        abrirModalGerenciarUsuario(uid); // Reabre para atualizar a lista

    } catch (error) {
        fecharTodosOsModais();
        exibirPopup("Erro", "Erro ao remover moldura: " + error.message);
    }
}

// ADICIONE ESTA NOVA FUNÇÃO PARA GERENCIAR OS PONTOS
async function adminModificarPontos(uid) {
    const inputPontos = document.getElementById('adminModificarPontos');
    const valor = parseInt(inputPontos.value);

    if (isNaN(valor)) {
        return exibirPopup("Por favor, insira um número válido de pontos.");
    }

    const acao = valor >= 0 ? "adicionar" : "remover";
    if (!confirm(`Tem certeza que deseja ${acao} ${Math.abs(valor)} pontos ${valor >= 0 ? 'para' : 'de'} este usuário?`)) {
        return;
    }

    exibirAguarde("Modificando pontos...");
    try {
        await db.collection('usuarios').doc(uid).update({
            pontosFidelidade: firebase.firestore.FieldValue.increment(valor)
        });
        fecharTodosOsModais();
        exibirPopup(`Pontos modificados com sucesso!`);
        notifyUser(uid, "🏆 Pontos Alterados!", `Um administrador alterou seus pontos de fidelidade em ${valor}.`, { link: '#fidelidade' });
        inputPontos.value = ''; // Limpa o input
        abrirModalGerenciarUsuario(uid); // Reabre para atualizar
    } catch (error) {
        fecharTodosOsModais();
        exibirPopup("Erro ao modificar pontos: " + error.message);
    }
}

function solicitarVirarProfissional() {
    fecharModalAtual(); // Fecha o modal de config
    exibirConfirmacao("Virar Profissional?", 
    "Tem certeza que deseja se tornar um profissional? Seu painel será alterado e você precisará configurar seus serviços, agenda e portfólio para começar a receber agendamentos. Esta ação não pode ser desfeita facilmente pelo app.", 
    () => {
        // Callback a ser executado se o usuário clicar "Sim"
        executarVirarProfissional();
    });
}

async function executarVirarProfissional() {
    if (perfil.tipo !== 'cliente') return;
    
    exibirAguarde("Atualizando seu perfil...");
    try {
        await db.collection('usuarios').doc(auth.currentUser.uid).update({
            tipo: perfil.interesse_principal || 'barbeiro', // Usa o interesse principal ou 'barbeiro' como padrão
            precisaConfiguracaoInicial: true, // Força o onboarding de profissional
            onboarding_profissional_concluido: false // Garante que o onboarding não foi concluído
        });
        
        fecharTodosOsModais();
        exibirPopup("Sucesso!", "Seu perfil foi atualizado para Profissional. O app será reiniciado para aplicar as mudanças.", 'sucesso', () => {
            // A página será recarregada automaticamente pelo onAuthStateChanged
            // Mas forçamos aqui após o delay para garantir
            setTimeout(() => location.reload(), 4000); 
        });
        
    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro", "Não foi possível atualizar seu perfil: " + e.message, 'erro');
    }
}


async function adminMudarTipoUsuario(uid, novoTipo) {
    // Validação removida para permitir 'admin'
    if (!confirm(`Tem certeza que deseja alterar o tipo deste usuário para "${novoTipo}"? O aplicativo dele será reiniciado.`)) return;

    // 1. Mostrar "Aguarde" IMEDIATAMENTE
    exibirAguarde("Alterando tipo de usuário...");

    try {
        // Atualiza o tipo e reseta campos específicos se necessário
        const updates = { tipo: novoTipo };
        if (novoTipo === 'cliente') {
            updates.listaServicos = [];
            updates.promocoes = [];
            updates.portfolio = [];
            updates.logo_url = firebase.firestore.FieldValue.delete();
            updates.disponivel = "nao";
            updates.vagaImediata = false;
            updates.usaAgendaManual = false;
            updates.agenda = {};
            updates.ausente = false;
            updates.ausenciaInicio = firebase.firestore.FieldValue.delete();
            updates.ausenciaFim = firebase.firestore.FieldValue.delete();
        } else {
             updates.onboarding_profissional_concluido = true;
        }

        // Adiciona o timestamp para forçar reload no *outro* cliente, se ele estiver online
        updates.forceReloadTimestamp = firebase.firestore.FieldValue.serverTimestamp();

        // Salva as alterações no Firestore
        await db.collection('usuarios').doc(uid).update(updates);

        // 2. Fechar "Aguarde" e Mostrar "Sucesso"
        fecharAguarde(null, true); // Força o fechamento do Aguarde
        exibirPopup("Sucesso", `Tipo de usuário alterado para "${novoTipo}" com sucesso! O aplicativo do usuário será reiniciado.`);

        // 3. Agendar o redirecionamento FORÇADO após 3 segundos
        //    (Isso afeta APENAS a tela do ADMIN que fez a ação, o usuário afetado
        //     será reiniciado pela lógica no onAuthStateChanged que já implementamos)
        //    Não precisamos reiniciar a tela do admin aqui, apenas reabrir o modal.
        // setTimeout(() => {
        //     console.log("Forçando reinicialização da *sua* tela (admin)...");
        //     window.location.href = '/?force_reload=' + Date.now(); // Adiciona timestamp para garantir que não use cache
        // }, 3000);

        // Em vez de reiniciar a tela do admin, apenas reabrimos o modal para ver a mudança
         abrirModalGerenciarUsuario(uid); // Reabre o modal do usuário gerenciado
         location.reload();
         abrirModalGerenciarUsuario(uid);

    } catch (error) {
        // Em caso de erro
        fecharAguarde(null, true); // Garante que o Aguarde feche
        console.error("Erro ao alterar tipo:", error);
        exibirPopup("Erro", `Erro ao alterar tipo: ${error.message}`);
    }
}

function exibirPopupNovoAgendamento(agendamentoDoc) {
    // Se já estiver aberto e visível, não recria para evitar piscar
    const modal = document.getElementById('modalNovoAgendamento');
    if (popupAgendamentoAberto && modal.style.display === 'flex') return; 

    const ag = agendamentoDoc.data();
    
    document.getElementById('popupClienteNome').textContent = ag.clienteNome;
    document.getElementById('popupServicoNome').textContent = ag.servico;
    document.getElementById('popupHorario').textContent = ag.horario ? ag.horario : "Vaga Imediata";
    document.getElementById('popupValor').textContent = ag.valor.toFixed(2);
    
    // Configura WhatsApp
    const btnWpp = document.getElementById('btnWhatsAppPopup');
    if (ag.clienteTelefone) {
        btnWpp.href = `https://wa.me/55${ag.clienteTelefone.replace(/\D/g,'')}`;
        btnWpp.style.display = 'block';
    } else {
        btnWpp.style.display = 'none';
    }

    const btnAceitar = document.getElementById('btnAceitarAgendamentoPopup');
    const btnRecusar = document.getElementById('btnRecusarAgendamentoPopup');

    // --- AÇÃO DO BOTÃO ACEITAR (COM POPUP CUSTOMIZADO) ---
    btnAceitar.onclick = () => {
        exibirConfirmacao(
            "Aprovar Agendamento?", 
            `Deseja confirmar o atendimento de ${ag.clienteNome} para ${ag.horario || 'agora'}?`,
            () => {
                // Callback: Só executa se clicar em "Sim" no popup
                
                // 1. Fecha o modal de agendamento manualmente
                modal.style.display = 'none';
                modal.classList.remove('show');
                popupAgendamentoAberto = false;
                
                // 2. Chama a função de aprovação
                if (ag.status === 'imediato') {
                    aprovarAgendamentoImediato(agendamentoDoc.id, ag.clienteUid, ag.valor);
                } else {
                    aprovarAgendamento(agendamentoDoc.id, ag.clienteUid, ag.valor, ag.horario);
                }
            }
        );
    };

    // --- AÇÃO DO BOTÃO RECUSAR (COM POPUP CUSTOMIZADO) ---
    btnRecusar.onclick = () => {
        exibirConfirmacao(
            "Recusar Agendamento?", 
            "Tem certeza que deseja recusar? O cliente será notificado.",
            () => {
                // Callback: Só executa se clicar em "Sim"
                
                // 1. Fecha o modal manualmente
                modal.style.display = 'none';
                modal.classList.remove('show');
                popupAgendamentoAberto = false;
                
                // 2. Chama a função de recusa
                recusarAgendamento(agendamentoDoc.id, ag.clienteUid);
            }
        );
    };

    // Abre o modal de forma persistente
    popupAgendamentoAberto = true;
    modal.style.display = 'flex';
    modal.onclick = null; // Remove fechamento por clique no fundo
    setTimeout(() => modal.classList.add('show'), 10);
}

async function enviarNotificacaoMarketing() {
    const title = document.getElementById('marketingTitulo').value.trim();
    const body = document.getElementById('marketingCorpo').value.trim();
    if (!title || !body || !confirm(`Confirma o envio da notificação em massa?`)) return;
    try {
        exibirAguarde("Aguarde...", "Enviando notificações para todos.");
        const response = await fetch("https://navalhabackend.onrender.com/enviar-notificacao-massa", {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title, body, adminUid: auth.currentUser.uid }),
        });
        const data = await response.json();
        fecharTodosOsModais();
        if (!response.ok) throw new Error(data.message);
        exibirPopup(`Notificações enviadas!\nSucessos: ${data.successCount}\nFalhas: ${data.failureCount}`);
        fecharModalAtual();
    } catch (error) {
        fecharTodosOsModais();
        exibirPopup('Falha ao enviar: ' + error.message);
    }
}

const conquistasDefinidas = {
    'cliente': {
        'cortes_1': { nome: 'Primeiro Agendamento', icone: '👶', descricao: 'Concluiu seu primeiro agendamento.', level: 1 },
        'cortes_5': { nome: 'Cliente Iniciante', icone: '👍', descricao: 'Concluiu 5 agendamentos.', level: 2 },
        'cortes_10': { nome: 'Cliente Regular', icone: '⭐', descricao: 'Concluiu 10 agendamentos.', level: 3 },
        'cortes_50': { nome: 'Parceiro da Beleza', icone: '💪', descricao: 'Concluiu 50 agendamentos.', level: 5 },
        'cortes_100': { nome: 'Membro de Honra', icone: '👑', descricao: 'Concluiu 100 agendamentos.', level: 6 },
        'cortes_250': { nome: 'Cliente Fanático', icone: '🔥', descricao: 'Concluiu 250 agendamentos.', level: 7 },
        'cortes_500': { nome: 'Cliente Lenda', icone: '🏆', descricao: 'Concluiu 500 agendamentos.', level: 8 },
        'cortes_1000': { nome: 'Embaixador Nova Versão', icone: '💎', descricao: 'Concluiu 1000 agendamentos.', level: 9 }
    },
    'profissional': {
        'cortes_1': { nome: 'Primeiro Cliente', icone: '🎉', descricao: 'Concluiu seu primeiro serviço.', level: 1 },
        'cortes_10': { nome: 'Profissional em Ascensão', icone: '🔥', descricao: 'Concluiu 10 serviços.', level: 3 },
        'cortes_50': { nome: 'Profissional Experiente', icone: '😎', descricao: 'Concluiu 50 serviços.', level: 5 },
        'cortes_100': { nome: 'Mestre da Área', icone: '💎', descricao: 'Concluiu 100 serviços.', level: 6 },
        'cortes_250': { nome: 'Referência Local', icone: '🚀', descricao: 'Concluiu 250 serviços.', level: 7 }, // ADICIONADO
        'cortes_500': { nome: 'Influenciador da Beleza', icone: '🌟', descricao: 'Concluiu 500 serviços.', level: 8 }, // ADICIONADO
        'cortes_1000': { nome: 'Lenda do Ramo', icone: '🏆', descricao: 'Concluiu 1000 serviços.', level: 9 } // Level ajustado
    }
};

// SUBSTITUA A FUNÇÃO verificarConquistas
async function verificarConquistas(uid) {
    const userRef = db.collection('usuarios').doc(uid);
    const userDoc = await userRef.get();
    if (!userDoc.exists) return;
    const userData = userDoc.data();
    const conquistasAtuais = userData.conquistas || [];
    const cortes = userData.cortesRealizados || 0;
    const definicoes = conquistasDefinidas.cliente;
    // CORREÇÃO: 'cortes_1000' estava com aspas erradas
    const niveis = { 1: 'cortes_1', 5: 'cortes_5', 10: 'cortes_10', 50: 'cortes_50', 100: 'cortes_100', 250: 'cortes_250', 500: 'cortes_500', 1000: 'cortes_1000' };

    for (const nivel in niveis) {
        const conquistaId = niveis[nivel];
        if (cortes >= nivel && !conquistasAtuais.includes(conquistaId)) {
            await userRef.update({ conquistas: firebase.firestore.FieldValue.arrayUnion(conquistaId) });
            const conquista = definicoes[conquistaId];
            notifyUser(uid, "🏅 Nova Conquista!", `Você desbloqueou: "${conquista.nome}"!`, { link: '#conquistas' });
        }
    }
}

// SUBSTITUA A FUNÇÃO verificarConquistasBarbeiro
async function verificarConquistasBarbeiro(uid) {
    const userRef = db.collection('usuarios').doc(uid);
    const userDoc = await userRef.get();
    if (!userDoc.exists) return;
    const userData = userDoc.data();
    const conquistasAtuais = userData.conquistas || [];
    const cortes = userData.clientesAtendidos || 0;
    const definicoes = conquistasDefinidas.profissional;
    // CORREÇÃO: 'cortes_1000' estava com aspas erradas e 'cortes_5' estava faltando (agora incluído como você pediu)
    const niveis = { 1: 'cortes_1', 10: 'cortes_10', 50: 'cortes_50', 100: 'cortes_100', 250: 'cortes_250', 500: 'cortes_500', 1000: 'cortes_1000' };

    
    for (const nivel in niveis) {
        const conquistaId = niveis[nivel];
        if (cortes >= nivel && !conquistasAtuais.includes(conquistaId)) {
            await userRef.update({ conquistas: firebase.firestore.FieldValue.arrayUnion(conquistaId) });
            const conquista = definicoes[conquistaId];
            notifyUser(uid, "🏅 Nova Conquista de Profissional!", `Você desbloqueou: "${conquista.nome}"!`, { link: '#conquistas' });
        }
    }
}

function abrirModalConquistas() {
    abrirModal('modalConquistas');
    const container = document.getElementById('listaConquistas');
    container.innerHTML = "";
    const conquistasDoUsuario = perfil.conquistas || [];
    const definicoes = conquistasDefinidas.cliente;
    for (const id in definicoes) {
        const c = definicoes[id];
        const unlocked = conquistasDoUsuario.includes(id);
        container.innerHTML += `<div class="conquista-item ${unlocked ? 'unlocked' : 'locked'}"><div class="conquista-icon
">${c.icone}</div><div><b>${c.nome}</b><p style="font-size:12px; margin:0;">${c.descricao}</p></div></div>`;
    }
}

function abrirModalConquistasBarbeiro() {
    abrirModal('modalConquistasBarbeiro');
    const container = document.getElementById('listaConquistasBarbeiro');
    container.innerHTML = "";
    const conquistasDoUsuario = perfil.conquistas || [];
    const definicoes = conquistasDefinidas.profissional;
    for (const id in definicoes) {
        const c = definicoes[id];
        const unlocked = conquistasDoUsuario.includes(id);
        container.innerHTML += `<div class="conquista-item ${unlocked ? 'unlocked' : 'locked'}"><div class="conquista-icon">${c.icone}</div><div><b>${c.nome}</b><p style="font-size:12px; margin:0;">${c.descricao}</p></div></div>`;
    }
}

async function abrirModalRankingUnificado() {
    abrirModal('modalRankingUnificado');
    const container = document.getElementById('listaRankingUnificado');
    container.innerHTML = '<p>Carregando...</p>';
    
    try {
        const [clientesSnap, profissionaisSnap] = await Promise.all([
            db.collection('usuarios').where('tipo', '==', 'cliente').orderBy('cortesRealizados', 'desc').limit(50).get(),
            db.collection('usuarios').where('tipo', 'in', ['barbeiro', 'manicure_pedicure', 'designer_cilios']).orderBy('clientesAtendidos', 'desc').limit(50).get()
        ]);
        
        let ranking = [];
        clientesSnap.forEach(doc => ranking.push({ nome: doc.data().nome, contagem: doc.data().cortesRealizados || 0, tipo: 'cliente' }));
        profissionaisSnap.forEach(doc => ranking.push({ nome: doc.data().nome, contagem: doc.data().clientesAtendidos || 0, tipo: 'profissional' }));

        ranking.sort((a, b) => b.contagem - a.contagem);
        
        container.innerHTML = "";
        ranking.slice(0, 100).forEach((item, i) => {
            const icone = item.tipo === 'cliente' ? '🙋' : '💼';
            container.innerHTML += `<div class="ranking-item"><span>${i + 1}. ${icone} ${item.nome}</span><span>${item.contagem}</span></div>`;
        });

    } catch (e) { 
        container.innerHTML = '<p>Erro ao carregar ranking.</p>'; 
        console.error(e);
    }
}


function obterIconeMaiorConquista(conquistas, tipo) {
    if (!conquistas || conquistas.length === 0) return '';
    const definicoes = tipo === 'cliente' ? conquistasDefinidas.cliente : conquistasDefinidas.profissional;
    let maiorLevel = -1;
    let melhorIcone = '';
    for (const id of conquistas) {
        if (definicoes[id] && definicoes[id].level > maiorLevel) {
            maiorLevel = definicoes[id].level;
            melhorIcone = definicoes[id].icone;
        }
    }
    return maiorLevel > -1 ? `<span class="chat-medal">${melhorIcone}</span>` : '';
}

async function abrirModalDashboardBarbeiro() {
    abrirModal('modalDashboardBarbeiro');
    const container = document.getElementById('dashboardConteudo');
    container.innerHTML = '<p>Calculando...</p>';
    try {
        const agora = new Date();
        const trintaDiasAtras = new Date(new Date().setDate(agora.getDate() - 30));
        
        const snap = await db.collection('agendamentos')
            .where('barbeiroUid', '==', auth.currentUser.uid)
            .get();

        let faturamentoTotal = 0, faturamento30d = 0;
        let concluidosTotal = 0, canceladosTotal = 0;
        const clientes = new Set();
        const servicos = {};
        
        snap.forEach(doc => {
            const ag = doc.data();
            clientes.add(ag.clienteUid);
            
            if(ag.status === 'concluido'){
                concluidosTotal++;
                faturamentoTotal += ag.valor;
                servicos[ag.servico] = (servicos[ag.servico] || 0) + 1;
                if(ag.ts.toDate() > trintaDiasAtras){
                    faturamento30d += ag.valor;
                }
            } else if (ag.status === 'cancelado'){
                canceladosTotal++;
            }
        });
        
        const taxaCancelamento = (concluidosTotal + canceladosTotal) > 0 ? ((canceladosTotal / (concluidosTotal + canceladosTotal)) * 100).toFixed(1) : 0;
        const popular = Object.entries(servicos).sort((a, b) => b[1] - a[1])[0]?.[0] || "N/A";
        const mediaAvaliacoes = perfil.numAvaliacoes > 0 ? (perfil.somaAvaliacoes / perfil.numAvaliacoes).toFixed(1) : "N/A";

        const servicosHtml = Object.entries(servicos).sort((a,b) => b[1] - a[1]).map(([nome, qtde]) => `<p>${nome}: <b>${qtde}</b></p>`).join('');

        container.innerHTML = `
            <div class="popup-section"><h4>Visão Geral</h4>
                <p>⭐ Avaliação Média: <b>${mediaAvaliacoes} / 10</b> (${perfil.numAvaliacoes} avaliações)</p>
                <p>🧑‍🤝‍🧑 Clientes Únicos: <b>${clientes.size}</b></p>
                <p>📈 Serviços Concluídos: <b>${concluidosTotal}</b></p>
                <p>❌ Taxa de Cancelamento: <b>${taxaCancelamento}%</b></p>
            </div>
            <div class="popup-section"><h4>💰 Financeiro</h4>
                <p>Faturamento Total: <b>R$ ${faturamentoTotal.toFixed(2)}</b></p>
                <p>Faturamento (Últimos 30 dias): <b>R$ ${faturamento30d.toFixed(2)}</b></p>
            </div>
            <div class="popup-section"><h4>✂️ Serviços</h4>
                <p>Serviço Mais Popular: <b>${popular}</b></p>
                ${servicosHtml}
            </div>
        `;
    } catch (e) { 
        container.innerHTML = '<p>Erro ao carregar dados.</p>'; 
        console.error("Erro no dashboard do profissional:", e);
    }
}

async function abrirModalPortfolioBarbeiro() {
    abrirModal('modalPortfolioBarbeiro');
    
    // Cancela o listener anterior se ele estiver ativo
    if (portfolioListener) {
        portfolioListener();
        portfolioListener = null;
    }

    imagensMarcadasParaExcluir = [];

    // --- INÍCIO DA MODIFICAÇÃO (Task 2) ---
    // Aguarda o carregamento inicial (get()) antes de continuar
    // Isso garante que o 'perfil' esteja atualizado
    await carregarPortfolioExistente();
    // --- FIM DA MODIFICAÇÃO ---

    // --- Configuração do Input de Novos Arquivos ---
    const fileInput = document.getElementById('portfolioFilesInput');
    const previewContainer = document.getElementById('portfolioPreviews');
    const progressBar = document.getElementById('portfolioUploadProgress');
    const btnSalvar = document.getElementById('btnSalvarPortfolio');

    // Limpa seleções anteriores do input e previews
    fileInput.value = '';
    previewContainer.innerHTML = '';
    progressBar.style.display = 'none';
    progressBar.value = 0;

    // Remove listener antigo para evitar duplicação
    fileInput.onchange = null;

    // Adiciona novo listener para preview e habilita/desabilita botão
    fileInput.onchange = () => {
        previewContainer.innerHTML = ''; // Limpa previews antigos
        const files = fileInput.files;
        
        // Usa 'perfil' que é atualizado pelo listener/get
        const portfolioAtual = (perfil?.portfolio || []).length; 
        const imagensMarcadas = imagensMarcadasParaExcluir.length;
        // Calcula o espaço baseado em quantas imagens VÃO SOBRAR
        const espacoDisponivel = 30 - (portfolioAtual - imagensMarcadas);

        if (files.length > 0) {
            if (files.length > espacoDisponivel) {
                exibirPopup('Limite Excedido', `Você pode adicionar no máximo mais ${espacoDisponivel} imagens (total de 30).`);
                fileInput.value = ''; // Limpa a seleção inválida
                btnSalvar.disabled = true; // Mantém desabilitado
                return;
            }

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.width = '60px';
                    img.style.height = '60px';
                    img.style.objectFit = 'cover';
                    img.style.borderRadius = '4px';
                    previewContainer.appendChild(img);
                }
                reader.readAsDataURL(file);
            });
            btnSalvar.disabled = false; // Habilita o botão se houver arquivos válidos
        } else {
            // Habilita salvar se houver apenas exclusões
            btnSalvar.disabled = imagensMarcadasParaExcluir.length === 0;
        }
    };

    // Atualiza o estado do contador e do input (caso já tenha 30 imagens)
    atualizarContadorEInputPortfolio();
}

// 2. ADICIONE ESTA NOVA FUNÇÃO (Função de ajuda)
function atualizarContadorEInputPortfolio() {
    // Garante que está lendo o 'perfil' mais recente
    const portfolioUrls = perfil?.portfolio || [];
    const contadorElement = document.getElementById('portfolioContador');
    const fileInput = document.getElementById('portfolioFilesInput');
    const labelFileInput = document.getElementById('labelPortfolioFiles');
    const btnSalvarPortfolio = document.getElementById('btnSalvarPortfolio');

    // Calcula quantas imagens "contam" (total - marcadas para excluir)
    const imagensAtuaisContagem = portfolioUrls.length - imagensMarcadasParaExcluir.length;
    if (contadorElement) {
         contadorElement.textContent = imagensAtuaisContagem;
    }

    const espacoDisponivel = 30 - imagensAtuaisContagem;
    if (fileInput && labelFileInput) {
        fileInput.disabled = espacoDisponivel <= 0;
        labelFileInput.textContent = espacoDisponivel <= 0
            ? "Limite de 30 imagens atingido."
            : `Adicionar Novas Imagens (${espacoDisponivel} restantes)`;
        
        // Se o espaço for 0, limpa qualquer seleção de arquivo
        if (espacoDisponivel <= 0) {
            fileInput.value = ''; 
            document.getElementById('portfolioPreviews').innerHTML = ''; // Limpa previews de novas
        }
    }
    
    if(btnSalvarPortfolio) {
         const novosArquivosSelecionados = fileInput.files && fileInput.files.length > 0;
         // O botão só fica desabilitado se NÃO houver novos arquivos E NÃO houver exclusões marcadas
         btnSalvarPortfolio.disabled = (!novosArquivosSelecionados && imagensMarcadasParaExcluir.length === 0);
    }
}

// Esta função substitui 'salvarNovasImagensPortfolio' e 'removerImagemPortfolio'
async function salvarAlteracoesPortfolio() {
    const fileInput = document.getElementById("portfolioFilesInput");
    const progressBar = document.getElementById('portfolioUploadProgress');
    const btnSalvar = document.getElementById('btnSalvarPortfolio');
    const userId = auth.currentUser.uid;
    const files = fileInput.files;

    // Pega imagens existentes que serão mantidas
    const portfolioAtual = perfil?.portfolio || [];
    const imagensExistentesParaManter = portfolioAtual.filter(url => !imagensMarcadasParaExcluir.includes(url));
    
    // Pega as imagens a serem deletadas (que já estão em `imagensMarcadasParaExcluir`)

    // Calcula o total final
    const totalImagensFinais = imagensExistentesParaManter.length + (files ? files.length : 0);
    
    // Validações
    if (totalImagensFinais > 30) {
        return exibirPopup(`O limite é 30 imagens. Você está tentando salvar ${totalImagensFinais}.`);
    }
    if (files.length === 0 && imagensMarcadasParaExcluir.length === 0) {
        // Se o botão estava habilitado (por ex, marcou e desmarcou), mas não há mudanças, apenas avise.
        btnSalvar.disabled = true; // Desabilita de novo
        return exibirPopup("Nenhuma alteração detectada.", "Nenhuma imagem nova selecionada ou marcada para exclusão.");
    }
    if (totalImagensFinais === 0 && (files.length > 0 || imagensMarcadasParaExcluir.length > 0)) {
       // Se o usuário está intencionalmente limpando o portfólio (0 imagens), permita.
       console.log("Usuário está limpando o portfólio.");
    }


    exibirAguarde("Salvando alterações no portfólio...");
    btnSalvar.disabled = true;
    progressBar.style.display = 'block';
    progressBar.value = 0;

    const uploadPromises = [];
    const newImageUrls = [];
    let totalBytesUpload = 0;
    const uploadTasksInfo = [];

    // --- 1. Upload de Novas Imagens ---
    if (files && files.length > 0) {
        totalBytesUpload = Array.from(files).reduce((acc, file) => acc + file.size, 0);
        Array.from(files).forEach((file, index) => {
            const filePath = `portfolio/${userId}/${Date.now()}_${index}_${file.name}`;
            const uploadPromise = new Promise((resolve, reject) => {
                const storageRef = storage.ref(filePath);
                const uploadTask = storageRef.put(file);
                const taskInfo = { task: uploadTask, bytesTransferred: 0 };
                uploadTasksInfo.push(taskInfo);

                uploadTask.on('state_changed',
                    (snapshot) => {
                        taskInfo.bytesTransferred = snapshot.bytesTransferred;
                        let totalBytesTransferidosAcumulados = uploadTasksInfo.reduce((acc, info) => acc + info.bytesTransferred, 0);
                        const progress = totalBytesUpload > 0 ? (totalBytesTransferidosAcumulados / totalBytesUpload) * 100 : 0;
                        progressBar.value = progress;
                    },
                    (error) => reject(error),
                    async () => {
                        try {
                            const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                            newImageUrls.push(downloadURL); // Adiciona a nova URL
                            resolve();
                        } catch(urlError) { reject(urlError); }
                    }
                );
            });
            uploadPromises.push(uploadPromise);
        });
    }

    try {
        // Espera todos os uploads terminarem
        await Promise.all(uploadPromises);

        // --- 2. Deletar Imagens Marcadas do Storage ---
        const deletePromises = imagensMarcadasParaExcluir.map(async url => {
            try {
                const imageRef = storage.refFromURL(url);
                await imageRef.delete();
                console.log("Imagem marcada deletada do Storage:", url);
            } catch (e) {
                console.warn("Erro ao deletar imagem marcada do Storage (pode já ter sido removida):", e.message, url);
                if (e.code !== 'storage/object-not-found') {
                     notifyAdmins("⚠️ Falha ao deletar (Portfólio)", `Não foi possível deletar a imagem ${url} do Storage ao ser removida por ${perfil.nome}. Erro: ${e.code}`);
                }
            }
        });
        await Promise.all(deletePromises); // Espera as exclusões terminarem

        // --- 3. Atualizar Firestore ---
        // Combina imagens existentes mantidas com as novas
        const finalImageUrls = [...imagensExistentesParaManter, ...newImageUrls];

        await db.collection('usuarios').doc(userId).update({
            portfolio: finalImageUrls // Salva o array final
        });
        
perfil = (await db.collection('usuarios').doc(userId).get()).data();

        // --- 4. Limpeza e Feedback ---
        fecharTodosOsModais(); // Fecha o "Aguarde"
        exibirPopup('Sucesso!', 'Seu portfólio foi atualizado.');

        // Limpa os campos do formulário
        fileInput.value = '';
        document.getElementById('portfolioPreviews').innerHTML = '';
        progressBar.style.display = 'none';
        btnSalvar.disabled = true;
        imagensMarcadasParaExcluir = []; // Limpa o array global

        // O listener onSnapshot em 'carregarPortfolioExistente'
        // irá recarregar a grid de imagens existentes automaticamente.
        
        // --- ADIÇÃO PARA FLUXO PÓS-CADASTRO ---
        if (fluxoPosCadastroAtivo) {
             fecharModalAtual(); // Fecha o modal de portfólio
             // Verifica se realmente adicionou imagens antes de prosseguir
             const perfilAtualizado = (await db.collection('usuarios').doc(userId).get()).data();
             if (perfilAtualizado.portfolio && perfilAtualizado.portfolio.length > 0) {
                  abrirModalComConfirmacao('modalAddPromocao', '🎁 Adicionar Promoção (Opcional)'); // Abre promoção
             } else {
                  exibirPopup("Portfólio Obrigatório", "Você precisa adicionar pelo menos uma imagem ao seu portfólio para continuar.");
                  abrirModalComConfirmacao('modalPortfolioBarbeiro', '🖼️ Adicionar ao Portfólio'); // Reabre portfólio
             }
         } else {
              // Comportamento normal: não precisa fechar, pois fecharTodosOsModais já fechou
         }
        // --- FIM DA ADIÇÃO ---


    } catch (error) {
        fecharTodosOsModais();
        exibirPopup('Erro ao salvar portfólio: ' + (error.message || error));
        btnSalvar.disabled = false; // Reabilita o botão em caso de erro
        progressBar.style.display = 'none';
    }
}

async function carregarPortfolioExistente() {
    const gridContainer = document.getElementById('portfolioExistenteGrid');
    gridContainer.innerHTML = '<p>Carregando...</p>'; // Feedback inicial

    // Cancela o listener anterior, se existir
    if (portfolioListener) {
        portfolioListener();
        portfolioListener = null;
    }
    
    const docRef = db.collection('usuarios').doc(auth.currentUser.uid);

    try {
        // 1. FAZ UM GET PRIMEIRO PARA CARGA RÁPIDA E SINCRONIZAÇÃO
        const doc = await docRef.get();
        if (doc.exists) {
            perfil = doc.data(); // ATUALIZA O PERFIL GLOBAL IMEDIATAMENTE
            renderizarGridPortfolio(doc.data()); // Renderiza a grid com os dados do get()
        } else {
            gridContainer.innerHTML = '<p style="color: red;">Erro: Perfil não encontrado.</p>';
        }
    } catch (getError) {
         console.error("Erro ao fazer 'get' do portfólio:", getError);
         gridContainer.innerHTML = `<p style="color: red;">Erro ao carregar: ${getError.message}</p>`;
    }

    // 2. AGORA, ANEXA O LISTENER para atualizações em tempo real
    portfolioListener = docRef.onSnapshot(doc => {
        const modalPortfolio = document.getElementById('modalPortfolioBarbeiro');
        // Se o modal não estiver aberto ou o doc não existir, cancela o listener
        if (!doc.exists || !modalPortfolio || !modalPortfolio.classList.contains('show')) {
            if (portfolioListener) {
                portfolioListener(); // Cancela o listener
                portfolioListener = null;
            }
            return;
        }
        
        perfil = doc.data(); // Atualiza o perfil global
        renderizarGridPortfolio(doc.data()); // Re-renderiza a grid com novos dados
        atualizarContadorEInputPortfolio(); // Atualiza o contador/input

    }, error => {
        console.error("Erro ao ouvir updates do portfólio:", error);
        gridContainer.innerHTML = '<p style="color: red;">Erro ao carregar portfólio.</p>';
    });
}

function renderizarGridPortfolio(perfilData) {
    const gridContainer = document.getElementById('portfolioExistenteGrid');
    const portfolioUrls = perfilData?.portfolio || [];
    
    gridContainer.innerHTML = ''; // Limpa o container

    if (portfolioUrls.length === 0) {
        gridContainer.innerHTML = '<p style="text-align: center; opacity: 0.7;">Nenhuma imagem no portfólio ainda.</p>';
        return;
    }

    portfolioUrls.forEach(url => {
        const imgContainer = document.createElement('div');
        imgContainer.style.position = 'relative'; 
        imgContainer.dataset.url = url; // Guarda a URL no elemento

        const imgElement = document.createElement('img');
        imgElement.src = url;
        imgElement.alt = 'Imagem do Portfólio';
        imgElement.style.width = '100%';
        imgElement.style.height = '100px';
        imgElement.style.objectFit = 'cover';
        imgElement.style.borderRadius = '4px';
        imgElement.style.border = '1px solid var(--cor-borda)';
        imgElement.onerror = function() {
            this.src='https://via.placeholder.com/100x100?text=Erro!';
            const deleteBtn = this.nextElementSibling;
            if(deleteBtn) deleteBtn.remove();
        };

        const deleteButton = document.createElement('button');
        deleteButton.textContent = '❌';
        deleteButton.style.position = 'absolute';
        deleteButton.style.top = '2px';
        deleteButton.style.right = '2px';
        deleteButton.style.background = 'rgba(0,0,0,0.7)';
        deleteButton.style.color = 'white';
        deleteButton.style.border = 'none';
        deleteButton.style.borderRadius = '50%';
        deleteButton.style.width = '20px';
        deleteButton.style.height = '20px';
        deleteButton.style.fontSize = '10px';
        deleteButton.style.lineHeight = '20px'; 
        deleteButton.style.textAlign = 'center';
        deleteButton.style.padding = '0';
        deleteButton.style.cursor = 'pointer';
        deleteButton.title = 'Remover Imagem';

        deleteButton.onclick = (e) => {
            e.stopPropagation();
            marcarImagemPortfolioParaExcluir(deleteButton, url); // Chama a função de "marcar"
        };

        imgContainer.appendChild(imgElement);
        imgContainer.appendChild(deleteButton);
        gridContainer.appendChild(imgContainer);

        // Re-aplica o estilo de "marcado" se a imagem estiver na lista global de exclusão
        if (imagensMarcadasParaExcluir.includes(url)) {
             imgContainer.classList.add('marcada-para-excluir');
             deleteButton.textContent = '↩️';
             deleteButton.title = 'Manter Imagem';
             imgElement.style.opacity = '0.5';
             imgElement.style.border = '2px solid red';
        }
    });
}

async function enviarEmailDeContato() {
    const userEmail = perfil ? perfil.email : prompt("Seu email para resposta:");
    const message = prompt("Sua mensagem:");
    if (!userEmail || !message) return;

    exibirAguarde("Enviando mensagem...");
    try {
        const sendEmailFunction = firebase.functions().httpsCallable('sendContactEmail');
        const result = await sendEmailFunction({ email: userEmail, message: message });
        fecharTodosOsModais();
        exibirPopup("Sucesso", result.data.message);
    } catch (error) {
        fecharTodosOsModais();
        console.error("Erro ao chamar função de email:", error);
        exibirPopup("Erro", error.message);
    }
}
// No HTML, o link do email chamaria essa função:
// <a href="#" onclick="enviarEmailDeContato()">...</a>

function abrirModalFidelidade() {
  const pontosDisplay = document.getElementById("pontosFidelidade");
  if (perfil && pontosDisplay) {
    pontosDisplay.textContent = perfil.pontosFidelidade || 0;
  }
  abrirModal('modalFidelidade');
}

async function abrirPortfolioCliente(barbeiroUid, barbeiroNome) {
    const doc = await db.collection('usuarios').doc(barbeiroUid).get();
    if (!doc.exists) return;
    const portfolio = doc.data().portfolio || [];
    
    const grid = document.getElementById('portfolioClienteGrid');
    grid.innerHTML = '';
    document.getElementById('portfolioClienteNome').textContent = `🖼️ Portfólio de ${barbeiroNome}`;
    
    if (portfolio.length > 0) {
        portfolio.forEach(url => {
            grid.innerHTML += `<img src="${url}" alt="Foto do portfólio" onerror="this.src='https://via.placeholder.com/150?text=Erro'">`;
        });
    } else {
        grid.innerHTML = '<p>Este profissional ainda não adicionou imagens ao portfólio.</p>';
    }
    
    abrirModal('modalPortfolioCliente');
}

function calcularDistancia(lat1, lon1, lat2, lon2) {
    const R = 6371; // Raio da Terra em km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c; // Distância em km
}

function obterLocalizacaoAtual() {
    return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
            return reject(new Error("Geolocalização não suportada."));
        }
        navigator.geolocation.getCurrentPosition(
            (position) => {
                localizacaoCliente = {
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude,
                };
                resolve(localizacaoCliente);
            },
            (error) => {
                console.warn("Não foi possível obter a localização: ", error.message);
                reject(error);
            }
        );
    });
}

function obterLocalizacaoCadastro() {
    const btn = document.getElementById('btnLocalizacaoCadastro');
    if(btn) btn.textContent = '⏳ Obtendo localização...';
    if (!navigator.geolocation) {
        exibirPopup("Geolocalização não é suportada pelo seu navegador.");
        if(btn) btn.textContent = '📍 Usar minha localização atual';
        return;
    }
    navigator.geolocation.getCurrentPosition(
        (position) => {
            cadastroCoords = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
            };
            
            if(btn) btn.textContent = '✅ Localização Obtida!';
        },
        (error) => {
            exibirPopup("Não foi possível obter a localização. Por favor, verifique as permissões no seu navegador.");
            if(btn) btn.textContent = '📍 Usar minha localização atual';
        }
    );
}

function abrirRota(barbeiroLat, barbeiroLon) {
    if (localizacaoCliente) {
        window.open(`https://www.google.com/maps/dir/?api=1&origin=${localizacaoCliente.latitude},${localizacaoCliente.longitude}&destination=${barbeiroLat},${barbeiroLon}`, '_blank');
    } else {
        window.open(`https://www.google.com/maps/search/?api=1&query=${barbeiroLat},${barbeiroLon}`, '_blank');
    }
}

function abrirModalTurbinar(){
    abrirModal('modalTurbinar');
}

function togglePasswordVisibility(inputId, iconElement) {
    const input = document.getElementById(inputId);
    if (!input || !iconElement) return; // Adiciona verificação
    if (input.type === "password") {
        input.type = "text";
        iconElement.textContent = '🙈';
    } else {
        input.type = "password";
        iconElement.textContent = '👁️';
    }
}

function abrirModalAlterarSenha() {
    // Limpa os campos ao abrir
    document.getElementById('senhaAtual').value = '';
    document.getElementById('novaSenha').value = '';
    document.getElementById('confirmarNovaSenha').value = '';
    // Garante que comecem como password
    document.getElementById('senhaAtual').type = 'password';
    document.getElementById('novaSenha').type = 'password';
    document.getElementById('confirmarNovaSenha').type = 'password';
    document.querySelectorAll('#modalAlterarSenha .show-password-toggle').forEach(el => el.textContent = '👁️'); // Seleciona ícones específicos deste modal

    abrirModal('modalAlterarSenha');
}

// 1. Verificar Acesso ao Balão (Inclui lógica de PRÊMIO TEMPORÁRIO DA ROLETA)
function verificarAcessoBalao(key) {
    const b = BALOES[key];
    const meusBaloes = perfil.baloesAdquiridos || [];
    
    if (b.adminOnly) {
        return perfil.tipo === 'admin' ? { acesso: true, tipo: 'permanente' } : { acesso: false, tipo: 'bloqueado_admin' };
    }
    if (meusBaloes.includes(key)) return { acesso: true, tipo: 'permanente' };

    // VERIFICAÇÃO CORRETA DO PRÊMIO
    if (perfil.premiosTemporarios && perfil.premiosTemporarios[`balao_${key}`]) {
        const validade = perfil.premiosTemporarios[`balao_${key}`].toDate();
        if (validade > new Date()) return { acesso: true, tipo: 'temporario_roleta', validade };
    }
    
    if (isProAtivo(perfil) && perfil.proTier) {
        // ... (lógica pro mantida) ...
         const tier = perfil.proTier;
         const niveis = ['tier1', 'tier2', 'tier3', 'tier4'];
         const baloesOrdem = ['bronze', 'prata', 'ouro', 'diamante'];
         if (niveis.indexOf(tier) >= baloesOrdem.indexOf(key) && niveis.indexOf(tier) > -1) {
             return { acesso: true, tipo: 'temporario_pro' };
         }
    }
    return { acesso: false, tipo: 'nenhum' };
}

// 2. Renderizar Lista de Balões (Chame isso dentro de abrirModalPerfil)
function renderizarBaloes() {
    const container = document.getElementById('listaBaloes');
    if (!container) return;
    
    container.innerHTML = '';
    
    Object.keys(BALOES).forEach(key => {
        const b = BALOES[key];
        
        // Filtro de Admin (não mostra se não for admin)
        if (b.adminOnly && perfil.tipo !== 'admin') return;

        const selecionado = perfil.balaoSelecionado === key;
        const statusAcesso = verificarAcessoBalao(key);
        
        const checkDisplay = selecionado ? 'flex' : 'none';
        let rodapeHtml = '';
        let estiloBorda = '';

        // Lógica de visualização do status
        if (statusAcesso.tipo === 'permanente') {
            const texto = b.adminOnly ? 'Exclusivo' : 'Adquirido';
            rodapeHtml = `<span style="font-size:10px; color:#4CAF50; margin-top:2px;">${texto}</span>`;
            estiloBorda = selecionado ? '' : 'border-color: #4CAF50;'; 
        } 
        else if (statusAcesso.tipo === 'temporario_pro') {
            rodapeHtml = `<span style="font-size:9px; color:#00c6ff;">Liberado PRO</span>`;
            estiloBorda = selecionado ? '' : 'border-color: #00c6ff;';
        } 
        else if (statusAcesso.tipo === 'temporario_roleta') {
            // --- CORREÇÃO AQUI ---
            // Antes estava calculando horas fixas. Agora usa o sistema de timer em tempo real.
            const ts = statusAcesso.validade.getTime();
            rodapeHtml = `<span class="contador-tempo-real" data-expire="${ts}" style="font-size:9px; color:#e57373; font-weight:bold;">Calculando...</span>`;
            estiloBorda = 'border-color: #e57373;';
        } 
        else {
            rodapeHtml = `<span style="font-size:10px; color:#ff9800; background:rgba(0,0,0,0.5); padding:2px 6px; border-radius:4px; margin-top:2px;">R$${b.preco}</span>`;
            estiloBorda = 'opacity: 0.7;';
        }

        // Preview Visual do Balão dentro da loja
        const previewHtml = `
            <div class="chat-message ${b.classe} custom-bubble" style="width: 60px; height: 40px; display:flex; align-items:center; justify-content:center; font-size:10px; margin-bottom:5px;">
                Abc
            </div>
        `;

        container.innerHTML += `
            <div id="balao_${key}" class="moldura-item ${selecionada ? 'selecionada' : ''}" 
                 onclick="gerenciarBalao('${key}', this)" 
                 style="flex: 0 0 auto; width: 90px; display:flex; flex-direction:column; align-items:center; position:relative; cursor:pointer; margin: 0; ${estiloBorda}"> 
                 
                <div class="moldura-check" style="display: ${checkDisplay}; right: 10px;">✅</div>
                ${previewHtml}
                <span style="font-size:11px; font-weight:bold; color: #fff;">${b.nome}</span>
                ${rodapeHtml}
            </div>`;
    });
}

// 3. Gerenciar Clique no Balão
async function gerenciarBalao(key, element) {
    const b = BALOES[key];
    const statusAcesso = verificarAcessoBalao(key);
    
    // Se já tem (seja permanente, pro ou roleta), equipa direto
    if (statusAcesso.acesso) {
        selecionarMolduraVisualmente(element); // Reusa a função visual das molduras
        try {
            await db.collection('usuarios').doc(auth.currentUser.uid).update({ balaoSelecionado: key });
        } catch (e) { exibirPopup("Erro ao salvar."); }
        return;
    }

    // Se não tem, compra
    executarCompraBalao(key, b);
}

// 4. Compra de Balão
function executarCompraBalao(key, b) {
    if (perfil.saldo < b.preco) {
        return exibirPopup("Saldo insuficiente", "Deposite fundos para comprar este estilo.", "aviso", () => abrirModal('modalCarteira'));
    }
    
    exibirConfirmacao(
        "Comprar Estilo de Chat?", 
        `Deseja adquirir "${b.nome}" VITALÍCIO por R$ ${b.preco.toFixed(2)}?`, 
        () => {
            exibirAguarde("Comprando...");
            db.collection('usuarios').doc(auth.currentUser.uid).update({
                saldo: firebase.firestore.FieldValue.increment(-b.preco),
                baloesAdquiridos: firebase.firestore.FieldValue.arrayUnion(key),
                balaoSelecionado: key
            }).then(() => {
                fecharTodosOsModais();
                exibirPopup("Sucesso!", "Estilo de chat adquirido!", "sucesso", () => abrirModalPerfil());
            }).catch(e => {
                fecharTodosOsModais();
                exibirPopup("Erro na compra: " + e.message);
            });
        }
    );
}

async function executarAlteracaoSenha() {
    const senhaAtual = document.getElementById('senhaAtual').value;
    const novaSenha = document.getElementById('novaSenha').value;
    const confirmarNovaSenha = document.getElementById('confirmarNovaSenha').value;

    if (!senhaAtual || !novaSenha || !confirmarNovaSenha) {
        return exibirPopup("Preencha todos os campos.");
    }
    if (novaSenha.length < 6) {
        return exibirPopup("A nova senha deve ter pelo menos 6 caracteres.");
    }
    if (novaSenha !== confirmarNovaSenha) {
        return exibirPopup("As novas senhas não coincidem.");
    }

    exibirAguarde("Verificando senha atual...");
    const user = auth.currentUser;
    if (!user) { // Adiciona verificação de usuário
        fecharTodosOsModais();
        exibirPopup("Erro: Usuário não está logado.");
        mostrar('authView');
        return;
    }
    const credential = firebase.auth.EmailAuthProvider.credential(user.email, senhaAtual);

    try {
        await user.reauthenticateWithCredential(credential);
        // Reautenticação bem-sucedida, agora atualiza a senha
        exibirAguarde("Atualizando senha..."); // Atualiza texto do popup
        await user.updatePassword(novaSenha);
        fecharTodosOsModais();
        exibirPopup("✅ Senha alterada com sucesso!");
        fecharModalAtual(); // Fecha o modal de alterar senha
    } catch (error) {
        fecharTodosOsModais();
        console.error("Erro ao alterar senha:", error);
        if (error.code === 'auth/wrong-password') {
            exibirPopup("❌ Senha atual incorreta. Tente novamente.");
        } else if (error.code === 'auth/too-many-requests') {
             exibirPopup("❌ Muitas tentativas incorretas. Tente novamente mais tarde.");
        } else {
            exibirPopup("❌ Erro ao alterar senha: " + error.message);
        }
    }
}

async function solicitarAlteracaoCidade() {
    if (!perfil) return exibirPopup("Erro", "Não foi possível carregar seu perfil.");

    // Limpa os inputs ao abrir
    document.getElementById('novoEstadoInput').value = '';
    document.getElementById('novoCidadeInput').value = '';

    abrirModal('modalAlterarCidadeInputs');
}

// Função chamada pelo botão "Confirmar" do modal de inputs
function processarInputsCidade() {
    const novoEstadoInput = document.getElementById('novoEstadoInput').value.trim();
    const novaCidadeInput = document.getElementById('novoCidadeInput').value.trim();

    if (!novoEstadoInput || !novaCidadeInput) {
        // Mostra erro dentro do modal ou usa exibirPopup
        exibirPopup("Atenção", "Por favor, preencha o estado e a cidade.");
        return;
    }

    const novoEstadoFormatado = formatarNomeProprio(novoEstadoInput);
    const novaCidadeFormatada = formatarNomeProprio(novaCidadeInput);

    // Fecha o modal de inputs
    fecharModalAtual();

    // Abre o modal de confirmação
    document.getElementById('confirmCidadeEstadoTexto').textContent = `${novaCidadeFormatada} - ${novoEstadoFormatado}`;
    // Define a ação do botão "Sim" para chamar a função final com os dados corretos
    document.getElementById('btnSimConfirmarCidade').onclick = () => executarAlteracaoCidadeAposConfirmacao(novoEstadoFormatado, novaCidadeFormatada);
    abrirModal('modalConfirmarAlteracaoCidade');
}

// Função que executa a lógica principal após a confirmação
async function executarAlteracaoCidadeAposConfirmacao(novoEstadoFormatado, novaCidadeFormatada) {
    // Fecha o modal de confirmação
    fecharModalAtual();

    exibirAguarde("Criando solicitação...");
    try {
        const solicitacaoRef = db.collection("solicitacoes").doc();
        await solicitacaoRef.set({
            id: solicitacaoRef.id,
            tipo: "alteracao_cidade",
            usuarioUid: auth.currentUser.uid,
            usuarioNome: perfil.nome,
            cidadeAtual: perfil.cidade,
            estadoAtual: perfil.estado,
            novoEstadoSolicitado: novoEstadoFormatado,
            novaCidadeSolicitada: novaCidadeFormatada,
            status: "pendente",
            ts: firebase.firestore.FieldValue.serverTimestamp()
        });

        const mensagem = encodeURIComponent(`Olá! Gostaria de solicitar a alteração da minha cidade no app Nova Versão.\n\nUsuário: ${perfil.nome}\nCidade Atual: ${perfil.cidade} - ${perfil.estado}\nNova Cidade: ${novaCidadeFormatada} - ${novoEstadoFormatado}\n\nID da Solicitação: ${solicitacaoRef.id}`);
        const phoneNum = WHATSAPP_ADM_PHONE.startsWith('55') ? WHATSAPP_ADM_PHONE : `55${WHATSAPP_ADM_PHONE.replace(/\D/g, '')}`; // Garante formato E.164
        window.open(`https://wa.me/${phoneNum}?text=${mensagem}`, '_blank');

        fecharAguarde(null, true);
        exibirPopup("Sucesso", "Solicitação enviada! Você foi redirecionado para o WhatsApp.");
        notifyAdmins("🏙️ Alteração de Cidade", `${perfil.nome} solicitou alterar para ${novaCidadeFormatada} - ${novoEstadoFormatado} (ID: ${solicitacaoRef.id}).`, { link: '#solicitacoes' });
        // Não precisa fechar modal aqui, pois já foram fechados

    } catch (error) {
        fecharAguarde(null, true);
        console.error("Erro ao solicitar alteração de cidade:", error);
        exibirPopup("Erro", "Não foi possível criar a solicitação: " + error.message);
    }
}

let solicitacaoAtualId = null; // Variável global para guardar o ID da solicitação aberta
let solicitacaoAtualUid = null; // Variável global para guardar o UID do usuário da solicitação

async function abrirModalAdminCidade(id, s) {
  solicitacaoAtualId = id;
  solicitacaoAtualUid = s.usuarioUid;

  document.getElementById('adminCidadeNomeUsuario').textContent = s.usuarioNome;
  document.getElementById('adminCidadeAtual').textContent = `${s.cidadeAtual || 'N/A'} - ${s.estadoAtual || 'N/A'}`;

  // --- MODIFICATION START ---
  // Use the NEW unique IDs and prefix
  const estadoSelectId = 'adminNovoEstadoSolicitacao';
  const cidadeSelectId = 'adminNovoCidadeSolicitacao';
  const prefix = 'adminNovoSolicitacao'; // Define the correct prefix

  const estadoSelect = document.getElementById(estadoSelectId);
  const cidadeSelect = document.getElementById(cidadeSelectId);

  // Clear old city options
  cidadeSelect.innerHTML = '<option value="">Selecione o estado</option>';

  // Load states using the correct prefix
  carregarEstados(prefix);
  // Add a slight delay to ensure states are populated before setting value/loading cities
  setTimeout(() => {
    estadoSelect.value = s.estadoAtual || ""; // Set current state

    // Load cities for the selected state, using the correct prefix
    carregarCidades(prefix);
    // Add another delay to ensure cities are loaded before setting the value
    setTimeout(() => {
        // Set the current city if it exists in the loaded options
        if(cidadeSelect.querySelector(`option[value="${s.cidadeAtual}"]`)) {
            cidadeSelect.value = s.cidadeAtual;
        } else {
            cidadeSelect.value = ""; // Otherwise, default to "Select city"
        }
    }, 150); // Delay for city options loading
  }, 100); // Delay for state options loading
  // --- MODIFICATION END ---

  abrirModal('modalAdminDetalhesCidade');
}

/**
 * Faz upload de um arquivo para o Firebase Storage.
 * @param {File} file O arquivo a ser enviado.
 * @param {string} path O caminho no Storage (ex: 'logos/userId.jpg').
 * @param {function} [onProgress] Callback para progresso (opcional).
 * @returns {Promise<string>} A URL de download do arquivo.
 */
function uploadImage(file, path, onProgress) {
    return new Promise((resolve, reject) => {
        const storageRef = storage.ref(path);
        const uploadTask = storageRef.put(file);

        uploadTask.on('state_changed',
            (snapshot) => {
                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                console.log('Upload está ' + progress + '% concluído');
                if (onProgress) {
                    onProgress(progress); // Chama o callback de progresso
                }
            },
            (error) => {
                console.error("Erro no upload: ", error);
                reject(error);
            },
            () => {
                // Upload concluído com sucesso, pega a URL de download
                uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                    console.log('Arquivo disponível em', downloadURL);
                    resolve(downloadURL); // Retorna a URL
                }).catch(reject);
            }
        );
    });
}

async function aprovarAlteracaoCidade() {
    // Lê dos inputs corretos
    const novoEstadoInput = document.getElementById('adminNovoEstadoSolicitacao');
    const novaCidadeInput = document.getElementById('adminNovoCidadeSolicitacao');

    const novoEstado = formatarNomeProprio(novoEstadoInput.value.trim());
    const novaCidade = formatarNomeProprio(novaCidadeInput.value.trim());

    if (!novoEstado || !novaCidade) {
        return exibirPopup("Erro", "Digite o novo estado e cidade.");
    }

    if (!confirm(`Confirmar alteração para ${novaCidade} - ${novoEstado}?`)) return;

    exibirAguarde("Atualizando cidade...");
    try {
        await db.runTransaction(async t => {
            const userRef = db.collection("usuarios").doc(solicitacaoAtualUid);
            const solicitacaoRef = db.collection("solicitacoes").doc(solicitacaoAtualId);

            t.update(userRef, { estado: novoEstado, cidade: novaCidade });
            t.update(solicitacaoRef, { status: "aprovado", novoEstado: novoEstado, novaCidade: novaCidade });
        });

        fecharTodosOsModais(); // Fecha Aguarde e Modal Detalhes
        exibirPopup("Sucesso", "Cidade do usuário alterada!");
        notifyUser(solicitacaoAtualUid, "✅ Cidade Alterada!", `Sua cidade foi atualizada para ${novaCidade} - ${novoEstado}.`);

    } catch (error) {
        fecharTodosOsModais();
        console.error("Erro ao aprovar alteração de cidade:", error);
        exibirPopup("Erro", "Não foi possível aprovar a alteração: " + error.message);
    } finally {
        // Limpa as variáveis globais após a operação
        solicitacaoAtualId = null;
        solicitacaoAtualUid = null;
    }
}

// Função auxiliar para recusar a solicitação aberta no modal de cidade
function recusarSolicitacaoAtual() {
    if (solicitacaoAtualId && solicitacaoAtualUid) {
         // Usa popup de confirmação customizado se você tiver um, senão usa confirm
        if (confirm("Tem certeza que deseja recusar esta solicitação?")) {
            recusarSolicitacao(solicitacaoAtualId, solicitacaoAtualUid, 'alteracao_cidade');
            fecharModalAtual(); // Fecha o modal de detalhes da cidade
        }
    }
}

// Funções da Loja
function abrirModalParaVender() {
    if (perfil.lojaLiberada || perfil.tipo === 'admin') {
        abrirFormularioProduto();
    } else {
        abrirModal('modalLiberarLoja');
    }
}

function solicitarLiberacaoLoja() {
    const mensagem = encodeURIComponent(`Olá, gostaria de solicitar autorização para cadastrar produtos na loja. Meu nome de usuário é ${perfil.nome}.`);
    window.open(`https://wa.me/${WHATSAPP_ADM_PHONE}?text=${mensagem}`, '_blank');
    db.collection("solicitacoes").add({
        tipo: "liberacao_loja",
        usuarioUid: auth.currentUser.uid,
        usuarioNome: perfil.nome,
        status: "pendente",
        ts: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
        exibirPopup("Sua solicitação foi enviada ao administrador. Você será redirecionado para o WhatsApp para confirmar.");
        notifyAdmins("🛍️ Liberação de Loja", `${perfil.nome} quer permissão para vender.`, { link: '#solicitacoes' });
    }).catch(e => exibirPopup("Erro ao criar solicitação: " + e.message));
}

function aprovarLiberacaoLoja(solicitacaoId, uid) {
    db.runTransaction(async t => {
        t.update(db.collection("usuarios").doc(uid), { lojaLiberada: true });
        t.update(db.collection("solicitacoes").doc(solicitacaoId), { status: "aprovado" });
    }).then(() => {
        exibirPopup("Acesso à loja liberado!");
        notifyUser(uid, "🛍️ Acesso à Loja Liberado!", "Parabéns! Você já pode cadastrar seus produtos para vender no app.");
    }).catch(e => exibirPopup("Erro ao aprovar: " + e.message));
}

async function carregarProdutos() {
    const container = document.getElementById('lojaContainer');
    container.innerHTML = '<p>Carregando loja...</p>';

    try {
        const usersSnap = await db.collection('usuarios').get();
        const usersData = {};
        usersSnap.forEach(doc => { usersData[doc.id] = doc.data(); });

        const produtosSnap = await db.collection('loja_produtos').orderBy('ts', 'desc').get();
        
        let premiumHtml = ''; // HTML Exclusivo para Premium
        let officialHtml = '<h4 style="grid-column: 1 / -1;">⭐ Oficiais Nova Versão ⭐</h4>';
        let communityProducts = [];
        let officialProductsFound = false;

        produtosSnap.forEach(doc => {
            const produto = { ...doc.data(), id: doc.id };
            const produtoJSON = JSON.stringify(produto).replace(/'/g, "\\'");
            
            if (produto.isPremium) {
                // RENDERIZAÇÃO ESPECIAL PREMIUM
                const precoFinal = produto.desconto ? produto.preco * (1 - produto.desconto / 100) : produto.preco;
                const imgUrl = (produto.imageUrls && produto.imageUrls.length > 0) ? produto.imageUrls[0] : 'https://via.placeholder.com/250x250?text=Premium';
                
                premiumHtml += `
                <div class="produto-card produto-premium" onclick='handleProdutoClick(${produtoJSON})'>
                    <img src="${imgUrl}" style="height: 200px; object-fit: cover; border-bottom: 2px solid gold;">
                    <div class="produto-info">
                        <div class="produto-nome">🌟 ${produto.nome} 🌟</div>
                        <div class="produto-preco">R$ ${precoFinal.toFixed(2)}</div>
                        <p style="font-size: 10px; letter-spacing: 2px; margin-top: 5px;">EDICÃO LIMITADA</p>
                    </div>
                </div>`;
            } else if (produto.isOficial) {
                officialHtml += renderProdutoCard(produto, produtoJSON);
                officialProductsFound = true;
            } else {
                communityProducts.push({ data: produto, json: produtoJSON });
            }
        });

        if (!officialProductsFound) {
            officialHtml += '<p style="grid-column: 1 / -1; font-size: 14px; opacity: 0.7;">Nenhum produto oficial comum no momento.</p>';
        }

        const getUserScore = (uid) => {
            const user = usersData[uid];
            if (!user) return 0;
            if (isVipAtivo(user)) return 4;
            const isBoosted = user.boostExpiracao && user.boostExpiracao.toDate() > new Date();
            if (isBoosted) return 3;
            if (user.tipo !== 'cliente') return 2;
            return 1;
        };

        communityProducts.sort((a, b) => {
            const scoreA = getUserScore(a.data.vendedorUid);
            const scoreB = getUserScore(b.data.vendedorUid);
            return scoreB - scoreA;
        });

        let communityHtml = '<h4 style="grid-column: 1 / -1; margin-top: 20px;">🛒 Marketplace da Comunidade</h4>';
        if (communityProducts.length === 0) {
            communityHtml += '<p style="grid-column: 1 / -1;">Nenhum produto da comunidade ainda.</p>';
        } else {
            communityProducts.forEach(p => {
                communityHtml += renderProdutoCard(p.data, p.json);
            });
        }
        
        // ORDEM: PREMIUM -> OFICIAL -> COMUNIDADE
        container.innerHTML = premiumHtml + officialHtml + communityHtml;

    } catch (error) {
        console.error("Erro ao carregar produtos:", error);
        container.innerHTML = '<p>Ocorreu um erro ao carregar a loja.</p>';
    }
}

function renderProdutoCard(p, pJson) {
    const precoFinal = p.desconto ? p.preco * (1 - p.desconto / 100) : p.preco;
    const precoHtml = p.desconto ? `<span class="produto-preco-original">R$ ${p.preco.toFixed(2)}</span> R$ ${precoFinal.toFixed(2)}` : `R$ ${p.preco.toFixed(2)}`;
    // Usa a primeira imagem do array 'imageUrls' ou a 'imagemUrl' antiga, ou um placeholder
    const imageUrlPrincipal = (p.imageUrls && p.imageUrls.length > 0) ? p.imageUrls[0] : p.imagemUrl;
    const placeholder = 'https://via.placeholder.com/150x150?text=Nova+Versao'; // Placeholder atualizado

    return `
        <div class="produto-card" onclick='handleProdutoClick(${pJson})'>
            <img src="${imageUrlPrincipal || placeholder}" alt="${p.nome}" onerror="this.onerror=null; this.src='${placeholder}';">
            <div class="produto-info">
                <div class="produto-nome">${p.nome}</div>
                <div class="produto-preco">${precoHtml}</div>
            </div>
        </div>
    `;
}

async function exibirVersaoApp() {
    try {
        const response = await fetch('/index.html', { method: 'HEAD', cache: 'no-store' });
        const lastModified = response.headers.get('Last-Modified');
        if (lastModified) {
            const d = new Date(lastModified);
            const version = `V${d.getFullYear().toString().slice(-2)}.${(d.getMonth() + 1).toString().padStart(2, '0')}.${d.getDate().toString().padStart(2, '0')}.${d.getHours().toString().padStart(2, '0')}${d.getMinutes().toString().padStart(2, '0')}`;
            document.getElementById('appVersion').textContent = version;
        }
    } catch(e) {
        console.error("Erro ao obter nova versão do app:", e);
        document.getElementById('appVersion').textContent = 'V.Local';
    }
}

function recarregarSaldoDoUsuario() {
    exibirPopup("💰 Seu saldo foi atualizado! A interface irá refletir a mudança em instantes.");
}

if (firebase.messaging.isSupported()) {
    messaging.onMessage((payload) => {
        console.log('Mensagem de primeiro plano recebida:', payload);

        if (payload.data && payload.data.tipo === 'atualizar_saldo') {
            recarregarSaldoDoUsuario();
        }

        if (payload.notification) {
            const notificationTitle = payload.notification.title;
            const notificationOptions = {
                body: payload.notification.body,
                icon: payload.notification.icon || '/icone.png'
            };
            if (Notification.permission === 'granted') {
                new Notification(notificationTitle, notificationOptions);
            }
        }
    });
}

async function abrirDetalhesProduto(produto) {
    produtoParaCompra = { ...produto }; // Copia o produto para evitar modificações indesejadas
    const precoFinal = produto.desconto ? produto.preco * (1 - produto.desconto / 100) : produto.preco;

    // Carrega Imagens no Carrossel
    const imagensContainer = document.getElementById('detalhesProdutoImagensContainer');
    const indicadoresContainer = document.getElementById('detalhesProdutoImagensIndicadores');
    imagensContainer.innerHTML = ''; // Limpa container
    indicadoresContainer.innerHTML = ''; // Limpa indicadores
    const imageUrls = produto.imageUrls || (produto.imagemUrl ? [produto.imagemUrl] : []); // Compatibilidade
    const placeholder = 'https://via.placeholder.com/250x250?text=Nova+Versao'; // Placeholder atualizado

    if (imageUrls.length === 0) {
         imagensContainer.innerHTML = `<img src="${placeholder}" alt="Sem Imagem" style="width: 100%; height: 250px; object-fit: contain; scroll-snap-align: start; flex-shrink: 0;">`; // Adicionado flex-shrink
    } else {
        imageUrls.forEach((url, index) => {
            imagensContainer.innerHTML += `
                <img src="${url}" alt="Imagem ${index + 1} do Produto" style="width: 100%; height: 250px; object-fit: contain; scroll-snap-align: start; flex-shrink: 0;" onerror="this.onerror=null; this.src='${placeholder}';">`; // Adicionado flex-shrink
            // Adiciona indicador apenas se houver mais de uma imagem
            if (imageUrls.length > 1) {
                indicadoresContainer.innerHTML += `<span data-index="${index}" style="height: 8px; width: 8px; background-color: #bbb; border-radius: 50%; display: inline-block; margin: 0 3px; cursor: pointer; transition: background-color 0.3s ease;"></span>`;
            }
        });

        // Lógica dos indicadores (só executa se houver indicadores)
        if (imageUrls.length > 1) {
            const indicadores = indicadoresContainer.querySelectorAll('span');
            let scrollTimeout; // Para evitar múltiplos updates rápidos no scroll

            const updateIndicadores = () => {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => { // Debounce
                    const scrollLeft = imagensContainer.scrollLeft;
                    const imgWidth = imagensContainer.offsetWidth;
                    // Prevenção contra divisão por zero
                    const activeIndex = imgWidth > 0 ? Math.round(scrollLeft / imgWidth) : 0;
                    indicadores.forEach((span, index) => {
                        span.style.backgroundColor = index === activeIndex ? 'var(--cor-destaque)' : '#bbb';
                    });
                }, 50); // Atraso pequeno para debounce
            };


            // Atualiza na rolagem e ao clicar no indicador
            imagensContainer.onscroll = updateIndicadores;
            indicadores.forEach(span => {
                span.onclick = () => {
                    const index = parseInt(span.dataset.index);
                    imagensContainer.scrollTo({
                        left: index * imagensContainer.offsetWidth,
                        behavior: 'smooth'
                    });
                    // Atualiza imediatamente ao clicar
                     indicadores.forEach((s, i) => s.style.backgroundColor = i === index ? 'var(--cor-destaque)' : '#bbb');
                };
            });
            updateIndicadores(); // Atualiza na abertura inicial
        }
    }


    // Carrega outros detalhes
    document.getElementById('detalhesProdutoNome').textContent = produto.nome;
    document.getElementById('detalhesProdutoPreco').textContent = `R$ ${precoFinal.toFixed(2)}`;
    document.getElementById('detalhesProdutoDescricao').textContent = produto.descricao || 'Sem descrição.';

    // Carrega Tamanhos
    const tamanhosContainer = document.getElementById('detalhesProdutoTamanhos');
    tamanhosContainer.innerHTML = '';
    if (produto.tamanhos && produto.tamanhos.length > 0) {
        produto.tamanhos.forEach((t, index) => {
            tamanhosContainer.innerHTML += `<input type="radio" name="tamanho_selecionado" value="${t}" id="tamanho_${t}" ${index === 0 ? 'checked' : ''}><label for="tamanho_${t}">${t}</label>`;
        });
    } else {
        // Se não há tamanhos definidos, cria um input invisível com valor 'único'
        tamanhosContainer.innerHTML = '<input type="radio" name="tamanho_selecionado" value="único" id="tamanho_unico" checked style="display: none;"><label for="tamanho_unico">Tamanho único</label>';
    }

    // Carrega Avaliação
    const avaliacaoContainer = document.getElementById('detalhesProdutoAvaliacao');
    await carregarAvaliacaoProduto(produto.id, produto.nome, avaliacaoContainer);

    document.getElementById('btnComprarAgora').onclick = () => iniciarCompra(produto);
    abrirModal('modalProdutoDetalhes');
}


function iniciarCompra(produto) {
    const tamanhoSelecionado = document.querySelector('input[name="tamanho_selecionado"]:checked');
    if ((produto.tamanhos && produto.tamanhos.length > 0) && !tamanhoSelecionado) {
        return exibirPopup('Por favor, selecione um tamanho.');
    }
    produtoParaCompra.tamanhoSelecionado = tamanhoSelecionado ? tamanhoSelecionado.value : 'único';
    
    abrirModal('modalFormularioCompraLoja');
    document.getElementById('btnPagarCompraLoja').onclick = () => {
        const nome = document.getElementById('compraNomeCompleto').value;
        const cpf = document.getElementById('compraCpf').value;
        const telefone = document.getElementById('compraTelefone').value;
        const email = document.getElementById('compraEmail').value;
        const cep = document.getElementById('compraCep').value;
        const rua = document.getElementById('compraRua').value;
        const numero = document.getElementById('compraNumeroCasa').value;
        if (!nome || !cpf || !telefone || !email || !cep || !rua || !numero) {
            return exibirPopup('Todos os campos são obrigatórios.');
        }
        
        const precoFinal = produtoParaCompra.desconto ? produtoParaCompra.preco * (1 - produtoParaCompra.desconto / 100) : produtoParaCompra.preco;
        document.getElementById('valorDebito').textContent = precoFinal.toFixed(2);
        
        const overlay = document.getElementById('overlayPagamento');
        overlay.classList.remove('hidden');
        document.getElementById('btnNaoDebitar').onclick = () => overlay.classList.add('hidden');
        document.getElementById('btnSimDebitar').onclick = () => confirmarCompraLoja({ nome, cpf, telefone, email, cep, rua, numero });
    };
}

async function confirmarCompraLoja(dadosEntrega) {
    exibirAguarde("Processando seu pedido...");
    const produto = produtoParaCompra;
    const precoFinal = produto.desconto ? produto.preco * (1 - produto.desconto / 100) : produto.preco;

    // --- MODIFICATION START ---
    // Check balance first
    if (perfil.saldo < precoFinal) {
        fecharTodosOsModais(); // Close "Aguarde..." and the form modal
        exibirPopup('Saldo insuficiente. Por favor, deposite fundos na sua carteira.'); // Show popup
        abrirModal('modalCarteira'); // <<<--- ADDED: Open wallet modal
        return; // Stop the purchase process
    }
    // --- MODIFICATION END ---

    try {
        // Transaction only debits buyer now
        await db.runTransaction(async t => {
            const clienteRef = db.collection("usuarios").doc(auth.currentUser.uid);
            const produtoRef = db.collection("loja_produtos").doc(produto.id);

            // --- MODIFICATION START ---
            // Only debit the client at this stage
            t.update(clienteRef, { saldo: firebase.firestore.FieldValue.increment(-precoFinal) });
            // Seller and Admin balance updates REMOVED from here
            // --- MODIFICATION END ---

            t.update(produtoRef, { vendasRealizadas: firebase.firestore.FieldValue.increment(1) });

            // Create the order document
            t.set(db.collection("loja_pedidos").doc(), {
                produtoId: produto.id,
                produtoNome: produto.nome,
                valor: precoFinal, // Store the final price paid
                tamanho: produto.tamanhoSelecionado,
                clienteUid: auth.currentUser.uid,
                clienteNome: perfil.nome,
                endereco: `${dadosEntrega.rua}, ${dadosEntrega.numero}`,
                cpf: dadosEntrega.cpf,
                telefone: dadosEntrega.telefone,
                email: dadosEntrega.email,
                cep: dadosEntrega.cep,
                vendedorUid: produto.vendedorUid,
                vendedorNotificado: false, // For the initial sale notification popup
                status: "pendente", // Initial status: waiting for seller to deliver
                avaliado: false,
                ts: firebase.firestore.FieldValue.serverTimestamp()
            });
        });

        fecharTodosOsModais();
        exibirPopup("Pedido realizado com sucesso!");
        notifyUser(auth.currentUser.uid, '📦 Pedido Confirmado!', `Sua compra de "${produto.nome}" foi realizada.`, { link: '#minhascompras' });
        notifyUser(produto.vendedorUid, '🎉 Nova Venda!', `Você vendeu um(a) "${produto.nome}" para ${perfil.nome}. Verifique suas entregas.`, { link: '#entregas' });
        // No longer closing specific modals, fecharTodosOsModais handles it.

    } catch (e) {
        fecharTodosOsModais();
        exibirPopup('Erro ao processar a compra: ' + e.message);
    }
}

// Nova Função para Admin Adicionar Giros na Roleta
async function adminAdicionarGiros(uid) {
    const inputGiros = document.getElementById('adminInputGiros');
    const qtde = parseInt(inputGiros.value);

    if (isNaN(qtde) || qtde <= 0) {
        return exibirPopup("Valor inválido", "Digite uma quantidade válida de giros.");
    }

    if (!confirm(`Deseja adicionar ${qtde} giros extras para este usuário hoje?`)) return;

    exibirAguarde("Adicionando giros...");

    try {
        await db.collection('usuarios').doc(uid).update({
            girosRealizadosHoje: firebase.firestore.FieldValue.increment(-qtde),
            // Atualiza a data para garantir que o front entenda que é "hoje" e use o valor
            ultimoGiroRoleta: new Date().toDateString() 
        });

        fecharTodosOsModais();
        exibirPopup("Sucesso", `${qtde} giros adicionados!`);
        abrirModalGerenciarUsuario(uid); 
    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro", "Não foi possível adicionar giros: " + e.message);
    }
}

async function abrirGerenciarLoja() {
    abrirModal('modalGerenciarLoja');
    const container = document.getElementById('listaMeusProdutos');
    container.innerHTML = '<p>Carregando seus produtos...</p>';
    
    const snap = await db.collection('loja_produtos').where('vendedorUid', '==', auth.currentUser.uid).get();
    if (snap.empty) {
        container.innerHTML = '<p>Você ainda não tem produtos cadastrados.</p>';
        return;
    }
    
    container.innerHTML = '';
    snap.forEach(doc => {
        const p = doc.data();
        container.innerHTML += `
            <div class="card">
                <b>${p.nome}</b> - R$ ${p.preco.toFixed(2)}
                <p>Vendas: ${p.vendasRealizadas || 0}</p>
                <div style="display: flex; gap: 5px; margin-top: 5px;">
                    <button onclick="abrirFormularioProduto('${doc.id}')" style="font-size:12px; padding: 5px 8px;">✏️ Editar</button>
                    <button onclick="deletarProdutoVendedor('${doc.id}')" style="background: #c0392b; font-size:12px; padding: 5px 8px;">🗑️ Excluir</button>
                </div>
            </div>`;
    });
}

// Função auxiliar para marcar/desmarcar imagem de PRODUTO para exclusão
function marcarImagemProdutoParaExcluir(buttonElement, imageUrl) {
    const imgContainer = buttonElement.parentElement;
    const imgElement = imgContainer.querySelector('img');
    const isMarked = imgContainer.classList.toggle('marcada-para-excluir');
    const fileInput = document.getElementById('produtoFiles');
    const labelFileInput = document.getElementById('labelProdutoFiles');
    const contadorImagensElement = document.getElementById('produtoContadorImagens');

    if (isMarked) {
        imagensMarcadasParaExcluir.push(imageUrl); // Adiciona ao array de exclusão
        buttonElement.textContent = '↩️';
        buttonElement.title = 'Manter Imagem';
        imgElement.style.opacity = '0.5';
        imgElement.style.border = '2px solid red';
    } else {
        // Remove do array de exclusão
        imagensMarcadasParaExcluir = imagensMarcadasParaExcluir.filter(url => url !== imageUrl);
        buttonElement.textContent = '❌';
        buttonElement.title = 'Excluir Imagem';
        imgElement.style.opacity = '1';
        imgElement.style.border = 'none';
    }

     // Atualiza contador e estado do input de novas imagens
     const previewsExistentesContainer = document.getElementById('produtoPreviewsExistentes');
     const existingImagesTotal = previewsExistentesContainer.querySelectorAll('div[data-url]').length; // Total inicial
     const currentImageCount = existingImagesTotal - imagensMarcadasParaExcluir.length; // Quantas ficarão
     const allowedNew = 5 - currentImageCount;

     if (contadorImagensElement) contadorImagensElement.textContent = currentImageCount; // Atualiza o contador exibido

     if (allowedNew <= 0) {
         fileInput.disabled = true;
         fileInput.value = ''; // Limpa seleção se não pode adicionar mais
         document.getElementById('produtoPreviewsNovas').innerHTML = '';
         labelFileInput.textContent = 'Limite de 5 imagens atingido.';
     } else {
         fileInput.disabled = false;
         labelFileInput.textContent = `Adicionar Novas Imagens (${allowedNew} restantes):`;
         // Se o número de arquivos selecionados agora excede o limite, limpa
         if (fileInput.files.length > allowedNew) {
             fileInput.value = '';
             document.getElementById('produtoPreviewsNovas').innerHTML = '';
             exibirPopup("Atenção", `Você só pode adicionar ${allowedNew} nova(s) imagem(ns) devido às exclusões marcadas. Selecione novamente.`);
         }
     }
}

function marcarImagemPortfolioParaExcluir(buttonElement, imageUrl) {
    const imgContainer = buttonElement.parentElement;
    const imgElement = imgContainer.querySelector('img');
    const isMarked = imgContainer.classList.toggle('marcada-para-excluir');
    
    if (isMarked) {
        imagensMarcadasParaExcluir.push(imageUrl); // Adiciona ao array de exclusão
        buttonElement.textContent = '↩️';
        buttonElement.title = 'Manter Imagem';
        imgElement.style.opacity = '0.5';
        imgElement.style.border = '2px solid red';
    } else {
        // Remove do array de exclusão
        imagensMarcadasParaExcluir = imagensMarcadasParaExcluir.filter(url => url !== imageUrl);
        buttonElement.textContent = '❌';
        buttonElement.title = 'Remover Imagem';
        imgElement.style.opacity = '1';
        imgElement.style.border = '1px solid var(--cor-borda)'; // Volta ao normal
    }

     // Atualiza contador, input e botão salvar
     atualizarContadorEInputPortfolio();
}

async function abrirFormularioProduto(produtoId = null, isPremium = false) {
    produtoEmEdicaoId = produtoId;
    imagensMarcadasParaExcluir = []; 
    const modal = document.getElementById('modalAddEditProduto');
    
    // Título Diferente para Premium
    const titulo = isPremium ? '🌟 Novo Produto PREMIUM' : (produtoId ? '✏️ Editar Produto' : '📦 Adicionar Novo Produto');
    document.getElementById('formProdutoTitulo').textContent = titulo;

    // Guarda flag no dataset do modal
    modal.dataset.isPremium = isPremium ? 'true' : 'false';

    const nomeInput = modal.querySelector('#produtoNome');
    const precoInput = modal.querySelector('#produtoPreco');
    const descontoInput = modal.querySelector('#produtoDesconto');
    const descricaoInput = modal.querySelector('#produtoDescricao');
    const tamanhosCheckboxes = modal.querySelectorAll('input[name="tamanhos"]');
    const fileInput = modal.querySelector('#produtoFiles');
    const labelFileInput = modal.querySelector('#labelProdutoFiles');
    const previewsExistentesContainer = modal.querySelector('#produtoPreviewsExistentes');
    const previewsNovasContainer = modal.querySelector('#produtoPreviewsNovas');
    const progressBar = modal.querySelector('#produtoUploadProgress');
    const btnSalvar = modal.querySelector('#btnSalvarProduto');
    const contadorImagensElement = modal.querySelector('#produtoContadorImagens');

    nomeInput.value = '';
    precoInput.value = '';
    descontoInput.value = '';
    descricaoInput.value = '';
    tamanhosCheckboxes.forEach(c => c.checked = false);
    fileInput.value = ''; 
    fileInput.disabled = false; 
    labelFileInput.textContent = 'Adicionar Novas Imagens';
    previewsExistentesContainer.innerHTML = '';
    previewsNovasContainer.innerHTML = '';
    progressBar.style.display = 'none';
    progressBar.value = 0;
    btnSalvar.disabled = false; 
    contadorImagensElement.textContent = '0'; 

    let existingImageUrls = [];
    if (produtoId) {
        exibirAguarde("Carregando dados do produto...");
        try {
            const doc = await db.collection('loja_produtos').doc(produtoId).get();
            if (!doc.exists) throw new Error("Produto não encontrado.");
            const p = doc.data();

            nomeInput.value = p.nome || '';
            precoInput.value = p.preco || '';
            descontoInput.value = p.desconto || '';
            descricaoInput.value = p.descricao || '';
            if (p.tamanhos && Array.isArray(p.tamanhos)) {
                p.tamanhos.forEach(t => {
                    const checkbox = modal.querySelector(`input[value="${t}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            existingImageUrls = p.imageUrls || (p.imagemUrl ? [p.imagemUrl] : []);
            contadorImagensElement.textContent = existingImageUrls.length; 
            existingImageUrls.forEach(url => {
                 previewsExistentesContainer.innerHTML += `
                    <div style="position: relative; margin-right: 5px;" data-url="${url}">
                        <img src="${url}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px;" alt="Imagem Existente">
                        <button onclick="marcarImagemProdutoParaExcluir(this, '${url}')" style="position: absolute; top: 0; right: 0; background: rgba(255,0,0,0.7); color: white; border: none; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; line-height: 18px; padding: 0; cursor: pointer;" title="Excluir Imagem">❌</button>
                    </div>`;
            });
            fecharAguarde(null, true);
        } catch (error) {
            fecharAguarde(null, true);
            exibirPopup("Erro", "Não foi possível carregar os dados do produto: " + error.message);
            return;
        }
    } else {
         if (existingImageUrls.length >= 5) {
            fileInput.disabled = true;
            labelFileInput.textContent = 'Limite de 5 imagens atingido.';
         }
    }

    fileInput.onchange = null;
    fileInput.onchange = () => {
        previewsNovasContainer.innerHTML = '';
        const files = fileInput.files;
        const currentImageCount = existingImageUrls.length - imagensMarcadasParaExcluir.length;
        const allowedNew = 5 - currentImageCount;

        if (files.length > 0) {
            if (files.length > allowedNew) {
                exibirPopup("Limite de Imagens", `Você pode adicionar no máximo mais ${allowedNew} imagens (total de 5).`);
                fileInput.value = ''; 
                return;
            }
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewsNovasContainer.innerHTML += `<img src="${e.target.result}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px; margin-right: 5px;" alt="Nova Imagem">`;
                }
                reader.readAsDataURL(file);
            });
        }
    };

    const currentCountInitial = existingImageUrls.length;
    if (currentCountInitial >= 5) {
        fileInput.disabled = true;
        labelFileInput.textContent = 'Limite de 5 imagens atingido.';
    } else {
         fileInput.disabled = false;
         labelFileInput.textContent = `Adicionar Novas Imagens (${5 - currentCountInitial} restantes):`;
    }

    abrirModal('modalAddEditProduto');
}

async function salvarProdutoVendedor() {
    const modal = document.getElementById('modalAddEditProduto');
    const nome = modal.querySelector('#produtoNome').value.trim();
    const preco = parseFloat(modal.querySelector('#produtoPreco').value);
    const descontoInput = modal.querySelector('#produtoDesconto').value;
    const desconto = descontoInput ? parseInt(descontoInput) : null;
    const descricao = modal.querySelector('#produtoDescricao').value.trim();
    const tamanhosSelecionados = Array.from(modal.querySelectorAll('input[name="tamanhos"]:checked')).map(cb => cb.value);
    const fileInput = modal.querySelector('#produtoFiles');
    const progressBar = modal.querySelector('#produtoUploadProgress');
    const btnSalvar = modal.querySelector('#btnSalvarProduto');
    
    // Pega Flag Premium
    const isPremium = modal.dataset.isPremium === 'true';

    if (!nome || isNaN(preco) || preco <= 0 || !descricao || tamanhosSelecionados.length === 0) {
        return exibirPopup('Preencha todos os campos obrigatórios (*): Nome, Preço, Descrição e pelo menos um Tamanho.');
    }
    if (desconto !== null && (isNaN(desconto) || desconto < 1 || desconto > 99)) {
        return exibirPopup('O desconto deve ser um número entre 1 e 99 (ou deixe em branco).');
    }

    const files = fileInput.files;
    const imagensExistentesParaManter = [];
    modal.querySelectorAll('#produtoPreviewsExistentes div[data-url]:not(.marcada-para-excluir)').forEach(div => {
        imagensExistentesParaManter.push(div.dataset.url);
    });

    const totalImagensFinais = imagensExistentesParaManter.length + (files ? files.length : 0);

    if (totalImagensFinais === 0) {
        return exibirPopup('O produto precisa ter pelo menos uma imagem.');
    }
    if (totalImagensFinais > 5) {
        return exibirPopup(`O produto pode ter no máximo 5 imagens. Você está tentando salvar ${totalImagensFinais}.`);
    }

    exibirAguarde("Salvando produto...");
    btnSalvar.disabled = true;
    progressBar.style.display = 'block';
    progressBar.value = 0;

    const uploadPromises = [];
    const newImageUrls = [];
    let totalBytesUpload = 0;
    const uploadTasksInfo = [];

    if (files && files.length > 0) {
        totalBytesUpload = Array.from(files).reduce((acc, file) => acc + file.size, 0);
        Array.from(files).forEach((file, index) => {
            const productIdForPath = produtoEmEdicaoId || `new_${auth.currentUser.uid}_${Date.now()}`;
            const filePath = `products/${auth.currentUser.uid}/${productIdForPath}/${Date.now()}_${index}_${file.name}`;
            const uploadPromise = new Promise((resolve, reject) => {
                const storageRef = storage.ref(filePath);
                const uploadTask = storageRef.put(file);
                const taskInfo = { task: uploadTask, bytesTransferred: 0 };
                uploadTasksInfo.push(taskInfo);

                uploadTask.on('state_changed',
                    (snapshot) => {
                        taskInfo.bytesTransferred = snapshot.bytesTransferred;
                        let totalBytesTransferidosAcumulados = uploadTasksInfo.reduce((acc, info) => acc + info.bytesTransferred, 0);
                        const progress = totalBytesUpload > 0 ? (totalBytesTransferidosAcumulados / totalBytesUpload) * 100 : 0;
                        progressBar.value = progress;
                    },
                    (error) => reject(error),
                    async () => {
                        try {
                            const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                            newImageUrls.push(downloadURL); 
                            resolve();
                        } catch(urlError) { reject(urlError); }
                    }
                );
            });
            uploadPromises.push(uploadPromise);
        });
    }

    try {
        await Promise.all(uploadPromises);

        const deletePromises = imagensMarcadasParaExcluir.map(async url => {
            try {
                const decodedUrl = decodeURIComponent(url);
                const pathRegex = /\/o\/(.+)\?alt=media/;
                const match = decodedUrl.match(pathRegex);
                if (match && match[1]) {
                    const filePath = match[1];
                    await storage.ref(filePath).delete();
                }
            } catch (e) { console.warn("Erro ao deletar imagem:", e); }
        });
        await Promise.all(deletePromises);

        const finalImageUrls = [...imagensExistentesParaManter, ...newImageUrls];

        const productData = {
            nome,
            preco,
            desconto: desconto !== null ? desconto : firebase.firestore.FieldValue.delete(),
            descricao,
            tamanhos: tamanhosSelecionados,
            imageUrls: finalImageUrls, 
            imagemUrl: finalImageUrls[0] || null,
            vendedorUid: auth.currentUser.uid,
            vendedorNome: perfil.nome,
            isOficial: perfil.tipo === 'admin',
            isPremium: isPremium // SALVA O STATUS PREMIUM
        };

        if (produtoEmEdicaoId) {
            await db.collection('loja_produtos').doc(produtoEmEdicaoId).update(productData);
        } else {
            productData.ts = firebase.firestore.FieldValue.serverTimestamp();
            productData.vendasRealizadas = 0;
            await db.collection('loja_produtos').add(productData);
        }

        fecharTodosOsModais();
        exibirPopup('Produto salvo com sucesso!');
        if(perfil.tipo === 'admin') abrirGerenciarLojaAdmin();
        else abrirGerenciarLoja();

    } catch (error) {
        fecharTodosOsModais();
        exibirPopup('Erro ao salvar produto: ' + (error.message || error));
        btnSalvar.disabled = false;
        progressBar.style.display = 'none';
    }
}

function habilitarEnterParaFormulario(inputIds, buttonId) {
    const button = document.getElementById(buttonId);
    if (!button) {
        console.warn(`Botão com ID "${buttonId}" não encontrado para habilitar Enter.`);
        return;
    }

    inputIds.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
            input.addEventListener('keyup', function(event) {
                // Verifica se a tecla pressionada foi "Enter" e se não é um textarea (para permitir Shift+Enter)
                if (event.key === 'Enter' && input.tagName.toLowerCase() !== 'textarea') {
                    event.preventDefault(); // Impede envio padrão se houver <form>
                    if (!button.disabled) { // Só clica se o botão não estiver desabilitado
                       button.click();
                    }
                }
            });
        } else {
             console.warn(`Input com ID "${inputId}" não encontrado para habilitar Enter no botão "${buttonId}".`);
        }
    });
}

async function deletarProdutoVendedor(produtoId) {
    if (confirm('Tem certeza que deseja excluir este produto?')) {
        await db.collection('loja_produtos').doc(produtoId).delete();
        exibirPopup('Produto excluído.');
        abrirGerenciarLoja();
    }
}

async function abrirEntregasVendedor() {
    abrirModal('modalEntregasVendedor');
    const container = document.getElementById('listaEntregas');
    container.innerHTML = '<p>Carregando entregas...</p>';

    if (pedidosVendedorListener) pedidosVendedorListener();

    // --- MODIFICATION: Query now includes 'entregue_pendente_confirmacao' ---
    pedidosVendedorListener = db.collection('loja_pedidos')
      .where('vendedorUid', '==', auth.currentUser.uid)
      .where('status', 'in', ['pendente', 'entregue_pendente_confirmacao', 'disputa']) // Added confirmation status
      .orderBy('ts', 'desc') // Order by most recent
      .onSnapshot(snap => {
        if(snap.empty) {
            container.innerHTML = '<p>Nenhuma entrega pendente ou aguardando confirmação.</p>';
            return;
        }
        container.innerHTML = '';
        snap.forEach(doc => {
            const pedido = doc.data();
            let statusHtml = '';
            let acaoHtml = ''; // Clear action html

             // --- MODIFICATION: Status logic updated ---
            if (pedido.status === 'pendente') {
                statusHtml = '<p style="color: #f1c40f;">Status: Aguardando Envio/Entrega</p>';
                acaoHtml = `<button onclick="marcarComoEntregue('${doc.id}', '${pedido.clienteUid}')">Marcar como Entregue</button>`;
            } else if (pedido.status === 'entregue_pendente_confirmacao') {
                statusHtml = '<p style="color: #3498db;">Status: Aguardando Confirmação do Cliente</p>';
                // Add button to notify/remind the client
                acaoHtml = `<button onclick="notificarCompradorEntrega('${doc.id}', '${pedido.clienteUid}')" style="background-color: #3498db;">Notificar Cliente (Lembrete)</button>`;
            } else if (pedido.status === 'disputa') {
                statusHtml = '<p style="color: #e74c3c;">Status: Cliente Negou Recebimento.</p>';
                // Allow seller to mark again
                acaoHtml = `<button onclick="marcarComoEntregue('${doc.id}', '${pedido.clienteUid}')">Tentar Marcar Entregue Novamente</button>`;
            }
            // --- MODIFICATION END ---

            container.innerHTML += `
                <div class="card">
                    <b>Comprador: ${pedido.clienteNome}</b>
                    <p>Produto: ${pedido.produtoNome} (T: ${pedido.tamanho}) - R$ ${pedido.valor.toFixed(2)}</p>
                    <p>Endereço: ${pedido.endereco} - CEP: ${pedido.cep}</p>
                    <p>WhatsApp: <a href="https://wa.me/55${pedido.telefone.replace(/\D/g,'')}" target="_blank">${pedido.telefone}</a></p>
                    ${statusHtml}
                    <div style="margin-top: 10px;">${acaoHtml}</div>
                </div>`;
        });
    });
}

function notificarCompradorEntrega(pedidoId, clienteUid) {
    // Optional: Add logic here to prevent spamming the buyer (e.g., check last notification time)
    if (confirm("Enviar um lembrete para o comprador confirmar o recebimento?")) {
        notifyUser(clienteUid, '🚚 Confirme o Recebimento!', 'Lembrete: Seu pedido foi marcado como entregue. Por favor, confirme o recebimento no app para liberar o pagamento ao vendedor.');
        exibirPopup('Lembrete enviado ao comprador.');
    }
}

async function marcarComoEntregue(pedidoId, clienteUid) {
    if (!confirm("Confirmar que o produto foi entregue? O comprador será notificado para confirmar o recebimento.")) return;
    try {
        await db.collection('loja_pedidos').doc(pedidoId).update({ status: 'entregue_pendente_confirmacao' });
        notifyUser(clienteUid, '🚚 Seu Pedido foi Entregue!', 'Por favor, confirme o recebimento do seu produto no app para finalizar a compra.');
        exibirPopup('Notificação enviada ao comprador.');
    } catch (e) {
        exibirPopup('Erro ao marcar como entregue: ' + e.message);
    }
}

async function abrirMinhasCompras() {
    abrirModal('modalMinhasCompras');
    const container = document.getElementById('listaMinhasCompras');
    container.innerHTML = '<p>Carregando suas compras...</p>';

    const snap = await db.collection('loja_pedidos').where('clienteUid', '==', auth.currentUser.uid).orderBy('ts', 'desc').get();
    if (snap.empty) {
        container.innerHTML = '<p>Você ainda não fez nenhuma compra.</p>';
        return;
    }
    container.innerHTML = '';
    snap.forEach(doc => {
        const compra = doc.data();
        let statusTexto = 'Status desconhecido';
        let acaoBotao = '';

        switch(compra.status) {
            case 'pendente': statusTexto = 'Aguardando entrega'; break;
            case 'entregue_pendente_confirmacao': statusTexto = 'Confirme o recebimento!'; break;
            case 'confirmado_pelo_cliente': statusTexto = 'Entrega confirmada'; break;
            case 'disputa': statusTexto = 'Entrega recusada'; break;
        }
        
        if (compra.status === 'confirmado_pelo_cliente' && !compra.avaliado) {
            acaoBotao = `<button onclick="abrirModalAvaliacaoProduto('${doc.id}', '${compra.produtoId}', '${compra.produtoNome}')">⭐ Avaliar Produto</button>`;
        } else if (compra.status === 'confirmado_pelo_cliente' && compra.avaliado) {
            acaoBotao = `<p style="font-size: 14px; color: var(--cor-destaque);">✅ Produto avaliado!</p>`;
        }

        container.innerHTML += `
            <div class="card">
                <b>${compra.produtoNome}</b>
                <p>Status: ${statusTexto}</p>
                <div style="margin-top: 10px;">${acaoBotao}</div>
            </div>
        `;
    });
}

function abrirModalConfirmacaoComprador(pedido) {
    const modal = document.getElementById('modalConfirmacaoComprador');
    if(modal.classList.contains('show')) return; 

    document.getElementById('btnAceitarEntrega').onclick = () => responderConfirmacaoEntrega(pedido.id, true);
    document.getElementById('btnRecusarEntrega').onclick = () => responderConfirmacaoEntrega(pedido.id, false);
    abrirModal('modalConfirmacaoComprador');
}

async function responderConfirmacaoEntrega(pedidoId, aceito) {
    const novoStatus = aceito ? 'confirmado_pelo_cliente' : 'disputa';
    try {
        const pedidoRef = db.collection('loja_pedidos').doc(pedidoId);
        const pedidoDoc = await pedidoRef.get();
        if (!pedidoDoc.exists) throw new Error("Pedido não encontrado.");

        const { vendedorUid, valor, produtoNome } = pedidoDoc.data(); // Get value and sellerUid from order

        // --- MODIFICATION START ---
        if (aceito) {
            exibirAguarde("Confirmando recebimento e liberando pagamento..."); // Show wait popup for transaction

            // Transaction to release funds to seller and admin
            await db.runTransaction(async t => {
                const vendedorRef = db.collection("usuarios").doc(vendedorUid);
                const adminSnap = await db.collection("usuarios").where("tipo", "==", "admin").limit(1).get();
                if (adminSnap.empty) throw new Error("Conta de administrador não encontrada para taxas.");
                const adminRef = db.collection("usuarios").doc(adminSnap.docs[0].id);
                const financeiroRef = db.collection("config").doc("financeiro");

                // Get seller profile to check PRO status and calculate correct fee
                const vendedorDoc = await t.get(vendedorRef);
                if (!vendedorDoc.exists) throw new Error("Vendedor não encontrado.");
                const vendedorData = vendedorDoc.data();

                let taxaAplicada = TAXA; // Default fee
                if (isProAtivo(vendedorData) && vendedorData.proTier && PRECOS_PRO[vendedorData.proTier]) {
                    taxaAplicada = PRECOS_PRO[vendedorData.proTier].taxa;
                    console.log(`Taxa PRO ${vendedorData.proTier} aplicada: ${taxaAplicada * 100}%`);
                } else {
                    console.log(`Taxa padrão aplicada: ${taxaAplicada * 100}%`);
                }

                const valorVendedor = valor * (1 - taxaAplicada);
                const valorAdmin = valor * taxaAplicada;

                // Update balances
                t.update(vendedorRef, { saldo: firebase.firestore.FieldValue.increment(valorVendedor) });
                t.update(adminRef, { saldo: firebase.firestore.FieldValue.increment(valorAdmin) });

                // Update financial stats
                t.set(financeiroRef, { arrecadadoTaxas: firebase.firestore.FieldValue.increment(valorAdmin) }, { merge: true });

                // Update order status within the same transaction
                t.update(pedidoRef, { status: novoStatus });
            });

            fecharTodosOsModais(); // Close wait popup

            // Notify seller about payment
            notifyUser(vendedorUid, '💰 Pagamento Recebido!', `O comprador confirmou o recebimento de "${produtoNome}"! O valor (menos taxas) foi adicionado ao seu saldo.`);

        } else {
            // Just update status if denied, no transaction needed
            await pedidoRef.update({ status: novoStatus });
            notifyUser(vendedorUid, '❌ Entrega Recusada', `O comprador recusou o recebimento de "${produtoNome}". Verifique a entrega e entre em contato.`, { link: '#entregas' });
        }
        // --- MODIFICATION END ---

        exibirPopup('Resposta enviada com sucesso!');
        fecharModalAtual(); // Close confirmation modal
        abrirMinhasCompras(); // Refresh buyer's purchase list

    } catch (e) {
        fecharTodosOsModais(); // Ensure wait popup closes on error
        exibirPopup('Erro ao enviar resposta: ' + e.message);
        console.error("Error in responderConfirmacaoEntrega:", e);
    }
}

function toggleFuncoes(containerId) {
    const container = document.getElementById(containerId);
    const button = container.previousElementSibling;
    if (container) {
        container.classList.toggle('hidden');
        button.classList.toggle('closed', container.classList.contains('hidden'));
    }
}

function handleProdutoClick(produto) {
    if (!auth.currentUser) {
        exibirPopup("Para ver detalhes e comprar produtos, por favor, faça login ou crie uma conta.");
        mostrar('authView');
    } else {
        abrirDetalhesProduto(produto);
    }
}

function iniciarVerificacaoDePendencias(uid) {
    if (pendenciasInterval) clearInterval(pendenciasInterval);
    verificarPendencias(uid);
    pendenciasInterval = setInterval(() => verificarPendencias(uid), 60000);
}

async function verificarPendencias(uid) {
    if (!uid || !perfil) return;

    if (perfil.tipo !== 'cliente') {
        const agendamentosSnap = await db.collection('agendamentos').where('barbeiroUid', '==', uid).where('status', '==', 'pendente').get();
        const btnAgendamentos = document.getElementById('btnAgendamentosBarbeiro');
        if (!agendamentosSnap.empty) {
            btnAgendamentos?.classList.add('notificacao-pulsante');
            notifyUser(uid, '⏰ Agendamento Pendente', `Você tem ${agendamentosSnap.size} novo(s) agendamento(s) para aprovar.`, { link: '#agendamentos' });
        } else {
            btnAgendamentos?.classList.remove('notificacao-pulsante');
        }
    }

    if (perfil.tipo === 'cliente') {
        const avaliacoesSnap = await db.collection('agendamentos').where('clienteUid', '==', uid).where('status', '==', 'concluido').where('avaliado', '==', false).get();
        const btnHistorico = document.getElementById('btnHistoricoCliente');
        if (!avaliacoesSnap.empty) {
            btnHistorico?.classList.add('notificacao-pulsante');
            notifyUser(uid, '⭐ Avaliação Pendente', `Você tem ${avaliacoesSnap.size} serviço(s) para avaliar e ganhar pontos!`, { link: '#historico' });
        } else {
            btnHistorico?.classList.remove('notificacao-pulsante');
        }
    }

    const saqueSnap = await db.collection("solicitacoes").where("usuarioUid", "==", uid).where("status", "==", "pendente").where("tipo", "==", "saque").get();
    if (!saqueSnap.empty) {
        notifyUser(uid, "⏳ Saque em Análise", "Sua solicitação de saque ainda está pendente de aprovação.", { link: '#carteira' });
    }
}

// SUBSTITUA A FUNÇÃO 'verificarPendenciasEssenciaisProfissional' INTEIRA EM index.html
async function verificarPendenciasEssenciaisProfissional(uid) {
    // Se o fluxo inicial ainda está ativo (true) ou se um popup de etapa já está aberto, não faz nada.
    if (etapaAtualOnboarding > 0 || !perfil || perfil.precisaConfiguracaoInicial === true) {
        return;
    }

    // Se o onboarding inicial foi pulado (false), verificamos as pendências.
    const p = perfil;

    // 1. Verifica se HÁ ALGUMA pendência essencial
    const temServicos = p.listaServicos && p.listaServicos.length > 0;
    const temHorarioManual = Object.values(p.agenda || {}).some(v => v === true);
    const temAgenda = p.vagaImediata || temHorarioManual;
    const temLogo = !!p.logo_url;
    const temPortfolio = p.portfolio && p.portfolio.length > 0;

    const temPendencia = !temServicos || !temAgenda || !temLogo || !temPortfolio;

    // 2. Se tiver pendência, mostra o popup de Lembrete
    if (temPendencia) {
        // Não abre se outro modal já estiver visível (ex: o de Lembrete)
        if (document.getElementById('modalLembretePendencia').classList.contains('show')) {
            return;
        }
        console.log("Fluxo Lembrete: Pendências encontradas. Abrindo modalLembretePendencia.");
        abrirModal('modalLembretePendencia');
    }
    // Se não houver pendência, não faz nada.
}

// [ADICIONAR ESTAS NOVAS FUNÇÕES]

/**
 * Chamada pelo botão "OK, Configurar" do modal de lembrete.
 * Fecha o lembrete e inicia a verificação do primeiro popup pendente.
 */
function iniciarFluxoDeLembrete() {
    fecharModalAtual(); // Fecha o modal de lembrete
    
    // Roda a verificação de qual popup abrir.
    // Usamos um timeout curto para garantir que o modal de lembrete feche antes do próximo abrir.
    setTimeout(() => {
        abrirProximoPopupDeLembrete();
    }, 350); 
}

/**
 * Verifica (recarregando o perfil) qual a próxima configuração essencial pendente
 * e abre o modal correspondente no "modo lembrete".
 */
async function abrirProximoPopupDeLembrete() {
    // Recarrega o perfil para garantir dados frescos
    let p;
    try {
        exibirAguarde("Verificando..."); // Mostra um aguarde rápido
        const userDoc = await db.collection('usuarios').doc(auth.currentUser.uid).get();
        if (!userDoc.exists) throw new Error("Usuário não encontrado.");
        p = userDoc.data();
        perfil = p; // Atualiza o perfil global
        fecharAguarde(null, true); // Fecha o aguarde
    } catch (e) {
        fecharAguarde(null, true);
        exibirPopup("Erro", "Não foi possível verificar suas configurações: " + e.message, "erro");
        return;
    }
    
    console.log("Fluxo Lembrete: Verificando próxima pendência...");

    // 1. Verifica Serviços
    if (!p.listaServicos || p.listaServicos.length === 0) {
        console.log("Fluxo Lembrete: Abrindo Etapa 1 (Serviços).");
        abrirOnboardingEtapa1(true); // 'true' para modo lembrete
        return;
    }

    // 2. Verifica Agenda (Etapa 3 do fluxo original)
    const temHorarioManual = Object.values(p.agenda || {}).some(v => v === true);
    if (!p.vagaImediata && !temHorarioManual) {
        console.log("Fluxo Lembrete: Abrindo Etapa 3 (Agenda).");
        abrirOnboardingEtapa3(true); // 'true' para modo lembrete
        return;
    }

    // 3. Verifica Logomarca (Etapa 4)
    if (!p.logo_url) {
        console.log("Fluxo Lembrete: Abrindo Etapa 4 (Logo).");
        abrirOnboardingEtapa4(true); // 'true' para modo lembrete
        return;
    }
    
    // 4. Verifica Portfólio (Etapa 5)
    if (!p.portfolio || p.portfolio.length === 0) {
        console.log("Fluxo Lembrete: Abrindo Etapa 5 (Portfólio).");
        abrirOnboardingEtapa5(true); // 'true' para modo lembrete
        return;
    }

    // 5. Nenhuma pendência encontrada!
    console.log("Fluxo Lembrete: Nenhuma pendência restante.");
    exibirPopup("Tudo Certo!", "Todas as suas configurações essenciais estão completas.", "sucesso");
}

async function carregarAvaliacaoProduto(produtoId, produtoNome, container) {
    container.innerHTML = '';
    
    if (produtoNome.toLowerCase().includes('Nova Versão')) {
        const hoje = new Date().toISOString().split('T')[0]; 
        const seed = produtoId + hoje;
        let hash = 0;
        for (let i = 0; i < seed.length; i++) {
            const char = seed.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash |= 0; 
        }
        const randomValue = (Math.abs(hash) % 10) / 10;
        const notaAleatoria = (4.1 + randomValue).toFixed(1);

        const snap = await db.collection('avaliacoes_produtos').where('produtoId', '==', produtoId).orderBy('ts', 'desc').limit(1).get();
        
        let avaliacaoHtml = `<p class="avaliacao-estrelas">⭐ ${notaAleatoria}</p>`;
        
        if (!snap.empty) {
            const ultimaAvaliacao = snap.docs[0].data();
            const doisDiasAtras = new Date(Date.now() - 2 * 24 * 60 * 60 * 1000);
            if (ultimaAvaliacao.ts.toDate() > doisDiasAtras) {
                avaliacaoHtml += `<p class="avaliacao-comentario">"${ultimaAvaliacao.comentario}"</p>`;
            } else {
                 avaliacaoHtml += `<p class="avaliacao-comentario">Veja as avaliações dos clientes.</p>`;
            }
        } else {
             avaliacaoHtml += `<p class="avaliacao-comentario">Seja o primeiro a avaliar!</p>`;
        }
        container.innerHTML = avaliacaoHtml;

    } else {
        const snap = await db.collection('avaliacoes_produtos').where('produtoId', '==', produtoId).orderBy('ts', 'desc').limit(1).get();
        if (snap.empty) {
            container.innerHTML = `<p class="avaliacao-estrelas">⭐ Sem avaliação</p><p class="avaliacao-comentario">Seja o primeiro a avaliar!</p>`;
        } else {
            const avaliacao = snap.docs[0].data();
            container.innerHTML = `
                <p class="avaliacao-estrelas">⭐ ${avaliacao.nota.toFixed(1)}</p>
                <p class="avaliacao-comentario">"${avaliacao.comentario}"</p>
            `;
        }
    }
}

let notaSelecionada = 0;
function abrirModalAvaliacaoProduto(pedidoId, produtoId, produtoNome) {
    notaSelecionada = 0;
    document.getElementById('avaliarProdutoNome').textContent = produtoNome;
    document.getElementById('avaliarProdutoComentario').value = '';
    
    const starsContainer = document.getElementById('ratingStars');
    const stars = starsContainer.querySelectorAll('span');

    stars.forEach(star => {
        star.classList.remove('selected');
        star.innerHTML = '☆';
        star.onmouseover = () => {
            const rating = parseInt(star.dataset.value);
            stars.forEach(s => {
                s.classList.toggle('hovered', parseInt(s.dataset.value) <= rating);
                s.innerHTML = parseInt(s.dataset.value) <= rating ? '★' : '☆';
            });
        };
        star.onmouseout = () => {
            stars.forEach(s => {
                s.classList.remove('hovered');
                const rating = notaSelecionada;
                s.innerHTML = parseInt(s.dataset.value) <= rating ? '★' : '☆';
            });
        };
        star.onclick = () => {
            notaSelecionada = parseInt(star.dataset.value);
            stars.forEach(s => {
                s.classList.toggle('selected', parseInt(s.dataset.value) <= notaSelecionada);
            });
        };
    });

    document.getElementById('btnSalvarAvaliacaoProduto').onclick = () => {
        const comentario = document.getElementById('avaliarProdutoComentario').value.trim();
        if (notaSelecionada === 0) {
            return exibirPopup('Por favor, selecione uma nota de 1 a 5 estrelas.');
        }
        salvarAvaliacaoProduto(pedidoId, produtoId, notaSelecionada, comentario);
    };
    
    abrirModal('modalAvaliarProduto');
}

async function salvarAvaliacaoProduto(pedidoId, produtoId, nota, comentario) {
    try {
        await db.collection('avaliacoes_produtos').add({
            produtoId,
            nota,
            comentario,
            clienteUid: auth.currentUser.uid,
            clienteNome: perfil.nome,
            ts: firebase.firestore.FieldValue.serverTimestamp()
        });
        await db.collection('loja_pedidos').doc(pedidoId).update({ avaliado: true });
        
        exibirPopup('Obrigado pela sua avaliação!');
        fecharModalAtual();
        abrirMinhasCompras();
    } catch (e) {
        exibirPopup('Erro ao salvar avaliação: ' + e.message);
    }
}

function fazerLogout() {
// Para o intervalo de atualização de lastSeen
if (updateLastSeenInterval) {
    clearInterval(updateLastSeenInterval);
    updateLastSeenInterval = null;
}
// Para o listener de usuários online
if (onlineUsersListener) {
    onlineUsersListener();
    onlineUsersListener = null;
}
// Esconde o contador
 const countElement = document.getElementById('onlineUserCount');
 if (countElement) countElement.classList.add('hidden');

    auth.signOut().then(() => {
        // Apenas recarrega a página. A lógica de verificação de login
        // irá automaticamente direcionar para a tela de autenticação.
        location.reload();
    });
}

function handleDeepLink() {
    const hash = window.location.hash.substring(1);
    if (!hash || !auth.currentUser) return;

    switch (hash) {
        case 'agendamentos':
            if (perfil.tipo !== 'cliente') abrirAgendamentosBarbeiro();
            break;
        case 'solicitacoes':
            if (perfil.tipo === 'admin') abrirModalSolicitacoes();
            break;
        case 'denuncias':
            if (perfil.tipo === 'admin') abrirDenuncias();
            break;
        case 'carteira':
            abrirModal('modalCarteira');
            break;
        case 'historico':
            if (perfil.tipo === 'cliente') abrirHistoricoCliente();
            break;
        case 'fidelidade':
            abrirModal('modalFidelidade');
            break;
        case 'conquistas':
            if (perfil.tipo === 'cliente') abrirModalConquistas();
            else abrirModalConquistasBarbeiro();
            break;
        case 'avaliacoes':
            if (perfil.tipo !== 'cliente') abrirAvaliacoesBarbeiro();
            break;
        case 'minhascompras':
            abrirMinhasCompras();
            break;
        case 'entregas':
            abrirEntregasVendedor();
            break;
    }
    history.pushState("", document.title, window.location.pathname + window.location.search);
}

// --- NOVAS FUNÇÕES Nova Versão ---

function iniciarOnboarding() {
    const modal = document.getElementById('modalOnboarding');
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('show'), 10);
    renderOnboardingTela1();
}

function renderOnboardingTela1() {
    document.getElementById('onboardingContent').innerHTML = `
        <div class="onboarding-content-wrapper" style="text-align: center;">
            <img src="https://i.postimg.cc/KYbBp2VR/image-removebg-preview.png" alt="Logo VersãoPro" style="width: 150px; height: 150px; margin-bottom: 20px;">
            <h2 style="color: var(--cor-destaque-ouro);">Bem-vindo(a) ao Nova Versão!</h2>
            <p style="color: var(--cor-destaque-ouro);">seu ecossistema de beleza e bem-estar.</p>
            <button onclick="renderOnboardingTela2()">Próximo</button>
        </div>
    `;
}

function renderOnboardingTela2() {
    const onboardingContent = document.getElementById('onboardingContent');
    
    onboardingContent.innerHTML = `
      <div class="onboarding-content-wrapper">
        <h2 style="color:var(--cor-destaque-ouro);">Qual o seu maior interesse?</h2>
        <p>Isso nos ajuda a personalizar sua experiência.</p>
        <div class="interest-options" style="display:flex; flex-direction:column; gap:10px;">
            <button onclick="selecionarInteresse('barbeiro')">Barbearias</button>
            <button onclick="selecionarInteresse('manicure_pedicure')">Manicure e Pedicure</button>
            <button onclick="selecionarInteresse('designer_cilios')">Designer de Cílios</button>
        </div>
        <button onclick="renderOnboardingTela3()" style="margin-top:20px;" id="btnOnboardingNext2" disabled>Próximo</button>
      </div>
    `;
}

function selecionarInteresse(interesse) {
    onboardingState.interesse_principal = interesse;
    const buttons = document.querySelectorAll('.interest-options button');
    buttons.forEach(btn => {
        // Lógica mais precisa: verifica qual botão corresponde exatamente ao interesse clicado.
        const isSelected = btn.getAttribute('onclick') === `selecionarInteresse('${interesse}')`;
        btn.classList.toggle('selected', isSelected);
    });
    document.getElementById('btnOnboardingNext2').disabled = false;
}

function renderOnboardingTela3() {
    document.getElementById('onboardingContent').innerHTML = `
      <div class="onboarding-content-wrapper">
        <h2 style="color:var(--cor-destaque-ouro);">Como você usará o app?</h2>
        <p>Escolha seu perfil principal.</p>
        <div class="interest-options" style="display:flex; flex-direction:column; gap:10px;">
            <button onclick="selecionarPerfilBasico('cliente')">Sou Cliente</button>
            <button onclick="selecionarPerfilBasico('profissional')">Sou Profissional</button>
        </div>
        <button onclick="finalizarOnboarding()" style="margin-top:20px;" id="btnOnboardingNext3" disabled>Começar!</button>
      </div>
    `;
}

function selecionarPerfilBasico(tipo) {
    onboardingState.perfil_basico = tipo;
    const buttons = document.querySelectorAll('.interest-options button');
    buttons.forEach(btn => {
        btn.classList.toggle('selected', btn.textContent.toLowerCase().includes(tipo));
    });
    document.getElementById('btnOnboardingNext3').disabled = false;
}

// ADICIONE ESTA NOVA FUNÇÃO EM INDEX.HTML
async function ativarModoFerias() {
    const inicio = document.getElementById('feriasInicio').value;
    const fim = document.getElementById('feriasFim').value;

    if (!inicio || !fim) {
        return exibirPopup("Por favor, selecione a data de início e fim.");
    }

    const dataInicio = new Date(inicio);
    const dataFim = new Date(fim);

    if (dataFim < dataInicio) {
        return exibirPopup("A data de fim não pode ser anterior à data de início.");
    }
    
    if (!confirm(`Você tem certeza que deseja bloquear sua agenda de ${dataInicio.toLocaleDateString()} até ${dataFim.toLocaleDateString()}? Seus clientes serão notificados.`)) {
        return;
    }

    exibirAguarde("Bloqueando agenda e notificando...");

    try {
        // Lógica de notificação (simples, para não sobrecarregar)
        // Uma implementação mais avançada usaria Cloud Functions para notificar em lotes
        const clientesSnap = await db.collection("agendamentos")
            .where("barbeiroUid", "==", auth.currentUser.uid)
            .where("status", "==", "concluido")
            .get();

        const clientesNotificados = new Set();
        clientesSnap.forEach(doc => {
            const clienteUid = doc.data().clienteUid;
            if (!clientesNotificados.has(clienteUid)) {
                notifyUser(
                    clienteUid, 
                    `🗓️ Aviso de ${perfil.nome}`, 
                    `O profissional estará ausente de ${dataInicio.toLocaleDateString()} a ${dataFim.toLocaleDateString()}.`
                );
                clientesNotificados.add(clienteUid);
            }
        });

        await db.collection("usuarios").doc(auth.currentUser.uid).update({
            ausente: true,
            ausenciaInicio: firebase.firestore.Timestamp.fromDate(dataInicio),
            ausenciaFim: firebase.firestore.Timestamp.fromDate(dataFim)
        });

        fecharTodosOsModais();
        exibirPopup("Modo férias ativado com sucesso! Sua agenda está bloqueada para o período e seus clientes foram notificados.");

    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Ocorreu um erro: " + e.message);
    }
}

function exibirPopupBloqueante(titulo, mensagem, onOk) {
    const modal = document.getElementById('modalBloqueante');
    
    // Remove onclick do fundo para impedir fechamento
    modal.onclick = null; 
    
    document.getElementById('tituloBloqueante').textContent = titulo;
    document.getElementById('msgBloqueante').innerHTML = mensagem.replace(/\n/g, '<br>');
    
    const btnOk = document.getElementById('btnOkBloqueante');
    
    // Remove listeners antigos clonando o botão
    const novoBtn = btnOk.cloneNode(true);
    btnOk.parentNode.replaceChild(novoBtn, btnOk);
    
    novoBtn.onclick = () => {
        modal.classList.remove('show');
        setTimeout(() => modal.style.display = 'none', 300);
        if (onOk) onOk(); // Executa a ação (ex: atualizar 'clienteNotificado: true')
    };
    
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('show'), 10);
}

function finalizarOnboarding() {
    localStorage.setItem('onboarding_concluido', 'true');
    const modal = document.getElementById('modalOnboarding');
    modal.classList.remove('show');
    setTimeout(() => modal.style.display = 'none', 500);
    prepararCriarConta();
    mostrar('authView'); // <-- ADICIONE ESTA LINHA
}

function aplicarTemaPorProfissao(interesse) {
    let cor = 'var(--cor-destaque-ouro)';
    if (interesse === 'manicure_pedicure' || interesse === 'designer_cilios') {
        cor = 'var(--cor-destaque-rosa)';
    }
    document.documentElement.style.setProperty('--cor-destaque', cor);
}

// =====================================================================
// ====== INÍCIO: NOVAS FUNÇÕES ONBOARDING (SUBSTITUIR) ===============
// =====================================================================

// Variáveis globais para o fluxo de onboarding
let onboardingServicos = [];
let onboardingPromocoes = [];
let onboardingAgendaConfig = { vagaImediata: false, usaAgendaManual: false, agenda: {} };
let onboardingLogoUrl = null;
let onboardingPortfolioUrls = [];
let etapaAtualOnboarding = 0;

// =====================================================================
// ====== INÍCIO: NOVA FUNÇÃO MESTRE DE ONBOARDING (ADICIONAR) ========
// =====================================================================

/**
 * Esta é a função "mestre" que verifica todas as pendências essenciais
 * em ordem e abre o popup correto.
 * É chamada no login (se o onboarding estiver pendente) e após a conclusão de cada etapa.
 */
async function iniciarFluxoDeConfiguracaoProfissional() {
    if (!perfil) {
        // Garante que o perfil esteja carregado antes de checar
        console.log("Fluxo: Perfil não carregado, buscando...");
        try {
            const userDoc = await db.collection('usuarios').doc(auth.currentUser.uid).get();
            if (!userDoc.exists) throw new Error("Usuário não encontrado no DB.");
            perfil = userDoc.data();
        } catch (e) {
            exibirPopup("Erro Crítico", "Não foi possível carregar seu perfil: " + e.message, "erro");
            auth.signOut();
            return;
        }
    }
    
    const p = perfil;
    console.log("Fluxo: Iniciando verificação de pendências de configuração...");

    // Etapa 1: Serviços (ESSENCIAL)
    // Critério: Só aparece se não tiver nenhum serviço.
    if (!p.listaServicos || p.listaServicos.length === 0) {
        console.log("Fluxo: Pendência encontrada [Etapa 1: Serviços]");
        return abrirOnboardingEtapa1(); // <-- CORREÇÃO AQUI (nome da função corrigido)
    }

    // Etapa 3: Agenda (ESSENCIAL)
    // Critério: Só aparece se vaga imediata E agenda manual estiverem desativadas/vazias.
    const temHorarioManual = Object.values(p.agenda || {}).some(v => v === true);
    if (!p.vagaImediata && !temHorarioManual) {
        console.log("Fluxo: Pendência encontrada [Etapa 3: Agenda]");
        return abrirOnboardingEtapa3();
    }

    // Etapa 4: Logomarca (ESSENCIAL)
    // Critério: Só aparece se não tiver logo.
    if (!p.logo_url) {
        console.log("Fluxo: Pendência encontrada [Etapa 4: Logomarca]");
        return abrirOnboardingEtapa4();
    }
    
    // Etapa 5: Portfólio (ESSENCIAL)
    // Critério: Só aparece se não tiver nenhuma foto no portfólio.
    if (!p.portfolio || p.portfolio.length === 0) {
        console.log("Fluxo: Pendência encontrada [Etapa 5: Portfólio]");
        return abrirOnboardingEtapa5();
    }

    // Se passou por tudo, finaliza o onboarding!
    console.log("Fluxo: Nenhuma pendência essencial encontrada. Finalizando onboarding.");
    finalizarOnboardingCompleto();
}

// =====================================================================
// ====== FIM: NOVA FUNÇÃO MESTRE DE ONBOARDING (ADICIONAR) ==========
// =====================================================================

// --- ETAPA 1: SERVIÇOS ---
// [SUBSTITUIR ESTA FUNÇÃO]
function abrirOnboardingEtapa1(isModoLembrete = false) {
    etapaAtualOnboarding = 1;
    onboardingServicos = []; // Limpa
    
    const modal = document.getElementById('modalOnboardingProfissionalServicos');
    if (!modal) {
        console.error("Modal modalOnboardingProfissionalServicos não encontrado!");
        return;
    }

    // Limpa campos e lista
    document.getElementById('onboardingServicosList').innerHTML = '';
    document.getElementById('onboardingServicoNome').value = '';
    document.getElementById('onboardingServicoValor').value = '';
    document.getElementById('onboardingServicoTempo').value = '';
    document.getElementById('btnOnboardingNextServicos').disabled = true;

    const btnConcluir = document.getElementById('btnOnboardingNextServicos');
    let btnFechar = document.getElementById('btnOnboardingCloseServicos');

    // Adiciona o botão Fechar se não existir
    if (!btnFechar) {
        btnFechar = document.createElement('button');
        btnFechar.id = 'btnOnboardingCloseServicos';
        btnFechar.textContent = '❌ Fechar';
        btnFechar.style.backgroundColor = '#555';
        btnFechar.onclick = () => fecharOnboardingComAviso(1);
        btnConcluir.parentNode.insertBefore(btnFechar, btnConcluir);
        btnConcluir.parentNode.style.display = 'flex';
        btnConcluir.parentNode.style.gap = '10px';
    }

    // Lógica dos botões baseada no modo
    if (isModoLembrete) {
        btnConcluir.textContent = 'Concluir ➡️';
        btnConcluir.onclick = salvarOnboardingServicosLembrete; // Nova função wrapper
        btnFechar.classList.add('hidden'); // Esconde o "Fechar"
        btnFechar.parentNode.style.justifyContent = 'flex-end'; 
    } else {
        btnConcluir.textContent = 'Próximo ➡️'; // No fluxo inicial, é "Próximo"
        btnConcluir.onclick = salvarOnboardingServicos; // Função original
        btnFechar.classList.remove('hidden'); // Mostra o "Fechar"
        btnFechar.parentNode.style.justifyContent = 'space-between';
    }

    abrirModal('modalOnboardingProfissionalServicos');
}

// Função que você já tinha, mas agora atualiza o array global
function adicionarServicoOnboarding() {
    const nome = document.getElementById('onboardingServicoNome').value.trim();
    const valor = parseFloat(document.getElementById('onboardingServicoValor').value);
    const tempo = parseInt(document.getElementById('onboardingServicoTempo').value);
    if (!nome || isNaN(valor) || valor <= 0 || isNaN(tempo) || tempo <= 0) return exibirPopup("Entrada inválida.");

    onboardingServicos.push({ nome, valor, duracao: tempo });
    
    const list = document.getElementById('onboardingServicosList');
    list.innerHTML += `<p>✅ ${nome} - R$${valor.toFixed(2)} (${tempo} min)</p>`;
    document.getElementById('onboardingServicoNome').value = '';
    document.getElementById('onboardingServicoValor').value = '';
    document.getElementById('onboardingServicoTempo').value = '';
    document.getElementById('btnOnboardingNextServicos').disabled = false;
}

// Salva e avança para a Etapa 2 (Promoções)
async function salvarOnboardingServicos() {
    if (onboardingServicos.length === 0) {
        exibirPopup("Atenção", "Você precisa adicionar pelo menos 1 serviço para continuar.");
        return;
    }
    
    exibirAguarde("Salvando serviços...");
    try {
        await db.collection('usuarios').doc(auth.currentUser.uid).update({
            listaServicos: onboardingServicos
        });
        fecharTodosOsModais(); // Fecha aguarde e modal
        abrirOnboardingEtapa2(); // Abre Etapa 2
    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro ao salvar serviços", e.message);
    }
}

// --- ETAPA 2: PROMOÇÕES ---
function abrirOnboardingEtapa2() {
    etapaAtualOnboarding = 2;
    onboardingPromocoes = []; // Limpa

    // Carrega os serviços cadastrados na etapa 1 no select
    const selectServicos = document.getElementById('onboardingPromocaoServicos');
    selectServicos.innerHTML = '';
    onboardingServicos.forEach(servico => {
        selectServicos.innerHTML += `<option value="${servico.nome}">${servico.nome} - R$ ${servico.valor.toFixed(2)}</option>`;
    });

    // Limpa campos do formulário
    document.getElementById('onboardingPromocaoNome').value = '';
    document.getElementById('onboardingPromocaoDescricao').value = '';
    document.getElementById('onboardingPromocaoDesconto').value = '';
    document.getElementById('onboardingPromocaoValidade').value = '';
    
    abrirModal('modalOnboardingPromocoes');
}

// Salva e avança para a Etapa 3 (Agenda)
async function salvarOnboardingPromocao() {
    const nome = document.getElementById('onboardingPromocaoNome').value.trim();
    const descricao = document.getElementById('onboardingPromocaoDescricao').value.trim();
    const desconto = parseInt(document.getElementById('onboardingPromocaoDesconto').value);
    const validadeInput = document.getElementById('onboardingPromocaoValidade').value;
    const servicosSelecionados = Array.from(document.getElementById('onboardingPromocaoServicos').selectedOptions).map(option => option.value);

    // Validação
    if (servicosSelecionados.length === 0 || !nome || isNaN(desconto) || desconto <= 0) {
        document.getElementById('overlayOnboardingPromocao').classList.remove('hidden');
        return;
    }
    
    const novaPromocao = {
        id: `promo_${new Date().getTime()}`, nome, descricao, desconto, 
        servicosAplicaveis: servicosSelecionados, valorMinimo: 0,
        validade: validadeInput ? new Date(validadeInput + 'T23:59:59') : null 
    };
    
    onboardingPromocoes.push(novaPromocao); // Salva localmente por enquanto

    exibirAguarde("Salvando promoção...");
    try {
        await db.collection('usuarios').doc(auth.currentUser.uid).update({
            promocoes: firebase.firestore.FieldValue.arrayUnion(novaPromocao)
        });
        fecharTodosOsModais();
        abrirOnboardingEtapa3(); // Abre Etapa 3
    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro ao salvar promoção", e.message);
    }
}

// --- ETAPA 3: AGENDA ---
function abrirOnboardingEtapa3(isModoLembrete = false) {
    etapaAtualOnboarding = 3;
    const modal = document.getElementById('modalOnboardingAgenda');
    
    onboardingAgendaConfig = { vagaImediata: false, usaAgendaManual: false, agenda: {} };

    const btnDisp = document.getElementById("onboardingBtnDisponibilidade");
    const btnVaga = document.getElementById("onboardingBtnVagaImediata");
    const btnManual = document.getElementById("onboardingBtnAgendaManual");
    const painelManual = document.getElementById("onboardingAgendaManualPainel");
    const horariosContainer = document.getElementById("onboardingHorariosContainer");

    btnDisp.textContent = '🟢 Ficar Disponível (Automático)';
    btnDisp.classList.remove('selected'); 
    onboardingAgendaConfig.disponivel = "nao";
    btnVaga.textContent = '⚡ Ativar Vaga Imediata';
    btnVaga.classList.remove('selected');
    btnManual.textContent = '📅 Ativar Agenda Manual';
    btnManual.classList.remove('selected');
    painelManual.classList.add("hidden");
    
    horariosContainer.innerHTML = "";
    for (let i = 7 * 60; i <= 18 * 60; i += 30) {
        const horas = Math.floor(i / 60);
        const minutos = i % 60;
        const horario = `${horas}:${minutos.toString().padStart(2, '0')}`;
        const btn = document.createElement('button');
        btn.textContent = horario;
        btn.className = `horario-btn`;
        btn.onclick = () => {
            const statusAtual = onboardingAgendaConfig.agenda[horario];
            if (statusAtual === true) {
                delete onboardingAgendaConfig.agenda[horario];
                btn.classList.remove("selecionado");
            } else {
                onboardingAgendaConfig.agenda[horario] = true;
                btn.classList.add("selecionado");
            }
        };
        horariosContainer.appendChild(btn);
    }

    // Lógica dos botões
    const btnConcluir = document.getElementById('btnOnboardingNextAgenda');
    const btnFechar = modal.querySelector('button[onclick^="fecharOnboardingComAviso(3)"]'); 

    if (isModoLembrete) {
        btnConcluir.textContent = 'Concluir ➡️';
        btnConcluir.onclick = salvarOnboardingAgendaLembrete; // Nova função wrapper
        if(btnFechar) btnFechar.classList.add('hidden');
        if(btnFechar) btnFechar.parentNode.style.justifyContent = 'flex-end';
    } else {
        btnConcluir.textContent = 'Concluir ➡️';
        btnConcluir.onclick = salvarOnboardingAgenda; // Função original
        if(btnFechar) btnFechar.classList.remove('hidden');
        if(btnFechar) btnFechar.parentNode.style.justifyContent = 'space-between';
    }
    
    abrirModal('modalOnboardingAgenda');
}

// Funções de toggle para a agenda do onboarding
function toggleOnboardingDisponibilidade() {
    const btnDisp = document.getElementById("onboardingBtnDisponibilidade");
    const novoStatus = (onboardingAgendaConfig.disponivel === "sim") ? "nao" : "sim";
    onboardingAgendaConfig.disponivel = novoStatus;
    btnDisp.textContent = novoStatus === 'sim' ? '🔴 Ficar Indisponível (Automático)' : '🟢 Ficar Disponível (Automático)';
    btnDisp.classList.toggle('selected', novoStatus === 'sim');
}

function toggleOnboardingVagaImediata() {
    const btnVaga = document.getElementById("onboardingBtnVagaImediata");
    onboardingAgendaConfig.vagaImediata = !onboardingAgendaConfig.vagaImediata;
    btnVaga.textContent = onboardingAgendaConfig.vagaImediata ? '⚠️ Desativar Vaga Imediata' : '⚡ Ativar Vaga Imediata';
    btnVaga.classList.toggle('selected', onboardingAgendaConfig.vagaImediata);

    // --- LÓGICA DE DESATIVAÇÃO MÚTUA REMOVIDA ---
}

function toggleOnboardingAgendaManual() {
    const btnManual = document.getElementById("onboardingBtnAgendaManual");
    onboardingAgendaConfig.usaAgendaManual = !onboardingAgendaConfig.usaAgendaManual;
    btnManual.classList.toggle('selected', onboardingAgendaConfig.usaAgendaManual);
    document.getElementById("onboardingAgendaManualPainel").classList.toggle("hidden", !onboardingAgendaConfig.usaAgendaManual);

    // --- LÓGICA DE DESATIVAÇÃO MÚTUA REMOVIDA ---
}

// Salva e avança para a Etapa 4 (Logomarca)
async function salvarOnboardingAgenda() {
    // Validação: Pelo menos uma opção deve ser ativada
    const { disponivel, vagaImediata, usaAgendaManual, agenda } = onboardingAgendaConfig;
    const agendaManualConfigurada = usaAgendaManual && Object.values(agenda).some(v => v === true);

    if (disponivel === "nao" && !vagaImediata && !agendaManualConfigurada) {
        document.getElementById('overlayOnboardingAgenda').classList.remove('hidden');
        return;
    }
    
    exibirAguarde("Salvando agenda...");
    try {
        const updates = {
            disponivel: disponivel,
            vagaImediata: vagaImediata,
            usaAgendaManual: usaAgendaManual,
            agenda: usaAgendaManual ? agenda : {} // Salva agenda se manual, senão limpa
        };
        await db.collection('usuarios').doc(auth.currentUser.uid).update(updates);
        fecharTodosOsModais();
        abrirOnboardingEtapa4(); // Abre Etapa 4
    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro ao salvar agenda", e.message);
    }
}

// --- ETAPA 4: LOGOMARCA ---
function abrirOnboardingEtapa4(isModoLembrete = false) {
    etapaAtualOnboarding = 4;
    onboardingLogoUrl = null; 
    const modal = document.getElementById('modalOnboardingLogomarca');

    const fileInput = document.getElementById("onboardingLogomarcaFile");
    const previewImg = document.getElementById("onboardingLogomarcaPreview");
    const btnSalvar = document.getElementById("btnOnboardingNextLogo");
    
    fileInput.value = ''; 
    previewImg.style.display = 'none';
    btnSalvar.disabled = true;

    fileInput.onchange = (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                previewImg.src = e.target.result;
                previewImg.style.display = 'block';
                btnSalvar.disabled = false; 
            }
            reader.readAsDataURL(file);
        } else {
            previewImg.style.display = 'none';
            btnSalvar.disabled = true;
        }
    };

    // Lógica dos botões
    const btnConcluir = btnSalvar; // Reutilizando a var
    const btnFechar = modal.querySelector('button[onclick^="fecharOnboardingComAviso(4)"]');

    if (isModoLembrete) {
        btnConcluir.textContent = 'Concluir ➡️';
        btnConcluir.onclick = salvarOnboardingLogoLembrete; // Nova função wrapper
        if(btnFechar) btnFechar.classList.add('hidden');
        if(btnFechar) btnFechar.parentNode.style.justifyContent = 'flex-end';
    } else {
        btnConcluir.textContent = 'Concluir ➡️';
        btnConcluir.onclick = salvarOnboardingLogo; // Função original
        if(btnFechar) btnFechar.classList.remove('hidden');
        if(btnFechar) btnFechar.parentNode.style.justifyContent = 'space-between';
    }
    
    abrirModal('modalOnboardingLogomarca');
}

// Salva e avança para a Etapa 5 (Portfólio)
async function salvarOnboardingLogo() {
    const fileInput = document.getElementById("onboardingLogomarcaFile");
    const progressBar = document.getElementById('onboardingLogoUploadProgress');
    const btnSalvar = document.getElementById('btnOnboardingNextLogo');

    if (!fileInput.files || fileInput.files.length === 0) {
        document.getElementById('overlayOnboardingLogo').classList.remove('hidden');
        return;
    }
    
    const file = fileInput.files[0];
    const userId = auth.currentUser.uid;
    const filePath = `logos/${userId}_${Date.now()}_${file.name}`;

    exibirAguarde("Enviando logomarca...");
    progressBar.style.display = 'block'; btnSalvar.disabled = true;

    try {
        // Usa a função de upload genérica
        const downloadURL = await uploadImage(file, filePath, (progress) => {
            progressBar.value = progress;
        });
        
        onboardingLogoUrl = downloadURL; // Salva localmente

        await db.collection("usuarios").doc(userId).update({
            logo_url: downloadURL
        });
        
        fecharTodosOsModais();
        abrirOnboardingEtapa5(); // Abre Etapa 5
        
    } catch (error) {
        fecharTodosOsModais();
        progressBar.style.display = 'none'; btnSalvar.disabled = false;
        exibirPopup("Erro ao salvar logomarca", error.message);
    }
}

// --- ETAPA 5: PORTFÓLIO ---
function abrirOnboardingEtapa5(isModoLembrete = false) {
    etapaAtualOnboarding = 5;
    onboardingPortfolioUrls = []; 
    const modal = document.getElementById('modalOnboardingPortfolio');

    const fileInput = document.getElementById("onboardingPortfolioFilesInput");
    const previewContainer = document.getElementById("onboardingPortfolioPreviews");
    const btnSalvar = document.getElementById("btnOnboardingNextPortfolio");

    fileInput.value = '';
    previewContainer.innerHTML = '';
    btnSalvar.disabled = true;
    
    fileInput.onchange = (event) => {
        previewContainer.innerHTML = ''; 
        const files = event.target.files;
        
        if (files.length === 0) {
            btnSalvar.disabled = true;
            return;
        }
        if (files.length > 30) {
            exibirPopup("Limite Excedido", "Você pode enviar no máximo 30 imagens de uma vez.");
            fileInput.value = '';
            btnSalvar.disabled = true;
            return;
        }

        Array.from(files).forEach(file => {
             const reader = new FileReader();
             reader.onload = (e) => {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.style.width = '60px'; img.style.height = '60px';
                img.style.objectFit = 'cover'; img.style.borderRadius = '4px';
                previewContainer.appendChild(img);
             }
             reader.readAsDataURL(file);
        });
        btnSalvar.disabled = false; 
    };

    // Lógica dos botões
    const btnConcluir = btnSalvar; // Reutilizando a var
    const btnFechar = modal.querySelector('button[onclick^="fecharOnboardingComAviso(5)"]');

    if (isModoLembrete) {
        btnConcluir.textContent = '🎉 Concluir'; // Última etapa
        btnConcluir.onclick = salvarOnboardingPortfolioLembrete; // Nova função wrapper
        if(btnFechar) btnFechar.classList.add('hidden');
        if(btnFechar) btnFechar.parentNode.style.justifyContent = 'flex-end';
    } else {
        btnConcluir.textContent = '🎉 Finalizar Configuração'; // Última etapa
        btnConcluir.onclick = salvarOnboardingPortfolio; // Função original
        if(btnFechar) btnFechar.classList.remove('hidden');
        if(btnFechar) btnFechar.parentNode.style.justifyContent = 'space-between';
    }

    abrirModal('modalOnboardingPortfolio');
}

// [ADICIONAR ESTAS NOVAS FUNÇÕES]

/** (Modo Lembrete) Salva Serviços e chama o próximo popup */
async function salvarOnboardingServicosLembrete() {
    if (onboardingServicos.length === 0) {
        exibirPopup("Atenção", "Você precisa adicionar pelo menos 1 serviço para continuar.");
        return;
    }
    
    exibirAguarde("Salvando serviços...");
    try {
        await db.collection('usuarios').doc(auth.currentUser.uid).update({
            listaServicos: onboardingServicos
        });
        fecharTodosOsModais(); // Fecha aguarde e modal
        abrirProximoPopupDeLembrete(); // <-- Chama o verificador
    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro ao salvar serviços", e.message, "erro");
    }
}

/** (Modo Lembrete) Salva Agenda e chama o próximo popup */
async function salvarOnboardingAgendaLembrete() {
    const { disponivel, vagaImediata, usaAgendaManual, agenda } = onboardingAgendaConfig;
    const agendaManualConfigurada = usaAgendaManual && Object.values(agenda).some(v => v === true);

    if (disponivel === "nao" && !vagaImediata && !agendaManualConfigurada) {
        document.getElementById('overlayOnboardingAgenda').classList.remove('hidden');
        return;
    }
    
    exibirAguarde("Salvando agenda...");
    try {
        const updates = {
            disponivel: disponivel,
            vagaImediata: vagaImediata,
            usaAgendaManual: usaAgendaManual,
            agenda: usaAgendaManual ? agenda : {}
        };
        await db.collection('usuarios').doc(auth.currentUser.uid).update(updates);
        fecharTodosOsModais();
        abrirProximoPopupDeLembrete(); // <-- Chama o verificador
    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro ao salvar agenda", e.message, "erro");
    }
}

/** (Modo Lembrete) Salva Logo e chama o próximo popup */
async function salvarOnboardingLogoLembrete() {
    const fileInput = document.getElementById("onboardingLogomarcaFile");
    const progressBar = document.getElementById('onboardingLogoUploadProgress');
    const btnSalvar = document.getElementById('btnOnboardingNextLogo');

    if (!fileInput.files || fileInput.files.length === 0) {
        document.getElementById('overlayOnboardingLogo').classList.remove('hidden');
        return;
    }
    
    const file = fileInput.files[0];
    const userId = auth.currentUser.uid;
    const filePath = `logos/${userId}_${Date.now()}_${file.name}`;

    exibirAguarde("Enviando logomarca...");
    progressBar.style.display = 'block'; btnSalvar.disabled = true;

    try {
        const downloadURL = await uploadImage(file, filePath, (progress) => {
            progressBar.value = progress;
        });
        
        await db.collection("usuarios").doc(userId).update({
            logo_url: downloadURL
        });
        
        fecharTodosOsModais();
        abrirProximoPopupDeLembrete(); // <-- Chama o verificador
        
    } catch (error) {
        fecharTodosOsModais();
        progressBar.style.display = 'none'; btnSalvar.disabled = false;
        exibirPopup("Erro ao salvar logomarca", error.message, "erro");
    }
}

/** (Modo Lembrete) Salva Portfólio e chama o próximo popup (que finalizará) */
async function salvarOnboardingPortfolioLembrete() {
    const fileInput = document.getElementById("onboardingPortfolioFilesInput");
    const progressBar = document.getElementById('onboardingPortfolioUploadProgress');
    const btnSalvar = document.getElementById('btnOnboardingNextPortfolio');
    const userId = auth.currentUser.uid;
    const files = fileInput.files;

    if (!files || files.length === 0) {
        document.getElementById('overlayOnboardingPortfolio').classList.remove('hidden');
        return;
    }
    
    exibirAguarde(`Enviando ${files.length} imagem(ns)...`);
    progressBar.style.display = 'block'; btnSalvar.disabled = true;

    // (Lógica de upload copiada de 'salvarOnboardingPortfolio')
    const uploadPromises = [];
    let totalBytesUpload = Array.from(files).reduce((acc, file) => acc + file.size, 0);
    const uploadTasksInfo = [];

    Array.from(files).forEach((file, index) => {
        const filePath = `portfolio/${userId}/${Date.now()}_${index}_${file.name}`;
        const uploadPromise = new Promise((resolve, reject) => {
            const storageRef = storage.ref(filePath);
            const uploadTask = storageRef.put(file);
            const taskInfo = { task: uploadTask, bytesTransferred: 0 };
            uploadTasksInfo.push(taskInfo);

            uploadTask.on('state_changed',
                (snapshot) => {
                    taskInfo.bytesTransferred = snapshot.bytesTransferred;
                    let totalBytesTransferidosAcumulados = uploadTasksInfo.reduce((acc, info) => acc + info.bytesTransferred, 0);
                    const progress = totalBytesUpload > 0 ? (totalBytesTransferidosAcumulados / totalBytesUpload) * 100 : 0;
                    progressBar.value = progress;
                },
                (error) => reject(error),
                async () => {
                    try {
                        const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                        resolve(downloadURL);
                    } catch(urlError) { reject(urlError); }
                }
            );
        });
        uploadPromises.push(uploadPromise);
    });

    try {
        const novasUrls = await Promise.all(uploadPromises);
        
        await db.collection('usuarios').doc(userId).update({
            portfolio: firebase.firestore.FieldValue.arrayUnion(...novasUrls)
        });
        
        fecharTodosOsModais();
        abrirProximoPopupDeLembrete(); // <-- Chama o verificador (que verá que tudo está completo)
        
    } catch (error) {
        fecharTodosOsModais();
        progressBar.style.display = 'none'; btnSalvar.disabled = false;
        exibirPopup("Erro ao salvar portfólio", error.message, "erro");
    }
}

// Salva e FINALIZA o fluxo
async function salvarOnboardingPortfolio() {
    const fileInput = document.getElementById("onboardingPortfolioFilesInput");
    const progressBar = document.getElementById('onboardingPortfolioUploadProgress');
    const btnSalvar = document.getElementById('btnOnboardingNextPortfolio');
    const userId = auth.currentUser.uid;
    const files = fileInput.files;

    if (!files || files.length === 0) {
        document.getElementById('overlayOnboardingPortfolio').classList.remove('hidden');
        return;
    }
    
    exibirAguarde(`Enviando ${files.length} imagem(ns)...`);
    progressBar.style.display = 'block'; btnSalvar.disabled = true;

    const uploadPromises = [];
    let totalBytesUpload = Array.from(files).reduce((acc, file) => acc + file.size, 0);
    const uploadTasksInfo = [];

    Array.from(files).forEach((file, index) => {
        const filePath = `portfolio/${userId}/${Date.now()}_${index}_${file.name}`;
        const uploadPromise = new Promise((resolve, reject) => {
            const storageRef = storage.ref(filePath);
            const uploadTask = storageRef.put(file);
            const taskInfo = { task: uploadTask, bytesTransferred: 0 };
            uploadTasksInfo.push(taskInfo);

            uploadTask.on('state_changed',
                (snapshot) => {
                    taskInfo.bytesTransferred = snapshot.bytesTransferred;
                    let totalBytesTransferidosAcumulados = uploadTasksInfo.reduce((acc, info) => acc + info.bytesTransferred, 0);
                    const progress = totalBytesUpload > 0 ? (totalBytesTransferidosAcumulados / totalBytesUpload) * 100 : 0;
                    progressBar.value = progress;
                },
                (error) => reject(error),
                async () => {
                    try {
                        const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                        resolve(downloadURL); // Retorna a URL
                    } catch(urlError) { reject(urlError); }
                }
            );
        });
        uploadPromises.push(uploadPromise);
    });

    try {
        const novasUrls = await Promise.all(uploadPromises);
        onboardingPortfolioUrls = novasUrls; // Salva localmente

        await db.collection('usuarios').doc(userId).update({
            portfolio: firebase.firestore.FieldValue.arrayUnion(...novasUrls)
        });
        
        // Se chegou aqui, tudo deu certo
        finalizarOnboardingCompleto();
        
    } catch (error) {
        fecharTodosOsModais();
        progressBar.style.display = 'none'; btnSalvar.disabled = false;
        exibirPopup("Erro ao salvar portfólio", error.message);
    }
}

// --- FUNÇÕES DE CONTROLE DO FLUXO ONBOARDING ---

function fecharOnboardingComAviso(etapa) {
    etapaAtualOnboarding = etapa; // Guarda a etapa atual
    const mensagens = {
        1: "Você precisa adicionar seus serviços para que clientes possam agendar.",
        2: "Sem promoções, você pode perder a chance de atrair novos clientes.",
        3: "Você deve configurar sua agenda para que clientes saibam quando você atende.",
        4: "Uma logomarca gera credibilidade e ajuda clientes a te reconhecerem.",
        5: "O portfólio é essencial para clientes verem a qualidade do seu trabalho."
    };
    
    document.getElementById('avisoOnboardingTitulo').textContent = `Sair da Etapa ${etapa}?`;
    document.getElementById('avisoOnboardingMensagem').textContent = mensagens[etapa] || "Você pode concluir esta etapa mais tarde nas configurações.";
    
    abrirModal('modalAvisoOnboarding');
}

async function confirmarFechamentoOnboarding() {
    fecharTodosOsModais(); // Fecha o aviso e o modal da etapa
    
    // --- NOVA LÓGICA (PEDIDO DO USUÁRIO) ---
    // Marca o onboarding inicial como "ignorado" para não mostrar mais.
    // O novo fluxo de "lembrete" será ativado no próximo login.
    exibirAguarde("Salvando preferência...");
    try {
        await db.collection('usuarios').doc(auth.currentUser.uid).update({
            precisaConfiguracaoInicial: false // <-- A MUDANÇA PRINCIPAL
        });
        fecharTodosOsModais();
        exibirPopup("OK!", "Você pode completar as configurações mais tarde no seu painel. Elas são essenciais para clientes agendarem.");
    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro", "Não foi possível salvar sua preferência: " + e.message, "erro");
    }
    // --- FIM DA NOVA LÓGICA ---
}

// Chamada APENAS no sucesso da Etapa 5
async function finalizarOnboardingCompleto() {
    exibirAguarde("Finalizando configuração...");
    try {
        await db.collection('usuarios').doc(auth.currentUser.uid).update({
            precisaConfiguracaoInicial: false // Finalmente, marca como concluído!
        });
        fecharTodosOsModais(); // Fecha o aguarde e o modal de portfólio
        exibirPopup("🎉 Configuração Concluída!", "Seu perfil de profissional está pronto! Bem-vindo(a) ao Nova Versão.");
    } catch (e) {
        fecharTodosOsModais();
        exibirPopup("Erro ao finalizar", e.message);
    }
}


// Substitui a função 'avancarOnboarding' antiga que não será mais usada
function avancarOnboarding(etapa) {
   // Esta função foi substituída pela nova lógica (salvarOnboardingServicos, etc.)
   // Mas a deixamos aqui em branco para evitar erros caso algo ainda a chame.
   console.warn("Função 'avancarOnboarding' obsoleta foi chamada.");
}

// =====================================================================
// ====== FIM: NOVAS FUNÇÕES ONBOARDING (SUBSTITUIR) =================
// =====================================================================

async function adminToggleLoja(uid, deveAtivar) {
    await db.collection('usuarios').doc(uid).update({ lojaLiberada: deveAtivar });
    exibirPopup(`Loja ${deveAtivar ? 'ativada' : 'desativada'} para o usuário.`);
    abrirModalGerenciarUsuario(uid); // Reabre o modal para refletir a mudança
}

async function adminDeletarProduto(produtoId, nome) {
    if(confirm(`Tem certeza que deseja deletar o produto "${nome}"?`)) {
        await db.collection('loja_produtos').doc(produtoId).delete();
        exibirPopup("Produto deletado!");
        fecharModalAtual();
    }
}

async function abrirGerenciarLojaAdmin() {
    abrirModal('modalGerenciarLojaAdmin');
    const produtosList = document.getElementById('adminDeletarProdutoList');
    const usuariosList = document.getElementById('adminToggleLojaList');
    produtosList.innerHTML = "<p>Carregando...</p>";
    usuariosList.innerHTML = "<p>Carregando...</p>";

    // BOTÃO PREMIUM ADICIONADO AQUI
    const modalContent = document.querySelector('#modalGerenciarLojaAdmin .modal-content');
    if (!document.getElementById('btnAdicionarPremium')) {
        const btnPremium = document.createElement('button');
        btnPremium.id = 'btnAdicionarPremium';
        btnPremium.textContent = '🌟 Adicionar Produto PREMIUM';
        btnPremium.className = 'btn-admin-premium'; 
        btnPremium.onclick = () => abrirFormularioProduto(null, true); // Chama com flag Premium
        // Insere logo após o título (index 0 é titulo, 1 é conteúdo)
        modalContent.insertBefore(btnPremium, modalContent.children[1]); 
    }

    const produtosSnap = await db.collection('loja_produtos').get();
    produtosList.innerHTML = "";
    produtosSnap.forEach(doc => {
        const p = doc.data();
        produtosList.innerHTML += `<div class="card"><b>${p.nome}</b> por ${p.vendedorNome} <button style="background: #c0392b; float:right;" onclick="adminDeletarProduto('${doc.id}', '${p.nome}')">X</button></div>`;
    });

    const usersSnap = await db.collection('usuarios').where('lojaLiberada', 'in', [true, false]).get();
    usuariosList.innerHTML = "";
    usersSnap.forEach(doc => {
        const u = doc.data();
        if (u.tipo === 'admin') return;
        usuariosList.innerHTML += `<div class="card"><b>${u.nome}</b> <button style="float:right;" onclick="adminToggleLoja('${doc.id}', ${!u.lojaLiberada})">${u.lojaLiberada ? 'Desativar' : 'Ativar'}</button></div>`;
    });
}

async function registrarSincronizacaoDeMensagem(mensagemData) {
    const swRegistration = await navigator.serviceWorker.ready;
    // Salve a mensagem no IndexedDB (armazenamento local) aqui
    await swRegistration.sync.register('enviar-mensagem-chat');
    console.log('Sincronização para envio de mensagem registrada.');
}

// --- FUNÇÕES DE FAVORITOS ---

// Alterna o estado do botão de filtro (♡ -> ❤️)
// Alterna o estado do filtro de favoritos
function alternarFiltroFavoritos() {
    mostrarApenasFavoritos = !mostrarApenasFavoritos;
    
    // O botão é recriado/atualizado dentro da função de carregar lista, 
    // então aqui só chamamos o recarregamento.
    
    // Identifica qual lista atualizar com base na view atual
    if (userView.currentType === 'cliente') {
        carregarBarbeirosPrincipal('listaBarbeirosPrincipalCliente', false);
    } else if (userView.currentType === 'barbeiro') {
        // Sim, profissionais também podem ter favoritos (ex: outros profissionais)
        carregarBarbeirosPrincipal('listaBarbeirosPrincipalBarbeiro', false); 
    } else if (userView.currentType === 'guest') {
         // Visitantes não têm favoritos salvos, mas o botão chama o login na função principal
         carregarBarbeirosPrincipal('listaBarbeirosPrincipalGuest', true);
    } else {
        // Fallback genérico
        carregarBarbeirosPrincipal('listaBarbeiros', false);
    }
}

// Salva ou remove o favorito no banco de dados
async function toggleFavorito(barbeiroUid) {
    if (!auth.currentUser) return;
    
    const userRef = db.collection('usuarios').doc(auth.currentUser.uid);
    // Determina se adiciona ou remove baseado se já existe no array local
    const jaFavorito = (perfil.favoritos || []).includes(barbeiroUid);
    
    try {
        if (jaFavorito) {
            await userRef.update({
                favoritos: firebase.firestore.FieldValue.arrayRemove(barbeiroUid)
            });
        } else {
            await userRef.update({
                favoritos: firebase.firestore.FieldValue.arrayUnion(barbeiroUid)
            });
        }
        // O listener principal (auth.onAuthStateChanged) vai cuidar de atualizar a tela.
        
    } catch (error) {
        console.error("Erro ao favoritar:", error);
        exibirPopup("Erro ao salvar favorito.");
    }
}

function copiarParaClipboard(text, nome) {
    if (navigator.clipboard) {
        navigator.clipboard.writeText(text)
            .then(() => exibirPopup("Link Copiado", `O link para o perfil de ${nome} foi copiado! Cole no WhatsApp ou outras redes.`))
            .catch(err => console.error('Erro ao copiar:', err));
    } else {
        // Fallback manual para navegadores muito antigos
        exibirPopup("Link Manual", "Seu navegador não suporta cópia automática. Copie o link abaixo manualmente: <br><br>" + text, 8000);
    }
}

// Função principal de compartilhamento
function compartilharPerfil(nome, uid) {
    // URL que direciona o usuário para a página principal com o parâmetro 'p' (profile)
    const shareUrl = window.location.origin + window.location.pathname + '?p=' + uid; 

    if (navigator.share) {
        // Usa a API nativa do sistema operacional (mais elegante)
        navigator.share({
            title: 'Nova Versão - ' + nome,
            text: 'Agende um horário com ' + nome + ' no app Nova Versão!',
            url: shareUrl
        }).catch(error => {
            console.warn('Compartilhamento falhou, usando fallback de cópia.', error);
            copiarParaClipboard(shareUrl, nome);
        });
    } else {
        // Fallback: Copiar para área de transferência
        copiarParaClipboard(shareUrl, nome);
    }
}

// Verifica se há um parâmetro de perfil na URL e abre o perfil
function checarParametrosURL() {
    const urlParams = new URLSearchParams(window.location.search);
    const profileUid = urlParams.get('p'); // 'p' é o parâmetro de perfil
    const homeHash = window.location.hash.includes('cliente') || window.location.hash.includes('barbeiro');

    if (profileUid) {
        // 1. Limpa o parâmetro da URL para que o link não recarregue o perfil se o usuário navegar
        const newUrl = window.location.origin + window.location.pathname + (homeHash ? window.location.hash : '');
        window.history.replaceState({}, document.title, newUrl);
        
        // 2. Abre o perfil do barbeiro. 
        // Se o usuário estiver deslogado, isGuest será true, permitindo a visualização.
        const isGuest = !auth.currentUser;
        abrirBarbeiroPerfil(profileUid, isGuest); 
        return true; // Indica que o deep link foi tratado
    }
    return false; // Indica que não havia deep link
}

function setupConfiguracoes() {
    // Configura botões de visitante
    configurarBotoesGuest();
    carregarBarbeirosPrincipal('listaBarbeirosPrincipalGuest', true);

    const btnSolicitarLoja = document.getElementById('btnSolicitarAcessoLoja');
    const msgLojaLiberada = document.getElementById('msgLojaJaLiberada');

    if (btnSolicitarLoja && msgLojaLiberada && perfil) {
        const mostrarBotao = !perfil.lojaLiberada && perfil.tipo !== 'admin';
        btnSolicitarLoja.classList.toggle('hidden', !mostrarBotao);
        msgLojaLiberada.classList.toggle('hidden', mostrarBotao);
    }

    const secaoVirarProfissional = document.getElementById('secaoVirarProfissional');
    if (secaoVirarProfissional && perfil) {
        secaoVirarProfissional.classList.toggle('hidden', perfil.tipo !== 'cliente');
    }

    // --- LÓGICA DE ALTERAÇÃO DE INTERESSE (NICHO) ---
    const interesseContainer = document.getElementById('configInteresseContainer');
    const buttons = interesseContainer.querySelectorAll('button');
    
    buttons.forEach(btn => {
        // Marca visualmente o botão do interesse atual
        const isActive = btn.dataset.interesse === (perfil.interesse_principal || 'barbeiro');
        btn.classList.toggle('selected', isActive);
        
        btn.onclick = async () => {
            const novoInteresse = btn.dataset.interesse;
            
            // Se clicar no que já está selecionado, não faz nada
            if (novoInteresse === perfil.interesse_principal) return;

            exibirAguarde("Alterando interesse...");
            try {
                // Atualiza no banco
                await db.collection('usuarios').doc(auth.currentUser.uid).update({ 
                    interesse_principal: novoInteresse 
                });
                
                fecharTodosOsModais();
                exibirPopup("Sucesso", "Seu interesse foi atualizado! O app será recarregado para exibir os novos profissionais.", "sucesso");
                
                // FORÇA O RELOAD PARA APLICAR A NOVA LISTA DE CARDS
                setTimeout(() => {
                    location.reload();
                }, 2000);

            } catch (error) {
                fecharTodosOsModais();
                exibirPopup("Erro", "Não foi possível alterar o interesse: " + error.message);
            }
        }
    });
}

function abrirModalPerfil() {
    if (!perfil) return;

    const nomeAtual = perfil.nome || "";
    const fotoAtual = perfil.fotoPerfil || 'https://via.placeholder.com/100';
    
    // === PADRÃO VISUAL DA ROLETA (20 ITENS - AJUSTADO) ===
    // A sequência foi ajustada para não repetir números na emenda do loop.
    const padraoItens = [
        // BLOCO 1
        { tipo: 'txt', val: '1', cls: 'ponto' },         // 0
        { tipo: 'html', id: 'bronze', cat: 'moldura', html: '<div class="mini-moldura-preview avatar-frame-bronze"></div>', cls: 'premio-top' }, // 1
        { tipo: 'txt', val: '2', cls: 'ponto' },         // 2
        { tipo: 'html', id: 'bronze', cat: 'balao', html: '<div class="mini-balao-preview chat-message bubble-bronze">Chat</div>', cls: 'premio-top' }, // 3
        
        // BLOCO 2
        { tipo: 'txt', val: '3', cls: 'ponto' },         // 4
        { tipo: 'html', id: 'prata', cat: 'moldura', html: '<div class="mini-moldura-preview avatar-frame-prata"></div>', cls: 'premio-top' }, // 5
        { tipo: 'txt', val: '4', cls: 'ponto' },         // 6
        { tipo: 'html', id: 'prata', cat: 'balao', html: '<div class="mini-balao-preview chat-message bubble-prata">Chat</div>', cls: 'premio-top' }, // 7
        
        // BLOCO 3 (MEIO)
        { tipo: 'txt', val: '5', cls: 'ponto' },         // 8
        { tipo: 'txt', val: '🎁', cls: 'caixa' },        // 9 (Caixa Surpresa)
        { tipo: 'txt', val: '6', cls: 'ponto' },         // 10
        
        // BLOCO 4
        { tipo: 'html', id: 'ouro', cat: 'moldura', html: '<div class="mini-moldura-preview avatar-frame-ouro"><div class="coroa-topo" style="top:-10px; width:20px;"></div></div>', cls: 'premio-top' }, // 11
        { tipo: 'txt', val: '7', cls: 'ponto' },         // 12
        { tipo: 'html', id: 'ouro', cat: 'balao', html: '<div class="mini-balao-preview chat-message bubble-ouro">Chat</div>', cls: 'premio-top' }, // 13
        
        // BLOCO 5
        { tipo: 'txt', val: '8', cls: 'ponto' },         // 14
        { tipo: 'html', id: 'diamante', cat: 'moldura', html: '<div class="mini-moldura-preview avatar-frame-diamante"><div class="coroa-topo" style="top:-10px; width:20px;"></div></div>', cls: 'premio-top' }, // 15
        { tipo: 'txt', val: '9', cls: 'ponto' },         // 16
        { tipo: 'html', id: 'diamante', cat: 'balao', html: '<div class="mini-balao-preview chat-message bubble-diamante">Chat</div>', cls: 'premio-top' }, // 17
        
        // FINAL (Conexão do Loop)
        { tipo: 'txt', val: '10', cls: 'ponto' },        // 18
        { tipo: 'txt', val: '4', cls: 'ponto' }          // 19 (Valor '4' para não repetir '1' na emenda com o índice 0)
    ];

    let faixaHtml = '';
    // Gera 40 repetições para criar a faixa de rolagem contínua
    for(let i=0; i<40; i++) {
        padraoItens.forEach(item => {
            let conteudo = '';
            if (item.tipo === 'txt') {
                conteudo = `<span>${item.val}</span>`;
            } else {
                conteudo = item.html;
            }
            faixaHtml += `<div class="roleta-item ${item.cls}">${conteudo}</div>`;
        });
    }

    // --- TEXTOS DINÂMICOS E EXPLICATIVOS ---
    const premioCaixa = perfil.tipo === 'cliente' 
        ? '<b>VIP (5 Dias)</b>' 
        : '<b>Ficar no Topo (24h)</b>';
        
    const infoTexto = `🎁 Caixa Surpresa: ${premioCaixa}`;
    const infoPremios = `<b>Prêmios Possíveis:</b> Pontos (1-10), Molduras, Balões de Chat e Caixa Surpresa.`;

    const modal = document.getElementById('modalMeuPerfil');
    const content = modal.querySelector('.modal-content');

    content.innerHTML = `
        <h3>👤 Editar Perfil</h3>
        
        <div style="text-align: center; margin-bottom: 15px;">
            <div style="position: relative; display: inline-block;">
                <img id="perfilFotoPreview" src="${fotoAtual}" class="perfil-foto-grande" style="width: 100px; height: 100px; border-radius: 50%; border: 2px solid #333; object-fit: cover;">
                <label for="perfilFotoInput" style="position: absolute; bottom: 0; right: 0; background: var(--cor-destaque); color: #000; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer;">📷</label>
            </div>
            <input type="file" id="perfilFotoInput" accept="image/*" style="display: none;" onchange="previewFotoPerfil()">
        </div>

        <label>Nome de Exibição:</label>
        <input type="text" id="perfilNomeInput" value="${nomeAtual}" placeholder="Seu nome">

        <div class="popup-section">
            <h4>🎰 Roleta Diária</h4>
            
            <div style="background: #222; padding: 8px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #444;">
                <p id="roletaInfoPremios" style="font-size: 12px; color: #ffcc00; margin: 0 0 5px 0;">${infoTexto}</p>
                <p style="font-size: 10px; color: #ccc; margin: 0; line-height: 1.3;">${infoPremios}</p>
            </div>
            
            <div class="roleta-wrapper-externo" style="position: relative;">
                 <div class="seta-externa topo"></div>
                 <div id="roletaVisual" class="roleta-container" style="margin: 0;">
                    <div class="roleta-faixa" id="roletaFaixa" style="transform: translateX(0px);">${faixaHtml}</div>
                 </div>
                 <div class="seta-externa baixo"></div>
            </div>
            
            <button id="btnGirarRoleta" onclick="girarRoleta()" style="width: 100%; font-weight: bold; font-size: 16px; margin-top:10px;">Carregando...</button>
        </div>

        <div class="popup-section">
            <h4>🖼️ Molduras de Perfil</h4>
            <div id="listaMolduras" class="molduras-scroll-container"></div>
        </div>

        <div class="popup-section" style="border-top: 1px solid var(--cor-borda); padding-top: 15px;">
            <h4>💬 Estilos de Chat</h4>
            <div id="listaBaloes" class="molduras-scroll-container"></div>
        </div>

        <div class="popup-section">
            <h4>🏅 Exibir Conquistas (Máx 3)</h4>
            <div id="listaSelecaoConquistas" class="scrollable-list" style="max-height: 120px;"></div>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 20px; border-top: 1px solid var(--cor-borda); padding-top: 15px;">
            <button onclick="fecharModalAtual()" style="background-color: #555; flex: 1;">❌ Cancelar</button>
            <button onclick="salvarNomePerfil()" style="flex: 1;">💾 Salvar Alterações</button>
        </div>
    `;

    atualizarBotaoRoleta();

    requestAnimationFrame(() => {
        renderizarMolduras();
        renderizarBaloes();
        renderizarSelecaoConquistas();
        iniciarRelogiosPerfil();
    });

    abrirModal('modalMeuPerfil');
}

function atualizarBotaoRoleta() {
    const btnGirar = document.getElementById('btnGirarRoleta');
    if (!btnGirar || !perfil) return;

    const hoje = new Date().toDateString();
    let girosTotais = 1; 
    if (isProAtivo(perfil) && perfil.proTier && PRECOS_PRO[perfil.proTier]) {
        girosTotais = PRECOS_PRO[perfil.proTier].giros;
    }
    
    const isNovoDia = perfil.ultimoGiroRoleta !== hoje;
    let girosRealizados = perfil.girosRealizadosHoje || 0;

    // CORREÇÃO: Se é um novo dia, mas os giros são negativos (extras do admin),
    // mantemos o valor negativo (crédito). Só zeramos se for positivo (uso).
    if (isNovoDia && girosRealizados > 0) {
        girosRealizados = 0;
    }

    // Cálculo: Total (ex: 1) - Realizados (ex: -999) = 1000 disponíveis
    let girosRestantes = Math.max(0, girosTotais - girosRealizados);

    btnGirar.textContent = `🎲 GIRAR (${girosRestantes} Restantes)`;
    
    if (girosRestantes > 0) {
        btnGirar.disabled = false;
        btnGirar.style.opacity = "1";
        btnGirar.style.cursor = "pointer";
    } else {
        btnGirar.disabled = true;
        btnGirar.style.opacity = "0.5";
        btnGirar.style.cursor = "not-allowed";
        btnGirar.textContent = "Volte Amanhã";
    }
}

function previewFotoPerfil() {
    const file = document.getElementById('perfilFotoInput').files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = e => document.getElementById('perfilFotoPreview').src = e.target.result;
        reader.readAsDataURL(file);
    }
}

async function salvarNomePerfil() {
    exibirAguarde("Salvando perfil...");
    const nome = document.getElementById('perfilNomeInput').value.trim();
    const file = document.getElementById('perfilFotoInput').files[0];
    
    if(!nome) return exibirPopup("O nome não pode ser vazio");

    let updates = { nome: nome };
    
    try {
        if (file) {
            // Usa a função uploadImage já existente
            const url = await uploadImage(file, `perfis/${auth.currentUser.uid}_${Date.now()}`);
            updates.fotoPerfil = url;
        }
        
        await db.collection('usuarios').doc(auth.currentUser.uid).update(updates);
        fecharTodosOsModais();
        exibirPopup("Perfil atualizado com sucesso!");
    } catch(e) {
        fecharTodosOsModais();
        exibirPopup("Erro ao salvar: " + e.message);
    }
}

async function girarRoleta() {
    if (!auth.currentUser) return;

    const btnGirar = document.getElementById('btnGirarRoleta');
    btnGirar.disabled = true; 
    btnGirar.textContent = "Sorteando..."; // Feedback inicial

    // URL do seu Backend (Ajuste se necessário, mas deve ser o mesmo domínio ou configurado no CORS)
    const API_URL = 'https://navalhabackend.onrender.com/api/girar-roleta'; 

    try {
        // 1. Chama o servidor para decidir o prêmio
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ uid: auth.currentUser.uid })
        });

        const data = await response.json();

        if (!data.success) {
            throw new Error(data.message || "Erro ao processar roleta.");
        }

        // 2. O servidor retornou o índice vencedor (0-19)
        const targetIndex = data.targetIndex;
        btnGirar.textContent = "Girando...";

        // 3. Inicia a animação visual para cair no índice correto
        const ITEM_WIDTH = 90; 
        const ITEMS_PER_SET = 20; 
        const LOOPS = 30; // Voltas visuais
        
        // Calcula a posição exata para parar no item sorteado pelo servidor
        const finalIndex = (LOOPS * ITEMS_PER_SET) + targetIndex;

        const containerWidth = 320; 
        const targetCenterPixel = (finalIndex * ITEM_WIDTH) + (ITEM_WIDTH / 2);
        const viewCenterPixel = containerWidth / 2;
        let moveX = targetCenterPixel - viewCenterPixel;
        
        // Adiciona um pequeno "jitter" aleatório para parecer física real (dentro do quadrado do item)
        // Mas garante que não saia do item sorteado
        const jitter = Math.floor(Math.random() * 40) - 20; 
        moveX += jitter;

        const faixa = document.getElementById('roletaFaixa');
        // Aumenta o tempo para dar suspense (6s) e usa bezier para desacelerar no final
        faixa.style.transition = `transform 6s cubic-bezier(0.1, 0, 0.1, 1)`; 
        faixa.style.transform = `translateX(-${moveX}px)`;

        // 4. Aguarda a animação terminar para mostrar o resultado
        setTimeout(async () => {
            // Confetis
            if (typeof confetti === 'function') {
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, zIndex: 9999 });
            }

            // Busca dados atualizados do usuário (já salvos pelo servidor)
            const userDoc = await db.collection('usuarios').doc(auth.currentUser.uid).get();
            perfil = userDoc.data(); // Atualiza variável global
            
            // Mostra o popup com a mensagem que veio do servidor
            let tituloPopup = "🎉 Parabéns!";
            if (data.tipoPr === 'item') tituloPopup = "🎁 Item Temporário!";
            else if (data.tipoPr === 'caixa') tituloPopup = "🎁 CAIXA MISTERIOSA!";

            exibirPopupBloqueante(tituloPopup, data.msgRetorno, () => {
                abrirModalPerfil(); // Reabre o perfil para atualizar a lista
            });

            // Notifica no front (opcional, pois o user já viu o popup)
            notifyUser(auth.currentUser.uid, "🎰 Prêmio da Roleta", data.msgRetorno);

        }, 6000); // Sincronizado com o tempo da transição CSS

    } catch (e) {
        console.error(e);
        exibirPopup("Erro", e.message);
        atualizarBotaoRoleta(); // Restaura botão se der erro
    }
}

function verificarAcessoMoldura(key) {
    const m = MOLDURAS[key];
    const minhasMolduras = perfil.moldurasAdquiridas || [];
    
    if (m.adminOnly) {
        return perfil.tipo === 'admin' ? { acesso: true, tipo: 'permanente' } : { acesso: false, tipo: 'bloqueado_admin' };
    }
    if (minhasMolduras.includes(key)) return { acesso: true, tipo: 'permanente' };

    // VERIFICAÇÃO CORRETA DO PRÊMIO
    if (perfil.premiosTemporarios && perfil.premiosTemporarios[`moldura_${key}`]) {
        const validade = perfil.premiosTemporarios[`moldura_${key}`].toDate();
        if (validade > new Date()) return { acesso: true, tipo: 'temporario_roleta', validade };
    }

    if (isProAtivo(perfil) && perfil.proTier) {
         // ... (lógica pro mantida) ...
         const tier = perfil.proTier;
         const niveis = ['tier1', 'tier2', 'tier3', 'tier4'];
         const moldurasOrdem = ['bronze', 'prata', 'ouro', 'diamante'];
         if (niveis.indexOf(tier) >= moldurasOrdem.indexOf(key) && niveis.indexOf(tier) > -1) {
             return { acesso: true, tipo: 'temporario' };
         }
    }
    return { acesso: false, tipo: 'nenhum' };
}	

function renderizarMolduras() {
    const container = document.getElementById('listaMolduras');
    container.className = 'molduras-scroll-container'; 
    container.innerHTML = '';
    
    Object.keys(MOLDURAS).forEach(key => {
        const m = MOLDURAS[key];
        if (m.adminOnly && perfil.tipo !== 'admin') return;

        const selecionada = perfil.molduraSelecionada === key;
        const statusAcesso = verificarAcessoMoldura(key); 
        const checkDisplay = selecionada ? 'flex' : 'none';
        
        let rodapeHtml = '';
        let estiloBorda = '';

        if (statusAcesso.tipo === 'permanente') {
            const texto = m.adminOnly ? 'Exclusivo Admin' : 'Adquirido';
            rodapeHtml = `<span style="font-size:10px; color:#4CAF50; margin-top:2px;">${texto}</span>`;
            estiloBorda = selecionada ? '' : 'border-color: #4CAF50;'; 
        } 
        else if (statusAcesso.tipo === 'temporario') {
            rodapeHtml = `<span style="font-size:9px; color:#00c6ff; font-weight:bold; margin-top:2px;">Liberado PRO</span>`;
            estiloBorda = selecionada ? '' : 'border-color: #00c6ff;';
        } 
        else if (statusAcesso.tipo === 'temporario_roleta') {
            // AQUI MUDOU: Adicionamos a classe e o data-expire
            const ts = statusAcesso.validade.getTime();
            rodapeHtml = `<span class="contador-tempo-real" data-expire="${ts}" style="font-size:9px; color:#e57373; font-weight:bold; margin-top:2px;">Calculando...</span>`;
            estiloBorda = 'border-color: #e57373;';
        } 
        else {
            rodapeHtml = `<span style="font-size:10px; color:#ff9800; background:rgba(0,0,0,0.5); padding:2px 6px; border-radius:4px; margin-top:2px;">R$${m.preco}</span>`;
            estiloBorda = 'opacity: 0.7;';
        }

        container.innerHTML += `
            <div id="moldura_${key}" class="moldura-item ${selecionada ? 'selecionada' : ''}" 
                 onclick="gerenciarMoldura('${key}', this)" 
                 style="flex: 0 0 auto; width: 80px; display:flex; flex-direction:column; align-items:center; position:relative; cursor:pointer; margin: 0; ${estiloBorda}"> 
                 
                <div class="moldura-check" style="display: ${checkDisplay}; right: 10px;">✅</div>
                <div class="avatar-wrapper shop-size ${key}" style="display: flex; justify-content: center; align-items: center;">
                    <div class="coroa-topo"></div> 
                    <div class="${m.classe}" style="width: 60px; height: 60px; border-radius: 50%; background: #222;"></div>
                </div>
                <span style="font-size:12px; margin-top:8px; font-weight:bold; color: #fff;">${m.nome}</span>
                ${rodapeHtml}
            </div>`;
    });
}

function selecionarMolduraVisualmente(element) {
    // Remove seleção visual de todas as outras
    document.querySelectorAll('.moldura-item').forEach(item => {
        item.classList.remove('temp-selected');
        item.classList.remove('selecionada'); // Remove a classe persistente antiga visualmente
    });
    
    // Adiciona a classe temporária ao clicado (que força o check a aparecer via CSS)
    element.classList.add('temp-selected');
}

function renderizarBaloes() {
    const container = document.getElementById('listaBaloes');
    if (!container) return;
    
    container.innerHTML = '';
    
    Object.keys(BALOES).forEach(key => {
        const b = BALOES[key];
        
        // Filtro de Admin (não mostra se não for admin)
        if (b.adminOnly && perfil.tipo !== 'admin') return;

        const selecionado = perfil.balaoSelecionado === key;
        const statusAcesso = verificarAcessoBalao(key);
        
        const checkDisplay = selecionado ? 'flex' : 'none';
        let rodapeHtml = '';
        let estiloBorda = '';

        // Lógica de visualização do status (Comprado, PRO, Roleta)
        if (statusAcesso.tipo === 'permanente') {
            const texto = b.adminOnly ? 'Exclusivo' : 'Adquirido';
            rodapeHtml = `<span style="font-size:10px; color:#4CAF50; margin-top:2px;">${texto}</span>`;
            estiloBorda = selecionado ? '' : 'border-color: #4CAF50;'; 
        } else if (statusAcesso.tipo === 'temporario_pro') {
            rodapeHtml = `<span style="font-size:9px; color:#00c6ff;">Liberado PRO</span>`;
            estiloBorda = selecionado ? '' : 'border-color: #00c6ff;';
        } else if (statusAcesso.tipo === 'temporario_roleta') {
            const horasRestantes = Math.ceil((statusAcesso.validade - new Date()) / (1000 * 60 * 60));
            rodapeHtml = `<span style="font-size:9px; color:#e57373;">Prêmio: ${horasRestantes}h</span>`;
            estiloBorda = 'border-color: #e57373;';
        } else {
            rodapeHtml = `<span style="font-size:10px; color:#ff9800; background:rgba(0,0,0,0.5); padding:2px 6px; border-radius:4px; margin-top:2px;">R$${b.preco}</span>`;
            estiloBorda = 'opacity: 0.7;';
        }

        // Preview Visual do Balão dentro da loja
        const previewHtml = `
            <div class="chat-message ${b.classe} custom-bubble" style="width: 60px; height: 40px; display:flex; align-items:center; justify-content:center; font-size:10px; margin-bottom:5px;">
                Abc
            </div>
        `;

        container.innerHTML += `
            <div id="balao_${key}" class="moldura-item ${selecionado ? 'selecionada' : ''}" 
                 onclick="gerenciarBalao('${key}', this)" 
                 style="flex: 0 0 auto; width: 90px; display:flex; flex-direction:column; align-items:center; position:relative; cursor:pointer; margin: 0; ${estiloBorda}"> 
                 
                <div class="moldura-check" style="display: ${checkDisplay}; right: 10px;">✅</div>
                ${previewHtml}
                <span style="font-size:11px; font-weight:bold; color: #fff;">${b.nome}</span>
                ${rodapeHtml}
            </div>`;
    });
}

async function gerenciarBalao(key, element) {
    const b = BALOES[key];
    const statusAcesso = verificarAcessoBalao(key);
    
    if (statusAcesso.acesso) {
        selecionarMolduraVisualmente(element);
        try {
            exibirAguarde("Aplicando...");
            await db.collection('usuarios').doc(auth.currentUser.uid).update({ balaoSelecionado: key });
            fecharTodosOsModais(); // Fecha Aguarde
            location.reload(); // <--- ATUALIZAÇÃO INSTANTÂNEA
        } catch (e) { 
            fecharTodosOsModais();
            exibirPopup("Erro ao salvar."); 
        }
        return;
    }
    executarCompraBalao(key, b);
}

function executarCompraBalao(key, b) {
    if (perfil.saldo < b.preco) {
        return exibirPopup("Saldo insuficiente", "Deposite fundos para comprar este estilo.", "aviso", () => abrirModal('modalCarteira'));
    }
    
    exibirConfirmacao(
        "Comprar Estilo de Chat?", 
        `Deseja adquirir "${b.nome}" VITALÍCIO por R$ ${b.preco.toFixed(2)}?`, 
        () => {
            exibirAguarde("Comprando...");
            db.collection('usuarios').doc(auth.currentUser.uid).update({
                saldo: firebase.firestore.FieldValue.increment(-b.preco),
                baloesAdquiridos: firebase.firestore.FieldValue.arrayUnion(key),
                balaoSelecionado: key
            }).then(() => {
                fecharTodosOsModais();
                exibirPopup("Sucesso!", "Estilo de chat adquirido!", "sucesso", () => abrirModalPerfil());
            }).catch(e => {
                fecharTodosOsModais();
                exibirPopup("Erro na compra: " + e.message);
            });
        }
    );
}

async function gerenciarMoldura(key, element) {
    const m = MOLDURAS[key];
    const statusAcesso = verificarAcessoMoldura(key);
    
    if (statusAcesso.tipo === 'permanente') {
        selecionarMolduraVisualmente(element);
        try {
            exibirAguarde("Aplicando...");
            await db.collection('usuarios').doc(auth.currentUser.uid).update({ molduraSelecionada: key });
            fecharTodosOsModais();
            location.reload(); // <--- ATUALIZAÇÃO INSTANTÂNEA
        } catch (e) {
            fecharTodosOsModais();
            exibirPopup("Erro", "Falha ao salvar moldura.");
        }
        return;
    }

    if (statusAcesso.tipo === 'temporario' || statusAcesso.tipo === 'temporario_roleta') {
        const modal = document.getElementById('modalConfirmacaoGenerica');
        document.getElementById('confirmacaoGenericaTitulo').textContent = "Item Liberado!";
        document.getElementById('confirmacaoGenericaMensagem').textContent = `Você tem acesso a este item.\n\nDeseja equipar agora ou comprar definitivo?`;
        
        const btnNao = document.getElementById('btnConfirmacaoGenericaNao');
        const btnSim = document.getElementById('btnConfirmacaoGenericaSim');
        
        btnNao.textContent = "Equipar (Grátis)";
        btnNao.style.backgroundColor = "#00c6ff";
        btnNao.onclick = async () => {
            exibirAguarde("Aplicando...");
            await db.collection('usuarios').doc(auth.currentUser.uid).update({ molduraSelecionada: key });
            fecharTodosOsModais();
            location.reload(); // <--- ATUALIZAÇÃO INSTANTÂNEA
        };

        btnSim.textContent = `Comprar (R$ ${m.preco})`;
        btnSim.style.backgroundColor = "#4CAF50";
        btnSim.onclick = () => {
            executarCompraMoldura(key, m); 
        };

        abrirModal('modalConfirmacaoGenerica');
        return;
    }

    executarCompraMoldura(key, m);
}

function executarCompraMoldura(key, m) {
    if (perfil.saldo < m.preco) {
        // Adicionei um callback aqui também para facilitar o depósito
        return exibirPopup("Saldo insuficiente", "Você não tem saldo suficiente para comprar esta moldura.", "aviso", () => {
            abrirModal('modalCarteira');
        });
    }
    
    exibirConfirmacao(
        "Comprar Moldura?", 
        `Deseja adquirir a moldura "${m.nome}" VITALÍCIA por R$ ${m.preco.toFixed(2)}?`, 
        () => {
            exibirAguarde("Comprando...");
            db.collection('usuarios').doc(auth.currentUser.uid).update({
                saldo: firebase.firestore.FieldValue.increment(-m.preco),
                moldurasAdquiridas: firebase.firestore.FieldValue.arrayUnion(key),
                molduraSelecionada: key // Já seleciona automaticamente ao comprar
            }).then(() => {
                fecharTodosOsModais();
                exibirPopup("Sucesso!", "Compra realizada! Moldura vitalícia adquirida.", "sucesso", () => {
                    // Reabre o perfil para mostrar a moldura equipada
                    abrirModalPerfil();
                });
            }).catch(e => {
                fecharTodosOsModais();
                exibirPopup("Erro na compra: " + e.message);
            });
        }
    );
}

// Função auxiliar para formatar tempo restante
function formatarTempoRestante(dataFutura) {
    const agora = new Date();
    const diff = dataFutura - agora;

    if (diff <= 0) return "Expirado";

    // Calcula dias, horas, minutos, segundos
    const dias = Math.floor(diff / (1000 * 60 * 60 * 24));
    const horas = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutos = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const segundos = Math.floor((diff % (1000 * 60)) / 1000);

    // Se tiver mais de 1 dia, mostra "Xd HH:MM:SS"
    if (dias > 0) {
        return `${dias}d ${horas.toString().padStart(2,'0')}:${minutos.toString().padStart(2,'0')}:${segundos.toString().padStart(2,'0')}`;
    }
    // Senão mostra "HH:MM:SS"
    return `${horas.toString().padStart(2,'0')}:${minutos.toString().padStart(2,'0')}:${segundos.toString().padStart(2,'0')}`;
}

// Variável global para o intervalo dos relógios
let intervaloRelogiosPerfil = null;

function iniciarRelogiosPerfil() {
    // Limpa anterior se existir
    if (intervaloRelogiosPerfil) clearInterval(intervaloRelogiosPerfil);

    const atualizar = () => {
        const elementos = document.querySelectorAll('.contador-tempo-real');
        if (elementos.length === 0) return;

        elementos.forEach(el => {
            // CORREÇÃO: Garante que é um número
            const timestamp = parseInt(el.getAttribute('data-expire'));
            if (!timestamp || isNaN(timestamp)) {
                el.textContent = "Erro Data";
                return;
            }
            
            const dataFutura = new Date(timestamp);
            const texto = formatarTempoRestante(dataFutura);
            
            el.textContent = texto;
            
            if (texto === "Expirado") {
                el.style.color = "gray";
            }
        });
    };

    // Roda imediatamente e depois a cada 1s
    atualizar();
    intervaloRelogiosPerfil = setInterval(atualizar, 1000);
}

function renderizarSelecaoConquistas() {
    const container = document.getElementById('listaSelecaoConquistas');
    if (!container) return;
    
    container.innerHTML = '';
    const minhasConquistas = perfil.conquistas || [];
    const selecionadas = perfil.conquistasSelecionadas || [];
    
    // Combina definições de cliente e profissional para garantir que encontre o ícone
    const todasDefinicoes = { ...conquistasDefinidas.cliente, ...conquistasDefinidas.profissional };
    
    // Exibe mensagem se não tiver conquistas
    if(minhasConquistas.length === 0) {
        container.innerHTML = "<p style='opacity:0.7; font-size:13px;'>Você ainda não desbloqueou conquistas. Complete serviços para ganhar!</p>";
        return;
    }

    // Adiciona aviso do Tier PRO se tiver
    if (perfil.proAtivo && perfil.proTier) {
         container.innerHTML += `<p style="color:var(--cor-destaque-azul); font-size:12px; margin-bottom:5px;">🌟 Tier PRO: ${perfil.proTier.toUpperCase()}</p>`;
    }

    minhasConquistas.forEach(cId => {
        const def = todasDefinicoes[cId];
        if(!def) return; // Pula se não achar definição
        
        const isSelected = selecionadas.includes(cId);
        container.innerHTML += `
            <div class="selectable-item ${isSelected ? 'selected' : ''}" onclick="toggleConquistaChat('${cId}')" style="display:flex; align-items:center; gap:10px;">
                <span style="font-size:24px;">${def.icone}</span> 
                <div>
                    <div style="font-weight:bold;">${def.nome}</div>
                    <div style="font-size:10px; opacity:0.8;">${def.descricao}</div>
                </div>
            </div>
        `;
    });
}

async function toggleConquistaChat(cId) {
    let selecionadas = perfil.conquistasSelecionadas || [];
    if (selecionadas.includes(cId)) {
        selecionadas = selecionadas.filter(id => id !== cId);
    } else {
        if (selecionadas.length >= 3) return exibirPopup("Máximo de 3 conquistas selecionadas.");
        selecionadas.push(cId);
    }
    await db.collection('usuarios').doc(auth.currentUser.uid).update({ conquistasSelecionadas: selecionadas });
    // Atualiza a lista visualmente
    renderizarSelecaoConquistas();
}

async function salvarLocalizacaoConfig() {
    const estado = document.getElementById('configEstado').value;
    const cidade = document.getElementById('configCidade').value;
    if (!estado || !cidade) return exibirPopup("Selecione estado e cidade.");
    await db.collection('usuarios').doc(auth.currentUser.uid).update({ estado, cidade });
    exibirPopup("Localização salva!");
    fecharModalAtual();
}

document.getElementById('btnConfig').onclick = () => {
    setupConfiguracoes();
    abrirModal('modalConfiguracoes');
}
</script>
<script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('/firebase-messaging-sw.js').then(function(reg) {
          console.log('✅ Service Worker registrado com sucesso:', reg.scope);

          reg.addEventListener('updatefound', () => {
            newWorker = reg.installing;
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                 const modal = document.getElementById('modalAtualizacao');
                 const btn = document.getElementById('btnAtualizarApp');
                 btn.onclick = () => {
                   newWorker.postMessage({ type: 'SKIP_WAITING' });
                 };
                 abrirModal('modalAtualizacao');
              }
            });
          });
        }).catch(function(err) {
          console.error('❌ Falha ao registrar Service Worker:', err);
        });

        let refreshing;
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          if (refreshing) return;
          window.location.reload();
          refreshing = true;
        });
      });
    }

// --- NOVO CÓDIGO: Adiciona a funcionalidade de login com a tecla Enter ---
const loginFields = [document.getElementById('email'), document.getElementById('senha')];
loginFields.forEach(field => {
    field.addEventListener('keyup', function(event) {
        // Verifica se a tecla pressionada foi "Enter"
        if (event.key === 'Enter') {
            // Impede qualquer ação padrão do navegador
            event.preventDefault();
            // Pega o botão de entrar pelo texto, pois não tem ID
            const entrarButton = Array.from(document.querySelectorAll('#authView button')).find(btn => btn.textContent.includes('Entrar'));
            // Clica no botão
            if (entrarButton) {
                entrarButton.click();
            }
        }
    });
});
// --- FIM DO NOVO CÓDIGO ---

</script>
</body>
</html>
