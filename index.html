<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Nova Vers√£o</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="icon" href="/icone.png" type="image/png">
  <link rel="apple-touch-icon" href="/icone.png">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --cor-destaque-vermelho: #ff0000;
      --cor-fundo: #0c0c0c;
      --cor-card: #181818;
      --cor-botoes: #222222;
      --cor-texto-principal: #e0e0e0;
      --cor-destaque-ouro: #d4af37;
      --cor-destaque-rosa: #e57373;
      --cor-destaque-prata: #c0c0c0;
      --cor-destaque-azul: #007BFF;
      --cor-sombra: #000000;
      --cor-borda: #333;
      --cor-destaque: var(--cor-destaque-ouro);
    }

    .onboard-screen[style*="background-image"] {
        background-repeat: no-repeat;
        background-position: center center !important;
        background-size: cover !important;
    }

    @keyframes brilhoDourado {
        0% {
            box-shadow: 0 0 5px rgba(212, 175, 55, 0.4), 0 0 10px rgba(212, 175, 55, 0.2);
        }
        50% {
            box-shadow: 0 0 15px var(--cor-destaque-ouro), 0 0 25px var(--cor-destaque-ouro);
        }
        100% {
            box-shadow: 0 0 5px rgba(212, 175, 55, 0.4), 0 0 10px rgba(212, 175, 55, 0.2);
        }
    }

    .onboard-option.selected {
        border: 2px solid var(--cor-destaque-ouro) !important;
        animation: brilhoDourado 1.5s infinite alternate;
    }

    .onboard-option:not(.selected) {
        animation: none;
    }

    body.tema-claro {
      --cor-destaque-vermelho: #cc0000;
      --cor-fundo: #f0f0f0;
      --cor-card: #ffffff;
      --cor-botoes: #e0e0e0;
      --cor-texto-principal: #333;
      --cor-destaque-ouro: #b8860b;
      --cor-destaque-rosa: #d81b60;
      --cor-destaque-prata: #808080;
      --cor-destaque-azul: #0056b3;
      --cor-sombra: #b0b0b0;
      --cor-borda: #ccc;
    }
    body {
      background-image: url('/icone.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
      background-blend-mode: multiply;
      background-color: rgba(0, 0, 0, 0.6);
      margin: 0;
      color: var(--cor-texto-principal);
      font-family: 'Poppins', sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: background-color 0.3s;
    }
    .content-container {
      width: 100%;
      max-width: 500px;
      padding-top: 60px;
      padding-bottom: 80px;
      box-sizing: border-box;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
    }
    input, select, button, textarea {
      width: 100%;
      margin: 8px 0;
      padding: 14px;
      background: var(--cor-botoes);
      color: var(--cor-texto-principal);
      border: 1px solid var(--cor-borda);
      border-radius: 10px;
      font-size: 16px;
      transition: all 0.3s ease-in-out;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      box-sizing: border-box;
    }
    button {
      cursor: pointer;
      font-weight: 600;
    }
    button:hover {
      background: var(--cor-destaque);
      color: var(--cor-fundo);
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(212, 175, 55, 0.4);
    }
    button:disabled {
        cursor: not-allowed;
        background: #444;
        opacity: 0.6;
    }
    .card {
      background: var(--cor-card);
      padding: 24px;
      margin: 12px;
      border-radius: 16px;
      box-shadow: 0 6px 15px var(--cor-sombra);
      width: 90%;
      max-width: 480px;
      box-sizing: border-box;
      position: relative;
      overflow: hidden;
      transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out;
    }
    .card.exiting {
        opacity: 0;
        transform: translateX(-50px);
    }
    .card.entering {
        opacity: 0;
        transform: translateX(50px);
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .hidden {
      display: none !important;
    }
    .topbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: var(--cor-card);
      color: var(--cor-texto-principal);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 16px;
      box-shadow: 0 2px 4px #000;
      font-size: 18px;
      z-index: 10;
      border-bottom: 2px solid var(--cor-borda);
    }
    .logo {
      font-weight: 600;
      color: var(--cor-destaque);
      font-size: 18px;
      text-shadow: 0 0 5px var(--cor-destaque);
      transition: color 0.3s;
    }
    .topbar-right {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    #btnConfig {
      font-size: 20px;
      background: none;
      border: none;
      padding: 0;
      cursor: pointer;
    }
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 20;
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
    }
    .modal.show {
      display: flex;
      opacity: 1;
    }
    .modal-content {
      background: var(--cor-card);
      padding: 30px;
      border-radius: 20px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.8);
      transform: scale(0.9);
      transition: transform 0.3s ease-in-out;
      border: 1px solid var(--cor-borda);
      position: relative;
    }
    .modal-overlay-content {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(12, 12, 12, 0.9);
        display: none; /* Hidden by default */
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border-radius: 20px;
        z-index: 25;
    }
    .modal-overlay-content.show {
        display: flex; /* Show when class is added */
    }
    #modalRankingUnificado .modal-content {
        max-width: 600px;
    }
    .modal.show .modal-content {
      transform: scale(1);
    }
    .servico-btn {
      background: #333;
      margin: 6px 0;
      border: 1px solid #555;
      border-radius: 8px;
      padding: 12px;
      text-align: left;
    }
    .bottom-buttons-container {
      position: fixed;
      bottom: 12px;
      width: 90%;
      max-width: 480px;
      display: flex;
      justify-content: space-between;
      z-index: 15;
    }
    .redeem-container {
      position: fixed;
      bottom: 25px;
      width: 100%;
      max-width: 500px;
      text-align: center;
      z-index: 15;
      box-sizing: border-box;
    }
    .redeem-container button {
      width: 200px;
      font-size: 14px;
      padding: 10px;
      margin: 0;
    }
    #btnChat, #btnDenuncia {
      font-size: 26px;
      background: none;
      border: none;
      padding: 0;
      margin: 0;
      cursor: pointer;
      width: auto;
      height: auto;
      text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
      position: relative;
    }
    #btnSair {
      font-size: 20px;
      background: none;
      border: none;
      padding: 0;
      margin: 0;
      cursor: pointer;
      width: auto;
      height: auto;
      text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
      position: fixed;
      bottom: 72px;
      left: 12px;
      z-index: 15;
    }
    #btnChat {
      position: fixed;
      bottom: 12px;
      right: 12px;
      z-index: 15;
    }
    #btnTema {
      font-size: 18px;
      background: none;
      border: none;
      padding: 0;
      margin: 0;
      cursor: pointer;
      width: auto;
      height: auto;
      text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
    }
    #btnCarteiraTop {
      font-size: 16px;
      background: var(--cor-botoes);
      color: var(--cor-texto-principal);
      border-radius: 10px;
      padding: 8px 12px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }
    #botaoExtra {
      margin: 10px;
      text-align: center;
      width: 90%;
      max-width: 480px;
      box-sizing: border-box;
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    .vantagens ul {
      list-style-type: '‚úÖ';
      padding-left: 20px;
    }
    .vantagens li {
      background: transparent;
      margin-bottom: 10px;
      padding: 5px;
      border-radius: 0;
      border: none;
      box-shadow: none;
      padding-left: 10px;
    }
    @keyframes vaga-glow {
      0% { box-shadow: 0 0 8px #4CAF50, 0 0 12px #4CAF50; }
      50% { box-shadow: 0 0 16px #4CAF50, 0 0 24px #4CAF50; }
      100% { box-shadow: 0 0 8px #4CAF50, 0 0 12px #4CAF50; }
    }
    @keyframes gold-flash-background {
        0%, 100% { background-color: var(--cor-card); }
        50% { background-color: #2c250e; }
    }
    .boosted-card {
        border: 2px solid var(--cor-destaque);
        animation: gold-flash-background 3s ease-in-out infinite, fadeIn 0.5s;
    }
    .boost-icon {
        position: absolute;
        top: 8px;
        left: 8px;
        font-size: 20px;
        text-shadow: 0 0 8px var(--cor-destaque);
    }
    @keyframes gold-flash {
      0%, 100% { background-color: transparent; transform: scale(1); }
      50% { background-color: rgba(212, 175, 55, 0.8); transform: scale(1.2); }
    }
    @keyframes gold-pulse {
      0% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.7); }
      70% { box-shadow: 0 0 10px 15px rgba(212, 175, 55, 0); }
      100% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0); }
    }
    .notificacao-pulsante {
        animation: gold-pulse 1.5s infinite;
    }
    .new-message-glow {
        animation: gold-flash 1.5s ease-in-out infinite;
        border-radius: 50%;
    }
    .notification-badge {
        position: absolute;
        top: -5px;
        right: -8px;
        background-color: #e74c3c;
        color: white;
        border-radius: 50%;
        padding: 2px 6px;
        font-size: 10px;
        font-weight: bold;
        border: 2px solid var(--cor-fundo);
    }
    .vip-glow {
      box-shadow: 0 0 8px var(--cor-destaque), 0 0 12px var(--cor-destaque);
      border: 1px solid var(--cor-destaque);
    }
    .pro-glow {
      box-shadow: 0 0 8px var(--cor-destaque-azul), 0 0 12px var(--cor-destaque-azul);
      border: 1px solid var(--cor-destaque-azul);
    }
    .promocao-card {
      background: linear-gradient(45deg, #181818, var(--cor-destaque));
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 10px;
      color: #fff;
    }
    .chat-container {
      height: 100%;
      flex-grow: 1;
      overflow-y: auto;
      border: 1px solid var(--cor-borda);
      padding: 10px;
      border-radius: 10px;
      background: #0d0d0d;
      margin-bottom: 10px;
      display: flex;
      flex-direction: column-reverse;
    }
    .chat-message {
      padding: 8px 12px;
      margin-bottom: 8px;
      border-radius: 12px;
      animation: fadeIn 0.3s ease-in-out;
      transition: opacity 1.5s ease-out;
    }
    .chat-message.fading-out {
        opacity: 0;
    }
    .chat-sent {
      text-align: right;
      background: #333;
      margin-left: 20%;
    }
    .chat-received {
      text-align: left;
      background: #555;
      margin-right: 20%;
    }
    .scrollable-list {
      max-height: 400px;
      overflow-y: auto;
    }
    .aviso-item {
      text-align: left;
      margin-bottom: 8px;
      border-bottom: 1px solid var(--cor-borda);
      padding-bottom: 8px;
      opacity: 0.8;
      transition: opacity 0.3s ease-in-out;
    }
    .horario-btn {
        background: #222;
        color: #fff;
        border: 1px solid #555;
        border-radius: 5px;
        padding: 8px;
        margin: 5px;
        width: 100px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .horario-btn.selecionado {
        background: var(--cor-destaque);
        color: var(--cor-fundo);
        border-color: var(--cor-destaque);
    }
    .horario-btn.bloqueado {
        background: #772014;
        color: #fff;
        border-color: #772014;
        text-decoration: line-through;
    }
    .horarios-actions {
        display: flex;
        justify-content: space-between;
        margin-top: 10px;
        gap: 10px;
    }
    .horarios-list {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 10px;
    }
    .horario-disponivel {
      background: var(--cor-botoes);
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 14px;
      color: var(--cor-texto-principal);
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .horario-disponivel:hover {
      background: var(--cor-destaque);
    }
    .admin-chat-red {
      color: red;
      font-weight: bold;
      text-shadow: 0 0 5px #000, 0 0 8px #000;
    }
    .barbeiro-chat {
        color: var(--cor-texto-principal);
        text-shadow: 0 0 8px var(--cor-destaque-azul);
    }
    .cliente-chat {
        color: var(--cor-destaque-prata);
        text-shadow: 0 0 8px var(--cor-destaque-vermelho);
    }
    .show-password-container {
        position: relative;
        display: flex;
        align-items: center;
        width: 100%;
    }
    .show-password-container input {
        padding-right: 40px;
    }
    .show-password-toggle {
        position: absolute;
        right: 15px;
        cursor: pointer;
        color: var(--cor-destaque-prata);
    }
    .barbeiro-card {
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        cursor: pointer;
    }
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        border-bottom: 1px solid var(--cor-borda);
        padding-bottom: 10px;
    }
    .card-header-info h4 {
        margin: 0;
        font-size: 1.1em;
        color: var(--cor-destaque);
    }
    .card-header-info p {
        margin: 4px 0 0;
        font-size: 0.8em;
        opacity: 0.8;
    }
    .card-reputacao {
        font-size: 0.9em;
        text-align: right;
    }
    .card-status {
        padding: 10px;
        border-radius: 8px;
        text-align: center;
        font-weight: 600;
    }
    .status-imediato {
        background-color: #4CAF50;
        color: white;
        animation: vaga-glow 1.5s ease-in-out infinite;
    }
    .status-manual {
        background-color: var(--cor-botoes);
    }
    .status-indisponivel {
        background-color: #555;
        opacity: 0.7;
    }
    .card-horarios-disponiveis {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
        margin-top: 8px;
    }
    .card-horarios-disponiveis span {
        background: #333;
        padding: 4px 8px;
        border-radius: 5px;
        font-size: 0.85em;
    }
    .card-servicos-title {
        font-size: 0.9em;
        font-weight: 600;
        margin-top: 8px;
        border-top: 1px solid var(--cor-borda);
        padding-top: 10px;
    }
    .card-servicos-list {
        font-size: 0.8em;
        opacity: 0.9;
        list-style-type: none;
        padding: 0;
        margin: 0;
    }
    .popup-section {
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--cor-borda);
    }
    .popup-section h4 {
        margin-top: 0;
        margin-bottom: 10px;
        color: var(--cor-destaque);
    }
    .selectable-item {
        background: var(--cor-botoes);
        border: 1px solid var(--cor-borda);
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
    }
    .selectable-item:hover {
        border-color: var(--cor-destaque);
    }
    .selectable-item.selected {
        background: var(--cor-destaque);
        color: var(--cor-fundo);
        border-color: var(--cor-destaque);
        font-weight: 600;
    }
    #barbeiroPerfilHorariosList {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        max-height: 150px;
        overflow-y: auto;
    }
    #barbeiroPerfilHorariosList .selectable-item {
        flex-grow: 1;
        text-align: center;
    }
    #modalBarbeiroPerfil .modal-footer {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid var(--cor-borda);
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }
    #chatPreview {
        position: absolute;
        top: -40px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(24, 24, 24, 0.8);
        color: var(--cor-texto-principal);
        padding: 5px 12px;
        border-radius: 10px;
        font-size: 12px;
        z-index: 5;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 90%;
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
        pointer-events: none;
    }
    #chatPreview.show {
        opacity: 1;
    }
    .conquista-item {
        display: flex;
        align-items: center;
        gap: 15px;
        background-color: var(--cor-botoes);
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 10px;
    }
    .conquista-item.unlocked {
        border-left: 5px solid var(--cor-destaque);
    }
    .conquista-item.locked {
        opacity: 0.5;
        border-left: 5px solid var(--cor-borda);
    }
    .conquista-icon {
        font-size: 2em;
    }
    .ranking-container {
        display: flex;
        gap: 20px;
        width: 100%;
    }
    .ranking-column {
        flex: 1;
        min-width: 0;
    }
    .ranking-column h4 {
        text-align: center;
        margin-bottom: 10px;
        color: var(--cor-destaque);
    }
    .ranking-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 5px;
        border-bottom: 1px solid var(--cor-borda);
        font-size: 14px;
    }
    .ranking-item:first-child {
        font-weight: bold;
        color: var(--cor-destaque);
    }
    .chat-medal {
        margin-right: 4px;
    }
    .app-footer {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        text-align: center;
        padding: 5px 0;
        font-size: 10px;
        color: var(--cor-texto-principal);
        opacity: 0.5;
        z-index: 5;
        pointer-events: none;
    }
    #janelaChat.fullscreen {
        padding: 0;
        border-radius: 0;
    }
    #janelaChat.fullscreen .modal-content {
        width: 100%;
        height: 100%;
        max-width: 100%;
        border-radius: 0;
        display: flex;
        flex-direction: column;
    }
    #janelaChat.fullscreen #chatInput {
        margin-bottom: 0;
    }
    #janelaChat #carregarMaisMsgBtn {
        margin: 0;
        width: 100%;
        border-radius: 0;
        background-color: var(--cor-botoes);
    }
    .portfolio-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px;
      padding: 10px;
      max-height: 70vh;
      overflow-y: auto;
    }
    .portfolio-grid img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid var(--cor-borda);
    }
    #modalPortfolioCliente .modal-content, #lojaView .modal-content {
        width: 100%;
        height: 100%;
        max-width: 100%;
        border-radius: 0;
        display: flex;
        flex-direction: column;
    }
    #portfolioInputsContainer {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 10px;
        max-height: 400px;
        overflow-y: auto;
        padding: 5px;
        background: var(--cor-fundo);
        border-radius: 8px;
    }
    .portfolio-admin-item {
        border: 1px solid var(--cor-borda);
        border-radius: 8px;
        overflow: hidden;
        background: var(--cor-botoes);
        display: flex;
        flex-direction: column;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .portfolio-admin-item img {
        width: 100%;
        height: 100px;
        object-fit: cover;
        background: #333;
        border-bottom: 1px solid var(--cor-borda);
    }
    .portfolio-admin-item input {
        width: 100%;
        border-radius: 0;
        margin: 0;
        border: none;
        font-size: 12px;
        padding: 8px;
        box-sizing: border-box;
    }
    .loja-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        padding: 10px;
        flex-grow: 1;
        overflow-y: auto;
    }
    .produto-card {
        background: var(--cor-botoes);
        border-radius: 12px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        border: 1px solid var(--cor-borda);
        cursor: pointer;
    }
    .produto-card img {
        width: 100%;
        height: 150px;
        object-fit: cover;
    }
    .produto-info {
        padding: 10px;
        text-align: center;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    .produto-nome { font-weight: 600; font-size: 1em; }
    .produto-preco { font-size: 1.1em; color: var(--cor-destaque); margin-top: 5px; }
    .produto-preco-original { text-decoration: line-through; opacity: 0.7; font-size: 0.9em; }
    .produto-card button { font-size: 14px; padding: 8px; margin-top: 10px;}
    #lojaView .card-header { display: flex; justify-content: space-between; align-items: center; }
    #lojaView .card-header h3 { font-size: 1.1em; white-space: nowrap; }
    #lojaContainer h4 { font-size: 1.0em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .tamanho-options { display: flex; gap: 5px; justify-content: center; margin: 10px 0; }
    .tamanho-options label {
      padding: 5px 10px;
      border: 1px solid var(--cor-borda);
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    .tamanho-options input { display: none; }
    .tamanho-options input:checked + label {
      background: var(--cor-destaque);
      color: var(--cor-fundo);
      border-color: var(--cor-destaque);
    }
    .checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; }
    .checkbox-group label { display: flex; align-items: center; gap: 5px; }
    .checkbox-group input { width: auto; margin: 0; }

    .modal-venda {
      z-index: 99;
    }
    .modal-venda .modal-content {
      background: #c0392b;
      color: white;
      text-align: center;
      border: 3px solid #e74c3c;
      animation: flash-red 1.5s infinite;
    }
    .modal-venda h3 {
      color: white;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    @keyframes flash-red {
      0%, 100% { background-color: #c0392b; }
      50% { background-color: #e74c3c; }
    }
    .barbeiro-list-container {
      width: 100%;
      max-height: 70vh;
      overflow-y: auto;
      padding: 0 10px;
      box-sizing: border-box;
    }
    .promo-info {
      font-size: 0.8em;
      color: var(--cor-destaque);
      margin: 8px 0 0 0;
      padding-top: 8px;
      border-top: 1px dashed var(--cor-borda);
    }
    #pix-qrcode {
        max-width: 200px;
        margin: 15px auto;
        display: block;
        border: 5px solid white;
        border-radius: 10px;
    }
    .pix-copia-cola-container {
      position: relative;
    }
    .pix-copia-cola-container button {
        width: 100%;
    }
    #pixChaveAleatoria {
        display: none;
    }
    .metodos-grid {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-top: 20px;
    }
    #detalhesProdutoAvaliacao {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid var(--cor-borda);
    }
    .avaliacao-estrelas {
        font-size: 1.2em;
        color: var(--cor-destaque);
    }
    .avaliacao-comentario {
        font-style: italic;
        opacity: 0.8;
        margin-top: 5px;
        font-size: 0.9em;
        background: var(--cor-botoes);
        padding: 8px;
        border-radius: 8px;
    }
    #detalhesProdutoImgContainer { /* Changed ID */
        width: 100%;
        height: 250px;
        margin-bottom: 15px;
        background-color: var(--cor-botoes);
        border-radius: 10px;
        position: relative; /* Needed for slider buttons if added */
        overflow: hidden; /* Ensure images don't overflow */
    }
    #detalhesProdutoImgContainer img { /* Style for images inside */
        display: block;
        width: 100%;
        height: 100%;
        object-fit: contain;
    }
    #popupAguarde {
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        z-index: 101;
    }
    #popupAguarde .modal-content {
        background: transparent;
        box-shadow: none;
        border: none;
        text-align: center;
        font-size: 1.2em;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .spinner {
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top: 4px solid var(--cor-destaque);
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px auto;
    }
    .modal-fullscreen {
        align-items: flex-end;
        background: none;
    }
    .modal-fullscreen .modal-content {
        width: 100%;
        height: 90vh;
        max-width: 100%;
        border-radius: 20px 20px 0 0;
        animation: slide-up 0.5s ease-out;
    }
    @keyframes slide-up {
        from { transform: translateY(100%); }
        to { transform: translateY(0); }
    }
    #onboardingContent {
        text-align: center;
    }
    #onboardingContent img {
        max-width: 80%;
        height: auto;
        margin-bottom: 20px;
    }
    .interest-options button {
        background: var(--cor-botoes);
        border: 2px solid transparent;
        transition: all 0.3s ease;
    }
    .interest-options button.selected {
        border-color: var(--cor-destaque);
        background: var(--cor-destaque-ouro);
        color: var(--cor-fundo);
        box-shadow: 0 0 15px var(--cor-destaque-ouro);
    }
    .onboarding-background-img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0.15;
      z-index: -1;
      border-radius: 20px 20px 0 0;
    }
    .onboarding-content-wrapper {
      position: relative;
      z-index: 1;
      padding: 20px;
      color: white;
      text-shadow: 1px 1px 3px black;
    }
    #modalOnboarding .modal-content {
        padding: 0;
        border-radius: 0;
        height: 100%;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background-image: linear-gradient(rgba(0,0,0, 0.7), rgba(0,0,0, 0.7)), url('https://i.postimg.cc/NjxQW6sm/ezgif-com-animated-gif-maker.gif');
        background-size: cover;
        background-position: center;
    }
    @keyframes blink-animation {
      0%, 100% { background-color: var(--cor-botoes); }
      50% { background-color: var(--cor-destaque); }
    }
    .blinking-button.closed {
      animation: blink-animation 2s infinite;
    }
    .chat-tabs {
        display: flex;
        border-bottom: 1px solid var(--cor-borda);
        margin-bottom: 10px;
    }
    .chat-tab {
        flex: 1;
        text-align: center;
        padding: 10px;
        cursor: pointer;
        border-bottom: 3px solid transparent;
    }
    .chat-tab.active {
        border-bottom-color: var(--cor-destaque);
    }
    .config-section button.selected {
        background-color: var(--cor-destaque);
        color: var(--cor-fundo);
    }
    #modalVipPro .modal-content {
        max-height: 85vh;
        overflow-y: auto;
    }
    #vipProContentContainer {
        padding-bottom: 20px;
    }
    .rating-stars {
        text-align: center;
        font-size: 2.5em;
        cursor: pointer;
        margin: 10px 0;
        color: #444;
    }
    .rating-stars span {
        transition: color 0.2s;
    }
    .rating-stars span:hover,
    .rating-stars span.hovered,
    .rating-stars span.selected {
        color: var(--cor-destaque);
    }
    #modalAdminGerenciarUsuario .modal-content {
        max-height: 80vh;
        overflow-y: auto;
    }

  </style>
</head>
<body>

<div id="modalAlterarSenha" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>üîë Alterar Senha</h3>
    <input id="senhaAntiga" type="password" placeholder="Senha Atual">
    <input id="senhaNova" type="password" placeholder="Nova Senha (m√≠nimo 6 caracteres)">
    <input id="senhaNovaConfirm" type="password" placeholder="Confirmar Nova Senha">
    <button onclick="alterarSenhaUsuario()">‚úÖ Confirmar Altera√ß√£o</button>
    <button data-modal-id="modalAlterarSenha" onclick="fecharModal(event)">‚ùå Cancelar</button>
  </div>
</div>

<div id="popupAguarde" class="modal" onclick="fecharAguarde(event)">
  <div class="modal-content">
    <div class="spinner"></div>
    <span id="popupAguardeTexto">Aguarde...</span>
  </div>
</div>

<div id="modalOnboarding" class="modal modal-fullscreen">
  <div class="modal-content">
    <div id="onboardingContent">
      </div>
  </div>
</div>

<div class="topbar hidden" id="topbar">
  <div class="logo">Nova Vers√£o</div>
  <div class="topbar-right">
    <button id="btnTema" onclick="alternarTema()">üåô</button>
    <button id="btnConfig" onclick="abrirModal('modalConfiguracoes')">‚öôÔ∏è</button>
    <button id="btnCarteiraTop" class="hidden" onclick="abrirModal('modalCarteira')">üí∞ R$ <span id="saldoHeader">0,00</span></button>
  </div>
</div>

<div class="content-container">

  <div id="chatPreview"></div> <div id="botaoExtra" class="hidden"></div>

  <div id="authView" class="card hidden">
    <h2>üîê Entrar ou Criar Conta</h2>
    <input id="email" type="email" placeholder="üìß Email">
    <input id="senha" type="password" placeholder="üîë Senha">
    <div id="cadastro-fields" class="hidden">
      <input id="nomeExibido" type="text" placeholder="üòÄ Nome Exibido (obrigat√≥rio)">
      <div class="show-password-container">
        <input id="senha-cadastro" type="password" placeholder="üîë Senha (vis√≠vel)">
      </div>
      <div class="show-password-container">
        <input id="senha-confirm" type="password" placeholder="üîë Confirmar Senha (vis√≠vel)">
      </div>
      <select id="tipo">
        <option value="cliente">üôã Cliente</option>
        <option value="barbeiro">üíà Barbeiro</option>
        <option value="manicure_pedicure">üíÖ Manicure/Pedicure</option>
        <option value="designer_cilios">üëÅÔ∏è Designer de C√≠lios</option>
      </select>
      <input id="telefone" type="tel" placeholder="üìû Telefone com DDD (ex: 27999999999)">
      <input id="rua" type="text" placeholder="Endere√ßo (Rua)" class="hidden">
      <input id="numero" type="text" placeholder="Endere√ßo (N√∫mero)" class="hidden">
      <select id="estado" onchange="carregarCidades()">
        <option value="">üåé Selecione seu estado</option>
      </select>
      <select id="cidade">
        <option value="">üèôÔ∏è Selecione sua cidade</option>
      </select>
      <input id="indicador" type="text" placeholder="üì® Email de quem te indicou? (opcional)">
      <button onclick="obterLocalizacaoCadastro()" id="btnLocalizacaoCadastro">üìç Usar minha localiza√ß√£o atual</button>
    </div>
    <button onclick="entrar()">‚û°Ô∏è Entrar</button>
    <button id="btnCriarConta" onclick="prepararCriarConta()">üÜï Criar conta</button>
    <button id="btnVoltar" class="hidden" onclick="voltarParaLogin()">‚¨ÖÔ∏è Voltar</button>
    <button onclick="abrirModal('modalEsqueciSenha')" style="background: none; border: none; color: var(--cor-destaque); margin-top: 10px; width: 100%;">Esqueci minha senha</button>
  </div>

  <div id="guestView" class="card">
    <h2>üôã Painel de Visitante</h2>
    <p style="text-align: center; font-size: 14px; opacity: 0.8;">Bem-vindo! Para interagir, crie uma conta ou fa√ßa login.</p>
    <button onclick="toggleFuncoes('guestFuncoesContainer')">‚öôÔ∏è Fun√ß√µes do Visitante</button>
    <div id="guestFuncoesContainer" class="hidden">
        <div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:10px;">
          <button>üìú Hist√≥rico</button>
          <button>üíé VIP</button>
          <button>üí∞ Carteira</button>
          <button>üèÜ Fidelidade</button>
          <button>üì∞ Blog</button>
          <button>üèÖ Conquistas</button>
          <button>üìä Ranking</button>
          <button onclick="mostrar('lojaView'); carregarProdutos();">üõçÔ∏è Loja</button>
        </div>
    </div>
    <hr style="border-color: var(--cor-borda); margin: 20px 0;">
    <div id="listaBarbeirosPrincipalGuest" class="barbeiro-list-container"></div>
  </div>

  <div id="clienteView" class="hidden card">
    <h2>üôã Painel do Cliente</h2>
    <button onclick="toggleFuncoes('clienteFuncoesContainer')" class="blinking-button closed">‚öôÔ∏è Fun√ß√µes do Cliente</button>
    <div id="clienteFuncoesContainer" class="hidden">
        <div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:10px;">
          <button id="btnHistoricoCliente" onclick="abrirHistoricoCliente()" style="width:45%">üìú Hist√≥rico</button>
          <button id="btnVip" onclick="abrirModalVip()" style="width:45%">üíé VIP</button>
          <button onclick="abrirModal('modalCarteira')" style="width:45%">üí∞ Carteira</button>
          <button onclick="abrirModalFidelidade()" style="width:45%">üèÜ Fidelidade</button>
          <button onclick="carregarListaBlog(); abrirModal('modalBlog')" style="width:45%">üì∞ Blog</button>
          <button onclick="abrirModalConquistas()" style="width:45%">üèÖ Conquistas</button>
          <button onclick="abrirModalRankingUnificado()" style="width:45%">üìä Ranking</button>
          <button id="btnGerenciarLojaCliente" onclick="abrirGerenciarLoja()" class="hidden" style="width:45%">üè™ Minha Loja</button>
          <button id="btnMinhasCompras" onclick="abrirMinhasCompras()" style="width:45%">üõçÔ∏è Minhas Compras</button>
        </div>
    </div>
    <hr style="border-color: var(--cor-borda); margin: 20px 0;">
    <div id="listaBarbeirosPrincipalCliente" class="barbeiro-list-container"></div>
  </div>

  <div id="barbeiroView" class="hidden card">
    <h2>üíà Painel do Profissional</h2>
    <button onclick="toggleFuncoes('barbeiroFuncoesContainer')" class="blinking-button closed">‚öôÔ∏è Fun√ß√µes do Profissional</button>
    <div id="barbeiroFuncoesContainer" class="hidden">
        <div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:10px;">
          <button onclick="abrirServicos()" style="width:45%">‚úÇÔ∏è Servi√ßos</button>
          <button onclick="abrirAgenda()" style="width:45%">üìÖ Agenda</button>
          <button id="btnAgendamentosBarbeiro" onclick="abrirAgendamentosBarbeiro()" style="width:45%">‚è∞ Agendamentos</button>
          <button onclick="abrirClientesBarbeiro()" style="width:45%">üßë‚Äçü§ù‚Äçüßë Clientes</button>
          <button onclick="abrirPromocoes()" style="width:45%">üéÅ Promo√ß√µes</button>
          <button onclick="abrirModal('modalCarteira')" style="width:45%">üí∞ Carteira</button>
          <button onclick="abrirHistoricoBarbeiro()" style="width:45%">üìú Hist√≥rico</button>
          <button id="btnAvaliacoesBarbeiro" onclick="abrirAvaliacoesBarbeiro()" style="width:45%">‚≠ê Avalia√ß√µes</button>
          <button onclick="abrirModalPortfolioBarbeiro()" style="width:45%">üñºÔ∏è Portf√≥lio</button>
          <button onclick="abrirModal('modalLogomarca')" style="width:45%">üé® Logomarca</button>
          <button onclick="abrirModal('modalAlterarEnderecoBarbeiro')" style="width:45%">üìç Alterar Endere√ßo</button>
          <button onclick="abrirModalDashboardBarbeiro()" style="width:45%">üöÄ Desempenho</button>
          <button onclick="abrirModalConquistasBarbeiro()" style="width:45%">üèÖ Conquistas</button>
          <button onclick="abrirModalRankingUnificado()" style="width:45%">üìä Ranking</button>
          <button onclick="carregarListaBlog(); abrirModal('modalBlog')" style="width:45%">üì∞ Blog</button>
          <button id="btnGerenciarLojaBarbeiro" onclick="abrirGerenciarLoja()" class="hidden" style="width:45%">üè™ Gerenciar Loja</button>
          <button onclick="abrirModalTurbinar()" style="width:92%; background: linear-gradient(45deg, var(--cor-destaque), #ffeb3b);">üöÄ Turbinar Perfil (R$ 9,99)</button>
          <button id="btnVipPro" onclick="abrirModalVipPro()" style="width:92%; background: linear-gradient(45deg, var(--cor-destaque-azul), #00c6ff);">üåü Seja PRO (R$ 29,99/m√™s)</button>
        </div>
    </div>
     <hr style="border-color: var(--cor-borda); margin: 20px 0;">
    <div id="listaBarbeirosPrincipalBarbeiro" class="barbeiro-list-container"></div>
  </div>

  <div id="adminView" class="hidden card">
    <h2>üß† Painel do Admin</h2>
    <div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center">
      <button onclick="abrirModalEstatisticas()" style="width:45%">üìä Estat√≠sticas</button>
      <button id="btnAdminSolicitacoes" onclick="abrirModalSolicitacoes()" style="width:45%">üì• Solicita√ß√µes</button>
      <button onclick="abrirModalUsuarios()" style="width:45%">üë• Usu√°rios</button>
      <button id="btnAdminDenuncias" onclick="abrirDenuncias()" style="width:45%">üö® Den√∫ncias</button>
      <button onclick="abrirModal('modalCarteira')" style="width:45%">üí∞ Carteira</button>
      <button onclick="abrirGerenciarLojaAdmin()" style="width:45%">üõçÔ∏è Gerenciar Loja</button>
      <button onclick="abrirModal('modalBlogAdmin')" style="width:45%">‚úçÔ∏è Publicar Blog</button>
      <button onclick="abrirModal('modalNotificacaoMarketing')" style="width:92%">üì£ Enviar Notifica√ß√£o Geral</button>
    </div>
  </div>

  <div id="lojaView" class="hidden card">
    <div class="card-header">
        <h3>üõçÔ∏è Loja Nova Vers√£o</h3>
    </div>
    <div id="lojaContainer" class="loja-grid">
    </div>
</div>

</div>

<div class="redeem-container hidden" id="redeemContainer">
  <button id="btnResgatar" onclick="abrirPortaSecreta()">‚ú® Resgatar C√≥digo</button>
</div>

<div class="bottom-buttons-container hidden" id="bottomButtons">
  <button id="btnDenuncia" onclick="abrirModal('modalDenuncia')">üö®</button>
  <button id="btnChat" onclick="abrirChatGlobal()">
    <span>üí¨</span>
    <span class="notification-badge hidden">0</span>
  </button>
</div>

<button id="btnSair" class="hidden" onclick="fazerLogout()">üö™ Sair</button>

<div id="modalConfiguracoes" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>‚öôÔ∏è Configura√ß√µes</h3>
    <div class="popup-section">
      <h4>üîí Seguran√ßa</h4>
      <button onclick="abrirModal('modalAlterarSenha'); fecharModalAtual();">Alterar Minha Senha</button>
    </div>
    <div class="popup-section config-section">
      <h4>‚ù§Ô∏è Meu Interesse Principal</h4>
      <div id="configInteresseContainer" style="display:flex; gap:10px;">
          <button data-interesse="barbeiro">Barbearias</button>
          <button data-interesse="manicure_pedicure">Unhas</button>
          <button data-interesse="designer_cilios">C√≠lios</button>
      </div>
    </div>
    <div class="popup-section">
        <h4>üìç Minha Localiza√ß√£o Padr√£o</h4>
        <select id="configEstado" onchange="carregarCidades('config')"></select>
        <select id="configCidade"></select>
        <button onclick="salvarLocalizacaoConfig()">Salvar Localiza√ß√£o</button>
    </div>
    <div class="popup-section">
      <h4>‚öñÔ∏è Legal</h4>
      <div style="display:flex; flex-direction:column; gap:10px;">
        <button onclick="abrirModal('modalTermosUso')">Termos de Uso</button>
        <button onclick="abrirModal('modalTermosPrivacidade')">Termos de Privacidade</button>
        <button onclick="abrirModal('modalTermosCookies')">Termos de Cookies</button>
      </div>
    </div>
    <button data-modal-id="modalConfiguracoes" onclick="fecharModal(event)">‚ùå Fechar</button>
  </div>
</div>

<div id="modalTermosUso" class="modal" onclick="fecharModal(event)"><div class="modal-content" onclick="event.stopPropagation()"><h3>Termos de Uso</h3><p class="scrollable-list">Bem-vindo ao Nova Vers√£o! Ao usar nosso aplicativo, voc√™ concorda em seguir nossas regras de conduta, respeitar outros usu√°rios e profissionais, e usar a plataforma para os fins a que se destina. Viola√ß√µes podem resultar na suspens√£o da conta.</p><button data-modal-id="modalTermosUso" onclick="fecharModal(event)">Fechar</button></div></div>
<div id="modalTermosPrivacidade" class="modal" onclick="fecharModal(event)"><div class="modal-content" onclick="event.stopPropagation()"><h3>Termos de Privacidade</h3><p class="scrollable-list">Sua privacidade √© importante. Coletamos dados como nome, e-mail e localiza√ß√£o para fornecer e melhorar nossos servi√ßos. N√£o compartilhamos seus dados pessoais com terceiros sem seu consentimento, exceto quando exigido por lei.</p><button data-modal-id="modalTermosPrivacidade" onclick="fecharModal(event)">Fechar</button></div></div>
<div id="modalTermosCookies" class="modal" onclick="fecharModal(event)"><div class="modal-content" onclick="event.stopPropagation()"><h3>Termos de Cookies</h3><p class="scrollable-list">Utilizamos cookies e tecnologias semelhantes para manter sua sess√£o ativa, lembrar suas prefer√™ncias e garantir o funcionamento do aplicativo. Ao continuar usando o Nova Vers√£o, voc√™ concorda com nosso uso de cookies.</p><button data-modal-id="modalTermosCookies" onclick="fecharModal(event)">Fechar</button></div></div>

<div id="modalCarteira" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>üí∞ Minha Carteira</h3>
    <p>Seu saldo atual √©: <b style="color: var(--cor-destaque);">R$ <span id="saldoModal">0,00</span></b></p>
    <button onclick="iniciarDeposito()">üì• Depositar</button>
    <button onclick="iniciarSaque()">üì§ Sacar</button>
    <button data-modal-id="modalCarteira" onclick="fecharModal(event)">‚ùå Fechar</button>
  </div>
</div>

<div id="modalDepositoFormulario" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>üìù Informa√ß√µes para Dep√≥sito</h3>
    <p>Preencha seus dados para continuar.</p>
    <input id="depositoPrimeiroNome" type="text" placeholder="Primeiro Nome">
    <input id="depositoSegundoNome" type="text" placeholder="Segundo Nome">
    <input id="depositoCpf" type="text" placeholder="CPF">
    <input id="depositoTelefone" type="tel" placeholder="Telefone com DDD">
    <input id="depositoValor" type="number" placeholder="üí∞ Valor a depositar (Ex: 50.00)">
    <button id="btnContinuarDeposito" onclick="criarSolicitacaoDeposito()" disabled>Continuar</button>
    <button data-modal-id="modalDepositoFormulario" onclick="fecharModal(event)">‚ùå Fechar</button>
  </div>
</div>

<div id="modalDeposito" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>üí∞ Dep√≥sito de Cr√©ditos</h3>
    <p>Escolha um m√©todo de pagamento para adicionar saldo √† sua carteira.</p>
    <div class="metodos-grid">
        <button id="btnPagarComPix" onclick="processarPagamentoPixAprimorado()">‚ö° PIX (QR Code)</button>
        <button id="btnPagarComCartao" onclick="abrirModalTaxaCartao()">üí≥ Cart√£o de Cr√©dito</button>
    </div>
    <button data-modal-id="modalDeposito" onclick="fecharModal(event)">‚ùå Voltar</button>
  </div>
</div>

<div id="modalTaxaCartao" class="modal">
    <div class="modal-content" style="text-align: center;">
        <h3>‚ö†Ô∏è Taxa de Plataforma</h3>
        <p style="font-size: 14px;">Para garantir a transpar√™ncia e a seguran√ßa da sua transa√ß√£o com cart√£o de cr√©dito, informamos que h√° uma taxa administrativa fixa cobrada pela plataforma de pagamentos.</p>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
           <button onclick="fecharModalAtual()" style="background-color: #555;">Cancelar</button>
           <button onclick="processarPagamentoCartaoAprimorado()">Continuar</button>
        </div>
    </div>
</div>

<div id="modalGerandoQRCode" class="modal">
    <div class="modal-content" style="text-align: center;">
        <h3 style="color: var(--cor-destaque);">Gerando QR CODE</h3>
        <p>Aguarde um instante...</p>
    </div>
</div>

<div id="modalCarregandoGenerico" class="modal">
    <div class="modal-content" style="text-align: center;">
        <h3 id="carregandoGenericoTitulo" style="color: var(--cor-destaque);">Aguarde...</h3>
        <p id="carregandoGenericoTexto">Estamos processando sua solicita√ß√£o.</p>
    </div>
</div>

<div id="modalExibirPixAprimorado" class="modal">
    <div class="modal-content" style="text-align: center;">
      <h3> Pague com PIX</h3>
      <p>Escaneie o QR Code abaixo com seu app de banco.</p>
      <img src="https://i.postimg.cc/fTZyFN6G/qrcode.jpg" id="pix-qrcode" alt="QR Code PIX">
      <div class="pix-copia-cola-container">
          <textarea id="pixChaveAleatoria">00020126770014BR.GOV.BCB.PIX0136ec4a8f0f-ec59-44bc-afcf-dff364f971de0215NAVALHA DE OURO5204000053039865802BR5920Josiel Lopes Azeredo6009SAO PAULO62140510vuyKg7Qnmx63041C39</textarea>
          <button onclick="copiarCodigoPixAprimorado(event)">Copiar Chave Aleat√≥ria PIX</button>
      </div>
      <p style="font-size: 14px; color: #ff9800; margin-top: 15px;">Este c√≥digo expira em: <b id="pixTimer">10:00</b></p>
      <button onclick="confirmarEnvioComprovante()">CONFIRMAR</button>
    </div>
</div>

<div id="modalPixExpirado" class="modal" style="z-index: 22;">
    <div class="modal-content" style="text-align: center;">
        <h3 style="color: #e74c3c;">Tempo Expirado!</h3>
        <p>O tempo para pagamento deste PIX acabou.</p>
        <div style="display:flex; gap: 10px; margin-top: 20px;">
            <button onclick="fecharTodosOsModais()" style="background: #555;">Fechar</button>
            <button onclick="tentarGerarPixNovamente()">Tentar Novamente</button>
        </div>
    </div>
</div>

<div id="modalSaque" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>üì§ Solicitar Saque</h3>
    <p>O valor ser√° transferido para sua chave PIX ap√≥s aprova√ß√£o do administrador.</p>
    <input id="saqueValor" type="number" placeholder="Valor do saque">
    <select id="saqueChavePixTipo">
      <option value="">Tipo de Chave PIX</option>
      <option value="cpf">CPF</option>
      <option value="email">E-mail</option>
      <option value="telefone">Telefone</option>
      <option value="aleatoria">Aleat√≥ria</option>
    </select>
    <input id="saqueChavePix" type="text" placeholder="Sua chave PIX">
    <button id="btnConfirmarSaque" onclick="confirmarSaque()">‚úÖ Confirmar Saque</button>
    <button data-modal-id="modalSaque" onclick="fecharModal(event)">‚ùå Cancelar</button>
  </div>
</div>

<div id="modalSaqueConfirmado" class="modal">
  <div class="modal-content" style="text-align:center;">
    <h3>‚úÖ Solicita√ß√£o Enviada!</h3>
    <p>Sua solicita√ß√£o de saque foi enviada para an√°lise.</p>
    <p style="font-size:14px; opacity: 0.8;">Para agilizar, entre em contato com o administrador.</p>
    <button onclick="contatarAdminSaque()">OK</button>
  </div>
</div>

<div id="janelaChat" class="modal fullscreen" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="chat-tabs">
        <div class="chat-tab active" id="tabChatGlobal" onclick="alternarChat('global')">üåé Global</div>
        <div class="chat-tab" id="tabChatLocal" onclick="alternarChat('local')">üìç Local</div>
    </div>
    <button id="carregarMaisMsgBtn" onclick="carregarMensagensAnteriores()">Ver mensagens anteriores</button>
    <h3 id="chatTitle">üí¨ Chat Global</h3>
    <div id="chatMessages" class="chat-container"></div>
    <input id="chatInput" placeholder="Digite sua mensagem">
    <button onclick="enviarMensagem()">‚û°Ô∏è Enviar</button>
    <button data-modal-id="janelaChat" onclick="fecharModal(event)">‚ùå Fechar</button>
  </div>
</div>

<div id="adminChatSelectorContainer" class="hidden" style="display: flex; gap: 10px; margin-bottom: 10px; padding: 5px; background: var(--cor-botoes); border-radius: 8px;">
    <select id="adminChatEstado" onchange="adminCarregarCidadesChat()"></select>
    <select id="adminChatCidade" onchange="adminRecarregarChat()"></select>
</div>

<div id="modalDenuncia" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>üö® Denunciar</h3>
    <p>Envie sua mensagem e o administrador responder√° em breve!</p>
    <textarea id="textoDenuncia" placeholder="Descreva o problema em detalhes"></textarea>
    <button onclick="enviarDenuncia()">‚û°Ô∏è Enviar</button>
    <button data-modal-id="modalDenuncia" onclick="fecharModal(event)">‚ùå Fechar</button>
  </div>
</div>

<div id="modalDenunciaEnviada" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>‚úÖ Den√∫ncia Enviada!</h3>
    <p>Agradecemos a sua den√∫ncia. Ela ser√° analisada pela nossa equipe.</p>
    <p>üí¨ Se preferir, clique no bot√£o abaixo para avisar o administrador diretamente no WhatsApp e agilizar o processo.</p>
    <a id="btnWhatsappDenuncia" href="#" target="_blank">
      <button>üí¨ Avisar no WhatsApp</button>
    </a>
    <button data-modal-id="modalDenunciaEnviada" onclick="fecharModal(event)">‚ùå Fechar</button>
  </div>
</div>

<div id="modalBlog" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>üì∞ Blog</h3>
    <div id="listaBlog" class="scrollable-list"></div>
    <button data-modal-id="modalBlog" onclick="fecharModal(event)">‚ùå Fechar</button>
  </div>
</div>

<div id="modalVip" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div id="vipContentContainer">
    </div>
    <button data-modal-id="modalVip" onclick="fecharModal(event)">‚ùå Fechar</button>
  </div>
</div>

<div id="modalVipPro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div id="vipProContentContainer">
      </div>
    <button data-modal-id="modalVipPro" onclick="fecharModal(event)">‚ùå Fechar</button>
  </div>
</div>

<div id="modalFidelidade" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>üèÜ Programa de Fidelidade</h3>
    <p>Seus pontos: <b id="pontosFidelidade">0</b></p>
    <p style="font-size: 14px; color: var(--cor-destaque-prata);">Acumule pontos em cada agendamento e troque por descontos!</p>
    <button onclick="resgatarPontos()">üéÅ Resgatar 100 pontos por R$ 5,00</button>
    <button data-modal-id="modalFidelidade" onclick="fecharModal(event)">‚ùå Fechar</button>
  </div>
</div>

<div id="modalBarbeiroPerfil" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div id="barbeiroPerfilHeader">
      <h3 id="barbeiroPerfilNome"></h3>
      <p>Endere√ßo: <span id="barbeiroPerfilEndereco"></span></p>
      <p>Reputa√ß√£o: <span id="barbeiroPerfilReputacao"></span></p>
      <img id="profissionalLogo" src="" alt="Logomarca" style="max-width: 100px; border-radius: 50%; display: none; margin: 10px auto;">
    </div>

    <div id="barbeiroPerfilServicos" class="popup-section">
      <h4>1. Escolha um Servi√ßo</h4>
      <div id="barbeiroPerfilServicosList" class="scrollable-list" style="max-height: 150px;"></div>
    </div>

    <div id="barbeiroPerfilHorarios" class="popup-section">
      <h4>2. Escolha uma Op√ß√£o</h4>
      <div id="barbeiroPerfilHorariosList"></div>
    </div>

    <div class="modal-footer">
      <button id="btnAcessarPortfolio" class="hidden" style="width: auto; background-color: var(--cor-botoes);">üñºÔ∏è Ver Portf√≥lio</button>
      <button id="btnAbrirRota" class="hidden" style="width: auto; background-color: var(--cor-botoes);">üó∫Ô∏è Rota</button>
      <button id="btnConfirmarAgendamento" disabled>üóìÔ∏è Agendar</button>
    </div>
    <button data-modal-id="modalBarbeiroPerfil" onclick="fecharModal(event)">‚ùå Fechar</button>
  </div>
</div>
<div id="modalVagaImediataAprovada" class="modal" style="z-index: 99;" onclick="fecharModal(event)">
  <div class="modal-content" style="background: #e74c3c; color: white;" onclick="event.stopPropagation()">
    <h3 style="color:white;text-shadow: 2px 2px 4px #000;">‚ö†Ô∏è VAGA IMEDIATA APROVADA!</h3>
    <p style="font-size: 1.2em; text-align: center;"><b>Voc√™ tem 10 minutos para chegar ao local.</b></p>
    <p style="text-align: center;">N√£o se atrase para n√£o perder a vaga e o seu dinheiro!</p>
    <div style="display:flex; gap: 10px; margin-top: 20px;">
      <button data-modal-id="modalVagaImediataAprovada" onclick="fecharModal(event)" style="background:white; color:#e74c3c; flex: 1;">‚úÖ Entendi</button>
      <button id="btnCancelarVagaAprovada" style="background: #333; color: white; flex: 1;">‚ùå Cancelar Agendamento</button>
    </div>
  </div>
</div>

<div id="modalBarbeariasCliente" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>üíà Profissionais dispon√≠veis</h3>
    <input type="text" id="filtroBarbeiro" onkeyup="filtrarBarbeiros()" placeholder="üîé Buscar por profissional ou cidade...">
    <div id='listaBarbeiros' class="scrollable-list"></div>
    <button data-modal-id="modalBarbeariasCliente" onclick="fecharModal(event)">‚ùå Fechar</button>
  </div>
</div>

<div id="modalHistoricoCliente" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>üìú Meu Hist√≥rico</h3>
    <div id="painelHistorico" class="scrollable-list"></div>
    <button data-modal-id="modalHistoricoCliente" onclick="fecharModal(event)">‚ùå Fechar</button>
  </div>
</div>

<div id="modalConquistas" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>üèÖ Minhas Conquistas</h3>
    <div id="listaConquistas" class="scrollable-list"></div>
    <button data-modal-id="modalConquistas" onclick="fecharModal(event)">‚ùå Fechar</button>
  </div>
</div>

<div id="modalRankingUnificado" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>üèÜ Ranking Geral üèÜ</h3>
    <p style="font-size: 12px; opacity: 0.7; text-align:center;">Top 100 com mais servi√ßos conclu√≠dos.</p>
    <div id="listaRankingUnificado" class="scrollable-list"></div>
    <button data-modal-id="modalRankingUnificado" onclick="fecharModal(event)" style="margin-top: 20px;">‚ùå Fechar</button>
  </div>
</div>

<div id="modalCriarPromocao" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>üéÅ Criar Promo√ß√£o</h3>
    <input id="promocaoNome" placeholder="Nome da Promo√ß√£o">
    <input id="promocaoDescricao" placeholder="Descri√ß√£o curta">
    <input type="number" id="promocaoDesconto" placeholder="Desconto em % (ex: 15)">
    <button onclick="criarPromocao()">üíæ Salvar Promo√ß√£o</button>
    <button data-modal-id="modalCriarPromocao" onclick="fecharModal(event)">‚ùå Fechar</button>
  </div>
</div>

<div id="modalLogomarca" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>üé® Adicionar Logomarca</h3>
    <p style="font-size: 12px; opacity: 0.8;">Use o site <a href="https://postimages.org/" target="_blank">Postimages.org</a> para hospedar sua imagem gratuitamente e cole o "Link Direto" abaixo.</p>
    <img id="logomarcaPreview" src="https://via.placeholder.com/100?text=Logo" alt="Preview" style="max-width: 100px; border-radius: 50%; display: block; margin: 10px auto; border: 1px solid var(--cor-borda);">
    <input type="file" id="logomarcaFile" accept="image/*,image/gif" onchange="previewImage(this, 'logomarcaPreview')">
    <progress id="logomarcaProgress" value="0" max="100" style="width: 100%; display: none;"></progress>
    <button onclick="uploadLogomarca()">üíæ Salvar Logomarca</button>
    <button data-modal-id="modalLogomarca" onclick="fecharModal(event)">‚ùå Fechar</button>
  </div>
</div>

<div id="modalAlterarEnderecoBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>üìç Alterar Endere√ßo</h3>
    <input id="novoEnderecoRua" type="text" placeholder="Nova Rua">
    <input id="novoEnderecoNumero" type="text" placeholder="Novo N√∫mero">
    <button onclick="salvarNovoEndereco()">üíæ Salvar Endere√ßo Manualmente</button>
    <button id="btnSalvarLocalAtual" onclick="salvarLocalizacaoAtualEndereco()">üìç Salvar Localiza√ß√£o Atual</button>
    <button data-modal-id="modalAlterarEnderecoBarbeiro" onclick="fecharModal(event)">‚ùå Fechar</button>
  </div>
</div>

<div id="modalAvaliacoes" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>‚≠ê Minhas Avalia√ß√µes</h3>
        <div id="listaAvaliacoesModal" class="scrollable-list"></div>
        <button data-modal-id="modalAvaliacoes" onclick="fecharModal(event)">‚ùå Fechar</button>
    </div>
</div>

<div id="modalServicosBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>‚úÇÔ∏è Meus Servi√ßos</h3>
    <div id="listaServicosBarbeiro" class="scrollable-list"></div>
    <button onclick="adicionarServico()">‚ûï Adicionar novo servi√ßo</button>
    <button data-modal-id="modalServicosBarbeiro" onclick="fecharModal(event)">‚ùå Fechar</button>
  </div>
</div>

<div id="modalAgendaBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>üìÖ Minha Agenda</h3>
    <p>Use os bot√µes abaixo para gerenciar sua disponibilidade e hor√°rios.</p>
    <button id="btnDisponibilidade" onclick="toggleDisponibilidade()"></button>
    <button id="btnVagaImediata" onclick="toggleVagaImediata()"></button>
    <button id="btnAgendaManual" onclick="toggleAgendaManual()"></button>
    <button id="btnModoFerias" onclick="abrirModal('modalModoFerias')">üèñÔ∏è Ativar Modo F√©rias/Aus√™ncia</button>
    <div id="agendaManualPainel" class="hidden card">
        <h4>Hor√°rios Dispon√≠veis Hoje</h4>
        <p>Selecione os hor√°rios para trabalhar ou clique duas vezes para bloquear.</p>
        <div id="horariosContainer" style="display:flex; flex-wrap:wrap; gap:5px; justify-content: center;"></div>
        <div class="horarios-actions">
            <button onclick="salvarAgendaManual()">üíæ Salvar</button>
        </div>
    </div>
    <button data-modal-id="modalAgendaBarbeiro" onclick="fecharModal(event)">‚ùå Fechar</button>
  </div>
</div>

<div id="modalOnboardingProfissionalServicos" class="modal"><div class="modal-content"><h3>1. Cadastre seus Servi√ßos</h3><p>Adicione pelo menos um servi√ßo para continuar.</p><div id="onboardingServicosList" class="scrollable-list"></div><input id="onboardingServicoNome" placeholder="Nome do Servi√ßo"><input id="onboardingServicoValor" type="number" placeholder="Valor (R$)"><input id="onboardingServicoTempo" type="number" placeholder="Tempo (minutos)"><button onclick="adicionarServicoOnboarding()">Adicionar Servi√ßo</button><button id="btnOnboardingNextServicos" disabled onclick="avancarOnboarding(2)">Pr√≥ximo ‚û°Ô∏è</button></div></div>
<div id="modalOnboardingProfissionalAgenda" class="modal"><div class="modal-content"><h3>2. Configure sua Agenda</h3><p>Como voc√™ ir√° atender seus clientes?</p><button id="onboardingBtnVagaImediata">‚ö° Ativar Vaga Imediata</button><button id="onboardingBtnAgendaManual">üìÖ Usar Agenda Manual</button><div id="onboardingAgendaManualPainel" class="hidden card"><h4>Hor√°rios Dispon√≠veis Hoje</h4><div id="onboardingHorariosContainer" style="display:flex; flex-wrap:wrap; gap:5px; justify-content: center;"></div></div><button onclick="avancarOnboarding(3)">‚úÖ Concluir</button></div></div>

<div id="modalAgendamentosBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>‚è∞ Meus Agendamentos</h3>
    <div id="agendamentosPainel" class="scrollable-list"></div>
    <button data-modal-id="modalAgendamentosBarbeiro" onclick="fecharModal(event)">‚ùå Fechar</button>
  </div>
</div>

<div id="modalClientesBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>üßë‚Äçü§ù‚Äçüßë Meus Clientes</h3>
    <p>Lista de clientes que j√° agendaram com voc√™.</p>
    <div id="listaClientesBarbeiro" class="scrollable-list"></div>
    <button data-modal-id="modalClientesBarbeiro" onclick="fecharModal(event)">‚ùå Fechar</button>
  </div>
</div>

<div id="modalDashboardBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>üöÄ Meu Desempenho</h3>
    <div id="dashboardConteudo">
      <p>Carregando dados...</p>
    </div>
    <button data-modal-id="modalDashboardBarbeiro" onclick="fecharModal(event)">‚ùå Fechar</button>
  </div>
</div>

<div id="modalHistoricoBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>üìú Hist√≥rico de Servi√ßos</h3>
    <div id="painelHistoricoBarbeiro" class="scrollable-list"></div>
    <button data-modal-id="modalHistoricoBarbeiro" onclick="fecharModal(event)">‚ùå Fechar</button>
  </div>
</div>

<div id="modalConquistasBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>üèÖ Minhas Conquistas de Profissional</h3>
    <div id="listaConquistasBarbeiro" class="scrollable-list"></div>
    <button data-modal-id="modalConquistasBarbeiro" onclick="fecharModal(event)">‚ùå Fechar</button>
  </div>
</div>

<div id="modalBlogAdmin" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>‚úçÔ∏è Novo Post</h3>
    <input id="blogTitulo" placeholder="T√≠tulo">
    <textarea id="blogConteudo" placeholder="Conte√∫do do post"></textarea>
    <button onclick="publicarBlog()">‚úçÔ∏è Publicar</button>
    <button data-modal-id="modalBlogAdmin" onclick="fecharModal(event)">‚ùå Fechar</button>
  </div>
</div>

<div id="modalEstatisticas" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>üìä Estat√≠sticas</h3>
    <div id="estatisticasPainel" class="scrollable-list"></div>
    <button data-modal-id="modalEstatisticas" onclick="fecharModal(event)">‚ùå Fechar</button>
  </div>
</div>

<div id="modalSolicitacoes" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>üì• Todas as Solicita√ß√µes</h3>
    <div id="listaSolicitacoes" class="scrollable-list"></div>
    <button data-modal-id="modalSolicitacoes" onclick="fecharModal(event)">‚ùå Fechar</button>
  </div>
</div>

<div id="modalUsuarios" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>üë• Todos os Usu√°rios</h3>
    <div id="usuariosPainel" class="scrollable-list"></div>
    <button data-modal-id="modalUsuarios" onclick="fecharModal(event)">‚ùå Fechar</button>
  </div>
</div>

<div id="modalAdminGerenciarUsuario" class="modal"><div class="modal-content"><h3>Gerenciar Usu√°rio</h3><div id="adminGerenciarConteudo"></div></div></div>

<div id="modalGerenciarLojaAdmin" class="modal"><div class="modal-content"><h3>Gerenciar Loja</h3><div class="popup-section"><h4>Deletar Produto</h4><div id="adminDeletarProdutoList" class="scrollable-list"></div></div><div class="popup-section"><h4>Ativar/Desativar Loja de Vendedor</h4><div id="adminToggleLojaList" class="scrollable-list"></div></div><button data-modal-id="modalGerenciarLojaAdmin" onclick="fecharModal(event)">Fechar</button></div></div>

<div id="modalDenunciasAdmin" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>üö® Den√∫ncias</h3>
    <div id="listaDenuncias" class="scrollable-list"></div>
    <button data-modal-id="modalDenunciasAdmin" onclick="fecharModal(event)">‚ùå Fechar</button>
  </div>
</div>

<div id="modalNotificacaoMarketing" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>üì£ Notifica√ß√£o para Todos</h3>
    <p>Esta mensagem ser√° enviada como uma notifica√ß√£o push para todos os usu√°rios do app.</p>
    <input id="marketingTitulo" placeholder="T√≠tulo da Notifica√ß√£o">
    <textarea id="marketingCorpo" placeholder="Corpo da mensagem"></textarea>
    <button onclick="enviarNotificacaoMarketing()">üöÄ Enviar para todos</button>
    <button data-modal-id="modalNotificacaoMarketing" onclick="fecharModal(event)">‚ùå Fechar</button>
  </div>
</div>

<div id="modalPortfolioBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>üñºÔ∏è Gerenciar Portf√≥lio</h3>
    <p style="font-size: 12px; opacity: 0.8;">Gerencie suas 30 imagens de portf√≥lio. Cole o link direto (que termina com .png ou .jpg) e a imagem aparecer√° instantaneamente.</p>
    <div id="portfolioInputsContainer"></div>
    <button onclick="salvarPortfolio()">üíæ Salvar Portf√≥lio</button>
    <button data-modal-id="modalPortfolioBarbeiro" onclick="fecharModal(event)">‚ùå Fechar</button>
  </div>
</div>

<div id="modalPortfolioCliente" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3 id="portfolioClienteNome">üñºÔ∏è Portf√≥lio</h3>
    <div id="portfolioClienteGrid" class="portfolio-grid"></div>
    <button data-modal-id="modalPortfolioCliente" onclick="fecharModal(event)">‚ùå Fechar</button>
  </div>
</div>

<div id="modalLiberarLoja" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>üõçÔ∏è Acesso √† Loja de Vendedores</h3>
        <p>Voc√™ ainda n√£o tem permiss√£o pra cadastrar produtos na loja. Pe√ßa autoriza√ß√£o pro administrador no WhatsApp.</p>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button data-modal-id="modalLiberarLoja" onclick="fecharModal(event)" style="background-color: #555;">‚Ü©Ô∏è Cancelar</button>
            <button onclick="solicitarLiberacaoLoja()" style="flex-grow: 1;">
                üí¨ Pedir no WhatsApp
            </button>
        </div>
    </div>
</div>

<div id="modalTurbinar" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>üöÄ Turbinar seu Perfil</h3>
        <p>Destaque seu perfil no topo da lista de profissionais por <strong>24 horas</strong> e alcance mais clientes!</p>
        <p style="font-size: 22px; color: var(--cor-destaque); font-weight: bold; text-align: center;">Apenas R$ 9,99</p>
        <button onclick="confirmarTurbinar()">üí• Confirmar e Turbinar</button>
        <button data-modal-id="modalTurbinar" onclick="fecharModal(event)">‚ùå Cancelar</button>
    </div>
</div>

<div id="modalPermissaoNotificacao" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>üîî Fique por Dentro!</h3>
        <p>Ative as notifica√ß√µes para receber alertas importantes sobre seus agendamentos, promo√ß√µes e novidades em tempo real.</p>
        <button onclick="pedirPermissaoEFechar()">üëç Ativar Notifica√ß√µes</button>
        <button data-modal-id="modalPermissaoNotificacao" onclick="fecharModal(event)">‚ùå Agora n√£o</button>
    </div>
</div>

<div id="modalInstalarApp" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>üì± Leve o App com Voc√™!</h3>
        <p>Instale nosso aplicativo na sua tela inicial para um acesso mais r√°pido e uma melhor experi√™ncia.</p>
        <button id="btnInstalarPWA">üì≤ Instalar Agora</button>
        <button data-modal-id="modalInstalarApp" onclick="fecharModal(event)">ü§î Depois</button>
    </div>
</div>

<div id="modalAtualizacao" class="modal" style="z-index: 100;" onclick="fecharModal(event)">
    <div class="modal-content" style="border: 2px solid var(--cor-destaque);" onclick="event.stopPropagation()">
        <h3>üöÄ Nova Vers√£o do App Dispon√≠vel!</h3>
        <p>Uma nova vers√£o do aplicativo est√° pronta. Clique no bot√£o abaixo para atualizar e ter acesso √†s √∫ltimas novidades e melhorias.</p>
        <div style="display:flex; gap: 10px; margin-top: 20px;">
           <button data-modal-id="modalAtualizacao" onclick="fecharModal(event)" style="background: #555;">ü§î Depois</button>
           <button id="btnAtualizarApp" style="flex-grow: 1;">üîÑ Atualize Agora</button>
        </div>
    </div>
</div>

<div id="modalPromocoesBarbeiro" class="modal">
  <div class="modal-content">
    <h2>üéÅ Promo√ß√µes Ativas</h2>
    <div id="listaPromocoes">
      </div>
    <div class="modal-botoes">
      <button onclick="abrirModalAddPromocao()">‚ûï Adicionar Promo√ß√£o</button>
      <button data-modal-id="modalPromocoesBarbeiro" onclick="fecharModal(event)">‚ùå Fechar</button>
    </div>
  </div>
</div>

<div id="modalAddPromocao" class="modal">
  <div class="modal-content">
    <h2>‚ûï Adicionar Nova Promo√ß√£o</h2>

    <input type="text" id="addPromocaoNome" placeholder="Nome da Promo√ß√£o (Ex: Combo Barba+Cabelo)" required>
    <textarea id="addPromocaoDescricao" placeholder="Descri√ß√£o (Ex: V√°lido de segunda a quarta)" required></textarea>

    <div class="popup-section">
      <h4>‚úÇÔ∏è Aplicar a quais servi√ßos?</h4>
      <p style="font-size: 12px; opacity: 0.7;">Segure Ctrl (ou Cmd) para selecionar v√°rios.</p>
      <select id="addPromocaoServicos" multiple style="height: 120px;"></select>
    </div>

    <div class="popup-section">
      <h4>‚öôÔ∏è Condi√ß√µes da Promo√ß√£o</h4>
      <label for="addPromocaoDesconto">Desconto (%):</label>
      <input type="number" id="addPromocaoDesconto" placeholder="Ex: 15" required>

      <label for="addPromocaoValidade">V√°lida at√© (opcional):</label>
      <input type="date" id="addPromocaoValidade">

      <label for="addPromocaoValorMinimo">Valor m√≠nimo do servi√ßo para aplicar (opcional):</label>
      <input type="number" id="addPromocaoValorMinimo" placeholder="Ex: 50">
    </div>

    <button onclick="salvarNovaPromocao()">üíæ Salvar Promo√ß√£o</button>
    <button data-modal-id="modalAddPromocao" onclick="fecharModal(event)">‚ùå Cancelar</button>
  </div>
</div>

<div id="modalLoja" class="modal">
  <div class="modal-content">
    <h3>üõí Produtos da Loja</h3>
    <div id="listaProdutos" class="loja-grid"></div>
    <button data-modal-id="modalLoja" onclick="fecharModal(event)">‚ùå Fechar</button>
  </div>
</div>

<div id="modalProdutoDetalhes" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div id="detalhesProdutoImgContainer"></div>
        <h3 id="detalhesProdutoNome" style="margin: 0; color: var(--cor-destaque);"></h3>

        <p style="margin-top: 15px;"><strong>Tamanho:</strong></p>
        <div id="detalhesProdutoTamanhos" class="tamanho-options"></div>

        <p><strong>Pre√ßo:</strong> <span id="detalhesProdutoPreco" style="font-weight: bold; font-size: 1.2em;"></span></p>
        <p><strong>Descri√ß√£o:</strong></p>
        <p id="detalhesProdutoDescricao" style="font-size: 14px; opacity: 0.9;"></p>

        <div id="detalhesProdutoAvaliacao"></div>

        <button id="btnComprarAgora">Continuar</button>
        <button data-modal-id="modalProdutoDetalhes" onclick="fecharModal(event)">‚ùå Fechar</button>
    </div>
</div>

<div id="modalFormularioCompraLoja" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-overlay-content hidden" id="overlayPagamento">
            <h3>Confirmar Pagamento</h3>
            <p>Debitar <b>R$ <span id="valorDebito">0,00</span></b> do seu saldo da carteira?</p>
            <div style="display: flex; gap: 10px; margin-top: 20px; width: 80%;">
                <button id="btnNaoDebitar" style="background-color: #555;">N√£o</button>
                <button id="btnSimDebitar">Sim</button>
            </div>
        </div>
        <h3>üìù Detalhes para Entrega</h3>
        <input id="compraNomeCompleto" type="text" placeholder="Nome Completo">
        <input id="compraCpf" type="text" placeholder="CPF">
        <input id="compraTelefone" type="tel" placeholder="Telefone para Contato">
        <input id="compraEmail" type="email" placeholder="Email para confirma√ß√£o">
        <input id="compraCep" type="text" placeholder="CEP">
        <input id="compraRua" type="text" placeholder="Endere√ßo Completo (Rua, Bairro...)">
        <input id="compraNumeroCasa" type="text" placeholder="N√∫mero da Casa e Complemento">
        <button id="btnPagarCompraLoja">Pagar</button>
        <button data-modal-id="modalFormularioCompraLoja" onclick="fecharModal(event)">‚ùå Cancelar</button>
    </div>
</div>

<div id="modalGerenciarLoja" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" style="max-width: 600px;">
        <h3>üè™ Gerenciar Minha Loja</h3>
        <div id="listaMeusProdutos" class="scrollable-list"></div>
        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px;">
          <button onclick="abrirFormularioProduto()">‚ûï Adicionar Produto</button>
          <button id="btnEntregasVendedor" onclick="abrirEntregasVendedor()">üöö Entregas</button>
          <button data-modal-id="modalGerenciarLoja" onclick="fecharModal(event)">‚ùå Fechar</button>
        </div>
    </div>
</div>

<div id="modalAddEditProduto" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3 id="formProdutoTitulo">üì¶ Adicionar Novo Produto</h3>
        <p>Imagens do Produto (at√© 5):</p>
        <input type="file" id="produtoImagensFile" accept="image/*,image/gif" multiple onchange="previewProductImages(this)">
        <div id="produtoImagensPreviews" class="portfolio-grid" style="grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); max-height: 100px; overflow-y: auto;"></div>
        <progress id="produtoImagensProgress" value="0" max="100" style="width: 100%; display: none;"></progress>
        <input id="produtoNome" type="text" placeholder="Nome do Produto">
        <input id="produtoPreco" type="number" placeholder="Pre√ßo (Ex: 49.90)">
        <p>Tamanhos dispon√≠veis:</p>
        <div class="checkbox-group">
            <label><input type="checkbox" name="tamanhos" value="P"> P</label>
            <label><input type="checkbox" name="tamanhos" value="M"> M</label>
            <label><input type="checkbox" name="tamanhos" value="G"> G</label>
            <label><input type="checkbox" name="tamanhos" value="GG"> GG</label>
        </div>
        <input id="produtoDesconto" type="number" placeholder="Desconto em % (Opcional)">
        <input id="produtoEntrega" type="text" placeholder="Tempo de entrega (Ex: 3-5 dias)">
        <textarea id="produtoDescricao" placeholder="Descri√ß√£o curta do produto" rows="3"></textarea>
        <button id="btnSalvarProduto" onclick="salvarProdutoVendedor()">üíæ Salvar Produto</button>
        <button data-modal-id="modalAddEditProduto" onclick="fecharModal(event)">‚ùå Cancelar</button>
    </div>
</div>

<div id="modalEntregasVendedor" class="modal" onclick="fecharModal(event)">
    <div class="modal-content">
        <h3>üöö Minhas Entregas</h3>
        <div id="listaEntregas" class="scrollable-list"></div>
        <button data-modal-id="modalEntregasVendedor" onclick="fecharModal(event)">‚ùå Fechar</button>
    </div>
</div>

<div id="modalMinhasCompras" class="modal" onclick="fecharModal(event)">
    <div class="modal-content">
        <h3>üõçÔ∏è Minhas Compras</h3>
        <div id="listaMinhasCompras" class="scrollable-list"></div>
        <button data-modal-id="modalMinhasCompras" onclick="fecharModal(event)">‚ùå Fechar</button>
    </div>
</div>

<div id="modalAvaliarProduto" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>‚≠ê Avaliar Produto</h3>
        <p>Como voc√™ avalia o produto <b id="avaliarProdutoNome"></b>?</p>
        <div class="rating-stars" id="ratingStars">
            <span data-value="1">‚òÜ</span><span data-value="2">‚òÜ</span><span data-value="3">‚òÜ</span><span data-value="4">‚òÜ</span><span data-value="5">‚òÜ</span>
        </div>
        <textarea id="avaliarProdutoComentario" placeholder="Deixe um coment√°rio..." rows="3"></textarea>
        <button id="btnSalvarAvaliacaoProduto">Enviar Avalia√ß√£o</button>
        <button data-modal-id="modalAvaliarProduto" onclick="fecharModal(event)">‚ùå Cancelar</button>
    </div>
</div>

<div id="modalInfoPopup" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3 id="infoPopupTitulo">Aviso</h3>
    <p id="infoPopupMensagem" style="margin-top: 15px;"></p>
    <button data-modal-id="modalInfoPopup" onclick="fecharModal(event)" style="margin-top: 20px;">‚úÖ OK</button>
  </div>
</div>

<div id="modalAddServico" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>‚ûï Adicionar Novo Servi√ßo</h3>
    <input id="addServicoNome" type="text" placeholder="Nome do Servi√ßo">
    <input id="addServicoValor" type="number" placeholder="Valor (Ex: 25.50)">
    <input id="addServicoDuracao" type="number" placeholder="Dura√ß√£o em Minutos (Ex: 30)">
    <button onclick="salvarNovoServico()">üíæ Salvar Servi√ßo</button>
    <button data-modal-id="modalAddServico" onclick="fecharModal(event)">‚ùå Cancelar</button>
  </div>
</div>

<div id="modalVendaRealizada" class="modal modal-venda" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>üéâ VENDA REALIZADA! üéâ</h3>
        <p style="font-size: 1.1em;">Parab√©ns, voc√™ vendeu um produto!</p>
        <p>Acesse <strong>Gerenciar Loja > Entregas</strong> para ver os detalhes.</p>
        <button data-modal-id="modalVendaRealizada" onclick="fecharModal(event)" style="background: white; color: #c0392b;">‚úÖ OK</button>
    </div>
</div>

<div id="modalConfirmacaoComprador" class="modal">
    <div class="modal-content">
        <h3 id="confirmacaoCompradorTitulo">Confirmar Recebimento</h3>
        <p id="confirmacaoCompradorTexto">O vendedor marcou o produto como entregue. Voc√™ confirma o recebimento?</p>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
           <button id="btnRecusarEntrega" style="background: #c0392b;">‚ùå Negar</button>
           <button id="btnAceitarEntrega" style="background: #27ae60;">‚úÖ Confirmar</button>
        </div>
    </div>
</div>

<div id="modalModoFerias" class="modal">
  <div class="modal-content">
    <h3>üìÖ Modo F√©rias/Aus√™ncia</h3>
    <p>Bloqueie um per√≠odo na sua agenda. Seus clientes ser√£o notificados.</p>
    <label for="feriasInicio">Data de In√≠cio:</label>
    <input type="date" id="feriasInicio">
    <label for="feriasFim">Data de Fim:</label>
    <input type="date" id="feriasFim">
    <button onclick="ativarModoFerias()">‚úÖ Ativar e Notificar Clientes</button>
    <button data-modal-id="modalModoFerias" onclick="fecharModal(event)">‚ùå Cancelar</button>
  </div>
</div>

<div id="modalEsqueciSenha" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>üîë Recuperar Acesso</h3>
    <p style="font-size: 14px;">Preencha seus dados para solicitar uma nova senha ao administrador.</p>
    <input id="recuperaEmail" type="email" placeholder="üìß Seu email de cadastro">
    <input id="recuperaTelefone" type="tel" placeholder="üìû Seu telefone com DDD">
    <button onclick="enviarSolicitacaoRecuperacaoSenha()">‚û°Ô∏è Enviar Solicita√ß√£o</button>
    <button data-modal-id="modalEsqueciSenha" onclick="fecharModal(event)">‚ùå Cancelar</button>
  </div>
</div>

<footer class="app-footer">
  <div id="appVersion"></div>
</footer>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-messaging-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-storage-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyDBt7NcU5rP-hsrBZ07ne_HbiMCHRyVcnY",
  authDomain: "navalha-de-ouro-v11.firebaseapp.com",
  projectId: "navalha-de-ouro-v11",
  storageBucket: "navalha-de-ouro-v11.firebasestorage.app",
  messagingSenderId: "434474263075",
  appId: "1:434474263075:web:163893d68a1b5dbe74c796"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth(), db = firebase.firestore();
const storage = firebase.storage();
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
  .then(() => {
    console.log("Persist√™ncia de autentica√ß√£o definida para 'local'.");
  })
  .catch((error) => {
    console.error("Erro ao definir a persist√™ncia de autentica√ß√£o:", error);
  });
const messaging = firebase.messaging.isSupported() ? firebase.messaging() : null;
const ADMIN_EMAIL = "josiel70c@gmail.com", ADMIN_PASS = "Ja997640401", TAXA_PADRAO = 0.05, BONUS_INDICACAO = 100, PONTOS_POR_CORTE = 10, PONTOS_PARA_RESGATE = 100, VALOR_RESGATE = 5;
const PONTOS_POR_DEPOSITO_NORMAL = 4, PONTOS_POR_DEPOSITO_VIP = 8;
const WHATSAPP_ADM_PHONE = "5527995003737";
const PRECO_VIP = 100;
const PRECO_TURBINAR = 9.99;
const PRECOS_PRO = {
    tier1: { preco: 29.90, taxa: 0.04 },
    tier2: { preco: 59.90, taxa: 0.02 },
    tier3: { preco: 99.90, taxa: 0.00 }
};

let fcmSetupDone = false;
let isSending = false;
let perfil = null;
let agendamentoListener = null;
let currentModal = null;
let chatListener = null;
let barbeirosListener = null;
let tempSelectedHorarios = {};
let onboardingState = {};
let tempOnboardingServicos = [];
const CHAT_GLOBAL_ID = "chatGlobal";
let botInterval = null;
let newWorker;
let localizacaoCliente = null;
let cadastroCoords = null;
let vendaListener = null;
let produtoEmEdicaoId = null;
let produtoParaCompra = null;
let pixTimerInterval = null;
let pendenciasInterval = null;
let pedidosVendedorListener = null;
let comprasClienteListener = null;
let modalStack = [];
let aguardeClickCount = 0;
const BACKEND_API_URL = 'https://navalhabackend.onrender.com';

let userView = {
    originalType: null,
    currentType: null
};

let agendamentoState = {
    barbeiroUid: null,
    barbeiroNome: null,
    servico: null,
    horario: null,
    barbeiroLat: null,
    barbeiroLon: null,
};

let adminBalanceListener = null;
let adminUserBalances = {};
let globalChatListener = null;
let lastGlobalMessageTimestamp = null;
let newMessagesCount = 0;
let oldestMessageSnapshot = null;
let deferredInstallPrompt = null;
let chatPreviewTimeout = null;

function exibirAguarde(texto = "Aguarde...") {
    document.getElementById('popupAguardeTexto').textContent = texto;
    const popup = document.getElementById('popupAguarde');
    popup.style.display = 'flex';
    setTimeout(() => popup.classList.add('show'), 10);
    aguardeClickCount = 0;
}

function fecharAguarde(event) {
    if (event && event.target.id === 'popupAguarde') {
        aguardeClickCount++;
        if (aguardeClickCount >= 2) {
            fecharModalAtual(true);
            aguardeClickCount = 0;
        }
    }
}

function abrirModal(modalId) {
    const novoModal = document.getElementById(modalId);
    if (novoModal && !novoModal.classList.contains('show')) {
        if (modalId.startsWith('modalOnboarding')) {
            novoModal.style.display = 'flex';
            setTimeout(() => novoModal.classList.add('show'), 10);
            return;
        }
        novoModal.style.display = 'flex';
        setTimeout(() => {
            novoModal.classList.add('show');
            modalStack.push(novoModal);
        }, 10);
    }
}

function fecharModal(event) {
    if (event && (event.target.classList.contains('modal') || event.target.getAttribute('data-modal-id'))) {
        fecharModalAtual();
    }
}

function fecharModalAtual(forcePopupAguarde = false) {
    if (forcePopupAguarde) {
        const popup = document.getElementById('popupAguarde');
        popup.classList.remove('show');
        setTimeout(() => popup.style.display = 'none', 300);
        return;
    }

    if (modalStack.length > 0) {
        const modalParaFechar = modalStack.pop();
        modalParaFechar.classList.remove('show');
        setTimeout(() => {
            modalParaFechar.style.display = 'none';
        }, 300);

        if (modalParaFechar.id === 'modalAgendamentosBarbeiro') {
            verificarPendenciasVisuaisBarbeiro();
        }
    }
}

function fecharTodosOsModais() {
    while (modalStack.length > 0) {
        fecharModalAtual();
    }
    const popup = document.getElementById('popupAguarde');
    if(popup.classList.contains('show')){
       fecharModalAtual(true);
    }
}

function mostrar(id) {
    const views = ["authView", "guestView", "clienteView", "barbeiroView", "adminView", "lojaView"];
    const viewAtual = views.find(v => document.getElementById(v) && !document.getElementById(v).classList.contains('hidden'));
    const viewNova = document.getElementById(id);
    const viewAtualEl = viewAtual ? document.getElementById(viewAtual) : null;

    if (viewAtualEl && viewAtualEl !== viewNova) {
        viewAtualEl.classList.add('exiting');
        setTimeout(() => {
            viewAtualEl.classList.add("hidden");
            viewAtualEl.classList.remove('exiting');
            views.forEach(v => { if (v !== id) document.getElementById(v)?.classList.add("hidden"); });
            viewNova?.classList.remove("hidden");
            viewNova?.classList.add("entering");
            setTimeout(() => {
                viewNova?.classList.remove("entering");
            }, 10);
        }, 400);
    } else {
        views.forEach(v => document.getElementById(v)?.classList.add("hidden"));
        viewNova?.classList.remove("hidden");
    }

    const isAuth = (id === 'authView');
    document.getElementById("topbar")?.classList.toggle("hidden", isAuth);
    document.getElementById("bottomButtons")?.classList.toggle("hidden", isAuth);
    document.getElementById("redeemContainer")?.classList.toggle("hidden", id !== 'clienteView' && id !== 'barbeiroView' && id !== 'adminView');
    document.getElementById("btnTema")?.classList.toggle("hidden", isAuth);
    document.getElementById("btnConfig")?.classList.toggle("hidden", isAuth);
    document.getElementById("btnCarteiraTop")?.classList.toggle("hidden", id !== 'clienteView' && id !== 'barbeiroView' && id !== 'adminView');
    document.getElementById("botaoExtra")?.classList.toggle("hidden", id === 'authView' || id === 'guestView');
    document.getElementById("btnSair")?.classList.toggle("hidden", isAuth || id === 'guestView');
}

function configurarBotoesGuest() {
    const guestView = document.getElementById('guestView');
    if (!guestView) return;
    const buttons = guestView.querySelectorAll('#guestFuncoesContainer button');
    buttons.forEach(btn => {
        const originalText = btn.textContent.trim();
        if (originalText === 'Loja') {
            btn.onclick = () => { mostrar('lojaView'); carregarProdutos(); };
            return;
        }
        btn.onclick = () => {
            exibirInfoPopup("Aviso", "Para acessar esta fun√ß√£o, por favor, crie uma conta ou fa√ßa login.");
            mostrar('authView');
        };
    });
}

function mostrarPainelAtual() {
    mostrar(`${userView.currentType}View`);
}

function solicitarPermissaoNotificacao() {
    if ('Notification' in window && Notification.permission === 'default' && messaging) {
        abrirModal('modalPermissaoNotificacao');
    }
}

function pedirPermissaoEFechar() {
    if (messaging) {
        Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
                const user = auth.currentUser;
                if (user) {
                    setupFCM(user.uid);
                }
            }
        });
    }
    fecharModalAtual();
}

async function garantirTokenAtualizadoNoPerfil(uid) {
    if (!messaging) return;
    try {
        const currentToken = await messaging.getToken({ vapidKey: 'BGkXq9v27VKT9Tl1DF2QBhP3c77lF4xDdptbay3jaKtlhw-5-G6D2GP7qcsjlweme9WggzBipoCDulIdSiuEfPE' });
        if (currentToken) {
            const userRef = db.collection('usuarios').doc(uid);
            const userDoc = await userRef.get();
            if (userDoc.exists) {
                const tokens = userDoc.data().fcmTokens || [];
                if (!tokens.includes(currentToken)) {
                    await userRef.update({
                        fcmTokens: firebase.firestore.FieldValue.arrayUnion(currentToken)
                    });
                }
            }
        }
    } catch(err) {
        console.error('Erro ao garantir token atualizado:', err);
    }
}

async function verificarPendenciasVisuaisBarbeiro() {
    if (!auth.currentUser || !perfil || perfil.tipo === 'cliente' || perfil.tipo === 'admin') return;
    try {
        const agendamentosSnap = await db.collection('agendamentos')
            .where('barbeiroUid', '==', auth.currentUser.uid)
            .where('status', '==', 'pendente')
            .limit(1)
            .get();

        const btnAgendamentos = document.getElementById('btnAgendamentosBarbeiro');
        if (btnAgendamentos) {
            btnAgendamentos.classList.toggle('notificacao-pulsante', !agendamentosSnap.empty);
        }
    } catch (error) {
        console.error("Erro ao verificar pend√™ncias visuais:", error);
    }
}

function setupFCM(uid) {
    if (fcmSetupDone || !('serviceWorker' in navigator) || !messaging) {
        return;
    }

    Notification.requestPermission().then((permission) => {
        if (permission === 'granted') {
            fcmSetupDone = true;
            messaging.getToken({ vapidKey: 'BGkXq9v27VKT9Tl1DF2QBhP3c77lF4xDdptbay3jaKtlhw-5-G6D2GP7qcsjlweme9WggzBipoCDulIdSiuEfPE' })
            .then((currentToken) => {
                if (currentToken) {
                    db.collection('usuarios').doc(uid).update({
                        fcmTokens: firebase.firestore.FieldValue.arrayUnion(currentToken)
                    }).catch(err => console.error("Erro ao salvar token FCM:", err));
                } else {
                    console.warn('N√£o foi poss√≠vel obter o token FCM.');
                }
            }).catch((err) => {
                console.error('Erro ao obter token FCM.', err);
            });
        } else {
            console.warn('Permiss√£o de notifica√ß√£o negada.');
        }
    });
}

function alternarTema() {
  const body = document.body;
  const isLight = body.classList.toggle('tema-claro');
  document.getElementById('btnTema').textContent = isLight ? '‚òÄÔ∏è' : 'üåô';
  localStorage.setItem('tema', isLight ? 'claro' : 'escuro');
}

function setupViewSwitcher() {
    const container = document.getElementById("botaoExtra");
    if (!container) return;
    container.innerHTML = "";
    if (!userView.originalType || !userView.currentType) return;

    if (userView.originalType === 'admin') {
        const createButton = (text, view) => {
            const btn = document.createElement("button");
            btn.textContent = text;
            btn.onclick = () => switchView(view);
            if (userView.currentType === view) {
                btn.disabled = true;
                btn.style.borderColor = "var(--cor-destaque)";
            }
            container.appendChild(btn);
        };
        createButton("üß† Admin", "admin");
        createButton("üíà Profissional", "barbeiro");
        createButton("üôã Cliente", "cliente");
        createButton("üõçÔ∏è Loja", "loja");
        return;
    }

    const lojaVisivel = userView.currentType === 'loja';
    if (lojaVisivel) {
        const btnPainel = document.createElement("button");
        btnPainel.textContent = "‚Ü©Ô∏è Painel Principal";
        btnPainel.onclick = () => switchView(userView.originalType);
        container.appendChild(btnPainel);
    } else {
        const btnLoja = document.createElement("button");
        btnLoja.textContent = "üõçÔ∏è Loja";
        btnLoja.onclick = () => switchView('loja');
        container.appendChild(btnLoja);
    }
}

function switchView(view) {
    userView.currentType = view;
    renderCurrentView();
}

function renderCurrentView() {
    setupViewSwitcher();
    if (adminBalanceListener) {
        adminBalanceListener();
        adminBalanceListener = null;
    }

    const btnGerenciarLojaCliente = document.getElementById('btnGerenciarLojaCliente');
    const btnGerenciarLojaBarbeiro = document.getElementById('btnGerenciarLojaBarbeiro');
    if (btnGerenciarLojaCliente) btnGerenciarLojaCliente.classList.add('hidden');
    if (btnGerenciarLojaBarbeiro) btnGerenciarLojaBarbeiro.classList.add('hidden');

    if(perfil && (perfil.lojaLiberada || perfil.tipo === 'admin')) {
      if(userView.currentType === 'cliente' && btnGerenciarLojaCliente) btnGerenciarLojaCliente.classList.remove('hidden');
      if(userView.currentType === 'barbeiro' && btnGerenciarLojaBarbeiro) btnGerenciarLojaBarbeiro.classList.remove('hidden');
    }

    switch (userView.currentType) {
        case 'admin':
            mostrar("adminView");
            carregarAdmin();
            break;
        case 'barbeiro':
        case 'manicure_pedicure':
        case 'designer_cilios':
            mostrar("barbeiroView");
            carregarBarbeirosPrincipal('listaBarbeirosPrincipalBarbeiro', false);
            verificarPendenciasVisuaisBarbeiro();
            break;
        case 'cliente':
            mostrar("clienteView");
            carregarBarbeirosPrincipal('listaBarbeirosPrincipalCliente', false);
            break;
        case 'loja':
            mostrar("lojaView");
            carregarProdutos();
            break;
        default:
            mostrar("authView");
    }
}

const cidadesPorEstado = {
  "ES": ["Aracruz", "Vit√≥ria", "Serra", "Linhares", "Colatina", "Cachoeiro de Itapemirim", "Guarapari", "Vila Velha", "S√£o Mateus", "Barra de S√£o Francisco"], "SP": ["S√£o Paulo", "Campinas", "Santos", "Ribeir√£o Preto", "Sorocaba"], "RJ": ["Rio de Janeiro", "Niter√≥i", "Petr√≥polis", "Volta Redonda", "Campos dos Goytacazes"], "MG": ["Belo Horizonte", "Uberl√¢ndia", "Contagem", "Juiz de Fora", "Montes Claros"], "BA": ["Salvador", "Feira de Santana", "Vit√≥ria da Conquista", "Ilh√©us", "Barreiras"], "PR": ["Curitiba", "Londrina", "Maring√°", "Cascavel", "Ponta Grossa"], "RS": ["Porto Alegre", "Caxias do Sul", "Pelotas", "Santa Maria", "Novo Hamburgo"], "SC": ["Flor√≥polis", "Joinville", "Blumenau", "Chapec√≥", "Crici√∫ma"], "PE": ["Recife", "Olinda", "Caruaru", "Petrolina", "Garanhuns"], "CE": ["Fortaleza", "Juazeiro do Norte", "Sobral", "Crato", "Iguatu"], "DF": ["Bras√≠lia"]
};

function carregarEstados(prefix = '') {
  const estadoSelect = document.getElementById(`${prefix}estado`);
  if (!estadoSelect) {
      console.error(`Elemento ${prefix}estado n√£o encontrado.`);
      return;
  }
  const valorAtual = estadoSelect.value;
  estadoSelect.innerHTML = '<option value="">üåé Selecione seu estado</option>';
  const estadosOrdenados = Object.keys(cidadesPorEstado).sort();
  estadosOrdenados.forEach(sigla => {
    estadoSelect.innerHTML += `<option value="${sigla}" ${sigla === valorAtual ? 'selected' : ''}>${sigla}</option>`;
  });
}

function carregarCidades(prefix = '') {
  const estadoSelect = document.getElementById(`${prefix}estado`);
  const cidadeSelect = document.getElementById(`${prefix}cidade`);
  if (!estadoSelect) {
      console.error(`Elemento ${prefix}estado n√£o encontrado ao carregar cidades.`);
      return;
  }
   if (!cidadeSelect) {
      console.error(`Elemento ${prefix}cidade n√£o encontrado.`);
      return;
  }
  const estado = estadoSelect.value;
  const valorAtual = cidadeSelect.value;
  cidadeSelect.innerHTML = '<option value="">üèôÔ∏è Selecione sua cidade</option>';
  const cidades = cidadesPorEstado[estado] || [];
  cidades.sort().forEach(c => {
    cidadeSelect.innerHTML += `<option value="${c}" ${c === valorAtual ? 'selected' : ''}>${c}</option>`;
  });
}

carregarEstados();
carregarEstados('config');
carregarEstados('adminNovo');

function entrar() {
  const cadastroFields = document.getElementById("cadastro-fields");
  if (cadastroFields && !cadastroFields.classList.contains('hidden')) {
    criarConta();
    return;
  }

  exibirAguarde("Entrando...");
  const email = document.getElementById("email")?.value.trim();
  const senha = document.getElementById("senha")?.value.trim();
  if (!email || !senha) {
    fecharTodosOsModais();
    return exibirInfoPopup("Erro", "Preencha os campos corretamente.");
  }
  auth.signInWithEmailAndPassword(email, senha)
    .then(() => {
        fecharTodosOsModais();
    })
    .catch(e => {
        fecharTodosOsModais();
        exibirInfoPopup("Erro ao entrar", e.message);
    });
}

function prepararCriarConta() {
    obterLocalizacaoCadastro();
    document.getElementById("senha")?.classList.add("hidden");
    const entrarButton = document.querySelector("#authView button:first-of-type");
    if(entrarButton) entrarButton.style.display = "none";
    document.getElementById("cadastro-fields")?.classList.remove("hidden");

    const senhaCadastroInput = document.getElementById("senha-cadastro");
    if(senhaCadastroInput) senhaCadastroInput.value = document.getElementById("senha")?.value || '';

    const tipoSelect = document.getElementById("tipo");
    if (tipoSelect) {
        if (onboardingState.perfil_basico === 'profissional') {
            tipoSelect.classList.remove('hidden');
            const clienteOption = tipoSelect.querySelector('option[value="cliente"]');
            if (clienteOption) clienteOption.remove();
        } else {
            tipoSelect.classList.add('hidden');
            tipoSelect.value = 'cliente';
        }
    }

    const btnCriarConta = document.getElementById("btnCriarConta");
    if(btnCriarConta) {
        btnCriarConta.onclick = criarConta;
        btnCriarConta.textContent = "üÜï Criar Conta";
    }
    document.getElementById("btnVoltar")?.classList.remove("hidden");
    const senhaCadastro = document.getElementById("senha-cadastro");
    const senhaConfirm = document.getElementById("senha-confirm");
    if(senhaCadastro) senhaCadastro.type = "text";
    if(senhaConfirm) senhaConfirm.type = "text";
}

function voltarParaLogin() {
    document.getElementById("cadastro-fields")?.classList.add("hidden");
    document.getElementById("btnVoltar")?.classList.add("hidden");
    document.getElementById("email")?.classList.remove("hidden");
    document.getElementById("senha")?.classList.remove("hidden");
    const entrarButton = document.querySelector("#authView button:first-of-type");
    if(entrarButton) entrarButton.style.display = "block";
    const btnCriarConta = document.getElementById("btnCriarConta");
    if (btnCriarConta) {
        btnCriarConta.onclick = prepararCriarConta;
        btnCriarConta.textContent = "üÜï Criar conta";
    }
    const senhaCadastro = document.getElementById("senha-cadastro");
    const senhaConfirm = document.getElementById("senha-confirm");
    if(senhaCadastro) senhaCadastro.value = "";
    if(senhaConfirm) senhaConfirm.value = "";
    if(senhaCadastro) senhaCadastro.type = "password";
    if(senhaConfirm) senhaConfirm.type = "password";
    cadastroCoords = null;
}

async function enviarSolicitacaoRecuperacaoSenha() {
    const email = document.getElementById('recuperaEmail')?.value.trim();
    const telefone = document.getElementById('recuperaTelefone')?.value.trim();

    if (!email || !telefone) {
        return exibirInfoPopup("Erro", "Por favor, preencha seu email e telefone.");
    }

    exibirAguarde("Enviando solicita√ß√£o...");

    try {
        await db.collection("solicitacoes").add({
            tipo: "recuperacao_senha",
            email: email,
            telefone: telefone,
            usuarioNome: `(Solicitante: ${email})`,
            status: "pendente",
            ts: firebase.firestore.FieldValue.serverTimestamp()
        });

        const mensagem = encodeURIComponent(`Ol√°, esqueci minha senha no app Nova Vers√£o.\n\nEmail: ${email}\nTelefone: ${telefone}\n\nAguardo o contato para redefinir.`);
        const telefoneLimpo = telefone.replace(/\D/g, '');
        window.open(`https://wa.me/55${telefoneLimpo}?text=${mensagem}`, '_blank');

        fecharTodosOsModais();
        exibirInfoPopup("Sucesso", "Solicita√ß√£o enviada! Voc√™ foi redirecionado para o WhatsApp para agilizar o atendimento. O administrador entrar√° em contato em breve.");
    } catch (error) {
        fecharTodosOsModais();
        exibirInfoPopup("Erro", "Erro ao enviar solicita√ß√£o: " + error.message);
    }
}

function criarConta() {
  exibirAguarde("Criando sua conta...");
  const email = document.getElementById("email")?.value.trim();
  const senha = document.getElementById("senha-cadastro")?.value;
  const senhaConfirm = document.getElementById("senha-confirm")?.value;
  const tipo = document.getElementById("tipo")?.value;
  const telefone = document.getElementById("telefone")?.value.trim();
  const estado = document.getElementById("estado")?.value;
  const cidade = document.getElementById("cidade")?.value;
  const nome = document.getElementById("nomeExibido")?.value.trim();
  const indicadorEmail = document.getElementById("indicador")?.value.trim();
  let rua = document.getElementById("rua")?.value.trim();
  let numero = document.getElementById("numero")?.value.trim();

  if (senha !== senhaConfirm) { fecharTodosOsModais(); return exibirInfoPopup("Erro", "As senhas n√£o coincidem."); }
  if (!telefone || telefone.length < 10 || !/^\d+$/.test(telefone)) { fecharTodosOsModais(); return exibirInfoPopup("Erro", "Por favor, insira um telefone v√°lido com DDD."); }
  if (!email || !senha || !nome || (email !== ADMIN_EMAIL && (!estado || !cidade))) { fecharTodosOsModais(); return exibirInfoPopup("Erro", "Preencha todos os campos obrigat√≥rios."); }
  if (tipo !== 'cliente' && (!rua || !numero)) {
      if (!confirm("Endere√ßo (rua e n√∫mero) n√£o preenchido. Deseja continuar assim mesmo? Sua localiza√ß√£o pode ficar imprecisa.")) {
          fecharTodosOsModais();
          return;
      }
      rua = rua || 'N√£o informado';
      numero = numero || 'S/N';
  }


  const tipoFinal = email === ADMIN_EMAIL ? "admin" : tipo;
  const estadoFinal = email === ADMIN_EMAIL ? "todos" : estado;
  const cidadeFinal = email === ADMIN_EMAIL ? "todos" : cidade;

  auth.createUserWithEmailAndPassword(email, senha)
    .then(async cred => {
      const data = {
        email, nome, tipo: tipoFinal, telefone, estado: estadoFinal, cidade: cidadeFinal,
        saldo: 0, reputacao: 100, cortesSemana: 0,
        disponivel: "nao", listaServicos: [], promocoes: [], portfolio: [],
        chatAtivo: true, vip: false, lojaLiberada: false,
        rua: rua || null, numero: numero || null,
        latitude: cadastroCoords ? cadastroCoords.latitude : null,
        longitude: cadastroCoords ? cadastroCoords.longitude : null,
        usaAgendaManual: false, agenda: {}, pontosFidelidade: 0,
        codigosResgatados: [],
        indicadoPorEmail: indicadorEmail || null,
        bonusIndicacaoPendente: !!indicadorEmail,
        fcmTokens: [],
        cortesRealizados: 0,
        conquistas: [],
        clientesAtendidos: 0,
        somaAvaliacoes: 0, numAvaliacoes: 0,
        ultimoBoostComprado: null,
        interesse_principal: onboardingState.interesse_principal || 'barbeiro',
        onboarding_profissional_concluido: tipo === 'cliente'
      };
      await db.collection("usuarios").doc(cred.user.uid).set(data);
      notifyAdmins("üÜï Novo Cadastro!", `O usu√°rio ${nome} (${tipoFinal}) acabou de se registrar.`);
      fecharTodosOsModais();
    })
    .catch(e => {
        fecharTodosOsModais();
        exibirInfoPopup("Erro ao criar conta", e.message);
    });
}

const tipoSelectCadastro = document.getElementById('tipo');
if(tipoSelectCadastro) {
    tipoSelectCadastro.addEventListener('change', (e) => {
      const isProfissional = e.target.value !== 'cliente';
      document.getElementById('rua')?.classList.toggle('hidden', !isProfissional);
      document.getElementById('numero')?.classList.toggle('hidden', !isProfissional);
      cadastroCoords = null;
    });
}

auth.onAuthStateChanged(async user => {
  if (!user) {
    if (localStorage.getItem('onboarding_concluido') === 'true') {
        mostrar('authView');
    } else {
        iniciarOnboarding();
    }
    document.getElementById("btnSair")?.classList.add("hidden");
    document.getElementById("redeemContainer")?.classList.add("hidden");
    if(globalChatListener) globalChatListener();
    if(vendaListener) vendaListener();
    if (comprasClienteListener) comprasClienteListener();
    if (pedidosVendedorListener) pedidosVendedorListener();
    if (agendamentoListener) agendamentoListener();
    if (barbeirosListener) barbeirosListener();
    if (chatListener) chatListener();
    if (adminBalanceListener) adminBalanceListener();
    clearInterval(pendenciasInterval);
    clearInterval(botInterval);
    botInterval = null;
    pendenciasInterval = null;
    return;
  }

  setupPlayStoreBilling();
  solicitarPermissaoNotificacao();
  await obterLocalizacaoAtual().catch(() => {});
  handleDeepLink();

  const ref = db.collection("usuarios").doc(user.uid);
  ref.onSnapshot(s => {
    if (!s.exists) return;
    perfil = s.data();
    perfil.uid = user.uid;
    const saldo = (perfil.saldo || 0).toFixed(2);
    document.getElementById("saldoHeader").textContent = saldo;
    document.getElementById("saldoModal").textContent = saldo;
    const btnVip = document.getElementById('btnVip');
    if(btnVip) {
        if (isVipAtivo(perfil)) {
          btnVip.textContent = 'üëë Sou VIP';
          btnVip.classList.add('vip-glow');
        } else {
          btnVip.textContent = 'üíé VIP';
          btnVip.classList.remove('vip-glow');
        }
    }

    const btnVipPro = document.getElementById('btnVipPro');
    if (btnVipPro) {
        if (isProAtivo(perfil)) {
            btnVipPro.textContent = 'üåü Sou PRO';
            btnVipPro.classList.add('pro-glow');
        } else {
            btnVipPro.textContent = `üåü Seja PRO (a partir de R$ ${PRECOS_PRO.tier1.preco.toFixed(2)}/m√™s)`;
            btnVipPro.classList.remove('pro-glow');
        }
    }
    aplicarTemaPorProfissao(perfil.interesse_principal);
  }, err => {
      console.error("Erro no listener do perfil:", err);
      // Talvez mostrar um erro ou tentar reconectar
  });

  try {
      const snap = await ref.get();
      if (!snap.exists) { mostrar("authView"); return; }
      perfil = snap.data();
      perfil.uid = user.uid;

      const config = await db.collection("config").doc("sistema").get();
      if (config.exists && config.data().ativo === false && perfil.tipo !== "admin") {
        exibirInfoPopup("Manuten√ß√£o", "üöß Sistema em manuten√ß√£o. Tente novamente mais tarde.");
        auth.signOut();
        return;
      }

      if(!userView.originalType) {
        userView.originalType = perfil.tipo;
        userView.currentType = perfil.tipo;
      }
      renderCurrentView();

      if (perfil.tipo !== 'cliente' && !perfil.onboarding_profissional_concluido) {
        iniciarOnboardingProfissional();
      }

      setupFCM(user.uid);
      exibirVersaoApp();
      iniciarVerificacaoDePendencias(user.uid);

      setTimeout(() => { document.getElementById("btnSair")?.classList.remove("hidden"); }, 15000);

      db.collection("avisos").where("usuarioUid", "==", user.uid).where("lido", "==", false)
        .onSnapshot(snapshot => {
            snapshot.docChanges().forEach(change => {
                if (change.type === "added") {
                    const aviso = change.doc.data();
                    if (aviso.tipo === 'vaga-aprovada' && aviso.agendamentoId) {
                        abrirModalVagaAprovada(aviso.agendamentoId);
                    } else {
                        exibirInfoPopup("üîî Novo Aviso", aviso.mensagem);
                    }
                    change.doc.ref.update({ lido: true }).catch(err => console.error("Erro ao marcar aviso como lido:", err));
                }
            });
        }, err => console.error("Erro no listener de avisos:", err));

        if (globalChatListener) globalChatListener();
        globalChatListener = db.collection("chats").doc(CHAT_GLOBAL_ID).collection("mensagens")
            .orderBy("ts", "desc").limit(1)
            .onSnapshot(async snapshot => {
                if (snapshot.empty) return;
                const msgData = snapshot.docs[0].data();
                const msgTs = msgData.ts;
                const janelaChat = document.getElementById('janelaChat');

                if (msgTs?.seconds > (lastGlobalMessageTimestamp?.seconds || 0) && msgData.remetenteUid !== user.uid) {
                    if (!janelaChat || !janelaChat.classList.contains('show')) {
                        const btnChatSpan = document.querySelector('#btnChat span:first-child');
                        if (btnChatSpan) {
                            btnChatSpan.classList.add('new-message-glow');
                            setTimeout(() => btnChatSpan.classList.remove('new-message-glow'), 2000);
                        }

                        newMessagesCount++;
                        const badge = document.querySelector('.notification-badge');
                        if(badge){
                            badge.textContent = newMessagesCount;
                            badge.classList.remove('hidden');
                        }

                        const preview = document.getElementById('chatPreview');
                        if(preview) {
                            let remetenteNomePreview = msgData.remetenteNome || "Usu√°rio";
                            if (msgData.remetenteUid && msgData.tipo !== 'bot' && msgData.tipo !== 'ai_suporte') {
                                try {
                                    const remetentePrevDoc = await db.collection("usuarios").doc(msgData.remetenteUid).get();
                                    if(remetentePrevDoc.exists) remetenteNomePreview = remetentePrevDoc.data().nome || remetenteNomePreview;
                                } catch(e) { console.warn("Erro ao buscar nome para preview:", e)}
                            }
                            preview.innerHTML = `<b>${remetenteNomePreview}:</b> ${msgData.texto}`;
                            preview.classList.add('show');
                            if (chatPreviewTimeout) clearTimeout(chatPreviewTimeout);
                            chatPreviewTimeout = setTimeout(() => { preview.classList.remove('show'); }, 3000);
                        }
                    }
                }
                lastGlobalMessageTimestamp = msgTs;
            }, err => console.error("Erro no listener do chat global:", err));

        if (vendaListener) vendaListener();
        if(perfil.lojaLiberada || perfil.tipo === 'admin') {
          vendaListener = db.collection("loja_pedidos")
            .where("vendedorUid", "==", user.uid)
            .where("vendedorNotificado", "==", false)
            .onSnapshot(snapshot => {
              snapshot.docChanges().forEach(change => {
                if (change.type === "added") {
                  abrirModal('modalVendaRealizada');
                  change.doc.ref.update({ vendedorNotificado: true }).catch(err => console.error("Erro ao marcar venda como notificada:", err));
                }
              });
            }, err => console.error("Erro no listener de vendas:", err));
        }

        if (comprasClienteListener) comprasClienteListener();
        comprasClienteListener = db.collection('loja_pedidos')
          .where('clienteUid', '==', user.uid)
          .where('status', '==', 'entregue_pendente_confirmacao')
          .onSnapshot(snapshot => {
            if (!snapshot.empty) {
                const pedido = snapshot.docs[0].data();
                pedido.id = snapshot.docs[0].id;
                abrirModalConfirmacaoComprador(pedido);
            }
          }, err => console.error("Erro no listener de compras cliente:", err));

  } catch (error) {
      console.error("Erro cr√≠tico na inicializa√ß√£o do usu√°rio:", error);
      mostrar("authView"); // Volta para login em caso de erro grave
      exibirInfoPopup("Erro", "N√£o foi poss√≠vel carregar seus dados. Tente novamente.");
  }

    // Aplica o tema salvo
    const temaSalvo = localStorage.getItem('tema');
    if (temaSalvo === 'claro') {
        document.body.classList.add('tema-claro');
        document.getElementById('btnTema').textContent = '‚òÄÔ∏è';
    } else {
        document.body.classList.remove('tema-claro');
        document.getElementById('btnTema').textContent = 'üåô';
    }
});

window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredInstallPrompt = e;
    const modalInstalar = document.getElementById('modalInstalarApp');
    if (modalInstalar) {
        abrirModal('modalInstalarApp');
        const btnInstalar = document.getElementById('btnInstalarPWA');
        if (btnInstalar) {
            btnInstalar.onclick = async () => {
                if (deferredInstallPrompt) {
                    deferredInstallPrompt.prompt();
                    await deferredInstallPrompt.userChoice;
                    deferredInstallPrompt = null;
                }
                fecharModalAtual();
            };
        }
    }
});

async function enviarNotificacaoParaBackend(uid, title, body, data = {}) {
  const backendUrl = BACKEND_API_URL;
  const notificationEndpoint = "/enviar-notificacao";
  const fullUrl = backendUrl + notificationEndpoint;

  if (!uid) {
    console.error("[NOTIFICA√á√ÉO] UID n√£o fornecido.");
    return;
  }

  try {
    const response = await fetch(fullUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ uid, title, body, data }),
    });

    const responseData = await response.json();

    if (!response.ok) {
      console.error(`[NOTIFICA√á√ÉO] Falha ${response.status}.`, responseData);
    }
  } catch (error) {
    console.error('[NOTIFICA√á√ÉO] Erro CR√çTICO:', error);
  }
}

function notifyUser(uid, title, body, data = {}) {
    enviarNotificacaoParaBackend(uid, title, body, data);
}

async function notifyAdmins(title, body, data = {}) {
    try {
        const adminSnapshot = await db.collection('usuarios').where('tipo', '==', 'admin').get();
        if (adminSnapshot.empty) {
            console.warn("[notifyAdmins] Nenhum administrador encontrado.");
            return;
        }
        adminSnapshot.forEach(doc => {
            enviarNotificacaoParaBackend(doc.id, title, body, data);
        });
    } catch (error) {
        console.error("Erro cr√≠tico ao notificar administradores:", error);
    }
}

async function abrirPortaSecreta() {
  const codigo = prompt("üíé Insira o c√≥digo de resgate:");
  if (!codigo) return;

  if (codigo === ADMIN_PASS) {
    if (perfil.tipo === "admin") return exibirInfoPopup("Aviso", "Sua conta j√° √© de administrador.");
    await db.collection("usuarios").doc(auth.currentUser.uid).update({ tipo: "admin" });
    exibirInfoPopup("Sucesso", "üîë Sua conta agora √© de Administrador! A p√°gina ser√° recarregada.");
    location.reload();
    return;
  }

  if (codigo.startsWith("(") && codigo.endsWith(")")) {
    if (perfil.codigosResgatados && perfil.codigosResgatados.includes(codigo)) {
        return exibirInfoPopup("Aviso", "Voc√™ j√° resgatou este c√≥digo.");
    }

    const quinzeHorasAtras = new Date(Date.now() - 15 * 60 * 60 * 1000);
    if (perfil.ultimo_resgate_ts && perfil.ultimo_resgate_ts.toDate() > quinzeHorasAtras) {
        const tempoRestanteMs = perfil.ultimo_resgate_ts.toDate().getTime() + (15 * 60 * 60 * 1000) - Date.now();
        const horas = Math.floor(tempoRestanteMs / (1000 * 60 * 60));
        const minutos = Math.floor((tempoRestanteMs % (1000 * 60 * 60)) / (1000 * 60));
        return exibirInfoPopup("Aviso", `Voc√™ s√≥ pode resgatar um c√≥digo a cada 15 horas. Tente novamente em ${horas}h ${minutos}m.`);
    }

    const blogPosts = await db.collection("blog").get();
    let codigoValido = false;
    blogPosts.forEach(doc => {
        if (doc.data().conteudo?.includes(codigo)) {
            codigoValido = true;
        }
    });
    if (codigoValido) {
        await db.collection("usuarios").doc(auth.currentUser.uid).update({
            pontosFidelidade: firebase.firestore.FieldValue.increment(5),
            codigosResgatados: firebase.firestore.FieldValue.arrayUnion(codigo),
            ultimo_resgate_ts: firebase.firestore.FieldValue.serverTimestamp()
        });
        exibirInfoPopup("Sucesso", "üéâ C√≥digo v√°lido! Voc√™ ganhou 5 pontos de fidelidade.");
        notifyUser(auth.currentUser.uid, "üèÜ Pontos de Fidelidade!", "Voc√™ ganhou 5 pontos por resgatar um c√≥digo do blog!", { link: '#fidelidade' });
    } else {
        exibirInfoPopup("Erro", "C√≥digo inv√°lido ou expirado.");
    }
  } else {
    exibirInfoPopup("Erro", "C√≥digo inv√°lido!");
  }
}

function abrirBarbeiros() {
  abrirModal('modalBarbeariasCliente');
  carregarBarbeiros();
}

function filtrarBarbeiros() {
  const termo = document.getElementById("filtroBarbeiro")?.value.toLowerCase() || "";
  const barbeiros = document.querySelectorAll("#listaBarbeiros .card");
  barbeiros.forEach(card => {
    const nome = card.querySelector("h4")?.textContent.toLowerCase() || "";
    const cidade = card.querySelector(".card-header-info p")?.textContent.toLowerCase() || "";
    card.style.display = (nome.includes(termo) || cidade.includes(termo)) ? "flex" : "none";
  });
}

async function carregarBarbeirosPrincipal(containerId, isGuest = false) {
    const lista = document.getElementById(containerId);
    if (!lista) return;
    lista.innerHTML = "<p>‚è≥ Carregando profissionais...</p>";

    if (!localizacaoCliente && !isGuest) {
       await obterLocalizacaoAtual().catch(() => {});
    }

    if (barbeirosListener) barbeirosListener();
    let query;
    const tiposProfissionais = ["barbeiro", "manicure_pedicure", "designer_cilios"];

    if (isGuest) {
        query = db.collection("usuarios").where("tipo", "in", tiposProfissionais);
    } else {
        const interesse = perfil?.interesse_principal || 'barbeiro';
        if (tiposProfissionais.includes(interesse)) {
             query = db.collection("usuarios").where("tipo", "==", interesse);
        } else {
            // Fallback para barbeiro se o interesse n√£o for um tipo profissional v√°lido
             query = db.collection("usuarios").where("tipo", "==", 'barbeiro');
        }
    }

    barbeirosListener = query.onSnapshot(snap => {
        if (snap.empty) {
            lista.innerHTML = `<p>üòî Nenhum profissional encontrado para "${perfil?.interesse_principal || 'esta categoria'}".</p>`;
            return;
        }

        let barbeiros = [];
        snap.forEach(doc => {
            const b = doc.data();
            b.uid = doc.id;
            if (localizacaoCliente && b.latitude && b.longitude) {
                b.distancia = calcularDistancia(localizacaoCliente.latitude, localizacaoCliente.longitude, b.latitude, b.longitude);
            } else {
                b.distancia = Infinity; // Coloca no final se n√£o tiver localiza√ß√£o
            }
            barbeiros.push(b);
        });

        barbeiros.sort((a, b) => {
            const aDisponivel = isProfissionalDisponivel(a);
            const bDisponivel = isProfissionalDisponivel(b);
            if (aDisponivel !== bDisponivel) return aDisponivel ? -1 : 1;

            const aBoosted = a.boostExpiracao && a.boostExpiracao.toDate() > new Date();
            const bBoosted = b.boostExpiracao && b.boostExpiracao.toDate() > new Date();
            if (aBoosted !== bBoosted) return aBoosted ? -1 : 1;

            const aPro = isProAtivo(a);
            const bPro = isProAtivo(b);
            if (aPro !== bPro) return aPro ? -1 : 1;

            const aVip = isVipAtivo(a); // Embora VIP seja mais para cliente, pode ser crit√©rio
            const bVip = isVipAtivo(b);
            if(aVip !== bVip) return aVip ? -1 : 1; // Prioriza VIPs (raro para profissionais)

            return a.distancia - b.distancia; // Por fim, ordena por dist√¢ncia
        });

        lista.innerHTML = "";
        barbeiros.forEach(b => {
            lista.innerHTML += criarCardBarbeiroHtml(b, isGuest);
        });
    }, err => {
        console.error("Erro ao carregar barbeiros:", err);
        lista.innerHTML = "<p>Erro ao carregar profissionais.</p>";
    });
}

function isProfissionalDisponivel(profissionalData) {
    const agora = new Date();
    const estaAusente = profissionalData.ausente && profissionalData.ausenciaInicio && profissionalData.ausenciaFim &&
                       agora >= profissionalData.ausenciaInicio.toDate() &&
                       agora <= profissionalData.ausenciaFim.toDate();

    if (estaAusente) return false;

    return profissionalData.vagaImediata || (profissionalData.usaAgendaManual && Object.values(profissionalData.agenda || {}).some(v => v === true));
}

function criarCardBarbeiroHtml(b, isGuest) {
    const reputacaoEstrelas = '‚≠ê'.repeat(Math.round((b.reputacao || 100) / 20));
    const isBoosted = b.boostExpiracao && b.boostExpiracao.toDate() > new Date();
    const isPro = isProAtivo(b);
    const agora = new Date();
    const estaAusente = b.ausente && b.ausenciaInicio && b.ausenciaFim &&
                       agora >= b.ausenciaInicio.toDate() &&
                       agora <= b.ausenciaFim.toDate();
    const isDisponivel = isProfissionalDisponivel(b); // Usa a fun√ß√£o helper

    let statusHtml = '';
    if (estaAusente) {
        const dataFimAusencia = b.ausenciaFim.toDate().toLocaleDateString('pt-BR');
        statusHtml = `<div class="card-status status-indisponivel">üèñÔ∏è Ausente (Retorna ${dataFimAusencia})</div>`;
    } else if (!isDisponivel) {
         statusHtml = `<div class="card-status status-indisponivel">üî¥ Indispon√≠vel no momento</div>`;
    } else if (b.vagaImediata) {
        statusHtml = `<div class="card-status status-imediato">‚ö° Vaga Imediata Dispon√≠vel!</div>`;
    } else if (b.usaAgendaManual) {
        const horarios = Object.keys(b.agenda || {}).filter(h => b.agenda[h] === true).sort();
        if (horarios.length > 0) {
            statusHtml = `<div class="card-status status-manual">üìÖ Agende seu hor√°rio<div class="card-horarios-disponiveis">${horarios.map(h => `<span>${h}</span>`).join('')}</div></div>`;
        } else {
            statusHtml = `<div class="card-status status-indisponivel">üìã Sem hor√°rios hoje</div>`;
        }
    }

    let promocoesHtml = '';
    const promocoesAtivas = (b.promocoes || []).filter(p => !p.validade || new Date(p.validade.seconds * 1000) > agora);
    if (promocoesAtivas.length > 0) {
      promocoesHtml = '<div class="promo-info">';
      promocoesAtivas.forEach(p => {
          promocoesHtml += `üéÅ ${p.nome} (${p.desconto}% OFF)<br>`;
      });
      promocoesHtml += '</div>';
    }

    const logoHtml = b.logo_url ? `<img src="${b.logo_url}" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; margin-right: 10px;">` : '';
    const distanciaTexto = b.distancia !== Infinity ? `<p>üìç Aprox. ${b.distancia.toFixed(1)} km</p>` : (b.cidade ? `<p>üèôÔ∏è ${b.cidade}</p>` : '');
    const boostIcon = isBoosted ? '<span class="boost-icon">üöÄ</span>' : '';
    const proIcon = isPro ? 'üåü ' : ''; // Adiciona √≠cone PRO
    const tipoProfissionalIcone = b.tipo === 'barbeiro' ? 'üíà' : (b.tipo === 'manicure_pedicure' ? 'üíÖ' : (b.tipo === 'designer_cilios' ? 'üëÅÔ∏è' : ''));

    const cardClasses = ['card', 'barbeiro-card'];
    if (isBoosted) cardClasses.push('boosted-card');
    if (isPro) cardClasses.push('pro-glow'); // Adiciona classe PRO

    return `
      <div class="${cardClasses.join(' ')}" onclick="abrirBarbeiroPerfil('${b.uid}', ${isGuest})">
          ${boostIcon}
          <div class="card-header">
              ${logoHtml}
              <div class="card-header-info">
                  <h4>${proIcon}${tipoProfissionalIcone} ${b.nome}</h4>
                  ${distanciaTexto}
              </div>
              <div class="card-reputacao">${reputacaoEstrelas}<br><span>(${b.reputacao != null ? b.reputacao : 100})</span></div>
          </div>
          ${statusHtml}
          ${promocoesHtml}
      </div>`;
}

function resetAgendamentoState() {
    agendamentoState = { barbeiroUid: null, barbeiroNome: null, servico: null, horario: null, barbeiroLat: null, barbeiroLon: null };
}

function selecionarServico(element, servicoString) {
    try {
        const servico = JSON.parse(servicoString);
        document.querySelectorAll('#barbeiroPerfilServicosList .selectable-item').forEach(item => item.classList.remove('selected'));
        element.classList.add('selected');
        agendamentoState.servico = servico;
        verificarEstadoBotaoAgendar();
    } catch(e) {
        console.error("Erro ao parsear servico:", e, servicoString);
        exibirInfoPopup("Erro", "Ocorreu um erro ao selecionar o servi√ßo.");
    }
}

function selecionarHorario(element, horario) {
    document.querySelectorAll('#barbeiroPerfilHorariosList .selectable-item').forEach(item => item.classList.remove('selected'));
    element.classList.add('selected');
    agendamentoState.horario = horario;
    verificarEstadoBotaoAgendar();
}

function verificarEstadoBotaoAgendar() {
    const btnConfirmar = document.getElementById('btnConfirmarAgendamento');
    if (btnConfirmar) {
        btnConfirmar.disabled = !(agendamentoState.servico && agendamentoState.horario);
    }
}

async function abrirBarbeiroPerfil(barbeiroUid, isGuest = false) {
    if (isGuest || !auth.currentUser) {
        exibirInfoPopup("Aviso", "Para agendar um hor√°rio, por favor, fa√ßa login ou crie uma conta.");
        return mostrar('authView');
    }
    try {
        exibirAguarde("Carregando perfil...");
        resetAgendamentoState();
        const barbeiroDoc = await db.collection("usuarios").doc(barbeiroUid).get();
        if (!barbeiroDoc.exists) throw new Error("Profissional n√£o encontrado.");
        const b = barbeiroDoc.data();
        agendamentoState.barbeiroUid = barbeiroUid;
        agendamentoState.barbeiroNome = b.nome;
        agendamentoState.barbeiroLat = b.latitude;
        agendamentoState.barbeiroLon = b.longitude;

        document.getElementById("barbeiroPerfilNome").textContent = `${b.tipo === 'barbeiro' ? 'üíà' : (b.tipo === 'manicure_pedicure' ? 'üíÖ' : 'üëÅÔ∏è')} ${b.nome}`;
        document.getElementById("barbeiroPerfilEndereco").textContent = (b.rua && b.numero) ? `${b.rua}, ${b.numero} - ${b.cidade}` : (b.cidade || 'Localiza√ß√£o n√£o informada');
        document.getElementById("barbeiroPerfilReputacao").textContent = `${'‚≠ê'.repeat(Math.round((b.reputacao || 100) / 20))} (${b.reputacao != null ? b.reputacao : 100})`;

        const logoImg = document.getElementById('profissionalLogo');
        if (logoImg) {
            if (b.logo_url) {
                logoImg.src = b.logo_url;
                logoImg.style.display = 'block';
            } else {
                logoImg.style.display = 'none';
            }
        }

        const servicosList = document.getElementById("barbeiroPerfilServicosList");
        servicosList.innerHTML = "";
        if (b.listaServicos?.length > 0) {
            const agora = new Date();
            const promocoesAtivasPerfil = (b.promocoes || []).filter(p => !p.validade || new Date(p.validade.seconds * 1000) > agora);

            b.listaServicos.forEach(s => {
                const servicoOriginal = { ...s };
                let precoFinal = s.valor;
                let precoHtml = `R$ ${s.valor.toFixed(2)}`;
                let promoAplicada = null;

                if (promocoesAtivasPerfil.length > 0) {
                    const promo = promocoesAtivasPerfil.find(p =>
                        p.servicosAplicaveis.includes(s.nome) && s.valor >= (p.valorMinimo || 0)
                    );
                    if (promo) {
                        precoFinal = s.valor * (1 - promo.desconto / 100);
                        precoHtml = `<span style="text-decoration: line-through; opacity: 0.7;">R$ ${servicoOriginal.valor.toFixed(2)}</span> <b style="color: var(--cor-destaque);">R$ ${precoFinal.toFixed(2)}</b>`;
                        promoAplicada = promo;
                    }
                }

                // Cria um objeto de servi√ßo atualizado com o pre√ßo final (com desconto, se aplic√°vel)
                const servicoParaAgendar = { ...servicoOriginal, valor: precoFinal };
                const servicoJSON = JSON.stringify(servicoParaAgendar).replace(/"/g, "'"); // Usa aspas simples para onclick
                const promoInfo = promoAplicada ? `<p style="font-size: 11px; color: var(--cor-destaque); margin: 2px 0 0 0;">üéÅ ${promoAplicada.nome} (${promoAplicada.desconto}% OFF)</p>` : '';

                servicosList.innerHTML += `
                    <div class="selectable-item" onclick="selecionarServico(this, &quot;${servicoJSON}&quot;)">
                        ${s.nome} - ${precoHtml}${s.duracao ? ` - ${s.duracao} min` : ''}
                        ${promoInfo}
                    </div>`;
            });
        } else {
            servicosList.innerHTML = "<p>Nenhum servi√ßo cadastrado.</p>";
        }

        const horariosList = document.getElementById("barbeiroPerfilHorariosList");
        horariosList.innerHTML = "";
        const agoraTs = new Date();
        const estaAusentePerfil = b.ausente && b.ausenciaInicio && b.ausenciaFim &&
                            agoraTs >= b.ausenciaInicio.toDate() &&
                            agoraTs <= b.ausenciaFim.toDate();
        let hasOptions = false;

        if (estaAusentePerfil) {
            const dataFimAusenciaPerfil = b.ausenciaFim.toDate().toLocaleDateString('pt-BR');
            horariosList.innerHTML = `<p style="color: var(--cor-destaque-rosa); text-align: center; font-weight: bold;">üèñÔ∏è Profissional ausente at√© ${dataFimAusenciaPerfil}. Agendamento indispon√≠vel.</p>`;
        } else {
            if (b.vagaImediata) {
                horariosList.innerHTML += `<div class="selectable-item" onclick='selecionarHorario(this, "imediato")'>‚ö° Vaga Imediata</div>`;
                hasOptions = true;
            }
            if (b.usaAgendaManual) {
                const horarios = Object.keys(b.agenda || {}).filter(h => b.agenda[h] === true).sort();
                if (horarios.length > 0) {
                    horarios.forEach(h => {
                        horariosList.innerHTML += `<div class="selectable-item" onclick='selecionarHorario(this, "${h}")'>üìÖ ${h}</div>`;
                    });
                    hasOptions = true;
                }
            }
            if (!hasOptions) {
                horariosList.innerHTML = "<p>Nenhuma op√ß√£o de agendamento dispon√≠vel no momento.</p>";
            }
        }

        const btnPortfolio = document.getElementById('btnAcessarPortfolio');
        if (btnPortfolio) {
            if (b.portfolio && b.portfolio.length > 0) {
                btnPortfolio.classList.remove('hidden');
                btnPortfolio.onclick = () => abrirPortfolioCliente(barbeiroUid, b.nome);
            } else {
                btnPortfolio.classList.add('hidden');
            }
        }

        const btnRota = document.getElementById('btnAbrirRota');
        if (btnRota) {
            if (b.latitude && b.longitude) {
                btnRota.classList.remove('hidden');
                btnRota.onclick = () => abrirRota(b.latitude, b.longitude);
            } else {
                btnRota.classList.add('hidden');
            }
        }

        const btnConfirmar = document.getElementById('btnConfirmarAgendamento');
        if (btnConfirmar) btnConfirmar.onclick = confirmarAgendamento;
        verificarEstadoBotaoAgendar();
        fecharTodosOsModais();
        abrirModal('modalBarbeiroPerfil');
    } catch (error) {
        fecharTodosOsModais();
        console.error("Erro ao abrir perfil do barbeiro:", error);
        exibirInfoPopup("Erro", "Ocorreu um erro ao carregar as informa√ß√µes do profissional.");
    }
}

function confirmarAgendamento() {
    const { barbeiroUid, barbeiroNome, servico, horario } = agendamentoState;
    if (!servico || !horario) {
        fecharModalAtual();
        return;
    }

    // Calcula o pre√ßo final considerando o VIP do cliente LOGADO (perfil)
    const preco = isVipAtivo(perfil) ? servico.valor * 0.9 : servico.valor;

    if (perfil.saldo < preco) {
        fecharModalAtual();
        exibirInfoPopup("Saldo Insuficiente", "üí∏ Saldo insuficiente. Por favor, deposite mais dinheiro em sua carteira.");
        abrirModal('modalCarteira');
        return;
    }

    const horarioTexto = horario === 'imediato' ? 'uma Vaga Imediata' : `o hor√°rio das ${horario}`;
    let detalhes = `Confirma o agendamento?\n\nProfissional: ${barbeiroNome}\nServi√ßo: ${servico.nome}\n`;
    if (servico.duracao) detalhes += `Dura√ß√£o Estimada: ${servico.duracao} minutos\n`;
    detalhes += `Hor√°rio: ${horarioTexto}\nValor: R$ ${preco.toFixed(2)}${isVipAtivo(perfil) ? ' (Desconto VIP de 10% aplicado)' : ''}`;

    if (!confirm(detalhes)) {
        return;
    }

    exibirAguarde("Agendando...");

    const agendamentoData = {
        clienteUid: auth.currentUser.uid, clienteNome: perfil.nome, clienteTelefone: perfil.telefone,
        barbeiroUid, barbeiroNome, servico: servico.nome, valor: preco,
        status: horario === 'imediato' ? 'imediato' : 'pendente',
        ts: firebase.firestore.FieldValue.serverTimestamp(),
        avaliado: false, lembreteEnviado: false
    };
    if (horario !== 'imediato') agendamentoData.horario = horario;

    db.collection("agendamentos").add(agendamentoData).then(() => {
        const tipoAviso = horario === 'imediato' ? 'vaga imediata' : `agendamento para ${horario}`;
        criarAviso(barbeiroUid, `üîî Novo pedido de ${tipoAviso} de ${perfil.nome} para ${servico.nome}.`);
        criarAviso(auth.currentUser.uid, "‚úÖ Seu pedido foi enviado! Aguarde a aprova√ß√£o do profissional.");
        notifyUser(barbeiroUid, "üîî Novo Agendamento Recebido!", `${perfil.nome} quer agendar "${servico.nome}".`, { link: '#agendamentos' });
        fecharTodosOsModais();
        exibirInfoPopup("Sucesso", "Pedido enviado com sucesso!");
    }).catch(e => {
        fecharTodosOsModais();
        exibirInfoPopup("Erro", "Erro ao enviar pedido: " + e.message)
    });
}

function abrirModalVagaAprovada(agendamentoId) {
    const btnCancelar = document.getElementById('btnCancelarVagaAprovada');
    if (!btnCancelar) return;
    const novoBtn = btnCancelar.cloneNode(true);
    btnCancelar.parentNode.replaceChild(novoBtn, btnCancelar);
    novoBtn.onclick = () => cancelarAgendamentoAposAprovacao(agendamentoId);
    abrirModal('modalVagaImediataAprovada');
}

async function cancelarAgendamentoAposAprovacao(agendamentoId) {
    if (!confirm("Tem certeza que deseja cancelar? O valor ser√° reembolsado.")) return;
    exibirAguarde("Cancelando...");
    try {
        const agendamentoDoc = await db.collection("agendamentos").doc(agendamentoId).get();
        if (!agendamentoDoc.exists) throw new Error("Agendamento n√£o encontrado.");
        const { valor, barbeiroUid, clienteUid } = agendamentoDoc.data();

        // Calcula taxa din√¢mica para estorno correto
        const barbeiroDoc = await db.collection("usuarios").doc(barbeiroUid).get();
        let taxaAplicadaEstorno = TAXA_PADRAO;
        if (barbeiroDoc.exists && isProAtivo(barbeiroDoc.data()) && barbeiroDoc.data().proTier && PRECOS_PRO[barbeiroDoc.data().proTier]) {
            taxaAplicadaEstorno = PRECOS_PRO[barbeiroDoc.data().proTier].taxa;
        }
        const valorBarbeiroEstorno = valor * (1 - taxaAplicadaEstorno);
        const valorAdminEstorno = valor * taxaAplicadaEstorno;

        await db.runTransaction(async t => {
            const clienteRef = db.collection("usuarios").doc(clienteUid);
            const barbeiroRef = db.collection("usuarios").doc(barbeiroUid);
            const agendamentoRef = db.collection("agendamentos").doc(agendamentoId);
            t.update(clienteRef, { saldo: firebase.firestore.FieldValue.increment(valor) });
            t.update(barbeiroRef, { saldo: firebase.firestore.FieldValue.increment(-valorBarbeiroEstorno) });
            const adminSnap = await db.collection("usuarios").where("tipo", "==", "admin").limit(1).get();
            if (!adminSnap.empty) {
                t.update(db.collection("usuarios").doc(adminSnap.docs[0].id), { saldo: firebase.firestore.FieldValue.increment(-valorAdminEstorno) });
            }
            t.update(agendamentoRef, { status: "cancelado" });
        });
        criarAviso(barbeiroUid, `‚ùå O cliente ${perfil.nome} cancelou a vaga imediata. O valor foi estornado.`);
        notifyUser(barbeiroUid, "‚ùå Agendamento Cancelado", `${perfil.nome} cancelou a vaga imediata.`);
        fecharTodosOsModais();
        exibirInfoPopup("Sucesso", "Agendamento cancelado e valor reembolsado com sucesso.");
    } catch (e) {
        fecharTodosOsModais();
        exibirInfoPopup("Erro", "Erro ao cancelar agendamento: " + e.message);
    }
}

function exibirInfoPopup(titulo, mensagem) {
    document.getElementById('infoPopupTitulo').textContent = titulo;
    document.getElementById('infoPopupMensagem').textContent = mensagem;
    abrirModal('modalInfoPopup');
}

function abrirHistoricoCliente() {
  abrirModal('modalHistoricoCliente');
  const painelHistorico = document.getElementById("painelHistorico");
  if (!painelHistorico) return;
  painelHistorico.innerHTML = "<p>‚è≥ Carregando hist√≥rico...</p>";
  db.collection("agendamentos")
    .where("clienteUid", "==", auth.currentUser.uid)
    .where("status", "in", ["concluido", "cancelado"])
    .orderBy("ts", "desc").limit(20)
    .onSnapshot(snap => {
      painelHistorico.innerHTML = snap.empty ? "<p>Nenhum item no hist√≥rico.</p>" : "";
      snap.forEach(doc => {
        const a = doc.data();
        let statusTexto = a.status === "concluido" ? "‚úÇÔ∏è Conclu√≠do" : "‚ùå Cancelado";
        let botoes = '';
        if (a.status === "concluido") {
             botoes = a.avaliado === false ? `<button onclick="abrirModalAvaliacao('${doc.id}', '${a.barbeiroUid}')">‚≠ê Avaliar</button>` : `<p>‚úÖ Avaliado</p>`;
        }
        const dataFormatada = a.ts ? new Date(a.ts.seconds * 1000).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' }) : 'Data indispon√≠vel';
        painelHistorico.innerHTML += `<div class="card">‚úÇÔ∏è ${a.servico} - R$ ${a.valor.toFixed(2)}<br>Profissional: ${a.barbeiroNome}<br>Data: ${dataFormatada}<br>Status: <b>${statusTexto}</b><br>${botoes}</div>`;
      });
    }, err => {
        console.error("Erro ao carregar hist√≥rico:", err);
        painelHistorico.innerHTML = "<p>Erro ao carregar hist√≥rico.</p>";
    });
}

function abrirModalAvaliacao(agendamentoId, barbeiroUid) {
  const nota = parseInt(prompt("Avalie o servi√ßo de 1 a 10:"));
  if (isNaN(nota) || nota < 1 || nota > 10) return exibirInfoPopup("Erro", "Avalia√ß√£o inv√°lida. Use um n√∫mero de 1 a 10.");

  const comentario = prompt("Deixe um coment√°rio sobre o servi√ßo (opcional):");

  avaliarServico(agendamentoId, barbeiroUid, nota, comentario);
}

async function avaliarServico(agendamentoId, barbeiroUid, nota, comentario) {
  const reputacaoGanho = nota >= 7 ? 10 : (nota <= 4 ? -10 : 0);

  try {
      const pontosGanhos = await db.runTransaction(async t => {
        const agendamentoRef = db.collection("agendamentos").doc(agendamentoId);
        const barbeiroRef = db.collection("usuarios").doc(barbeiroUid);
        const clienteRef = db.collection("usuarios").doc(auth.currentUser.uid);

        const [agendamentoDoc, barbeiroDoc, clienteDoc] = await Promise.all([
            t.get(agendamentoRef),
            t.get(barbeiroRef),
            t.get(clienteRef)
        ]);

        if (!barbeiroDoc.exists) throw "O profissional n√£o foi encontrado.";
        if (agendamentoDoc.data().avaliado) throw "Este servi√ßo j√° foi avaliado.";
        if (!clienteDoc.exists) throw "Cliente n√£o encontrado.";

        const barbeiroData = barbeiroDoc.data();
        const clienteData = clienteDoc.data();
        const valor = agendamentoDoc.data().valor;
        const pontosPorReal = isVipAtivo(clienteData) ? 0.2 : 0.1; // Ex: 1 ponto a cada R$10 (ou R$5 para VIP)
        const pontosCalculados = Math.floor(valor * pontosPorReal);

        t.update(agendamentoRef, { avaliado: true });
        t.update(barbeiroRef, {
            reputacao: firebase.firestore.FieldValue.increment(reputacaoGanho),
            somaAvaliacoes: firebase.firestore.FieldValue.increment(nota),
            numAvaliacoes: firebase.firestore.FieldValue.increment(1)
        });
        t.set(db.collection("avaliacoes").doc(), {
          barbeiroUid, clienteUid: auth.currentUser.uid, nota,
          comentario: comentario || "Sem coment√°rio",
          ts: firebase.firestore.FieldValue.serverTimestamp()
        });
        if (pontosCalculados > 0) {
            t.update(clienteRef, { pontosFidelidade: firebase.firestore.FieldValue.increment(pontosCalculados) });
        }
        return pontosCalculados;
      });

      exibirInfoPopup("Sucesso", `Avalia√ß√£o enviada com sucesso! Voc√™ ganhou ${pontosGanhos} pontos de fidelidade.`);
      criarAviso(barbeiroUid, `‚≠ê Voc√™ recebeu uma nova avalia√ß√£o de ${perfil.nome}.`);
      notifyUser(barbeiroUid, "‚≠ê Nova Avalia√ß√£o!", `${perfil.nome} deixou uma avalia√ß√£o de nota ${nota} para voc√™.`, { link: '#avaliacoes' });
  } catch(e) {
      console.error("Erro detalhado ao avaliar:", e);
      exibirInfoPopup("Erro", "Erro ao avaliar: " + (e.message || e));
  }
}

function resgatarPontos() {
  if ((perfil.pontosFidelidade || 0) < PONTOS_PARA_RESGATE) {
    return exibirInfoPopup("Aviso", `Voc√™ precisa de ${PONTOS_PARA_RESGATE} pontos para resgatar.`);
  }
  if (!confirm(`Deseja resgatar ${PONTOS_PARA_RESGATE} pontos por R$ ${VALOR_RESGATE.toFixed(2)}?`)) return;
  exibirAguarde("Resgatando...");
  db.runTransaction(async t => {
    const ref = db.collection("usuarios").doc(auth.currentUser.uid);
    const doc = await t.get(ref);
    if ((doc.data().pontosFidelidade || 0) < PONTOS_PARA_RESGATE) throw "Pontos insuficientes.";
    t.update(ref, {
        pontosFidelidade: firebase.firestore.FieldValue.increment(-PONTOS_PARA_RESGATE),
        saldo: firebase.firestore.FieldValue.increment(VALOR_RESGATE)
    });
  }).then(() => {
    fecharTodosOsModais();
    exibirInfoPopup("Sucesso", `üéâ Parab√©ns! Voc√™ resgatou R$ ${VALOR_RESGATE.toFixed(2)} com seus pontos!`);
    notifyUser(auth.currentUser.uid, "üí∏ Pontos Resgatados!", `Voc√™ converteu ${PONTOS_PARA_RESGATE} pontos em R$${VALOR_RESGATE.toFixed(2)}.`, { link: '#carteira' });
  }).catch(e => {
    fecharTodosOsModais();
    exibirInfoPopup("Erro", "Erro ao resgatar pontos: " + e.message);
  });
}

function abrirModalVip() {
    const container = document.getElementById('vipContentContainer');
    if (!container) return;
    if (isVipAtivo(perfil)) {
        const dataExpiracao = perfil.vipExpirationDate.toDate().toLocaleDateString('pt-BR');
        container.innerHTML = `
            <div class="vip-glow" style="padding: 20px; border-radius: 15px; text-align: center;">
                <h3 style="color: var(--cor-destaque);">üëë Voc√™ √© um Membro VIP!</h3>
                <p>Sua assinatura √© v√°lida at√©: <strong>${dataExpiracao}</strong>.</p>
                <div class="vantagens" style="text-align: left; margin-top: 20px;">
                    <h4>Seus Benef√≠cios Atuais:</h4>
                    <ul>
                        <li>Desconto de 10% em todos os servi√ßos.</li>
                        <li>Pontos de fidelidade em dobro por dep√≥sito e avalia√ß√£o.</li>
                        <li>S√≠mbolo de prest√≠gio üëë no chat global.</li>
                    </ul>
                </div>
            </div>
        `;
    } else {
        container.innerHTML = `
            <div style="padding: 20px; border-radius: 15px; text-align: center;">
                <h3 style="color: var(--cor-destaque);">üíé Torne-se um Membro VIP!</h3>
                <p>Eleve sua experi√™ncia por 6 meses e apoie o desenvolvimento do app.</p>
                <p style="font-size: 24px; font-weight: bold; margin: 15px 0;">Ades√£o √önica: R$ ${PRECO_VIP.toFixed(2)}</p>
                <div class="vantagens" style="text-align: left; margin-top: 20px;">
                    <h4>Vantagens Exclusivas para Clientes VIP:</h4>
                    <ul>
                        <li><strong>10% de Desconto</strong> em todos os servi√ßos agendados pelo app.</li>
                        <li><strong>Dobro de Pontos</strong> de fidelidade ao avaliar servi√ßos e depositar.</li>
                        <li><strong>Status de Prest√≠gio</strong> com um √≠cone üëë exclusivo no chat.</li>
                    </ul>
                </div>
                <button onclick="assinarVip()" style="margin-top: 15px;">üíé Assinar Agora</button>
            </div>
        `;
    }
    abrirModal('modalVip');
}

const SKUS = {
    VIP: 'adesao_vip_6_meses',
    TURBINAR: 'turbinar_perfil_24h',
    PRO_TIER1: 'pro_tier1',
    PRO_TIER2: 'pro_tier2',
    PRO_TIER3: 'pro_tier3'
};

let playStoreService = null;

async function setupPlayStoreBilling() {
    if ('getDigitalGoodsService' in window) {
        try {
            playStoreService = await window.getDigitalGoodsService("https://play.google.com/billing");
        } catch (error) {
            console.error("Falha ao conectar com o servi√ßo da Play Store:", error);
            playStoreService = null;
        }
    }
}

async function comprarComPlayStore(sku, precoEstimado) {
    if (!playStoreService) {
        exibirInfoPopup("Aviso", "O servi√ßo de pagamento da Play Store n√£o est√° dispon√≠vel neste navegador/dispositivo.");
        return;
    }

    try {
        const paymentMethodData = [{
            supportedMethods: "https://play.google.com/billing",
            data: { sku: sku }
        }];
        const paymentDetails = {
            total: {
                label: `Total`,
                amount: { currency: "BRL", value: precoEstimado.toString() }
            }
        };

        const request = new PaymentRequest(paymentMethodData, paymentDetails);
        const response = await request.show();
        const { purchaseToken } = response.details;

        exibirAguarde("Validando sua compra...");
        const validationResponse = await fetch(`${BACKEND_API_URL}/google-play/validate-purchase`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ purchaseToken, sku, uid: auth.currentUser.uid })
        });

        const validationData = await validationResponse.json();

        if (validationResponse.ok && validationData.success) {
            await response.complete('success');
            fecharTodosOsModais();
            exibirInfoPopup("Sucesso", "Compra conclu√≠da e benef√≠cio ativado!");
            location.reload(); // Recarrega para garantir que a UI reflita a mudan√ßa
        } else {
            await response.complete('fail');
            fecharTodosOsModais();
            exibirInfoPopup("Erro", validationData.message || "Falha ao validar a compra.");
        }

    } catch (error) {
        fecharTodosOsModais();
        console.error("Erro durante a compra na Play Store:", error);
        if (error.name !== 'AbortError' && error.name !== 'NotAllowedError') { // Ignora erros de cancelamento pelo usu√°rio
             exibirInfoPopup("Erro", "Ocorreu um erro ao processar seu pagamento na Play Store.");
        }
    }
}

function assinarVip() {
    if (playStoreService) {
        comprarComPlayStore(SKUS.VIP, PRECO_VIP);
        return;
    }

    if (perfil.saldo < PRECO_VIP) {
        exibirInfoPopup("Saldo Insuficiente", "Saldo insuficiente para assinar o VIP.");
        return abrirModal('modalCarteira');
    }
    if (!confirm(`Deseja assinar o plano VIP por R$ ${PRECO_VIP.toFixed(2)} (v√°lido por 6 meses)? O valor ser√° descontado do seu saldo.`)) return;

    exibirAguarde("Ativando VIP...");
    db.runTransaction(async t => {
        const clienteRef = db.collection("usuarios").doc(auth.currentUser.uid);
        const financeiroRef = db.collection("config").doc("financeiro");
        const clienteDoc = await t.get(clienteRef);
        if (isVipAtivo(clienteDoc.data())) throw "Voc√™ j√° √© um membro VIP ativo.";

        const expiracao = new Date();
        expiracao.setDate(expiracao.getDate() + 180);

        t.update(clienteRef, {
            saldo: firebase.firestore.FieldValue.increment(-PRECO_VIP),
            vip: true,
            vipExpirationDate: firebase.firestore.Timestamp.fromDate(expiracao)
        });
        t.set(financeiroRef, { arrecadadoVip: firebase.firestore.FieldValue.increment(PRECO_VIP) }, { merge: true });
    }).then(() => {
        fecharTodosOsModais();
        exibirInfoPopup("Sucesso", "Parab√©ns! Voc√™ agora √© um membro VIP!");
        notifyUser(auth.currentUser.uid, "üëë Bem-vindo ao VIP!", "Aproveite seus benef√≠cios exclusivos por 6 meses!");
        fecharModalAtual();
    }).catch(e => {
        fecharTodosOsModais();
        exibirInfoPopup("Erro", "Erro ao assinar VIP: " + e.message);
    });
}

function assinarPro(tier) {
    const plano = PRECOS_PRO[tier];
    if (!plano) {
        return exibirInfoPopup("Erro", "Plano PRO inv√°lido selecionado.");
    }
    const sku = `pro_${tier}`;

    if (playStoreService) {
        comprarComPlayStore(sku, plano.preco);
        return;
    }

    if (perfil.saldo < plano.preco) {
        exibirInfoPopup("Saldo Insuficiente", "Saldo insuficiente para assinar este plano PRO. Por favor, deposite fundos na sua carteira.");
        return abrirModal('modalCarteira');
    }
    if (!confirm(`Deseja assinar o plano PRO ${tier.replace('tier','')} por R$ ${plano.preco.toFixed(2)} (v√°lido por 30 dias)? O valor ser√° descontado do seu saldo.`)) return;

    exibirAguarde("Ativando PRO...");

    db.runTransaction(async t => {
        const proRef = db.collection("usuarios").doc(auth.currentUser.uid);
        const financeiroRef = db.collection("config").doc("financeiro");
        const proDoc = await t.get(proRef);

        if (isProAtivo(proDoc.data())) {
            throw "Voc√™ j√° √© um membro PRO ativo.";
        }

        const expiracao = new Date();
        expiracao.setDate(expiracao.getDate() + 30);

        t.update(proRef, {
            saldo: firebase.firestore.FieldValue.increment(-plano.preco),
            proAtivo: true,
            proTier: tier,
            proExpirationDate: firebase.firestore.Timestamp.fromDate(expiracao)
        });

        t.set(financeiroRef, { arrecadadoPro: firebase.firestore.FieldValue.increment(plano.preco) }, { merge: true });

    }).then(() => {
        fecharTodosOsModais();
        exibirInfoPopup("Sucesso", "Parab√©ns! Voc√™ agora √© um Profissional PRO!");
        notifyUser(auth.currentUser.uid, "üåü Bem-vindo ao PRO!", "Aproveite seus benef√≠cios exclusivos por 30 dias!");
        fecharModalAtual();
    }).catch(e => {
        fecharTodosOsModais();
        exibirInfoPopup("Erro", "Erro ao assinar PRO: " + e.message);
    });
}

function confirmarTurbinar() {
    if (playStoreService) {
        comprarComPlayStore(SKUS.TURBINAR, PRECO_TURBINAR);
        return;
    }

    if (perfil.saldo < PRECO_TURBINAR) {
        return exibirInfoPopup("Saldo Insuficiente", `Saldo insuficiente. Voc√™ precisa de R$ ${PRECO_TURBINAR.toFixed(2)}.`);
    }
    if (perfil.ultimoBoostComprado) {
        const vinteQuatroHorasAtras = new Date(Date.now() - 24 * 60 * 60 * 1000);
        if (perfil.ultimoBoostComprado.toDate() > vinteQuatroHorasAtras) {
            return exibirInfoPopup("Aviso", "Voc√™ s√≥ pode turbinar o perfil uma vez a cada 24 horas.");
        }
    }
    if (confirm(`Confirmar o boost de 24h por R$ ${PRECO_TURBINAR.toFixed(2)}? O valor ser√° descontado do seu saldo.`)) {
        exibirAguarde("Turbinando perfil...");
        const expiracao = new Date(Date.now() + 24 * 60 * 60 * 1000);
        db.collection('usuarios').doc(auth.currentUser.uid).update({
            saldo: firebase.firestore.FieldValue.increment(-PRECO_TURBINAR),
            boostExpiracao: firebase.firestore.Timestamp.fromDate(expiracao),
            ultimoBoostComprado: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
            fecharTodosOsModais();
            exibirInfoPopup('Sucesso', 'Perfil turbinado com sucesso! Voc√™ est√° no topo da lista por 24 horas.');
            fecharModalAtual();
        }).catch(e => {
            fecharTodosOsModais();
            exibirInfoPopup('Erro', 'Erro ao turbinar perfil: ' + e.message)
        });
    }
}

function isProAtivo(perfilUsuario) {
    if (!perfilUsuario || !perfilUsuario.proAtivo || !perfilUsuario.proExpirationDate) {
        return false;
    }
    if (perfilUsuario.proExpirationDate && typeof perfilUsuario.proExpirationDate.toDate === 'function') {
        return perfilUsuario.proExpirationDate.toDate() > new Date();
    }
    try {
        let expiryDate;
        if (typeof perfilUsuario.proExpirationDate === 'object' && perfilUsuario.proExpirationDate._seconds) {
             expiryDate = new Date(perfilUsuario.proExpirationDate._seconds * 1000);
        } else if (typeof perfilUsuario.proExpirationDate === 'string') {
             expiryDate = new Date(perfilUsuario.proExpirationDate);
        }
        if (expiryDate instanceof Date && !isNaN(expiryDate)) {
            return expiryDate > new Date();
        }
    } catch (e) {
        console.error("Erro ao processar proExpirationDate:", e, perfilUsuario.proExpirationDate);
    }
    return false;
}

function abrirModalVipPro() {
    const container = document.getElementById('vipProContentContainer');
    if (!container) return;
    const proAtivo = isProAtivo(perfil);

    if (proAtivo) {
        const dataExpiracao = perfil.proExpirationDate.toDate().toLocaleDateString('pt-BR');
        let taxaAtual = (TAXA_PADRAO * 100);
        let nomePlano = "Padr√£o";
        if(perfil.proTier && PRECOS_PRO[perfil.proTier]) {
            taxaAtual = PRECOS_PRO[perfil.proTier].taxa * 100;
            if(perfil.proTier === 'tier1') nomePlano = "Bronze";
            else if(perfil.proTier === 'tier2') nomePlano = "Prata";
            else if(perfil.proTier === 'tier3') nomePlano = "Ouro";
        }

        container.innerHTML = `
            <div class="pro-glow" style="padding: 20px; border-radius: 15px; text-align: center;">
                <h3 style="color: var(--cor-destaque-azul);">üåü Voc√™ √© um Profissional PRO (${nomePlano})!</h3>
                <p>Sua assinatura mensal √© v√°lida at√©: <strong>${dataExpiracao}</strong>.</p>
                <p>Sua taxa de servi√ßo atual √© de apenas: <strong>${taxaAtual.toFixed(1)}%</strong>.</p>
                <div class="vantagens" style="text-align: left; margin-top: 20px;">
                    <h4>Seus Benef√≠cios Atuais:</h4>
                    <ul>
                        <li>Selo üåü PRO de destaque no perfil e no chat.</li>
                        <li><strong>Taxa de servi√ßo reduzida.</strong></li>
                        <li>Acesso ao Dashboard de Desempenho.</li>
                    </ul>
                </div>
            </div>
        `;
    } else {
        container.innerHTML = `
            <div style="text-align: center;">
                <h3 style="color: var(--cor-destaque-azul);">üåü Torne-se um Profissional PRO!</h3>
                <p>Aumente seus lucros reduzindo a taxa de servi√ßo do aplicativo.</p>

                <div style="display: flex; flex-direction: column; gap: 15px; margin-top: 20px;">
                    <div class="card" style="border: 1px solid #cd7f32;">
                        <h4>Plano Bronze</h4>
                        <p style="font-size: 22px; font-weight: bold;">R$ ${PRECOS_PRO.tier1.preco.toFixed(2)}<small>/m√™s</small></p>
                        <p>Reduz a taxa de servi√ßo para <strong>4%</strong>.</p>
                        <button onclick="assinarPro('tier1')" style="background-color: #cd7f32;">Assinar Bronze</button>
                    </div>

                    <div class="card" style="border: 1px solid #c0c0c0;">
                        <h4>Plano Prata</h4>
                        <p style="font-size: 22px; font-weight: bold;">R$ ${PRECOS_PRO.tier2.preco.toFixed(2)}<small>/m√™s</small></p>
                        <p>Reduz a taxa de servi√ßo para <strong>2%</strong>.</p>
                        <button onclick="assinarPro('tier2')" style="background-color: #c0c0c0; color: #333;">Assinar Prata</button>
                    </div>

                    <div class="card vip-glow">
                        <h4>Plano Ouro</h4>
                        <p style="font-size: 22px; font-weight: bold;">R$ ${PRECOS_PRO.tier3.preco.toFixed(2)}<small>/m√™s</small></p>
                        <p><strong>ZERE</strong> a taxa de servi√ßo (<strong>0%</strong>).</p>
                        <button onclick="assinarPro('tier3')">Assinar Ouro</button>
                    </div>
                </div>
            </div>
        `;
    }
    abrirModal('modalVipPro');
}

function isVipAtivo(perfilUsuario) {
    if (!perfilUsuario || !perfilUsuario.vip || !perfilUsuario.vipExpirationDate) {
        return false;
    }
    if (perfilUsuario.vipExpirationDate && typeof perfilUsuario.vipExpirationDate.toDate === 'function') {
        return perfilUsuario.vipExpirationDate.toDate() > new Date();
    }
    try {
        let expiryDate;
        if (typeof perfilUsuario.vipExpirationDate === 'object' && perfilUsuario.vipExpirationDate._seconds) {
             expiryDate = new Date(perfilUsuario.vipExpirationDate._seconds * 1000);
        } else if (typeof perfilUsuario.vipExpirationDate === 'string') {
             expiryDate = new Date(perfilUsuario.vipExpirationDate);
        }
        if (expiryDate instanceof Date && !isNaN(expiryDate)) {
            return expiryDate > new Date();
        }
    } catch (e) {
        console.error("Erro ao processar vipExpirationDate:", e, perfilUsuario.vipExpirationDate);
    }
    return false;
}

let chatAtual = 'global';
function abrirChatGlobal() {
    const badge = document.querySelector('.notification-badge');
    newMessagesCount = 0;
    if(badge) {
        badge.textContent = '0';
        badge.classList.add('hidden');
    }
    abrirModal('janelaChat');
    alternarChat('global');
}

function alternarChat(tipo) {
    chatAtual = tipo;
    document.getElementById('tabChatGlobal')?.classList.toggle('active', tipo === 'global');
    document.getElementById('tabChatLocal')?.classList.toggle('active', tipo === 'local');

    const adminSelector = document.getElementById('adminChatSelectorContainer');
    if (adminSelector) adminSelector.classList.add('hidden');

    const chatContainer = document.getElementById("chatMessages");
    if (!chatContainer) return;
    chatContainer.innerHTML = "";
    if (chatListener) chatListener();

    let query = db.collection("chats").doc(CHAT_GLOBAL_ID).collection("mensagens");
    const agora = new Date();
    const chatTitleElement = document.getElementById("chatTitle");

    if (tipo === 'local') {
        if (perfil && perfil.tipo === 'admin') {
            if (chatTitleElement) chatTitleElement.textContent = `üìç Chat Local (Todas as Cidades)`;
        } else if (perfil && perfil.cidade) {
            query = query.where("cidade", "==", perfil.cidade);
            if (chatTitleElement) chatTitleElement.textContent = `üìç Chat Local (${perfil.cidade})`;
        } else {
             if (chatTitleElement) chatTitleElement.textContent = `üìç Chat Local (Carregando...)`;
             return; // N√£o carrega se n√£o tiver cidade definida (exceto admin)
        }
    } else {
        if (chatTitleElement) chatTitleElement.textContent = 'üí¨ Chat Global';
    }

    query = query.where("deleteAt", ">", agora).orderBy("deleteAt", "desc").limit(15);

    chatListener = query.onSnapshot(async snapshot => {
        if(snapshot.empty) {
            chatContainer.innerHTML = `<p>Nenhuma mensagem neste chat ainda.</p>`;
            oldestMessageSnapshot = null;
            return;
        }
        oldestMessageSnapshot = snapshot.docs[snapshot.docs.length - 1];
        const mensagensHtmlPromises = snapshot.docs.reverse().map(doc => createMessageDiv(doc.data(), doc.id));
        const mensagensHtml = await Promise.all(mensagensHtmlPromises);
        chatContainer.innerHTML = ""; // Limpa antes de adicionar
        mensagensHtml.forEach(div => chatContainer.appendChild(div));
        // Auto scroll to bottom
        chatContainer.scrollTop = chatContainer.scrollHeight;

    }, err => {
        console.error("Erro no listener do chat:", err);
        chatContainer.innerHTML = "<p>Erro ao carregar mensagens.</p>";
    });

    const chatInput = document.getElementById('chatInput');
    if(chatInput) {
        chatInput.removeEventListener('keydown', handleChatEnterKey); // Remove listener antigo para evitar duplica√ß√£o
        chatInput.addEventListener('keydown', handleChatEnterKey);
    }
    if (!botInterval) botInterval = setInterval(sendBotMessage, 3600000); // 1 hora
}

function handleChatEnterKey(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        enviarMensagem();
    }
}

async function carregarMensagensAnteriores() {
    if (!oldestMessageSnapshot) return;

    const btn = document.getElementById('carregarMaisMsgBtn');
    if (!btn) return;
    btn.textContent = 'Carregando...';
    btn.disabled = true;

    const agora = new Date();
    let query = db.collection("chats").doc(CHAT_GLOBAL_ID).collection("mensagens");
    if (chatAtual === 'local') {
         if (perfil && perfil.tipo !== 'admin' && perfil.cidade) {
            query = query.where("cidade", "==", perfil.cidade);
         }
    }
    query = query.where("deleteAt", ">", agora).orderBy("deleteAt", "desc").startAfter(oldestMessageSnapshot).limit(50);

    try {
        const snapshot = await query.get();
        const chatContainer = document.getElementById("chatMessages");

        if (snapshot.empty) {
            btn.textContent = 'Fim do hist√≥rico';
            return;
        }

        oldestMessageSnapshot = snapshot.docs[snapshot.docs.length - 1];

        const mensagensHtmlPromises = snapshot.docs.map(doc => createMessageDiv(doc.data(), doc.id));
        const mensagensHtml = await Promise.all(mensagensHtmlPromises);

        // Adiciona as mensagens no TOPO do container
        mensagensHtml.reverse().forEach(div => chatContainer.insertBefore(div, chatContainer.firstChild));

        btn.textContent = 'Ver mensagens anteriores';
        btn.disabled = false;

    } catch (error) {
        console.error("Erro ao carregar mensagens anteriores:", error);
        btn.textContent = 'Erro ao carregar';
    }
}

async function createMessageDiv(msg, docId) {
    let remetenteNome = msg.remetenteNome || "Desconhecido";
    let classeCSS = "", iconeBase = "", medalhaIcone = "", itemExclusivoIcone = "";
    const messageDiv = document.createElement('div');
    const isCurrentUser = auth.currentUser && msg.remetenteUid === auth.currentUser.uid;
    messageDiv.className = `chat-message ${isCurrentUser ? "chat-sent" : "chat-received"}`;

    if (msg.tipo === "bot" || msg.tipo === "ai_suporte") {
        remetenteNome = `<span style="color: ${msg.tipo === "ai_suporte" ? '#8e44ad' : '#e74c3c'};">${msg.tipo === "ai_suporte" ? 'ü§ñ Suporte AI' : 'ü§ñ Vers√£oPro Bot'}</span>`;
    } else if (msg.remetenteUid) {
        try {
            const remetenteDoc = await db.collection("usuarios").doc(msg.remetenteUid).get();
            if(remetenteDoc.exists) {
                const remetenteData = remetenteDoc.data();
                remetenteNome = remetenteData.nome || remetenteNome; // Atualiza o nome se existir

                if (remetenteData.possuiItemExclusivo) { // Assumindo que este campo existe
                    itemExclusivoIcone = 'üëï‚ú® '; // Adicione espa√ßo
                }

                if (remetenteData.tipo === "admin") {
                    classeCSS = `admin-chat-red`;
                    iconeBase = `üß† `;
                    messageDiv.style.textShadow = '0 0 5px #000';
                } else if (remetenteData.tipo !== "cliente") {
                    classeCSS = `barbeiro-chat`;
                    iconeBase = isProAtivo(remetenteData) ? `üåü ` : `üíº `;
                    medalhaIcone = obterIconeMaiorConquista(remetenteData.conquistas, 'profissional');
                } else { // Cliente
                    classeCSS = `cliente-chat`;
                    iconeBase = isVipAtivo(remetenteData) ? `üëë ` : `üë§ `;
                    medalhaIcone = obterIconeMaiorConquista(remetenteData.conquistas, 'cliente');
                }

                let cidadeLabel = '';
                if (perfil && perfil.tipo === 'admin' && chatAtual === 'local' && msg.cidade && msg.cidade !== 'global') {
                    cidadeLabel = ` <small style="opacity: 0.7; font-weight: normal;">(${msg.cidade})</small>`;
                }

                remetenteNome = `<span class="${classeCSS}">${itemExclusivoIcone}${medalhaIcone}${iconeBase}${remetenteData.nome || 'Usu√°rio'}${cidadeLabel}</span>`;
            } else {
                 remetenteNome = `<span class="cliente-chat">üë§ Usu√°rio</span>`; // Fallback se n√£o encontrar doc
            }
        } catch(e) {
             console.warn("Erro ao buscar dados do remetente:", e);
             remetenteNome = `<span class="cliente-chat">üë§ Usu√°rio</span>`; // Fallback em caso de erro
        }
    } else {
         remetenteNome = `<span class="cliente-chat">üë§ Usu√°rio</span>`; // Fallback geral
    }

    // Escapa HTML no texto da mensagem para prevenir XSS
    const textoSeguro = msg.texto.replace(/</g, "&lt;").replace(/>/g, "&gt;");
    messageDiv.innerHTML = `<b>${remetenteNome}:</b> ${textoSeguro}`;
    messageDiv.id = `msg-${docId || msg.ts?.toMillis() || Date.now()}`;
    return messageDiv;
}

const botMessages = [ "Dica: Avalie seu profissional para ganhar pontos de fidelidade e ajudar a comunidade!", "Voc√™ sabia? Indicando um amigo com seu e-mail, voc√™s dois ganham 100 pontos de fidelidade ap√≥s o primeiro agendamento conclu√≠do dele!", "Mantenha seu saldo atualizado! Use a fun√ß√£o de dep√≥sito para adicionar cr√©ditos de forma r√°pida e segura.", "Precisa de ajuda ou tem uma sugest√£o? Use a op√ß√£o 'Denunciar' para falar diretamente com um administrador.", "Torne-se VIP para ter 10% de desconto em todos os servi√ßos e ganhar o dobro de pontos!", "Fique de olho no nosso Blog! Postamos c√≥digos de resgate valendo pontos de fidelidade. Procure por c√≥digos entre (par√™nteses)!", "Explore a nossa Loja! Produtos exclusivos e da comunidade est√£o dispon√≠veis para voc√™.", "Complete agendamentos e desbloqueie conquistas para mostrar seu status no chat!" ];
let lastBotMessageIndex = -1;

function sendBotMessage() {
    if (!auth.currentUser) return; // N√£o envia se n√£o estiver logado
    let randomIndex;
    do { randomIndex = Math.floor(Math.random() * botMessages.length); } while (randomIndex === lastBotMessageIndex);
    lastBotMessageIndex = randomIndex;
    const deleteAt = new Date(Date.now() + 24 * 60 * 60 * 1000);
    db.collection("chats").doc(CHAT_GLOBAL_ID).collection("mensagens").add({
        remetenteUid: "bot-uid", remetenteNome: "Nova Vers√£o Bot", tipo: "bot",
        texto: botMessages[randomIndex], ts: firebase.firestore.FieldValue.serverTimestamp(),
        cidade: "global",
        deleteAt: firebase.firestore.Timestamp.fromDate(deleteAt)
    }).catch(err => console.error("Erro ao enviar mensagem do bot:", err));
}

async function alterarSenhaUsuario() {
    const senhaAntiga = document.getElementById('senhaAntiga')?.value;
    const senhaNova = document.getElementById('senhaNova')?.value;
    const senhaNovaConfirm = document.getElementById('senhaNovaConfirm')?.value;
    const user = auth.currentUser;

    if (!user) {
        exibirInfoPopup("Erro", "Voc√™ precisa estar logado para alterar a senha.");
        return;
    }
    if (!senhaAntiga || !senhaNova || !senhaNovaConfirm) {
        exibirInfoPopup("Erro", "Por favor, preencha todos os campos.");
        return;
    }
    if (senhaNova.length < 6) {
        exibirInfoPopup("Erro", "A nova senha deve ter pelo menos 6 caracteres.");
        return;
    }
    if (senhaNova !== senhaNovaConfirm) {
        exibirInfoPopup("Erro", "A nova senha e a confirma√ß√£o n√£o coincidem.");
        return;
    }

    exibirAguarde("Verificando senha atual...");

    try {
        const credential = firebase.auth.EmailAuthProvider.credential(user.email, senhaAntiga);
        await user.reauthenticateWithCredential(credential);

        exibirAguarde("Atualizando senha...");
        await user.updatePassword(senhaNova);

        fecharTodosOsModais();
        exibirInfoPopup("Sucesso", "‚úÖ Senha alterada com sucesso!");

        document.getElementById('senhaAntiga').value = '';
        document.getElementById('senhaNova').value = '';
        document.getElementById('senhaNovaConfirm').value = '';
        fecharModalAtual();

    } catch (error) {
        fecharTodosOsModais();
        console.error("Erro ao alterar senha:", error);
        if (error.code === 'auth/wrong-password') {
            exibirInfoPopup("Erro", "‚ùå A senha atual informada est√° incorreta.");
        } else if (error.code === 'auth/too-many-requests') {
             exibirInfoPopup("Erro", "‚ùå Muitas tentativas incorretas. Tente novamente mais tarde.");
        } else {
            exibirInfoPopup("Erro", "‚ùå Ocorreu um erro ao tentar alterar a senha: " + error.message);
        }
    }
}

function enviarMensagem() {
    if (!auth.currentUser) {
        exibirInfoPopup("Aviso", "Para enviar mensagens, por favor, fa√ßa login ou crie uma conta.");
        mostrar('authView');
        fecharModalAtual();
        return;
    }
    if (isSending) return;
    const textoInput = document.getElementById("chatInput");
    const texto = textoInput?.value.trim();
    if (!texto) return;
    isSending = true;
    const deleteAt = new Date(Date.now() + 24 * 60 * 60 * 1000);
    const msgData = {
        remetenteUid: auth.currentUser.uid, remetenteNome: perfil.nome, tipo: perfil.tipo, texto,
        ts: firebase.firestore.FieldValue.serverTimestamp(),
        cidade: perfil.cidade || 'global', // Usa a cidade do perfil ou 'global'
        deleteAt: firebase.firestore.Timestamp.fromDate(deleteAt)
    };
    db.collection("chats").doc(CHAT_GLOBAL_ID).collection("mensagens").add(msgData)
    .then(() => {
        if(textoInput) textoInput.value = "";
        if (texto.toLowerCase().includes('suporte')) {
            setTimeout(enviarRespostaAI, 1500);
        }
        setTimeout(() => { isSending = false; }, 500); // Reduzido para permitir envio mais r√°pido
    }).catch(error => {
        console.error("Erro ao enviar mensagem:", error);
        isSending = false;
        exibirInfoPopup("Erro", "N√£o foi poss√≠vel enviar a mensagem.");
    });
}

function enviarRespostaAI() {
    const resposta = `Ol√°! Sou a assistente virtual. Como posso ajudar? <br><br>
        ‚Ä¢ Para <b>d√∫vidas sobre o app</b> (agendamentos, carteira, VIP, etc.), tente ser espec√≠fico na sua pergunta. <br>
        ‚Ä¢ Para <b>contatar um administrador</b> sobre problemas urgentes, den√∫ncias ou sugest√µes, use o bot√£o üö® no canto inferior esquerdo ou chame diretamente no WhatsApp: <a href="https://wa.me/${WHATSAPP_ADM_PHONE}" target="_blank">clique aqui</a>.`;
    const deleteAt = new Date(Date.now() + 24 * 60 * 60 * 1000);
    db.collection("chats").doc(CHAT_GLOBAL_ID).collection("mensagens").add({
        remetenteUid: "ai-suporte-uid",
        remetenteNome: "Suporte AI",
        tipo: "ai_suporte",
        texto: resposta,
        ts: firebase.firestore.FieldValue.serverTimestamp(),
        cidade: chatAtual === 'local' ? (perfil?.cidade || 'global') : 'global',
        deleteAt: firebase.firestore.Timestamp.fromDate(deleteAt)
    }).catch(err => console.error("Erro ao enviar resposta AI:", err));
}

function adminCarregarCidadesChat() {
    const estado = document.getElementById('adminChatEstado')?.value;
    const cidadeSelect = document.getElementById('adminChatCidade');
    if (!cidadeSelect) return;
    const valorAtual = cidadeSelect.value;
    cidadeSelect.innerHTML = '<option value="">Selecione a cidade</option>';
    const cidades = cidadesPorEstado[estado] || [];
    cidades.forEach(c => {
        const isSelected = c === valorAtual || (c === perfil?.cidade && !valorAtual);
        cidadeSelect.innerHTML += `<option value="${c}" ${isSelected ? 'selected' : ''}>${c}</option>`;
    });
    if(perfil?.tipo === 'admin') {
        adminRecarregarChat();
    }
}

function adminRecarregarChat() {
    alternarChat('local');
}

function criarAviso(uid, mensagem, tipo = 'geral', agendamentoId = null) {
  const avisoData = { usuarioUid: uid, mensagem, tipo, lido: false, ts: firebase.firestore.FieldValue.serverTimestamp() };
  if (agendamentoId) avisoData.agendamentoId = agendamentoId;
  db.collection("avisos").add(avisoData).catch(err => console.error("Erro ao criar aviso:", err));
}

function enviarDenuncia() {
  const textoInput = document.getElementById("textoDenuncia");
  const texto = textoInput?.value.trim();
  if (!texto) return exibirInfoPopup("Erro", "Por favor, descreva o problema.");
  db.collection("denuncias").add({
    usuarioUid: auth.currentUser.uid, usuarioNome: perfil.nome, texto,
    status: "aberta", ts: firebase.firestore.FieldValue.serverTimestamp()
  }).then(denunciaRef => {
    fecharModalAtual(); // Fecha modal de den√∫ncia
    abrirModal('modalDenunciaEnviada');
    const mensagem = encodeURIComponent(`üö® Nova den√∫ncia no app. ID: ${denunciaRef.id}\n\nDe: ${perfil.nome}\n\nDescri√ß√£o: ${texto}`);
    const btnWhatsapp = document.getElementById("btnWhatsappDenuncia");
    if(btnWhatsapp) btnWhatsapp.href = `https://wa.me/${WHATSAPP_ADM_PHONE}?text=${mensagem}`;
    if(textoInput) textoInput.value = "";
    notifyAdmins("üö® Nova Den√∫ncia!", `Uma nova den√∫ncia foi enviada por ${perfil.nome}.`, { link: '#denuncias' });
  }).catch(e => exibirInfoPopup("Erro", "Erro ao enviar den√∫ncia: " + e.message));
}

function abrirServicos() {
  abrirModal('modalServicosBarbeiro');
  listarServicos();
}

function listarServicos() {
  const lista = document.getElementById("listaServicosBarbeiro");
  if (!lista) return;
  lista.innerHTML = "<p>‚è≥ Carregando...</p>";
  db.collection("usuarios").doc(auth.currentUser.uid).onSnapshot(doc => {
    if (!doc.exists) return;
    perfil = doc.data(); // Atualiza o perfil local
    lista.innerHTML = "";
    if (!perfil.listaServicos || perfil.listaServicos.length === 0) {
      lista.innerHTML = "<p>Nenhum servi√ßo cadastrado.</p>";
      return;
    }
    perfil.listaServicos.forEach((s, index) => {
      lista.innerHTML += `<div class="card"><b>${s.nome}</b> - R$ ${s.valor.toFixed(2)} ${s.duracao ? `(${s.duracao} min)` : ''}<button onclick="removerServico(${index})" style="float:right; background: #c0392b; padding: 5px 8px;">‚ùå</button></div>`;
    });
  }, err => {
      console.error("Erro ao listar servi√ßos:", err);
      lista.innerHTML = "<p>Erro ao carregar servi√ßos.</p>";
  });
}

function adicionarServico() {
  document.getElementById('addServicoNome').value = '';
  document.getElementById('addServicoValor').value = '';
  document.getElementById('addServicoDuracao').value = '';
  abrirModal('modalAddServico');
}

function salvarNovoServico() {
  const nome = document.getElementById('addServicoNome')?.value.trim();
  const valor = parseFloat(document.getElementById('addServicoValor')?.value);
  const duracao = parseInt(document.getElementById('addServicoDuracao')?.value);

  if (!nome || isNaN(valor) || valor <= 0 || isNaN(duracao) || duracao <= 0) {
      return exibirInfoPopup("Erro", "Entrada inv√°lida. Preencha nome, valor (positivo) e dura√ß√£o (positiva) corretamente.");
  }

  const servico = { nome, valor, duracao };
  db.collection("usuarios").doc(auth.currentUser.uid).update({
    listaServicos: firebase.firestore.FieldValue.arrayUnion(servico)
  }).then(() => {
    exibirInfoPopup("Sucesso", "Servi√ßo adicionado com sucesso!");
    fecharModalAtual();
  }).catch(e => {
     exibirInfoPopup("Erro", "Erro ao adicionar servi√ßo: " + e.message);
  });
}

function removerServico(index) {
  if (!perfil || !perfil.listaServicos || index < 0 || index >= perfil.listaServicos.length) return;
  const servicoParaRemover = perfil.listaServicos[index];
  if (!confirm(`Deseja remover "${servicoParaRemover.nome}"?`)) return;
  db.collection("usuarios").doc(auth.currentUser.uid).update({
    listaServicos: firebase.firestore.FieldValue.arrayRemove(servicoParaRemover)
  }).then(() => exibirInfoPopup("Sucesso", "Servi√ßo removido!")).catch(e => exibirInfoPopup("Erro", "Erro: " + e.message));
}

async function uploadLogomarca() {
    const fileInput = document.getElementById('logomarcaFile');
    if (!fileInput) return exibirInfoPopup("Erro", "Elemento de arquivo n√£o encontrado.");
    const file = fileInput.files[0];
    if (!file) return exibirInfoPopup("Aviso", "Selecione um arquivo de imagem ou GIF.");
    if (!auth.currentUser) return;

    const progressBar = document.getElementById('logomarcaProgress');
    const saveButton = document.querySelector('#modalLogomarca button[onclick="uploadLogomarca()"]');
    exibirAguarde("Enviando logomarca...");
    if(progressBar) progressBar.style.display = 'block';
    if(progressBar) progressBar.value = 0;
    if(saveButton) saveButton.disabled = true;

    const storageRef = storage.ref(`logomarcas/${auth.currentUser.uid}/${Date.now()}_${file.name}`);
    const uploadTask = storageRef.put(file);

    uploadTask.on('state_changed',
        (snapshot) => {
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            if(progressBar) progressBar.value = progress;
        },
        (error) => {
            fecharTodosOsModais();
            console.error("Erro no upload da logomarca:", error);
            exibirInfoPopup("Erro", "Falha no upload: " + error.code);
            if(progressBar) progressBar.style.display = 'none';
            if(saveButton) saveButton.disabled = false;
        },
        async () => {
            try {
                const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                await db.collection('usuarios').doc(auth.currentUser.uid).update({ logo_url: downloadURL });
                if(progressBar) progressBar.style.display = 'none';
                if(saveButton) saveButton.disabled = false;
                fecharTodosOsModais();
                exibirInfoPopup('Sucesso', 'Logomarca salva com sucesso!');
                fecharModalAtual();
            } catch (dbError) {
                fecharTodosOsModais();
                exibirInfoPopup('Erro', 'Erro ao salvar URL no banco de dados: ' + dbError.message);
                if(progressBar) progressBar.style.display = 'none';
                if(saveButton) saveButton.disabled = false;
            }
        }
    );
}

function previewImage(input, previewId) {
    const file = input.files[0];
    const reader = new FileReader();
    const previewElement = document.getElementById(previewId);
    reader.onload = function(e) {
       if (previewElement) previewElement.src = e.target.result;
    }
    if (file && previewElement) { reader.readAsDataURL(file); }
    else if(previewElement) { previewElement.src = 'https://via.placeholder.com/100?text=Logo';}
}

async function salvarNovoEndereco() {
    const rua = document.getElementById("novoEnderecoRua")?.value.trim();
    const numero = document.getElementById("novoEnderecoNumero")?.value.trim();
    if (!rua || !numero) {
        return exibirInfoPopup("Erro", "Preencha a Rua e o N√∫mero.");
    }
    exibirAguarde("Salvando endere√ßo...");
    try {
        await db.collection("usuarios").doc(auth.currentUser.uid).update({ rua, numero });
        fecharTodosOsModais();
        exibirInfoPopup("Sucesso", "Endere√ßo atualizado!");
        fecharModalAtual();
    } catch(e) {
        fecharTodosOsModais();
        exibirInfoPopup("Erro", "Erro ao salvar endere√ßo: " + e.message);
    }
}
async function salvarLocalizacaoAtualEndereco() {
    const ruaInput = document.getElementById("novoEnderecoRua");
    const numeroInput = document.getElementById("novoEnderecoNumero");
    const rua = ruaInput?.value.trim();
    const numero = numeroInput?.value.trim();
    const btnSalvar = document.getElementById('btnSalvarLocalAtual');

    if (!rua || !numero) {
        return exibirInfoPopup("Erro", "Por favor, preencha a Rua e o N√∫mero antes de salvar a localiza√ß√£o.");
    }

    if(btnSalvar) btnSalvar.textContent = '‚è≥ Obtendo localiza√ß√£o...';
    if(btnSalvar) btnSalvar.disabled = true;

    try {
        await new Promise((resolve, reject) => {
            if (!navigator.geolocation) {
               return reject(new Error("Geolocaliza√ß√£o n√£o suportada."));
            }
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    cadastroCoords = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                    };
                    resolve();
                },
                (error) => {
                     reject(error);
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        });

        exibirAguarde("Salvando endere√ßo e localiza√ß√£o...");
        await db.collection("usuarios").doc(auth.currentUser.uid).update({
            rua,
            numero,
            latitude: cadastroCoords.latitude,
            longitude: cadastroCoords.longitude,
        });

        fecharTodosOsModais();
        exibirInfoPopup("Sucesso", "Endere√ßo e localiza√ß√£o atualizados!");
        cadastroCoords = null;
        fecharModalAtual();

    } catch (error) {
        console.error("Erro ao obter localiza√ß√£o ou salvar:", error);
        exibirInfoPopup("Erro", "N√£o foi poss√≠vel obter a localiza√ß√£o atual ou salvar. Verifique as permiss√µes do navegador ou tente novamente. (" + error.message + ")");
        fecharAguarde();
    } finally {
         if(btnSalvar) btnSalvar.textContent = 'üìç Salvar Localiza√ß√£o Atual';
         if(btnSalvar) btnSalvar.disabled = false;
    }
}

function abrirAgenda() {
    abrirModal('modalAgendaBarbeiro');
    carregarAgenda();
}

function carregarAgenda() {
    const btnDisp = document.getElementById("btnDisponibilidade");
    const btnVagaImediata = document.getElementById("btnVagaImediata");
    const btnAgendaManual = document.getElementById("btnAgendaManual");
    const agendaManualPainel = document.getElementById("agendaManualPainel");
    const horariosContainer = document.getElementById("horariosContainer");

    db.collection("usuarios").doc(auth.currentUser.uid).onSnapshot(doc => {
        if (!doc.exists) return;
        perfil = doc.data();
        if(!btnDisp || !btnVagaImediata || !btnAgendaManual) return;
        btnDisp.textContent = perfil.disponivel === 'sim' ? 'üî¥ Ficar Indispon√≠vel (Autom√°tico)' : 'üü¢ Ficar Dispon√≠vel (Autom√°tico)';
        btnVagaImediata.textContent = perfil.vagaImediata ? '‚ö†Ô∏è Desativar Vaga Imediata' : '‚ö° Ativar Vaga Imediata';
        btnAgendaManual.textContent = perfil.usaAgendaManual ? '‚ùå Desativar Agenda Manual' : 'üìÖ Ativar Agenda Manual';

        if (perfil.usaAgendaManual) {
            if (agendaManualPainel) agendaManualPainel.classList.remove("hidden");
            if (horariosContainer) {
                horariosContainer.innerHTML = "";
                tempSelectedHorarios = { ...(perfil.agenda || {}) };
                for (let i = 7; i <= 18; i++) {
                    for (let min = 0; min < 60; min += 30) { // Adiciona hor√°rios de meia em meia hora
                        const hora = i.toString().padStart(2, '0');
                        const minuto = min.toString().padStart(2, '0');
                        const horario = `${hora}:${minuto}`;
                        const statusHorario = tempSelectedHorarios[horario];
                        const btn = document.createElement('button');
                        btn.textContent = horario;
                        btn.className = `horario-btn`;
                        if(statusHorario === true) btn.classList.add('selecionado');
                        if(statusHorario === 'bloqueado') btn.classList.add('bloqueado');
                        btn.onclick = () => toggleHorario(horario);
                        horariosContainer.appendChild(btn);
                    }
                }
            }
        } else {
            if (agendaManualPainel) agendaManualPainel.classList.add("hidden");
        }
    }, err => console.error("Erro ao carregar agenda:", err));
}

function abrirAgendamentosBarbeiro() {
  abrirModal('modalAgendamentosBarbeiro');
  const painel = document.getElementById("agendamentosPainel");
  if (!painel) return;
  painel.innerHTML = "<p>‚è≥ Carregando...</p>";
  if (agendamentoListener) agendamentoListener(); // Cancela listener anterior
  agendamentoListener = db.collection("agendamentos")
    .where("barbeiroUid", "==", auth.currentUser.uid)
    .where("status", "in", ["pendente", "confirmado", "imediato", "conclus√£o pendente"])
    .orderBy("ts", "asc")
    .onSnapshot(snap => {
        painel.innerHTML = snap.empty ? "<p>Nenhum agendamento ativo.</p>" : "";
        snap.forEach(doc => {
            const ag = doc.data();
            let botoes = "", statusTexto = "", horarioInfo = ag.horario ? ` √†s <b>${ag.horario}</b>` : ' (Vaga Imediata)';
            const dataAgendamento = ag.ts ? new Date(ag.ts.seconds * 1000).toLocaleDateString('pt-BR') : 'Data Indispon√≠vel';

            if (ag.status === "pendente") {
                statusTexto = "‚è≥ Aguardando Aprova√ß√£o";
                botoes = `<button onclick="aprovarAgendamento('${doc.id}','${ag.clienteUid}',${ag.valor},'${ag.horario}')">‚úÖ Aprovar</button><button onclick="recusarAgendamento('${doc.id}','${ag.clienteUid}')" style="background:#e74c3c;">‚ùå Recusar</button>`;
            } else if (ag.status === "confirmado" || ag.status === "conclus√£o pendente") {
                statusTexto = "‚úÖ Conclus√£o Pendente";
                botoes = `<button onclick="concluirAgendamento('${doc.id}','${ag.clienteUid}')">‚úÇÔ∏è Concluir</button><button onclick="cancelarAgendamentoManualmente('${doc.id}','${ag.clienteUid}',${ag.valor})" style="background:#e74c3c;">‚ùå Cancelar</button>`;
            } else if (ag.status === "imediato") {
                statusTexto = "‚ö° Vaga Imediata Pendente";
                botoes = `<button onclick="aprovarAgendamentoImediato('${doc.id}','${ag.clienteUid}',${ag.valor})">‚úÖ Aprovar</button><button onclick="recusarAgendamento('${doc.id}','${ag.clienteUid}')" style="background:#e74c3c;">‚ùå Recusar</button>`;
            }
            const telefoneLimpoBarbeiro = ag.clienteTelefone ? ag.clienteTelefone.replace(/\D/g, '') : '';
            const linkWhatsapp = telefoneLimpoBarbeiro ? `<br><a href="https://wa.me/55${telefoneLimpoBarbeiro}" target="_blank">üìû Contatar Cliente</a>` : '';
            painel.innerHTML += `<div class="card"><b>${ag.clienteNome}</b> - ${ag.servico} (R$ ${ag.valor.toFixed(2)})<br>Data: ${dataAgendamento}${horarioInfo}<br>Status: <b>${statusTexto}</b>${linkWhatsapp}<div style="margin-top:10px; display:flex; gap: 8px;">${botoes}</div></div>`;
        });
        verificarPendenciasVisuaisBarbeiro(); // Atualiza o bot√£o pulsante
    }, err => {
        console.error("Erro no listener de agendamentos:", err);
        painel.innerHTML = "<p>Erro ao carregar agendamentos.</p>";
    });
}

function toggleVagaImediata() {
    if (!perfil) return;
    db.collection("usuarios").doc(auth.currentUser.uid).update({ vagaImediata: !perfil.vagaImediata }).catch(e => exibirInfoPopup("Erro", "Erro: " + e.message));
}

function toggleAgendaManual() {
  if (!perfil) return;
  db.collection("usuarios").doc(auth.currentUser.uid).update({ usaAgendaManual: !perfil.usaAgendaManual }).catch(e => exibirInfoPopup("Erro", "Erro: " + e.message));
}

function toggleHorario(horario) {
    const btn = Array.from(document.querySelectorAll('#horariosContainer .horario-btn')).find(b => b.textContent === horario);
    if (!btn) return;
    const statusAtual = tempSelectedHorarios[horario];
    if (statusAtual === true) {
        tempSelectedHorarios[horario] = 'bloqueado';
        btn.classList.remove("selecionado"); btn.classList.add("bloqueado");
    } else if (statusAtual === 'bloqueado') {
        delete tempSelectedHorarios[horario];
        btn.classList.remove("bloqueado");
    } else {
        tempSelectedHorarios[horario] = true;
        btn.classList.add("selecionado");
    }
}

function salvarAgendaManual() {
    db.collection("usuarios").doc(auth.currentUser.uid).update({ agenda: tempSelectedHorarios })
      .then(() => exibirInfoPopup("Sucesso", "Agenda salva!"))
      .catch(e => exibirInfoPopup("Erro", "Erro ao salvar: " + e.message));
}

function toggleDisponibilidade() {
  if (!perfil) return;
  db.collection("usuarios").doc(auth.currentUser.uid).update({ disponivel: perfil.disponivel === "sim" ? "nao" : "sim" }).catch(e => exibirInfoPopup("Erro", "Erro: " + e.message));
}

async function aprovarAgendamentoImediato(agendamentoId, clienteUid, valor) {
    if (!confirm("Aprovar esta vaga imediata?")) return;
    exibirAguarde("Aprovando vaga...");

    let taxaAplicada = TAXA_PADRAO;
    if (perfil && isProAtivo(perfil) && perfil.proTier && PRECOS_PRO[perfil.proTier]) {
        taxaAplicada = PRECOS_PRO[perfil.proTier].taxa;
    }
    const valorComTaxa = valor * (1 - taxaAplicada);
    const valorAdmin = valor * taxaAplicada;

    try {
        await db.runTransaction(async t => {
            const agendamentoRef = db.collection("agendamentos").doc(agendamentoId);
            const clienteRef = db.collection("usuarios").doc(clienteUid);
            const barbeiroRef = db.collection("usuarios").doc(auth.currentUser.uid);
            const [agendamentoDoc, clienteDoc, barbeiroDoc] = await Promise.all([t.get(agendamentoRef), t.get(clienteRef), t.get(barbeiroRef)]);
            if (!agendamentoDoc.exists || agendamentoDoc.data().status !== 'imediato') throw "Solicita√ß√£o j√° processada ou n√£o encontrada.";
            if (!clienteDoc.exists) throw "Cliente n√£o encontrado.";
            if ((clienteDoc.data().saldo || 0) < valor) throw "Saldo do cliente insuficiente.";
            if (!barbeiroDoc.exists || barbeiroDoc.data().vagaImediata === false) throw "Vaga imediata n√£o est√° mais ativa ou profissional n√£o encontrado.";

            t.update(clienteRef, { saldo: firebase.firestore.FieldValue.increment(-valor) });
            t.update(barbeiroRef, { saldo: firebase.firestore.FieldValue.increment(valorComTaxa), vagaImediata: false });
            t.update(agendamentoRef, { status: "conclus√£o pendente", confirmadoEm: firebase.firestore.FieldValue.serverTimestamp() });
            const adminSnap = await db.collection("usuarios").where("tipo", "==", "admin").limit(1).get();
            if(!adminSnap.empty) t.update(db.collection("usuarios").doc(adminSnap.docs[0].id), { saldo: firebase.firestore.FieldValue.increment(valorAdmin) });
            t.set(db.collection("config").doc("financeiro"), { arrecadadoTaxas: firebase.firestore.FieldValue.increment(valorAdmin) }, { merge: true });
        });
        fecharTodosOsModais();
        criarAviso(clienteUid, `‚úÖ Sua vaga imediata foi aprovada por ${perfil.nome}!`, 'vaga-aprovada', agendamentoId);
        notifyUser(clienteUid, "‚úÖ Agendamento Confirmado!", `Sua vaga imediata com ${perfil.nome} foi aprovada. Corra para o local!`);
        exibirInfoPopup("Sucesso", "Agendamento aprovado!");
    } catch(e) {
        fecharTodosOsModais();
        exibirInfoPopup("Erro", "Erro ao aprovar: " + (e.message || e));
    }
}

async function aprovarAgendamento(agendamentoId, clienteUid, valor, horario = null) {
  if (!confirm("Aprovar este agendamento?")) return;
  exibirAguarde("Aprovando agendamento...");

  let taxaAplicada = TAXA_PADRAO;
  if (perfil && isProAtivo(perfil) && perfil.proTier && PRECOS_PRO[perfil.proTier]) {
      taxaAplicada = PRECOS_PRO[perfil.proTier].taxa;
  }
  const valorComTaxa = valor * (1 - taxaAplicada);
  const valorAdmin = valor * taxaAplicada;

  try {
      await db.runTransaction(async t => {
          const agendamentoRef = db.collection("agendamentos").doc(agendamentoId);
          const clienteRef = db.collection("usuarios").doc(clienteUid);
          const barbeiroRef = db.collection("usuarios").doc(auth.currentUser.uid);
          const [agendamentoDoc, clienteDoc, barbeiroDoc] = await Promise.all([t.get(agendamentoRef), t.get(clienteRef), t.get(barbeiroRef)]);
          if (!agendamentoDoc.exists || agendamentoDoc.data().status !== 'pendente') throw "Solicita√ß√£o j√° processada ou n√£o encontrada.";
          if (!clienteDoc.exists) throw "Cliente n√£o encontrado.";
          if (!barbeiroDoc.exists) throw "Profissional n√£o encontrado.";
          if ((clienteDoc.data().saldo || 0) < valor) throw "Saldo do cliente insuficiente.";

          t.update(clienteRef, { saldo: firebase.firestore.FieldValue.increment(-valor) });
          t.update(barbeiroRef, { saldo: firebase.firestore.FieldValue.increment(valorComTaxa) });
          t.update(agendamentoRef, { status: "conclus√£o pendente", confirmadoEm: firebase.firestore.FieldValue.serverTimestamp() });

          // Atualiza agenda manual se necess√°rio
          const barbeiroData = barbeiroDoc.data();
          if (barbeiroData.usaAgendaManual && horario && horario !== 'null') {
              const agendaAtualizada = { ...barbeiroData.agenda };
              // Marca o hor√°rio como bloqueado em vez de deletar
              agendaAtualizada[horario] = 'bloqueado';
              t.update(barbeiroRef, { agenda: agendaAtualizada });
          }
          const adminSnap = await db.collection("usuarios").where("tipo", "==", "admin").limit(1).get();
          if(!adminSnap.empty) t.update(db.collection("usuarios").doc(adminSnap.docs[0].id), { saldo: firebase.firestore.FieldValue.increment(valorAdmin) });
          t.set(db.collection("config").doc("financeiro"), { arrecadadoTaxas: firebase.firestore.FieldValue.increment(valorAdmin) }, { merge: true });
      });
      fecharTodosOsModais();
      criarAviso(clienteUid, `‚úÖ Seu agendamento foi aprovado pelo profissional ${perfil.nome}!`);
      notifyUser(clienteUid, "‚úÖ Agendamento Confirmado!", `Seu hor√°rio com ${perfil.nome}${horario ? ` para as ${horario}`:''} foi confirmado.`);
      exibirInfoPopup("Sucesso", "Agendamento aprovado!");
  } catch(e) {
      fecharTodosOsModais();
      exibirInfoPopup("Erro", "Erro ao aprovar: " + (e.message || e));
  }
}

function recusarAgendamento(agendamentoId, clienteUid) {
  if (!confirm("Recusar este agendamento?")) return;
  db.runTransaction(async t => {
      const agendamentoRef = db.collection("agendamentos").doc(agendamentoId);
      const agendamentoDoc = await t.get(agendamentoRef);
      if(!agendamentoDoc.exists) throw "Agendamento n√£o encontrado.";
      const status = agendamentoDoc.data().status;
      if (status !== 'pendente' && status !== 'imediato') throw "Solicita√ß√£o j√° processada.";
      t.update(agendamentoRef, { status: "cancelado" });
  }).then(() => {
      criarAviso(clienteUid, `‚ùå O profissional ${perfil.nome} recusou seu agendamento.`);
      notifyUser(clienteUid, "‚ùå Agendamento Recusado", `O profissional ${perfil.nome} n√£o p√¥de aceitar seu pedido.`);
      exibirInfoPopup("Sucesso", "Agendamento recusado.");
  }).catch(e => exibirInfoPopup("Erro", "Erro ao recusar: " + (e.message || e)));
}

async function cancelarAgendamentoManualmente(agendamentoId, clienteUid, valor) {
  if (!confirm("Cancelar este agendamento? O dinheiro ser√° reembolsado e sua reputa√ß√£o ser√° afetada.")) return;
  exibirAguarde("Cancelando...");

  let taxaAplicadaEstornoManual = TAXA_PADRAO;
  if (perfil && isProAtivo(perfil) && perfil.proTier && PRECOS_PRO[perfil.proTier]) {
      taxaAplicadaEstornoManual = PRECOS_PRO[perfil.proTier].taxa;
  }
  const valorComTaxaEstorno = valor * (1 - taxaAplicadaEstornoManual);
  const valorAdminEstornoManual = valor * taxaAplicadaEstornoManual;

  try {
      await db.runTransaction(async t => {
          const agendamentoRef = db.collection("agendamentos").doc(agendamentoId);
          const agendamentoDoc = await t.get(agendamentoRef);
          if(!agendamentoDoc.exists) throw "Agendamento n√£o encontrado.";
          const agData = agendamentoDoc.data();
          const status = agData.status;
          if (status !== 'confirmado' && status !== 'conclus√£o pendente') throw "Apenas agendamentos aprovados podem ser cancelados.";

          const clienteRef = db.collection("usuarios").doc(clienteUid);
          const barbeiroRef = db.collection("usuarios").doc(auth.currentUser.uid);
          t.update(clienteRef, { saldo: firebase.firestore.FieldValue.increment(valor) });
          t.update(barbeiroRef, { saldo: firebase.firestore.FieldValue.increment(-valorComTaxaEstorno), reputacao: firebase.firestore.FieldValue.increment(-10) });
          t.update(agendamentoRef, { status: "cancelado" });

          // Reabre o hor√°rio na agenda manual se foi cancelado ANTES de concluir
          if (perfil.usaAgendaManual && agData.horario && agData.horario !== 'null') {
              const agendaRecuperada = { ...perfil.agenda };
              agendaRecuperada[agData.horario] = true; // Marca como dispon√≠vel novamente
              t.update(barbeiroRef, { agenda: agendaRecuperada });
          }

          const adminSnap = await db.collection("usuarios").where("tipo", "==", "admin").limit(1).get();
          if (!adminSnap.empty) t.update(db.collection("usuarios").doc(adminSnap.docs[0].id), { saldo: firebase.firestore.FieldValue.increment(-valorAdminEstornoManual) });
          t.set(db.collection("config").doc("financeiro"), { arrecadadoTaxas: firebase.firestore.FieldValue.increment(-valorAdminEstornoManual) }, { merge: true });
      });
      fecharTodosOsModais();
      criarAviso(clienteUid, `‚ùå O profissional ${perfil.nome} cancelou seu agendamento. O valor de R$ ${valor.toFixed(2)} foi reembolsado.`);
      notifyUser(clienteUid, "üîÑ Agendamento Cancelado", `${perfil.nome} cancelou seu hor√°rio. O valor de R$ ${valor.toFixed(2)} foi estornado.`);
      exibirInfoPopup("Sucesso", "Agendamento cancelado e valor reembolsado. Sua reputa√ß√£o diminuiu.");
  } catch(e) {
      fecharTodosOsModais();
      exibirInfoPopup("Erro", "Erro ao cancelar: " + (e.message || e));
  }
}

async function concluirAgendamento(agendamentoId, clienteUid) {
  exibirAguarde("Concluindo servi√ßo...");
  try {
    const agendamentoRef = db.collection("agendamentos").doc(agendamentoId);
    const barbeiroRef = db.collection("usuarios").doc(auth.currentUser.uid);
    const clienteRef = db.collection("usuarios").doc(clienteUid);

    await db.runTransaction(async t => {
        const agendamentoDoc = await t.get(agendamentoRef);
        if (!agendamentoDoc.exists || agendamentoDoc.data().status !== "conclus√£o pendente") throw "Este agendamento n√£o est√° pendente de conclus√£o.";
        t.update(barbeiroRef, { cortesSemana: firebase.firestore.FieldValue.increment(1), clientesAtendidos: firebase.firestore.FieldValue.increment(1) });
        t.update(agendamentoRef, { status: "concluido" });
        t.update(clienteRef, { cortesRealizados: firebase.firestore.FieldValue.increment(1) });
    });

    await verificarConquistas(clienteUid);
    await verificarConquistasBarbeiro(auth.currentUser.uid);

    fecharTodosOsModais();
    exibirInfoPopup("Sucesso", "Servi√ßo conclu√≠do!");
    criarAviso(clienteUid, `Agendamento conclu√≠do! Voc√™ j√° pode avaliar o servi√ßo de ${perfil.nome}.`);
    notifyUser(clienteUid, "‚≠ê Avalie sua Experi√™ncia!", `O servi√ßo com ${perfil.nome} foi conclu√≠do. Deixe sua avalia√ß√£o!`, { link: '#historico' });

    const clienteDoc = await clienteRef.get();
    const clienteData = clienteDoc.data();
    if (clienteData.bonusIndicacaoPendente && clienteData.cortesRealizados === 1) {
        await clienteRef.update({ pontosFidelidade: firebase.firestore.FieldValue.increment(BONUS_INDICACAO), bonusIndicacaoPendente: false });
        notifyUser(clienteUid, "üèÜ B√¥nus de Indica√ß√£o!", `Voc√™ ganhou ${BONUS_INDICACAO} pontos de fidelidade pelo seu primeiro agendamento!`);
        if (clienteData.indicadoPorEmail) {
            const query = await db.collection("usuarios").where("email", "==", clienteData.indicadoPorEmail).limit(1).get();
            if (!query.empty) {
                const indicadorDoc = query.docs[0];
                await indicadorDoc.ref.update({ pontosFidelidade: firebase.firestore.FieldValue.increment(BONUS_INDICACAO) });
                notifyUser(indicadorDoc.id, "üèÜ B√¥nus por Indicar!", `Voc√™ ganhou ${BONUS_INDICACAO} pontos porque ${clienteData.nome} finalizou o primeiro servi√ßo!`);
            }
        }
    }
  } catch(e) {
    fecharTodosOsModais();
    exibirInfoPopup("Erro", "Erro ao concluir servi√ßo: " + (e.message || e));
  }
}

async function abrirClientesBarbeiro() {
  abrirModal('modalClientesBarbeiro');
  const lista = document.getElementById("listaClientesBarbeiro");
  if (!lista) return;
  lista.innerHTML = "<p>‚è≥ Carregando...</p>";

  try {
      const agendamentosSnap = await db.collection("agendamentos")
        .where("barbeiroUid", "==", auth.currentUser.uid)
        .where("status", "==", "concluido")
        .get();

      const clientesMap = {};
      agendamentosSnap.forEach(doc => {
        const ag = doc.data();
        if (!clientesMap[ag.clienteUid]) {
          clientesMap[ag.clienteUid] = {
              nome: ag.clienteNome,
              totalCortes: 0,
              telefone: ag.clienteTelefone,
              uid: ag.clienteUid
          };
        }
        clientesMap[ag.clienteUid].totalCortes++;
      });

      const notasSnap = await db.collection("profissionais_notas_clientes").doc(auth.currentUser.uid).get();
      const notasData = notasSnap.exists ? notasSnap.data().notas : {};

      lista.innerHTML = Object.keys(clientesMap).length === 0 ? "<p>Voc√™ ainda n√£o tem clientes.</p>" : "";

      Object.values(clientesMap).sort((a, b) => b.totalCortes - a.totalCortes).forEach(c => {
        const notaAtual = notasData[c.uid] || "";
        const telefoneLimpoCliente = c.telefone ? c.telefone.replace(/\D/g,'') : '';
        const whatsappLinkCliente = telefoneLimpoCliente ? `<a href="https://wa.me/55${telefoneLimpoCliente}" target="_blank" onclick="event.stopPropagation()"><button style="font-size:12px; padding: 5px 8px; margin-top:5px;">üí¨ WhatsApp</button></a>` : '';

        lista.innerHTML += `
            <div class="card">
                <b>${c.nome}</b>
                <p>Servi√ßos conclu√≠dos: ${c.totalCortes}</p>
                ${whatsappLinkCliente}
                <textarea id="nota_${c.uid}" placeholder="Adicione notas sobre este cliente..." style="margin-top: 10px; width: 100%; min-height: 50px;">${notaAtual}</textarea>
                <button onclick="salvarNotaCliente('${c.uid}')" style="font-size:12px; padding: 5px 8px; margin-top:5px;">Salvar Nota</button>
            </div>`;
      });
  } catch (error) {
      console.error("Erro ao carregar clientes:", error);
      lista.innerHTML = "<p>Erro ao carregar clientes.</p>";
  }
}

async function salvarNotaCliente(clienteUid) {
    const notaInput = document.getElementById(`nota_${clienteUid}`);
    const nota = notaInput?.value || ""; // Pega vazio se n√£o encontrar
    const ref = db.collection("profissionais_notas_clientes").doc(auth.currentUser.uid);
    try {
        await ref.set({
            notas: {
                [clienteUid]: nota
            }
        }, { merge: true });
        exibirInfoPopup("Sucesso", "Nota salva com sucesso!");
    } catch (e) {
        console.error("Erro ao salvar nota:", e);
        exibirInfoPopup("Erro", "N√£o foi poss√≠vel salvar a nota.");
    }
}

function abrirHistoricoBarbeiro() {
  abrirModal('modalHistoricoBarbeiro');
  const painel = document.getElementById("painelHistoricoBarbeiro");
  if (!painel) return;
  painel.innerHTML = "<p>‚è≥ Carregando...</p>";
  db.collection("agendamentos").where("barbeiroUid", "==", auth.currentUser.uid)
    .where("status", "in", ["concluido", "cancelado"]).orderBy("ts", "desc").limit(20)
    .onSnapshot(snap => {
      if (snap.empty) {
          painel.innerHTML = "<p>Nenhum servi√ßo no hist√≥rico encontrado.</p>";
          return;
      }
      painel.innerHTML = "";
      snap.forEach(doc => {
        const a = doc.data();
        const dataFormatada = a.ts ? new Date(a.ts.seconds * 1000).toLocaleDateString('pt-BR') : 'Data indispon√≠vel';
        const statusIcon = a.status === "concluido" ? "‚úÖ" : "‚ùå";
        const statusTexto = a.status === "concluido" ? "Conclu√≠do" : "Cancelado";
        painel.innerHTML += `<div class="card" style="margin-bottom: 10px;">
          <p><strong>${statusIcon} Cliente:</strong> ${a.clienteNome}</p>
          <p><strong>‚úÇÔ∏è Servi√ßo:</strong> ${a.servico} - R$ ${a.valor.toFixed(2)}</p>
          <p><strong>üóìÔ∏è Data:</strong> ${dataFormatada}</p>
          <p><strong>Status:</strong> ${statusTexto}</p>
        </div>`;
      });
    }, err => {
        console.error("Erro ao carregar hist√≥rico do barbeiro:", err);
        painel.innerHTML = "<p>Erro ao carregar hist√≥rico.</p>";
    });
}

function abrirPromocoes() {
    abrirModal('modalPromocoesBarbeiro');
    carregarPromocoesAtivas();
}

function carregarPromocoesAtivas() {
    const container = document.getElementById('listaPromocoes');
    if (!container) return;
    container.innerHTML = '';
    const promocoes = perfil?.promocoes || [];
    if (promocoes.length > 0) {
        promocoes.forEach((promo, index) => {
            const validadeStr = promo.validade ? `V√°lida at√©: ${new Date(promo.validade.seconds * 1000).toLocaleDateString('pt-BR')}` : 'Sem data de expira√ß√£o';
            const servicosAfetados = promo.servicosAplicaveis ? promo.servicosAplicaveis.join(', ') : 'Todos os servi√ßos selecionados';
            container.innerHTML += `
                <div class="card">
                    <b>${promo.nome} (${promo.desconto}%)</b>
                    <p style="font-size:14px;">${promo.descricao}</p>
                    <p style="font-size:12px; opacity: 0.7;">Aplica-se a: ${servicosAfetados}</p>
                    <p style="font-size:12px; opacity: 0.7;">${validadeStr}</p>
                    <button onclick="removerPromocao(${index})" style="background:#c0392b; float:right; padding: 5px 8px;">üóëÔ∏è</button>
                </div>`;
        });
    } else {
        container.innerHTML = '<p>Nenhuma promo√ß√£o ativa no momento.</p>';
    }
}

function removerPromocao(index) {
  if (!perfil || !perfil.promocoes || index < 0 || index >= perfil.promocoes.length) return;
  const p = perfil.promocoes[index];
  if (!confirm(`Remover a promo√ß√£o "${p.nome}"?`)) return;
  db.collection("usuarios").doc(auth.currentUser.uid).update({
    promocoes: firebase.firestore.FieldValue.arrayRemove(p)
  }).then(() => {
      exibirInfoPopup("Sucesso", "Promo√ß√£o removida!");
      // Atualiza a lista visualmente sem recarregar o perfil inteiro
      carregarPromocoesAtivas();
  }).catch(e => exibirInfoPopup("Erro", "Erro: " + e.message));
}

function abrirModalAddPromocao() {
    const selectServicos = document.getElementById('addPromocaoServicos');
    if (!selectServicos) return;
    selectServicos.innerHTML = '';

    if (perfil?.listaServicos && perfil.listaServicos.length > 0) {
        perfil.listaServicos.forEach(servico => {
            const option = document.createElement('option');
            option.value = servico.nome;
            option.textContent = `${servico.nome} - R$ ${servico.valor.toFixed(2)}`;
            selectServicos.appendChild(option);
        });
    } else {
        selectServicos.innerHTML = '<option disabled>Cadastre servi√ßos primeiro</option>';
    }

    document.getElementById('addPromocaoNome').value = '';
    document.getElementById('addPromocaoDescricao').value = '';
    document.getElementById('addPromocaoDesconto').value = '';
    document.getElementById('addPromocaoValidade').value = '';
    document.getElementById('addPromocaoValorMinimo').value = '';

    abrirModal('modalAddPromocao');
}

async function salvarNovaPromocao() {
    const nome = document.getElementById('addPromocaoNome')?.value.trim();
    const descricao = document.getElementById('addPromocaoDescricao')?.value.trim();
    const desconto = parseInt(document.getElementById('addPromocaoDesconto')?.value);
    const validadeInput = document.getElementById('addPromocaoValidade')?.value;
    const valorMinimo = parseFloat(document.getElementById('addPromocaoValorMinimo')?.value) || 0;
    const selectServicos = document.getElementById('addPromocaoServicos');
    const servicosSelecionados = selectServicos ? Array.from(selectServicos.selectedOptions).map(option => option.value) : [];

    if (!nome || !descricao || isNaN(desconto) || desconto <= 0 || desconto > 100) {
        return exibirInfoPopup("Erro", "Preencha nome, descri√ß√£o e um desconto v√°lido (1-100%).");
    }
    if (servicosSelecionados.length === 0) {
        return exibirInfoPopup("Erro", "Selecione pelo menos um servi√ßo para aplicar a promo√ß√£o.");
    }

    const novaPromocao = {
        id: `promo_${Date.now()}`,
        nome, descricao, desconto,
        servicosAplicaveis: servicosSelecionados,
        valorMinimo: valorMinimo,
        validade: validadeInput ? firebase.firestore.Timestamp.fromDate(new Date(validadeInput + 'T23:59:59')) : null
    };

    try {
        await db.collection("usuarios").doc(auth.currentUser.uid).update({
            promocoes: firebase.firestore.FieldValue.arrayUnion(novaPromocao)
        });
        exibirInfoPopup("Sucesso", "Promo√ß√£o salva com sucesso!");
        fecharModalAtual();
        // Atualiza o perfil local para refletir a nova promo√ß√£o imediatamente
        if(!perfil.promocoes) perfil.promocoes = [];
        perfil.promocoes.push(novaPromocao);
        carregarPromocoesAtivas();

    } catch (e) {
        exibirInfoPopup("Erro", "Erro ao salvar promo√ß√£o: " + e.message);
    }
}

function abrirAvaliacoesBarbeiro() {
  abrirModal('modalAvaliacoes');
  const lista = document.getElementById("listaAvaliacoesModal");
  if (!lista) return;
  lista.innerHTML = "<p>‚è≥ Carregando...</p>";
  db.collection("avaliacoes").where("barbeiroUid", "==", auth.currentUser.uid)
    .orderBy("ts", "desc").onSnapshot(async snap => {
      lista.innerHTML = snap.empty ? "<p>Nenhuma avalia√ß√£o recebida.</p>" : "";
      for (const doc of snap.docs) {
        const a = doc.data();
        let clienteNome = "Cliente";
        if (a.clienteUid) {
          try {
              const clienteDoc = await db.collection("usuarios").doc(a.clienteUid).get();
              if (clienteDoc.exists) clienteNome = clienteDoc.data().nome;
          } catch(e){ console.warn("Erro ao buscar nome do cliente:", e); }
        }
        lista.innerHTML += `<div class="card" style="margin-bottom:15px;"><p style="margin-bottom:5px;"><b>De:</b> ${clienteNome}</p><b>Nota: ${a.nota}/10</b> (${'‚≠ê'.repeat(Math.round(a.nota / 2))})<br><p style="margin-top:5px;"><b>Coment√°rio:</b> "${a.comentario || 'Sem coment√°rio'}"</p></div>`;
      }
    }, err => {
        console.error("Erro ao carregar avalia√ß√µes:", err);
        lista.innerHTML = "<p>Erro ao carregar avalia√ß√µes.</p>";
    });
}
// C√≥digo restante (conquistas, ranking, dashboard, etc.) e fechamento das tags script e body/html
</script>
<script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('/firebase-messaging-sw.js').then(function(reg) {
          console.log('‚úÖ Service Worker registrado:', reg.scope);
          reg.addEventListener('updatefound', () => {
            newWorker = reg.installing;
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                 const modal = document.getElementById('modalAtualizacao');
                 const btn = document.getElementById('btnAtualizarApp');
                 if(modal && btn) {
                     btn.onclick = () => {
                       newWorker.postMessage({ type: 'SKIP_WAITING' });
                     };
                     abrirModal('modalAtualizacao');
                 }
              }
            });
          });
        }).catch(function(err) {
          console.error('‚ùå Falha ao registrar SW:', err);
        });

        let refreshing;
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          if (refreshing) return;
          window.location.reload();
          refreshing = true;
        });
      });
    }

    const loginFields = [document.getElementById('email'), document.getElementById('senha')];
    loginFields.forEach(field => {
        if(field) {
            field.addEventListener('keyup', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    const entrarButton = Array.from(document.querySelectorAll('#authView button')).find(btn => btn.textContent.includes('Entrar'));
                    if (entrarButton) {
                        entrarButton.click();
                    }
                }
            });
        }
    });

</script>
</body>
</html>
