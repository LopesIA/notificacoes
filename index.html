<!DOCTYPE html>
<html>
<head>
  <link rel="manifest" href="/manifest.json">
  <meta charset="UTF-8">
  <title>宙 Navalha de Ouro</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<link rel="manifest" href="/manifest.json">
  <meta charset="UTF-8">
  
  <link rel="icon" href="/icone.png" type="image/png">
  <link rel="apple-touch-icon" href="/icone.png">
  <title>宙 Navalha de Ouro</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --cor-fundo: #0c0c0c;
      --cor-card: #181818;
      --cor-botoes: #222222;
      --cor-texto-principal: #e0e0e0;
      --cor-destaque-ouro: #d4af37; /* Dourado */
      --cor-destaque-prata: #c0c0c0; /* Prateado */
      --cor-destaque-azul: #007BFF; /* Azul */
      --cor-sombra: #000000;
      --cor-borda: #333;
    }
    body.tema-claro {
      --cor-fundo: #f0f0f0;
      --cor-card: #ffffff;
      --cor-botoes: #e0e0e0;
      --cor-texto-principal: #333;
      --cor-destaque-ouro: #d4af37;
      --cor-destaque-prata: #808080;
      --cor-destaque-azul: #0056b3;
      --cor-sombra: #b0b0b0;
      --cor-borda: #ccc;
    }
    body {
      margin: 0;
      background: var(--cor-fundo);
      color: var(--cor-texto-principal);
      font-family: 'Poppins', sans-serif;
      min-height: 10vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: background-color 0.3s;
    }
    .content-container {
      width: 100%;
      max-width: 500px;
      padding-top: 60px;
      padding-bottom: 80px; /* Espaﾃｧo para os botﾃｵes do rodapﾃｩ */
      box-sizing: border-box;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative; /* Adicionado para posicionamento do chat preview */
    }
    input, select, button, textarea {
      width: 100%;
      margin: 8px 0;
      padding: 14px;
      background: var(--cor-botoes);
      color: var(--cor-texto-principal);
      border: 1px solid var(--cor-borda);
      border-radius: 10px;
      font-size: 16px;
      transition: all 0.3s ease-in-out;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      box-sizing: border-box; /* CORREﾃﾃグ: Garante que padding nﾃ｣o estoure a div */
    }
    button {
      cursor: pointer;
      font-weight: 600;
    }
    button:hover {
      background: var(--cor-destaque-ouro);
      color: var(--cor-fundo);
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(212, 175, 55, 0.4);
    }
    button:disabled {
        cursor: not-allowed;
        background: #444;
        opacity: 0.6;
    }
    .card {
      background: var(--cor-card);
      padding: 24px;
      margin: 12px;
      border-radius: 16px;
      box-shadow: 0 6px 15px var(--cor-sombra);
      width: 90%;
      max-width: 480px;
      box-sizing: border-box;
      animation: fadeIn 0.5s ease-in-out;
      position: relative;
      overflow: hidden;
    }
    .hidden {
      display: none;
    }
    .topbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: var(--cor-card);
      color: var(--cor-texto-principal);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 16px;
      box-shadow: 0 2px 4px #000;
      font-size: 18px;
      z-index: 10;
      border-bottom: 2px solid var(--cor-borda);
    }
    .logo {
      font-weight: 600;
      color: var(--cor-destaque-ouro);
      font-size: 18px;
      text-shadow: 0 0 5px var(--cor-destaque-ouro);
      transition: color 0.3s;
    }
    .topbar-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 20;
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
    }
    .modal.show {
      display: flex;
      opacity: 1;
    }
    .modal-content {
      background: var(--cor-card);
      padding: 30px;
      border-radius: 20px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.8);
      transform: scale(0.9);
      transition: transform 0.3s ease-in-out;
      border: 1px solid var(--cor-borda);
    }
    /* Estilo para o modal de ranking maior */
    #modalRankingUnificado .modal-content {
        max-width: 600px; /* Maior para caber as duas colunas */
    }
    .modal.show .modal-content {
      transform: scale(1);
    }
    .servico-btn {
      background: #333;
      margin: 6px 0;
      border: 1px solid #555;
      border-radius: 8px;
      padding: 12px;
      text-align: left;
    }
    .bottom-buttons-container {
      position: fixed;
      bottom: 12px;
      width: 90%;
      max-width: 480px;
      display: flex;
      justify-content: space-between;
      z-index: 15;
    }
    .redeem-container {
      position: fixed;
      bottom: 25px; /* Posiﾃｧﾃ｣o ajustada */
      width: 100%;
      max-width: 500px;
      text-align: center;
      z-index: 15;
      box-sizing: border-box;
    }
    .redeem-container button {
      width: 200px;
      font-size: 14px;
      padding: 10px;
      margin: 0;
    }
    #btnChat, #btnDenuncia {
      font-size: 26px;
      background: none;
      border: none;
      padding: 0;
      margin: 0;
      cursor: pointer;
      width: auto;
      height: auto;
      text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
      position: relative; /* Para o contador de notificaﾃｧﾃ｣o */
    }
    #btnSair {
      font-size: 20px; /* Reduzido */
      background: none;
      border: none;
      padding: 0;
      margin: 0;
      cursor: pointer;
      width: auto;
      height: auto;
      text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
      position: fixed;
      bottom: 72px; /* Posiﾃｧﾃ｣o alterada para ficar acima do botﾃ｣o de denﾃｺncia */
      left: 12px;
      z-index: 15;
    }
    #btnChat {
      position: fixed;
      bottom: 12px;
      right: 12px;
      z-index: 15;
    }
    #btnTema {
      font-size: 18px; /* Ajuste aqui */
      background: none;
      border: none;
      padding: 0;
      margin: 0;
      cursor: pointer;
      width: auto;
      height: auto;
      text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
    }
    #btnCarteiraTop {
      font-size: 16px;
      background: var(--cor-botoes);
      color: var(--cor-texto-principal);
      border-radius: 10px;
      padding: 8px 12px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }
    #botaoExtra {
      margin: 10px;
      text-align: center;
      width: 90%;
      max-width: 480px;
      box-sizing: border-box;
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    .vantagens ul {
      list-style-type: '笨';
      padding-left: 20px;
    }
    .vantagens li {
      background: transparent;
      margin-bottom: 10px;
      padding: 5px;
      border-radius: 0;
      border: none;
      box-shadow: none;
      padding-left: 10px;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes vip-glow {
      0% {
        box-shadow: 0 0 5px var(--cor-destaque-ouro), 0 0 10px var(--cor-destaque-ouro), 0 0 15px var(--cor-destaque-ouro);
      }
      50% {
        box-shadow: 0 0 10px var(--cor-destaque-ouro), 0 0 20px var(--cor-destaque-ouro), 0 0 30px var(--cor-destaque-ouro);
      }
      100% {
        box-shadow: 0 0 5px var(--cor-destaque-ouro), 0 0 10px var(--cor-destaque-ouro), 0 0 15px var(--cor-destaque-ouro);
      }
    }
     @keyframes vaga-glow {
      0% { box-shadow: 0 0 8px #4CAF50, 0 0 12px #4CAF50; }
      50% { box-shadow: 0 0 16px #4CAF50, 0 0 24px #4CAF50; }
      100% { box-shadow: 0 0 8px #4CAF50, 0 0 12px #4CAF50; }
    }
    @keyframes gold-flash-background {
        0%, 100% { background-color: var(--cor-card); }
        50% { background-color: #2c250e; }
    }
    .boosted-card {
        border: 2px solid var(--cor-destaque-ouro);
        animation: gold-flash-background 3s ease-in-out infinite, fadeIn 0.5s;
    }
    .boost-icon {
        position: absolute;
        top: 8px;
        left: 8px;
        font-size: 20px;
        text-shadow: 0 0 8px var(--cor-destaque-ouro);
        animation: vip-glow 10s ease-in-out infinite;
    }
    /* NOVO: Animaﾃｧﾃ｣o para notificaﾃｧﾃ｣o de chat */
    @keyframes gold-flash {
      0%, 100% { background-color: transparent; transform: scale(1); }
      50% { background-color: rgba(212, 175, 55, 0.8); transform: scale(1.2); }
    }
    /* NOVO: Animaﾃｧﾃ｣o de luz pulsante dourada */
    @keyframes gold-pulse {
      0% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.7); }
      70% { box-shadow: 0 0 10px 15px rgba(212, 175, 55, 0); }
      100% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0); }
    }
    .notificacao-pulsante {
        animation: gold-pulse 1.5s infinite;
    }
    .new-message-glow {
        animation: gold-flash 1.5s ease-in-out infinite;
        border-radius: 50%;
    }
    /* NOVO: Contador de notificaﾃｧﾃ｣o */
    .notification-badge {
        position: absolute;
        top: -5px;
        right: -8px;
        background-color: #e74c3c;
        color: white;
        border-radius: 50%;
        padding: 2px 6px;
        font-size: 10px;
        font-weight: bold;
        border: 2px solid var(--cor-fundo);
    }
    .vip-glow {
      animation: vip-glow 2s ease-in-out infinite;
      border: 2px solid var(--cor-destaque-ouro);
    }
    .promocao-card {
      background: linear-gradient(45deg, #181818, var(--cor-destaque-ouro));
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 10px;
      color: #fff;
    }
    .chat-container {
      height: 100%;
      flex-grow: 1; /* Faz o container crescer */
      overflow-y: auto;
      border: 1px solid var(--cor-borda);
      padding: 10px;
      border-radius: 10px;
      background: #0d0d0d;
      margin-bottom: 10px;
      display: flex;
      flex-direction: column-reverse; 
    }
    .chat-message {
      padding: 8px 12px;
      margin-bottom: 8px;
      border-radius: 12px;
      animation: fadeIn 0.3s ease-in-out;
      transition: opacity 1.5s ease-out; /* Transiﾃｧﾃ｣o para o fade out */
    }
    .chat-message.fading-out {
        opacity: 0;
    }
    .chat-sent {
      text-align: right;
      background: #333;
      margin-left: 20%;
    }
    .chat-received {
      text-align: left;
      background: #555;
      margin-right: 20%;
    }
    .scrollable-list {
      max-height: 400px;
      overflow-y: auto;
    }
    .aviso-item {
      text-align: left;
      margin-bottom: 8px;
      border-bottom: 1px solid var(--cor-borda);
      padding-bottom: 8px;
      opacity: 0.8;
      transition: opacity 0.3s ease-in-out;
    }
    .horario-btn {
        background: #222;
        color: #fff;
        border: 1px solid #555;
        border-radius: 5px;
        padding: 8px;
        margin: 5px;
        width: 100px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .horario-btn.selecionado {
        background: var(--cor-destaque-ouro);
        color: var(--cor-fundo);
        border-color: var(--cor-destaque-ouro);
    }
    .horario-btn.bloqueado {
        background: #772014;
        color: #fff;
        border-color: #772014;
        text-decoration: line-through;
    }
    .horarios-actions {
        display: flex;
        justify-content: space-between;
        margin-top: 10px;
        gap: 10px;
    }
    .horarios-list {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 10px;
    }
    .horario-disponivel {
      background: var(--cor-botoes);
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 14px;
      color: var(--cor-texto-principal);
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .horario-disponivel:hover {
      background: var(--cor-destaque-ouro);
    }
    .admin-chat-red {
      color: red;
      font-weight: bold;
      text-shadow: 0 0 5px #000, 0 0 8px #000;
    }
    .barbeiro-chat {
        color: var(--cor-texto-principal);
        text-shadow: 0 0 8px var(--cor-destaque-azul);
    }
    .cliente-chat {
        color: var(--cor-texto-principal);
        text-shadow: 0 0 8px var(--cor-destaque-prata);
    }
    .show-password-container {
        position: relative;
        display: flex;
        align-items: center;
        width: 100%;
    }
    .show-password-container input {
        padding-right: 40px;
    }
    .show-password-toggle {
        position: absolute;
        right: 15px;
        cursor: pointer;
        color: var(--cor-destaque-prata);
    }
    .barbeiro-card {
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        cursor: pointer;
    }
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        border-bottom: 1px solid var(--cor-borda);
        padding-bottom: 10px;
    }
    .card-header-info h4 {
        margin: 0;
        font-size: 1.1em;
        color: var(--cor-destaque-ouro);
    }
    .card-header-info p {
        margin: 4px 0 0;
        font-size: 0.8em;
        opacity: 0.8;
    }
    .card-reputacao {
        font-size: 0.9em;
        text-align: right;
    }
    .card-status {
        padding: 10px;
        border-radius: 8px;
        text-align: center;
        font-weight: 600;
    }
    .status-imediato {
        background-color: #4CAF50;
        color: white;
        animation: vaga-glow 1.5s ease-in-out infinite;
    }
    .status-manual {
        background-color: var(--cor-botoes);
    }
    .status-indisponivel {
        background-color: #555;
        opacity: 0.7;
    }
    .card-horarios-disponiveis {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
        margin-top: 8px;
    }
    .card-horarios-disponiveis span {
        background: #333;
        padding: 4px 8px;
        border-radius: 5px;
        font-size: 0.85em;
    }
    .card-servicos-title {
        font-size: 0.9em;
        font-weight: 600;
        margin-top: 8px;
        border-top: 1px solid var(--cor-borda);
        padding-top: 10px;
    }
    .card-servicos-list {
        font-size: 0.8em;
        opacity: 0.9;
        list-style-type: none;
        padding: 0;
        margin: 0;
    }
    .popup-section {
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--cor-borda);
    }
    .popup-section h4 {
        margin-top: 0;
        margin-bottom: 10px;
        color: var(--cor-destaque-ouro);
    }
    .selectable-item {
        background: var(--cor-botoes);
        border: 1px solid var(--cor-borda);
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
    }
    .selectable-item:hover {
        border-color: var(--cor-destaque-ouro);
    }
    .selectable-item.selected {
        background: var(--cor-destaque-ouro);
        color: var(--cor-fundo);
        border-color: var(--cor-destaque-ouro);
        font-weight: 600;
    }
    #barbeiroPerfilHorariosList {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        max-height: 150px;
        overflow-y: auto;
    }
    #barbeiroPerfilHorariosList .selectable-item {
        flex-grow: 1;
        text-align: center;
    }
    #modalBarbeiroPerfil .modal-footer {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid var(--cor-borda);
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }
    #chatPreview {
        position: absolute;
        top: -40px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(24, 24, 24, 0.8);
        color: var(--cor-texto-principal);
        padding: 5px 12px;
        border-radius: 10px;
        font-size: 12px;
        z-index: 5;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 90%;
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
        pointer-events: none;
    }
    #chatPreview.show {
        opacity: 1;
    }
    .conquista-item {
        display: flex;
        align-items: center;
        gap: 15px;
        background-color: var(--cor-botoes);
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 10px;
    }
    .conquista-item.unlocked {
        border-left: 5px solid var(--cor-destaque-ouro);
    }
    .conquista-item.locked {
        opacity: 0.5;
        border-left: 5px solid var(--cor-borda);
    }
    .conquista-icon {
        font-size: 2em;
    }
    .ranking-container {
        display: flex;
        gap: 20px;
        width: 100%;
    }
    .ranking-column {
        flex: 1;
        min-width: 0;
    }
    .ranking-column h4 {
        text-align: center;
        margin-bottom: 10px;
        color: var(--cor-destaque-ouro);
    }
    .ranking-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 5px;
        border-bottom: 1px solid var(--cor-borda);
        font-size: 14px;
    }
    .ranking-item:first-child {
        font-weight: bold;
        color: var(--cor-destaque-ouro);
    }
    .chat-medal {
        margin-right: 4px;
    }
    .app-footer {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        text-align: center;
        padding: 5px 0;
        font-size: 10px;
        color: var(--cor-texto-principal);
        opacity: 0.5;
        z-index: 5;
        pointer-events: none;
    }
    /* Estilos do Chat Fullscreen */
    #janelaChat.fullscreen {
        padding: 0;
        border-radius: 0;
    }
    #janelaChat.fullscreen .modal-content {
        width: 100%;
        height: 100%;
        max-width: 100%;
        border-radius: 0;
        display: flex;
        flex-direction: column;
    }
    #janelaChat.fullscreen #chatInput {
        margin-bottom: 0;
    }
    #janelaChat #carregarMaisMsgBtn {
        margin: 0;
        width: 100%;
        border-radius: 0;
        background-color: var(--cor-botoes);
    }
    /* Estilos do Portfﾃｳlio */
    .portfolio-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px;
      padding: 10px;
      max-height: 70vh;
      overflow-y: auto;
    }
    .portfolio-grid img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid var(--cor-borda);
    }
    #modalPortfolioCliente .modal-content, #lojaView .modal-content {
        width: 100%;
        height: 100%;
        max-width: 100%;
        border-radius: 0;
        display: flex;
        flex-direction: column;
    }
    /* Estilos da Loja */
    .loja-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        padding: 10px;
        flex-grow: 1;
        overflow-y: auto;
    }
    .produto-card {
        background: var(--cor-botoes);
        border-radius: 12px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        border: 1px solid var(--cor-borda);
        cursor: pointer;
    }
    .produto-card img {
        width: 100%;
        height: 150px;
        object-fit: cover;
    }
    .produto-info {
        padding: 10px;
        text-align: center;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    .produto-nome { font-weight: 600; font-size: 1em; }
    .produto-preco { font-size: 1.1em; color: var(--cor-destaque-ouro); margin-top: 5px; }
    .produto-preco-original { text-decoration: line-through; opacity: 0.7; font-size: 0.9em; }
    .produto-card button { font-size: 14px; padding: 8px; margin-top: 10px;}
    #lojaView .card-header { display: flex; justify-content: space-between; align-items: center; }
    #lojaView .card-header h3 { font-size: 1.1em; white-space: nowrap; }
    #lojaContainer h4 { font-size: 1.0em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .tamanho-options { display: flex; gap: 5px; justify-content: center; margin: 10px 0; }
    .tamanho-options label {
      padding: 5px 10px;
      border: 1px solid var(--cor-borda);
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    .tamanho-options input { display: none; }
    .tamanho-options input:checked + label {
      background: var(--cor-destaque-ouro);
      color: var(--cor-fundo);
      border-color: var(--cor-destaque-ouro);
    }
    .checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; }
    .checkbox-group label { display: flex; align-items: center; gap: 5px; }
    .checkbox-group input { width: auto; margin: 0; }

    .modal-venda {
      z-index: 99;
    }
    .modal-venda .modal-content {
      background: #c0392b;
      color: white;
      text-align: center;
      border: 3px solid #e74c3c;
      animation: flash-red 1.5s infinite;
    }
    .modal-venda h3 {
      color: white;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    @keyframes flash-red {
      0%, 100% { background-color: #c0392b; }
      50% { background-color: #e74c3c; }
    }
    
    /* NOVOS ESTILOS */
    .barbeiro-list-container {
      width: 100%;
      max-height: 70vh;
      overflow-y: auto;
      padding: 0 10px;
      box-sizing: border-box;
    }
    .promo-info {
      font-size: 0.8em;
      color: var(--cor-destaque-ouro);
      margin: 8px 0 0 0;
      padding-top: 8px;
      border-top: 1px dashed var(--cor-borda);
    }
    #pix-qrcode {
        max-width: 200px;
        margin: 15px auto;
        display: block;
        border: 5px solid white;
        border-radius: 10px;
    }
    .pix-copia-cola-container {
      position: relative;
    }
    .pix-copia-cola-container button {
        width: 100%;
    }
    #pixChaveAleatoria {
        display: none;
    }
    .metodos-grid {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-top: 20px;
    }
    #detalhesProdutoAvaliacao {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid var(--cor-borda);
    }
    .avaliacao-estrelas {
        font-size: 1.2em;
        color: var(--cor-destaque-ouro);
    }
    .avaliacao-comentario {
        font-style: italic;
        opacity: 0.8;
        margin-top: 5px;
        font-size: 0.9em;
        background: var(--cor-botoes);
        padding: 8px;
        border-radius: 8px;
    }

<link rel="manifest" href="/manifest.json">
  <meta charset="UTF-8">
  <title>宙 Navalha de Ouro</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<link rel="manifest" href="/manifest.json">
  <meta charset="UTF-8">
  
  <link rel="icon" href="/icone.png" type="image/png">
  <link rel="apple-touch-icon" href="/icone.png">
  <title>宙 Navalha de Ouro</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --cor-fundo: #0c0c0c;
      --cor-card: #181818;
      --cor-botoes: #222222;
      --cor-texto-principal: #e0e0e0;
      --cor-destaque-ouro: #d4af37; /* Dourado */
      --cor-destaque-prata: #c0c0c0; /* Prateado */
      --cor-destaque-azul: #007BFF; /* Azul */
      --cor-sombra: #000000;
      --cor-borda: #333;
    }
    body.tema-claro {
      --cor-fundo: #f0f0f0;
      --cor-card: #ffffff;
      --cor-botoes: #e0e0e0;
      --cor-texto-principal: #333;
      --cor-destaque-ouro: #d4af37;
      --cor-destaque-prata: #808080;
      --cor-destaque-azul: #0056b3;
      --cor-sombra: #b0b0b0;
      --cor-borda: #ccc;
    }
    body {
      margin: 0;
      background: var(--cor-fundo);
      color: var(--cor-texto-principal);
      font-family: 'Poppins', sans-serif;
      min-height: 10vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: background-color 0.3s;
    }
    .content-container {
      width: 100%;
      max-width: 500px;
      padding-top: 60px;
      padding-bottom: 80px; /* Espaﾃｧo para os botﾃｵes do rodapﾃｩ */
      box-sizing: border-box;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative; /* Adicionado para posicionamento do chat preview */
    }
    input, select, button, textarea {
      width: 100%;
      margin: 8px 0;
      padding: 14px;
      background: var(--cor-botoes);
      color: var(--cor-texto-principal);
      border: 1px solid var(--cor-borda);
      border-radius: 10px;
      font-size: 16px;
      transition: all 0.3s ease-in-out;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      box-sizing: border-box; /* CORREﾃﾃグ: Garante que padding nﾃ｣o estoure a div */
    }
    button {
      cursor: pointer;
      font-weight: 600;
    }
    button:hover {
      background: var(--cor-destaque-ouro);
      color: var(--cor-fundo);
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(212, 175, 55, 0.4);
    }
    button:disabled {
        cursor: not-allowed;
        background: #444;
        opacity: 0.6;
    }
    .card {
      background: var(--cor-card);
      padding: 24px;
      margin: 12px;
      border-radius: 16px;
      box-shadow: 0 6px 15px var(--cor-sombra);
      width: 90%;
      max-width: 480px;
      box-sizing: border-box;
      animation: fadeIn 0.5s ease-in-out;
      position: relative;
      overflow: hidden;
      transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
    }
    .hidden {
      display: none;
      opacity: 0;
      transform: scale(0.95);
    }
    .topbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: var(--cor-card);
      color: var(--cor-texto-principal);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 16px;
      box-shadow: 0 2px 4px #000;
      font-size: 18px;
      z-index: 10;
      border-bottom: 2px solid var(--cor-borda);
    }
    .logo {
      font-weight: 600;
      color: var(--cor-destaque-ouro);
      font-size: 18px;
      text-shadow: 0 0 5px var(--cor-destaque-ouro);
      transition: color 0.3s;
    }
    .topbar-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 20;
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
    }
    .modal.show {
      display: flex;
      opacity: 1;
    }
    .modal-content {
      background: var(--cor-card);
      padding: 30px;
      border-radius: 20px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.8);
      transform: scale(0.9);
      transition: transform 0.3s ease-in-out;
      border: 1px solid var(--cor-borda);
    }
    /* Estilo para o modal de ranking maior */
    #modalRankingUnificado .modal-content {
        max-width: 600px; /* Maior para caber as duas colunas */
    }
    .modal.show .modal-content {
      transform: scale(1);
    }
    .servico-btn {
      background: #333;
      margin: 6px 0;
      border: 1px solid #555;
      border-radius: 8px;
      padding: 12px;
      text-align: left;
    }
    .bottom-buttons-container {
      position: fixed;
      bottom: 12px;
      width: 90%;
      max-width: 480px;
      display: flex;
      justify-content: space-between;
      z-index: 15;
    }
    .redeem-container {
      position: fixed;
      bottom: 25px; /* Posiﾃｧﾃ｣o ajustada */
      width: 100%;
      max-width: 500px;
      text-align: center;
      z-index: 15;
      box-sizing: border-box;
    }
    .redeem-container button {
      width: 200px;
      font-size: 14px;
      padding: 10px;
      margin: 0;
    }
    #btnChat, #btnDenuncia {
      font-size: 26px;
      background: none;
      border: none;
      padding: 0;
      margin: 0;
      cursor: pointer;
      width: auto;
      height: auto;
      text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
      position: relative; /* Para o contador de notificaﾃｧﾃ｣o */
    }
    #btnSair {
      font-size: 20px; /* Reduzido */
      background: none;
      border: none;
      padding: 0;
      margin: 0;
      cursor: pointer;
      width: auto;
      height: auto;
      text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
      position: fixed;
      bottom: 72px; /* Posiﾃｧﾃ｣o alterada para ficar acima do botﾃ｣o de denﾃｺncia */
      left: 12px;
      z-index: 15;
    }
    #btnChat {
      position: fixed;
      bottom: 12px;
      right: 12px;
      z-index: 15;
    }
    #btnTema {
      font-size: 18px; /* Ajuste aqui */
      background: none;
      border: none;
      padding: 0;
      margin: 0;
      cursor: pointer;
      width: auto;
      height: auto;
      text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
    }
    #btnCarteiraTop {
      font-size: 16px;
      background: var(--cor-botoes);
      color: var(--cor-texto-principal);
      border-radius: 10px;
      padding: 8px 12px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }
    #botaoExtra {
      margin: 10px;
      text-align: center;
      width: 90%;
      max-width: 480px;
      box-sizing: border-box;
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    .vantagens ul {
      list-style-type: '笨';
      padding-left: 20px;
    }
    .vantagens li {
      background: transparent;
      margin-bottom: 10px;
      padding: 5px;
      border-radius: 0;
      border: none;
      box-shadow: none;
      padding-left: 10px;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes vip-glow {
      0% {
        box-shadow: 0 0 5px var(--cor-destaque-ouro), 0 0 10px var(--cor-destaque-ouro), 0 0 15px var(--cor-destaque-ouro);
      }
      50% {
        box-shadow: 0 0 10px var(--cor-destaque-ouro), 0 0 20px var(--cor-destaque-ouro), 0 0 30px var(--cor-destaque-ouro);
      }
      100% {
        box-shadow: 0 0 5px var(--cor-destaque-ouro), 0 0 10px var(--cor-destaque-ouro), 0 0 15px var(--cor-destaque-ouro);
      }
    }
     @keyframes vaga-glow {
      0% { box-shadow: 0 0 8px #4CAF50, 0 0 12px #4CAF50; }
      50% { box-shadow: 0 0 16px #4CAF50, 0 0 24px #4CAF50; }
      100% { box-shadow: 0 0 8px #4CAF50, 0 0 12px #4CAF50; }
    }
    @keyframes gold-flash-background {
        0%, 100% { background-color: var(--cor-card); }
        50% { background-color: #2c250e; }
    }
    .boosted-card {
        border: 2px solid var(--cor-destaque-ouro);
        animation: gold-flash-background 3s ease-in-out infinite, fadeIn 0.5s;
    }
    .boost-icon {
        position: absolute;
        top: 8px;
        left: 8px;
        font-size: 20px;
        text-shadow: 0 0 8px var(--cor-destaque-ouro);
        animation: vip-glow 10s ease-in-out infinite;
    }
    /* NOVO: Animaﾃｧﾃ｣o para notificaﾃｧﾃ｣o de chat */
    @keyframes gold-flash {
      0%, 100% { background-color: transparent; transform: scale(1); }
      50% { background-color: rgba(212, 175, 55, 0.8); transform: scale(1.2); }
    }
    /* NOVO: Animaﾃｧﾃ｣o de luz pulsante dourada */
    @keyframes gold-pulse-anim {
      0% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.7); }
      70% { box-shadow: 0 0 10px 15px rgba(212, 175, 55, 0); }
      100% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0); }
    }
    .notificacao-pulsante {
        animation: gold-pulse-anim 1.5s infinite;
    }
    /* ATUALIZAﾃﾃグ: Pulsaﾃｧﾃ｣o dourada para admin */
    .notificacao-pulsante-admin {
        position: relative;
        animation: gold-pulse-admin-anim 1.5s ease-in-out infinite;
        border-color: var(--cor-destaque-ouro) !important;
    }
    @keyframes gold-pulse-admin-anim {
      0% { box-shadow: 0 0 6px rgba(212,175,55,0.4); transform: scale(1); }
      50% { box-shadow: 0 0 18px rgba(212,175,55,0.8); transform: scale(1.03); }
      100% { box-shadow: 0 0 6px rgba(212,175,55,0.4); transform: scale(1); }
    }
    .new-message-glow {
        animation: gold-flash 1.5s ease-in-out infinite;
        border-radius: 50%;
    }
    /* NOVO: Contador de notificaﾃｧﾃ｣o */
    .notification-badge {
        position: absolute;
        top: -5px;
        right: -8px;
        background-color: #e74c3c;
        color: white;
        border-radius: 50%;
        padding: 2px 6px;
        font-size: 10px;
        font-weight: bold;
        border: 2px solid var(--cor-fundo);
    }
    /* ATUALIZAﾃﾃグ: Brilho do botﾃ｣o VIP agora ﾃｩ estﾃ｡tico */
    .vip-dourado {
        box-shadow: 0 0 10px rgba(212,175,55,0.7), inset 0 0 20px rgba(212,175,55,0.2);
        border: 1px solid var(--cor-destaque-ouro) !important;
        /* removida a animaﾃｧﾃ｣o de pulsaﾃｧﾃ｣o */
    }
    .promocao-card {
      background: linear-gradient(45deg, #181818, var(--cor-destaque-ouro));
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 10px;
      color: #fff;
    }
    .chat-container {
      height: 100%;
      flex-grow: 1; /* Faz o container crescer */
      overflow-y: auto;
      border: 1px solid var(--cor-borda);
      padding: 10px;
      border-radius: 10px;
      background: #0d0d0d;
      margin-bottom: 10px;
      display: flex;
      flex-direction: column-reverse; 
    }
    .chat-message {
      padding: 8px 12px;
      margin-bottom: 8px;
      border-radius: 12px;
      animation: fadeIn 0.3s ease-in-out;
      transition: opacity 1.5s ease-out; /* Transiﾃｧﾃ｣o para o fade out */
    }
    .chat-message.fading-out {
        opacity: 0;
    }
    .chat-sent {
      text-align: right;
      background: #333;
      margin-left: 20%;
    }
    .chat-received {
      text-align: left;
      background: #555;
      margin-right: 20%;
    }
    .scrollable-list {
      max-height: 400px;
      overflow-y: auto;
    }
    .aviso-item {
      text-align: left;
      margin-bottom: 8px;
      border-bottom: 1px solid var(--cor-borda);
      padding-bottom: 8px;
      opacity: 0.8;
      transition: opacity 0.3s ease-in-out;
    }
    .horario-btn {
        background: #222;
        color: #fff;
        border: 1px solid #555;
        border-radius: 5px;
        padding: 8px;
        margin: 5px;
        width: 100px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .horario-btn.selecionado {
        background: var(--cor-destaque-ouro);
        color: var(--cor-fundo);
        border-color: var(--cor-destaque-ouro);
    }
    .horario-btn.bloqueado {
        background: #772014;
        color: #fff;
        border-color: #772014;
        text-decoration: line-through;
    }
    .horarios-actions {
        display: flex;
        justify-content: space-between;
        margin-top: 10px;
        gap: 10px;
    }
    .horarios-list {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 10px;
    }
    .horario-disponivel {
      background: var(--cor-botoes);
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 14px;
      color: var(--cor-texto-principal);
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .horario-disponivel:hover {
      background: var(--cor-destaque-ouro);
    }
    .admin-chat-red {
      color: red;
      font-weight: bold;
      text-shadow: 0 0 5px #000, 0 0 8px #000;
    }
    .barbeiro-chat {
        color: var(--cor-texto-principal);
        text-shadow: 0 0 8px var(--cor-destaque-azul);
    }
    .cliente-chat {
        color: var(--cor-texto-principal);
        text-shadow: 0 0 8px var(--cor-destaque-prata);
    }
    .show-password-container {
        position: relative;
        display: flex;
        align-items: center;
        width: 100%;
    }
    .show-password-container input {
        padding-right: 40px;
    }
    .show-password-toggle {
        position: absolute;
        right: 15px;
        cursor: pointer;
        color: var(--cor-destaque-prata);
    }
    .barbeiro-card {
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        cursor: pointer;
    }
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        border-bottom: 1px solid var(--cor-borda);
        padding-bottom: 10px;
    }
    .card-header-info h4 {
        margin: 0;
        font-size: 1.1em;
        color: var(--cor-destaque-ouro);
    }
    .card-header-info p {
        margin: 4px 0 0;
        font-size: 0.8em;
        opacity: 0.8;
    }
    .card-reputacao {
        font-size: 0.9em;
        text-align: right;
    }
    .card-status {
        padding: 10px;
        border-radius: 8px;
        text-align: center;
        font-weight: 600;
    }
    .status-imediato {
        background-color: #4CAF50;
        color: white;
        animation: vaga-glow 1.5s ease-in-out infinite;
    }
    .status-manual {
        background-color: var(--cor-botoes);
    }
    .status-indisponivel {
        background-color: #555;
        opacity: 0.7;
    }
    .card-horarios-disponiveis {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
        margin-top: 8px;
    }
    .card-horarios-disponiveis span {
        background: #333;
        padding: 4px 8px;
        border-radius: 5px;
        font-size: 0.85em;
    }
    .card-servicos-title {
        font-size: 0.9em;
        font-weight: 600;
        margin-top: 8px;
        border-top: 1px solid var(--cor-borda);
        padding-top: 10px;
    }
    .card-servicos-list {
        font-size: 0.8em;
        opacity: 0.9;
        list-style-type: none;
        padding: 0;
        margin: 0;
    }
    .popup-section {
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--cor-borda);
    }
    .popup-section h4 {
        margin-top: 0;
        margin-bottom: 10px;
        color: var(--cor-destaque-ouro);
    }
    .selectable-item {
        background: var(--cor-botoes);
        border: 1px solid var(--cor-borda);
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
    }
    .selectable-item:hover {
        border-color: var(--cor-destaque-ouro);
    }
    .selectable-item.selected {
        background: var(--cor-destaque-ouro);
        color: var(--cor-fundo);
        border-color: var(--cor-destaque-ouro);
        font-weight: 600;
    }
    #barbeiroPerfilHorariosList {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        max-height: 150px;
        overflow-y: auto;
    }
    #barbeiroPerfilHorariosList .selectable-item {
        flex-grow: 1;
        text-align: center;
    }
    #modalBarbeiroPerfil .modal-footer {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid var(--cor-borda);
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }
    #chatPreview {
        position: absolute;
        top: -40px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(24, 24, 24, 0.8);
        color: var(--cor-texto-principal);
        padding: 5px 12px;
        border-radius: 10px;
        font-size: 12px;
        z-index: 5;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 90%;
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
        pointer-events: none;
    }
    #chatPreview.show {
        opacity: 1;
    }
    .conquista-item {
        display: flex;
        align-items: center;
        gap: 15px;
        background-color: var(--cor-botoes);
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 10px;
    }
    .conquista-item.unlocked {
        border-left: 5px solid var(--cor-destaque-ouro);
    }
    .conquista-item.locked {
        opacity: 0.5;
        border-left: 5px solid var(--cor-borda);
    }
    .conquista-icon {
        font-size: 2em;
    }
    .ranking-container {
        display: flex;
        gap: 20px;
        width: 100%;
    }
    .ranking-column {
        flex: 1;
        min-width: 0;
    }
    .ranking-column h4 {
        text-align: center;
        margin-bottom: 10px;
        color: var(--cor-destaque-ouro);
    }
    .ranking-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 5px;
        border-bottom: 1px solid var(--cor-borda);
        font-size: 14px;
    }
    .ranking-item:first-child {
        font-weight: bold;
        color: var(--cor-destaque-ouro);
    }
    .chat-medal {
        margin-right: 4px;
    }
    .app-footer {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        text-align: center;
        padding: 5px 0;
        font-size: 10px;
        color: var(--cor-texto-principal);
        opacity: 0.5;
        z-index: 5;
        pointer-events: none;
    }
    /* Estilos do Chat Fullscreen */
    #janelaChat.fullscreen {
        padding: 0;
        border-radius: 0;
    }
    #janelaChat.fullscreen .modal-content {
        width: 100%;
        height: 100%;
        max-width: 100%;
        border-radius: 0;
        display: flex;
        flex-direction: column;
    }
    #janelaChat.fullscreen #chatInput {
        margin-bottom: 0;
    }
    #janelaChat #carregarMaisMsgBtn {
        margin: 0;
        width: 100%;
        border-radius: 0;
        background-color: var(--cor-botoes);
    }
    /* Estilos do Portfﾃｳlio */
    .portfolio-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px;
      padding: 10px;
      max-height: 70vh;
      overflow-y: auto;
    }
    .portfolio-grid img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid var(--cor-borda);
    }
    #modalPortfolioCliente .modal-content, #lojaView .modal-content {
        width: 100%;
        height: 100%;
        max-width: 100%;
        border-radius: 0;
        display: flex;
        flex-direction: column;
    }
    /* Estilos da Loja */
    .loja-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        padding: 10px;
        flex-grow: 1;
        overflow-y: auto;
    }
    .produto-card {
        background: var(--cor-botoes);
        border-radius: 12px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        border: 1px solid var(--cor-borda);
        cursor: pointer;
    }
    .produto-card img {
        width: 100%;
        height: 150px;
        object-fit: cover;
    }
    .produto-info {
        padding: 10px;
        text-align: center;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    .produto-nome { font-weight: 600; font-size: 1em; }
    .produto-preco { font-size: 1.1em; color: var(--cor-destaque-ouro); margin-top: 5px; }
    .produto-preco-original { text-decoration: line-through; opacity: 0.7; font-size: 0.9em; }
    .produto-card button { font-size: 14px; padding: 8px; margin-top: 10px;}
    #lojaView .card-header { display: flex; justify-content: space-between; align-items: center; }
    #lojaView .card-header h3 { font-size: 1.1em; white-space: nowrap; }
    #lojaContainer h4 { font-size: 1.0em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .tamanho-options { display: flex; gap: 5px; justify-content: center; margin: 10px 0; }
    .tamanho-options label {
      padding: 5px 10px;
      border: 1px solid var(--cor-borda);
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    .tamanho-options input { display: none; }
    .tamanho-options input:checked + label {
      background: var(--cor-destaque-ouro);
      color: var(--cor-fundo);
      border-color: var(--cor-destaque-ouro);
    }
    .checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; }
    .checkbox-group label { display: flex; align-items: center; gap: 5px; }
    .checkbox-group input { width: auto; margin: 0; }

    .modal-venda {
      z-index: 99;
    }
    .modal-venda .modal-content {
      background: #c0392b;
      color: white;
      text-align: center;
      border: 3px solid #e74c3c;
      animation: flash-red 1.5s infinite;
    }
    .modal-venda h3 {
      color: white;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    @keyframes flash-red {
      0%, 100% { background-color: #c0392b; }
      50% { background-color: #e74c3c; }
    }
    
    /* NOVOS ESTILOS */
    .barbeiro-list-container {
      width: 100%;
      max-height: 70vh;
      overflow-y: auto;
      padding: 0 10px;
      box-sizing: border-box;
    }
    .promo-info {
      font-size: 0.8em;
      color: var(--cor-destaque-ouro);
      margin: 8px 0 0 0;
      padding-top: 8px;
      border-top: 1px dashed var(--cor-borda);
    }
    #pix-qrcode {
        max-width: 200px;
        margin: 15px auto;
        display: block;
        border: 5px solid white;
        border-radius: 10px;
    }
    .pix-copia-cola-container {
      position: relative;
    }
    .pix-copia-cola-container button {
        width: 100%;
    }
    #pixChaveAleatoria {
        display: none;
    }
    .metodos-grid {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-top: 20px;
    }
    #detalhesProdutoAvaliacao {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid var(--cor-borda);
    }
    .avaliacao-estrelas {
        font-size: 1.2em;
        color: var(--cor-destaque-ouro);
    }
    .avaliacao-comentario {
        font-style: italic;
        opacity: 0.8;
        margin-top: 5px;
        font-size: 0.9em;
        background: var(--cor-botoes);
        padding: 8px;
        border-radius: 8px;
    }
    /* ATUALIZAﾃﾃグ: Estilo da imagem do produto no popup */
    #detalhesProdutoImg {
      object-fit: contain !important; /* Garante que a imagem inteira apareﾃｧa */
      max-height: 250px;
      width: 100%;
    }

  </style>
</head>
<body>

   <div id="modalDadosDeposito" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <h3>Preencha seus Dados</h3>
      <p>Precisamos de algumas informaﾃｧﾃｵes para o depﾃｳsito.</p>
      <input id="depPrimeiroNome" type="text" placeholder="Primeiro Nome">
      <input id="depSegundoNome" type="text" placeholder="Segundo Nome">
      <input id="depCPF" type="text" placeholder="CPF">
      <input id="depTelefone" type="tel" placeholder="Telefone">
      <button id="btnContinuarDadosDeposito" disabled>Continuar</button>
      <button data-modal-id="modalDadosDeposito" onclick="fecharModal(event)">Cancelar</button>
    </div>
  </div>

  <!-- [NOVO] Modal para PIX expirado -->
  <div id="modalPixExpirado" class="modal" onclick="fecharModal(event)" style="z-index: 101;">
    <div class="modal-content" onclick="event.stopPropagation()">
      <h3>竢ｳ Tempo Expirado</h3>
      <p>O cﾃｳdigo PIX expirou. Por favor, gere um novo.</p>
      <button onclick="fecharModalAtual(); processarPagamentoPixAprimorado();">Tentar Novamente</button>
      <button data-modal-id="modalPixExpirado" onclick="fecharTodosOsPopups()">Fechar Tudo</button>
    </div>
  </div>

  <!-- [NOVO] Modal para taxa do cartﾃ｣o de crﾃｩdito -->
  <div id="modalTaxaCartao" class="modal" onclick="fecharModal(event)" style="z-index: 101;">
    <div class="modal-content" onclick="event.stopPropagation()">
      <h3>諜 Taxa da Plataforma</h3>
      <p>Transaﾃｧﾃｵes com cartﾃ｣o de crﾃｩdito incluem uma taxa administrativa para garantir a seguranﾃｧa e confiabilidade do pagamento. O valor ﾃｩ fixo.</p>
      <button id="btnContinuarPagamentoCartao">Continuar</button>
      <button data-modal-id="modalTaxaCartao" onclick="fecharModal(event)">Cancelar</button>
    </div>
  </div>
  
  <!-- [NOVO] Modal para formulﾃ｡rio de entrega da loja -->
  <div id="modalFormularioEntrega" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>逃 Endereﾃｧo de Entrega</h3>
        <p>Preencha os dados para o envio do seu produto.</p>
        <input id="compraNome" type="text" placeholder="Nome Completo">
        <input id="compraTelefone" type="tel" placeholder="Telefone (com DDD)">
        <input id="compraEmail" type="email" placeholder="E-mail">
        <input id="compraCep" type="text" placeholder="CEP">
        <input id="compraRua" type="text" placeholder="Nome da Rua">
        <input id="compraNumero" type="text" placeholder="Nﾃｺmero da Casa / Apto">
        <button id="btnIrParaPagamento">Ir para Pagamento</button>
        <button data-modal-id="modalFormularioEntrega" onclick="fecharModal(event)">Cancelar</button>
    </div>
  </div>
  
  <!-- [NOVO] Modal para confirmar dﾃｩbito da carteira -->
  <div id="modalConfirmarDebito" class="modal" onclick="fecharModal(event)" style="z-index: 102;">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3 id="textoConfirmarDebito">Confirmar Pagamento?</h3>
        <p>O valor serﾃ｡ debitado do seu saldo na carteira.</p>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
           <button id="btnConfirmarDebitoNao" style="background: #c0392b;">Nﾃ｣o</button>
           <button id="btnConfirmarDebitoSim" style="background: #27ae60;">Sim, Pagar</button>
        </div>
    </div>
  </div>

  <!-- ============================================= -->
  <!-- MODAIS EXISTENTES (com possﾃｭveis ajustes)     -->
  <!-- ============================================= -->
  
  <div id="modalGerenciarLoja" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" style="max-width: 600px;">
      <h3>宵 Gerenciar Minha Loja</h3>
      <div id="listaMeusProdutos" class="scrollable-list"></div>
      <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px;">
        <button onclick="abrirFormularioProduto()">筐 Adicionar Produto</button>
        <button id="btnEntregasVendedor" onclick="abrirEntregasVendedor()">囹 Entregas</button>
        <button data-modal-id="modalGerenciarLoja" onclick="fecharModal(event)">笶 Fechar</button>
      </div>
    </div>
  </div>

  <div id="modalAddEditProduto" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <h3 id="formProdutoTitulo">逃 Adicionar Novo Produto</h3>
      <input id="produtoImagemUrl" type="url" placeholder="迫 Link direto da imagem (.png, .jpg)">
      <input id="produtoNome" type="text" placeholder="Nome do Produto">
      <input id="produtoPreco" type="number" placeholder="Preﾃｧo (Ex: 49.90)">
      <p>Tamanhos disponﾃｭveis:</p>
      <div class="checkbox-group">
        <label><input type="checkbox" name="tamanhos" value="P"> P</label>
        <label><input type="checkbox" name="tamanhos" value="M"> M</label>
        <label><input type="checkbox" name="tamanhos" value="G"> G</label>
        <label><input type="checkbox" name="tamanhos" value="GG"> GG</label>
      </div>
      <input id="produtoDesconto" type="number" placeholder="Desconto em % (Opcional)">
      <input id="produtoEntrega" type="text" placeholder="Tempo de entrega (Ex: 3-5 dias)">
      <textarea id="produtoDescricao" placeholder="Descriﾃｧﾃ｣o curta do produto" rows="3"></textarea>
      <button id="btnSalvarProduto" onclick="salvarProdutoVendedor()">沈 Salvar Produto</button>
      <button data-modal-id="modalAddEditProduto" onclick="fecharModal(event)">笶 Cancelar</button>
    </div>
  </div>

  <div id="modalEntregasVendedor" class="modal" onclick="fecharModal(event)">
    <div class="modal-content">
      <h3>囹 Minhas Entregas</h3>
      <div id="listaEntregas" class="scrollable-list"></div>
      <button data-modal-id="modalEntregasVendedor" onclick="fecharModal(event)">笶 Fechar</button>
    </div>
  </div>

  <div id="modalMinhasCompras" class="modal" onclick="fecharModal(event)">
    <div class="modal-content">
      <h3>寫ｸ Minhas Compras</h3>
      <div id="listaMinhasCompras" class="scrollable-list"></div>
      <button data-modal-id="modalMinhasCompras" onclick="fecharModal(event)">笶 Fechar</button>
    </div>
  </div>

  <div id="modalVendaRealizada" class="modal modal-venda" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <h3>脂 VENDA REALIZADA! 脂</h3>
      <p style="font-size: 1.1em;">Parabﾃｩns, vocﾃｪ vendeu um produto!</p>
      <p>Acesse <strong>Gerenciar Loja > Entregas</strong> para ver os detalhes.</p>
      <button data-modal-id="modalVendaRealizada" onclick="fecharModal(event)" style="background: white; color: #c0392b;">笨 OK</button>
    </div>
  </div>

  <!-- [ATUALIZADO] Modal de confirmaﾃｧﾃ｣o do comprador nﾃ｣o pode ser fechado acidentalmente -->
  <div id="modalConfirmacaoComprador" class="modal">
    <div class="modal-content" onclick="event.stopPropagation()">
      <h3 id="confirmacaoCompradorTitulo">Confirmar Recebimento</h3>
      <p id="confirmacaoCompradorTexto">O vendedor marcou o produto como entregue. Vocﾃｪ confirma o recebimento?</p>
      <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button id="btnRecusarEntrega" style="background: #c0392b;">笶 Negar Recebimento</button>
        <button id="btnAceitarEntrega" style="background: #27ae60;">笨 Confirmar Entrega</button>
      </div>
    </div>
  </div>

<div class="topbar hidden" id="topbar">
  <div class="logo">宙 Navalha de Ouro</div>
  <div class="topbar-right">
    <button id="btnTema" onclick="alternarTema()">嫌</button>
    <button id="btnCarteiraTop" class="hidden" onclick="abrirModal('modalCarteira')">腸 R$ <span id="saldoHeader">0,00</span></button>
  </div>
</div>

<div class="content-container">
  
  <div id="chatPreview"></div> <div id="botaoExtra" class="hidden"></div>

  <div id="authView" class="card hidden">
    <h2>柏 Entrar ou Criar Conta</h2>
    <input id="email" type="email" placeholder="透 Email">
    <input id="senha" type="password" placeholder="泊 Senha">
    <div id="cadastro-fields" class="hidden">
      <div class="show-password-container">
        <input id="senha-cadastro" type="password" placeholder="泊 Senha (visﾃｭvel)">
      </div>
      <div class="show-password-container">
        <input id="senha-confirm" type="password" placeholder="泊 Confirmar Senha (visﾃｭvel)">
      </div>
      <select id="tipo">
        <option value="cliente">刹 Cliente</option>
        <option value="barbeiro">宙 Barbeiro</option>
      </select>
      <input id="telefone" type="tel" placeholder="到 Telefone com DDD (ex: 27999999999)">
      <input id="rua" type="text" placeholder="Endereﾃｧo (Rua)" class="hidden">
      <input id="numero" type="text" placeholder="Endereﾃｧo (Nﾃｺmero)" class="hidden">
      <select id="estado" onchange="carregarCidades()">
        <option value="">月 Selecione seu estado</option>
      </select>
      <select id="cidade">
        <option value="">徐ｸ Selecione sua cidade</option>
      </select>
      <input id="indicador" type="text" placeholder="鐙 Email de quem te indicou? (opcional)">
      <button onclick="obterLocalizacaoCadastro()" id="btnLocalizacaoCadastro">桃 Usar minha localizaﾃｧﾃ｣o atual</button>
    </div>
    <button onclick="entrar()">筐｡ｸ Entrar</button>
    <button id="btnCriarConta" onclick="prepararCriarConta()"> Criar conta</button>
    <button id="btnVoltar" class="hidden" onclick="voltarParaLogin()">筮ｸ Voltar</button>
  </div>
  
  <div id="guestView" class="card">
    <h2>刹 Painel de Visitante</h2>
    <p style="text-align: center; font-size: 14px; opacity: 0.8;">Bem-vindo! Para interagir, crie uma conta ou faﾃｧa login.</p>
    <button onclick="toggleFuncoes('guestFuncoesContainer')">笞呻ｸ Funﾃｧﾃｵes do Visitante</button>
    <div id="guestFuncoesContainer" class="hidden">
        <div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:10px;">
          <button>糖 Histﾃｳrico</button>
          <button>虫 VIP</button>
          <button>腸 Carteira</button>
          <button>醇 Fidelidade</button>
          <button>堂 Blog</button>
          <button>遵 Conquistas</button>
          <button>投 Ranking</button>
          <button>寫ｸ Loja</button>
        </div>
    </div>
    <hr style="border-color: var(--cor-borda); margin: 20px 0;">
    <div id="listaBarbeirosPrincipalGuest" class="barbeiro-list-container"></div>
  </div>

  <div id="clienteView" class="hidden card">
    <h2>刹 Painel do Cliente</h2>
    <button onclick="toggleFuncoes('clienteFuncoesContainer')">笞呻ｸ Funﾃｧﾃｵes do Cliente</button>
    <div id="clienteFuncoesContainer" class="hidden">
        <div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:10px;">
          <button id="btnHistoricoCliente" onclick="abrirHistoricoCliente()" style="width:45%">糖 Histﾃｳrico</button>
          <button id="btnVip" onclick="abrirModalVip()" style="width:45%">虫 VIP</button>
          <button onclick="abrirModal('modalCarteira')" style="width:45%">腸 Carteira</button>
          <button onclick="abrirModal('modalFidelidade')" style="width:45%">醇 Fidelidade</button>
          <button onclick="carregarListaBlog(); abrirModal('modalBlog')" style="width:45%">堂 Blog</button>
          <button onclick="abrirModalConquistas()" style="width:45%">遵 Conquistas</button>
          <button onclick="abrirModalRankingUnificado()" style="width:45%">投 Ranking</button>
          <button id="btnGerenciarLojaCliente" onclick="abrirGerenciarLoja()" class="hidden" style="width:45%">宵 Minha Loja</button>
          <button id="btnMinhasCompras" onclick="abrirMinhasCompras()" style="width:45%">寫ｸ Minhas Compras</button>
        </div>
    </div>
    <hr style="border-color: var(--cor-borda); margin: 20px 0;">
    <div id="listaBarbeirosPrincipalCliente" class="barbeiro-list-container"></div>
  </div>

  <div id="barbeiroView" class="hidden card">
    <h2>宙 Painel do Barbeiro</h2>
    <button onclick="toggleFuncoes('barbeiroFuncoesContainer')">笞呻ｸ Funﾃｧﾃｵes do Barbeiro</button>
    <div id="barbeiroFuncoesContainer" class="hidden">
        <div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:10px;">
          <button onclick="abrirServicos()" style="width:45%">笨ゑｸ Serviﾃｧos</button>
          <button onclick="abrirAgenda()" style="width:45%">套 Agenda</button>
          <button id="btnAgendamentosBarbeiro" onclick="abrirAgendamentosBarbeiro()" style="width:45%">竢ｰ Agendamentos</button>
          <button onclick="abrirClientesBarbeiro()" style="width:45%">ｧ鯛昨洟昶昨洫 Clientes</button>
          <button onclick="abrirPromocoes()" style="width:45%">氏 Promoﾃｧﾃｵes</button>
          <button onclick="abrirModal('modalCarteira')" style="width:45%">腸 Carteira</button>
          <button onclick="abrirHistoricoBarbeiro()" style="width:45%">糖 Histﾃｳrico</button>
          <button id="btnAvaliacoesBarbeiro" onclick="abrirAvaliacoesBarbeiro()" style="width:45%">箝 Avaliaﾃｧﾃｵes</button>
          <button onclick="abrirModalPortfolioBarbeiro()" style="width:45%">名ｸ Portfﾃｳlio</button>
          <button onclick="abrirModal('modalAlterarNomeBarbeiro')" style="width:45%">笨擾ｸ Alterar Nome</button>
          <button onclick="abrirModal('modalAlterarEnderecoBarbeiro')" style="width:45%">桃 Alterar Endereﾃｧo</button>
          <button onclick="abrirModalDashboardBarbeiro()" style="width:45%">噫 Desempenho</button>
          <button onclick="abrirModalConquistasBarbeiro()" style="width:45%">遵 Conquistas</button>
          <button onclick="abrirModalRankingUnificado()" style="width:45%">投 Ranking</button>
          <button onclick="carregarListaBlog(); abrirModal('modalBlog')" style="width:45%">堂 Blog</button>
          <button id="btnGerenciarLojaBarbeiro" onclick="abrirGerenciarLoja()" class="hidden" style="width:45%">宵 Gerenciar Loja</button>
          <button onclick="abrirModalTurbinar()" style="width:92%; background: linear-gradient(45deg, var(--cor-destaque-ouro), #ffeb3b);">噫 Turbinar Perfil (R$ 9,99)</button>
        </div>
    </div>
     <hr style="border-color: var(--cor-borda); margin: 20px 0;">
    <div id="listaBarbeirosPrincipalBarbeiro" class="barbeiro-list-container"></div>
  </div>

  <div id="adminView" class="hidden card">
    <h2>ｧ Painel do Admin</h2>
    <div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center">
      <button onclick="abrirModalEstatisticas()" style="width:45%">投 Estatﾃｭsticas</button>
      <button onclick="abrirModalSolicitacoes()" style="width:45%">踏 Solicitaﾃｧﾃｵes</button>
      <button onclick="abrirModalUsuarios()" style="width:45%">則 Usuﾃ｡rios</button>
      <button onclick="abrirDenuncias()" style="width:45%">圷 Denﾃｺncias</button>
      <button onclick="abrirModal('modalCarteira')" style="width:45%">腸 Carteira</button>
      <button onclick="abrirGerenciarLoja()" style="width:45%">寫ｸ Gerenciar Loja</button>
      <button onclick="abrirModal('modalBlogAdmin')" style="width:45%">笨搾ｸ Publicar Blog</button>
      <button onclick="abrirModal('modalNotificacaoMarketing')" style="width:92%">謄 Enviar Notificaﾃｧﾃ｣o Geral</button>
    </div>
  </div>

  <div id="lojaView" class="hidden card">
    <div class="card-header">
        <h3>寫ｸ Loja Navalha de Ouro</h3>
        <div style="display: flex; gap: 10px;">
            <!-- O botﾃ｣o vender foi movido para o painel de funﾃｧﾃｵes para melhor UX -->
        </div>
    </div>
    <div id="lojaContainer" class="loja-grid">
    </div>
</div>


</div>

<div class="redeem-container hidden" id="redeemContainer">
  <button id="btnResgatar" onclick="abrirPortaSecreta()">笨ｨ Resgatar Cﾃｳdigo</button>
</div>

<div class="bottom-buttons-container hidden" id="bottomButtons">
  <button id="btnDenuncia" onclick="abrirModal('modalDenuncia')">圷</button>
  <button id="btnChat" onclick="abrirChatGlobal()">
    <span>町</span>
    <span class="notification-badge hidden">0</span>
  </button>
</div>

<!-- [ATUALIZADO] Botﾃ｣o de sair agora chama a funﾃｧﾃ｣o de logout com reload -->
<button id="btnSair" class="hidden" onclick="fazerLogout()">坎 Sair</button>

<!-- ============================================= -->
<!-- MODAIS DE FLUXO FINANCEIRO (NOVOS E REFINADOS) -->
<!-- ============================================= -->

<div id="modalCarteira" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>腸 Minha Carteira</h3>
    <p>Seu saldo atual ﾃｩ: <b style="color: var(--cor-destaque-ouro);">R$ <span id="saldoModal">0,00</span></b></p>
    <button onclick="iniciarDeposito()">踏 Depositar</button>
    <button onclick="iniciarSaque()">豆 Sacar</button>
    <button data-modal-id="modalCarteira" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalDeposito" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>腸 Depﾃｳsito de Crﾃｩditos</h3>
    <p>Escolha um mﾃｩtodo de pagamento para adicionar saldo ﾃ sua carteira.</p>
    <div class="metodos-grid">
        <button id="btnPagarComPix" onclick="processarPagamentoPixAprimorado()">笞｡ PIX (QR Code)</button>
        <button id="btnPagarComCartao" onclick="processarPagamentoCartaoAprimorado()">諜 Cartﾃ｣o de Crﾃｩdito</button>
    </div>
    <button data-modal-id="modalDeposito" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalGerandoQRCode" class="modal">
    <div class="modal-content" style="text-align: center;">
        <h3 style="color: var(--cor-destaque-ouro);">Gerando QR CODE</h3>
        <p>Aguarde um instante...</p>
    </div>
</div>

<div id="modalCarregandoGenerico" class="modal">
    <div class="modal-content" style="text-align: center;">
        <h3 id="carregandoGenericoTitulo" style="color: var(--cor-destaque-ouro);">Aguarde...</h3>
        <p id="carregandoGenericoTexto">Estamos processando sua solicitaﾃｧﾃ｣o.</p>
    </div>
</div>

<div id="modalExibirPixAprimorado" class="modal">
    <div class="modal-content" style="text-align: center;">
      <h3> Pague com PIX</h3>
      <p>Escaneie o QR Code abaixo com seu app de banco.</p>
      <!-- [ATUALIZADO] Imagem do QR Code agora ﾃｩ local -->
      <img src="qrcode.png.jpg" id="pix-qrcode" alt="QR Code PIX">
      <div class="pix-copia-cola-container">
          <textarea id="pixChaveAleatoria">00020126770014BR.GOV.BCB.PIX0136ec4a8f0f-ec59-44bc-afcf-dff364f971de0215NAVALHA DE OURO5204000053039865802BR5920Josiel Lopes Azeredo6009SAO PAULO62140510vuyKg7Qnmx63041C39</textarea>
          <button onclick="copiarCodigoPixAprimorado()">Copiar Chave Aleatﾃｳria PIX</button>
      </div>
      <p style="font-size: 14px; color: #ff9800; margin-top: 15px;">Este cﾃｳdigo expira em: <b id="pixTimer">10:00</b></p>
      <button onclick="confirmarEnvioComprovante()">CONFIRMAR</button>
    </div>
</div>

<div id="modalSaque" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>豆 Solicitar Saque</h3>
    <p>O valor serﾃ｡ transferido para sua chave PIX apﾃｳs aprovaﾃｧﾃ｣o do administrador.</p>
    <input id="saqueValor" type="number" placeholder="Valor do saque">
    <select id="saqueChavePixTipo">
      <option value="">Tipo de Chave PIX</option>
      <option value="cpf">CPF</option>
      <option value="email">E-mail</option>
      <option value="telefone">Telefone</option>
      <option value="aleatoria">Aleatﾃｳria</option>
    </select>
    <input id="saqueChavePix" type="text" placeholder="Sua chave PIX">
    <button id="btnConfirmarSaque" onclick="confirmarSaque()">笨 Confirmar Saque</button>
    <button data-modal-id="modalSaque" onclick="fecharModal(event)">笶 Cancelar</button>
  </div>
</div>

<div id="modalSaqueConfirmado" class="modal">
  <div class="modal-content" style="text-align:center;">
    <h3>笨 Solicitaﾃｧﾃ｣o Enviada!</h3>
    <p>Sua solicitaﾃｧﾃ｣o de saque foi enviada para anﾃ｡lise.</p>
    <p style="font-size:14px; opacity: 0.8;">Para agilizar, entre em contato com o administrador.</p>
    <button onclick="contatarAdminSaque()">OK</button>
  </div>
</div>

<!-- ============================================= -->
<!-- MODAIS GERAIS (EXISTENTES E NOVOS)            -->
<!-- ============================================= -->

<div id="janelaChat" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <button id="carregarMaisMsgBtn" onclick="carregarMensagensAnteriores()">Ver mensagens anteriores</button>
    <h3 id="chatTitle">町 Chat Global</h3>
    <div id="chatMessages" class="chat-container"></div>
    <input id="chatInput" placeholder="Digite sua mensagem">
    <button onclick="enviarMensagem()">筐｡ｸ Enviar</button>
    <button data-modal-id="janelaChat" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalDenuncia" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>圷 Denunciar</h3>
    <p>Envie sua mensagem e o administrador responderﾃ｡ em breve!</p>
    <textarea id="textoDenuncia" placeholder="Descreva o problema em detalhes"></textarea>
    <button onclick="enviarDenuncia()">筐｡ｸ Enviar</button>
    <button data-modal-id="modalDenuncia" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalDenunciaEnviada" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>笨 Denﾃｺncia Enviada!</h3>
    <p>Agradecemos a sua denﾃｺncia. Ela serﾃ｡ analisada pela nossa equipe.</p>
    <p>町 Se preferir, clique no botﾃ｣o abaixo para avisar o administrador diretamente no WhatsApp e agilizar o processo.</p>
    <a id="btnWhatsappDenuncia" href="#" target="_blank">
      <button>町 Avisar no WhatsApp</button>
    </a>
    <button data-modal-id="modalDenunciaEnviada" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalBlog" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>堂 Blog</h3>
    <div id="listaBlog" class="scrollable-list"></div>
    <button data-modal-id="modalBlog" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalVip" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div id="vipContentContainer">
    </div>
    <button data-modal-id="modalVip" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalFidelidade" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>醇 Programa de Fidelidade</h3>
    <p>Seus pontos: <b id="pontosFidelidade">0</b></p>
    <p style="font-size: 14px; color: var(--cor-destaque-prata);">Acumule pontos em cada agendamento e troque por descontos!</p>
    <button onclick="resgatarPontos()">氏 Resgatar 100 pontos por R$ 5,00</button>
    <button data-modal-id="modalFidelidade" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalBarbeiroPerfil" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div id="barbeiroPerfilHeader">
      <h3 id="barbeiroPerfilNome"></h3>
      <p>Endereﾃｧo: <span id="barbeiroPerfilEndereco"></span></p>
      <p>Reputaﾃｧﾃ｣o: <span id="barbeiroPerfilReputacao"></span></p>
    </div>

    <div id="barbeiroPerfilServicos" class="popup-section">
      <h4>1. Escolha um Serviﾃｧo</h4>
      <div id="barbeiroPerfilServicosList" class="scrollable-list" style="max-height: 150px;"></div>
    </div>

    <div id="barbeiroPerfilHorarios" class="popup-section">
      <h4>2. Escolha uma Opﾃｧﾃ｣o</h4>
      <div id="barbeiroPerfilHorariosList"></div>
    </div>

    <div class="modal-footer">
      <button id="btnAcessarPortfolio" class="hidden" style="width: auto; background-color: var(--cor-botoes);">名ｸ Ver Portfﾃｳlio</button>
      <button id="btnAbrirRota" class="hidden" style="width: auto; background-color: var(--cor-botoes);">亮ｸ Rota</button>
      <button id="btnConfirmarAgendamento" disabled>欄ｸ Agendar</button>
    </div>
    <button data-modal-id="modalBarbeiroPerfil" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalVagaImediataAprovada" class="modal" style="z-index: 99;" onclick="fecharModal(event)">
  <div class="modal-content" style="background: #e74c3c; color: white;" onclick="event.stopPropagation()">
    <h3 style="color:white;text-shadow: 2px 2px 4px #000;">笞ｸ VAGA IMEDIATA APROVADA!</h3>
    <p style="font-size: 1.2em; text-align: center;"><b>Vocﾃｪ tem 10 minutos para chegar ﾃ barbearia.</b></p>
    <p style="text-align: center;">Nﾃ｣o se atrase para nﾃ｣o perder a vaga e o seu dinheiro!</p>
    <div style="display:flex; gap: 10px; margin-top: 20px;">
      <button data-modal-id="modalVagaImediataAprovada" onclick="fecharModal(event)" style="background:white; color:#e74c3c; flex: 1;">笨 Entendi</button>
      <button id="btnCancelarVagaAprovada" style="background: #333; color: white; flex: 1;">笶 Cancelar Agendamento</button>
    </div>
  </div>
</div>

<div id="modalBarbeariasCliente" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>宙 Barbearias disponﾃｭveis</h3>
    <input type="text" id="filtroBarbeiro" onkeyup="filtrarBarbeiros()" placeholder="博 Buscar por barbeiro ou cidade...">
    <div id='listaBarbeiros' class="scrollable-list"></div>
    <button data-modal-id="modalBarbeariasCliente" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalHistoricoCliente" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>糖 Meu Histﾃｳrico</h3>
    <div id="painelHistorico" class="scrollable-list"></div>
    <button data-modal-id="modalHistoricoCliente" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalConquistas" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>遵 Minhas Conquistas</h3>
    <div id="listaConquistas" class="scrollable-list"></div>
    <button data-modal-id="modalConquistas" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalRankingUnificado" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>醇 Ranking Geral 醇</h3>
    <p style="font-size: 12px; opacity: 0.7; text-align:center;">Top 100 com mais serviﾃｧos concluﾃｭdos.</p>
    <div class="ranking-container">
      <div class="ranking-column">
        <h4>宙 Barbeiros</h4>
        <div id="listaRankingBarbeirosUnificado" class="scrollable-list"></div>
      </div>
      <div class="ranking-column">
        <h4>刹 Clientes</h4>
        <div id="listaRankingClientesUnificado" class="scrollable-list"></div>
      </div>
    </div>
    <button data-modal-id="modalRankingUnificado" onclick="fecharModal(event)" style="margin-top: 20px;">笶 Fechar</button>
  </div>
</div>


<div id="modalCriarPromocao" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>氏 Criar Promoﾃｧﾃ｣o</h3>
    <input id="promocaoNome" placeholder="Nome da Promoﾃｧﾃ｣o">
    <input id="promocaoDescricao" placeholder="Descriﾃｧﾃ｣o curta">
    <input type="number" id="promocaoDesconto" placeholder="Desconto em % (ex: 15)">
    <button onclick="criarPromocao()">沈 Salvar Promoﾃｧﾃ｣o</button>
    <button data-modal-id="modalCriarPromocao" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalAlterarNomeBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>笨擾ｸ Alterar Nome</h3>
    <input id="novoNomeBarbeiro" type="text" placeholder="Novo nome do barbeiro/barbearia">
    <button onclick="alterarNomeBarbeiro(event)">沈 Salvar</button>
    <button data-modal-id="modalAlterarNomeBarbeiro" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalAlterarEnderecoBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>桃 Alterar Endereﾃｧo</h3>
    <input id="novoEnderecoRua" type="text" placeholder="Nova Rua">
    <input id="novoEnderecoNumero" type="text" placeholder="Novo Nﾃｺmero">
    <button onclick="obterLocalizacaoCadastro('barbeiro')">桃 Usar minha localizaﾃｧﾃ｣o atual</button>
    <button onclick="alterarEnderecoBarbeiro(event)">沈 Salvar</button>
    <button data-modal-id="modalAlterarEnderecoBarbeiro" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalAvaliacoes" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>箝 Minhas Avaliaﾃｧﾃｵes</h3>
        <div id="listaAvaliacoesModal" class="scrollable-list"></div>
        <button data-modal-id="modalAvaliacoes" onclick="fecharModal(event)">笶 Fechar</button>
    </div>
</div>

<div id="modalServicosBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>笨ゑｸ Meus Serviﾃｧos</h3>
    <div id="listaServicosBarbeiro" class="scrollable-list"></div>
    <button onclick="adicionarServico()">筐 Adicionar novo serviﾃｧo</button>
    <button data-modal-id="modalServicosBarbeiro" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalAgendaBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>套 Minha Agenda</h3>
    <p>Use os botﾃｵes abaixo para gerenciar sua disponibilidade e horﾃ｡rios.</p>
    <button id="btnDisponibilidade" onclick="toggleDisponibilidade()"></button>
    <button id="btnVagaImediata" onclick="toggleVagaImediata()"></button>
    <button id="btnAgendaManual" onclick="toggleAgendaManual()"></button>
    <div id="agendaManualPainel" class="hidden card">
        <h4>Horﾃ｡rios Disponﾃｭveis Hoje</h4>
        <p>Selecione os horﾃ｡rios para trabalhar ou clique duas vezes para bloquear.</p>
        <div id="horariosContainer" style="display:flex; flex-wrap:wrap; gap:5px; justify-content: center;"></div>
        <div class="horarios-actions">
            <button onclick="salvarAgendaManual()">沈 Salvar</button>
            <button data-modal-id="modalAgendaBarbeiro" onclick="fecharModal(event)">坎 Fechar</button>
        </div>
    </div>
    <button data-modal-id="modalAgendaBarbeiro" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalAgendamentosBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>竢ｰ Meus Agendamentos</h3>
    <div id="agendamentosPainel" class="scrollable-list"></div>
    <button data-modal-id="modalAgendamentosBarbeiro" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalClientesBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>ｧ鯛昨洟昶昨洫 Meus Clientes</h3>
    <p>Lista de clientes que jﾃ｡ agendaram com vocﾃｪ.</p>
    <div id="listaClientesBarbeiro" class="scrollable-list"></div>
    <button data-modal-id="modalClientesBarbeiro" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalDashboardBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>噫 Meu Desempenho</h3>
    <div id="dashboardConteudo">
      <p>Carregando dados...</p>
    </div>
    <button data-modal-id="modalDashboardBarbeiro" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalHistoricoBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>糖 Histﾃｳrico de Serviﾃｧos</h3>
    <div id="painelHistoricoBarbeiro" class="scrollable-list"></div>
    <button data-modal-id="modalHistoricoBarbeiro" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalConquistasBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>遵 Minhas Conquistas de Barbeiro</h3>
    <div id="listaConquistasBarbeiro" class="scrollable-list"></div>
    <button data-modal-id="modalConquistasBarbeiro" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalBlogAdmin" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>笨搾ｸ Novo Post</h3>
    <input id="blogTitulo" placeholder="Tﾃｭtulo">
    <textarea id="blogConteudo" placeholder="Conteﾃｺdo do post"></textarea>
    <button onclick="publicarBlog()">笨搾ｸ Publicar</button>
    <button data-modal-id="modalBlogAdmin" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalEstatisticas" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>投 Estatﾃｭsticas</h3>
    <div id="estatisticasPainel" class="scrollable-list"></div>
    <button data-modal-id="modalEstatisticas" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalSolicitacoes" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>踏 Todas as Solicitaﾃｧﾃｵes</h3>
    <div id="listaSolicitacoes" class="scrollable-list"></div>
    <button data-modal-id="modalSolicitacoes" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalUsuarios" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>則 Todos os Usuﾃ｡rios</h3>
    <div id="usuariosPainel" class="scrollable-list"></div>
    <button data-modal-id="modalUsuarios" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalDenunciasAdmin" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>圷 Denﾃｺncias</h3>
    <div id="listaDenuncias" class="scrollable-list"></div>
    <button data-modal-id="modalDenunciasAdmin" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalNotificacaoMarketing" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>謄 Notificaﾃｧﾃ｣o para Todos</h3>
    <p>Esta mensagem serﾃ｡ enviada como uma notificaﾃｧﾃ｣o push para todos os usuﾃ｡rios do app.</p>
    <input id="marketingTitulo" placeholder="Tﾃｭtulo da Notificaﾃｧﾃ｣o">
    <textarea id="marketingCorpo" placeholder="Corpo da mensagem"></textarea>
    <button onclick="enviarNotificacaoMarketing()">噫 Enviar para todos</button>
    <button data-modal-id="modalNotificacaoMarketing" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalPortfolioBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>名ｸ Gerenciar Portfﾃｳlio</h3>
    <p style="font-size: 12px; opacity: 0.8;">Cole os links das suas imagens. Use serviﾃｧos como <a href="https://postimages.org/" target="_blank">Postimages</a> para hospedar suas fotos gratuitamente. Mﾃ｡ximo de 10 imagens.</p>
    <div id="portfolioInputsContainer" class="scrollable-list" style="max-height: 250px;"></div>
    <button onclick="salvarPortfolio()">沈 Salvar Portfﾃｳlio</button>
    <button data-modal-id="modalPortfolioBarbeiro" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalPortfolioCliente" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3 id="portfolioClienteNome">名ｸ Portfﾃｳlio</h3>
    <div id="portfolioClienteGrid" class="portfolio-grid"></div>
    <button data-modal-id="modalPortfolioCliente" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalLiberarLoja" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>寫ｸ Acesso ﾃ Loja de Vendedores</h3>
        <p>Vocﾃｪ ainda nﾃ｣o tem permissﾃ｣o pra cadastrar produtos na loja. Peﾃｧa autorizaﾃｧﾃ｣o pro administrador no WhatsApp.</p>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button data-modal-id="modalLiberarLoja" onclick="fecharModal(event)" style="background-color: #555;">竊ｩｸ Cancelar</button>
            <button onclick="solicitarLiberacaoLoja()" style="flex-grow: 1;">
                町 Pedir no WhatsApp
            </button>
        </div>
    </div>
</div>

<div id="modalTurbinar" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>噫 Turbinar seu Perfil</h3>
        <p>Destaque seu perfil no topo da lista de barbearias por <strong>24 horas</strong> e alcance mais clientes!</p>
        <p style="font-size: 22px; color: var(--cor-destaque-ouro); font-weight: bold; text-align: center;">Apenas R$ 9,99</p>
        <button onclick="confirmarTurbinar()">徴 Confirmar e Turbinar</button>
        <button data-modal-id="modalTurbinar" onclick="fecharModal(event)">笶 Cancelar</button>
    </div>
</div>

<div id="modalPermissaoNotificacao" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>粕 Fique por Dentro!</h3>
        <p>Ative as notificaﾃｧﾃｵes para receber alertas importantes sobre seus agendamentos, promoﾃｧﾃｵes e novidades em tempo real.</p>
        <button onclick="pedirPermissaoEFechar()">総 Ativar Notificaﾃｧﾃｵes</button>
        <button data-modal-id="modalPermissaoNotificacao" onclick="fecharModal(event)">笶 Agora nﾃ｣o</button>
    </div>
</div>

<div id="modalInstalarApp" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>導 Leve o App com Vocﾃｪ!</h3>
        <p>Instale nosso aplicativo na sua tela inicial para um acesso mais rﾃ｡pido e uma melhor experiﾃｪncia.</p>
        <button id="btnInstalarPWA">憧 Instalar Agora</button>
        <button data-modal-id="modalInstalarApp" onclick="fecharModal(event)">､ Depois</button>
    </div>
</div>

<div id="modalAtualizacao" class="modal" style="z-index: 100;" onclick="fecharModal(event)">
    <div class="modal-content" style="border: 2px solid var(--cor-destaque-ouro);" onclick="event.stopPropagation()">
        <h3>噫 Nova Versﾃ｣o Disponﾃｭvel!</h3>
        <p>Uma nova versﾃ｣o do aplicativo estﾃ｡ pronta. Clique no botﾃ｣o abaixo para atualizar e ter acesso ﾃs ﾃｺltimas novidades e melhorias.</p>
        <div style="display:flex; gap: 10px; margin-top: 20px;">
           <button data-modal-id="modalAtualizacao" onclick="fecharModal(event)" style="background: #555;">､ Depois</button>
           <button id="btnAtualizarApp" style="flex-grow: 1;">売 Atualize Agora</button>
        </div>
    </div>
</div>

<div id="modalPromocoesBarbeiro" class="modal">
  <div class="modal-content">
    <h2>氏 Promoﾃｧﾃｵes Ativas</h2>
    <div id="listaPromocoes">
      </div>
    <div class="modal-botoes">
      <button onclick="abrirModalAddPromocao()">筐 Adicionar Promoﾃｧﾃ｣o</button>
      <button data-modal-id="modalPromocoesBarbeiro" onclick="fecharModal(event)">笶 Fechar</button>
    </div>
  </div>
</div>

<div id="modalAddPromocao" class="modal">
  <div class="modal-content">
    <h2>筐 Adicionar Nova Promoﾃｧﾃ｣o</h2>
    <input type="text" id="addPromocaoNome" placeholder="Nome da Promoﾃｧﾃ｣o" required>
    <textarea id="addPromocaoDescricao" placeholder="Descriﾃｧﾃ｣o" required></textarea>
    <input type="number" id="addPromocaoDesconto" placeholder="Desconto (%)" required>
    <button onclick="salvarNovaPromocao()">沈 Salvar Promoﾃｧﾃ｣o</button>
    <button data-modal-id="modalAddPromocao" onclick="fecharModal(event)">笶 Cancelar</button>
  </div>
</div>
	
<div id="modalLoja" class="modal">
  <div class="modal-content">
    <h3>將 Produtos da Loja</h3>
    <div id="listaProdutos" class="loja-grid"></div>
    <button data-modal-id="modalLoja" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<!-- [ATUALIZADO] Modal de detalhes do produto para novo fluxo -->
<div id="modalProdutoDetalhes" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <img id="detalhesProdutoImg" src="" alt="Imagem do Produto" style="width: 100%; border-radius: 10px; margin-bottom: 15px;">
        <h3 id="detalhesProdutoNome" style="margin: 0; color: var(--cor-destaque-ouro);"></h3>
        <p style="margin-top: 15px;"><strong>Tamanho:</strong></p>
        <div id="detalhesProdutoTamanhos" class="tamanho-options"></div>
        <p><strong>Preﾃｧo:</strong> <span id="detalhesProdutoPreco" style="font-weight: bold; font-size: 1.2em;"></span></p>
        <p><strong>Descriﾃｧﾃ｣o:</strong> <span id="detalhesProdutoDescricao"></span></p>
        <p><strong>Entrega estimada:</strong> <span id="detalhesProdutoEntrega"></span></p>
        
        <div id="detalhesProdutoAvaliacao"></div>

        <button id="btnComprarAgora">將 Continuar</button>
        <button data-modal-id="modalProdutoDetalhes" onclick="fecharModal(event)">笶 Fechar</button>
    </div>
</div>

<!-- [REMOVIDO E SUBSTITUﾃ好O] O modal 'modalConfirmarCompra' foi substituﾃｭdo pelo novo fluxo -->


  <!-- Modais existentes da loja, agendamentos, etc... -->
  <div id="modalGerenciarLoja" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" style="max-width: 600px;">
      <h3>宵 Gerenciar Minha Loja</h3>
      <div id="listaMeusProdutos" class="scrollable-list"></div>
      <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px;">
        <button onclick="abrirFormularioProduto()">筐 Adicionar Produto</button>
        <button id="btnEntregasVendedor" onclick="abrirEntregasVendedor()">囹 Entregas</button>
        <button data-modal-id="modalGerenciarLoja" onclick="fecharModal(event)">笶 Fechar</button>
      </div>
    </div>
  </div>

  <!-- Modal de adicionar/editar produto -->
  <div id="modalAddEditProduto" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <h3 id="formProdutoTitulo">逃 Adicionar Novo Produto</h3>
      <input id="produtoImagemUrl" type="url" placeholder="迫 Link direto da imagem (.png, .jpg)">
      <input id="produtoNome" type="text" placeholder="Nome do Produto">
      <input id="produtoPreco" type="number" placeholder="Preﾃｧo (Ex: 49.90)">
      <p>Tamanhos disponﾃｭveis:</p>
      <div class="checkbox-group">
        <label><input type="checkbox" name="tamanhos" value="P"> P</label>
        <label><input type="checkbox" name="tamanhos" value="M"> M</label>
        <label><input type="checkbox" name="tamanhos" value="G"> G</label>
        <label><input type="checkbox" name="tamanhos" value="GG"> GG</label>
      </div>
      <input id="produtoDesconto" type="number" placeholder="Desconto em % (Opcional)">
      <input id="produtoEntrega" type="text" placeholder="Tempo de entrega (Ex: 3-5 dias)">
      <textarea id="produtoDescricao" placeholder="Descriﾃｧﾃ｣o curta do produto" rows="3"></textarea>
      <button id="btnSalvarProduto" onclick="salvarProdutoVendedor()">沈 Salvar Produto</button>
      <button data-modal-id="modalAddEditProduto" onclick="fecharModal(event)">笶 Cancelar</button>
    </div>
  </div>

  <!-- Modal de entregas -->
  <div id="modalEntregasVendedor" class="modal" onclick="fecharModal(event)">
    <div class="modal-content">
      <h3>囹 Minhas Entregas</h3>
      <div id="listaEntregas" class="scrollable-list"></div>
      <button data-modal-id="modalEntregasVendedor" onclick="fecharModal(event)">笶 Fechar</button>
    </div>
  </div>

  <!-- Modal de compras -->
  <div id="modalMinhasCompras" class="modal" onclick="fecharModal(event)">
    <div class="modal-content">
      <h3>寫ｸ Minhas Compras</h3>
      <div id="listaMinhasCompras" class="scrollable-list"></div>
      <button data-modal-id="modalMinhasCompras" onclick="fecharModal(event)">笶 Fechar</button>
    </div>
  </div>

  <!-- Modal de venda realizada -->
  <div id="modalVendaRealizada" class="modal modal-venda" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <h3>脂 VENDA REALIZADA! 脂</h3>
      <p style="font-size: 1.1em;">Parabﾃｩns, vocﾃｪ vendeu um produto!</p>
      <p>Acesse <strong>Gerenciar Loja > Entregas</strong> para ver os detalhes.</p>
      <button data-modal-id="modalVendaRealizada" onclick="fecharModal(event)" style="background: white; color: #c0392b;">笨 OK</button>
    </div>
  </div>

  <!-- Modal de confirmaﾃｧﾃ｣o do comprador -->
  <div id="modalConfirmacaoComprador" class="modal">
    <div class="modal-content">
      <h3 id="confirmacaoCompradorTitulo">Confirmar Recebimento</h3>
      <p id="confirmacaoCompradorTexto">O vendedor marcou o produto como entregue. Vocﾃｪ confirma o recebimento?</p>
      <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button id="btnRecusarEntrega" style="background: #c0392b;">笶 Recusar</button>
        <button id="btnAceitarEntrega" style="background: #27ae60;">笨 Aceitar</button>
      </div>
    </div>
  </div>

  <!-- Novos modais para depﾃｳsito e PIX expirado -->
  <div id="modalDadosDeposito" class="modal" onclick="fecharModal(event)" style="display:none;">
    <div class="modal-content" onclick="event.stopPropagation()">
      <h3>ｧｾ Dados para Depﾃｳsito</h3>
      <input id="depPrimeiroNome" type="text" placeholder="Primeiro nome">
      <input id="depSegundoNome" type="text" placeholder="Segundo nome">
      <input id="depCPF" type="text" placeholder="CPF">
      <input id="depTelefone" type="tel" placeholder="Telefone">
      <button id="btnContinuarDadosDeposito" disabled>筐｡ｸ Continuar</button>
      <button data-modal-id="modalDadosDeposito" onclick="fecharModal(event)">笶 Cancelar</button>
    </div>
  </div>

  <div id="modalPixExpirado" class="modal" onclick="fecharModal(event)" style="display:none; z-index: 101;">
    <div class="modal-content" onclick="event.stopPropagation()">
      <h3>竢ｳ Tempo expirado</h3>
      <p>Seu QR Code PIX expirou apﾃｳs 10 minutos.</p>
      <div style="display:flex; gap:10px;">
        <button onclick="fecharModalAtual(); processarPagamentoPixAprimorado()">煤 Tentar novamente</button>
        <button data-modal-id="modalPixExpirado" onclick="fecharModal(event)">笶 Fechar</button>
      </div>
    </div>
  </div>

<div class="topbar hidden" id="topbar">
  <div class="logo">宙 Navalha de Ouro</div>
  <div class="topbar-right">
    <button id="btnTema" onclick="alternarTema()">嫌</button>
    <button id="btnCarteiraTop" class="hidden" onclick="abrirModal('modalCarteira')">腸 R$ <span id="saldoHeader">0,00</span></button>
  </div>
</div>

<div class="content-container">
  
  <div id="chatPreview"></div> <div id="botaoExtra" class="hidden"></div>

  <div id="authView" class="card hidden">
    <h2>柏 Entrar ou Criar Conta</h2>
    <input id="email" type="email" placeholder="透 Email">
    <input id="senha" type="password" placeholder="泊 Senha">
    <div id="cadastro-fields" class="hidden">
      <div class="show-password-container">
        <input id="senha-cadastro" type="password" placeholder="泊 Senha (visﾃｭvel)">
      </div>
      <div class="show-password-container">
        <input id="senha-confirm" type="password" placeholder="泊 Confirmar Senha (visﾃｭvel)">
      </div>
      <select id="tipo">
        <option value="cliente">刹 Cliente</option>
        <option value="barbeiro">宙 Barbeiro</option>
      </select>
      <input id="telefone" type="tel" placeholder="到 Telefone com DDD (ex: 27999999999)">
      <input id="rua" type="text" placeholder="Endereﾃｧo (Rua)" class="hidden">
      <input id="numero" type="text" placeholder="Endereﾃｧo (Nﾃｺmero)" class="hidden">
      <select id="estado" onchange="carregarCidades()">
        <option value="">月 Selecione seu estado</option>
      </select>
      <select id="cidade">
        <option value="">徐ｸ Selecione sua cidade</option>
      </select>
      <input id="indicador" type="text" placeholder="鐙 Email de quem te indicou? (opcional)">
      <button onclick="obterLocalizacaoCadastro()" id="btnLocalizacaoCadastro">桃 Usar minha localizaﾃｧﾃ｣o atual</button>
    </div>
    <button onclick="entrar()">筐｡ｸ Entrar</button>
    <button id="btnCriarConta" onclick="prepararCriarConta()"> Criar conta</button>
    <button id="btnVoltar" class="hidden" onclick="voltarParaLogin()">筮ｸ Voltar</button>
  </div>
  
  <div id="guestView" class="card">
    <h2>刹 Painel de Visitante</h2>
    <p style="text-align: center; font-size: 14px; opacity: 0.8;">Bem-vindo! Para interagir, crie uma conta ou faﾃｧa login.</p>
    <button onclick="toggleFuncoes('guestFuncoesContainer')">笞呻ｸ Funﾃｧﾃｵes do Visitante</button>
    <div id="guestFuncoesContainer" class="hidden">
        <div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:10px;">
          <button>糖 Histﾃｳrico</button>
          <button>虫 VIP</button>
          <button>腸 Carteira</button>
          <button>醇 Fidelidade</button>
          <button>堂 Blog</button>
          <button>遵 Conquistas</button>
          <button>投 Ranking</button>
          <button>寫ｸ Loja</button>
        </div>
    </div>
    <hr style="border-color: var(--cor-borda); margin: 20px 0;">
    <div id="listaBarbeirosPrincipalGuest" class="barbeiro-list-container"></div>
  </div>

  <div id="clienteView" class="hidden card">
    <h2>刹 Painel do Cliente</h2>
    <button onclick="toggleFuncoes('clienteFuncoesContainer')">笞呻ｸ Funﾃｧﾃｵes do Cliente</button>
    <div id="clienteFuncoesContainer" class="hidden">
        <div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:10px;">
          <button id="btnHistoricoCliente" onclick="abrirHistoricoCliente()" style="width:45%">糖 Histﾃｳrico</button>
          <button id="btnVip" onclick="abrirModalVip()" style="width:45%">虫 VIP</button>
          <button onclick="abrirModal('modalCarteira')" style="width:45%">腸 Carteira</button>
          <button onclick="abrirModal('modalFidelidade')" style="width:45%">醇 Fidelidade</button>
          <button onclick="carregarListaBlog(); abrirModal('modalBlog')" style="width:45%">堂 Blog</button>
          <button onclick="abrirModalConquistas()" style="width:45%">遵 Conquistas</button>
          <button onclick="abrirModalRankingUnificado()" style="width:45%">投 Ranking</button>
          <button id="btnGerenciarLojaCliente" onclick="abrirGerenciarLoja()" class="hidden" style="width:45%">宵 Minha Loja</button>
          <button id="btnMinhasCompras" onclick="abrirMinhasCompras()" style="width:45%">寫ｸ Minhas Compras</button>
        </div>
    </div>
    <hr style="border-color: var(--cor-borda); margin: 20px 0;">
    <div id="listaBarbeirosPrincipalCliente" class="barbeiro-list-container"></div>
  </div>

  <div id="barbeiroView" class="hidden card">
    <h2>宙 Painel do Barbeiro</h2>
    <button onclick="toggleFuncoes('barbeiroFuncoesContainer')">笞呻ｸ Funﾃｧﾃｵes do Barbeiro</button>
    <div id="barbeiroFuncoesContainer" class="hidden">
        <div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:10px;">
          <button onclick="abrirServicos()" style="width:45%">笨ゑｸ Serviﾃｧos</button>
          <button onclick="abrirAgenda()" style="width:45%">套 Agenda</button>
          <button id="btnAgendamentosBarbeiro" onclick="abrirAgendamentosBarbeiro()" style="width:45%">竢ｰ Agendamentos</button>
          <button onclick="abrirClientesBarbeiro()" style="width:45%">ｧ鯛昨洟昶昨洫 Clientes</button>
          <button onclick="abrirPromocoes()" style="width:45%">氏 Promoﾃｧﾃｵes</button>
          <button onclick="abrirModal('modalCarteira')" style="width:45%">腸 Carteira</button>
          <button onclick="abrirHistoricoBarbeiro()" style="width:45%">糖 Histﾃｳrico</button>
          <button id="btnAvaliacoesBarbeiro" onclick="abrirAvaliacoesBarbeiro()" style="width:45%">箝 Avaliaﾃｧﾃｵes</button>
          <button onclick="abrirModalPortfolioBarbeiro()" style="width:45%">名ｸ Portfﾃｳlio</button>
          <button onclick="abrirModal('modalAlterarNomeBarbeiro')" style="width:45%">笨擾ｸ Alterar Nome</button>
          <button onclick="abrirModal('modalAlterarEnderecoBarbeiro')" style="width:45%">桃 Alterar Endereﾃｧo</button>
          <button onclick="abrirModalDashboardBarbeiro()" style="width:45%">噫 Desempenho</button>
          <button onclick="abrirModalConquistasBarbeiro()" style="width:45%">遵 Conquistas</button>
          <button onclick="abrirModalRankingUnificado()" style="width:45%">投 Ranking</button>
          <button onclick="carregarListaBlog(); abrirModal('modalBlog')" style="width:45%">堂 Blog</button>
          <button id="btnGerenciarLojaBarbeiro" onclick="abrirGerenciarLoja()" class="hidden" style="width:45%">宵 Gerenciar Loja</button>
          <button onclick="abrirModalTurbinar()" style="width:92%; background: linear-gradient(45deg, var(--cor-destaque-ouro), #ffeb3b);">噫 Turbinar Perfil (R$ 9,99)</button>
        </div>
    </div>
     <hr style="border-color: var(--cor-borda); margin: 20px 0;">
    <div id="listaBarbeirosPrincipalBarbeiro" class="barbeiro-list-container"></div>
  </div>

  <div id="adminView" class="hidden card">
    <h2>ｧ Painel do Admin</h2>
    <div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center">
      <button onclick="abrirModalEstatisticas()" style="width:45%">投 Estatﾃｭsticas</button>
      <button onclick="abrirModalSolicitacoes()" style="width:45%">踏 Solicitaﾃｧﾃｵes</button>
      <button onclick="abrirModalUsuarios()" style="width:45%">則 Usuﾃ｡rios</button>
      <button onclick="abrirDenuncias()" style="width:45%">圷 Denﾃｺncias</button>
      <button onclick="abrirModal('modalCarteira')" style="width:45%">腸 Carteira</button>
      <button onclick="abrirGerenciarLoja()" style="width:45%">寫ｸ Gerenciar Loja</button>
      <button onclick="abrirModal('modalBlogAdmin')" style="width:45%">笨搾ｸ Publicar Blog</button>
      <button onclick="abrirModal('modalNotificacaoMarketing')" style="width:92%">謄 Enviar Notificaﾃｧﾃ｣o Geral</button>
    </div>
  </div>

  <div id="lojaView" class="hidden card">
    <div class="card-header">
        <h3>寫ｸ Loja Navalha de Ouro</h3>
        <div style="display: flex; gap: 10px;">
            <!-- O botﾃ｣o vender foi movido para o painel de funﾃｧﾃｵes para melhor UX -->
        </div>
    </div>
    <div id="lojaContainer" class="loja-grid">
    </div>
</div>


</div>

<div class="redeem-container hidden" id="redeemContainer">
  <button id="btnResgatar" onclick="abrirPortaSecreta()">笨ｨ Resgatar Cﾃｳdigo</button>
</div>

<div class="bottom-buttons-container hidden" id="bottomButtons">
  <button id="btnDenuncia" onclick="abrirModal('modalDenuncia')">圷</button>
  <button id="btnChat" onclick="abrirChatGlobal()">
    <span>町</span>
    <span class="notification-badge hidden">0</span>
  </button>
</div>

<button id="btnSair" class="hidden" onclick="auth.signOut()">坎 Sair</button>

<!-- ============================================= -->
<!-- MODAIS DE FLUXO FINANCEIRO (NOVOS E REFINADOS) -->
<!-- ============================================= -->

<div id="modalCarteira" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>腸 Minha Carteira</h3>
    <p>Seu saldo atual ﾃｩ: <b style="color: var(--cor-destaque-ouro);">R$ <span id="saldoModal">0,00</span></b></p>
    <button onclick="iniciarDeposito()">踏 Depositar</button>
    <button onclick="iniciarSaque()">豆 Sacar</button>
    <button data-modal-id="modalCarteira" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalDeposito" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>腸 Depﾃｳsito de Crﾃｩditos</h3>
    <p>Escolha um mﾃｩtodo de pagamento para adicionar saldo ﾃ sua carteira.</p>
    <div class="metodos-grid">
        <button id="btnPagarComPix" onclick="processarPagamentoPixAprimorado()">笞｡ PIX (QR Code)</button>
        <button id="btnPagarComCartao" onclick="processarPagamentoCartaoAprimorado()">諜 Cartﾃ｣o de Crﾃｩdito</button>
    </div>
    <button data-modal-id="modalDeposito" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalGerandoQRCode" class="modal">
    <div class="modal-content" style="text-align: center;">
        <h3 style="color: var(--cor-destaque-ouro);">Gerando QR CODE</h3>
        <p>Aguarde um instante...</p>
    </div>
</div>

<div id="modalCarregandoGenerico" class="modal">
    <div class="modal-content" style="text-align: center;">
        <h3 id="carregandoGenericoTitulo" style="color: var(--cor-destaque-ouro);">Aguarde...</h3>
        <p id="carregandoGenericoTexto">Estamos processando sua solicitaﾃｧﾃ｣o.</p>
    </div>
</div>

<div id="modalExibirPixAprimorado" class="modal">
    <div class="modal-content" style="text-align: center;">
      <h3> Pague com PIX</h3>
      <p>Escaneie o QR Code abaixo com seu app de banco.</p>
      <img src="https://i.imgur.com/g2512hL.png" id="pix-qrcode" alt="QR Code PIX">
      <div class="pix-copia-cola-container">
          <textarea id="pixChaveAleatoria">00020126770014BR.GOV.BCB.PIX0136ec4a8f0f-ec59-44bc-afcf-dff364f971de0215NAVALHA DE OURO5204000053039865802BR5920Josiel Lopes Azeredo6009SAO PAULO62140510vuyKg7Qnmx63041C39</textarea>
          <button onclick="copiarCodigoPixAprimorado()">Copiar Chave Aleatﾃｳria PIX</button>
      </div>
      <p style="font-size: 14px; color: #ff9800; margin-top: 15px;">Este cﾃｳdigo expira em: <b id="pixTimer">10:00</b></p>
      <button onclick="confirmarEnvioComprovante()">CONFIRMAR</button>
    </div>
</div>

<div id="modalSaque" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>豆 Solicitar Saque</h3>
    <p>O valor serﾃ｡ transferido para sua chave PIX apﾃｳs aprovaﾃｧﾃ｣o do administrador.</p>
    <input id="saqueValor" type="number" placeholder="Valor do saque">
    <select id="saqueChavePixTipo">
      <option value="">Tipo de Chave PIX</option>
      <option value="cpf">CPF</option>
      <option value="email">E-mail</option>
      <option value="telefone">Telefone</option>
      <option value="aleatoria">Aleatﾃｳria</option>
    </select>
    <input id="saqueChavePix" type="text" placeholder="Sua chave PIX">
    <button id="btnConfirmarSaque" onclick="confirmarSaque()">笨 Confirmar Saque</button>
    <button data-modal-id="modalSaque" onclick="fecharModal(event)">笶 Cancelar</button>
  </div>
</div>

<div id="modalSaqueConfirmado" class="modal">
  <div class="modal-content" style="text-align:center;">
    <h3>笨 Solicitaﾃｧﾃ｣o Enviada!</h3>
    <p>Sua solicitaﾃｧﾃ｣o de saque foi enviada para anﾃ｡lise.</p>
    <p style="font-size:14px; opacity: 0.8;">Para agilizar, entre em contato com o administrador.</p>
    <button onclick="contatarAdminSaque()">OK</button>
  </div>
</div>

<!-- ============================================= -->
<!-- MODAIS GERAIS (EXISTENTES E NOVOS)            -->
<!-- ============================================= -->

<div id="janelaChat" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <button id="carregarMaisMsgBtn" onclick="carregarMensagensAnteriores()">Ver mensagens anteriores</button>
    <h3 id="chatTitle">町 Chat Global</h3>
    <div id="chatMessages" class="chat-container"></div>
    <input id="chatInput" placeholder="Digite sua mensagem">
    <button onclick="enviarMensagem()">筐｡ｸ Enviar</button>
    <button data-modal-id="janelaChat" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalDenuncia" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>圷 Denunciar</h3>
    <p>Envie sua mensagem e o administrador responderﾃ｡ em breve!</p>
    <textarea id="textoDenuncia" placeholder="Descreva o problema em detalhes"></textarea>
    <button onclick="enviarDenuncia()">筐｡ｸ Enviar</button>
    <button data-modal-id="modalDenuncia" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalDenunciaEnviada" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>笨 Denﾃｺncia Enviada!</h3>
    <p>Agradecemos a sua denﾃｺncia. Ela serﾃ｡ analisada pela nossa equipe.</p>
    <p>町 Se preferir, clique no botﾃ｣o abaixo para avisar o administrador diretamente no WhatsApp e agilizar o processo.</p>
    <a id="btnWhatsappDenuncia" href="#" target="_blank">
      <button>町 Avisar no WhatsApp</button>
    </a>
    <button data-modal-id="modalDenunciaEnviada" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalBlog" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>堂 Blog</h3>
    <div id="listaBlog" class="scrollable-list"></div>
    <button data-modal-id="modalBlog" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalVip" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div id="vipContentContainer">
    </div>
    <button data-modal-id="modalVip" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalFidelidade" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>醇 Programa de Fidelidade</h3>
    <p>Seus pontos: <b id="pontosFidelidade">0</b></p>
    <p style="font-size: 14px; color: var(--cor-destaque-prata);">Acumule pontos em cada agendamento e troque por descontos!</p>
    <button onclick="resgatarPontos()">氏 Resgatar 100 pontos por R$ 5,00</button>
    <button data-modal-id="modalFidelidade" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalBarbeiroPerfil" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div id="barbeiroPerfilHeader">
      <h3 id="barbeiroPerfilNome"></h3>
      <p>Endereﾃｧo: <span id="barbeiroPerfilEndereco"></span></p>
      <p>Reputaﾃｧﾃ｣o: <span id="barbeiroPerfilReputacao"></span></p>
    </div>

    <div id="barbeiroPerfilServicos" class="popup-section">
      <h4>1. Escolha um Serviﾃｧo</h4>
      <div id="barbeiroPerfilServicosList" class="scrollable-list" style="max-height: 150px;"></div>
    </div>

    <div id="barbeiroPerfilHorarios" class="popup-section">
      <h4>2. Escolha uma Opﾃｧﾃ｣o</h4>
      <div id="barbeiroPerfilHorariosList"></div>
    </div>

    <div class="modal-footer">
      <button id="btnAcessarPortfolio" class="hidden" style="width: auto; background-color: var(--cor-botoes);">名ｸ Ver Portfﾃｳlio</button>
      <button id="btnAbrirRota" class="hidden" style="width: auto; background-color: var(--cor-botoes);">亮ｸ Rota</button>
      <button id="btnConfirmarAgendamento" disabled>欄ｸ Agendar</button>
    </div>
    <button data-modal-id="modalBarbeiroPerfil" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalVagaImediataAprovada" class="modal" style="z-index: 99;" onclick="fecharModal(event)">
  <div class="modal-content" style="background: #e74c3c; color: white;" onclick="event.stopPropagation()">
    <h3 style="color:white;text-shadow: 2px 2px 4px #000;">笞ｸ VAGA IMEDIATA APROVADA!</h3>
    <p style="font-size: 1.2em; text-align: center;"><b>Vocﾃｪ tem 10 minutos para chegar ﾃ barbearia.</b></p>
    <p style="text-align: center;">Nﾃ｣o se atrase para nﾃ｣o perder a vaga e o seu dinheiro!</p>
    <div style="display:flex; gap: 10px; margin-top: 20px;">
      <button data-modal-id="modalVagaImediataAprovada" onclick="fecharModal(event)" style="background:white; color:#e74c3c; flex: 1;">笨 Entendi</button>
      <button id="btnCancelarVagaAprovada" style="background: #333; color: white; flex: 1;">笶 Cancelar Agendamento</button>
    </div>
  </div>
</div>

<div id="modalBarbeariasCliente" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>宙 Barbearias disponﾃｭveis</h3>
    <input type="text" id="filtroBarbeiro" onkeyup="filtrarBarbeiros()" placeholder="博 Buscar por barbeiro ou cidade...">
    <div id='listaBarbeiros' class="scrollable-list"></div>
    <button data-modal-id="modalBarbeariasCliente" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalHistoricoCliente" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>糖 Meu Histﾃｳrico</h3>
    <div id="painelHistorico" class="scrollable-list"></div>
    <button data-modal-id="modalHistoricoCliente" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalConquistas" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>遵 Minhas Conquistas</h3>
    <div id="listaConquistas" class="scrollable-list"></div>
    <button data-modal-id="modalConquistas" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalRankingUnificado" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>醇 Ranking Geral 醇</h3>
    <p style="font-size: 12px; opacity: 0.7; text-align:center;">Top 100 com mais serviﾃｧos concluﾃｭdos.</p>
    <div class="ranking-container">
      <div class="ranking-column">
        <h4>宙 Barbeiros</h4>
        <div id="listaRankingBarbeirosUnificado" class="scrollable-list"></div>
      </div>
      <div class="ranking-column">
        <h4>刹 Clientes</h4>
        <div id="listaRankingClientesUnificado" class="scrollable-list"></div>
      </div>
    </div>
    <button data-modal-id="modalRankingUnificado" onclick="fecharModal(event)" style="margin-top: 20px;">笶 Fechar</button>
  </div>
</div>


<div id="modalCriarPromocao" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>氏 Criar Promoﾃｧﾃ｣o</h3>
    <input id="promocaoNome" placeholder="Nome da Promoﾃｧﾃ｣o">
    <input id="promocaoDescricao" placeholder="Descriﾃｧﾃ｣o curta">
    <input type="number" id="promocaoDesconto" placeholder="Desconto em % (ex: 15)">
    <button onclick="criarPromocao()">沈 Salvar Promoﾃｧﾃ｣o</button>
    <button data-modal-id="modalCriarPromocao" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalAlterarNomeBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>笨擾ｸ Alterar Nome</h3>
    <input id="novoNomeBarbeiro" type="text" placeholder="Novo nome do barbeiro/barbearia">
    <button onclick="alterarNomeBarbeiro(event)">沈 Salvar</button>
    <button data-modal-id="modalAlterarNomeBarbeiro" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalAlterarEnderecoBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>桃 Alterar Endereﾃｧo</h3>
    <input id="novoEnderecoRua" type="text" placeholder="Nova Rua">
    <input id="novoEnderecoNumero" type="text" placeholder="Novo Nﾃｺmero">
    <button onclick="obterLocalizacaoCadastro('barbeiro')">桃 Usar minha localizaﾃｧﾃ｣o atual</button>
    <button onclick="alterarEnderecoBarbeiro(event)">沈 Salvar</button>
    <button data-modal-id="modalAlterarEnderecoBarbeiro" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalAvaliacoes" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>箝 Minhas Avaliaﾃｧﾃｵes</h3>
        <div id="listaAvaliacoesModal" class="scrollable-list"></div>
        <button data-modal-id="modalAvaliacoes" onclick="fecharModal(event)">笶 Fechar</button>
    </div>
</div>

<div id="modalServicosBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>笨ゑｸ Meus Serviﾃｧos</h3>
    <div id="listaServicosBarbeiro" class="scrollable-list"></div>
    <button onclick="adicionarServico()">筐 Adicionar novo serviﾃｧo</button>
    <button data-modal-id="modalServicosBarbeiro" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalAgendaBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>套 Minha Agenda</h3>
    <p>Use os botﾃｵes abaixo para gerenciar sua disponibilidade e horﾃ｡rios.</p>
    <button id="btnDisponibilidade" onclick="toggleDisponibilidade()"></button>
    <button id="btnVagaImediata" onclick="toggleVagaImediata()"></button>
    <button id="btnAgendaManual" onclick="toggleAgendaManual()"></button>
    <div id="agendaManualPainel" class="hidden card">
        <h4>Horﾃ｡rios Disponﾃｭveis Hoje</h4>
        <p>Selecione os horﾃ｡rios para trabalhar ou clique duas vezes para bloquear.</p>
        <div id="horariosContainer" style="display:flex; flex-wrap:wrap; gap:5px; justify-content: center;"></div>
        <div class="horarios-actions">
            <button onclick="salvarAgendaManual()">沈 Salvar</button>
            <button data-modal-id="modalAgendaBarbeiro" onclick="fecharModal(event)">坎 Fechar</button>
        </div>
    </div>
    <button data-modal-id="modalAgendaBarbeiro" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalAgendamentosBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>竢ｰ Meus Agendamentos</h3>
    <div id="agendamentosPainel" class="scrollable-list"></div>
    <button data-modal-id="modalAgendamentosBarbeiro" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalClientesBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>ｧ鯛昨洟昶昨洫 Meus Clientes</h3>
    <p>Lista de clientes que jﾃ｡ agendaram com vocﾃｪ.</p>
    <div id="listaClientesBarbeiro" class="scrollable-list"></div>
    <button data-modal-id="modalClientesBarbeiro" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalDashboardBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>噫 Meu Desempenho</h3>
    <div id="dashboardConteudo">
      <p>Carregando dados...</p>
    </div>
    <button data-modal-id="modalDashboardBarbeiro" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalHistoricoBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>糖 Histﾃｳrico de Serviﾃｧos</h3>
    <div id="painelHistoricoBarbeiro" class="scrollable-list"></div>
    <button data-modal-id="modalHistoricoBarbeiro" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalConquistasBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>遵 Minhas Conquistas de Barbeiro</h3>
    <div id="listaConquistasBarbeiro" class="scrollable-list"></div>
    <button data-modal-id="modalConquistasBarbeiro" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalBlogAdmin" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>笨搾ｸ Novo Post</h3>
    <input id="blogTitulo" placeholder="Tﾃｭtulo">
    <textarea id="blogConteudo" placeholder="Conteﾃｺdo do post"></textarea>
    <button onclick="publicarBlog()">笨搾ｸ Publicar</button>
    <button data-modal-id="modalBlogAdmin" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalEstatisticas" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>投 Estatﾃｭsticas</h3>
    <div id="estatisticasPainel" class="scrollable-list"></div>
    <button data-modal-id="modalEstatisticas" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalSolicitacoes" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>踏 Todas as Solicitaﾃｧﾃｵes</h3>
    <div id="listaSolicitacoes" class="scrollable-list"></div>
    <button data-modal-id="modalSolicitacoes" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalUsuarios" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>則 Todos os Usuﾃ｡rios</h3>
    <div id="usuariosPainel" class="scrollable-list"></div>
    <button data-modal-id="modalUsuarios" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalDenunciasAdmin" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>圷 Denﾃｺncias</h3>
    <div id="listaDenuncias" class="scrollable-list"></div>
    <button data-modal-id="modalDenunciasAdmin" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalNotificacaoMarketing" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>謄 Notificaﾃｧﾃ｣o para Todos</h3>
    <p>Esta mensagem serﾃ｡ enviada como uma notificaﾃｧﾃ｣o push para todos os usuﾃ｡rios do app.</p>
    <input id="marketingTitulo" placeholder="Tﾃｭtulo da Notificaﾃｧﾃ｣o">
    <textarea id="marketingCorpo" placeholder="Corpo da mensagem"></textarea>
    <button onclick="enviarNotificacaoMarketing()">噫 Enviar para todos</button>
    <button data-modal-id="modalNotificacaoMarketing" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalPortfolioBarbeiro" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>名ｸ Gerenciar Portfﾃｳlio</h3>
    <p style="font-size: 12px; opacity: 0.8;">Cole os links das suas imagens. Use serviﾃｧos como <a href="https://postimages.org/" target="_blank">Postimages</a> para hospedar suas fotos gratuitamente. Mﾃ｡ximo de 10 imagens.</p>
    <div id="portfolioInputsContainer" class="scrollable-list" style="max-height: 250px;"></div>
    <button onclick="salvarPortfolio()">沈 Salvar Portfﾃｳlio</button>
    <button data-modal-id="modalPortfolioBarbeiro" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalPortfolioCliente" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3 id="portfolioClienteNome">名ｸ Portfﾃｳlio</h3>
    <div id="portfolioClienteGrid" class="portfolio-grid"></div>
    <button data-modal-id="modalPortfolioCliente" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

<div id="modalLiberarLoja" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>寫ｸ Acesso ﾃ Loja de Vendedores</h3>
        <p>Vocﾃｪ ainda nﾃ｣o tem permissﾃ｣o pra cadastrar produtos na loja. Peﾃｧa autorizaﾃｧﾃ｣o pro administrador no WhatsApp.</p>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button data-modal-id="modalLiberarLoja" onclick="fecharModal(event)" style="background-color: #555;">竊ｩｸ Cancelar</button>
            <button onclick="solicitarLiberacaoLoja()" style="flex-grow: 1;">
                町 Pedir no WhatsApp
            </button>
        </div>
    </div>
</div>

<div id="modalTurbinar" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>噫 Turbinar seu Perfil</h3>
        <p>Destaque seu perfil no topo da lista de barbearias por <strong>24 horas</strong> e alcance mais clientes!</p>
        <p style="font-size: 22px; color: var(--cor-destaque-ouro); font-weight: bold; text-align: center;">Apenas R$ 9,99</p>
        <button onclick="confirmarTurbinar()">徴 Confirmar e Turbinar</button>
        <button data-modal-id="modalTurbinar" onclick="fecharModal(event)">笶 Cancelar</button>
    </div>
</div>

<div id="modalPermissaoNotificacao" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>粕 Fique por Dentro!</h3>
        <p>Ative as notificaﾃｧﾃｵes para receber alertas importantes sobre seus agendamentos, promoﾃｧﾃｵes e novidades em tempo real.</p>
        <button onclick="pedirPermissaoEFechar()">総 Ativar Notificaﾃｧﾃｵes</button>
        <button data-modal-id="modalPermissaoNotificacao" onclick="fecharModal(event)">笶 Agora nﾃ｣o</button>
    </div>
</div>

<div id="modalInstalarApp" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>導 Leve o App com Vocﾃｪ!</h3>
        <p>Instale nosso aplicativo na sua tela inicial para um acesso mais rﾃ｡pido e uma melhor experiﾃｪncia.</p>
        <button id="btnInstalarPWA">憧 Instalar Agora</button>
        <button data-modal-id="modalInstalarApp" onclick="fecharModal(event)">､ Depois</button>
    </div>
</div>

<div id="modalAtualizacao" class="modal" style="z-index: 100;" onclick="fecharModal(event)">
    <div class="modal-content" style="border: 2px solid var(--cor-destaque-ouro);" onclick="event.stopPropagation()">
        <h3>噫 Nova Versﾃ｣o Disponﾃｭvel!</h3>
        <p>Uma nova versﾃ｣o do aplicativo estﾃ｡ pronta. Clique no botﾃ｣o abaixo para atualizar e ter acesso ﾃs ﾃｺltimas novidades e melhorias.</p>
        <div style="display:flex; gap: 10px; margin-top: 20px;">
           <button data-modal-id="modalAtualizacao" onclick="fecharModal(event)" style="background: #555;">､ Depois</button>
           <button id="btnAtualizarApp" style="flex-grow: 1;">売 Atualize Agora</button>
        </div>
    </div>
</div>

<div id="modalPromocoesBarbeiro" class="modal">
  <div class="modal-content">
    <h2>氏 Promoﾃｧﾃｵes Ativas</h2>
    <div id="listaPromocoes">
      </div>
    <div class="modal-botoes">
      <button onclick="abrirModalAddPromocao()">筐 Adicionar Promoﾃｧﾃ｣o</button>
      <button data-modal-id="modalPromocoesBarbeiro" onclick="fecharModal(event)">笶 Fechar</button>
    </div>
  </div>
</div>

<div id="modalAddPromocao" class="modal">
  <div class="modal-content">
    <h2>筐 Adicionar Nova Promoﾃｧﾃ｣o</h2>
    <input type="text" id="addPromocaoNome" placeholder="Nome da Promoﾃｧﾃ｣o" required>
    <textarea id="addPromocaoDescricao" placeholder="Descriﾃｧﾃ｣o" required></textarea>
    <input type="number" id="addPromocaoDesconto" placeholder="Desconto (%)" required>
    <button onclick="salvarNovaPromocao()">沈 Salvar Promoﾃｧﾃ｣o</button>
    <button data-modal-id="modalAddPromocao" onclick="fecharModal(event)">笶 Cancelar</button>
  </div>
</div>
	
<div id="modalLoja" class="modal">
  <div class="modal-content">
    <h3>將 Produtos da Loja</h3>
    <div id="listaProdutos" class="loja-grid"></div>
    <button data-modal-id="modalLoja" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>


<div id="modalProdutoDetalhes" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <img id="detalhesProdutoImg" src="" style="width: 100%; height: 200px; object-fit: contain; border-radius: 10px; margin-bottom: 15px;">
        <h3 id="detalhesProdutoNome" style="margin: 0; color: var(--cor-destaque-ouro);"></h3>
        <p style="margin-top: 15px;"><strong>Tamanho:</strong></p>
        <div id="detalhesProdutoTamanhos" class="tamanho-options"></div>
        <p><strong>Preﾃｧo:</strong> <span id="detalhesProdutoPreco" style="font-weight: bold; font-size: 1.2em;"></span></p>
        <p><strong>Descriﾃｧﾃ｣o:</strong> <span id="detalhesProdutoDescricao"></span></p>
        <p><strong>Entrega estimada:</strong> <span id="detalhesProdutoEntrega"></span></p>
        
        <div id="detalhesProdutoAvaliacao"></div>

        <button id="btnComprarAgora">將 Comprar Agora</button>
        <button data-modal-id="modalProdutoDetalhes" onclick="fecharModal(event)">笶 Fechar</button>
    </div>
</div>

<div id="modalConfirmarCompra" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>逃 Confirmaﾃｧﾃ｣o de Compra</h3>
        <p>Por favor, confirme os detalhes para a entrega.</p>
        <input id="compraEndereco" type="text" placeholder="匠 Endereﾃｧo Completo para Entrega">
        <input id="compraTelefone" type="tel" placeholder="到 Telefone para Contato">
        <input id="compraCep" type="text" placeholder="笨会ｸ CEP (Obrigatﾃｳrio)">
        <button id="btnConfirmarCompraFinal">笨 Confirmar Pedido</button>
        <button data-modal-id="modalConfirmarCompra" onclick="fecharModal(event)">笶 Cancelar</button>
    </div>
</div>

<div id="modalGerenciarLoja" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" style="max-width: 600px;">
        <h3>宵 Gerenciar Minha Loja</h3>
        <div id="listaMeusProdutos" class="scrollable-list"></div>
        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px;">
          <button onclick="abrirFormularioProduto()">筐 Adicionar Produto</button>
          <button id="btnEntregasVendedor" onclick="abrirEntregasVendedor()">囹 Entregas</button>
          <button data-modal-id="modalGerenciarLoja" onclick="fecharModal(event)">笶 Fechar</button>
        </div>
    </div>
</div>

<div id="modalAddEditProduto" class="modal" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3 id="formProdutoTitulo">逃 Adicionar Novo Produto</h3>
        <input id="produtoImagemUrl" type="url" placeholder="迫 Link direto da imagem (.png, .jpg)">
        <input id="produtoNome" type="text" placeholder="Nome do Produto">
        <input id="produtoPreco" type="number" placeholder="Preﾃｧo (Ex: 49.90)">
        <p>Tamanhos disponﾃｭveis:</p>
        <div class="checkbox-group">
            <label><input type="checkbox" name="tamanhos" value="P"> P</label>
            <label><input type="checkbox" name="tamanhos" value="M"> M</label>
            <label><input type="checkbox" name="tamanhos" value="G"> G</label>
            <label><input type="checkbox" name="tamanhos" value="GG"> GG</label>
        </div>
        <input id="produtoDesconto" type="number" placeholder="Desconto em % (Opcional)">
        <input id="produtoEntrega" type="text" placeholder="Tempo de entrega (Ex: 3-5 dias)">
        <textarea id="produtoDescricao" placeholder="Descriﾃｧﾃ｣o curta do produto" rows="3"></textarea>
        <button id="btnSalvarProduto" onclick="salvarProdutoVendedor()">沈 Salvar Produto</button>
        <button data-modal-id="modalAddEditProduto" onclick="fecharModal(event)">笶 Cancelar</button>
    </div>
</div>

<div id="modalEntregasVendedor" class="modal" onclick="fecharModal(event)">
    <div class="modal-content">
        <h3>囹 Minhas Entregas</h3>
        <div id="listaEntregas" class="scrollable-list"></div>
        <button data-modal-id="modalEntregasVendedor" onclick="fecharModal(event)">笶 Fechar</button>
    </div>
</div>

<div id="modalMinhasCompras" class="modal" onclick="fecharModal(event)">
    <div class="modal-content">
        <h3>寫ｸ Minhas Compras</h3>
        <div id="listaMinhasCompras" class="scrollable-list"></div>
        <button data-modal-id="modalMinhasCompras" onclick="fecharModal(event)">笶 Fechar</button>
    </div>
</div>

<div id="modalVendaRealizada" class="modal modal-venda" onclick="fecharModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>脂 VENDA REALIZADA! 脂</h3>
        <p style="font-size: 1.1em;">Parabﾃｩns, vocﾃｪ vendeu um produto!</p>
        <p>Acesse <strong>Gerenciar Loja > Entregas</strong> para ver os detalhes.</p>
        <button data-modal-id="modalVendaRealizada" onclick="fecharModal(event)" style="background: white; color: #c0392b;">笨 OK</button>
    </div>
</div>

<div id="modalConfirmacaoComprador" class="modal">
    <div class="modal-content">
        <h3 id="confirmacaoCompradorTitulo">Confirmar Recebimento</h3>
        <p id="confirmacaoCompradorTexto">O vendedor marcou o produto como entregue. Vocﾃｪ confirma o recebimento?</p>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
           <button id="btnRecusarEntrega" style="background: #c0392b;">笶 Recusar</button>
           <button id="btnAceitarEntrega" style="background: #27ae60;">笨 Aceitar</button>
        </div>
    </div>
</div>

<footer class="app-footer">
  <div id="appVersion"></div>
</footer>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-messaging-compat.js"></script> 

<script>
// Firebase e variﾃ｡veis globais
const firebaseConfig = {
  apiKey: "AIzaSyDBt7NcU5rP-hsrBZ07ne_HbiMCHRyVcnY",
  authDomain: "navalha-de-ouro-v11.firebaseapp.com",
  projectId: "navalha-de-ouro-v11",
  storageBucket: "navalha-de-ouro-v11.firebasestorage.app",
  messagingSenderId: "434474263075",
  appId: "1:434474263075:web:163893d68a1b5dbe74c796"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth(), db = firebase.firestore();

auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
  .then(() => {
    console.log("Persistﾃｪncia de autenticaﾃｧﾃ｣o definida para 'local'. O usuﾃ｡rio ficarﾃ｡ logado.");
  })
  .catch((error) => {
    console.error("Erro ao definir a persistﾃｪncia de autenticaﾃｧﾃ｣o:", error);
  });
const messaging = firebase.messaging(); 
const ADMIN_EMAIL = "josiel70c@gmail.com", ADMIN_PASS = "Ja997640401", TAXA = 0.05, BONUS_INDICACAO = 100, PONTOS_POR_CORTE = 10, PONTOS_PARA_RESGATE = 100, VALOR_RESGATE = 5;
const PONTOS_POR_DEPOSITO_NORMAL = 4, PONTOS_POR_DEPOSITO_VIP = 8;
const WHATSAPP_ADM_PHONE = "5527995003737";
const PRECO_VIP = 100;
const PRECO_TURBINAR = 9.99;

let fcmSetupDone = false;
let isSending = false;
let perfil = null;
let agendamentoListener = null;
let currentModal = null;
let chatListener = null;
let barbeirosListener = null;
let tempSelectedHorarios = {};
const CHAT_GLOBAL_ID = "chatGlobal";
let botInterval = null;
let newWorker;
let localizacaoCliente = null;
let cadastroCoords = null;
let vendaListener = null;
let produtoEmEdicaoId = null; 
let produtoParaCompra = null;
let pixTimerInterval = null; 
let pendenciasInterval = null; 
let pedidosVendedorListener = null;
let comprasClienteListener = null; 

let userView = {
    originalType: null,
    currentType: null
};

let agendamentoState = {
    barbeiroUid: null,
    barbeiroNome: null,
    servico: null,
    horario: null, 
    barbeiroLat: null,
    barbeiroLon: null,
};

let adminBalanceListener = null;
let adminUserBalances = {};
let globalChatListener = null;
let lastGlobalMessageTimestamp = null;
let newMessagesCount = 0;
let oldestMessageSnapshot = null; // Variﾃ｡vel para paginaﾃｧﾃ｣o do chat

let deferredInstallPrompt = null;
let chatPreviewTimeout = null; 


// --- [Lﾃ敵ICA DE MODAIS CORRIGIDA] ---
let modalAberto = null; // Rastreia o modal que estﾃ｡ atualmente visﾃｭvel

/**
 * Abre um modal especﾃｭfico pelo seu ID. Se outro modal jﾃ｡ estiver aberto,
 * ele serﾃ｡ fechado primeiro para evitar sobreposiﾃｧﾃ｣o.
 * @param {string} modalId O ID do elemento do modal a ser aberto.
 */
function abrirModal(modalId) {
    if (modalAberto) {
        fecharModalAtual();
    }
    const novoModal = document.getElementById(modalId);
    if (novoModal) {
        modalAberto = novoModal;
        novoModal.style.display = 'flex';
        setTimeout(() => {
            novoModal.classList.add('show');
        }, 10);
    }
}
/**
 * Fecha o modal ativo.
 * @param {MouseEvent} event O objeto de evento do clique (opcional).
 */
function fecharModal(event) {
    if (event && !event.target.classList.contains('modal') && !event.target.getAttribute('data-modal-id')) {
        return; 
    }
    if (modalAberto) {
        modalAberto.classList.remove('show');
        const modalParaFechar = modalAberto;
        setTimeout(() => {
            modalParaFechar.style.display = 'none';
            if(modalAberto === modalParaFechar) {
               modalAberto = null;
            }
        }, 300);
    }
}
function fecharModalAtual() {
    if(modalAberto) {
        const event = { target: modalAberto };
        fecharModal(event);
    }
}

// --- [FIM DA Lﾃ敵ICA DE MODAIS] ---


// FUNﾃﾃグ PARA ABRIR O MODAL DE PROMOﾃﾃ髭S E CARREGAR OS DADOS
function abrirPromocoes() {
  abrirModal('modalPromocoesBarbeiro');
  const lista = document.getElementById("listaPromocoes");
  if (!lista) {
    console.error("Erro: Elemento com ID 'listaPromocoes' nﾃ｣o encontrado no HTML.");
    return;
  }
  lista.innerHTML = "<p>竢ｳ Carregando...</p>";
  db.collection("usuarios").doc(auth.currentUser.uid).onSnapshot(doc => {
    perfil = doc.data();
    lista.innerHTML = "";
    if (!perfil.promocoes || perfil.promocoes.length === 0) {
      lista.innerHTML = "<p>Nenhuma promoﾃｧﾃ｣o ativa.</p>";
      return;
    }
    perfil.promocoes.forEach((p, index) => {
      lista.innerHTML += `<div class="promocao-card">
        <b>${p.nome}</b>
        <p>${p.descricao} (${p.desconto}%)</p>
        <button onclick="removerPromocao(${index})" style="background:none;border:none;color:#fff;float:right;">笶</button>
      </div>`;
    });
  });
}

// FUNﾃﾃグ PARA ABRIR O MODAL DE ADICIONAR PROMOﾃﾃグ
function abrirModalAddPromocao() {
  abrirModal('modalAddPromocao');
}

// FUNﾃﾃグ PARA SALVAR A PROMOﾃﾃグ NO FIREBASE
function salvarNovaPromocao() {
  const nome = document.getElementById('addPromocaoNome').value;
  const descricao = document.getElementById('addPromocaoDescricao').value;
  const desconto = parseInt(document.getElementById('addPromocaoDesconto').value);
  
  if (!nome || !descricao || isNaN(desconto)) {
    alert("Por favor, preencha todos os campos corretamente.");
    return;
  }
  
  const novaPromocao = {
    nome: nome,
    descricao: descricao,
    desconto: desconto,
  };

  const userId = auth.currentUser.uid;
  const userRef = db.collection("usuarios").doc(userId);

  userRef.update({
    promocoes: firebase.firestore.FieldValue.arrayUnion(novaPromocao)
  })
  .then(() => {
    alert("Promoﾃｧﾃ｣o adicionada com sucesso!");
    fecharModalAtual();
    document.getElementById('addPromocaoNome').value = '';
    document.getElementById('addPromocaoDescricao').value = '';
    document.getElementById('addPromocaoDesconto').value = '';
  })
  .catch(error => {
    console.error("Erro ao adicionar promoﾃｧﾃ｣o:", error);
    alert("Erro ao adicionar promoﾃｧﾃ｣o. Tente novamente.");
  });
}

async function enviarNotificacaoParaBackend(uid, title, body, data = {}) {
  // ATENﾃﾃグ: A URL do backend foi movida para uma constante no inﾃｭcio do script para fﾃ｡cil manutenﾃｧﾃ｣o.
  const backendUrl = "https://navalhabackend.onrender.com"; 
  const notificationEndpoint = "/enviar-notificacao";
  const fullUrl = backendUrl + notificationEndpoint;

  if (!uid) {
    console.error("Tentativa de enviar notificaﾃｧﾃ｣o sem um UID de usuﾃ｡rio.");
    return;
  }
  
  try {
    // Nﾃ｣o precisamos mais do 'mode: no-cors' pois o backend estﾃ｡ configurado com CORS.
    const response = await fetch(fullUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ uid, title, body, data }),
    });

    const responseData = await response.json();
    if (response.ok) {
      console.log('Notificaﾃｧﾃ｣o enviada com sucesso via backend:', responseData);
    } else {
      console.error('Falha ao enviar a notificaﾃｧﾃ｣o via backend:', responseData.message);
    }
  } catch (error) {
    console.error('Erro de rede ou na chamada da API de notificaﾃｧﾃ｣o:', error);
  }
}


async function notifyUser(uid, title, body, data = {}) {
    if (!uid) return;
    console.log(`Disparando notificaﾃｧﾃ｣o para UID: ${uid} - Tﾃｭtulo: ${title}`);
    await enviarNotificacaoParaBackend(uid, title, body, data);
}

async function notifyAdmins(title, body, data = {}) {
    try {
        const adminQuery = await db.collection("usuarios").where("tipo", "==", "admin").get();
        if (!adminQuery.empty) {
            adminQuery.forEach(adminDoc => {
                notifyUser(adminDoc.id, title, body, data);
            });
        }
    } catch(e) {
        console.error("Erro ao notificar admins:", e);
    }
}


// Funﾃｧﾃｵes de UI
function mostrar(id) {
  ["authView", "guestView", "clienteView", "barbeiroView", "adminView", "lojaView"].forEach(v => document.getElementById(v)?.classList.add("hidden"));
  document.getElementById(id)?.classList.remove("hidden");
  
  const isAuth = (id === 'authView');
  document.getElementById("topbar").classList.toggle("hidden", isAuth);
  document.getElementById("bottomButtons").classList.toggle("hidden", isAuth);
  document.getElementById("redeemContainer").classList.toggle("hidden", id !== 'clienteView' && id !== 'barbeiroView' && id !== 'adminView');
  
  document.getElementById("btnTema").classList.toggle("hidden", isAuth);
  document.getElementById("btnCarteiraTop").classList.toggle("hidden", id !== 'clienteView' && id !== 'barbeiroView' && id !== 'adminView');
  document.getElementById("botaoExtra").classList.toggle("hidden", id === 'authView' || id === 'guestView');
  document.getElementById("btnSair").classList.toggle("hidden", isAuth || id === 'guestView');
}


function configurarBotoesGuest() {
    const guestView = document.getElementById('guestView');
    const buttons = guestView.querySelectorAll('#guestFuncoesContainer button');
    buttons.forEach(btn => {
        btn.onclick = () => {
            const textoBotao = btn.textContent.trim();
            // Visitantes sﾃ｣o sempre redirecionados para a tela de cadastro/login
            alert("Para acessar esta funﾃｧﾃ｣o, por favor, faﾃｧa login ou crie uma conta.");
            mostrar('authView');
        };
    });
}

function mostrarPainelAtual() {
    mostrar(`${userView.currentType}View`);
}

function solicitarPermissaoNotificacao() {
    if ('Notification' in window && Notification.permission === 'default') {
        abrirModal('modalPermissaoNotificacao');
    }
}

function pedirPermissaoEFechar() {
    Notification.requestPermission().then(permission => {
        if (permission === 'granted') {
            const user = auth.currentUser;
            if (user) {
                setupFCM(user.uid);
            }
        }
    });
    fecharModalAtual();
}

async function garantirTokenAtualizadoNoPerfil(uid) {
    try {
        const currentToken = await messaging.getToken({ vapidKey: 'BGkXq9v27VKT9Tl1DF2QBhP3c77lF4xDdptbay3jaKtlhw-5-G6D2GP7qcsjlweme9WggzBipoCDulIdSiuEfPE' });
        if (currentToken) {
            const userRef = db.collection('usuarios').doc(uid);
            const userDoc = await userRef.get();
            if (userDoc.exists) {
                const tokens = userDoc.data().fcmTokens || [];
                if (!tokens.includes(currentToken)) {
                    await userRef.update({
                        fcmTokens: firebase.firestore.FieldValue.arrayUnion(currentToken)
                    });
                }
            }
        }
    } catch(err) {
        console.error('Erro ao garantir token atualizado:', err);
    }
}


function setupFCM(uid) {
    if (fcmSetupDone || !('serviceWorker' in navigator) || !firebase.messaging.isSupported()) {
        return;
    }

    navigator.serviceWorker.ready.then(async (registration) => {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
            fcmSetupDone = true;

            try {
                // Obtﾃｩm o token do dispositivo. Essa funﾃｧﾃ｣o jﾃ｡ gerencia a renovaﾃｧﾃ｣o.
                const currentToken = await firebase.messaging().getToken({
                    vapidKey: 'BGkXq9v27VKT9Tl1DF2QBhP3c77lF4xDdptbay3jaKtlhw-5-G6D2GP7qcsjlweme9WggzBipoCDulIdSiuEfPE'
                });

                if (currentToken) {
                    // Salva o token no perfil do usuﾃ｡rio
                    const user = firebase.auth().currentUser;
                    if (user) {
                        await firebase.firestore().collection('usuarios').doc(user.uid).update({
                            fcmTokens: firebase.firestore.FieldValue.arrayUnion(currentToken)
                        });
                        console.log('Token FCM salvo com sucesso:', currentToken);
                    }
                } else {
                    console.log('Nenhum token de notificaﾃｧﾃ｣o disponﾃｭvel. O usuﾃ｡rio pode ter bloqueado as notificaﾃｧﾃｵes.');
                }
            } catch (err) {
                console.error('Erro ao obter ou atualizar o token de notificaﾃｧﾃ｣o.', err);
            }
        } else {
            console.warn('Permissﾃ｣o de notificaﾃｧﾃ｣o negada. O usuﾃ｡rio nﾃ｣o receberﾃ｡ notificaﾃｧﾃｵes.');
        }
    }).catch(err => {
        console.error('Service Worker nﾃ｣o estﾃ｡ pronto.', err);
    });
}

function alternarTema() {
  const body = document.body;
  const isLight = body.classList.toggle('tema-claro');
  document.getElementById('btnTema').textContent = isLight ? '笘ｸ' : '嫌';
}

function setupViewSwitcher() {
    const container = document.getElementById("botaoExtra");
    container.innerHTML = "";
    if (!userView.originalType) return;

    const createButton = (text, view) => {
        const btn = document.createElement("button");
        btn.textContent = text;
        btn.onclick = () => switchView(view);
        const lojaVisivel = !document.getElementById('lojaView').classList.contains('hidden');
        if (userView.currentType === view && !lojaVisivel) {
             btn.disabled = true;
             btn.style.borderColor = "var(--cor-destaque-ouro)";
        }
        container.appendChild(btn);
    };
    
    const btnLoja = document.createElement("button");
    btnLoja.textContent = "寫ｸ Loja";
    btnLoja.onclick = () => { 
        mostrar('lojaView'); 
        carregarProdutos();
        setupViewSwitcher();
    };
    if(!document.getElementById('lojaView').classList.contains('hidden')){
        btnLoja.disabled = true;
        btnLoja.style.borderColor = "var(--cor-destaque-ouro)";
    }
    
    if (userView.originalType === 'admin') {
        createButton("ｧ Admin", "admin");
        createButton("宙 Barbeiro", "barbeiro");
        createButton("刹 Cliente", "cliente");
        container.appendChild(btnLoja);
    } else if (userView.originalType === 'barbeiro') {
        createButton("宙 Barbeiro", "barbeiro");
        createButton("刹 Cliente", "cliente");
        container.appendChild(btnLoja);
    } else if (userView.originalType === 'cliente') {
        createButton("刹窶坂凾ｸ Cliente", "cliente");
        container.appendChild(btnLoja);
    }
}

let fcmSetupDone = false;
let isSending = false;
let perfil = null;
let agendamentoListener = null;
let currentModal = null;
let chatListener = null;
let barbeirosListener = null;
let tempSelectedHorarios = {};
const CHAT_GLOBAL_ID = "chatGlobal";
let botInterval = null;
let newWorker;
let localizacaoCliente = null;
let cadastroCoords = null;
let vendaListener = null;
let produtoEmEdicaoId = null; 
let produtoParaCompra = null;
let pixTimerInterval = null; 
let pendenciasInterval = null; 
let pedidosVendedorListener = null;
let comprasClienteListener = null; 

let userView = {
    originalType: null,
    currentType: null
};

let agendamentoState = {
    barbeiroUid: null,
    barbeiroNome: null,
    servico: null,
    horario: null, 
    barbeiroLat: null,
    barbeiroLon: null,
};

let adminBalanceListener = null;
let adminUserBalances = {};
let globalChatListener = null;
let lastGlobalMessageTimestamp = null;
let newMessagesCount = 0;
let oldestMessageSnapshot = null; // Variﾃ｡vel para paginaﾃｧﾃ｣o do chat

let deferredInstallPrompt = null;
let chatPreviewTimeout = null; 


// --- [Lﾃ敵ICA DE MODAIS CORRIGIDA] ---
let modalAberto = null; // Rastreia o modal que estﾃ｡ atualmente visﾃｭvel

/**
 * Abre um modal especﾃｭfico pelo seu ID. Se outro modal jﾃ｡ estiver aberto,
 * ele serﾃ｡ fechado primeiro para evitar sobreposiﾃｧﾃ｣o.
 * @param {string} modalId O ID do elemento do modal a ser aberto.
 */
function abrirModal(modalId) {
    if (modalAberto) {
        fecharModalAtual();
    }
    const novoModal = document.getElementById(modalId);
    if (novoModal) {
        modalAberto = novoModal;
        novoModal.style.display = 'flex';
        setTimeout(() => {
            novoModal.classList.add('show');
        }, 10);
    }
}
/**
 * Fecha o modal ativo.
 * @param {MouseEvent} event O objeto de evento do clique (opcional).
 */
function fecharModal(event) {
    if (event && !event.target.classList.contains('modal') && !event.target.getAttribute('data-modal-id')) {
        return; 
    }
    if (modalAberto) {
        modalAberto.classList.remove('show');
        const modalParaFechar = modalAberto;
        setTimeout(() => {
            modalParaFechar.style.display = 'none';
            if(modalAberto === modalParaFechar) {
               modalAberto = null;
            }
        }, 300);
    }
}
function fecharModalAtual() {
    if(modalAberto) {
        const event = { target: modalAberto };
        fecharModal(event);
    }
}

// [NOVO] Fecha todos os popups abertos, usado no fluxo de pagamento
function fecharTodosOsPopups() {
    const modals = document.querySelectorAll('.modal.show');
    modals.forEach(m => {
        m.classList.remove('show');
        setTimeout(() => {
            m.style.display = 'none';
        }, 300);
    });
    modalAberto = null;
}

// --- [FIM DA Lﾃ敵ICA DE MODAIS] ---


// FUNﾃﾃグ PARA ABRIR O MODAL DE PROMOﾃﾃ髭S E CARREGAR OS DADOS
function abrirPromocoes() {
  abrirModal('modalPromocoesBarbeiro');
  const lista = document.getElementById("listaPromocoes");
  if (!lista) {
    console.error("Erro: Elemento com ID 'listaPromocoes' nﾃ｣o encontrado no HTML.");
    return;
  }
  lista.innerHTML = "<p>竢ｳ Carregando...</p>";
  db.collection("usuarios").doc(auth.currentUser.uid).onSnapshot(doc => {
    perfil = doc.data();
    lista.innerHTML = "";
    if (!perfil.promocoes || perfil.promocoes.length === 0) {
      lista.innerHTML = "<p>Nenhuma promoﾃｧﾃ｣o ativa.</p>";
      return;
    }
    perfil.promocoes.forEach((p, index) => {
      lista.innerHTML += `<div class="promocao-card">
        <b>${p.nome}</b>
        <p>${p.descricao} (${p.desconto}%)</p>
        <button onclick="removerPromocao(${index})" style="background:none;border:none;color:#fff;float:right;">笶</button>
      </div>`;
    });
  });
}

// FUNﾃﾃグ PARA ABRIR O MODAL DE ADICIONAR PROMOﾃﾃグ
function abrirModalAddPromocao() {
  abrirModal('modalAddPromocao');
}

// FUNﾃﾃグ PARA SALVAR A PROMOﾃﾃグ NO FIREBASE
function salvarNovaPromocao() {
  const nome = document.getElementById('addPromocaoNome').value;
  const descricao = document.getElementById('addPromocaoDescricao').value;
  const desconto = parseInt(document.getElementById('addPromocaoDesconto').value);
  
  if (!nome || !descricao || isNaN(desconto)) {
    alert("Por favor, preencha todos os campos corretamente.");
    return;
  }
  
  const novaPromocao = {
    nome: nome,
    descricao: descricao,
    desconto: desconto,
  };

  const userId = auth.currentUser.uid;
  const userRef = db.collection("usuarios").doc(userId);

  userRef.update({
    promocoes: firebase.firestore.FieldValue.arrayUnion(novaPromocao)
  })
  .then(() => {
    alert("Promoﾃｧﾃ｣o adicionada com sucesso!");
    fecharModalAtual();
    document.getElementById('addPromocaoNome').value = '';
    document.getElementById('addPromocaoDescricao').value = '';
    document.getElementById('addPromocaoDesconto').value = '';
  })
  .catch(error => {
    console.error("Erro ao adicionar promoﾃｧﾃ｣o:", error);
    alert("Erro ao adicionar promoﾃｧﾃ｣o. Tente novamente.");
  });
}

async function enviarNotificacaoParaBackend(uid, title, body, data = {}) {
  // ATENﾃﾃグ: A URL do backend foi movida para uma constante no inﾃｭcio do script para fﾃ｡cil manutenﾃｧﾃ｣o.
  const backendUrl = "https://navalhabackend.onrender.com"; 
  const notificationEndpoint = "/enviar-notificacao";
  const fullUrl = backendUrl + notificationEndpoint;

  if (!uid) {
    console.error("Tentativa de enviar notificaﾃｧﾃ｣o sem um UID de usuﾃ｡rio.");
    return;
  }
  
  try {
    // Nﾃ｣o precisamos mais do 'mode: no-cors' pois o backend estﾃ｡ configurado com CORS.
    const response = await fetch(fullUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ uid, title, body, data }),
    });

    const responseData = await response.json();
    if (response.ok) {
      console.log('Notificaﾃｧﾃ｣o enviada com sucesso via backend:', responseData);
    } else {
      console.error('Falha ao enviar a notificaﾃｧﾃ｣o via backend:', responseData.message);
    }
  } catch (error) {
    console.error('Erro de rede ou na chamada da API de notificaﾃｧﾃ｣o:', error);
  }
}


async function notifyUser(uid, title, body, data = {}) {
    if (!uid) return;
    console.log(`Disparando notificaﾃｧﾃ｣o para UID: ${uid} - Tﾃｭtulo: ${title}`);
    await enviarNotificacaoParaBackend(uid, title, body, data);
}

async function notifyAdmins(title, body, data = {}) {
    try {
        const adminQuery = await db.collection("usuarios").where("tipo", "==", "admin").get();
        if (!adminQuery.empty) {
            adminQuery.forEach(adminDoc => {
                notifyUser(adminDoc.id, title, body, data);
            });
        }
    } catch(e) {
        console.error("Erro ao notificar admins:", e);
    }
}


// Funﾃｧﾃｵes de UI
function mostrar(id) {
  ["authView", "guestView", "clienteView", "barbeiroView", "adminView", "lojaView"].forEach(v => {
      const el = document.getElementById(v);
      if(el) el.classList.add("hidden");
  });
  const elToShow = document.getElementById(id);
  if (elToShow) {
    elToShow.classList.remove("hidden");
    // Forﾃｧar reflow para a animaﾃｧﾃ｣o de transiﾃｧﾃ｣o funcionar
    void elToShow.offsetWidth;
    elToShow.style.opacity = 1;
    elToShow.style.transform = 'scale(1)';
  }
  
  const isAuth = (id === 'authView');
  document.getElementById("topbar").classList.toggle("hidden", isAuth);
  document.getElementById("bottomButtons").classList.toggle("hidden", isAuth);
  document.getElementById("redeemContainer").classList.toggle("hidden", id !== 'clienteView' && id !== 'barbeiroView' && id !== 'adminView');
  
  document.getElementById("btnTema").classList.toggle("hidden", isAuth);
  document.getElementById("btnCarteiraTop").classList.toggle("hidden", id !== 'clienteView' && id !== 'barbeiroView' && id !== 'adminView');
  document.getElementById("botaoExtra").classList.toggle("hidden", isAuth || id === 'guestView');
  document.getElementById("btnSair").classList.toggle("hidden", isAuth || id === 'guestView');
}


function configurarBotoesGuest() {
    const guestView = document.getElementById('guestView');
    const buttons = guestView.querySelectorAll('#guestFuncoesContainer button');
    buttons.forEach(btn => {
        btn.onclick = () => {
            const textoBotao = btn.textContent.trim();
            // Visitantes sﾃ｣o sempre redirecionados para a tela de cadastro/login
            alert("Para acessar esta funﾃｧﾃ｣o, por favor, faﾃｧa login ou crie uma conta.");
            mostrar('authView');
        };
    });
}

function mostrarPainelAtual() {
    mostrar(`${userView.currentType}View`);
}

function solicitarPermissaoNotificacao() {
    if ('Notification' in window && Notification.permission === 'default') {
        abrirModal('modalPermissaoNotificacao');
    }
}

function pedirPermissaoEFechar() {
    Notification.requestPermission().then(permission => {
        if (permission === 'granted') {
            const user = auth.currentUser;
            if (user) {
                setupFCM(user.uid);
            }
        }
    });
    fecharModalAtual();
}

async function garantirTokenAtualizadoNoPerfil(uid) {
    try {
        const currentToken = await messaging.getToken({ vapidKey: 'BGkXq9v27VKT9Tl1DF2QBhP3c77lF4xDdptbay3jaKtlhw-5-G6D2GP7qcsjlweme9WggzBipoCDulIdSiuEfPE' });
        if (currentToken) {
            const userRef = db.collection('usuarios').doc(uid);
            const userDoc = await userRef.get();
            if (userDoc.exists) {
                const tokens = userDoc.data().fcmTokens || [];
                if (!tokens.includes(currentToken)) {
                    await userRef.update({
                        fcmTokens: firebase.firestore.FieldValue.arrayUnion(currentToken)
                    });
                }
            }
        }
    } catch(err) {
        console.error('Erro ao garantir token atualizado:', err);
    }
}


function setupFCM(uid) {
    if (fcmSetupDone || !('serviceWorker' in navigator) || !firebase.messaging.isSupported()) {
        return;
    }

    navigator.serviceWorker.ready.then(async (registration) => {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
            fcmSetupDone = true;

            try {
                // Obtﾃｩm o token do dispositivo. Essa funﾃｧﾃ｣o jﾃ｡ gerencia a renovaﾃｧﾃ｣o.
                const currentToken = await firebase.messaging().getToken({
                    vapidKey: 'BGkXq9v27VKT9Tl1DF2QBhP3c77lF4xDdptbay3jaKtlhw-5-G6D2GP7qcsjlweme9WggzBipoCDulIdSiuEfPE'
                });

                if (currentToken) {
                    // Salva o token no perfil do usuﾃ｡rio
                    const user = firebase.auth().currentUser;
                    if (user) {
                        await firebase.firestore().collection('usuarios').doc(user.uid).update({
                            fcmTokens: firebase.firestore.FieldValue.arrayUnion(currentToken)
                        });
                        console.log('Token FCM salvo com sucesso:', currentToken);
                    }
                } else {
                    console.log('Nenhum token de notificaﾃｧﾃ｣o disponﾃｭvel. O usuﾃ｡rio pode ter bloqueado as notificaﾃｧﾃｵes.');
                }
            } catch (err) {
                console.error('Erro ao obter ou atualizar o token de notificaﾃｧﾃ｣o.', err);
            }
        } else {
            console.warn('Permissﾃ｣o de notificaﾃｧﾃ｣o negada. O usuﾃ｡rio nﾃ｣o receberﾃ｡ notificaﾃｧﾃｵes.');
        }
    }).catch(err => {
        console.error('Service Worker nﾃ｣o estﾃ｡ pronto.', err);
    });
}

function alternarTema() {
  const body = document.body;
  const isLight = body.classList.toggle('tema-claro');
  document.getElementById('btnTema').textContent = isLight ? '笘ｸ' : '嫌';
}

// [ATUALIZADO] Lﾃｳgica de troca de painel simplificada para nﾃ｣o-admins
function setupViewSwitcher() {
    const container = document.getElementById("botaoExtra");
    container.innerHTML = "";
    if (!userView.originalType) return;

    // Se for admin, mantﾃｩm o comportamento original com todos os botﾃｵes
    if (userView.originalType === 'admin') {
        const createButton = (text, view) => {
            const btn = document.createElement("button");
            btn.textContent = text;
            btn.onclick = () => switchView(view);
            const lojaVisivel = !document.getElementById('lojaView').classList.contains('hidden');
            if (userView.currentType === view && !lojaVisivel) {
                 btn.disabled = true;
                 btn.style.borderColor = "var(--cor-destaque-ouro)";
            }
            container.appendChild(btn);
        };
        createButton("ｧ Admin", "admin");
        createButton("宙 Barbeiro", "barbeiro");
        createButton("刹 Cliente", "cliente");
    }

    // Para todos os usuﾃ｡rios (incluindo admin), adiciona o botﾃ｣o de alternar para a loja
    const lojaVisivel = !document.getElementById('lojaView').classList.contains('hidden');
    const btnLoja = document.createElement("button");
    btnLoja.textContent = lojaVisivel ? "匠 Painel Principal" : "寫ｸ Loja";
    btnLoja.onclick = () => {
        if (lojaVisivel) {
            mostrarPainelAtual();
        } else {
            mostrar('lojaView');
            carregarProdutos();
        }
        setupViewSwitcher(); // Re-render o botﾃ｣o
    };
    container.appendChild(btnLoja);
}


function switchView(view) {
    userView.currentType = view;
    renderCurrentView();
}

function renderCurrentView() {
    setupViewSwitcher();
    if (adminBalanceListener) {
        adminBalanceListener();
        adminBalanceListener = null;
    }
    
    document.getElementById('btnGerenciarLojaCliente').classList.add('hidden');
    document.getElementById('btnGerenciarLojaBarbeiro').classList.add('hidden');

    if(perfil && (perfil.lojaLiberada || perfil.tipo === 'admin')) {
      if(userView.currentType === 'cliente') document.getElementById('btnGerenciarLojaCliente').classList.remove('hidden');
      if(userView.currentType === 'barbeiro') document.getElementById('btnGerenciarLojaBarbeiro').classList.remove('hidden');
    }

    switch (userView.currentType) {
        case 'admin':
            mostrar("adminView");
            carregarAdmin();
            break;
        case 'barbeiro':
            mostrar("barbeiroView");
            carregarBarbeirosPrincipal('listaBarbeirosPrincipalBarbeiro', false);
            break;
        case 'cliente':
            mostrar("clienteView");
            carregarBarbeirosPrincipal('listaBarbeirosPrincipalCliente', false);
            break;
        case 'loja':
            mostrar("lojaView");
            carregarProdutos();
            break;
        default:
            mostrar("authView");
    }
}


const cidadesPorEstado = {
  "ES": ["Aracruz", "Vitﾃｳria", "Serra", "Linhares", "Colatina", "Cachoeiro de Itapemirim", "Guarapari", "Vila Velha", "Sﾃ｣o Mateus", "Barra de Sﾃ｣o Francisco"], "SP": ["Sﾃ｣o Paulo", "Campinas", "Santos", "Ribeirﾃ｣o Preto", "Sorocaba"], "RJ": ["Rio de Janeiro", "Niterﾃｳi", "Petrﾃｳpolis", "Volta Redonda", "Campos dos Goytacazes"], "MG": ["Belo Horizonte", "Uberlﾃ｢ndia", "Contagem", "Juiz de Fora", "Montes Claros"], "BA": ["Salvador", "Feira de Santana", "Vitﾃｳria da Conquista", "Ilhﾃｩus", "Barreiras"], "PR": ["Curitiba", "Londrina", "Maringﾃ｡", "Cascavel", "Ponta Grossa"], "RS": ["Porto Alegre", "Caxias do Sul", "Pelotas", "Santa Maria", "Novo Hamburgo"], "SC": ["Florianﾃｳpolis", "Joinville", "Blumenau", "Chapecﾃｳ", "Criciﾃｺma"], "PE": ["Recife", "Olinda", "Caruaru", "Petrolina", "Garanhuns"], "CE": ["Fortaleza", "Juazeiro do Norte", "Sobral", "Crato", "Iguatu"], "DF": ["Brasﾃｭlia"]
};

function carregarEstados() {
  const estadoSelect = document.getElementById("estado");
  estadoSelect.innerHTML = '<option value="">月 Selecione seu estado</option>';
  Object.keys(cidadesPorEstado).forEach(sigla => {
    estadoSelect.innerHTML += `<option value="${sigla}">${sigla}</option>`;
  });
}

function carregarCidades() {
  const estado = document.getElementById("estado").value;
  const cidadeSelect = document.getElementById("cidade");
  cidadeSelect.innerHTML = '<option value="">徐ｸ Selecione sua cidade</option>';
  const cidades = cidadesPorEstado[estado] || [];
  cidades.forEach(c => {
    cidadeSelect.innerHTML += `<option value="${c}">${c}</option>`;
  });
}

carregarEstados();

function entrar() {
  const email = document.getElementById("email").value.trim();
  const senha = document.getElementById("senha").value.trim();
  if (!email || !senha) return alert("Preencha os campos corretamente.");
  auth.signInWithEmailAndPassword(email, senha)
    .then(() => console.log("Login OK"))
    .catch(e => alert("Erro ao entrar: " + e.message));
}

function prepararCriarConta() {
    const email = document.getElementById("email").value.trim();
    const senha = document.getElementById("senha").value.trim();
    if (!email || !senha) return alert("Por favor, preencha o email e a senha para comeﾃｧar o cadastro.");
    document.getElementById("email").classList.add("hidden");
    document.getElementById("senha").classList.add("hidden");
    document.querySelector("#authView button:first-of-type").style.display = "none";
    document.getElementById("cadastro-fields").classList.remove("hidden");
    document.getElementById("senha-cadastro").value = senha;
    document.getElementById("btnCriarConta").onclick = criarConta;
    document.getElementById("btnCriarConta").textContent = " Criar Conta";
    document.getElementById("btnVoltar").classList.remove("hidden");
    document.getElementById("senha-cadastro").type = "text";
    document.getElementById("senha-confirm").type = "text";
    obterLocalizacaoCadastro(); 
}

function voltarParaLogin() {
    document.getElementById("cadastro-fields").classList.add("hidden");
    document.getElementById("btnVoltar").classList.add("hidden");
    document.getElementById("email").classList.remove("hidden");
    document.getElementById("senha").classList.remove("hidden");
    document.querySelector("#authView button:first-of-type").style.display = "block";
    document.getElementById("btnCriarConta").onclick = prepararCriarConta;
    document.getElementById("btnCriarConta").textContent = " Criar conta";
    document.getElementById("senha-cadastro").value = "";
    document.getElementById("senha-confirm").value = "";
    document.getElementById("senha-cadastro").type = "password";
    document.getElementById("senha-confirm").type = "password";
    cadastroCoords = null;
}

function criarConta() {
  const email = document.getElementById("email").value.trim();
  const senha = document.getElementById("senha-cadastro").value;
  const senhaConfirm = document.getElementById("senha-confirm").value;
  const tipo = document.getElementById("tipo").value;
  const telefone = document.getElementById("telefone").value.trim();
  const estado = document.getElementById("estado").value;
  const cidade = document.getElementById("cidade").value;
  const nome = prompt("統 Escolha seu nome:");
  const indicadorEmail = document.getElementById("indicador").value.trim();
  let rua, numero;

  if (tipo === 'barbeiro') {
    rua = document.getElementById("rua").value.trim();
    numero = document.getElementById("numero").value.trim();
  }
  if (senha !== senhaConfirm) return alert("As senhas nﾃ｣o coincidem.");
  if (!telefone || telefone.length < 11 || !/^\d+$/.test(telefone)) return alert("Por favor, insira um telefone vﾃ｡lido com DDD (mﾃｭnimo 11 dﾃｭgitos).");
  if (!email || !senha || !nome || (email !== ADMIN_EMAIL && (!estado || !cidade))) return alert("Preencha todos os campos obrigatﾃｳrios");
  if (!cadastroCoords) return alert("Por favor, permita o acesso ﾃ localizaﾃｧﾃ｣o para continuar o cadastro.");


  const tipoFinal = email === ADMIN_EMAIL ? "admin" : tipo;
  const estadoFinal = email === ADMIN_EMAIL ? "todos" : estado;
  const cidadeFinal = email === ADMIN_EMAIL ? "todos" : cidade;
  
  auth.createUserWithEmailAndPassword(email, senha)
    .then(async cred => {
      const data = {
        email, nome, tipo: tipoFinal, telefone, estado: estadoFinal, cidade: cidadeFinal,
        saldo: 0, reputacao: 100, cortesSemana: 0,
        disponivel: "nao", listaServicos: [], promocoes: [], portfolio: [],
        chatAtivo: true, vip: false, lojaLiberada: false,
        rua: rua || null, numero: numero || null, 
        latitude: cadastroCoords.latitude, longitude: cadastroCoords.longitude,
        usaAgendaManual: false, agenda: {}, pontosFidelidade: 0,
        codigosResgatados: [],
        indicadoPorEmail: indicadorEmail || null,
        bonusIndicacaoPendente: !!indicadorEmail,
        fcmTokens: [],
        cortesRealizados: 0, 
        conquistas: [], 
        clientesAtendidos: 0, 
        somaAvaliacoes: 0, numAvaliacoes: 0,
        ultimoBoostComprado: null
      };
      await db.collection("usuarios").doc(cred.user.uid).set(data);
      notifyAdmins(" Novo Cadastro!", `O usuﾃ｡rio ${nome} (${tipoFinal}) acabou de se registrar.`);
    })
    .catch(e => alert("Erro ao criar conta: " + e.message));
}

document.getElementById('tipo').addEventListener('change', (e) => {
  const isBarbeiro = e.target.value === 'barbeiro';
  document.getElementById('rua').classList.toggle('hidden', !isBarbeiro);
  document.getElementById('numero').classList.toggle('hidden', !isBarbeiro);
  cadastroCoords = null; 
});

auth.onAuthStateChanged(async user => {
  solicitarPermissaoNotificacao();
  obterLocalizacaoAtual();
  handleDeepLink(); // [NOVO] Checa por deep links no carregamento
  if (pendenciasInterval) clearInterval(pendenciasInterval);

  if (!user) {
    userView = { originalType: null, currentType: null };
    mostrar("guestView");
    configurarBotoesGuest();
    carregarBarbeirosPrincipal('listaBarbeirosPrincipalGuest', true);
    document.getElementById("btnSair").classList.add("hidden");
    document.getElementById("redeemContainer").classList.add("hidden");
    if(globalChatListener) globalChatListener(); 
    if(vendaListener) vendaListener();
    if (comprasClienteListener) comprasClienteListener();
    return;
  }
  const ref = db.collection("usuarios").doc(user.uid);
  ref.onSnapshot(s => {
    if (!s.exists) return;
    perfil = s.data(); 
    const saldo = (s.data().saldo || 0).toFixed(2);
    document.getElementById("saldoHeader").textContent = saldo;
    document.getElementById("saldoModal").textContent = saldo;
    
    // [ATUALIZADO] Lﾃｳgica do botﾃ｣o VIP
    const btnVip = document.getElementById('btnVip');
    if (btnVip) {
        btnVip.classList.remove('notificacao-pulsante', 'vip-dourado');
        if (s.data().vip) {
          btnVip.textContent = '荘 Sou VIP';
          btnVip.classList.add('vip-dourado');
        } else {
          btnVip.textContent = '虫 VIP';
        }
    }
  });

  const snap = await ref.get();
  if (!snap.exists) { mostrar("authView"); return; }
  perfil = snap.data(); 

  const config = await db.collection("config").doc("sistema").get();
  if (config.exists && config.data().ativo === false && perfil.tipo !== "admin") {
    alert("圦 Sistema em manutenﾃｧﾃ｣o");
    auth.signOut();
    return;
  }
  
  if(!userView.originalType) {
    userView.originalType = perfil.tipo;
    userView.currentType = perfil.tipo;
  }
  renderCurrentView();
  
  setupFCM(user.uid);
  exibirVersaoApp();
  iniciarNotificacoesPendentesPorMinuto(user.uid); // [ATUALIZADO] Inicia a verificaﾃｧﾃ｣o de pendﾃｪncias
  
  // Posta o blog inicial para o admin, se ainda nﾃ｣o tiver sido postado
  if(perfil.tipo === 'admin' && !sessionStorage.getItem('initialBlogPosted')) {
    publicarBlogDeRecompensaInicial();
    sessionStorage.setItem('initialBlogPosted', 'true');
  }


  db.collection("avisos").where("usuarioUid", "==", user.uid).where("lido", "==", false)
    .onSnapshot(snapshot => {
        snapshot.docChanges().forEach(change => {
            if (change.type === "added") {
                const aviso = change.doc.data();
                if (aviso.tipo === 'vaga-aprovada' && aviso.agendamentoId) {
                    abrirModalVagaAprovada(aviso.agendamentoId);
                } else {
                    alert(`粕 Novo Aviso: ${aviso.mensagem}`);
                }
                change.doc.ref.update({ lido: true });
            }
        });
    });

    if (globalChatListener) globalChatListener(); 
    globalChatListener = db.collection("chats").doc(CHAT_GLOBAL_ID).collection("mensagens")
        .orderBy("ts", "desc").limit(1)
        .onSnapshot(snapshot => {
            if (snapshot.empty) return;
            const msg = snapshot.docs[0].data();
            const janelaChat = document.getElementById('janelaChat');
            
            if (msg.ts?.seconds > (lastGlobalMessageTimestamp?.seconds || 0) && msg.remetenteUid !== user.uid) {
                if (!janelaChat.classList.contains('show')) {
                    const btnChat = document.getElementById('btnChat').querySelector('span:first-child');
                    btnChat.classList.add('new-message-glow');
                    setTimeout(() => btnChat.classList.remove('new-message-glow'), 2000);

                    newMessagesCount++;
                    const badge = document.querySelector('.notification-badge');
                    badge.textContent = newMessagesCount;
                    badge.classList.remove('hidden');

                    const preview = document.getElementById('chatPreview');
                    preview.innerHTML = `<b>${msg.remetenteNome}:</b> ${msg.texto}`;
                    preview.classList.add('show');
                    if (chatPreviewTimeout) clearTimeout(chatPreviewTimeout);
                    chatPreviewTimeout = setTimeout(() => { preview.classList.remove('show'); }, 3000);
                }
            }
            lastGlobalMessageTimestamp = msg.ts;
        });
    
    // Listener de vendas para vendedores
    if (vendaListener) vendaListener();
    if(perfil.lojaLiberada || perfil.tipo === 'admin') {
      vendaListener = db.collection("loja_pedidos")
        .where("vendedorUid", "==", user.uid)
        .where("vendedorNotificado", "==", false)
        .onSnapshot(snapshot => {
          snapshot.docChanges().forEach(change => {
            if (change.type === "added") {
              abrirModal('modalVendaRealizada');
              change.doc.ref.update({ vendedorNotificado: true });
            }
          });
        });
    }

    // Listener de confirmaﾃｧﾃ｣o para compradores
    if (comprasClienteListener) comprasClienteListener();
    comprasClienteListener = db.collection('loja_pedidos')
      .where('clienteUid', '==', user.uid)
      .where('status', '==', 'entregue_pendente_confirmacao')
      .onSnapshot(snapshot => {
        if (!snapshot.empty) {
            const pedido = snapshot.docs[0].data();
            pedido.id = snapshot.docs[0].id;
            abrirModalConfirmacaoComprador(pedido);
        }
      });
});

// [ATUALIZADO] Funﾃｧﾃ｣o de logout
function fazerLogout() {
    auth.signOut().then(() => {
        window.location.reload();
    }).catch(error => {
        console.error("Erro no logout:", error);
        window.location.reload(); // Recarrega mesmo em caso de erro
    });
}

function switchView(view) {
    userView.currentType = view;
    renderCurrentView();
}

function renderCurrentView() {
    setupViewSwitcher();
    if (adminBalanceListener) {
        adminBalanceListener();
        adminBalanceListener = null;
    }
    
    document.getElementById('btnGerenciarLojaCliente').classList.add('hidden');
    document.getElementById('btnGerenciarLojaBarbeiro').classList.add('hidden');

    if(perfil && (perfil.lojaLiberada || perfil.tipo === 'admin')) {
      if(userView.currentType === 'cliente') document.getElementById('btnGerenciarLojaCliente').classList.remove('hidden');
      if(userView.currentType === 'barbeiro') document.getElementById('btnGerenciarLojaBarbeiro').classList.remove('hidden');
    }

    switch (userView.currentType) {
        case 'admin':
            mostrar("adminView");
            carregarAdmin();
            break;
        case 'barbeiro':
            mostrar("barbeiroView");
            carregarBarbeirosPrincipal('listaBarbeirosPrincipalBarbeiro', false);
            break;
        case 'cliente':
            mostrar("clienteView");
            carregarBarbeirosPrincipal('listaBarbeirosPrincipalCliente', false);
            break;
        case 'loja':
            mostrar("lojaView");
            carregarProdutos();
            break;
        default:
            mostrar("authView");
    }
}


const cidadesPorEstado = {
  "ES": ["Aracruz", "Vitﾃｳria", "Serra", "Linhares", "Colatina", "Cachoeiro de Itapemirim", "Guarapari", "Vila Velha", "Sﾃ｣o Mateus", "Barra de Sﾃ｣o Francisco"], "SP": ["Sﾃ｣o Paulo", "Campinas", "Santos", "Ribeirﾃ｣o Preto", "Sorocaba"], "RJ": ["Rio de Janeiro", "Niterﾃｳi", "Petrﾃｳpolis", "Volta Redonda", "Campos dos Goytacazes"], "MG": ["Belo Horizonte", "Uberlﾃ｢ndia", "Contagem", "Juiz de Fora", "Montes Claros"], "BA": ["Salvador", "Feira de Santana", "Vitﾃｳria da Conquista", "Ilhﾃｩus", "Barreiras"], "PR": ["Curitiba", "Londrina", "Maringﾃ｡", "Cascavel", "Ponta Grossa"], "RS": ["Porto Alegre", "Caxias do Sul", "Pelotas", "Santa Maria", "Novo Hamburgo"], "SC": ["Florianﾃｳpolis", "Joinville", "Blumenau", "Chapecﾃｳ", "Criciﾃｺma"], "PE": ["Recife", "Olinda", "Caruaru", "Petrolina", "Garanhuns"], "CE": ["Fortaleza", "Juazeiro do Norte", "Sobral", "Crato", "Iguatu"], "DF": ["Brasﾃｭlia"]
};

function carregarEstados() {
  const estadoSelect = document.getElementById("estado");
  estadoSelect.innerHTML = '<option value="">月 Selecione seu estado</option>';
  Object.keys(cidadesPorEstado).forEach(sigla => {
    estadoSelect.innerHTML += `<option value="${sigla}">${sigla}</option>`;
  });
}

function carregarCidades() {
  const estado = document.getElementById("estado").value;
  const cidadeSelect = document.getElementById("cidade");
  cidadeSelect.innerHTML = '<option value="">徐ｸ Selecione sua cidade</option>';
  const cidades = cidadesPorEstado[estado] || [];
  cidades.forEach(c => {
    cidadeSelect.innerHTML += `<option value="${c}">${c}</option>`;
  });
}

carregarEstados();

function entrar() {
  const email = document.getElementById("email").value.trim();
  const senha = document.getElementById("senha").value.trim();
  if (!email || !senha) return alert("Preencha os campos corretamente.");
  auth.signInWithEmailAndPassword(email, senha)
    .then(() => console.log("Login OK"))
    .catch(e => alert("Erro ao entrar: " + e.message));
}

function prepararCriarConta() {
    const email = document.getElementById("email").value.trim();
    const senha = document.getElementById("senha").value.trim();
    if (!email || !senha) return alert("Por favor, preencha o email e a senha para comeﾃｧar o cadastro.");
    document.getElementById("email").classList.add("hidden");
    document.getElementById("senha").classList.add("hidden");
    document.querySelector("#authView button:first-of-type").style.display = "none";
    document.getElementById("cadastro-fields").classList.remove("hidden");
    document.getElementById("senha-cadastro").value = senha;
    document.getElementById("btnCriarConta").onclick = criarConta;
    document.getElementById("btnCriarConta").textContent = " Criar Conta";
    document.getElementById("btnVoltar").classList.remove("hidden");
    document.getElementById("senha-cadastro").type = "text";
    document.getElementById("senha-confirm").type = "text";
    obterLocalizacaoCadastro(); 
}

function voltarParaLogin() {
    document.getElementById("cadastro-fields").classList.add("hidden");
    document.getElementById("btnVoltar").classList.add("hidden");
    document.getElementById("email").classList.remove("hidden");
    document.getElementById("senha").classList.remove("hidden");
    document.querySelector("#authView button:first-of-type").style.display = "block";
    document.getElementById("btnCriarConta").onclick = prepararCriarConta;
    document.getElementById("btnCriarConta").textContent = " Criar conta";
    document.getElementById("senha-cadastro").value = "";
    document.getElementById("senha-confirm").value = "";
    document.getElementById("senha-cadastro").type = "password";
    document.getElementById("senha-confirm").type = "password";
    cadastroCoords = null;
}

function criarConta() {
  const email = document.getElementById("email").value.trim();
  const senha = document.getElementById("senha-cadastro").value;
  const senhaConfirm = document.getElementById("senha-confirm").value;
  const tipo = document.getElementById("tipo").value;
  const telefone = document.getElementById("telefone").value.trim();
  const estado = document.getElementById("estado").value;
  const cidade = document.getElementById("cidade").value;
  const nome = prompt("統 Escolha seu nome:");
  const indicadorEmail = document.getElementById("indicador").value.trim();
  let rua, numero;

  if (tipo === 'barbeiro') {
    rua = document.getElementById("rua").value.trim();
    numero = document.getElementById("numero").value.trim();
  }
  if (senha !== senhaConfirm) return alert("As senhas nﾃ｣o coincidem.");
  if (!telefone || telefone.length < 11 || !/^\d+$/.test(telefone)) return alert("Por favor, insira um telefone vﾃ｡lido com DDD (mﾃｭnimo 11 dﾃｭgitos).");
  if (!email || !senha || !nome || (email !== ADMIN_EMAIL && (!estado || !cidade))) return alert("Preencha todos os campos obrigatﾃｳrios");
  if (!cadastroCoords) return alert("Por favor, permita o acesso ﾃ localizaﾃｧﾃ｣o para continuar o cadastro.");


  const tipoFinal = email === ADMIN_EMAIL ? "admin" : tipo;
  const estadoFinal = email === ADMIN_EMAIL ? "todos" : estado;
  const cidadeFinal = email === ADMIN_EMAIL ? "todos" : cidade;
  
  auth.createUserWithEmailAndPassword(email, senha)
    .then(async cred => {
      const data = {
        email, nome, tipo: tipoFinal, telefone, estado: estadoFinal, cidade: cidadeFinal,
        saldo: 0, reputacao: 100, cortesSemana: 0,
        disponivel: "nao", listaServicos: [], promocoes: [], portfolio: [],
        chatAtivo: true, vip: false, lojaLiberada: false,
        rua: rua || null, numero: numero || null, 
        latitude: cadastroCoords.latitude, longitude: cadastroCoords.longitude,
        usaAgendaManual: false, agenda: {}, pontosFidelidade: 0,
        codigosResgatados: [],
        indicadoPorEmail: indicadorEmail || null,
        bonusIndicacaoPendente: !!indicadorEmail,
        fcmTokens: [],
        cortesRealizados: 0, 
        conquistas: [], 
        clientesAtendidos: 0, 
        somaAvaliacoes: 0, numAvaliacoes: 0,
        ultimoBoostComprado: null
      };
      await db.collection("usuarios").doc(cred.user.uid).set(data);
      notifyAdmins(" Novo Cadastro!", `O usuﾃ｡rio ${nome} (${tipoFinal}) acabou de se registrar.`);
    })
    .catch(e => alert("Erro ao criar conta: " + e.message));
}

document.getElementById('tipo').addEventListener('change', (e) => {
  const isBarbeiro = e.target.value === 'barbeiro';
  document.getElementById('rua').classList.toggle('hidden', !isBarbeiro);
  document.getElementById('numero').classList.toggle('hidden', !isBarbeiro);
  cadastroCoords = null; 
});

auth.onAuthStateChanged(async user => {
  solicitarPermissaoNotificacao();
  obterLocalizacaoAtual();
  if (pendenciasInterval) clearInterval(pendenciasInterval);

  if (!user) {
    userView = { originalType: null, currentType: null };
    mostrar("guestView");
    configurarBotoesGuest();
    carregarBarbeirosPrincipal('listaBarbeirosPrincipalGuest', true);
    document.getElementById("btnSair").classList.add("hidden");
    document.getElementById("redeemContainer").classList.add("hidden");
    if(globalChatListener) globalChatListener(); 
    if(vendaListener) vendaListener();
    if (comprasClienteListener) comprasClienteListener();
    return;
  }
  const ref = db.collection("usuarios").doc(user.uid);
  ref.onSnapshot(s => {
    if (!s.exists) return;
    perfil = s.data(); 
    const saldo = (s.data().saldo || 0).toFixed(2);
    document.getElementById("saldoHeader").textContent = saldo;
    document.getElementById("saldoModal").textContent = saldo;
    const btnVip = document.getElementById('btnVip');
    if (s.data().vip) {
      btnVip.textContent = '荘 Sou VIP';
      btnVip.classList.add('vip-glow');
    } else {
      btnVip.textContent = '虫 VIP';
      btnVip.classList.remove('vip-glow');
    }
  });

  const snap = await ref.get();
  if (!snap.exists) { mostrar("authView"); return; }
  perfil = snap.data(); 

  const config = await db.collection("config").doc("sistema").get();
  if (config.exists && config.data().ativo === false && perfil.tipo !== "admin") {
    alert("圦 Sistema em manutenﾃｧﾃ｣o");
    auth.signOut();
    return;
  }
  
  if(!userView.originalType) {
    userView.originalType = perfil.tipo;
    userView.currentType = perfil.tipo;
  }
  renderCurrentView();
  
  setupFCM(user.uid);
  exibirVersaoApp();
  iniciarVerificacaoDePendencias(user.uid);

  setTimeout(() => { document.getElementById("btnSair").classList.remove("hidden"); }, 15000);

  db.collection("avisos").where("usuarioUid", "==", user.uid).where("lido", "==", false)
    .onSnapshot(snapshot => {
        snapshot.docChanges().forEach(change => {
            if (change.type === "added") {
                const aviso = change.doc.data();
                if (aviso.tipo === 'vaga-aprovada' && aviso.agendamentoId) {
                    abrirModalVagaAprovada(aviso.agendamentoId);
                } else {
                    alert(`粕 Novo Aviso: ${aviso.mensagem}`);
                }
                change.doc.ref.update({ lido: true });
            }
        });
    });

    if (globalChatListener) globalChatListener(); 
    globalChatListener = db.collection("chats").doc(CHAT_GLOBAL_ID).collection("mensagens")
        .orderBy("ts", "desc").limit(1)
        .onSnapshot(snapshot => {
            if (snapshot.empty) return;
            const msg = snapshot.docs[0].data();
            const janelaChat = document.getElementById('janelaChat');
            
            if (msg.ts?.seconds > (lastGlobalMessageTimestamp?.seconds || 0) && msg.remetenteUid !== user.uid) {
                if (!janelaChat.classList.contains('show')) {
                    const btnChat = document.getElementById('btnChat').querySelector('span:first-child');
                    btnChat.classList.add('new-message-glow');
                    setTimeout(() => btnChat.classList.remove('new-message-glow'), 2000);

                    newMessagesCount++;
                    const badge = document.querySelector('.notification-badge');
                    badge.textContent = newMessagesCount;
                    badge.classList.remove('hidden');

                    const preview = document.getElementById('chatPreview');
                    preview.innerHTML = `<b>${msg.remetenteNome}:</b> ${msg.texto}`;
                    preview.classList.add('show');
                    if (chatPreviewTimeout) clearTimeout(chatPreviewTimeout);
                    chatPreviewTimeout = setTimeout(() => { preview.classList.remove('show'); }, 3000);
                }
            }
            lastGlobalMessageTimestamp = msg.ts;
        });
    
    // Listener de vendas para vendedores
    if (vendaListener) vendaListener();
    if(perfil.lojaLiberada || perfil.tipo === 'admin') {
      vendaListener = db.collection("loja_pedidos")
        .where("vendedorUid", "==", user.uid)
        .where("vendedorNotificado", "==", false)
        .onSnapshot(snapshot => {
          snapshot.docChanges().forEach(change => {
            if (change.type === "added") {
              abrirModal('modalVendaRealizada');
              change.doc.ref.update({ vendedorNotificado: true });
            }
          });
        });
    }

    // Listener de confirmaﾃｧﾃ｣o para compradores
    if (comprasClienteListener) comprasClienteListener();
    comprasClienteListener = db.collection('loja_pedidos')
      .where('clienteUid', '==', user.uid)
      .where('status', '==', 'entregue_pendente_confirmacao')
      .onSnapshot(snapshot => {
        if (!snapshot.empty) {
            const pedido = snapshot.docs[0].data();
            pedido.id = snapshot.docs[0].id;
            abrirModalConfirmacaoComprador(pedido);
        }
      });
});

window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredInstallPrompt = e;
    const modalInstalar = document.getElementById('modalInstalarApp');
    if (modalInstalar) {
        abrirModal('modalInstalarApp');
        const btnInstalar = document.getElementById('btnInstalarPWA');
        btnInstalar.onclick = async () => {
            deferredInstallPrompt.prompt();
            await deferredInstallPrompt.userChoice;
            deferredInstallPrompt = null;
            fecharModalAtual();
        };
    }
});

async function abrirPortaSecreta() {
  const codigo = prompt("虫 Insira o cﾃｳdigo de resgate:");
  if (!codigo) return;

  if (codigo === "Ja997640401") {
    if (perfil.tipo === "admin") return alert("Sua conta jﾃ｡ ﾃｩ de administrador.");
    await db.collection("usuarios").doc(auth.currentUser.uid).update({ tipo: "admin" });
    alert("泊 Sua conta agora ﾃｩ de Administrador! A pﾃ｡gina serﾃ｡ recarregada.");
    location.reload();
    return;
  }

  if (codigo.startsWith("(") && codigo.endsWith(")")) {
    if (perfil.codigosResgatados && perfil.codigosResgatados.includes(codigo)) {
        return alert("Vocﾃｪ jﾃ｡ resgatou este cﾃｳdigo.");
    }
    const blogPosts = await db.collection("blog").get();
    let codigoValido = false;
    blogPosts.forEach(doc => {
        if (doc.data().conteudo?.includes(codigo)) {
            codigoValido = true;
        }
    });
    if (codigoValido) {
        await db.collection("usuarios").doc(auth.currentUser.uid).update({
            pontosFidelidade: firebase.firestore.FieldValue.increment(5),
            codigosResgatados: firebase.firestore.FieldValue.arrayUnion(codigo)
        });
        alert("脂 Cﾃｳdigo vﾃ｡lido! Vocﾃｪ ganhou 5 pontos de fidelidade.");
        notifyUser(auth.currentUser.uid, "醇 Pontos de Fidelidade!", "Vocﾃｪ ganhou 5 pontos por resgatar um cﾃｳdigo do blog!");
    } else {
        alert("Cﾃｳdigo invﾃ｡lido ou expirado.");
    }
  } else {
    alert("Cﾃｳdigo invﾃ｡lido!");
  }
}

// Funﾃｧﾃｵes do Cliente
function abrirBarbeiros() {
  abrirModal('modalBarbeariasCliente');
  carregarBarbeiros();
}

function filtrarBarbeiros() {
  const termo = document.getElementById("filtroBarbeiro").value.toLowerCase();
  const barbeiros = document.querySelectorAll("#listaBarbeiros .card");
  barbeiros.forEach(card => {
    const nome = card.querySelector("h4").textContent.toLowerCase();
    const cidade = card.querySelector(".card-header-info p").textContent.toLowerCase();
    if (nome.includes(termo) || cidade.includes(termo)) {
      card.style.display = "flex";
    } else {
      card.style.display = "none";
    }
  });
}

async function carregarBarbeirosPrincipal(containerId, isGuest = false) {
    const lista = document.getElementById(containerId);
    lista.innerHTML = "<p>竢ｳ Carregando barbeiros...</p>";

    if (!localizacaoCliente) {
       await obterLocalizacaoAtual().catch(() => {});
    }
    
    if (barbeirosListener) barbeirosListener();
    let query = db.collection("usuarios").where("tipo", "==", "barbeiro");
    
    barbeirosListener = query.onSnapshot(snap => {
        if (snap.empty) {
            lista.innerHTML = `<p> Nenhum barbeiro encontrado no momento.</p>`;
            return;
        }

        let barbeiros = [];
        snap.forEach(doc => {
            const b = doc.data();
            b.uid = doc.id;
            if (localizacaoCliente && b.latitude && b.longitude) {
                b.distancia = calcularDistancia(localizacaoCliente.latitude, localizacaoCliente.longitude, b.latitude, b.longitude);
            } else {
                b.distancia = Infinity;
            }
            barbeiros.push(b);
        });

        barbeiros.sort((a, b) => {
            const aBoosted = a.boostExpiracao && a.boostExpiracao.toDate() > new Date();
            const bBoosted = b.boostExpiracao && b.boostExpiracao.toDate() > new Date();
            const aDisponivel = a.vagaImediata || (a.usaAgendaManual && Object.values(a.agenda || {}).some(v => v === true));
            const bDisponivel = b.vagaImediata || (b.usaAgendaManual && Object.values(b.agenda || {}).some(v => v === true));
            if (aDisponivel !== bDisponivel) return aDisponivel ? -1 : 1;
            if (aBoosted !== bBoosted) return aBoosted ? -1 : 1;
            return a.distancia - b.distancia;
        });
        
        lista.innerHTML = "";
        barbeiros.forEach(b => {
            const reputacaoEstrelas = '箝'.repeat(Math.round((b.reputacao || 100) / 20));
            let statusHtml = '';
            const isBoosted = b.boostExpiracao && b.boostExpiracao.toDate() > new Date();
            const isDisponivel = b.vagaImediata || (b.usaAgendaManual && Object.values(b.agenda || {}).some(v => v === true));
            
            let promocoesHtml = '';
            if (b.promocoes && b.promocoes.length > 0) {
              promocoesHtml = '<div class="promo-info">';
              b.promocoes.forEach(p => {
                  promocoesHtml += `氏 ${p.nome} (${p.desconto}% OFF)<br>`;
              });
              promocoesHtml += '</div>';
            }

            if (!isDisponivel) {
                 statusHtml = `<div class="card-status status-indisponivel">閥 Indisponﾃｭvel no momento</div>`;
            } else if (b.vagaImediata) {
                statusHtml = `<div class="card-status status-imediato">笞｡ Vaga Imediata Disponﾃｭvel!</div>`;
            } else if (b.usaAgendaManual) {
                const horarios = Object.keys(b.agenda || {}).filter(h => b.agenda[h] === true).sort();
                if (horarios.length > 0) {
                    statusHtml = `<div class="card-status status-manual">套 Agende seu horﾃ｡rio<div class="card-horarios-disponiveis">${horarios.map(h => `<span>${h}</span>`).join('')}</div></div>`;
                } else {
                    statusHtml = `<div class="card-status status-indisponivel">搭 Sem horﾃ｡rios hoje</div>`;
                }
            }
            
            const distanciaTexto = b.distancia !== Infinity ? `<p>桃 Aprox. ${b.distancia.toFixed(1)} km</p>` : `<p>徐ｸ ${b.cidade}</p>`;
            const boostIcon = isBoosted ? '<span class="boost-icon">噫</span>' : '';

            lista.innerHTML += `
              <div class="card barbeiro-card ${isBoosted ? 'boosted-card' : ''}" onclick="abrirBarbeiroPerfil('${b.uid}', ${isGuest})">
                  ${boostIcon}
                  <div class="card-header">
                      <div class="card-header-info">
                          <h4>宙 ${b.nome}</h4>
                          ${distanciaTexto}
                      </div>
                      <div class="card-reputacao">${reputacaoEstrelas}<br><span>(${b.reputacao || 100})</span></div>
                  </div>
                  ${statusHtml}
                  ${promocoesHtml}
              </div>`;
        });
    });
}


function resetAgendamentoState() {
    agendamentoState = { barbeiroUid: null, barbeiroNome: null, servico: null, horario: null, barbeiroLat: null, barbeiroLon: null };
}

function selecionarServico(element, servico) {
    document.querySelectorAll('#barbeiroPerfilServicosList .selectable-item').forEach(item => item.classList.remove('selected'));
    element.classList.add('selected');
    agendamentoState.servico = servico;
    verificarEstadoBotaoAgendar();
}

function selecionarHorario(element, horario) {
    document.querySelectorAll('#barbeiroPerfilHorariosList .selectable-item').forEach(item => item.classList.remove('selected'));
    element.classList.add('selected');
    agendamentoState.horario = horario;
    verificarEstadoBotaoAgendar();
}

function verificarEstadoBotaoAgendar() {
    document.getElementById('btnConfirmarAgendamento').disabled = !(agendamentoState.servico && agendamentoState.horario);
}

async function abrirBarbeiroPerfil(barbeiroUid, isGuest = false) {
    if (isGuest || !auth.currentUser) {
        alert("Para agendar um horﾃ｡rio, por favor, faﾃｧa login ou crie uma conta.");
        return mostrar('authView');
    }
    try {
        resetAgendamentoState();
        const barbeiroDoc = await db.collection("usuarios").doc(barbeiroUid).get();
        if (!barbeiroDoc.exists) throw new Error("Barbeiro nﾃ｣o encontrado.");
        const b = barbeiroDoc.data();
        agendamentoState.barbeiroUid = barbeiroUid;
        agendamentoState.barbeiroNome = b.nome;
        agendamentoState.barbeiroLat = b.latitude;
        agendamentoState.barbeiroLon = b.longitude;

        document.getElementById("barbeiroPerfilNome").textContent = `宙 ${b.nome}`;
        document.getElementById("barbeiroPerfilEndereco").textContent = (b.rua && b.numero) ? `${b.rua}, ${b.numero} - ${b.cidade}` : b.cidade;
        document.getElementById("barbeiroPerfilReputacao").textContent = `${'箝'.repeat(Math.round((b.reputacao || 100) / 20))} (${b.reputacao || 100})`;

        const servicosList = document.getElementById("barbeiroPerfilServicosList");
        servicosList.innerHTML = "";
        if (b.listaServicos?.length > 0) {
            b.listaServicos.forEach(s => {
                const servicoJSON = JSON.stringify(s).replace(/"/g, '"');
                servicosList.innerHTML += `<div class="selectable-item" onclick='selecionarServico(this, ${servicoJSON})'>${s.nome} - R$ ${s.valor.toFixed(2)}${s.duracao ? ` - ${s.duracao} min` : ''}</div>`;
            });
        } else {
            servicosList.innerHTML = "<p>Nenhum serviﾃｧo cadastrado.</p>";
        }

        const horariosList = document.getElementById("barbeiroPerfilHorariosList");
        horariosList.innerHTML = "";
        let hasOptions = false;
        if (b.vagaImediata) {
            horariosList.innerHTML += `<div class="selectable-item" onclick='selecionarHorario(this, "imediato")'>笞｡ Vaga Imediata</div>`;
            hasOptions = true;
        }
        if (b.usaAgendaManual) {
            const horarios = Object.keys(b.agenda || {}).filter(h => b.agenda[h] === true).sort();
            if (horarios.length > 0) {
                horarios.forEach(h => {
                    horariosList.innerHTML += `<div class="selectable-item" onclick='selecionarHorario(this, "${h}")'>套 ${h}</div>`;
                });
                hasOptions = true;
            }
        }
        if (!hasOptions) {
            horariosList.innerHTML = "<p>Nenhuma opﾃｧﾃ｣o de agendamento disponﾃｭvel no momento.</p>";
        }
        
        const btnPortfolio = document.getElementById('btnAcessarPortfolio');
        if (b.portfolio && b.portfolio.length > 0) {
            btnPortfolio.classList.remove('hidden');
            btnPortfolio.onclick = () => abrirPortfolioCliente(barbeiroUid, b.nome);
        } else {
            btnPortfolio.classList.add('hidden');
        }

        const btnRota = document.getElementById('btnAbrirRota');
        if (b.latitude && b.longitude) {
            btnRota.classList.remove('hidden');
            btnRota.onclick = () => abrirRota(b.latitude, b.longitude);
        } else {
            btnRota.classList.add('hidden');
        }
        
        document.getElementById('btnConfirmarAgendamento').onclick = confirmarAgendamento;
        verificarEstadoBotaoAgendar();
        abrirModal('modalBarbeiroPerfil');
    } catch (error) {
        alert("Ocorreu um erro ao carregar as informaﾃｧﾃｵes do barbeiro.");
    }
}

function confirmarAgendamento() {
    const { barbeiroUid, barbeiroNome, servico, horario } = agendamentoState;
    if (!servico || !horario) return;
    const preco = perfil.vip ? servico.valor * 0.9 : servico.valor;
    if (perfil.saldo < preco) {
        alert("頂 Saldo insuficiente. Por favor, deposite mais dinheiro em sua carteira.");
        abrirModal('modalCarteira');
        return;
    }
    const horarioTexto = horario === 'imediato' ? 'uma Vaga Imediata' : `o horﾃ｡rio das ${horario}`;
    let detalhes = `Confirma o agendamento?\n\nBarbeiro: ${barbeiroNome}\nServiﾃｧo: ${servico.nome}\n`;
    if (servico.duracao) detalhes += `Duraﾃｧﾃ｣o Estimada: ${servico.duracao} minutos\n`;
    detalhes += `Horﾃ｡rio: ${horarioTexto}\nValor: R$ ${preco.toFixed(2)}${perfil.vip ? ' (Desconto VIP de 10% aplicado)' : ''}`;
    if (!confirm(detalhes)) return;

    const agendamentoData = {
        clienteUid: auth.currentUser.uid, clienteNome: perfil.nome, clienteTelefone: perfil.telefone, 
        barbeiroUid, barbeiroNome, servico: servico.nome, valor: preco,
        status: horario === 'imediato' ? 'imediato' : 'pendente',
        ts: firebase.firestore.FieldValue.serverTimestamp(),
        avaliado: false, lembreteEnviado: false
    };
    if (horario !== 'imediato') agendamentoData.horario = horario;

    db.collection("agendamentos").add(agendamentoData).then(() => {
        const tipoAviso = horario === 'imediato' ? 'vaga imediata' : `agendamento para as ${horario}`;
        criarAviso(barbeiroUid, `粕 Novo pedido de ${tipoAviso} de ${perfil.nome} para ${servico.nome}.`);
        criarAviso(auth.currentUser.uid, "笨 Seu pedido foi enviado! Aguarde a aprovaﾃｧﾃ｣o do barbeiro.");
        notifyUser(barbeiroUid, "粕 Novo Agendamento Recebido!", `${perfil.nome} quer agendar "${servico.nome}".`);
        alert("Pedido enviado com sucesso!");
        fecharModalAtual();
    }).catch(e => alert("Erro ao enviar pedido: " + e.message));
}

function abrirModalVagaAprovada(agendamentoId) {
    const btnCancelar = document.getElementById('btnCancelarVagaAprovada');
    const novoBtn = btnCancelar.cloneNode(true);
    btnCancelar.parentNode.replaceChild(novoBtn, btnCancelar);
    novoBtn.onclick = () => cancelarAgendamentoAposAprovacao(agendamentoId);
    abrirModal('modalVagaImediataAprovada');
}

async function cancelarAgendamentoAposAprovacao(agendamentoId) {
    if (!confirm("Tem certeza que deseja cancelar? O valor serﾃ｡ reembolsado.")) return;
    try {
        const agendamentoDoc = await db.collection("agendamentos").doc(agendamentoId).get();
        if (!agendamentoDoc.exists) throw new Error("Agendamento nﾃ｣o encontrado.");
        const { valor, barbeiroUid, clienteUid } = agendamentoDoc.data();
        await db.runTransaction(async t => {
            const clienteRef = db.collection("usuarios").doc(clienteUid);
            const barbeiroRef = db.collection("usuarios").doc(barbeiroUid);
            const agendamentoRef = db.collection("agendamentos").doc(agendamentoId);
            t.update(clienteRef, { saldo: firebase.firestore.FieldValue.increment(valor) });
            t.update(barbeiroRef, { saldo: firebase.firestore.FieldValue.increment(-(valor * (1 - TAXA))) });
            const adminSnap = await db.collection("usuarios").where("tipo", "==", "admin").limit(1).get();
            if (!adminSnap.empty) {
                t.update(db.collection("usuarios").doc(adminSnap.docs[0].id), { saldo: firebase.firestore.FieldValue.increment(-(valor * TAXA)) });
            }
            t.update(agendamentoRef, { status: "cancelado" });
        });
        criarAviso(barbeiroUid, `笶 O cliente ${perfil.nome} cancelou a vaga imediata. O valor foi estornado.`);
        notifyUser(barbeiroUid, "笶 Agendamento Cancelado", `${perfil.nome} cancelou a vaga imediata.`);
        alert("Agendamento cancelado e valor reembolsado com sucesso.");
        fecharModalAtual();
    } catch (e) {
        alert("Erro ao cancelar agendamento: " + e.message);
    }
}


function abrirHistoricoCliente() {
  abrirModal('modalHistoricoCliente');
  const painelHistorico = document.getElementById("painelHistorico");
  db.collection("agendamentos")
    .where("clienteUid", "==", auth.currentUser.uid)
    .where("status", "in", ["concluido", "cancelado"])
    .orderBy("ts", "desc").limit(20)
    .onSnapshot(snap => {
      painelHistorico.innerHTML = "";
      snap.forEach(doc => {
        const a = doc.data();
        let statusTexto = a.status === "concluido" ? "笨ゑｸ Concluﾃｭdo" : "笶 Cancelado";
        let botoes = a.status === "concluido" ? (a.avaliado === false ? `<button onclick="abrirModalAvaliacao('${doc.id}', '${a.barbeiroUid}')">箝 Avaliar</button>` : `<p>笨 Avaliado</p>`) : "";
        painelHistorico.innerHTML += `<div class="card">笨ゑｸ ${a.servico} - R$ ${a.valor.toFixed(2)}<br>Barbeiro: ${a.barbeiroNome}<br>Status: <b>${statusTexto}</b><br>${botoes}</div>`;
      });
    });
}

function abrirModalAvaliacao(agendamentoId, barbeiroUid) {
  const nota = parseInt(prompt("Avalie o serviﾃｧo de 1 a 10:"));
  if (isNaN(nota) || nota < 1 || nota > 10) return alert("Avaliaﾃｧﾃ｣o invﾃ｡lida. Use um nﾃｺmero de 1 a 10.");
  const comentario = prompt("Deixe um comentﾃ｡rio sobre o serviﾃｧo:");
  avaliarServico(agendamentoId, barbeiroUid, nota, comentario);
}

function avaliarServico(agendamentoId, barbeiroUid, nota, comentario) {
  const reputacaoGanho = nota >= 7 ? 10 : (nota <= 4 ? -10 : 0);
  db.runTransaction(async t => {
    const agendamentoRef = db.collection("agendamentos").doc(agendamentoId);
    const barbeiroRef = db.collection("usuarios").doc(barbeiroUid);
    const clienteRef = db.collection("usuarios").doc(auth.currentUser.uid);
    const agendamentoDoc = await t.get(agendamentoRef);
    if (agendamentoDoc.data().avaliado) throw "Este serviﾃｧo jﾃ｡ foi avaliado.";
    
    t.update(agendamentoRef, { avaliado: true });
    t.update(barbeiroRef, { 
        reputacao: firebase.firestore.FieldValue.increment(reputacaoGanho),
        somaAvaliacoes: firebase.firestore.FieldValue.increment(nota),
        numAvaliacoes: firebase.firestore.FieldValue.increment(1)
    });
    t.set(db.collection("avaliacoes").doc(), {
      barbeiroUid, clienteUid: auth.currentUser.uid, nota,
      comentario: comentario || "Sem comentﾃ｡rio",
      ts: firebase.firestore.FieldValue.serverTimestamp()
    });
    t.update(clienteRef, { pontosFidelidade: firebase.firestore.FieldValue.increment(PONTOS_POR_CORTE) });
  }).then(() => {
    alert(`Avaliaﾃｧﾃ｣o enviada com sucesso! Vocﾃｪ ganhou ${PONTOS_POR_CORTE} pontos de fidelidade.`);
    criarAviso(barbeiroUid, `箝 Vocﾃｪ recebeu uma nova avaliaﾃｧﾃ｣o de ${perfil.nome}.`);
    notifyUser(barbeiroUid, "箝 Nova Avaliaﾃｧﾃ｣o!", `${perfil.nome} deixou uma avaliaﾃｧﾃ｣o de nota ${nota} para vocﾃｪ.`);
    notifyUser(auth.currentUser.uid, "醇 Pontos Recebidos!", `Vocﾃｪ ganhou ${PONTOS_POR_CORTE} pontos por avaliar o serviﾃｧo.`);
  }).catch(e => alert("Erro ao avaliar: " + e));
}

function resgatarPontos() {
  if ((perfil.pontosFidelidade || 0) < PONTOS_PARA_RESGATE) {
    return alert(`Vocﾃｪ precisa de ${PONTOS_PARA_RESGATE} pontos para resgatar.`);
  }
  if (!confirm(`Deseja resgatar ${PONTOS_PARA_RESGATE} pontos por R$ ${VALOR_RESGATE.toFixed(2)}?`)) return;
  db.runTransaction(async t => {
    const ref = db.collection("usuarios").doc(auth.currentUser.uid);
    const doc = await t.get(ref);
    if ((doc.data().pontosFidelidade || 0) < PONTOS_PARA_RESGATE) throw "Pontos insuficientes.";
    t.update(ref, {
        pontosFidelidade: firebase.firestore.FieldValue.increment(-PONTOS_PARA_RESGATE),
        saldo: firebase.firestore.FieldValue.increment(VALOR_RESGATE)
    });
  }).then(() => {
    alert(`脂 Parabﾃｩns! Vocﾃｪ resgatou R$ ${VALOR_RESGATE.toFixed(2)} com seus pontos!`);
    notifyUser(auth.currentUser.uid, "頂 Pontos Resgatados!", `Vocﾃｪ converteu ${PONTOS_PARA_RESGATE} pontos em R$${VALOR_RESGATE.toFixed(2)}.`);
  }).catch(e => alert("Erro ao resgatar pontos: " + e.message));
}

function abrirModalVip() {
    const container = document.getElementById('vipContentContainer');
    if (perfil.vip) {
        container.innerHTML = `
            <div class="vip-glow" style="padding: 20px; border-radius: 15px; text-align: center;">
                <h3 style="color: var(--cor-destaque-ouro);">荘 Vocﾃｪ ﾃｩ um Membro VIP!</h3>
                <p>Obrigado por fazer parte do nosso clube exclusivo. Sua assinatura ﾃｩ fundamental para o crescimento do nosso aplicativo.</p>
                <div class="vantagens" style="text-align: left; margin-top: 20px;">
                    <h4>Seus Benefﾃｭcios Atuais:</h4>
                    <ul>
                        <li>Desconto de 10% em todos os serviﾃｧos.</li>
                        <li>Atendimento prioritﾃ｡rio na agenda dos barbeiros.</li>
                        <li>O dobro de pontos de fidelidade em depﾃｳsitos.</li>
                        <li>Sﾃｭmbolo de prestﾃｭgio 荘 no chat global.</li>
                    </ul>
                </div>
                <p style="font-size: 12px; opacity: 0.7; margin-top: 20px;">Sua assinatura nﾃ｣o tem data de expiraﾃｧﾃ｣o. Aproveite!</p>
            </div>
        `;
    } else {
        container.innerHTML = `
            <div class="vip-glow" style="padding: 20px; border-radius: 15px; text-align: center;">
                <h3 style="color: var(--cor-destaque-ouro);">虫 Torne-se um Membro VIP!</h3>
                <p>Eleve sua experiﾃｪncia e apoie o desenvolvimento contﾃｭnuo do nosso aplicativo com uma adesﾃ｣o ﾃｺnica.</p>
                <p style="font-size: 24px; font-weight: bold; margin: 15px 0;">Adesﾃ｣o: R$ ${PRECO_VIP.toFixed(2)}</p>
                <div class="vantagens" style="text-align: left; margin-top: 20px;">
                    <h4>Vantagens Exclusivas para Clientes VIP:</h4>
                    <ul>
                        <li><strong>10% de Desconto</strong> em todos os serviﾃｧos, sempre.</li>
                        <li><strong>Atendimento Prioritﾃ｡rio</strong> na agenda.</li>
                        <li><strong>Dobro de Pontos</strong> de fidelidade ao fazer depﾃｳsitos.</li>
                         <li><strong>Status de Prestﾃｭgio</strong> com um ﾃｭcone 荘 no chat.</li>
                    </ul>
                </div>
                <p style="font-size: 12px; color: var(--cor-destaque-prata); margin-top: 20px;">Sua contribuiﾃｧﾃ｣o ﾃｩ um investimento direto em novas funcionalidades e melhorias para toda a comunidade.</p>
                <button onclick="assinarVip()" style="margin-top: 15px;">虫 Assinar Agora</button>
            </div>
        `;
    }
    abrirModal('modalVip');
}


function assinarVip() {
    if (perfil.saldo < PRECO_VIP) {
        alert("Saldo insuficiente para assinar o VIP.");
        return abrirModal('modalCarteira');
    }
    if (!confirm(`Deseja assinar o plano VIP por R$ ${PRECO_VIP.toFixed(2)}?`)) return;
    db.runTransaction(async t => {
        const clienteRef = db.collection("usuarios").doc(auth.currentUser.uid);
        const financeiroRef = db.collection("config").doc("financeiro");
        const clienteDoc = await t.get(clienteRef);
        if (clienteDoc.data().vip) throw "Vocﾃｪ jﾃ｡ ﾃｩ um membro VIP.";
        t.update(clienteRef, {
            saldo: firebase.firestore.FieldValue.increment(-PRECO_VIP),
            vip: true
        });
        t.set(financeiroRef, { arrecadadoVip: firebase.firestore.FieldValue.increment(PRECO_VIP) }, { merge: true });
    }).then(() => {
        alert("Parabﾃｩns! Vocﾃｪ agora ﾃｩ um membro VIP!");
        notifyUser(auth.currentUser.uid, "荘 Bem-vindo ao VIP!", "Aproveite 10% de desconto e benefﾃｭcios exclusivos!");
        fecharModalAtual();
    }).catch(e => alert("Erro ao assinar VIP: " + e.message));
}

// FUNﾃﾃグ DO CHAT ATUALIZADA
function abrirChatGlobal() {
    const badge = document.querySelector('.notification-badge');
    newMessagesCount = 0;
    badge.textContent = '0';
    badge.classList.add('hidden');
    
    const modal = document.getElementById('janelaChat');
    modal.classList.add('fullscreen');
    abrirModal('janelaChat');

    const chatContainer = document.getElementById("chatMessages");
    chatContainer.innerHTML = "";
    document.getElementById("chatTitle").innerHTML = perfil && perfil.vip ? `<span class="admin-chat">虫 Cliente VIP</span>` : `町 Chat Global`;
    if (chatListener) chatListener();

    // Carrega as 6 mensagens iniciais
    let query = db.collection("chats").doc(CHAT_GLOBAL_ID).collection("mensagens")
      .orderBy("ts", "desc").limit(6);

    chatListener = query.onSnapshot(async snapshot => {
        if(snapshot.empty) {
            chatContainer.innerHTML = "<p>Nenhuma mensagem ainda.</p>";
            return;
        }

        // Guarda a referﾃｪncia da mensagem mais antiga para a paginaﾃｧﾃ｣o
        oldestMessageSnapshot = snapshot.docs[snapshot.docs.length - 1];

        const messagesToRender = [];
        snapshot.docChanges().forEach(change => {
            if (change.type === "added") {
                const msgData = change.doc.data();
                msgData.id = change.doc.id;
                messagesToRender.push(msgData);
            }
        });
        
        messagesToRender.sort((a, b) => a.ts.seconds - b.ts.seconds);
        
        // Limpa o chat apenas na primeira carga
        if (!chatContainer.hasChildNodes()) {
           chatContainer.innerHTML = "";
        }
        
        for(const msg of messagesToRender) {
             const messageDiv = await createMessageDiv(msg);
             // Adiciona novas mensagens em tempo real no final (topo visual)
             if (chatContainer.querySelector(`#msg-${msg.id}`)) continue;
             chatContainer.prepend(messageDiv);
        }
    });
    
    document.getElementById('chatInput').addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); enviarMensagem(); } });
    if (!botInterval) botInterval = setInterval(sendBotMessage, 600000);
}

// NOVA FUNﾃﾃグ PARA CARREGAR MENSAGENS ANTERIORES
async function carregarMensagensAnteriores() {
    if (!oldestMessageSnapshot) return; // Nﾃ｣o hﾃ｡ mais mensagens para carregar

    const btn = document.getElementById('carregarMaisMsgBtn');
    btn.textContent = 'Carregando...';
    btn.disabled = true;

    const query = db.collection("chats").doc(CHAT_GLOBAL_ID).collection("mensagens")
        .orderBy("ts", "desc")
        .startAfter(oldestMessageSnapshot)
        .limit(50);

    const snapshot = await query.get();

    if (snapshot.empty) {
        btn.textContent = 'Fim do histﾃｳrico';
        return;
    }

    // Atualiza a referﾃｪncia para a prﾃｳxima paginaﾃｧﾃ｣o
    oldestMessageSnapshot = snapshot.docs[snapshot.docs.length - 1];
    
    const chatContainer = document.getElementById("chatMessages");
    for (const doc of snapshot.docs.reverse()) { // Inverte para manter a ordem cronolﾃｳgica
        const msg = doc.data();
        msg.id = doc.id;
        const messageDiv = await createMessageDiv(msg);
        chatContainer.appendChild(messageDiv); // Adiciona no final (fundo visual)
    }

    btn.textContent = 'Ver mensagens anteriores';
    btn.disabled = false;
}

async function createMessageDiv(msg) {
    let remetenteNome = msg.remetenteNome || "Desconhecido";
    let classeCSS = "", iconeBase = "", medalhaIcone = "", itemExclusivoIcone = "";
    const messageDiv = document.createElement('div');
    const isCurrentUser = auth.currentUser && msg.remetenteUid === auth.currentUser.uid;
    messageDiv.className = `chat-message ${isCurrentUser ? "chat-sent" : "chat-received"}`;

    if (msg.tipo === "bot") {
        remetenteNome = `<span style="color: red;">､ ${remetenteNome}</span>`;
    } else {
        const remetenteDoc = await db.collection("usuarios").doc(msg.remetenteUid).get();
        if(remetenteDoc.exists) {
            const remetenteData = remetenteDoc.data();

            if (remetenteData.possuiItemExclusivo) {
                itemExclusivoIcone = '装笨ｨ';
            }

            if (remetenteData.tipo === "admin") {
                classeCSS = `admin-chat-red`; 
                iconeBase = `ｧ`;
                messageDiv.style.textShadow = '0 0 5px #000';
            } else if (remetenteData.tipo === "barbeiro") {
                classeCSS = `barbeiro-chat`; iconeBase = `宙`;
                medalhaIcone = obterIconeMaiorConquista(remetenteData.conquistas, 'barbeiro');
            } else if (remetenteData.vip) {
                classeCSS = `cliente-chat`; iconeBase = `荘`;
                medalhaIcone = obterIconeMaiorConquista(remetenteData.conquistas, 'cliente');
            } else {
                classeCSS = `cliente-chat`; iconeBase = `側`;
                medalhaIcone = obterIconeMaiorConquista(remetenteData.conquistas, 'cliente');
            }
            remetenteNome = `<span class="${classeCSS}">${itemExclusivoIcone}${medalhaIcone}${iconeBase} ${remetenteData.nome}</span>`;
        }
    }
    
    messageDiv.innerHTML = `<b>${remetenteNome}:</b> ${msg.texto}`;
    messageDiv.id = `msg-${msg.id}`;
    return messageDiv;
}


const botMessages = [ "Dica: Avalie seu barbeiro apﾃｳs o serviﾃｧo para ganhar 10 pontos de fidelidade e ajudar a comunidade!", "Vocﾃｪ sabia? Indicando um amigo com seu e-mail, vocﾃｪs dois ganham 100 pontos de fidelidade apﾃｳs o primeiro agendamento concluﾃｭdo dele!", "Mantenha seu saldo atualizado! Use a funﾃｧﾃ｣o de depﾃｳsito para adicionar crﾃｩditos de forma rﾃ｡pida e segura.", "Precisa de ajuda ou tem uma sugestﾃ｣o? Use a opﾃｧﾃ｣o 'Denunciar' para falar diretamente com um administrador.", "Torne-se VIP para ter 10% de desconto em todos os serviﾃｧos e ganhar o dobro de pontos nos depﾃｳsitos!", "Barbeiros: mantenham sua agenda e serviﾃｧos atualizados para atrair mais clientes e facilitar os agendamentos.", "Fique de olho no nosso Blog! Administradores podem postar cﾃｳdigos de resgate valendo pontos de fidelidade. Procure por cﾃｳdigos entre (parﾃｪnteses)!" ];
let lastBotMessageIndex = -1;

function sendBotMessage() {
    let randomIndex;
    do { randomIndex = Math.floor(Math.random() * botMessages.length); } while (randomIndex === lastBotMessageIndex);
    lastBotMessageIndex = randomIndex;
    db.collection("chats").doc(CHAT_GLOBAL_ID).collection("mensagens").add({
        remetenteUid: "bot-uid", remetenteNome: "Navalha de Ouro Bot", tipo: "bot",
        texto: botMessages[randomIndex], ts: firebase.firestore.FieldValue.serverTimestamp()
    });
}

function enviarMensagem() {
    if (!auth.currentUser) {
        alert("Para enviar mensagens, por favor, faﾃｧa login ou crie uma conta.");
        mostrar('authView');
        fecharModalAtual();
        return;
    }
    if (isSending) return;
    const texto = document.getElementById("chatInput").value.trim();
    if (!texto) return;
    isSending = true;
    db.collection("chats").doc(CHAT_GLOBAL_ID).collection("mensagens").add({
        remetenteUid: auth.currentUser.uid, remetenteNome: perfil.nome, tipo: perfil.tipo, texto,
        ts: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
        document.getElementById("chatInput").value = "";
        setTimeout(() => { isSending = false; }, 1000);
    }).catch(error => { isSending = false; });
}

function criarAviso(uid, mensagem, tipo = 'geral', agendamentoId = null) {
  const avisoData = { usuarioUid: uid, mensagem, tipo, lido: false, ts: firebase.firestore.FieldValue.serverTimestamp() };
  if (agendamentoId) avisoData.agendamentoId = agendamentoId;
  db.collection("avisos").add(avisoData);
}

function enviarDenuncia() {
  const texto = document.getElementById("textoDenuncia").value.trim();
  if (!texto) return alert("Por favor, descreva o problema.");
  db.collection("denuncias").add({
    usuarioUid: auth.currentUser.uid, usuarioNome: perfil.nome, texto,
    status: "aberta", ts: firebase.firestore.FieldValue.serverTimestamp()
  }).then(denunciaRef => {
    abrirModal('modalDenunciaEnviada');
    const mensagem = encodeURIComponent(`圷 Nova denﾃｺncia no app. ID: ${denunciaRef.id}\n\nDe: ${perfil.nome}\n\nDescriﾃｧﾃ｣o: ${texto}`);
    document.getElementById("btnWhatsappDenuncia").href = `https://wa.me/${WHATSAPP_ADM_PHONE}?text=${mensagem}`;
    document.getElementById("textoDenuncia").value = "";
    notifyAdmins("圷 Nova Denﾃｺncia!", `Uma nova denﾃｺncia foi enviada por ${perfil.nome}.`);
  }).catch(e => alert("Erro ao enviar denﾃｺncia: " + e.message));
}

// Funﾃｧﾃｵes do Barbeiro
function abrirServicos() {
  abrirModal('modalServicosBarbeiro');
  listarServicos();
}

function listarServicos() {
  const lista = document.getElementById("listaServicosBarbeiro");
  lista.innerHTML = "<p>竢ｳ Carregando...</p>";
  db.collection("usuarios").doc(auth.currentUser.uid).onSnapshot(doc => {
    perfil = doc.data();
    lista.innerHTML = "";
    if (!perfil.listaServicos || perfil.listaServicos.length === 0) {
      lista.innerHTML = "<p>Nenhum serviﾃｧo cadastrado.</p>";
      return;
    }
    perfil.listaServicos.forEach((s, index) => {
      lista.innerHTML += `<div class="card"><b>${s.nome}</b> - R$ ${s.valor.toFixed(2)} ${s.duracao ? `(${s.duracao} min)` : ''}<button onclick="removerServico(${index})" style="float:right">笶</button></div>`;
    });
  });
}

function adicionarServico() {
  const nome = prompt("Nome do serviﾃｧo:");
  const valor = parseFloat(prompt("Valor (ex: 25.50):"));
  const duracao = parseInt(prompt("Duraﾃｧﾃ｣o em minutos (ex: 30):"));
  if (!nome || isNaN(valor) || valor <= 0 || isNaN(duracao) || duracao <= 0) return alert("Entrada invﾃ｡lida.");
  db.collection("usuarios").doc(auth.currentUser.uid).update({
    listaServicos: firebase.firestore.FieldValue.arrayUnion({ nome, valor, duracao })
  }).then(() => alert("Serviﾃｧo adicionado!")).catch(e => alert("Erro: " + e.message));
}

function removerServico(index) {
  const servicoParaRemover = perfil.listaServicos[index];
  if (!confirm(`Deseja remover "${servicoParaRemover.nome}"?`)) return;
  db.collection("usuarios").doc(auth.currentUser.uid).update({
    listaServicos: firebase.firestore.FieldValue.arrayRemove(servicoParaRemover)
  }).then(() => alert("Serviﾃｧo removido!")).catch(e => alert("Erro: " + e.message));
}

function alterarNomeBarbeiro(event) {
  const novoNome = document.getElementById("novoNomeBarbeiro").value.trim();
  if (!novoNome) return alert("Por favor, insira um nome vﾃ｡lido.");
  db.collection("usuarios").doc(auth.currentUser.uid).update({ nome: novoNome })
    .then(() => {
      alert("Nome alterado com sucesso!");
      fecharModalAtual();
    }).catch(e => alert("Erro ao alterar nome: " + e.message));
}

function alterarEnderecoBarbeiro(event) {
    const rua = document.getElementById("novoEnderecoRua").value.trim();
    const numero = document.getElementById("novoEnderecoNumero").value.trim();
    if (!rua || !numero) return alert("Por favor, preencha a rua e o nﾃｺmero.");
    if (!cadastroCoords) return alert("Por favor, use o botﾃ｣o para definir a localizaﾃｧﾃ｣o no mapa antes de salvar.");
    
    db.collection("usuarios").doc(auth.currentUser.uid).update({ 
        rua, 
        numero,
        latitude: cadastroCoords.latitude,
        longitude: cadastroCoords.longitude,
    }).then(() => {
        alert("Endereﾃｧo alterado com sucesso!");
        cadastroCoords = null;
        fecharModalAtual();
    }).catch(e => alert("Erro ao alterar endereﾃｧo: " + e.message));
}

function abrirAgenda() {
    abrirModal('modalAgendaBarbeiro');
    carregarAgenda();
}

function carregarAgenda() {
    const btnDisp = document.getElementById("btnDisponibilidade");
    const btnVagaImediata = document.getElementById("btnVagaImediata");
    const btnAgendaManual = document.getElementById("btnAgendaManual");
    const agendaManualPainel = document.getElementById("agendaManualPainel");
    const horariosContainer = document.getElementById("horariosContainer");

    db.collection("usuarios").doc(auth.currentUser.uid).onSnapshot(doc => {
        perfil = doc.data(); 
        if(!btnDisp) return;
        btnDisp.textContent = perfil.disponivel === 'sim' ? '閥 Ficar Indisponﾃｭvel (Automﾃ｡tico)' : '泙 Ficar Disponﾃｭvel (Automﾃ｡tico)';
        btnVagaImediata.textContent = perfil.vagaImediata ? '笞ｸ Desativar Vaga Imediata' : '笞｡ Ativar Vaga Imediata';
        btnAgendaManual.textContent = perfil.usaAgendaManual ? '笶 Desativar Agenda Manual' : '套 Ativar Agenda Manual';
        
        if (perfil.usaAgendaManual) {
            agendaManualPainel.classList.remove("hidden");
            horariosContainer.innerHTML = "";
            tempSelectedHorarios = { ...perfil.agenda };
            for (let i = 7; i <= 18; i++) {
                const horario = `${i}:00`;
                const statusHorario = tempSelectedHorarios[horario];
                const btn = document.createElement('button');
                btn.textContent = horario;
                btn.className = `horario-btn`;
                if(statusHorario === true) btn.classList.add('selecionado');
                if(statusHorario === 'bloqueado') btn.classList.add('bloqueado');
                btn.onclick = () => toggleHorario(horario);
                horariosContainer.appendChild(btn);
            }
        } else {
            agendaManualPainel.classList.add("hidden");
        }
    });
}

function abrirAgendamentosBarbeiro() {
  abrirModal('modalAgendamentosBarbeiro');
  const painel = document.getElementById("agendamentosPainel");
  painel.innerHTML = "<p>竢ｳ Carregando...</p>";
  db.collection("agendamentos")
    .where("barbeiroUid", "==", auth.currentUser.uid)
    .where("status", "in", ["pendente", "confirmado", "imediato", "conclusﾃ｣o pendente"])
    .orderBy("ts", "asc")
    .onSnapshot(snap => {
        painel.innerHTML = !snap.empty ? "" : "<p>Nenhum agendamento ativo.</p>";
        snap.forEach(doc => {
            const ag = doc.data();
            let botoes = "", statusTexto = "", horarioInfo = ag.horario ? ` ﾃs <b>${ag.horario}</b>` : ' (Vaga Imediata)';
            if (ag.status === "pendente") {
                statusTexto = "竢ｳ Aguardando Aprovaﾃｧﾃ｣o";
                botoes = `<button onclick="aprovarAgendamento('${doc.id}','${ag.clienteUid}',${ag.valor},'${ag.horario}')">笨 Aprovar</button><button onclick="recusarAgendamento('${doc.id}','${ag.clienteUid}')">笶 Recusar</button>`;
            } else if (ag.status === "confirmado" || ag.status === "conclusﾃ｣o pendente") {
                statusTexto = "笨 Conclusﾃ｣o Pendente";
                botoes = `<button onclick="concluirAgendamento('${doc.id}','${ag.clienteUid}')">笨ゑｸ Concluir</button><button onclick="cancelarAgendamentoManualmente('${doc.id}','${ag.clienteUid}',${ag.valor})">笶 Cancelar</button>`;
            } else if (ag.status === "imediato") {
                statusTexto = "笞｡ Vaga Imediata Pendente";
                botoes = `<button onclick="aprovarAgendamentoImediato('${doc.id}','${ag.clienteUid}',${ag.valor})">笨 Aprovar</button><button onclick="recusarAgendamento('${doc.id}','${ag.clienteUid}')">笶 Recusar</button>`;
            }
            painel.innerHTML += `<div class="card"><b>${ag.clienteNome}</b> - ${ag.servico} (R$ ${ag.valor.toFixed(2)})<br>Horﾃ｡rio: ${horarioInfo}<br>Status: <b>${statusTexto}</b>${ag.clienteTelefone ? `<br><a href="https://wa.me/55${ag.clienteTelefone}" target="_blank">到 Contatar</a>` : ''}<div style="margin-top:10px; display:flex; gap: 8px;">${botoes}</div></div>`;
        });
    });
}

function toggleVagaImediata() {
    db.collection("usuarios").doc(auth.currentUser.uid).update({ vagaImediata: !perfil.vagaImediata }).catch(e => alert("Erro: " + e.message));
}

function toggleAgendaManual() {
  db.collection("usuarios").doc(auth.currentUser.uid).update({ usaAgendaManual: !perfil.usaAgendaManual }).catch(e => alert("Erro: " + e.message));
}

function toggleHorario(horario) {
    const btn = Array.from(document.querySelectorAll('#horariosContainer .horario-btn')).find(b => b.textContent === horario);
    const statusAtual = tempSelectedHorarios[horario];
    if (statusAtual === true) {
        tempSelectedHorarios[horario] = 'bloqueado';
        btn.classList.remove("selecionado"); btn.classList.add("bloqueado");
    } else if (statusAtual === 'bloqueado') {
        delete tempSelectedHorarios[horario];
        btn.classList.remove("bloqueado");
    } else {
        tempSelectedHorarios[horario] = true;
        btn.classList.add("selecionado");
    }
}


function salvarAgendaManual() {
    db.collection("usuarios").doc(auth.currentUser.uid).update({ agenda: tempSelectedHorarios })
      .then(() => alert("Agenda salva!"))
      .catch(e => alert("Erro ao salvar: " + e.message));
}

function toggleDisponibilidade() {
  db.collection("usuarios").doc(auth.currentUser.uid).update({ disponivel: perfil.disponivel === "sim" ? "nao" : "sim" }).catch(e => alert("Erro: " + e.message));
}

async function aprovarAgendamentoImediato(agendamentoId, clienteUid, valor) {
    if (!confirm("Aprovar esta vaga imediata?")) return;
    const valorComTaxa = valor * (1 - TAXA), valorAdmin = valor * TAXA;
    db.runTransaction(async t => {
        const agendamentoRef = db.collection("agendamentos").doc(agendamentoId);
        const clienteRef = db.collection("usuarios").doc(clienteUid);
        const barbeiroRef = db.collection("usuarios").doc(auth.currentUser.uid);
        const [agendamentoDoc, clienteDoc, barbeiroDoc] = await Promise.all([t.get(agendamentoRef), t.get(clienteRef), t.get(barbeiroRef)]);
        if (agendamentoDoc.data().status !== 'imediato') throw "Solicitaﾃｧﾃ｣o jﾃ｡ processada.";
        if (!clienteDoc.exists) throw "Cliente nﾃ｣o encontrado.";
        if (clienteDoc.data().saldo < valor) throw "Saldo do cliente insuficiente.";
        if (barbeiroDoc.data().vagaImediata === false) throw "Vaga imediata nﾃ｣o estﾃ｡ mais ativa.";

        t.update(clienteRef, { saldo: firebase.firestore.FieldValue.increment(-valor) });
        t.update(barbeiroRef, { saldo: firebase.firestore.FieldValue.increment(valorComTaxa), vagaImediata: false });
        t.update(agendamentoRef, { status: "conclusﾃ｣o pendente", confirmadoEm: firebase.firestore.FieldValue.serverTimestamp() });
        const adminSnap = await db.collection("usuarios").where("tipo", "==", "admin").limit(1).get();
        if(!adminSnap.empty) t.update(db.collection("usuarios").doc(adminSnap.docs[0].id), { saldo: firebase.firestore.FieldValue.increment(valorAdmin) });
        t.set(db.collection("config").doc("financeiro"), { arrecadadoTaxas: firebase.firestore.FieldValue.increment(valorAdmin) }, { merge: true });
    }).then(() => {
        criarAviso(clienteUid, `笨 Sua vaga imediata foi aprovada por ${perfil.nome}!`, 'vaga-aprovada', agendamentoId);
        notifyUser(clienteUid, "笨 Agendamento Confirmado!", `Sua vaga imediata com ${perfil.nome} foi aprovada. Corra para a barbearia!`);
        alert("Agendamento aprovado!");
    }).catch(e => alert("Erro ao aprovar: " + e));
}

async function aprovarAgendamento(agendamentoId, clienteUid, valor, horario = null) {
  if (!confirm("Aprovar este agendamento?")) return;
  const valorComTaxa = valor * (1 - TAXA), valorAdmin = valor * TAXA;
  db.runTransaction(async t => {
      const agendamentoRef = db.collection("agendamentos").doc(agendamentoId);
      const clienteRef = db.collection("usuarios").doc(clienteUid);
      const barbeiroRef = db.collection("usuarios").doc(auth.currentUser.uid);
      const [agendamentoDoc, clienteDoc, barbeiroDoc] = await Promise.all([t.get(agendamentoRef), t.get(clienteRef), t.get(barbeiroRef)]);
      if (agendamentoDoc.data().status !== 'pendente') throw "Solicitaﾃｧﾃ｣o jﾃ｡ processada.";
      if (!clienteDoc.exists) throw "Cliente nﾃ｣o encontrado.";
      if (clienteDoc.data().saldo < valor) throw "Saldo do cliente insuficiente.";

      t.update(clienteRef, { saldo: firebase.firestore.FieldValue.increment(-valor) });
      t.update(barbeiroRef, { saldo: firebase.firestore.FieldValue.increment(valorComTaxa) });
      t.update(agendamentoRef, { status: "conclusﾃ｣o pendente", confirmadoEm: firebase.firestore.FieldValue.serverTimestamp() });

      if (barbeiroDoc.data().usaAgendaManual && horario) {
          const agendaAtual = barbeiroDoc.data().agenda || {};
          if (agendaAtual[horario]) { delete agendaAtual[horario]; t.update(barbeiroRef, { agenda: agendaAtual }); }
      }
      const adminSnap = await db.collection("usuarios").where("tipo", "==", "admin").limit(1).get();
      if(!adminSnap.empty) t.update(db.collection("usuarios").doc(adminSnap.docs[0].id), { saldo: firebase.firestore.FieldValue.increment(valorAdmin) });
      t.set(db.collection("config").doc("financeiro"), { arrecadadoTaxas: firebase.firestore.FieldValue.increment(valorAdmin) }, { merge: true });
  }).then(() => {
      criarAviso(clienteUid, `笨 Seu agendamento foi aprovado pelo barbeiro ${perfil.nome}!`);
      notifyUser(clienteUid, "笨 Agendamento Confirmado!", `Seu horﾃ｡rio com ${perfil.nome} para as ${horario} foi confirmado.`);
      alert("Agendamento aprovado!");
  }).catch(e => alert("Erro ao aprovar: " + e));
}

function recusarAgendamento(agendamentoId, clienteUid) {
  if (!confirm("Recusar este agendamento?")) return;
  db.runTransaction(async t => {
      const agendamentoRef = db.collection("agendamentos").doc(agendamentoId);
      const agendamentoDoc = await t.get(agendamentoRef);
      const status = agendamentoDoc.data().status;
      if (status !== 'pendente' && status !== 'imediato') throw "Solicitaﾃｧﾃ｣o jﾃ｡ processada.";
      t.update(agendamentoRef, { status: "cancelado" });
  }).then(() => {
      criarAviso(clienteUid, `笶 O barbeiro ${perfil.nome} recusou seu agendamento.`);
      notifyUser(clienteUid, "笶 Agendamento Recusado", `O barbeiro ${perfil.nome} nﾃ｣o pﾃｴde aceitar seu pedido.`);
      alert("Agendamento recusado.");
  }).catch(e => alert("Erro ao recusar: " + e));
}

async function cancelarAgendamentoManualmente(agendamentoId, clienteUid, valor) {
  if (!confirm("Cancelar este agendamento? O dinheiro serﾃ｡ reembolsado e sua reputaﾃｧﾃ｣o serﾃ｡ afetada.")) return;
  const valorComTaxa = valor * (1 - TAXA), valorAdmin = valor * TAXA;
  db.runTransaction(async t => {
      const agendamentoRef = db.collection("agendamentos").doc(agendamentoId);
      const agendamentoDoc = await t.get(agendamentoRef);
      const status = agendamentoDoc.data().status;
      if (status !== 'confirmado' && status !== 'conclusﾃ｣o pendente') throw "Apenas agendamentos aprovados podem ser cancelados.";
      
      const clienteRef = db.collection("usuarios").doc(clienteUid);
      const barbeiroRef = db.collection("usuarios").doc(auth.currentUser.uid);
      t.update(clienteRef, { saldo: firebase.firestore.FieldValue.increment(valor) });
      t.update(barbeiroRef, { saldo: firebase.firestore.FieldValue.increment(-valorComTaxa), reputacao: firebase.firestore.FieldValue.increment(-10) });
      t.update(agendamentoRef, { status: "cancelado" });

      const adminSnap = await db.collection("usuarios").where("tipo", "==", "admin").limit(1).get();
      if (!adminSnap.empty) t.update(db.collection("usuarios").doc(adminSnap.docs[0].id), { saldo: firebase.firestore.FieldValue.increment(-valorAdmin) });
      t.set(db.collection("config").doc("financeiro"), { arrecadadoTaxas: firebase.firestore.FieldValue.increment(-valorAdmin) }, { merge: true });
  }).then(() => {
      criarAviso(clienteUid, `笶 O barbeiro ${perfil.nome} cancelou seu agendamento. O valor de R$ ${valor.toFixed(2)} foi reembolsado.`);
      notifyUser(clienteUid, "売 Agendamento Cancelado", `${perfil.nome} cancelou seu horﾃ｡rio. O valor de R$ ${valor.toFixed(2)} foi estornado.`);
      alert("Agendamento cancelado e valor reembolsado. Sua reputaﾃｧﾃ｣o diminuiu.");
  }).catch(e => alert("Erro ao cancelar: " + e));
}

async function concluirAgendamento(agendamentoId, clienteUid) {
  try {
    const agendamentoRef = db.collection("agendamentos").doc(agendamentoId);
    const barbeiroRef = db.collection("usuarios").doc(auth.currentUser.uid);
    const clienteRef = db.collection("usuarios").doc(clienteUid);
    await db.runTransaction(async t => {
        const agendamentoDoc = await t.get(agendamentoRef);
        if (agendamentoDoc.data().status !== "conclusﾃ｣o pendente") throw "Este agendamento nﾃ｣o pode ser concluﾃｭdo.";
        t.update(barbeiroRef, { cortesSemana: firebase.firestore.FieldValue.increment(1), clientesAtendidos: firebase.firestore.FieldValue.increment(1) });
        t.update(agendamentoRef, { status: "concluido" });
        t.update(clienteRef, { cortesRealizados: firebase.firestore.FieldValue.increment(1) });
    });
    await verificarConquistas(clienteUid);
    await verificarConquistasBarbeiro(auth.currentUser.uid);

    alert("Serviﾃｧo concluﾃｭdo!");
    criarAviso(clienteUid, `Agendamento concluﾃｭdo! Vocﾃｪ jﾃ｡ pode avaliar o serviﾃｧo.`);
    notifyUser(clienteUid, "箝 Avalie sua Experiﾃｪncia!", `O serviﾃｧo com ${perfil.nome} foi concluﾃｭdo. Deixe sua avaliaﾃｧﾃ｣o e ganhe pontos!`);
    const clienteDoc = await clienteRef.get();
    const clienteData = clienteDoc.data();
    if (clienteData.bonusIndicacaoPendente) {
        await clienteRef.update({ pontosFidelidade: firebase.firestore.FieldValue.increment(BONUS_INDICACAO), bonusIndicacaoPendente: false });
        notifyUser(clienteUid, "醇 Bﾃｴnus de Indicaﾃｧﾃ｣o!", `Vocﾃｪ ganhou ${BONUS_INDICACAO} pontos de fidelidade!`);
        const query = await db.collection("usuarios").where("email", "==", clienteData.indicadoPorEmail).limit(1).get();
        if (!query.empty) {
            const indicadorDoc = query.docs[0];
            await indicadorDoc.ref.update({ pontosFidelidade: firebase.firestore.FieldValue.increment(BONUS_INDICACAO) });
            notifyUser(indicadorDoc.id, "醇 Bﾃｴnus por Indicar!", `Vocﾃｪ ganhou ${BONUS_INDICACAO} pontos porque ${clienteData.nome} finalizou o serviﾃｧo!`);
        }
    }
  } catch(e) {
    alert("Erro ao concluir serviﾃｧo: " + e);
  }
}

function abrirClientesBarbeiro() {
  abrirModal('modalClientesBarbeiro');
  const lista = document.getElementById("listaClientesBarbeiro");
  lista.innerHTML = "<p>竢ｳ Carregando...</p>";
  db.collection("agendamentos").where("barbeiroUid", "==", auth.currentUser.uid)
    .where("status", "==", "concluido")
    .get()
    .then(snap => {
      const clientesMap = {};
      snap.forEach(doc => {
        const ag = doc.data();
        if (!clientesMap[ag.clienteUid]) {
          clientesMap[ag.clienteUid] = { nome: ag.clienteNome, totalCortes: 0, telefone: ag.clienteTelefone };
        }
        clientesMap[ag.clienteUid].totalCortes++;
      });
      lista.innerHTML = Object.keys(clientesMap).length === 0 ? "<p>Vocﾃｪ ainda nﾃ｣o tem clientes.</p>" : "";
      Object.values(clientesMap).sort((a, b) => b.totalCortes - a.totalCortes).forEach(c => {
        const whatsappLink = c.telefone ? `<a href="https://wa.me/55${c.telefone.replace(/\D/g,'')}" target="_blank" onclick="event.stopPropagation()"><button style="font-size:12px; padding: 5px 8px; margin-top:5px;">町 WhatsApp</button></a>` : '<p style="font-size:11px; opacity:0.6;">Sem telefone</p>';
        lista.innerHTML += `<div class="card"><b>${c.nome}</b><p>Cortes realizados: ${c.totalCortes}</p>${whatsappLink}</div>`;
      });
    });
}

function abrirHistoricoBarbeiro() {
  abrirModal('modalHistoricoBarbeiro');
  const painel = document.getElementById("painelHistoricoBarbeiro");
  painel.innerHTML = "<p>竢ｳ Carregando...</p>";
  db.collection("agendamentos").where("barbeiroUid", "==", auth.currentUser.uid)
    .where("status", "in", ["concluido", "cancelado"]).orderBy("ts", "desc").limit(20)
    .onSnapshot(snap => {
      if (snap.empty) {
          painel.innerHTML = "<p>Nenhum serviﾃｧo no histﾃｳrico encontrado.</p>";
          return;
      }
      painel.innerHTML = "";
      snap.forEach(doc => {
        const a = doc.data();
        const dataFormatada = a.ts ? new Date(a.ts.seconds * 1000).toLocaleDateString('pt-BR') : 'Data indisponﾃｭvel';
        const statusIcon = a.status === "concluido" ? "笨" : "笶";
        const statusTexto = a.status === "concluido" ? "Concluﾃｭdo" : "Cancelado";
        painel.innerHTML += `<div class="card" style="margin-bottom: 10px;">
          <p><strong>${statusIcon} Cliente:</strong> ${a.clienteNome}</p>
          <p><strong>笨ゑｸ Serviﾃｧo:</strong> ${a.servico} - R$ ${a.valor.toFixed(2)}</p>
          <p><strong>欄ｸ Data:</strong> ${dataFormatada}</p>
          <p><strong>Status:</strong> ${statusTexto}</p>
        </div>`;
      });
    });
}

function criarPromocao() {
  const nome = document.getElementById("promocaoNome").value;
  const descricao = document.getElementById("promocaoDescricao").value;
  const desconto = parseInt(document.getElementById("promocaoDesconto").value);
  if (!nome || !descricao || isNaN(desconto) || desconto <= 0 || desconto > 100) return alert("Preencha os campos corretamente.");
  db.collection("usuarios").doc(auth.currentUser.uid).update({
    promocoes: firebase.firestore.FieldValue.arrayUnion({ nome, descricao, desconto })
  }).then(() => {
    alert("Promoﾃｧﾃ｣o criada!");
    fecharModalAtual();
  }).catch(e => alert("Erro: " + e.message));
}

function removerPromocao(index) {
  const p = perfil.promocoes[index];
  if (!confirm(`Remover a promoﾃｧﾃ｣o "${p.nome}"?`)) return;
  db.collection("usuarios").doc(auth.currentUser.uid).update({
    promocoes: firebase.firestore.FieldValue.arrayRemove(p)
  }).then(() => alert("Promoﾃｧﾃ｣o removida!")).catch(e => alert("Erro: " + e.message));
}

function abrirAvaliacoesBarbeiro() {
  abrirModal('modalAvaliacoes');
  const lista = document.getElementById("listaAvaliacoesModal");
  lista.innerHTML = "<p>竢ｳ Carregando...</p>";
  db.collection("avaliacoes").where("barbeiroUid", "==", auth.currentUser.uid)
    .orderBy("ts", "desc").onSnapshot(async snap => {
      lista.innerHTML = snap.empty ? "<p>Nenhuma avaliaﾃｧﾃ｣o recebida.</p>" : "";
      for (const doc of snap.docs) {
        const a = doc.data();
        let clienteNome = "Anﾃｴnimo";
        if (a.clienteUid) {
          const clienteDoc = await db.collection("usuarios").doc(a.clienteUid).get();
          if (clienteDoc.exists) clienteNome = clienteDoc.data().nome;
        }
        lista.innerHTML += `<div class="card" style="margin-bottom:15px;"><p style="margin-bottom:5px;"><b>De:</b> ${clienteNome}</p><b>Nota: ${a.nota}/10</b> (${'箝'.repeat(Math.round(a.nota / 2))})<br><p style="margin-top:5px;"><b>Comentﾃ｡rio:</b> "${a.comentario}"</p></div>`;
      }
    });
}

// ======================================================================
// --- NOVAS FUNﾃﾃ髭S DE PAGAMENTO (APRIMORADO) ---
// ======================================================================

function iniciarDeposito() {
  abrirModal('modalDeposito');
}

function iniciarSaque() {
  abrirModal('modalSaque');
}

function processarPagamentoPixAprimorado() {
    abrirModal('modalGerandoQRCode');
    setTimeout(() => {
        fecharModalAtual();
        abrirModal('modalExibirPixAprimorado');
        iniciarTimerPix(600); // 10 minutos
    }, 3000); // Simula o carregamento de 3 segundos
}

function processarPagamentoCartaoAprimorado() {
    document.getElementById('carregandoGenericoTitulo').textContent = 'Aguarde...';
    document.getElementById('carregandoGenericoTexto').textContent = 'Vocﾃｪ estﾃ｡ sendo redirecionado para um ambiente de pagamento seguro.';
    abrirModal('modalCarregandoGenerico');
    setTimeout(() => {
        window.location.href = 'https://pay.kiwify.com.br/T3M9m1C';
    }, 3000); // Simula o processamento de 3 segundos
}

function iniciarTimerPix(duracao) {
    if (pixTimerInterval) clearInterval(pixTimerInterval);
    let timer = duracao;
    const display = document.getElementById('pixTimer');
    pixTimerInterval = setInterval(() => {
        const minutos = parseInt(timer / 60, 10);
        const segundos = parseInt(timer % 60, 10);
        display.textContent = `${minutos < 10 ? "0" + minutos : minutos}:${segundos < 10 ? "0" + segundos : segundos}`;
        if (--timer < 0) {
            clearInterval(pixTimerInterval);
            display.textContent = "EXPIRADO";
            alert("O tempo para pagamento via PIX expirou. Por favor, gere um novo cﾃｳdigo.");
            fecharModalAtual();
        }
    }, 1000);
}

function copiarCodigoPixAprimorado() {
    const texto = document.getElementById('pixChaveAleatoria').value;
    const btn = event.target;
    navigator.clipboard.writeText(texto).then(() => {
        btn.textContent = '笨 Copiado!';
        setTimeout(() => { btn.textContent = 'Copiar Chave Aleatﾃｳria PIX'; }, 2000);
    }).catch(err => {
        alert("Nﾃ｣o foi possﾃｭvel copiar o cﾃｳdigo. Por favor, selecione e copie manualmente.");
    });
}

function confirmarEnvioComprovante() {
    const mensagem = encodeURIComponent("Olﾃ｡! Segue o comprovante do meu depﾃｳsito no app Navalha de Ouro.");
    window.open(`https://wa.me/${WHATSAPP_ADM_PHONE}?text=${mensagem}`, '_blank');
}

function confirmarSaque() {
    const valor = parseFloat(document.getElementById('saqueValor').value);
    const chaveTipo = document.getElementById('saqueChavePixTipo').value;
    const chave = document.getElementById('saqueChavePix').value.trim();

    if (isNaN(valor) || valor <= 0) return alert("Valor de saque invﾃ｡lido.");
    if (!chaveTipo) return alert("Selecione o tipo da chave PIX.");
    if (!chave) return alert("Insira sua chave PIX.");
    if (perfil.saldo < valor) return alert("Saldo insuficiente.");

    abrirModal('modalSaqueConfirmado');
}

function contatarAdminSaque() {
    const mensagem = encodeURIComponent(`Olﾃ｡! Acabei de solicitar um saque no valor de R$${document.getElementById('saqueValor').value} e gostaria de confirmar o recebimento.`);
    window.open(`https://wa.me/${WHATSAPP_ADM_PHONE}?text=${mensagem}`, '_blank');
    fecharModalAtual();
}

// ======================================================================
// --- FIM DAS FUNﾃﾃ髭S DE PAGAMENTO ---
// ======================================================================

async function publicarBlog() {
  const titulo = document.getElementById("blogTitulo").value.trim();
  const conteudo = document.getElementById("blogConteudo").value.trim();
  if (!titulo || !conteudo) return alert("Preencha todos os campos.");
  await db.collection("blog").add({
    titulo, conteudo, autor: perfil.nome, autorUid: auth.currentUser.uid,
    ts: firebase.firestore.FieldValue.serverTimestamp()
  });
  alert("Postagem publicada!");
  fecharModalAtual();
}

function carregarListaBlog() {
  const lista = document.getElementById("listaBlog");
  lista.innerHTML = "<p>竢ｳ Carregando...</p>";
  db.collection("blog").orderBy("ts", "desc").onSnapshot(snap => {
    lista.innerHTML = "";
    const umDiaAtras = new Date().getTime() - (24 * 60 * 60 * 1000);
    let postsExibidos = 0;
    snap.forEach(doc => {
      const p = doc.data();
      if (p.ts && p.ts.toDate().getTime() > umDiaAtras) {
        lista.innerHTML += `<div class="card" style="margin-bottom:15px;"><h4>${p.titulo}</h4><p>${p.conteudo}</p><p style="font-size:12px;opacity:0.7;">Por: ${p.autor}</p></div>`;
        postsExibidos++;
      }
    });
    if (postsExibidos === 0) {
        lista.innerHTML = "<p>Nenhum post recente (ﾃｺltimas 24h).</p>";
    }
  });
}

function carregarAdmin() {
    if (adminBalanceListener) adminBalanceListener(); 
    db.collection("usuarios").get().then(snapshot => {
        adminUserBalances = {};
        snapshot.forEach(doc => { adminUserBalances[doc.id] = doc.data().saldo || 0; });
        adminBalanceListener = db.collection("usuarios").onSnapshot(snap => {
            snap.docChanges().forEach(change => {
                if (change.type === "modified") {
                    const novo = change.doc.data();
                    const id = change.doc.id;
                    const antigoSaldo = adminUserBalances[id] || 0;
                    const novoSaldo = novo.saldo || 0;
                    if (Math.floor(novoSaldo / 100) > Math.floor(antigoSaldo / 100)) {
                        alert(`笞ｸ Alerta de Saldo! ${novo.nome} ultrapassou R$${Math.floor(novoSaldo / 100) * 100}.`);
                    }
                    adminUserBalances[id] = novoSaldo;
                }
            });
        });
    });
}

async function abrirModalEstatisticas() {
    abrirModal('modalEstatisticas');
    const painel = document.getElementById("estatisticasPainel");
    painel.innerHTML = "<p>竢ｳ Carregando estatﾃｭsticas...</p>";
    
    try {
        const usuariosSnap = await db.collection("usuarios").get();
        let totalUsuarios = usuariosSnap.size;
        let clientes = 0, barbeiros = 0, vip = 0, totalSaldo = 0, somaReputacao = 0, barbeirosComReputacao = 0;
        usuariosSnap.forEach(doc => {
            const u = doc.data();
            if (u.tipo === "cliente") clientes++;
            if (u.tipo === "barbeiro") {
                barbeiros++;
                if(u.reputacao) {
                    somaReputacao += u.reputacao;
                    barbeirosComReputacao++;
                }
            }
            if (u.vip) vip++;
            totalSaldo += u.saldo || 0;
        });
        const mediaReputacao = barbeirosComReputacao > 0 ? (somaReputacao / barbeirosComReputacao).toFixed(0) : 'N/A';

        const agendamentosSnap = await db.collection("agendamentos").get();
        let totalAgendamentos = agendamentosSnap.size;
        let concluidos = 0, cancelados = 0;
        agendamentosSnap.forEach(doc => {
            const status = doc.data().status;
            if (status === 'concluido') concluidos++;
            if (status === 'cancelado') cancelados++;
        });

        const solicitacoesSnap = await db.collection("solicitacoes").where('status', '==', 'pendente').get();
        let solicitacoesPendentes = solicitacoesSnap.size;

        const financeiroDoc = await db.collection("config").doc("financeiro").get();
        const fin = financeiroDoc.data() || { arrecadadoTaxas: 0, arrecadadoVip: 0 };
        
        painel.innerHTML = `
            <div class="popup-section"><h4>則 Usuﾃ｡rios</h4>
                <p>Total: <b>${totalUsuarios}</b></p>
                <p>Clientes: <b>${clientes}</b> | Barbeiros: <b>${barbeiros}</b></p>
                <p>Membros VIP: <b>${vip}</b></p>
            </div>
            <div class="popup-section"><h4>欄ｸ Agendamentos</h4>
                <p>Total de Registros: <b>${totalAgendamentos}</b></p>
                <p>Concluﾃｭdos: <b style="color: #4CAF50;">${concluidos}</b></p>
                <p>Cancelados: <b style="color: #e74c3c;">${cancelados}</b></p>
            </div>
             <div class="popup-section"><h4>笞呻ｸ Sistema</h4>
                <p>Reputaﾃｧﾃ｣o Mﾃｩdia dos Barbeiros: <b>${mediaReputacao} / 100</b></p>
                <p>Solicitaﾃｧﾃｵes Pendentes: <b>${solicitacoesPendentes}</b></p>
            </div>
            <div class="popup-section"><h4>腸 Financeiro</h4>
                <p>Arrecadado com Taxas: <b>R$ ${fin.arrecadadoTaxas.toFixed(2)}</b></p>
                <p>Arrecadado com VIP: <b>R$ ${fin.arrecadadoVip.toFixed(2)}</b></p>
                <p>Saldo total em circulaﾃｧﾃ｣o: <b>R$ ${totalSaldo.toFixed(2)}</b></p>
            </div>
        `;
    } catch (error) {
        painel.innerHTML = "<p>Erro ao carregar as estatﾃｭsticas.</p>";
        console.error("Erro em abrirModalEstatisticas:", error);
    }
}


function abrirModalSolicitacoes() {
  abrirModal('modalSolicitacoes');
  const lista = document.getElementById("listaSolicitacoes");
  lista.innerHTML = "<p>竢ｳ Carregando...</p>";
  db.collection("solicitacoes").where("status", "==", "pendente")
    .orderBy("ts", "desc").onSnapshot(snap => {
      lista.innerHTML = snap.empty ? "<p>Nenhuma solicitaﾃｧﾃ｣o pendente.</p>" : "";
      snap.forEach(doc => {
        const s = doc.data();
        lista.innerHTML += `<div class="card" onclick="verDetalhesSolicitacao('${doc.id}')"><b>${s.tipo.toUpperCase()}</b> de ${s.usuarioNome}<br><p>Valor: R$ ${s.valor ? s.valor.toFixed(2) : 'N/A'}</p><p style="color: #ff9800;">Status: <b>PENDENTE</b></p></div>`;
      });
    });
}

async function verDetalhesSolicitacao(id) {
  const doc = await db.collection("solicitacoes").doc(id).get();
  const s = doc.data();
  if (!s || s.status !== 'pendente') return alert(`Esta solicitaﾃｧﾃ｣o jﾃ｡ foi ${s.status}.`);

  let detalhes = `Detalhes:\nTipo: ${s.tipo}\nUsuﾃ｡rio: ${s.usuarioNome}\n`;
  if(s.valor) detalhes += `Valor: R$ ${s.valor.toFixed(2)}\n`;
  if(s.tipo === 'saque') detalhes += `Chave: ${s.chavePixTipo} - ${s.chavePix}\n`;
  detalhes += `\nAprovar? (Para saques, esta aﾃｧﾃ｣o ﾃｩ irreversﾃｭvel e deve ser feita APﾃ鉄 a transferﾃｪncia manual via PIX)`;

  const confirmar = confirm(detalhes);
  if (confirmar) {
    if (s.tipo === "saque") aprovarSaque(id, s.usuarioUid, s.valor);
    else if (s.tipo === "liberacao_loja") aprovarLiberacaoLoja(id, s.usuarioUid);
  } else if (confirm("Deseja recusar a solicitaﾃｧﾃ｣o?")) {
    recusarSolicitacao(id, s.usuarioUid, s.tipo);
  }
}

function aprovarSaque(id, uid, valor) {
  db.runTransaction(async t => {
    const userRef = db.collection("usuarios").doc(uid);
    const userDoc = await t.get(userRef);
    if ((userDoc.data().saldo || 0) < valor) throw "Saldo insuficiente.";
    t.update(userRef, { saldo: firebase.firestore.FieldValue.increment(-valor) });
    t.update(db.collection("solicitacoes").doc(id), { status: "aprovado" });
  }).then(() => {
    alert("Saque aprovado!");
    notifyUser(uid, "頂 Saque Aprovado!", `Sua solicitaﾃｧﾃ｣o de saque de R$ ${valor.toFixed(2)} foi processada.`, { tipo: 'atualizar_saldo' });
  }).catch(e => alert("Erro: " + e.message));
}

function recusarSolicitacao(id, uid, tipo) {
  db.collection("solicitacoes").doc(id).update({ status: "recusado" })
    .then(() => {
      alert("Solicitaﾃｧﾃ｣o recusada.");
      notifyUser(uid, `笶 Solicitaﾃｧﾃ｣o Recusada`, `Sua solicitaﾃｧﾃ｣o de ${tipo} foi recusada.`);
    }).catch(e => alert("Erro: " + e.message));
}

function abrirModalUsuarios() {
  abrirModal('modalUsuarios');
  const lista = document.getElementById("usuariosPainel");
  lista.innerHTML = "<p>竢ｳ Carregando...</p>";
  db.collection("usuarios").onSnapshot(snap => {
    lista.innerHTML = snap.empty ? "<p>Nenhum usuﾃ｡rio cadastrado.</p>" : "";
    snap.forEach(doc => {
      const u = doc.data();
      lista.innerHTML += `<div class="card"><b>${u.nome}</b> (${u.tipo})<p>Email: ${u.email}</p><p>Telefone: ${u.telefone}</p><button onclick="verDetalhesUsuario('${doc.id}')">笞呻ｸ Gerenciar</button></div>`;
    });
  });
}

function abrirDenuncias() {
  abrirModal('modalDenunciasAdmin');
  const lista = document.getElementById("listaDenuncias");
  lista.innerHTML = "<p>竢ｳ Carregando...</p>";
  db.collection("denuncias").where("status", "==", "aberta").orderBy("ts", "desc")
    .onSnapshot(snap => {
      lista.innerHTML = snap.empty ? "<p>Nenhuma denﾃｺncia aberta.</p>" : "";
      snap.forEach(doc => {
        const d = doc.data();
        lista.innerHTML += `<div class="card" onclick="verDetalhesDenuncia('${doc.id}')"><b>Denﾃｺncia de ${d.usuarioNome}</b><p>${d.texto.substring(0, 50)}...</p></div>`;
      });
    });
}

async function verDetalhesDenuncia(id) {
  const doc = await db.collection("denuncias").doc(id).get();
  const d = doc.data();
  if (!d) return;
  if (confirm(`Denﾃｺncia de ${d.usuarioNome}:\n${d.texto}\n\nDeseja fechar esta denﾃｺncia?`)) {
    fecharDenuncia(id);
  }
}

function fecharDenuncia(id) {
  db.collection("denuncias").doc(id).update({ status: "fechada" }).then(() => alert("Denﾃｺncia fechada!"));
}

async function verDetalhesUsuario(uid) {
  const doc = await db.collection("usuarios").doc(uid).get();
  const u = doc.data();
  if (!u) return;
  const menu = `Gerenciando: ${u.nome}\nSaldo: R$ ${(u.saldo || 0).toFixed(2)}\n\n1. Mudar tipo (atual: ${u.tipo})\n2. Modificar Saldo\n3. Mudar VIP (atual: ${u.vip ? 'Sim' : 'Nﾃ｣o'})\n4. Chamar no WhatsApp\n5. DELETAR\n\nEscolha uma opﾃｧﾃ｣o:`;
  const acao = prompt(menu);
  switch(acao) {
    case "1":
      const novoTipo = prompt("Novo tipo (cliente, barbeiro, admin):");
      if (["cliente", "barbeiro", "admin"].includes(novoTipo)) {
        await db.collection("usuarios").doc(uid).update({ tipo: novoTipo });
        alert("Tipo alterado!");
      } else alert("Tipo invﾃ｡lido.");
      break;
    case "2":
      const valor = parseFloat(prompt("Valor para adicionar (use '-' para remover):"));
      if (!isNaN(valor)) {
        await db.collection("usuarios").doc(uid).update({ saldo: firebase.firestore.FieldValue.increment(valor) });
        notifyUser(uid, "頂 Nova Transaﾃｧﾃ｣o!", `Um admin alterou seu saldo em R$ ${valor.toFixed(2)}.`, { tipo: 'atualizar_saldo' });
        alert("Saldo alterado!");
      } else alert("Valor invﾃ｡lido.");
      break;
    case "3":
      await db.collection("usuarios").doc(uid).update({ vip: !u.vip });
      alert("Status VIP alterado!");
      break;
    case "4":
      if(u.telefone) window.open(`https://wa.me/55${u.telefone}`, '_blank');
      else alert("Usuﾃ｡rio sem telefone.");
      break;
    case "5":
      if (prompt(`TEM CERTEZA? Para deletar ${u.nome}, digite "DELETAR":`) === "DELETAR") {
        await db.collection("usuarios").doc(uid).delete();
        alert("Usuﾃ｡rio deletado!");
      } else alert("Exclusﾃ｣o cancelada.");
      break;
  }
}

async function enviarNotificacaoMarketing() {
    const title = document.getElementById('marketingTitulo').value.trim();
    const body = document.getElementById('marketingCorpo').value.trim();
    if (!title || !body || !confirm(`Confirma o envio da notificaﾃｧﾃ｣o em massa?`)) return;
    try {
        const response = await fetch("https://navalhabackend.onrender.com/enviar-notificacao-massa", {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title, body, adminUid: auth.currentUser.uid }),
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.message);
        alert(`Notificaﾃｧﾃｵes enviadas!\nSucessos: ${data.successCount}\nFalhas: ${data.failureCount}`);
        fecharModalAtual();
    } catch (error) {
        alert('Falha ao enviar: ' + error.message);
    }
}

const conquistasDefinidas = {
    'cortes_1': { nome: 'Primeiro Agendamento', icone: '存', descricao: 'Concluiu seu primeiro agendamento.', level: 1 },
    'cortes_5': { nome: 'Cliente Iniciante', icone: '総', descricao: 'Concluiu 5 agendamentos.', level: 2 },
    'cortes_10': { nome: 'Cliente Regular', icone: '箝', descricao: 'Concluiu 10 agendamentos.', level: 3 },
    'cortes_20': { nome: 'Cliente Fiel', icone: '､', descricao: 'Concluiu 20 agendamentos.', level: 4 },
    'cortes_50': { nome: 'Parceiro da Barbearia', icone: '潮', descricao: 'Concluiu 50 agendamentos.', level: 5 },
    'cortes_100': { nome: 'Membro de Honra', icone: '荘', descricao: 'Concluiu 100 agendamentos.', level: 6 },
    'cortes_1000': { nome: 'Lenda da Navalha', icone: '醇', descricao: 'Concluiu 1000 agendamentos.', level: 7 }
};
const conquistasOrdem = ['cortes_1000', 'cortes_100', 'cortes_50', 'cortes_20', 'cortes_10', 'cortes_5', 'cortes_1'];

const conquistasBarbeiroDefinidas = {
    'cortes_1': { nome: 'Primeiro Corte', icone: '脂', descricao: 'Concluiu seu primeiro corte.', level: 1 },
    'cortes_5': { nome: 'Mﾃ｣os ﾃ Obra', icone: '屏ｸ', descricao: 'Concluiu 5 cortes.', level: 2 },
    'cortes_10': { nome: 'Barbeiro em Ascensﾃ｣o', icone: '櫨', descricao: 'Concluiu 10 cortes.', level: 3 },
    'cortes_20': { nome: 'Profissional da Tesoura', icone: '笨ゑｸ', descricao: 'Concluiu 20 cortes.', level: 4 },
    'cortes_50': { nome: 'Barbeiro Experiente', icone: '', descricao: 'Concluiu 50 cortes.', level: 5 },
    'cortes_100': { nome: 'Mestre da Navalha', icone: '虫', descricao: 'Concluiu 100 cortes.', level: 6 },
    'cortes_1000': { nome: 'Lenda da Barbearia', icone: '醇', descricao: 'Concluiu 1000 cortes.', level: 7 }
};
const conquistasBarbeiroOrdem = ['cortes_1000', 'cortes_100', 'cortes_50', 'cortes_20', 'cortes_10', 'cortes_5', 'cortes_1'];


async function verificarConquistas(uid) {
    const userRef = db.collection('usuarios').doc(uid);
    const userDoc = await userRef.get();
    if (!userDoc.exists) return;
    const userData = userDoc.data();
    const conquistasAtuais = userData.conquistas || [];
    const cortes = userData.cortesRealizados || 0;

    const niveis = { 1: 'cortes_1', 5: 'cortes_5', 10: 'cortes_10', 20: 'cortes_20', 50: 'cortes_50', 100: 'cortes_100', 1000: 'cortes_1000' };

    for (const nivel in niveis) {
        const conquistaId = niveis[nivel];
        if (cortes >= nivel && !conquistasAtuais.includes(conquistaId)) {
            await userRef.update({ conquistas: firebase.firestore.FieldValue.arrayUnion(conquistaId) });
            const conquista = conquistasDefinidas[conquistaId];
            notifyUser(uid, "遵 Nova Conquista!", `Vocﾃｪ desbloqueou: "${conquista.nome}"!`);
        }
    }
}

async function verificarConquistasBarbeiro(uid) {
    const userRef = db.collection('usuarios').doc(uid);
    const userDoc = await userRef.get();
    if (!userDoc.exists) return;
    const userData = userDoc.data();
    const conquistasAtuais = userData.conquistas || [];
    const cortes = userData.clientesAtendidos || 0;

    const niveis = { 1: 'cortes_1', 5: 'cortes_5', 10: 'cortes_10', 20: 'cortes_20', 50: 'cortes_50', 100: 'cortes_100', 1000: 'cortes_1000' };
    
    for (const nivel in niveis) {
        const conquistaId = niveis[nivel];
        if (cortes >= nivel && !conquistasAtuais.includes(conquistaId)) {
            await userRef.update({ conquistas: firebase.firestore.FieldValue.arrayUnion(conquistaId) });
            const conquista = conquistasBarbeiroDefinidas[conquistaId];
            notifyUser(uid, "遵 Nova Conquista de Barbeiro!", `Vocﾃｪ desbloqueou: "${conquista.nome}"!`);
        }
    }
}

function abrirModalConquistas() {
    abrirModal('modalConquistas');
    const container = document.getElementById('listaConquistas');
    container.innerHTML = "";
    const conquistasDoUsuario = perfil.conquistas || [];
    for (const id in conquistasDefinidas) {
        const c = conquistasDefinidas[id];
        const unlocked = conquistasDoUsuario.includes(id);
        container.innerHTML += `<div class="conquista-item ${unlocked ? 'unlocked' : 'locked'}"><div class="conquista-icon">${c.icone}</div><div><b>${c.nome}</b><p style="font-size:12px; margin:0;">${c.descricao}</p></div></div>`;
    }
}

function abrirModalConquistasBarbeiro() {
    abrirModal('modalConquistasBarbeiro');
    const container = document.getElementById('listaConquistasBarbeiro');
    container.innerHTML = "";
    const conquistasDoUsuario = perfil.conquistas || [];
    for (const id in conquistasBarbeiroDefinidas) {
        const c = conquistasBarbeiroDefinidas[id];
        const unlocked = conquistasDoUsuario.includes(id);
        container.innerHTML += `<div class="conquista-item ${unlocked ? 'unlocked' : 'locked'}"><div class="conquista-icon">${c.icone}</div><div><b>${c.nome}</b><p style="font-size:12px; margin:0;">${c.descricao}</p></div></div>`;
    }
}

async function abrirModalRankingUnificado() {
    abrirModal('modalRankingUnificado');
    const containerClientes = document.getElementById('listaRankingClientesUnificado');
    const containerBarbeiros = document.getElementById('listaRankingBarbeirosUnificado');
    containerClientes.innerHTML = '<p>Carregando...</p>';
    containerBarbeiros.innerHTML = '<p>Carregando...</p>';

    try {
        const docClientes = await db.collection('config').doc('rankingClientes').get();
        if (docClientes.exists && docClientes.data().ranking) {
            containerClientes.innerHTML = "";
            docClientes.data().ranking.forEach((item, i) => {
                containerClientes.innerHTML += `<div class="ranking-item"><span>${i + 1}. ${item.nome}</span><span>${item.contagem}</span></div>`;
            });
        } else {
            containerClientes.innerHTML = '<p>Nenhum ranking disponﾃｭvel.</p>';
        }
    } catch (e) { containerClientes.innerHTML = '<p>Erro ao carregar ranking.</p>'; }

    try {
        const docBarbeiros = await db.collection('config').doc('rankingBarbeiros').get();
        if (docBarbeiros.exists && docBarbeiros.data().ranking) {
            containerBarbeiros.innerHTML = "";
            docBarbeiros.data().ranking.forEach((item, i) => {
                containerBarbeiros.innerHTML += `<div class="ranking-item"><span>${i + 1}. ${item.nome}</span><span>${item.contagem}</span></div>`;
            });
        } else {
            containerBarbeiros.innerHTML = '<p>Nenhum ranking disponﾃｭvel.</p>';
        }
    } catch(e) { containerBarbeiros.innerHTML = '<p>Erro ao carregar ranking.</p>'; }
}


function obterIconeMaiorConquista(conquistas, tipo) {
    if (!conquistas || conquistas.length === 0) return '';
    const ordem = tipo === 'cliente' ? conquistasOrdem : conquistasBarbeiroOrdem;
    const definicoes = tipo === 'cliente' ? conquistasDefinidas : conquistasBarbeiroDefinidas;
    for (const id of ordem) {
        if (conquistas.includes(id)) {
            return `<span class="chat-medal">${definicoes[id].icone}</span>`;
        }
    }
    return '';
}

async function abrirModalDashboardBarbeiro() {
    abrirModal('modalDashboardBarbeiro');
    const container = document.getElementById('dashboardConteudo');
    container.innerHTML = '<p>Calculando...</p>';
    try {
        const agora = new Date();
        const trintaDiasAtras = new Date(new Date().setDate(agora.getDate() - 30));
        
        const snap = await db.collection('agendamentos')
            .where('barbeiroUid', '==', auth.currentUser.uid)
            .get();

        let faturamentoTotal = 0, faturamento30d = 0;
        let concluidosTotal = 0, canceladosTotal = 0;
        const clientes = new Set();
        const servicos = {};
        
        snap.forEach(doc => {
            const ag = doc.data();
            clientes.add(ag.clienteUid);
            
            if(ag.status === 'concluido'){
                concluidosTotal++;
                faturamentoTotal += ag.valor;
                servicos[ag.servico] = (servicos[ag.servico] || 0) + 1;
                if(ag.ts.toDate() > trintaDiasAtras){
                    faturamento30d += ag.valor;
                }
            } else if (ag.status === 'cancelado'){
                canceladosTotal++;
            }
        });
        
        const taxaCancelamento = (concluidosTotal + canceladosTotal) > 0 ? ((canceladosTotal / (concluidosTotal + canceladosTotal)) * 100).toFixed(1) : 0;
        const popular = Object.entries(servicos).sort((a, b) => b[1] - a[1])[0]?.[0] || "N/A";
        const mediaAvaliacoes = perfil.numAvaliacoes > 0 ? (perfil.somaAvaliacoes / perfil.numAvaliacoes).toFixed(1) : "N/A";

        const servicosHtml = Object.entries(servicos).sort((a,b) => b[1] - a[1]).map(([nome, qtde]) => `<p>${nome}: <b>${qtde}</b></p>`).join('');

        container.innerHTML = `
            <div class="popup-section"><h4>Visﾃ｣o Geral</h4>
                <p>箝 Avaliaﾃｧﾃ｣o Mﾃｩdia: <b>${mediaAvaliacoes} / 10</b> (${perfil.numAvaliacoes} avaliaﾃｧﾃｵes)</p>
                <p>ｧ鯛昨洟昶昨洫 Clientes ﾃ嗜icos: <b>${clientes.size}</b></p>
                <p>嶋 Cortes Concluﾃｭdos: <b>${concluidosTotal}</b></p>
                <p>笶 Taxa de Cancelamento: <b>${taxaCancelamento}%</b></p>
            </div>
            <div class="popup-section"><h4>腸 Financeiro</h4>
                <p>Faturamento Total: <b>R$ ${faturamentoTotal.toFixed(2)}</b></p>
                <p>Faturamento (ﾃ嗟timos 30 dias): <b>R$ ${faturamento30d.toFixed(2)}</b></p>
            </div>
            <div class="popup-section"><h4>笨ゑｸ Serviﾃｧos</h4>
                <p>Serviﾃｧo Mais Popular: <b>${popular}</b></p>
                ${servicosHtml}
            </div>
        `;
    } catch (e) { 
        container.innerHTML = '<p>Erro ao carregar dados.</p>'; 
        console.error("Erro no dashboard do barbeiro:", e);
    }
}

// Funﾃｧﾃｵes de Portfﾃｳlio
function abrirModalPortfolioBarbeiro() {
    abrirModal('modalPortfolioBarbeiro');
    const container = document.getElementById('portfolioInputsContainer');
    container.innerHTML = '';
    const portfolioAtual = perfil.portfolio || [];
    for (let i = 0; i < 10; i++) {
        container.innerHTML += `<input type="url" class="portfolio-url-input" placeholder="迫 Link direto que termina com .png/.jpg aqui" value="${portfolioAtual[i] || ''}">`;
    }
}

function salvarPortfolio() {
    const inputs = document.querySelectorAll('.portfolio-url-input');
    const novasUrls = Array.from(inputs).map(input => input.value.trim()).filter(url => url);
    
    db.collection('usuarios').doc(auth.currentUser.uid).update({
        portfolio: novasUrls
    }).then(() => {
        alert('Portfﾃｳlio salvo com sucesso!');
        fecharModalAtual();
    }).catch(e => alert('Erro ao salvar portfﾃｳlio: ' + e.message));
}

async function abrirPortfolioCliente(barbeiroUid, barbeiroNome) {
    const doc = await db.collection('usuarios').doc(barbeiroUid).get();
    if (!doc.exists) return;
    const portfolio = doc.data().portfolio || [];
    
    const grid = document.getElementById('portfolioClienteGrid');
    grid.innerHTML = '';
    document.getElementById('portfolioClienteNome').textContent = `名ｸ Portfﾃｳlio de ${barbeiroNome}`;
    
    if (portfolio.length > 0) {
        portfolio.forEach(url => {
            grid.innerHTML += `<img src="${url}" alt="Foto do portfﾃｳlio" onerror="this.src='https://via.placeholder.com/150?text=Erro'">`;
        });
    } else {
        grid.innerHTML = '<p>Este barbeiro ainda nﾃ｣o adicionou imagens ao portfﾃｳlio.</p>';
    }
    
    abrirModal('modalPortfolioCliente');
}

function calcularDistancia(lat1, lon1, lat2, lon2) {
    const R = 6371; // Raio da Terra em km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c; // Distﾃ｢ncia em km
}

function obterLocalizacaoAtual() {
    return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
            return reject(new Error("Geolocalizaﾃｧﾃ｣o nﾃ｣o suportada."));
        }
        navigator.geolocation.getCurrentPosition(
            (position) => {
                localizacaoCliente = {
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude,
                };
                resolve(localizacaoCliente);
            },
            (error) => {
                console.warn("Nﾃ｣o foi possﾃｭvel obter a localizaﾃｧﾃ｣o: ", error.message);
                reject(error);
            }
        );
    });
}

function obterLocalizacaoCadastro() {
    const btn = document.getElementById('btnLocalizacaoCadastro');
    if(btn) btn.textContent = '竢ｳ Obtendo localizaﾃｧﾃ｣o...';
    if (!navigator.geolocation) {
        alert("Geolocalizaﾃｧﾃ｣o nﾃ｣o ﾃｩ suportada pelo seu navegador.");
        if(btn) btn.textContent = '桃 Usar minha localizaﾃｧﾃ｣o atual';
        return;
    }
    navigator.geolocation.getCurrentPosition(
        (position) => {
            cadastroCoords = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
            };
            alert("Localizaﾃｧﾃ｣o obtida com sucesso!");
            if(btn) btn.textContent = '笨 Localizaﾃｧﾃ｣o Obtida!';
        },
        (error) => {
            alert("Nﾃ｣o foi possﾃｭvel obter a localizaﾃｧﾃ｣o. Por favor, verifique as permissﾃｵes no seu navegador.");
            if(btn) btn.textContent = '桃 Usar minha localizaﾃｧﾃ｣o atual';
        }
    );
}

function abrirRota(barbeiroLat, barbeiroLon) {
    if (localizacaoCliente) {
        window.open(`https://www.google.com/maps/dir/?api=1&origin=${localizacaoCliente.latitude},${localizacaoCliente.longitude}&destination=${barbeiroLat},${barbeiroLon}`, '_blank');
    } else {
        window.open(`https://www.google.com/maps/search/?api=1&query=${barbeiroLat},${barbeiroLon}`, '_blank');
    }
}

function abrirModalTurbinar(){
    abrirModal('modalTurbinar');
}

function confirmarTurbinar() {
    if (perfil.saldo < PRECO_TURBINAR) {
        return alert(`Saldo insuficiente. Vocﾃｪ precisa de R$ ${PRECO_TURBINAR.toFixed(2)}.`);
    }
    if (perfil.ultimoBoostComprado) {
        const vinteQuatroHorasAtras = new Date(Date.now() - 24 * 60 * 60 * 1000);
        if (perfil.ultimoBoostComprado.toDate() > vinteQuatroHorasAtras) {
            return alert("Vocﾃｪ sﾃｳ pode turbinar o perfil uma vez a cada 24 horas.");
        }
    }
    if (confirm(`Confirmar o boost de 24h por R$ ${PRECO_TURBINAR.toFixed(2)}? O valor serﾃ｡ descontado do seu saldo.`)) {
        const expiracao = new Date(Date.now() + 24 * 60 * 60 * 1000);
        db.collection('usuarios').doc(auth.currentUser.uid).update({
            saldo: firebase.firestore.FieldValue.increment(-PRECO_TURBINAR),
            boostExpiracao: firebase.firestore.Timestamp.fromDate(expiracao),
            ultimoBoostComprado: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
            alert('Perfil turbinado com sucesso! Vocﾃｪ estﾃ｡ no topo da lista por 24 horas.');
            fecharModalAtual();
        }).catch(e => alert('Erro ao turbinar perfil: ' + e.message));
    }
}

// Funﾃｧﾃｵes da Loja
function abrirModalParaVender() {
    if (perfil.lojaLiberada || perfil.tipo === 'admin') {
        abrirFormularioProduto();
    } else {
        abrirModal('modalLiberarLoja');
    }
}

function solicitarLiberacaoLoja() {
    const mensagem = encodeURIComponent(`Olﾃ｡, gostaria de solicitar autorizaﾃｧﾃ｣o para cadastrar produtos na loja. Meu nome de usuﾃ｡rio ﾃｩ ${perfil.nome}.`);
    window.open(`https://wa.me/${WHATSAPP_ADM_PHONE}?text=${mensagem}`, '_blank');
    db.collection("solicitacoes").add({
        tipo: "liberacao_loja",
        usuarioUid: auth.currentUser.uid,
        usuarioNome: perfil.nome,
        status: "pendente",
        ts: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
        alert("Sua solicitaﾃｧﾃ｣o foi enviada ao administrador. Vocﾃｪ serﾃ｡ redirecionado para o WhatsApp para confirmar.");
    }).catch(e => alert("Erro ao criar solicitaﾃｧﾃ｣o: " + e.message));
}

function aprovarLiberacaoLoja(solicitacaoId, uid) {
    db.runTransaction(async t => {
        t.update(db.collection("usuarios").doc(uid), { lojaLiberada: true });
        t.update(db.collection("solicitacoes").doc(solicitacaoId), { status: "aprovado" });
    }).then(() => {
        alert("Acesso ﾃ loja liberado!");
        notifyUser(uid, "寫ｸ Acesso ﾃ Loja Liberado!", "Parabﾃｩns! Vocﾃｪ jﾃ｡ pode cadastrar seus produtos para vender no app.");
    }).catch(e => alert("Erro ao aprovar: " + e.message));
}

async function carregarProdutos() {
    const container = document.getElementById('lojaContainer');
    container.innerHTML = '<p>Carregando loja...</p>';

    try {
        const usersSnap = await db.collection('usuarios').get();
        const usersData = {};
        usersSnap.forEach(doc => {
            usersData[doc.id] = doc.data();
        });

        const produtosSnap = await db.collection('loja_produtos').orderBy('ts', 'desc').get();
        
        let officialHtml = '<h4 style="grid-column: 1 / -1;">箝 Oficiais Navalha de Ouro 箝</h4>';
        let communityProducts = [];
        let officialProductsFound = false;

        produtosSnap.forEach(doc => {
            const produto = { ...doc.data(), id: doc.id };
            const produtoJSON = JSON.stringify(produto).replace(/'/g, "\\'");
            if (produto.isOficial) {
                officialHtml += renderProdutoCard(produto, produtoJSON);
                officialProductsFound = true;
            } else {
                communityProducts.push({ data: produto, json: produtoJSON });
            }
        });

        if (!officialProductsFound) {
            officialHtml += '<p style="grid-column: 1 / -1; font-size: 14px; opacity: 0.7;">Nenhum produto oficial no momento.</p>';
        }

        const getUserScore = (uid) => {
            const user = usersData[uid];
            if (!user) return 0;
            if (user.vip) return 4;
            const isBoosted = user.boostExpiracao && user.boostExpiracao.toDate() > new Date();
            if (isBoosted) return 3;
            if (user.tipo === 'barbeiro') return 2;
            if (user.tipo === 'cliente') return 1;
            return 0;
        };

        communityProducts.sort((a, b) => {
            const scoreA = getUserScore(a.data.vendedorUid);
            const scoreB = getUserScore(b.data.vendedorUid);
            return scoreB - scoreA;
        });

        let communityHtml = '<h4 style="grid-column: 1 / -1; margin-top: 20px;">將 Marketplace da Comunidade</h4>';
        if (communityProducts.length === 0) {
            communityHtml += '<p style="grid-column: 1 / -1;">Nenhum produto da comunidade ainda.</p>';
        } else {
            communityProducts.forEach(p => {
                communityHtml += renderProdutoCard(p.data, p.json);
            });
        }
        
        container.innerHTML = officialHtml + communityHtml;

    } catch (error) {
        console.error("Erro ao carregar produtos:", error);
        container.innerHTML = '<p>Ocorreu um erro ao carregar a loja.</p>';
    }
}


function renderProdutoCard(p) {
  const precoFinal = p.desconto ? p.preco * (1 - p.desconto / 100) : p.preco;
  const precoHtml = p.desconto
    ? `<span class="produto-preco-original">R$ ${p.preco.toFixed(2)}</span> R$ ${precoFinal.toFixed(2)}`
    : `R$ ${p.preco.toFixed(2)}`;

  const produtoStr = encodeURIComponent(JSON.stringify(p));

  return `
    <div class="produto-card" onclick='handleProdutoClick("${produtoStr}")'>
      <img src="${p.imagemUrl}" alt="${p.nome}" onerror="this.src='https://via.placeholder.com/150?text=Navalha'">
      <div class="produto-info">
        <div class="produto-nome">${p.nome}</div>
        <div class="produto-preco">${precoHtml}</div>
      </div>
    </div>
  `;
}

function handleProdutoClick(produtoStr) {
  try {
    const produto = JSON.parse(decodeURIComponent(produtoStr));
    if (!auth.currentUser) {
      alert("Para ver detalhes e comprar produtos, por favor, faﾃｧa login ou crie uma conta.");
      mostrar('authView');
    } else {
      abrirDetalhesProduto(produto);
    }
  } catch (e) {
    console.error("Erro ao abrir produto:", e);
    alert("Nﾃ｣o foi possﾃｭvel abrir os detalhes do produto.");
  }
}

async function exibirVersaoApp() {
    try {
        const response = await fetch('/index.html', { method: 'HEAD', cache: 'no-store' });
        const lastModified = response.headers.get('Last-Modified');
        if (lastModified) {
            const d = new Date(lastModified);
            const version = `V${d.getFullYear().toString().slice(-2)}.${(d.getMonth() + 1).toString().padStart(2, '0')}.${d.getDate().toString().padStart(2, '0')}.${d.getHours().toString().padStart(2, '0')}${d.getMinutes().toString().padStart(2, '0')}`;
            document.getElementById('appVersion').textContent = version;
        }
    } catch(e) {
        console.error("Erro ao obter versﾃ｣o do app:", e);
        document.getElementById('appVersion').textContent = 'V.Local';
    }
}

function recarregarSaldoDoUsuario() {
    alert("腸 Seu saldo foi atualizado! A interface irﾃ｡ refletir a mudanﾃｧa em instantes.");
}

if (firebase.messaging.isSupported()) {
    messaging.onMessage((payload) => {
        console.log('Mensagem de primeiro plano recebida:', payload);

        if (payload.data && payload.data.tipo === 'atualizar_saldo') {
            recarregarSaldoDoUsuario();
        }

        if (payload.notification) {
            const notificationTitle = payload.notification.title;
            const notificationOptions = {
                body: payload.notification.body,
                icon: payload.notification.icon || '/icone.png'
            };
            if (Notification.permission === 'granted') {
                new Notification(notificationTitle, notificationOptions);
            }
        }
    });
}
// NOVAS FUNﾃﾃ髭S DA LOJA E GERENCIAMENTO
async function abrirDetalhesProduto(produto) {
    produtoParaCompra = produto;
    document.getElementById('detalhesProdutoImg').src = produto.imagemUrl;
    document.getElementById('detalhesProdutoNome').textContent = produto.nome;
    const precoFinal = produto.desconto ? produto.preco * (1 - produto.desconto / 100) : produto.preco;
    document.getElementById('detalhesProdutoPreco').textContent = `R$ ${precoFinal.toFixed(2)}`;
    document.getElementById('detalhesProdutoDescricao').textContent = produto.descricao;
    document.getElementById('detalhesProdutoEntrega').textContent = produto.tempoEntrega;
    
    const tamanhosContainer = document.getElementById('detalhesProdutoTamanhos');
    tamanhosContainer.innerHTML = '';
    if (produto.tamanhos && produto.tamanhos.length > 0) {
        produto.tamanhos.forEach(t => {
            tamanhosContainer.innerHTML += `<input type="radio" name="tamanho_selecionado" value="${t}" id="tamanho_${t}"><label for="tamanho_${t}">${t}</label>`;
        });
    } else {
        tamanhosContainer.innerHTML = 'Tamanho ﾃｺnico';
    }
    
    // Lﾃｳgica de avaliaﾃｧﾃ｣o
    const avaliacaoContainer = document.getElementById('detalhesProdutoAvaliacao');
    await carregarAvaliacaoProduto(produto.id, produto.nome, avaliacaoContainer);
    
    document.getElementById('btnComprarAgora').onclick = () => iniciarCompra(produto);
    abrirModal('modalProdutoDetalhes');
}

function iniciarCompra(produto) {
    const tamanhoSelecionado = document.querySelector('input[name="tamanho_selecionado"]:checked');
    if ((produto.tamanhos && produto.tamanhos.length > 0) && !tamanhoSelecionado) {
        return alert('Por favor, selecione um tamanho.');
    }
    
    document.getElementById('compraEndereco').value = '';
    document.getElementById('compraTelefone').value = perfil.telefone || '';
    document.getElementById('compraCep').value = '';
    
    document.getElementById('btnConfirmarCompraFinal').onclick = () => confirmarCompra(produto, tamanhoSelecionado ? tamanhoSelecionado.value : 'ﾃｺnico');
    abrirModal('modalConfirmarCompra');
}

async function confirmarCompra(produto, tamanho) {
    const endereco = document.getElementById('compraEndereco').value.trim();
    const telefone = document.getElementById('compraTelefone').value.trim();
    const cep = document.getElementById('compraCep').value.trim();
    if (!endereco || !telefone || !cep) return alert('Endereﾃｧo, telefone e CEP sﾃ｣o obrigatﾃｳrios.');

    const precoFinal = produto.desconto ? produto.preco * (1 - produto.desconto / 100) : produto.preco;
    if (perfil.saldo < precoFinal) return alert('Saldo insuficiente.');
    
    if(!confirm('Confirmar o pedido? O valor serﾃ｡ debitado do seu saldo.')) return;
    
    try {
        await db.runTransaction(async t => {
            const clienteRef = db.collection("usuarios").doc(auth.currentUser.uid);
            const vendedorRef = db.collection("usuarios").doc(produto.vendedorUid);
            const adminSnap = await db.collection("usuarios").where("tipo", "==", "admin").limit(1).get();
            const adminRef = db.collection("usuarios").doc(adminSnap.docs[0].id);
            const produtoRef = db.collection("loja_produtos").doc(produto.id);

            const valorVendedor = precoFinal * (1 - TAXA);
            const valorAdmin = precoFinal * TAXA;

            t.update(clienteRef, { saldo: firebase.firestore.FieldValue.increment(-precoFinal) });
            t.update(vendedorRef, { saldo: firebase.firestore.FieldValue.increment(valorVendedor) });
            t.update(adminRef, { saldo: firebase.firestore.FieldValue.increment(valorAdmin) });
            t.update(produtoRef, { vendasRealizadas: firebase.firestore.FieldValue.increment(1) });
            
            t.set(db.collection("loja_pedidos").doc(), {
                produtoId: produto.id,
                produtoNome: produto.nome,
                valor: precoFinal,
                tamanho,
                clienteUid: auth.currentUser.uid,
                clienteNome: perfil.nome,
                endereco,
                telefone,
                cep,
                vendedorUid: produto.vendedorUid,
                vendedorNotificado: false,
                status: "pendente", // Status inicial
                ts: firebase.firestore.FieldValue.serverTimestamp()
            });
        });

        alert("Pedido realizado com sucesso!");
        notifyUser(auth.currentUser.uid, '逃 Pedido Confirmado!', `Sua compra de "${produto.nome}" foi realizada.`);
        notifyUser(produto.vendedorUid, '脂 Nova Venda!', `Vocﾃｪ vendeu um(a) "${produto.nome}" para ${perfil.nome}.`);
        fecharModalAtual();
    } catch (e) {
        alert('Erro ao processar a compra: ' + e.message);
    }
}

async function abrirGerenciarLoja() {
    abrirModal('modalGerenciarLoja');
    const container = document.getElementById('listaMeusProdutos');
    container.innerHTML = '<p>Carregando seus produtos...</p>';
    
    const snap = await db.collection('loja_produtos').where('vendedorUid', '==', auth.currentUser.uid).get();
    if (snap.empty) {
        container.innerHTML = '<p>Vocﾃｪ ainda nﾃ｣o tem produtos cadastrados.</p>';
        return;
    }
    
    container.innerHTML = '';
    snap.forEach(doc => {
        const p = doc.data();
        container.innerHTML += `
            <div class="card">
                <b>${p.nome}</b> - R$ ${p.preco.toFixed(2)}
                <p>Vendas: ${p.vendasRealizadas || 0}</p>
                <div style="display: flex; gap: 5px; margin-top: 5px;">
                    <button onclick="abrirFormularioProduto('${doc.id}')" style="font-size:12px; padding: 5px 8px;">笨擾ｸ Editar</button>
                    <button onclick="deletarProdutoVendedor('${doc.id}')" style="background: #c0392b; font-size:12px; padding: 5px 8px;">卵ｸ Excluir</button>
                </div>
            </div>`;
    });
}

async function abrirFormularioProduto(produtoId = null) {
    produtoEmEdicaoId = produtoId;
    const form = document.getElementById('modalAddEditProduto');
    document.getElementById('formProdutoTitulo').textContent = produtoId ? '笨擾ｸ Editar Produto' : '逃 Adicionar Novo Produto';
    
    // Reset form
    form.querySelector('#produtoNome').value = '';
    form.querySelector('#produtoImagemUrl').value = '';
    form.querySelector('#produtoPreco').value = '';
    form.querySelector('#produtoDesconto').value = '';
    form.querySelector('#produtoEntrega').value = '';
    form.querySelector('#produtoDescricao').value = '';
    form.querySelectorAll('input[name="tamanhos"]').forEach(c => c.checked = false);

    if (produtoId) {
        const doc = await db.collection('loja_produtos').doc(produtoId).get();
        const p = doc.data();
        form.querySelector('#produtoNome').value = p.nome;
        form.querySelector('#produtoImagemUrl').value = p.imagemUrl;
        form.querySelector('#produtoPreco').value = p.preco;
        form.querySelector('#produtoDesconto').value = p.desconto || '';
        form.querySelector('#produtoEntrega').value = p.tempoEntrega || '';
        form.querySelector('#produtoDescricao').value = p.descricao || '';
        if (p.tamanhos) {
            p.tamanhos.forEach(t => {
                const checkbox = form.querySelector(`input[value="${t}"]`);
                if(checkbox) checkbox.checked = true;
            });
        }
    }
    abrirModal('modalAddEditProduto');
}

async function salvarProdutoVendedor() {
    const nome = document.getElementById('produtoNome').value.trim();
    const imagemUrl = document.getElementById('produtoImagemUrl').value.trim();
    const preco = parseFloat(document.getElementById('produtoPreco').value);
    const desconto = parseInt(document.getElementById('produtoDesconto').value) || 0;
    const tempoEntrega = document.getElementById('produtoEntrega').value.trim();
    const descricao = document.getElementById('produtoDescricao').value.trim();
    const tamanhos = Array.from(document.querySelectorAll('input[name="tamanhos"]:checked')).map(c => c.value);

    if(!nome || !imagemUrl || isNaN(preco) || preco <= 0 || !tempoEntrega) {
        return alert('Preencha nome, imagem, preﾃｧo e tempo de entrega.');
    }

    const data = {
        nome, imagemUrl, preco, desconto, tempoEntrega, descricao, tamanhos,
        vendedorUid: auth.currentUser.uid,
        vendedorNome: perfil.nome,
        isOficial: perfil.tipo === 'admin',
        ts: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    if (produtoEmEdicaoId) {
        await db.collection('loja_produtos').doc(produtoEmEdicaoId).update(data);
    } else {
        data.vendasRealizadas = 0;
        await db.collection('loja_produtos').add(data);
    }
    
    alert('Produto salvo com sucesso!');
    fecharModalAtual();
    abrirGerenciarLoja(); // Recarrega a lista
}

async function deletarProdutoVendedor(produtoId) {
    if (confirm('Tem certeza que deseja excluir este produto?')) {
        await db.collection('loja_produtos').doc(produtoId).delete();
        alert('Produto excluﾃｭdo.');
        abrirGerenciarLoja();
    }
}

async function abrirEntregasVendedor() {
    abrirModal('modalEntregasVendedor');
    const container = document.getElementById('listaEntregas');
    container.innerHTML = '<p>Carregando entregas...</p>';
    
    if (pedidosVendedorListener) pedidosVendedorListener();
    pedidosVendedorListener = db.collection('loja_pedidos')
      .where('vendedorUid', '==', auth.currentUser.uid)
      .where('status', 'in', ['pendente', 'confirmado_pelo_cliente'])
      .onSnapshot(snap => {
        if(snap.empty) {
            container.innerHTML = '<p>Nenhuma entrega pendente.</p>';
            return;
        }
        container.innerHTML = '';
        snap.forEach(doc => {
            const pedido = doc.data();
            let statusHtml = '';
            let acaoHtml = `<button onclick="marcarComoEntregue('${doc.id}', '${pedido.clienteUid}')">Marcar como Entregue</button>`;
            
            if (pedido.status === 'pendente') {
                statusHtml = '<p style="color: #f1c40f;">Status: Aguardando Entrega</p>';
            } else if (pedido.status === 'confirmado_pelo_cliente') {
                statusHtml = '<p style="color: #2ecc71;">Status: Cliente confirmou recebimento!</p>';
                acaoHtml = '<p>笨 Finalizado</p>';
            }

            container.innerHTML += `
                <div class="card">
                    <b>Comprador: ${pedido.clienteNome}</b>
                    <p>Produto: ${pedido.produtoNome} (T: ${pedido.tamanho})</p>
                    <p>Endereﾃｧo: ${pedido.endereco} - CEP: ${pedido.cep}</p>
                    <p>WhatsApp: <a href="https://wa.me/55${pedido.telefone}" target="_blank">${pedido.telefone}</a></p>
                    ${statusHtml}
                    ${acaoHtml}
                </div>`;
        });
    });
}

async function marcarComoEntregue(pedidoId, clienteUid) {
    if (!confirm("Confirmar que o produto foi entregue? O comprador serﾃ｡ notificado para confirmar o recebimento.")) return;
    try {
        await db.collection('loja_pedidos').doc(pedidoId).update({ status: 'entregue_pendente_confirmacao' });
        notifyUser(clienteUid, '囹 Seu Pedido foi Entregue!', 'Por favor, confirme o recebimento do seu produto no app para finalizar a compra.');
        alert('Notificaﾃｧﾃ｣o enviada ao comprador.');
    } catch (e) {
        alert('Erro ao marcar como entregue: ' + e.message);
    }
}

async function abrirMinhasCompras() {
    abrirModal('modalMinhasCompras');
    const container = document.getElementById('listaMinhasCompras');
    container.innerHTML = '<p>Carregando suas compras...</p>';

    const snap = await db.collection('loja_pedidos').where('clienteUid', '==', auth.currentUser.uid).orderBy('ts', 'desc').get();
    if (snap.empty) {
        container.innerHTML = '<p>Vocﾃｪ ainda nﾃ｣o fez nenhuma compra.</p>';
        return;
    }
    container.innerHTML = '';
    snap.forEach(doc => {
        const compra = doc.data();
        let statusTexto = 'Status desconhecido';
        switch(compra.status) {
            case 'pendente': statusTexto = 'Aguardando entrega'; break;
            case 'entregue_pendente_confirmacao': statusTexto = 'Confirme o recebimento!'; break;
            case 'confirmado_pelo_cliente': statusTexto = 'Entrega confirmada'; break;
            case 'disputa': statusTexto = 'Entrega recusada'; break;
        }
        container.innerHTML += `
            <div class="card">
                <b>${compra.produtoNome}</b>
                <p>Status: ${statusTexto}</p>
            </div>
        `;
    });
}

function abrirModalConfirmacaoComprador(pedido) {
    document.getElementById('btnAceitarEntrega').onclick = () => responderConfirmacaoEntrega(pedido.id, true);
    document.getElementById('btnRecusarEntrega').onclick = () => responderConfirmacaoEntrega(pedido.id, false);
    abrirModal('modalConfirmacaoComprador');
}

async function responderConfirmacaoEntrega(pedidoId, aceito) {
    const novoStatus = aceito ? 'confirmado_pelo_cliente' : 'disputa';
    try {
        const pedidoDoc = await db.collection('loja_pedidos').doc(pedidoId).get();
        const vendedorUid = pedidoDoc.data().vendedorUid;
        await db.collection('loja_pedidos').doc(pedidoId).update({ status: novoStatus });
        const msg = aceito ? '笨 O comprador confirmou o recebimento!' : '笶 O comprador recusou o recebimento. Entre em contato.';
        notifyUser(vendedorUid, '逃 Atualizaﾃｧﾃ｣o de Entrega', msg);
        alert('Resposta enviada com sucesso!');
        fecharModalAtual();
    } catch (e) {
        alert('Erro ao enviar resposta: ' + e.message);
    }
}
function toggleFuncoes(containerId) {
    const container = document.getElementById(containerId);
    if (container) {
        container.classList.toggle('hidden');
    }
}

function handleProdutoClick(produtoStr) {
  try {
    const produto = JSON.parse(decodeURIComponent(produtoStr));
    if (!auth.currentUser) {
      alert("Para ver detalhes e comprar produtos, por favor, faﾃｧa login ou crie uma conta.");
      mostrar('authView');
    } else {
      abrirDetalhesProduto(produto);
    }
  } catch (e) {
    console.error("Erro ao abrir produto:", e);
    alert("Nﾃ｣o foi possﾃｭvel abrir os detalhes do produto.");
  }
}

// Lﾃｳgica de verificaﾃｧﾃ｣o de pendﾃｪncias e notificaﾃｧﾃｵes
function iniciarVerificacaoDePendencias(uid) {
    if (pendenciasInterval) clearInterval(pendenciasInterval);
    verificarPendencias(uid); // Executa uma vez imediatamente
    pendenciasInterval = setInterval(() => verificarPendencias(uid), 60000); // Executa a cada minuto
}

async function verificarPendencias(uid) {
    if (!uid || !perfil) return;

    // Barbeiro: Agendamentos pendentes
    if (perfil.tipo === 'barbeiro') {
        const agendamentosSnap = await db.collection('agendamentos').where('barbeiroUid', '==', uid).where('status', '==', 'pendente').get();
        const btnAgendamentos = document.getElementById('btnAgendamentosBarbeiro');
        if (!agendamentosSnap.empty) {
            btnAgendamentos?.classList.add('notificacao-pulsante');
            notifyUser(uid, '竢ｰ Agendamento Pendente', `Vocﾃｪ tem ${agendamentosSnap.size} novo(s) agendamento(s) para aprovar.`);
        } else {
            btnAgendamentos?.classList.remove('notificacao-pulsante');
        }
    }

    // Cliente: Avaliaﾃｧﾃｵes pendentes
    if (perfil.tipo === 'cliente') {
        const avaliacoesSnap = await db.collection('agendamentos').where('clienteUid', '==', uid).where('status', '==', 'concluido').where('avaliado', '==', false).get();
        const btnHistorico = document.getElementById('btnHistoricoCliente');
        if (!avaliacoesSnap.empty) {
            btnHistorico?.classList.add('notificacao-pulsante');
            notifyUser(uid, '箝 Avaliaﾃｧﾃ｣o Pendente', `Vocﾃｪ tem ${avaliacoesSnap.size} serviﾃｧo(s) para avaliar e ganhar pontos!`);
        } else {
            btnHistorico?.classList.remove('notificacao-pulsante');
        }
    }
}

// Lﾃｳgica de avaliaﾃｧﾃ｣o de produtos
async function carregarAvaliacaoProduto(produtoId, produtoNome, container) {
    container.innerHTML = '';
    
    // Regra para produtos "Navalha de Ouro"
    if (produtoNome.toLowerCase().includes('navalha de ouro')) {
        const hoje = new Date().toISOString().split('T')[0]; // 'YYYY-MM-DD'
        const seed = produtoId + hoje;
        let hash = 0;
        for (let i = 0; i < seed.length; i++) {
            const char = seed.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash |= 0; 
        }
        const randomValue = (Math.abs(hash) % 10) / 10; // Valor de 0.0 a 0.9
        const notaAleatoria = (4.1 + randomValue).toFixed(1);

        const snap = await db.collection('avaliacoes_produtos').where('produtoId', '==', produtoId).orderBy('ts', 'desc').limit(1).get();
        
        let avaliacaoHtml = `<p class="avaliacao-estrelas">箝 ${notaAleatoria}</p>`;
        
        if (!snap.empty) {
            const ultimaAvaliacao = snap.docs[0].data();
            const doisDiasAtras = new Date(Date.now() - 2 * 24 * 60 * 60 * 1000);
            if (ultimaAvaliacao.ts.toDate() > doisDiasAtras) {
                avaliacaoHtml += `<p class="avaliacao-comentario">"${ultimaAvaliacao.comentario}"</p>`;
            } else {
                 avaliacaoHtml += `<p class="avaliacao-comentario">Veja as avaliaﾃｧﾃｵes dos clientes.</p>`;
            }
        } else {
             avaliacaoHtml += `<p class="avaliacao-comentario">Seja o primeiro a avaliar!</p>`;
        }
        container.innerHTML = avaliacaoHtml;

    } else {
        // Regra para outros produtos
        const snap = await db.collection('avaliacoes_produtos').where('produtoId', '==', produtoId).orderBy('ts', 'desc').limit(1).get();
        if (snap.empty) {
            container.innerHTML = `<p class="avaliacao-estrelas">箝 Sem avaliaﾃｧﾃ｣o</p><p class="avaliacao-comentario">Seja o primeiro a avaliar!</p>`;
        } else {
            const avaliacao = snap.docs[0].data();
            container.innerHTML = `
                <p class="avaliacao-estrelas">箝 ${avaliacao.nota.toFixed(1)}</p>
                <p class="avaliacao-comentario">"${avaliacao.comentario}"</p>
            `;
        }
    }
}
</script>
<script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('/firebase-messaging-sw.js').then(function(reg) {
          console.log('笨 Service Worker registrado com sucesso:', reg.scope);

          reg.addEventListener('updatefound', () => {
            newWorker = reg.installing;
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                 const modal = document.getElementById('modalAtualizacao');
                 const btn = document.getElementById('btnAtualizarApp');
                 btn.onclick = () => {
                   newWorker.postMessage({ type: 'SKIP_WAITING' });
                 };
                 abrirModal('modalAtualizacao');
              }
            });
          });
        }).catch(function(err) {
          console.error('笶 Falha ao registrar Service Worker:', err);
        });

        let refreshing;
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          if (refreshing) return;
          window.location.reload();
          refreshing = true;
        });
      });
    }
/* ============================================
   PART 2 窶 IMPLEMENTAﾃﾃ髭S 1窶7 (APENAS ADIﾃﾃ髭S)
   Cole este bloco no FINAL do seu <script> atual
   ============================================ */

// [1] VIP: brilho dourado sem pulsar quando VIP; pulsar removido
const GOLD_PULSE_CLASS = 'notificacao-pulsante-gold';
(function injectGoldPulseCSS(){
  const style = document.createElement('style');
  style.textContent = `
    .notificacao-pulsante-gold {
      position: relative;
      animation: gold-pulse 1.5s ease-in-out infinite;
      box-shadow: 0 0 12px rgba(255, 215, 0, 0.6);
      border-color: var(--cor-destaque-ouro) !important;
    }
    @keyframes gold-pulse {
      0% { box-shadow: 0 0 6px rgba(255,215,0,0.3); transform: scale(1); }
      50% { box-shadow: 0 0 16px rgba(255,215,0,0.7); transform: scale(1.02); }
      100% { box-shadow: 0 0 6px rgba(255,215,0,0.3); transform: scale(1); }
    }
    .vip-brilho-dourado {
      box-shadow: inset 0 0 0 999px rgba(255, 215, 0, 0.12), 0 0 10px rgba(255,215,0,0.5);
      border-color: var(--cor-destaque-ouro) !important;
    }
  `;
  document.head.appendChild(style);
})();

function atualizarEstadoBotaoVip() {
  const btnVip = document.getElementById('btnVip');
  if (!btnVip || !perfil) return;
  btnVip.classList.remove('notificacao-pulsante', GOLD_PULSE_CLASS, 'vip-glow');
  if (perfil.vip) {
    btnVip.textContent = '荘 Sou VIP';
    btnVip.classList.add('vip-brilho-dourado');
  } else {
    btnVip.textContent = '虫 VIP';
    btnVip.classList.remove('vip-brilho-dourado');
  }
}
(function hookVipButtonState(){
  const applyVipStateInterval = setInterval(() => {
    if (perfil) {
      atualizarEstadoBotaoVip();
      clearInterval(applyVipStateInterval);
    }
  }, 500);
})();

// [2] Admin: botﾃｵes Solicitaﾃｧﾃｵes/Denﾃｺncias com pulsaﾃｧﾃ｣o dourada e notificaﾃｧﾃｵes por minuto
function atualizarPendenciasAdminBotoes() {
  const btnSolicitacoes = document.querySelector('#adminView button[onclick="abrirModalSolicitacoes()"]');
  const btnDenuncias = document.querySelector('#adminView button[onclick="abrirDenuncias()"]');
  if (!btnSolicitacoes || !btnDenuncias) return;

  db.collection("solicitacoes").where("status", "==", "pendente")
    .get().then(snap => {
      btnSolicitacoes.classList.toggle(GOLD_PULSE_CLASS, !snap.empty);
    });

  db.collection("denuncias").where("status", "==", "aberta")
    .get().then(snap => {
      btnDenuncias.classList.toggle(GOLD_PULSE_CLASS, !snap.empty);
    });
}

function iniciarNotificacoesPendentesPorMinuto() {
  if (window.__navalhaPendenciasTimer) return;
  window.__navalhaPendenciasTimer = setInterval(async () => {
    if (!perfil || !auth.currentUser) return;
    try {
      if (perfil.tipo === 'admin') {
        atualizarPendenciasAdminBotoes();
        const pendSolicit = await db.collection("solicitacoes").where("status", "==", "pendente").get();
        const pendDenun = await db.collection("denuncias").where("status", "==", "aberta").get();
        const totalPend = pendSolicit.size + pendDenun.size;
        if (totalPend > 0) {
          notifyUser(auth.currentUser.uid, "竢ｰ Pendﾃｪncias no Sistema", `Existem ${totalPend} itens pendentes para aﾃｧﾃ｣o.`, { deepLink: 'admin_pendencias' });
        }
      }
      if (perfil.tipo === 'barbeiro') {
        const pendAg = await db.collection('agendamentos').where('barbeiroUid', '==', auth.currentUser.uid).where('status', '==', 'pendente').get();
        if (!pendAg.empty) {
          notifyUser(auth.currentUser.uid, '竢ｰ Agendamento Pendente', `Vocﾃｪ tem ${pendAg.size} agendamento(s) para aprovar.`, { deepLink: 'barbeiro_agendamentos' });
        }
      }
      if (perfil.tipo === 'cliente') {
        const pendAv = await db.collection('agendamentos')
          .where('clienteUid', '==', auth.currentUser.uid)
          .where('status', '==', 'concluido')
          .where('avaliado', '==', false).get();
        if (!pendAv.empty) {
          notifyUser(auth.currentUser.uid, '箝 Avaliaﾃｧﾃ｣o Pendente', `Vocﾃｪ tem ${pendAv.size} serviﾃｧo(s) para avaliar!`, { deepLink: 'cliente_historico' });
        }
      }
    } catch (e) { console.warn('Falha ao checar pendﾃｪncias por minuto:', e); }
  }, 60000);
}
(function autoStartPendenciasAdmin(){
  const startInterval = setInterval(() => {
    if (auth && auth.currentUser) {
      iniciarNotificacoesPendentesPorMinuto();
      clearInterval(startInterval);
    }
  }, 800);
})();

// [3] Carteira depﾃｳsito: formulﾃ｡rio de dados + overlay expirado PIX + fechar popups ao confirmar + notificaﾃｧﾃ｣o admin ao copiar chave
// Modal de dados jﾃ｡ foi injetado na Parte 1; aqui estﾃ｡ o fluxo
(function patchDepositoFluxo(){
  const originalIniciarDeposito = iniciarDeposito;
  iniciarDeposito = function() {
    abrirModal('modalDadosDeposito');
    const inputs = ['depPrimeiroNome','depSegundoNome','depCPF','depTelefone'].map(id => document.getElementById(id));
    const btnCont = document.getElementById('btnContinuarDadosDeposito');
    const validate = () => {
      const filled = inputs.every(i => i && i.value.trim().length > 0);
      btnCont.disabled = !filled;
    };
    inputs.forEach(i => i.addEventListener('input', validate));
    validate();
    btnCont.onclick = () => {
      fecharModalAtual();
      abrirModal('modalDeposito');
    };
  };

  // Fechar todos os popups
  window.fecharTodosOsPopups = function() {
    const modals = document.querySelectorAll('.modal.show');
    modals.forEach(m => {
      m.classList.remove('show');
      setTimeout(() => { m.style.display = 'none'; }, 300);
    });
  };

  // Timer PIX com overlay
  const originalIniciarTimerPix = iniciarTimerPix;
  iniciarTimerPix = function(duracao){
    let timer = duracao;
    const display = document.getElementById('pixTimer');
    if (window.pixTimerInterval) clearInterval(window.pixTimerInterval);
    window.pixTimerInterval = setInterval(() => {
      const minutos = parseInt(timer / 60, 10);
      const segundos = parseInt(timer % 60, 10);
      display.textContent = `${minutos < 10 ? "0" + minutos : minutos}:${segundos < 10 ? "0" + segundos : segundos}`;
      if (--timer < 0) {
        clearInterval(window.pixTimerInterval);
        display.textContent = "EXPIRADO";
        abrirModal('modalPixExpirado');
      }
    }, 1000);
  };

  // Confirmar comprovante fecha tudo e abre WhatsApp (mantﾃｩm original)
  const originalConfirmarEnvioComprovante = confirmarEnvioComprovante;
  confirmarEnvioComprovante = function(){
    fecharTodosOsPopups();
    originalConfirmarEnvioComprovante();
  };

  // Copiar chave PIX dispara notificaﾃｧﾃ｣o verde para admin
  const originalCopiarCodigoPixAprimorado = copiarCodigoPixAprimorado;
  copiarCodigoPixAprimorado = function() {
    originalCopiarCodigoPixAprimorado();
    notifyAdmins("洸 Possﾃｭvel Depﾃｳsito via PIX", "Um usuﾃ｡rio copiou a chave PIX. Fique atento!", { tipo: 'deposito_pix_copiado' });
  };
})();

// [3b] Logout recarrega pﾃ｡gina
(function attachLogoutReload(){
  const btnSair = document.getElementById('btnSair');
  if (btnSair) {
    btnSair.onclick = async () => {
      try { await auth.signOut(); } finally { location.reload(); }
    };
  }
})();

// [4] Alternador de painel simplificado (nﾃ｣o-admin): ﾃｺnico botﾃ｣o Loja/Painel
(function patchViewSwitcher(){
  const originalSetup = setupViewSwitcher;
  setupViewSwitcher = function(){
    const container = document.getElementById("botaoExtra");
    if (!container) return originalSetup();
    container.innerHTML = "";
    if (!userView.originalType) return;

    if (userView.originalType === 'admin') {
      return originalSetup(); // Admin mantﾃｩm como estﾃ｡
    }
    const lojaVisivel = !document.getElementById('lojaView').classList.contains('hidden');
    const btn = document.createElement("button");
    btn.textContent = lojaVisivel ? "匠 Painel principal" : "寫ｸ Loja";
    btn.onclick = () => {
      if (lojaVisivel) {
        mostrarPainelAtual();
      } else {
        mostrar('lojaView'); carregarProdutos();
      }
      setupViewSwitcher();
    };
    btn.style.borderColor = "var(--cor-destaque-ouro)";
    container.appendChild(btn);
  };
})();

// [5] Confirmaﾃｧﾃ｣o de entrega: modal sem fechar, vendedor sﾃｳ conclui quando cliente aceitar
(function patchConfirmacaoEntrega(){
  const originalAbrirModalConfirmacaoComprador = abrirModalConfirmacaoComprador;
  abrirModalConfirmacaoComprador = function(pedido) {
    const modal = document.getElementById('modalConfirmacaoComprador');
    // Bloqueia fechar clicando fora
    modal.onclick = (e) => { e.stopPropagation(); }; // ignore close by backdrop
    const btnAceitar = document.getElementById('btnAceitarEntrega');
    const btnRecusar = document.getElementById('btnRecusarEntrega');
    btnAceitar.onclick = () => responderConfirmacaoEntrega(pedido.id, true);
    btnRecusar.onclick = () => responderConfirmacaoEntrega(pedido.id, false);
    abrirModal('modalConfirmacaoComprador');
  };

  const originalResponderConfirmacaoEntrega = responderConfirmacaoEntrega;
  responderConfirmacaoEntrega = async function(pedidoId, aceito) {
    const novoStatus = aceito ? 'confirmado_pelo_cliente' : 'disputa';
    try {
      const pedidoDoc = await db.collection('loja_pedidos').doc(pedidoId).get();
      const vendedorUid = pedidoDoc.data().vendedorUid;
      await db.collection('loja_pedidos').doc(pedidoId).update({ status: novoStatus });
      const msg = aceito ? '笨 O comprador confirmou o recebimento!' : '笶 O comprador recusou o recebimento. Entre em contato.';
      notifyUser(vendedorUid, '逃 Atualizaﾃｧﾃ｣o de Entrega', msg, { deepLink: 'vendedor_entregas' });
      alert('Resposta enviada com sucesso!');
      fecharModalAtual();
    } catch (e) {
      alert('Erro ao enviar resposta: ' + e.message);
    }
  };
})();

// [6] Cartﾃ｣o de crﾃｩdito: popup taxa administrativa + notificaﾃｧﾃ｣o verde para admin ao continuar
(function patchCartaoCreditoFluxo(){
  // Injetar modal de taxa administrativa
  const modalTaxaHTML = `
    <div id="modalTaxaCartao" class="modal" onclick="fecharModal(event)" style="display:none;">
      <div class="modal-content" onclick="event.stopPropagation()">
        <h3>諜 Taxa Administrativa</h3>
        <p>Transaﾃｧﾃｵes por cartﾃ｣o possuem taxa fixa cobrada pela plataforma segura de pagamentos.</p>
        <div style="display:flex; gap:10px; margin-top:10px;">
          <button id="btnContinuarTaxaCartao">笨 Continuar</button>
          <button data-modal-id="modalTaxaCartao" onclick="fecharModal(event)">笶 Cancelar</button>
        </div>
      </div>
    </div>`;
  const div = document.createElement('div'); div.innerHTML = modalTaxaHTML; document.body.appendChild(div);

  const originalProcessarPagamentoCartaoAprimorado = processarPagamentoCartaoAprimorado;
  processarPagamentoCartaoAprimorado = function() {
    abrirModal('modalTaxaCartao');
    const btnContinuar = document.getElementById('btnContinuarTaxaCartao');
    btnContinuar.onclick = () => {
      // Notificaﾃｧﾃ｣o bem chamativa ao admin
      notifyAdmins("洸 Pagamento por Cartﾃ｣o Iniciado", "Um usuﾃ｡rio iniciou pagamento por cartﾃ｣o. Verifique.", { tipo: 'pagamento_cartao' });
      // Segue fluxo original
      document.getElementById('carregandoGenericoTitulo').textContent = 'Aguarde...';
      document.getElementById('carregandoGenericoTexto').textContent = 'Vocﾃｪ estﾃ｡ sendo redirecionado para um ambiente de pagamento seguro.';
      abrirModal('modalCarregandoGenerico');
      setTimeout(() => { window.location.href = 'https://pay.kiwify.com.br/T3M9m1C'; }, 3000);
      fecharModalAtual(); // fecha taxa
    };
  };
})();

// [7] Notificaﾃｧﾃｵes clicﾃ｡veis com deep link para telas especﾃｭficas
(function enableNotificationDeepLinks(){
  // jﾃ｡ recebemos payload em messaging.onMessage; vamos abrir telas baseado em data.deepLink
  if (firebase.messaging.isSupported()) {
    messaging.onMessage((payload) => {
      const data = payload.data || {};
      if (data.deepLink) {
        setTimeout(() => {
          switch(data.deepLink) {
            case 'barbeiro_agendamentos': abrirAgendamentosBarbeiro(); break;
            case 'cliente_historico': abrirHistoricoCliente(); break;
            case 'admin_pendencias': abrirModalSolicitacoes(); abrirDenuncias(); break;
            case 'vendedor_entregas': abrirEntregasVendedor(); break;
            case 'saque_solicitacoes': abrirModalSolicitacoes(); break;
            default: break;
          }
        }, 300);
      }
    });
  }
})();

/* ============================================
   PART 3 窶 IMPLEMENTAﾃﾃ髭S 8窶12
   ============================================ */

// [8] Publicaﾃｧﾃ｣o automﾃ｡tica de blogs com cﾃｳdigos de resgate ﾃs 00:00
function publicarBlogAutomatico() {
  const agora = new Date();
  if (agora.getHours() === 0 && agora.getMinutes() === 0) {
    // Gera palavra aleatﾃｳria relacionada a cortes/barbearia
    const palavras = ["(fade)", "(degradﾃｪ)", "(moicano)", "(barba)", "(tesoura)", "(mﾃ｡quina)", "(undercut)", "(pompadour)", "(navalha)", "(barbearia)"];
    const palavra = palavras[Math.floor(Math.random() * palavras.length)];
    db.collection("blog").add({
      titulo: "宙 Cﾃｳdigo Relﾃ｢mpago!",
      conteudo: `Use este cﾃｳdigo hoje: ${palavra}`,
      autor: "Sistema Navalha de Ouro",
      autorUid: "system",
      ts: firebase.firestore.FieldValue.serverTimestamp()
    });
  }
}
// Checagem a cada minuto
setInterval(publicarBlogAutomatico, 60000);

// [9] Correﾃｧﾃ｣o da notificaﾃｧﾃ｣o em massa (tratamento de JSON)
async function enviarNotificacaoMarketing() {
  const title = document.getElementById('marketingTitulo').value.trim();
  const body = document.getElementById('marketingCorpo').value.trim();
  if (!title || !body || !confirm(`Confirma o envio da notificaﾃｧﾃ｣o em massa?`)) return;
  try {
    const response = await fetch("https://navalhabackend.onrender.com/enviar-notificacao-massa", {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ title, body, adminUid: auth.currentUser.uid }),
    });
    const text = await response.text();
    let data;
    try { data = JSON.parse(text); } catch { throw new Error("Resposta invﾃ｡lida do servidor: " + text); }
    if (!response.ok) throw new Error(data.message || "Erro desconhecido");
    alert(`Notificaﾃｧﾃｵes enviadas!\nSucessos: ${data.successCount}\nFalhas: ${data.failureCount}`);
    fecharModalAtual();
  } catch (error) {
    alert('Falha ao enviar: ' + error.message);
  }
}

// [10] Correﾃｧﾃ｣o do popup de produto com formulﾃ｡rio completo e confirmaﾃｧﾃ｣o de dﾃｩbito
async function abrirDetalhesProduto(produto) {
  produtoParaCompra = produto;
  document.getElementById('detalhesProdutoImg').src = produto.imagemUrl;
  document.getElementById('detalhesProdutoNome').textContent = produto.nome;
  const precoFinal = produto.desconto ? produto.preco * (1 - produto.desconto / 100) : produto.preco;
  document.getElementById('detalhesProdutoPreco').textContent = `R$ ${precoFinal.toFixed(2)}`;
  document.getElementById('detalhesProdutoDescricao').textContent = produto.descricao;
  document.getElementById('detalhesProdutoEntrega').textContent = produto.tempoEntrega;

  const tamanhosContainer = document.getElementById('detalhesProdutoTamanhos');
  tamanhosContainer.innerHTML = '';
  if (produto.tamanhos && produto.tamanhos.length > 0) {
    produto.tamanhos.forEach(t => {
      tamanhosContainer.innerHTML += `<input type="radio" name="tamanho_selecionado" value="${t}" id="tamanho_${t}"><label for="tamanho_${t}">${t}</label>`;
    });
  } else {
    tamanhosContainer.innerHTML = 'Tamanho ﾃｺnico';
  }

  // Avaliaﾃｧﾃ｣o
  const avaliacaoContainer = document.getElementById('detalhesProdutoAvaliacao');
  await carregarAvaliacaoProduto(produto.id, produto.nome, avaliacaoContainer);

  // Botﾃ｣o continuar leva ao formulﾃ｡rio
  document.getElementById('btnComprarAgora').onclick = () => {
    abrirModal('modalConfirmarCompra');
    document.getElementById('compraEndereco').value = '';
    document.getElementById('compraTelefone').value = perfil.telefone || '';
    document.getElementById('compraCep').value = '';
    document.getElementById('compraEmail').value = perfil.email || '';
    document.getElementById('compraRua').value = '';
    document.getElementById('compraNumero').value = '';
    document.getElementById('btnConfirmarCompraFinal').onclick = () => confirmarCompra(produto, "ﾃｺnico");
  };

  <div id="modalProdutoDetalhes" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <img id="detalhesProdutoImg" src="" alt="Produto">
    <h3 id="detalhesProdutoNome"></h3>
    <p id="detalhesProdutoPreco"></p>
    <p id="detalhesProdutoDescricao"></p>
    <p id="detalhesProdutoEntrega"></p>
    <div id="detalhesProdutoTamanhos"></div>
    <div id="detalhesProdutoAvaliacao"></div>
    <button id="btnComprarAgora">將 Comprar Agora</button>
    <button data-modal-id="modalProdutoDetalhes" onclick="fecharModal(event)">笶 Fechar</button>
  </div>
</div>

async function confirmarCompra(produto, tamanho) {
  const endereco = document.getElementById('compraEndereco').value.trim();
  const telefone = document.getElementById('compraTelefone').value.trim();
  const cep = document.getElementById('compraCep').value.trim();
  const email = document.getElementById('compraEmail').value.trim();
  const rua = document.getElementById('compraRua').value.trim();
  const numero = document.getElementById('compraNumero').value.trim();
  if (!endereco || !telefone || !cep || !email || !rua || !numero) return alert('Preencha todos os campos obrigatﾃｳrios.');

  const precoFinal = produto.desconto ? produto.preco * (1 - produto.desconto / 100) : produto.preco;
  if (perfil.saldo < precoFinal) return alert('Saldo insuficiente.');

  abrirModal('modalConfirmacaoDebito');
  document.getElementById('btnConfirmarDebitoSim').onclick = async () => {
    try {
      await db.runTransaction(async t => {
        const clienteRef = db.collection("usuarios").doc(auth.currentUser.uid);
        const vendedorRef = db.collection("usuarios").doc(produto.vendedorUid);
        const adminSnap = await db.collection("usuarios").where("tipo", "==", "admin").limit(1).get();
        const adminRef = db.collection("usuarios").doc(adminSnap.docs[0].id);
        const produtoRef = db.collection("loja_produtos").doc(produto.id);

        const valorVendedor = precoFinal * (1 - TAXA);
        const valorAdmin = precoFinal * TAXA;

        t.update(clienteRef, { saldo: firebase.firestore.FieldValue.increment(-precoFinal) });
        t.update(vendedorRef, { saldo: firebase.firestore.FieldValue.increment(valorVendedor) });
        t.update(adminRef, { saldo: firebase.firestore.FieldValue.increment(valorAdmin) });
        t.update(produtoRef, { vendasRealizadas: firebase.firestore.FieldValue.increment(1) });

        t.set(db.collection("loja_pedidos").doc(), {
          produtoId: produto.id,
          produtoNome: produto.nome,
          valor: precoFinal,
          tamanho,
          clienteUid: auth.currentUser.uid,
          clienteNome: perfil.nome,
          endereco, telefone, cep, email, rua, numero,
          vendedorUid: produto.vendedorUid,
          vendedorNotificado: false,
          status: "pendente",
          ts: firebase.firestore.FieldValue.serverTimestamp()
        });
      });
      alert("Pedido realizado com sucesso!");
      notifyUser(auth.currentUser.uid, '逃 Pedido Confirmado!', `Sua compra de "${produto.nome}" foi realizada.`);
      notifyUser(produto.vendedorUid, '脂 Nova Venda!', `Vocﾃｪ vendeu um(a) "${produto.nome}" para ${perfil.nome}.`);
      fecharModalAtual();
    } catch (e) {
      alert('Erro ao processar a compra: ' + e.message);
    }
  };
  document.getElementById('btnConfirmarDebitoNao').onclick = () => fecharModalAtual();
}

// [11] Ajuste da imagem no modal de produto para nﾃ｣o cortar
(function ajustarImagemProdutoModal(){
  const style = document.createElement('style');
  style.textContent = `
    #detalhesProdutoImg {
      object-fit: contain !important;
      max-height: 250px;
      width: 100%;
    }
  `;
  document.head.appendChild(style);
})();

// [12] Mensagens de feedback intuitivas
function mostrarMensagemProcesso(texto) {
  const modal = document.createElement('div');
  modal.className = 'modal show';
  modal.innerHTML = `<div class="modal-content"><p>${texto}</p></div>`;
  document.body.appendChild(modal);
  setTimeout(() => {
    modal.classList.remove('show');
    setTimeout(() => modal.remove(), 300);
  }, 2000);
}

// Exemplo de uso em pontos crﾃｭticos
function iniciarProcessoCompra() { mostrarMensagemProcesso("竢ｳ Estamos preparando seu pedido..."); }
function finalizarProcessoCompra() { mostrarMensagemProcesso("笨 Pedido concluﾃｭdo!"); }

</script>
</body>
</html>
