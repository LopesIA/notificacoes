async function girarRoleta() {
    const hoje = new Date().toDateString();
    let girosTotais = 1; 
    if (isProAtivo(perfil) && perfil.proTier && PRECOS_PRO[perfil.proTier]) {
        girosTotais = PRECOS_PRO[perfil.proTier].giros;
    }
    const isNovoDia = perfil.ultimoGiroRoleta !== hoje;
    let girosRealizados = isNovoDia ? 0 : (perfil.girosRealizadosHoje || 0);
    
    if (girosRealizados >= girosTotais) {
        return exibirPopup("Sem giros", "Voc√™ j√° usou seus giros de hoje! Volte amanh√£ ou assine PRO.");
    }

    const btnGirar = document.getElementById('btnGirarRoleta');
    btnGirar.disabled = true; 
    btnGirar.textContent = "Girando...";

    // --- L√ìGICA MATEM√ÅTICA ---
    // Mapeamento do padr√£o visual: [1, 5, MOLDURA, 10, 2, BALAO, 3, 1, CAIXA]
    const arrayPremios = [
        { tipo: 'ponto', valor: 1 },   // Index 0
        { tipo: 'ponto', valor: 5 },   // Index 1
        { tipo: 'moldura', valor: 0 }, // Index 2
        { tipo: 'ponto', valor: 10 },  // Index 3
        { tipo: 'ponto', valor: 2 },   // Index 4
        { tipo: 'balao', valor: 0 },   // Index 5
        { tipo: 'ponto', valor: 3 },   // Index 6
        { tipo: 'ponto', valor: 1 },   // Index 7
        { tipo: 'caixa', valor: 0 }    // Index 8
    ];

    // Sorteio
    const rand = Math.random() * 100;
    let targetIndex = 0; 

    if (rand < 40) targetIndex = 0;      // 1pt
    else if (rand < 60) targetIndex = 7; // 1pt
    else if (rand < 75) targetIndex = 4; // 2pt
    else if (rand < 85) targetIndex = 6; // 3pt
    else if (rand < 90) targetIndex = 1; // 5pt
    else if (rand < 93) targetIndex = 3; // 10pt
    else if (rand < 96) targetIndex = 2; // Moldura
    else if (rand < 98) targetIndex = 5; // Bal√£o
    else targetIndex = 8;                // Caixa

    // --- C√ÅLCULO PIXEL PERFECT ---
    const LARGURA_ITEM = 90; // 80px width + 10px margin total
    const ITENS_POR_SET = 9; 
    const SET_FINAL = 45; // N√∫mero de repeti√ß√µes para girar bastante
    
    // √çndice absoluto na faixa longa
    const indiceFinalAbsoluto = (SET_FINAL * ITENS_POR_SET) + targetIndex;

    // Elementos e Dimens√µes
    const container = document.getElementById('roletaVisual');
    const larguraContainer = container.offsetWidth;
    
    // O centro do container
    const centroContainer = larguraContainer / 2;
    
    // O centro do item alvo (posi√ß√£o esquerda + metade da largura)
    const centroItemAlvo = (indiceFinalAbsoluto * LARGURA_ITEM) + (LARGURA_ITEM / 2);
    
    // O quanto precisamos mover para alinhar os dois centros
    let moveX = centroItemAlvo - centroContainer;

    // Pequeno "tempero" aleat√≥rio para n√£o parecer rob√≥tico (+/- 25px)
    const jitter = Math.floor(Math.random() * 50) - 25; 
    moveX += jitter;

    // Anima√ß√£o
    const faixa = document.getElementById('roletaFaixa');
    faixa.style.transition = `transform 5s cubic-bezier(0.15, 0, 0.10, 1)`; 
    faixa.style.transform = `translateX(-${moveX}px)`;

    // Defini√ß√£o do Pr√™mio
    let premioKey = '';
    let msgPremio = '';
    const premioGanho = arrayPremios[targetIndex];

    if (premioGanho.tipo === 'moldura') {
        const chaves = Object.keys(MOLDURAS).filter(k => !MOLDURAS[k].adminOnly);
        premioKey = chaves[Math.floor(Math.random() * chaves.length)];
        msgPremio = `Moldura ${MOLDURAS[premioKey].nome}`;
    } else if (premioGanho.tipo === 'balao') {
        const chaves = Object.keys(BALOES).filter(k => !BALOES[k].adminOnly);
        premioKey = chaves[Math.floor(Math.random() * chaves.length)];
        msgPremio = `Estilo ${BALOES[premioKey].nome}`;
    }

    // Entrega
    setTimeout(async () => {
        let updates = { ultimoGiroRoleta: hoje };
        updates.girosRealizadosHoje = isNovoDia ? 1 : firebase.firestore.FieldValue.increment(1);
        
        let tituloPopup = "üéâ Parab√©ns!";
        let corpoPopup = "";

        if (premioGanho.tipo === 'ponto') {
            corpoPopup = `Voc√™ ganhou ${premioGanho.valor} pontos de fidelidade!`;
            updates.pontosFidelidade = firebase.firestore.FieldValue.increment(premioGanho.valor);
        } 
        else if (premioGanho.tipo === 'moldura' || premioGanho.tipo === 'balao') {
            tituloPopup = "üéÅ Item Tempor√°rio!";
            corpoPopup = `Sorte Grande! Voc√™ ganhou o item **${msgPremio}** por 24 horas!`;
            const expiraEm = new Date();
            expiraEm.setHours(expiraEm.getHours() + 24);
            updates[`premiosTemporarios.${premioKey}`] = firebase.firestore.Timestamp.fromDate(expiraEm);
            
            if (premioGanho.tipo === 'moldura') updates.molduraSelecionada = premioKey;
            if (premioGanho.tipo === 'balao') updates.balaoSelecionado = premioKey;
        } 
        else if (premioGanho.tipo === 'caixa') {
            tituloPopup = "üéÅ CAIXA MISTERIOSA!";
            if (perfil.tipo !== 'cliente') {
                const exp = new Date(); 
                const atualExp = perfil.boostExpiracao ? perfil.boostExpiracao.toDate() : new Date();
                if (atualExp < new Date()) { atualExp.setTime(Date.now()); } 
                atualExp.setHours(atualExp.getHours() + 24); 
                updates.boostExpiracao = firebase.firestore.Timestamp.fromDate(atualExp);
                updates.ultimoBoostComprado = firebase.firestore.FieldValue.serverTimestamp();
                corpoPopup = "Voc√™ ganhou 24 horas de Perfil Turbinado!";
            } else {
                const exp = new Date();
                const atualVipExp = (isVipAtivo(perfil) && perfil.vipExpirationDate) ? perfil.vipExpirationDate.toDate() : new Date();
                if (atualVipExp < new Date()) { atualVipExp.setTime(Date.now()); }
                atualVipExp.setDate(atualVipExp.getDate() + 5); 
                updates.vip = true; 
                updates.vipExpirationDate = firebase.firestore.Timestamp.fromDate(atualVipExp);
                corpoPopup = "Incr√≠vel! Voc√™ ganhou 5 Dias de VIP Gr√°tis!";
            }
        }

        try {
            await db.collection('usuarios').doc(auth.currentUser.uid).update(updates);
            
            exibirPopupBloqueante(tituloPopup, corpoPopup, () => {
                db.collection('usuarios').doc(auth.currentUser.uid).get().then(doc => {
                    perfil = doc.data();
                    abrirModalPerfil(); // Recarrega para mostrar pr√™mios e resetar roleta
                });
            });

            notifyUser(auth.currentUser.uid, "üé∞ Pr√™mio da Roleta", corpoPopup);
            perfil.ultimoGiroRoleta = hoje;
            perfil.girosRealizadosHoje = isNovoDia ? 1 : (girosRealizados + 1);

        } catch (e) {
            exibirPopup("Erro", "Erro ao salvar pr√™mio: " + e.message);
            atualizarBotaoRoleta();
        }

    }, 5000);
}
