async function concluirAgendamento(agendamentoId, clienteUid) {
  exibirAguarde("Concluindo...");
  
  try {
    const agendamentoRef = db.collection("agendamentos").doc(agendamentoId);
    const barbeiroRef = db.collection("usuarios").doc(auth.currentUser.uid);
    const clienteRef = db.collection("usuarios").doc(clienteUid);

    const resultData = await db.runTransaction(async t => {
        const [agendamentoDoc, barbeiroDoc] = await Promise.all([
            t.get(agendamentoRef),
            t.get(barbeiroRef)
        ]);

        const agData = agendamentoDoc.data();
        const barbeiroData = barbeiroDoc.data();

        if (agData.status !== "conclusão pendente") throw "Este agendamento não pode ser concluído.";

        // --- CORREÇÃO FINANCEIRA DEFINITIVA ---
        
        // 1. Descobre o Valor CHEIO do serviço (Base de cálculo do profissional)
        let valorBaseParaProfissional = agData.valorOriginal;

        // TRAVA DE SEGURANÇA: Se for um agendamento antigo sem 'valorOriginal' salvo
        if (!valorBaseParaProfissional) {
            if (agData.descontoVipAplicado) {
                // Se foi aplicado desconto VIP, o valor pago (agData.valor) é 90% do real.
                // Revertemos a conta: Valor / 0.9 = Valor Original.
                valorBaseParaProfissional = agData.valor / 0.9;
            } else {
                // Se não teve desconto VIP, o valor pago é o valor cheio.
                valorBaseParaProfissional = agData.valor;
            }
        }

        // 2. Identifica a Taxa do Profissional
        let taxaAplicada = TAXA; // Padrão 20% (0.20)
        if (isProAtivo(barbeiroData) && barbeiroData.proTier && PRECOS_PRO[barbeiroData.proTier]) {
            taxaAplicada = PRECOS_PRO[barbeiroData.proTier].taxa;
        }

        // 3. Cálculo Final
        // Profissional recebe: Valor CHEIO - Taxa dele.
        // Exemplo: Serviço 100. VIP pagou 90. Profissional (Taxa 20%) recebe: 100 * 0.8 = 80.
        // O sistema recebeu 90. Repassou 80. Lucro Admin = 10. 
        // (Se não fosse VIP, sistema recebia 100, repassava 80, Lucro Admin = 20).
        // Ou seja, o Admin "pagou" os 10 reais de desconto do VIP deixando de lucrar.
        const valorLiquido = valorBaseParaProfissional * (1 - taxaAplicada); 

        // 4. Atualiza Saldo do Profissional
        t.update(barbeiroRef, { 
            saldo: firebase.firestore.FieldValue.increment(valorLiquido), 
            cortesSemana: firebase.firestore.FieldValue.increment(1), 
            clientesAtendidos: firebase.firestore.FieldValue.increment(1) 
        });
        
        // 5. Finaliza Agendamento
        t.update(agendamentoRef, { 
            status: "concluido", 
            avisoAvaliacaoEnviado: false
        });

        // 6. Registro Financeiro
        const registroRef = db.collection("extrato_financeiro").doc();
        t.set(registroRef, {
            usuarioUid: auth.currentUser.uid,
            tipo: "entrada_servico",
            valorBrutoServico: valorBaseParaProfissional, // 100
            valorPagoPeloCliente: agData.valor,           // 90
            valorLiquidoRecebido: valorLiquido,           // 80
            taxaAplicada: taxaAplicada,
            adminAbsorveuDesconto: (valorBaseParaProfissional - agData.valor), // 10
            dataEvento: firebase.firestore.FieldValue.serverTimestamp(),
            origem: `Serviço: ${agData.servico}`,
            agendamentoId: agendamentoId
        });
        
        // 7. Atualiza Cliente
        t.update(clienteRef, { 
            cortesRealizados: firebase.firestore.FieldValue.increment(1) 
        });

        return agData.clienteTelefone;
    });

    await verificarConquistas(clienteUid);
    await verificarConquistasBarbeiro(auth.currentUser.uid);

    if (resultData) {
        const phoneNum = resultData.replace(/\D/g, '');
        const msg = encodeURIComponent("Acabei de concluir o agendamento no aplicativo, você pode ir em historico e deixar sua avaliação! :D");
        window.open(`https://wa.me/55${phoneNum}?text=${msg}`, '_blank');
    }

    fecharTodosOsModais();
    exibirPopup("Sucesso", "Serviço concluído e saldo liberado!");
    
    notifyUser(clienteUid, "⭐ Avalie sua Experiência!", `O serviço com ${perfil.nome} foi concluído.`, { link: '#historico' });
    
    setTimeout(() => location.reload(), 4000);

  } catch(e) {
    fecharTodosOsModais();
    exibirPopup("Erro ao concluir serviço: " + e);
    setTimeout(() => location.reload(), 4000); 
  }
}
